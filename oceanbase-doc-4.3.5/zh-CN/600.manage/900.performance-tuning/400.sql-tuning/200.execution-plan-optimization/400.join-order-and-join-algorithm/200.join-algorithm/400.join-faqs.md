| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   |                 |

# 联接算法选择问题及解决方法

在 OceanBase 数据库 V4.0 之前的版本中，由于优化器采用二阶段架构，常出现分布式计划错误选择联接算法的问题，导致慢 SQL 的发生。

## 问题 1：优化器架构缺陷导致联接算法错误

**原因**：

OceanBase 优化器的二阶段架构在分布式计划生成时，可能导致以下问题：
- **错误选择联接算法**：优先选择 **Nested Loops Join** 或 **Merge Join**，而非更高效的 **Hash Join**。

**现象**：

- 查询执行计划中出现 **Nested Loops Join** 或 **Merge Join**。
- 由于分布式场景下数据量较大，此类算法的性能较差，导致 SQL 执行缓慢。

**解决方法**：

DBA 需手动控制优化器选择 **Hash Join 算法**，通常可有效解决此类慢 SQL 问题。

## 问题 2：统计信息不准确导致的误判

**原因**：

基表的统计信息（如行数）估计严重偏小，导致优化器误判：
- **错误认为 Nested Loops 是最优选择**：优化器认为小表驱动大表的 Nested Loops 是高效方案。
- **实际驱动表数据量过大**：执行时因驱动表数据量远超估计值，导致 Nested Loops Join 执行效率极低。

**现象**：

- 执行计划显示 **Nested Loops Join**。
- 驱动表实际数据量远大于优化器的估计值，执行时间显著增加。

**解决方法**：

DBA 可采取以下措施：
1. 手动指定其他联接算法（如 **Hash Join**）。
2. 调整联接次序（如将大表作为驱动表）。
