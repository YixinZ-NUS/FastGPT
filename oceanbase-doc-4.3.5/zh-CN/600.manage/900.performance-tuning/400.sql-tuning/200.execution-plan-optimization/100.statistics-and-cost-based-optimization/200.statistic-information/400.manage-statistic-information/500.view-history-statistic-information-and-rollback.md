| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   |                 |

# 查询与回滚历史版本统计信息

OceanBase 数据库优化器提供了 **统计信息历史版本管理功能**，用于：

- **查询统计信息的历史版本**
- **将统计信息回滚到指定版本**
- **管理历史信息的保留时限**

当统计信息发生变更（如收集、设置、删除、导入、锁定等），系统会自动将变更前的统计信息保存到 **统计信息历史表**，统计信息历史表可以查询某张表的一个历史统计信息改变情况，同时也能够恢复指定到历史版本的统计信息。

## 查询历史统计信息

### 支持的查询视图

根据模式类型，可通过以下视图查询用于查询历史版本统计信息：

| **模式**   | **视图名称**                          | **功能描述**               |
|------------|---------------------------------------|---------------------------|
| Oracle     | `ALL_TAB_STATS_HISTORY`               | 用于提供当前用户可访问的所有表的表统计修改历史记录。   |
| Oracle     | `DBA_TAB_STATS_HISTORY`               | 展示数据库中所有表的表统计修改历史记录。   |
| Oracle     | `USER_TAB_STATS_HISTORY`              | 用于展示当前用户拥有的所有表的表统计修改历史记录。   |
| MySQL      | `OCEANBASE.DBA_TAB_STATS_HISTORY`     | 兼容 MySQL 模式的统计信息历史查询，展示数据库中所有表的表统计历史记录。 |

**关键字段说明**：

- `STATS_UPDATE_TIME`：统计信息版本的更新时间戳。

### 示例：获取最早可用历史版本时间

```sql
-- 查询当前可用的最早历史统计信息时间
SELECT DBMS_STATS.GET_STATS_HISTORY_AVAILABILITY() FROM DUAL;
```

## 回滚到指定统计版本

### 操作步骤

1. **查询目标时间戳**：通过视图或 `GET_STATS_HISTORY_AVAILABILITY` 获取历史版本的时间。
2. **利用系统包的存储过程**：通过 `DBMS_STATS` 包中的存储过程指定时间戳恢复统计信息。

### 支持的存储过程

| **存储过程**                | **功能**                             |
|-----------------------------|--------------------------------------|
| `RESTORE_TABLE_STATS`        | 恢复某个表的指定版本的历史统计信息。        |
| `RESTORE_SCHEMA_STATS`       | 恢复某个 schema 的指定版本的历史统计信息。  |

#### 示例：恢复 TEST 用户的 T1 表统计信息

```sql
-- 指定恢复 TEST 用户的 T1 表在 2021-09-26 19:02:12 的统计信息
CALL DBMS_STATS.RESTORE_TABLE_STATS(
  ownname => 'TEST',
  tabname => 'T1',
  time => TO_TIMESTAMP('2021-09-26 19:02:12.675729', 'YYYY-MM-DD HH24:MI:SS.FF')
);
```

## 管理历史信息保留时限

### 默认值

系统默认保留历史统计信息 **31 天**。

### 配置历史信息保留时限

通过 `DBMS_STATS` 包的存储过程管理保留时限：

| **存储过程**                | **功能**                             |
|-----------------------------|--------------------------------------|
| `ALTER_STATS_HISTORY_RETENTION` | 修改历史统计信息的的保留间隔时间，有效值范围为 [-1, 365000]；需要注意的是如果设置值为 -1，则永远不会清除统计信息；而设置为 0，则会关闭历史统计信息功能。 |
| `GET_STATS_HISTORY_RETENTION`   | 获取当前历史统计信息的保留间隔时间。             |

#### 示例：修改与查询保留时限

```sql
-- 获取当前保留天数
SELECT DBMS_STATS.GET_STATS_HISTORY_RETENTION() FROM DUAL;

-- 设置保留时限为 15 天
CALL DBMS_STATS.ALTER_STATS_HISTORY_RETENTION(15);
```

## 清理历史统计信息

### 自动清理机制

系统每日会自动清理 **超过保留时限** 的历史统计信息。

### 手动清理机制

可通过 `PURGE_STATS` 存储过程清除指定时间戳的历史版本：

#### 示例：手动清理指定时间的历史信息

```sql
CALL DBMS_STATS.PURGE_STATS(
  time => TO_TIMESTAMP('2021-09-26 19:02:12.675729', 'YYYY-MM-DD HH24:MI:SS.FF')
);
```
