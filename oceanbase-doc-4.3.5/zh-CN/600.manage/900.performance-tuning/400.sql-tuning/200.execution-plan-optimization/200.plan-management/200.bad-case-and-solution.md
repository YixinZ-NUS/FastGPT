| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   |                 |

# 计划缓存的缺点与计划绑定解决方案

## 问题场景：计划缓存与数据倾斜

### 背景

计划缓存通过复用已有执行计划节省生成时间，但在 **数据倾斜场景** 下可能引发性能问题。

### 示例说明

假设表 `t1` 的定义和数据分布如下：

```sql
CREATE TABLE t1 (
  c1 INT,
  c2 INT,
  c3 INT,
  KEY idx1(c1),
  KEY idx2(c2)
);
```

- **加入数据分布如下**：

  - `c1` 列值 `0` 占 1%，`1` 占 99%。
  - `c2` 列值 `1`~`10` 各占 10%。

### 问题现象

对于 SQL `SELECT * FROM t1 WHERE c1 = ? AND c2 = ?`：

1. **首次执行（条件：`c1=0 AND c2=1`）**：
   - 优化器选择索引 `idx1`，从索引上查出满足 `c1 = 0` 的 1% 的数据，然后索引回表后通过 `c2 = 1` 过滤掉不满足条件的数据后回表，效率高。
2. **后续执行（条件：`c1=1 AND c2=1`）**：
   - 复用首次生成的计划，走 `idx1`，查出满足 `c1 = 1` 的 99% 的数据，然后索引回表后通过 `c2 = 1` 过滤掉不满足条件的数据后返回。此时需要扫描 99% 的数据加索引回表 99% 的数据才能完成查询，性能差。
   - **更优选择**：强制使用 `idx2` 索引，始终扫描 10% 数据。
   - **推荐方案**：可以使用 outline 对 SQL 进行执行计划绑定，强制这条查询请求使用 `idx2` 索引。当然针对这条 SQL，其实还有更好的优化方法，本篇文章不做讨论。

## 解决方案：计划绑定（Outline）

OceanBase 提供 **计划绑定** 功能，允许用户在不修改 SQL 的情况下，通过 `OUTLINE` 强制指定执行计划。

### Outline 的创建方式

1. **通过 SQL_TEXT 创建**：

   ```sql
   CREATE [OR REPLACE] OUTLINE outline_name ON stmt [ TO target_stmt ]
   ```
   - **示例**：

     ```sql
     CREATE OUTLINE otl_idx2 ON SELECT/*+ index(T1 idx2)*/ * FROM t1 WHERE c1 = 1 AND c2 = 1;
     ```

   - **局限性**：

     - 对 SQL 格式（空格、大小写）敏感，易因语法差异导致绑定失败。

2. **通过 SQL_ID 创建**：

   ```sql
   CREATE [OR REPLACE] OUTLINE outline_name ON sql_id USING HINT hint;
   ```

   - **示例**：

     ```sql
     CREATE OUTLINE otl_idx2 ON '27F4FC32407331073407EAA24F5E5FA4'
     USING HINT /*+ index(T1 idx2)*/ ;
     ```

   - **优势**：
     - 直接绑定到 `SQL_ID`，避免语法差异导致的绑定失败。
     - 推荐优先使用此方式。

### 关键点说明

1. 问题根本原因：计划缓存复用导致 **非最优计划** 在倾斜数据时重复执行。

2. Outline 的作用：强制指定执行计划（如选择 `idx2` 索引），避免因数据分布差异导致性能波动。

3. 推荐实践：使用 `SQL_ID` 方式创建 Outline，确保绑定可靠性。
