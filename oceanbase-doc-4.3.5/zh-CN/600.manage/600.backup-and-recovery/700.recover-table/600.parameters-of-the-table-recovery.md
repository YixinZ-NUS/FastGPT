|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 表级恢复相关参数介绍

本节主要对表级恢复命令中的相关参数进行介绍。

## 表级恢复命令相关

### 命令

* 表级恢复

  ```sql
  ALTER SYSTEM 
  RECOVER TABLE table_name_list 
  TO [TENANT [=]] dest_tenant_name 
  FROM uri 
  [UNTIL {TIME='timestamp'} | {SCN=scn} ]
  WITH 'restore_option' 
  [WITH KEY FROM 'backup_key_path' ENCRYPTED BY 'password']
  [REMAP TABLE remap_table_name_list] 
  [REMAP TABLEGROUP remap_tablegroup_list] 
  [REMAP TABLESPACE remap_tablespace_list]
  [DESCRIPTION [=] description];
  ```

* 取消正在进行的表级恢复任务

   ```sql
   ALTER SYSTEM CANCEL RECOVER TABLE dest_tenant_name;
   ```

### 参数解释

|         参数                |     描述                                        |
|-----------------------------|------------------------------------------------|
|   table_name_list           |  需要恢复的表，格式形如 <code>database_name.table_name1,database_name.table_name2,...</code>，多个表之间使用英文逗号（,）来分隔。</br>指定 <code>database_name</code> 和 <code>table_name</code> 时：<ul> <li>需要保证名称与系统实际存储的名称一致。<ul><li>对于 Oracle 模式租户，<code>database_name</code> 的名称与表所在的用户名相同，同时 <code>database_name</code> 和 <code>table_name</code> 默认大小写不敏感，按照英文字母大写存储在内部表中。</li> <li>对于 MySQL 租户，<code>database_name</code> 的名称为表所属的数据库名，同时 <code>database_name</code> 和 <code>table_name</code> 是否大小写敏感取决于创建源租户时指定的变量 <code>lower_case_table_names</code> 的值。</br>变量 <code>lower_case_table_names</code> 用于设置数据库名和表名是否对大小写敏感。如果创建租户时未指定该变量的值，则默认为数据库名和表名按照小写形式进行存储，并以不区分大小写的形式进行比较。有关变量 <code>lower_case_table_names</code> 的更多说明，请参见 <a href="../../../700.reference/800.configuration-items-and-system-variables/200.system-variable/300.global-system-variable/3600.lower_case_table_names-global.md">lower_case_table_names</a>。</li></ul> </li> <li>对于 <code>database_name</code> 或 <code>table_name</code> 中含有特殊字符的场景，含特殊字符的 <code>database_name</code> 或 <code>table_name</code> 需要放在反引号（``）内。</li> <li> 如果需要恢复一个 DataBase 下的所有表，则可以表示为 database_name.\*。</li> <li>如果需要恢复租户下的所有用户表，则可以表示为 \*.\*。</li></ul>    |
|  dest_tenant_name           | 表待恢复的目标租户名，仅支持将表恢复到用户租户中，不支持恢复到 `sys` 租户或 Meta 租户。                                             |
|  uri                        | 分别指定数据备份和日志归档的路径，与租户级物理恢复命令的参数一样。若数据备份是通过 PLUS ARCHIVELOG 方式发起的，只需要填一个路径即可，否则需要分别输入数据备份和日志归档至少 2 个路径，例如：`'file:///backup/archive, file:///backup/data'`。                                               |
|    {TIME='timestamp'} \| {SCN=scn}          | 指定的恢复终点，恢复到该位点位置，且包含该位点。当指定恢复到 `TIME` 或 `SCN` 时, 必须以 `=` 来连接指定的值。如果不指定 `UNTIL` 子句，则默认恢复到最新的位点。                                              |
| restore_option     | 支持 `pool_list`、`locality`、`primary_zone`、`concurrency`，不同参数之间通过 `&` 分隔。在指定 `locality` 和 `primary_zone` 时，建议尽量与源租户保持同构。<ul><li>`pool_list`：必选，填写用户的资源池。多个资源池之间用英文逗号（,）分隔。</li>  <li>`locality`：可选，填写辅助租户副本分布的 Locality 信息，需要满足与辅助租户所在集群的 `pool_list` 的 Zone 信息相匹配。不填时，默认按照 resource_pool 的 `zone_list` 为每个 Zone 设一个 F 副本。</br>填写样例: `locality='F@z1,F@z2,F@z3'` </li> <li>`primary_zone`：可选，填写辅助租户的 Leader 副本的偏好位置，需要满足与 `pool_list` 及 `locality` 的匹配，即需要满足 Zone 信息匹配以及 `primary_region` 内至少有两个 Paxos 成员等限制。不填时，则系统按照 `locality` 的 `zone_list` 将 Leader 随机分布在这些 Zone 中。 </br>填写样例: `primary_zone='z1'`</li> <li>`concurrency`：可选，指定数据恢复的并发度。如果不指定，则默认等于该租户被分配的 MAX_CPU 数。</br>填写样例：`concurrency=50` </li></ul>   |
| WITH KEY FROM 'backup_key_path' ENCRYPTED BY 'password' | 指定加密租户的秘钥备份信息。仅当源租户配置了透明加密，才需要在恢复时指定秘钥备份相关的信息。其中：<ul><li><code>backup_key_path</code>：秘钥的备份路径。</li> <li><code>password</code>：备份秘钥时设置的加密密码。</li></ul> |
|  remap_table_name_list      | 重命名恢复后的表名。支持仅重命名表名，表所属的 Database 不变；也支持表名不变，仅重命名到其他 Database；还支持重命名表名，同时所属的 Database 重命名为其他 Database。源对象与重命名对象之间使用英文冒号（:）连接，具体格式的示例如下：<ul> <li>表名从 <code>student</code> 重命名为 <code>student2</code>，表所属的 Database 不变：<code>REMAP TABLE school.student:student2</code>。</br>当所属的 Database 不变时，在恢复到目标租户创建表时，系统默认会将表恢复到目标租户同名的 Database 中，如果同名的 Database 不存在，则表恢复就会失败。</li> <li>表名不变，表所属的 Database 从 <code>school</code> 改为 <code>college</code>：<code>REMAP TABLE school.student:college.student</code>。</li> <li>表名从 <code>student</code> 重命名为 <code>student2</code>，表所属的 Database 从 <code>school</code> 改为 <code>college</code>：</code>REMAP TABLE school.student:college.student2</code>。</li> <li>将 <code>school</code> 下的所有表恢复到 <code>college</code> 中：<code>REMAP TABLE school.`*`:college.`*`</code>。 </li></ul> <main id="notice" type='explain'><h4>说明</h4><p>如果重命名的 <code>database_name</code> 或 <code>table_name</code> 中含有特殊字符，则含特殊字符的 <code>database_name</code> 或 <code>table_name</code> 需要放在反引号（``）内。</p></main>             |
|  remap_tablegroup_list      | 重命名表所属的表组。如果源表绑定了表组，则在恢复到目标租户创建表时，系统默认会将表恢复到目标租户中同名的表组，如果同名的表组不存在，表恢复就会失败。如果目标租户中有其他表组，可以将表通过该语句恢复到其他表组中，源对象与重命名对象之间使用英文冒号（:）连接。 </br>例如，将源表组 <code>tg1</code> 中的表全部恢复到目标租户的表组 <code>newtg1</code> 中：<code>REMAP TABLEGROUP tg1:newtg1</code>。                                              |
|  remap_tablespace_list      | 重命名表所属的表空间。表空间在 OceanBase 数据库中是一个逻辑单元，当前主要用于数据加密。如果源表绑定了表空间，则在恢复到目标租户创建表时，系统默认会将表恢复到目标租户中同名的表空间，如果同名的表空间不存在，表恢复就会失败。如果目标租户中有其他表空间，也可以将表通过该语句恢复到其他表空间中，源对象与重命名对象之间使用英文冒号（:）连接。</br> 例如，将源表空间 <code>ts1</code> 中的表全部恢复到目标租户的表空间 <code>newts1</code> 中：<code>REMAP TABLESPACE ts1:newts1</code>。                                             |

## 表级恢复性能相关

### 恢复辅助租户阶段

表级恢复中恢复辅助租户阶段与租户级恢复一致，该阶段相关的性能参数及说明，可参见 [物理恢复相关参数介绍](../600.restore-data/800.parameters-of-the-restore.md)。 

### 跨租户导表阶段

**命令**

```sql
ALTER SYSTEM SET ddl_thread_score = int_value Tenant=tenant_name;
```

```sql
ALTER SYSTEM SET recover_table_concurrency= int_value Tenant=tenant_name;
```

```sql
ALTER SYSTEM SET recover_table_dop = int_value Tenant=tenant_name;
```

***参数解释***

|         参数                |     描述                                        |
|-----------------------------|------------------------------------------------|
| [ddl_thread_score](../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/1850.ddl_thread_score.md)            | 用于控制租户 OBServer 节点上表级恢复线程池的数量。默认值为 0，表示内部默认线程数为 2。|
| [recover_table_concurrency](../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/7320.recover_table_concurrency.md)   | 用于控制租户多表并行恢复的并行度，指定最多允许 `recover_table_concurrency` 个表同时执行跨租户导表。默认值为 0，表示内部默认最多允许 1 个表执行跨租户导表。|
| [recover_table_dop](../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/7325.recover_table_dop.md)            | 用于控制单表恢复的并行度。默认值为 0，表示内部默认并行度为 1。<p>该参数具体对以下两个阶段有影响：</p><ul><li>数据恢复阶段<p>系统将表的每个分区拆分成为最多 `recover_table_dop` 个恢复子任务，每个子任务由独立的表级恢复线程执行，实现并行恢复。</p> <p>总并行度的计算公式：`单表最大并行度 = 分区总数 * recover_table_dop`</p> <p>示例：假设当前恢复的表有 4 个分区，且 `recover_table_dop` 的值为 2，则总并行线程数为 `4*2=8`。</p></li> <li>重建索引阶段<p>系统基于已经恢复的表数据，利用并行执行（Parallel Execution, PX）重建索引。PX 的并行度由 `recover_table_dop` 决定。有关 PX 的详细介绍及调优说明，参见 [并行执行](../../../700.reference/1000.performance-tuning-guide/500.sql-optimization/350.parallel-execution/100.parallel-execution-concept.md)。</p></li></ul> |
