|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 更新对象存储的密钥信息

OceanBase 数据库支持动态更新备份路径或归档路径的 `access_id` 和 `access_key` 等信息。用户在设置备份路径和归档路径后，因安全或其他原因，更改了对象存储的密钥信息，为了保证备份或归档的正常执行，可以通过该方式来变更已设置的备份路径或归档路径的 `access_id` 和 `access_key` 。

## 使用限制

* 对于 V4.3.5 版本，从 V4.3.5 BP2 版本开始支持变更备份路径或归档路径的密钥信息。

* 仅支持变更对象存储路径的 `access_id` 和 `access_key` 信息。

* 仅支持用户租户变更本租户备份路径或归档路径的密钥信息，不支持系统租户变更指定用户租户的备份路径或归档路径的密钥信息。

## 注意事项

* 备份或归档过程中，更改对象存储路径对应的密钥信息后，需要及时变更备份路径或归档路径的 `access_id` 和 `access_key` 信息，否则可能会导致备份任务执行失败或归档无法推进的问题。

* 对于基于日志归档的物理备库场景，更改对象存储路径对应的密钥信息后，需要尽快更新备库（备租户）日志恢复路径中的 `access_id` 和 `access_key` 信息，否则可能会导致日志同步无法推进的问题。更新备库（备租户）日志恢复路径中的 `access_id` 和 `access_key` 信息的详细操作，参见 [设置日志恢复源](../400.high-availability/300.physical-standby-database-disaster-recovery/300.log-transport-service/200.configure-the-log-transport-service/100.set-log-restore-source.md)。

## 操作步骤

1. 用户租户的租户管理员登录集群的用户租户。

   <main id="notice" type='explain'>
   <h4>说明</h4>
   <p>MySQL 模式的管理员用户为 <code>root</code> 用户，Oracle 模式的管理员用户为 <code>SYS</code> 用户。</p>
   </main>

   连接示例如下，连接数据库时请以实际环境为准。

   ```shell
   obclient -h10.xx.xx.xx -P2883 -uroot@mysql_tenant#obdemo -p***** -A
   ```

2. 执行以下语句，变更备份路径或归档路径的密钥信息。

   SQL 语句如下：

   ```sql
   ALTER SYSTEM {ALTER|CHANGE|MODIFY} EXTERNAL_STORAGE_DEST PATH [=] 'path' SET ACCESS_INFO = 'access_id=new_access_id&access_key=new_access_key';
   ```

   相关参数说明如下：

   * `path`：指定待变更密钥信息的备份路径或归档路径。要求路径必须为当前租户已经设置的备份路径或归档路径，且必须为对象存储路径，同时路径中需要包含 `host` 信息。
   
     以 OSS 为例，该路径的格式如下：`oss://oceanbase-test-bucket/backup/data?host=***`。

   * `access_id=new_access_id&access_key=new_access_key`：指定变更后的新的 `access_id` 和 `access_key` 信息。`access_id` 与 `access_key` 需要同时填写。

   以备份或归档介质为 OSS 为例，假设当前用户租户在备份时设置的备份路径为 `oss://oceanbase-test-bucket/backup/data?host=cn-****.aliyuncs.com`，归档路径为 `oss://oceanbase-test-bucket/backup/archive?host=cn-****.aliyuncs.com`，分别变更备份路径和归档路径的密钥信息的示例如下：

   * 变更备份路径的密钥信息

      ```shell
      obclient> ALTER SYSTEM CHANGE EXTERNAL_STORAGE_DEST PATH='oss://oceanbase-test-bucket/backup/data?host=cn-****.aliyuncs.com' SET ACCESS_INFO = 'access_id=******&access_key=******';
      ```
   
   * 变更归档路径的密钥信息

      ```shell
      obclient> ALTER SYSTEM CHANGE ARCHIVELOG DESTINATION PATH='oss://oceanbase-test-bucket/backup/archive?host=cn-****.aliyuncs.com' SET ACCESS_INFO = 'access_id=******&access_key=******';
      ```

    更多示例，参见 [ALTER/CHANGE/MODIFY EXTERNAL_STORAGE_DEST](../../700.reference/500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/600.sql-statement-of-mysql-mode/1430.alter-system-change-external-storage-dest-of-mysql-mode.md)。

3. 修改成功后，可以查询视图 `DBA_OB_BACKUP_STORAGE_INFO` 进行确认。

   :::tab
   tab MySQL 模式

   * 确认备份路径的 `access_id` 和 `access_key` 信息

      ```shell
      obclient[oceanbase]> SELECT AUTHORIZATION FROM oceanbase.DBA_OB_BACKUP_STORAGE_INFO WHERE PATH='oss://oceanbase-test-bucket/backup/data' AND ENDPOINT = 'host=cn-****.aliyuncs.com';
      ```

      查询结果如下：

      ```shell
      +-------------------------------------+
      | AUTHORIZATION                       |
      +-------------------------------------+
      | access_id=******&encrypt_key=****** |
      +-------------------------------------+
      1 row in set
      ```

   * 确认归档路径的 `access_id` 和 `access_key` 信息

      ```shell
      obclient[oceanbase]> SELECT AUTHORIZATION FROM oceanbase.DBA_OB_BACKUP_STORAGE_INFO WHERE PATH='oss://oceanbase-test-bucket/backup/archive' AND ENDPOINT = 'host=cn-****.aliyuncs.com';
      ```

      查询结果如下：

      ```shell
      +-------------------------------------+
      | AUTHORIZATION                       |
      +-------------------------------------+
      | access_id=******&encrypt_key=****** |
      +-------------------------------------+
      1 row in set
      ```

   tab Oracle 模式

   * 确认备份路径的 `access_id` 和 `access_key` 信息

      ```shell
      obclient[SYS]> SELECT AUTHORIZATION FROM SYS.DBA_OB_BACKUP_STORAGE_INFO WHERE PATH='oss://oceanbase-test-bucket/backup/data' AND ENDPOINT = 'host=cn-****.aliyuncs.com';
      ```

      查询结果如下：

      ```shell
      +-------------------------------------+
      | AUTHORIZATION                       |
      +-------------------------------------+
      | access_id=******&encrypt_key=****** |
      +-------------------------------------+
      1 row in set
      ```

   * 确认归档路径的 `access_id` 和 `access_key` 信息

      ```shell
      obclient[SYS]> SELECT AUTHORIZATION FROM SYS.DBA_OB_BACKUP_STORAGE_INFO WHERE PATH='oss://oceanbase-test-bucket/backup/archive' AND ENDPOINT = 'host=cn-****.aliyuncs.com';
      ```

      查询结果如下：

      ```shell
      +-------------------------------------+
      | AUTHORIZATION                       |
      +-------------------------------------+
      | access_id=******&encrypt_key=****** |
      +-------------------------------------+
      1 row in set
      ```
   :::

## 相关文档

* [查看数据备份相关参数](400.data-backup/700.parameters-of-data-backup.md)

* [查看数据归档相关参数](300.log-archive/800.view-parameters-of-log-archive.md)

* [ALTER/CHANGE/MODIFY EXTERNAL_STORAGE_DEST](../../700.reference/500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/600.sql-statement-of-mysql-mode/1430.alter-system-change-external-storage-dest-of-mysql-mode.md)
