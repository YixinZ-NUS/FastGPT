|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 合并异常问题排查

合并异常是测试环境中的常见问题之一。合并异常可能导致查询变慢、磁盘空间占用异常、DDL 不生效、Checksum 报错等问题。

为了帮助大家快速定位问题根源并高效解决，本文总结了一套清晰、实用的合并异常排查流程。这套流程提供了明确的操作步骤，旨在提升问题处理效率，尽可能降低对业务的影响，为日常运维工作提供有力的支持。

合并异常问题的排查流程如下图所示。

![合并异常问题排查流程](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.5/management/merge-exception-troubleshooting2.png)

## 流程介绍

1. 查看系统表以及 RS 层合并发起的情况。

   1. 查看租户合并状态。在系统租户下，通过查看 `CDB_OB_MAJOR_COMPACTION` 视图，确认各个租户的合并状态。

      ```shell
      obclient(root@sys)[oceanbase]> SELECT * FROM oceanbase.CDB_OB_MAJOR_COMPACTION;
      ```

      根据查询结果，如果 `LAST_SCN = GLOBAL_BROADCAST_SCN`，则表示上一轮已完成合并的版本号与当前合并的版本号相同，该轮合并已结束。否则，需要根据其他字段进一步确认：

      * 如果 `IS_SUSPENDED` 列为 `True`，说明合并被手动挂起了，需要执行 SQL 语句 `ALTER SYSTEM RESUME MERGE TENANT tenant_name;` 进行恢复。

      * 如果 `STATUS` 持续为 `COMPACTING`，则表示合并卡住，需要进一步排查。

      * 如果 `IS_ERROR` 为非空，需进一步排查。如果 `IS_ERROR` 的值为 `CHECKSUM_ERROR`，则表示该租户下出现了 Checksum 校验不一致的问题。

   2. 查询当前租户所有 tablet 的合并进度，并过滤未合并到指定版本的记录。

      合并判定结束的逻辑，是查看该租户下所有的 Tablet（过滤掉一些不符合需求的 Tablet）是否已合并到指定版本号。只要有一个 Tablet 没有合并到指定版本，则该租户的合并就不会结束。接下来需要查看该租户下有哪些 Tablet 没有合并到指定版本。

      查询 `CDB_OB_TABLET_REPLICAS` 和 `CDB_OB_MAJOR_COMPACTION` 视图，以 `tenant_id = 1004` 为例。

      ```shell
      obclient(root@sys)[oceanbase]> SELECT
          t.svr_ip,
          t.svr_port,
          t.tenant_id,
          t.ls_id,
          t.tablet_id,
          t.compaction_scn AS tablet_version,
          m.global_broadcast_scn AS target_version
      FROM
          oceanbase.CDB_OB_TABLET_REPLICAS t,
          oceanbase.CDB_OB_MAJOR_COMPACTION m
      WHERE
          t.tenant_id = m.tenant_id
          AND t.tenant_id = 1004
          AND m.global_broadcast_scn > 0
          AND (t.compaction_scn < m.global_broadcast_scn)
      ORDER BY t.compaction_scn;
      ```

      根据查询结果：

      * 如果查询结果为 Null，则表示是在 RS 的校验阶段，合并正常。

      * 如果查询结果不为 Null，则查询出来的即为未合并到指定版本的 Tablet。

        其中，`compaction_scn` 字段来自 `CDB_OB_TABLET_REPLICAS` 视图，表示当前 Tablet 已完成合并的最大 SCN；`global_broadcast_scn` 字段来自 `CDB_OB_MAJOR_COMPACTION` 视图，表示本轮合并的目标版本。如果 `compaction_scn < global_broadcast_scn`，则表示有 Tablet 未完成合并，需要进一步排查。

   3. 如果有 Tablet 未完成合并，需要观察是否有 Tablet 正在执行合并任务。

      查询 `GV$OB_TABLET_COMPACTION_PROGRESS` 视图，以 `tenant_id = 1004` 为例。

      ```shell
      obclient(root@sys)[oceanbase]> SELECT * FROM oceanbase.GV$OB_TABLET_COMPACTION_PROGRESS WHERE tenant_id = 1004 AND type = "MAJOR_MERGE" AND status LIKE "%RUNNING%";
      ```

      根据查询结果，如果有 Tablet 正在执行合并，可以等待合并完成。等待一段时间后，如果没有任何 Tablet 在执行过程中，且通过 `CDB_OB_TABLET_REPLICAS` 和 `CDB_OB_MAJOR_COMPACTION` 视图查出来的未完成合并的 Tablet 个数没有减少，可以查询合并诊断视图，进一步定位问题。

2. 查询合并诊断视图，获取诊断信息。

   合并诊断视图中有合并过程中的各种异常报错信息，可以用来辅助排查。以 `tenant_id = 1004` 且未完成合并的 Tablet 的 `Tablet_ID = 200001` 为例。

   ```shell
   obclient(root@sys)[oceanbase]> SELECT * FROM oceanbase.GV$OB_COMPACTION_DIAGNOSE_INFO WHERE TENANT_ID = 1004 AND TABLET_ID = 200001\G
   ```

   根据 `diagnose_info` 字段展示的信息，进行接下来的处理：

   * `weak read ts is not ready` 或 `slave_read_version is less than freeze_ts, can not merge`：表示备机读未推过 Major 点导致合并异常，请联系技术支持协助处理。

   * `memtable can not minor merge`：表示 MemTable 未达到转储条件，导致 Mini Compaction 慢、clog 回收慢、内存爆，请联系技术支持协助处理。

   * `sstable count is not safe`：表示 SSTable 数量过多，导致无法做 Mini compaction、clog 回收慢、内存爆。请联系技术支持协助处理。

     同时，`diagnose_info` 中还会展示导致 SSTable 数量过多的原因：

     * `SNAPSHOT_FOR_MAJOR`：Major Compaction

     * `SNAPSHOT_FOR_DDL`：表的 DDL，例如：建索引。

     * `SNAPSHOT_FOR_MULTI_VERSION`：多版本数据过多，`undo_retention` 的值过大。

   * `dag may hang`：DAG 一段时间未更新，可能卡住，如果超过 10 分钟一直保持这个状态，请联系技术支持人员协助处理。

   * `freeze_info is invalid`：没有刷到 freeze_info，导致合并异常。请联系技术支持人员协助处理。

   * `memtable rec_log_ts not stable`：日志流冻结过程中连续最大回调（回放）点长时间没有推过对应 Tablet 的 MemTable 的 `rec_log_ts` 更深层次的原因是回调（回放）慢。请联系技术支持人员协助处理。

   * `traverse_trans_to_submit_redo_log failed`：提交 redo log 失败，请联系技术支持人员协助处理。

   * `trans table has not merged, can not schedule minor merge`：V3.2.x 版本事务状态表转储成功之后，数据表才能发起转储，可能导致数据表不转储。请联系技术支持人员协助处理。

   * `memtable not ready for flush`：日志流冻结过程中有 MemTable 长时间没有达到转储条件，可能导致转储超时、内存爆。请联系技术支持人员协助处理。

   * `memtable no destroy after release`：MemTable 释放后长时间没有被 Destroy，主要原因是 MemTable 引用计数泄漏。请联系技术支持人员协助处理。

   * `memtable can not create dag successfully`：MemTable 达到转储条件后，长时间没有成功发起转储任务。请联系技术支持人员协助处理。

   * `compaction has finished in storage`：存储层合并结束但 RS 后续处理未完成。请联系技术支持人员协助处理。

   * `there is too many tablets. tablet count xxx`：诊断时需要遍历的分区过多，跳过了该 LS 的诊断。

3. 根据合并诊断视图中的报错信息，可以对问题进行分类，具体问题可以参考相关文档或典型案例进行排查。

## 典型案例

以下案例不区分模式。

* OceanBase 数据库 V4.3 版本中集群合并卡住，部分 Tablet 合并出现 `-4016` 异常。具体排查操作参见 [OceanBase 数据库 V4.3 版本中集群合并出现 tablet haven't kept medium snapshot(ret=-4016 的原因及处理方法](https://www.oceanbase.com/knowledge-base/oceanbase-database-1000000002397189?back=kb)。

* 当 table 数量超过高水位时，便不能添加新的 SSTable 到数组里，由此可能导致不能做 Mini Merge。遇到类似的情况，参考 [SSTable 数量太多的问题排查](https://www.oceanbase.com/knowledge-base/oceanbase-database-1000000000994204)。

* 当在变更 locality 过程中，若将 locality 从 `z1,z2` 变更为 `z1,z2,z3`，且在新增加的 `z3` 上的 Zone 日志流成为 Leader，可能会导致数据合并操作卡住。具体排查操作参见 [locality 变更卡住导致合并卡住的排查方法](https://www.oceanbase.com/knowledge-base/oceanbase-database-1000000001031113)。

* 当各个 Zone 合并完成变为 idle 状态后，集群的合并状态依然为 `merging`。具体排查操作参见 [各个 Zone 合并完成变为 idle 状态后，集群的合并状态依然为 merging](https://www.oceanbase.com/knowledge-base/oceanbase-database-1000000000267190?back=kb)。

* 集群合并卡住，合并过程中带宽被打满时，详细排查操作参见 [集群合并卡住，合并过程中带宽被打满的原因及处理方法](https://www.oceanbase.com/knowledge-base/oceanbase-database-1000000000905872?back=kb)。

* 在 OceanBase 数据库 V4.x 版本中，如何排查合并卡住问题，参见 [如何排查合并卡住问题](https://www.oceanbase.com/knowledge-base/oceanbase-database-1000000000685150?back=kb)。

* 在 Oceanbase 数据库 V4.x 版本中，如何排查 RS 端合并卡住问题，参见 [V4.x 版本 RS 端合并卡住排查手册](https://www.oceanbase.com/knowledge-base/oceanbase-database-1000000000816610)。

## 相关文档

* [查看合并信息](../../700.reference/200.system-management/500.manage-data-storage/200.merge-management/500.view-merge-process.md)

* [查看转储信息](../../700.reference/200.system-management/500.manage-data-storage/100.dump-management/400.view-dump-information.md)

* [GV$OB_COMPACTION_DIAGNOSE_INFO](../../700.reference/700.system-views/300.system-view-of-sys-tenant/300.performance-view-of-sys-tenant/500.gv-ob_compaction_diagnose_info-of-sys-tenant.md)