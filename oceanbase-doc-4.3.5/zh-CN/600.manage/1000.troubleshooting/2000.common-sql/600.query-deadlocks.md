|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 查死锁

## 查询死锁检测参数

在 OceanBase 数据库中，与死锁检测相关的配置项为集群级隐藏配置项 `_lcl_op_interval`。该配置项用于控制 LCL（Lock Chain Length）死锁检测算法中节点间消息推送的间隔时间。

在 OceanBase 数据库 V4.x 版本中，隐藏配置项 `_lcl_op_interval` 的默认值为 30 ms，即默认开启死锁检测。该配置项的值越小，则死锁检测的延迟越低，系统资源消耗越多；值越大，死锁检测的延迟越高，资源占用越少。

当 `_lcl_op_interval` 的值设置为 0ms 时，表示关闭 LCL 死锁检测功能。通常情况下，建议关闭 LCL 死锁检测功能。关闭后，死锁依赖事务超时回滚机制处理（事务默认超时时间由变量 ob_trx_timeout 控制）。

查询死锁检测功能是否开启的方法如下：

### 使用视图查询

视图 `GV$OB_PARAMETERS` 记录了集群中的所有配置项（含隐藏配置项，即 `_xx_xx` 格式的配置项）及其所有属性描述。用户可以通过该视图查询隐藏配置项 `_lcl_op_interval` 的值。

* 系统租户

  系统租户下，可以通过以下语句进行查询。

  ```shell
  obclient> SELECT * FROM oceanbase.GV$OB_PARAMETERS WHERE NAME='_lcl_op_interval';
  ```

* 用户租户

  MySQL 模式的用户租户下，可以通过以下语句进行查询。

  ```shell
  obclient> SELECT * FROM oceanbase.GV$OB_PARAMETERS WHERE NAME='_lcl_op_interval';
  ```

  Oracle 模式的用户租户下，可以通过以下语句进行查询。

  ```shell
  obclient> SELECT * FROM SYS.GV$OB_PARAMETERS WHERE NAME='_lcl_op_interval';
  ```

### 使用 SHOW 语句查询

仅当隐藏配置项 `_lcl_op_interval` 的值被修改为非默认值后，可以通过以下语句查看。

```shell
obclient> SHOW PARAMETERS LIKE '%_lcl_op_interval%';
```

## 查询死锁事件

视图 `CDB_OB_DEADLOCK_EVENT_HISTORY`（系统租户） 或 `DBA_OB_DEADLOCK_EVENT_HISTORY` （用户租户）中记录了所有发生过的死锁事件以及参与这些事件的事务，并展示了在一个死锁事件中哪个事务最终被 kill。

* 系统租户

  系统租户下，可以通过以下语句进行查询。

  ```shell
  obclient [oceanbase]> SELECT * FROM oceanbase.CDB_OB_DEADLOCK_EVENT_HISTORY WHERE TENANT_ID=tenant_id;
  ```

* 用户租户

  MySQL 模式的用户租户下，可以通过以下语句进行查询。

  ```shell
  obclient [oceanbase]> SELECT * FROM oceanbase.DBA_OB_DEADLOCK_EVENT_HISTORY;
  ```

  Oracle 模式的用户租户下，可以通过以下语句进行查询。

  ```shell
  obclient [SYS]> SELECT * FROM SYS.DBA_OB_DEADLOCK_EVENT_HISTORY;
  ```
