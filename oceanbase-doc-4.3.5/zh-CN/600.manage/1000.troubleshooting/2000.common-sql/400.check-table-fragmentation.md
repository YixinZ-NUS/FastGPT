|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 查询表的碎片

在数据库中，表碎片是指已分配但未实际存储数据的磁盘空间。表碎片主要由以下操作产生：

* 频繁的 DELETE 或 UPDATE 操作：数据删除后，原空间被标记为“可复用”但未被立即回收，形成空洞即碎片。

* 页分裂（Page Split）：当数据更新导致页（Page）容量不足时，存储引擎会将页分裂成多个不连续的块，产生碎片。

在 OceanBase 数据库 V4.x 版本中，可以通过视图 `CDB_OB_TABLE_SPACE_USAGE`（系统租户） 或 `DBA_OB_TABLE_SPACE_USAGE`（用户租户） 来查询表碎片。

* 系统租户

  系统租户下，可以通过以下语句进行查询。

  ```shell
  obclient> SELECT DATABASE_NAME,TABLE_NAME,
    ROUND(OCCUPY_SIZE / 1024 / 1024 / 1024, 2) AS DATA_GB,
    ROUND(REQUIRED_SIZE / 1024 / 1024 / 1024, 2) AS ALLOCATED_GB,
    ROUND((REQUIRED_SIZE - OCCUPY_SIZE) / 1024 / 1024 / 1024, 2) AS EMPTY_GB
  FROM oceanbase.CDB_OB_TABLE_SPACE_USAGE
  WHERE TENANT_NAME = 'tenant_name'
  ORDER BY EMPTY_GB DESC;
  ```

* 用户租户

  MySQL 模式的用户租户下，可以通过以下语句进行查询。

  ```shell
  obclient> SELECT DATABASE_NAME,TABLE_NAME,
    ROUND(OCCUPY_SIZE / 1024 / 1024 / 1024, 2) AS DATA_GB,
    ROUND(REQUIRED_SIZE / 1024 / 1024 / 1024, 2) AS ALLOCATED_GB,
    ROUND((REQUIRED_SIZE - OCCUPY_SIZE) / 1024 / 1024 / 1024, 2) AS EMPTY_GB
  FROM oceanbase.DBA_OB_TABLE_SPACE_USAGE
  ORDER BY EMPTY_GB DESC;
  ```

  Oracle 模式的用户租户下，可以通过以下语句进行查询。

  ```shell
  obclient> SELECT DATABASE_NAME,TABLE_NAME,
    ROUND(OCCUPY_SIZE / 1024 / 1024 / 1024, 2) AS DATA_GB,
    ROUND(REQUIRED_SIZE / 1024 / 1024 / 1024, 2) AS ALLOCATED_GB,
    ROUND((REQUIRED_SIZE - OCCUPY_SIZE) / 1024 / 1024 / 1024, 2) AS EMPTY_GB
  FROM SYS.DBA_OB_TABLE_SPACE_USAGE
  ORDER BY EMPTY_GB DESC;
  ```

语句中：

* `DATA_GB`：表压缩后实际存储的数据量。

* `ALLOCATED_GB`：表压缩后存储的数据实际占用了多少磁盘空间。

  OceanBase 数据库的存储以宏块（默认占 2MB）为单位分配，表示实际分配的宏块总量，即使数据未填满也会占用完整宏块。

* `EMPTY_GB`：碎片空间，即 `ALLOCATED_GB - DATA_GB `的值，表示未有效利用的存储空间。
