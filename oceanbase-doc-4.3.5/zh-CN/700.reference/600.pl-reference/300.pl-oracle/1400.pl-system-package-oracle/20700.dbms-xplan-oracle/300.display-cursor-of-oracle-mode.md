| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   | Oracle Mode     |
|machine-translation||

# DISPLAY_CURSOR

`DISPLAY_CURSOR` 函数用于展示已执行的查询计划详情。

## 使用限制

对于 V4.3.5 版本，该功能从 V4.3.5 BP2 版本开始支持。

## 语法

```sql
DBMS_XPLAN.DISPLAY_CURSOR(plan_id      INTEGER          DEFAULT    0,         -- default value: last plan
                          format       VARCHAR2         DEFAULT    'TYPICAL',
                          svr_ip       VARCHAR2         DEFAULT    null,   -- default value: server connected by client
                          svr_port     INTEGER          DEFAULT    0,     -- default value: server connected by client
                          tenant_id    INTEGER          DEFAULT    0,     -- default value: current tenant
                          sql_handle   VARCHAR2         DEFAULT    NULL,
                          plan_name    VARCHAR2         DEFAULT    NULL
                        )
RETURN DBMS_XPLAN_TYPE_TABLE;
```

## 参数解释

| 参数 | 说明 |
| ---- | ---- |
| plan_id     | 执行计划的 ID。如果不指定，则使用上一次执行的计划。 |
| format      | 指定计划格式信息，可选参数如下：<ul><li>`'BASIC'`：展示少量信息，例如算子 ID、算子名称、算子备注信息、表达式信息。</li><li> `'TYPICAL'`：展示基础信息，例如算子 ID、算子名称、算子备注信息、优化器估计的输出行数、优化器估计的执行时间，表达式信息。如果该计划执行过，还会展示计划第一次执行真实反馈信息，例如真实行数，开销等等。</li><li> `'ALL'`：展示丰富的计划信息，例如算子 ID、算子名称、算子备注信息、优化器估计的输出行数、优化器估计的执行时间，表达式信息、生效的 Hint、Query Block Name Trace 信息、Outline 信息、基表优化信息、常量参数化信息、约束信息、Plan Note 等。</li><li> `'ADVANCED'`：展示丰富的计划信息，计划信息与 'ALL' 参数一致，除此之外还为复杂的计划展示树状结构信息。</li></ul> |
| svr_ip      | 计划所在的节点 IP，默认是 Session 连接的节点 IP。|
| svr_port    | 计划所在的节点端口号，默认是 Session 连接的节点端口号。|
| tenant_id   | 计划所属租户 ID，默认是 Session 当前连接的租户。|
| sql_handle  | 执行计划用于标识 SQL 语句的句柄（Handle）。当查询某条 SQL 语句的特定执行计划时，在存在多条相似 SQL 时，可通过 sql_handle 精准指定目标语句。|
| plan_name   | 执行计划的名称。|

## 示例

Oracle 租户需要配合 Function Table 功能使用。

1. 创建表。

    ```shell
    obclient [test]> CREATE TABLE t1(c1 INT);
    ```

2. 执行查询。

    ```shell
    obclient [SYS]> SELECT * FROM t1;
    ```

3. 使用 `DBMS_XPLAN` 包查看历史计划。

   * 不指定参数查询。

      ```shell
      obclient [SYS]> SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY_CURSOR());
      ```

      查询结果如下：

      ```shell
      +--------------------------------------------------------------------------------------------------+
      | COLUMN_VALUE                                                                                     |
      +--------------------------------------------------------------------------------------------------+
      | ================================================================================================ |
      | |ID|OPERATOR       |NAME|EST.ROWS|EST.TIME(us)|REAL.ROWS|REAL.TIME(us)|IO TIME(us)|CPU TIME(us)| |
      | ------------------------------------------------------------------------------------------------ |
      | |0 |TABLE FULL SCAN|T1  |1       |4           |0        |0            |0          |48          | |
      | ================================================================================================ |
      | Outputs & filters:                                                                               |
      | -------------------------------------                                                            |
      |   0 - output([T1.C1]), filter(nil), rowset=16                                                    |
      |       access([T1.C1]), partitions(p0)                                                            |
      |       is_index_back=false, is_global_index=false,                                                |
      |       range_key([T1.__pk_increment]), range(MIN ; MAX)always true                                |
      +--------------------------------------------------------------------------------------------------+
      11 rows in set (0.135 sec)
      ```

   * 指定参数查询。

      ```shell
      obclient [SYS]> SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY_CURSOR(2574, 'typical', 'xx.xx.xx.xx', 2882, 1004, '836B328E0F78A3AD873B24C07BF02D71', '16232266100518399368'));
      ```

      查询结果如下：

      ```shell
      +-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | COLUMN_VALUE                                                                                                                                                                                              |
      +-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | =============================================================================================================================                                                                             |
      | |ID|OPERATOR               |NAME                     |EST.ROWS|EST.TIME(us)|REAL.ROWS|REAL.TIME(us)|IO TIME(us)|CPU TIME(us)|                                                                             |
      | -----------------------------------------------------------------------------------------------------------------------------                                                                             |
      | |0 |LIMIT                  |                         |1       |90376       |1        |1055         |0          |2           |                                                                             |
      | |0 |LIMIT                  |                         |1       |90376       |1        |1055         |0          |2           |                                                                             |
      | |0 |LIMIT                  |                         |1       |90376       |1        |1055         |0          |2           |                                                                             |
      | |0 |LIMIT                  |                         |1       |90376       |1        |1055         |0          |2           |                                                                             |
      | |0 |LIMIT                  |                         |1       |90376       |1        |1055         |0          |2           |                                                                             |
      | |0 |LIMIT                  |                         |1       |90376       |1        |1055         |0          |2           |                                                                             |
      | |0 |LIMIT                  |                         |1       |90376       |1        |1055         |0          |2           |                                                                             |
      | |1 |└─HASH OUTER JOIN      |                         |1       |90376       |1        |1055         |0          |170         |                                                                             |
      | |1 |  HASH OUTER JOIN      |                         |1       |90376       |1        |1055         |0          |170         |                                                                             |
      | |1 |  HASH OUTER JOIN      |                         |1       |90376       |1        |1055         |0          |170         |                                                                             |
      | |1 |  HASH OUTER JOIN      |                         |1       |90376       |1        |1055         |0          |170         |                                                                             |
      | |1 |  HASH OUTER JOIN      |                         |1       |90376       |1        |1055         |0          |170         |                                                                             |
      | |1 |  HASH OUTER JOIN      |                         |1       |90376       |1        |1055         |0          |170         |                                                                             |
      | |1 |  HASH OUTER JOIN      |                         |1       |90376       |1        |1055         |0          |170         |                                                                             |
      | |2 |  ├─SUBPLAN SCAN       |VIEW2                    |1       |89234       |1        |1055         |0          |2           |                                                                             |
      | |2 |  ├─SUBPLAN SCAN       |VIEW2                    |1       |89234       |1        |1055         |0          |2           |                                                                             |
      | |2 |  ├─SUBPLAN SCAN       |VIEW2                    |1       |89234       |1        |1055         |0          |2           |                                                                             |
      | |2 |  ├─SUBPLAN SCAN       |VIEW2                    |1       |89234       |1        |1055         |0          |2           |                                                                             |
      | |2 |  ├─SUBPLAN SCAN       |VIEW2                    |1       |89234       |1        |1055         |0          |2           |                                                                             |
      | |2 |  ├─SUBPLAN SCAN       |VIEW2                    |1       |89234       |1        |1055         |0          |2           |                                                                             |
      | |2 |  ├─SUBPLAN SCAN       |VIEW2                    |1       |89234       |1        |1055         |0          |2           |                                                                             |
      | |3 |  │ └─LIMIT            |                         |1       |89234       |1        |1055         |0          |1           |                                                                             |
      | |3 |  │   LIMIT            |                         |1       |89234       |1        |1055         |0          |1           |                                                                             |
      | |3 |  │   LIMIT            |                         |1       |89234       |1        |1055         |0          |1           |                                                                             |
      | |3 |  │   LIMIT            |                         |1       |89234       |1        |1055         |0          |1           |                                                                             |
      | |3 |  │   LIMIT            |                         |1       |89234       |1        |1055         |0          |1           |                                                                             |
      | |3 |  │   LIMIT            |                         |1       |89234       |1        |1055         |0          |1           |                                                                             |
      | |3 |  │   LIMIT            |                         |1       |89234       |1        |1055         |0          |1           |                                                                             |
      | |4 |  │   └─TABLE FULL SCAN|ALL_VIRTUAL_ASH          |11001   |89205       |1        |1055         |0          |375         |                                                                             |
      | |4 |  │     TABLE FULL SCAN|ALL_VIRTUAL_ASH          |11001   |89205       |1        |1055         |0          |375         |                                                                             |
      | |4 |  │     TABLE FULL SCAN|ALL_VIRTUAL_ASH          |11001   |89205       |1        |1055         |0          |375         |                                                                             |
      | |4 |  │     TABLE FULL SCAN|ALL_VIRTUAL_ASH          |11001   |89205       |1        |1055         |0          |375         |                                                                             |
      | |4 |  │     TABLE FULL SCAN|ALL_VIRTUAL_ASH          |11001   |89205       |1        |1055         |0          |375         |                                                                             |
      | |4 |  │     TABLE FULL SCAN|ALL_VIRTUAL_ASH          |11001   |89205       |1        |1055         |0          |375         |                                                                             |
      | |4 |  │     TABLE FULL SCAN|ALL_VIRTUAL_ASH          |11001   |89205       |1        |1055         |0          |375         |                                                                             |
      | |5 |  └─SUBPLAN SCAN       |V$EVENT_NAME             |334     |1108        |1        |1055         |0          |2           |                                                                             |
      | |5 |    SUBPLAN SCAN       |V$EVENT_NAME             |334     |1108        |1        |1055         |0          |2           |                                                                             |
      | |5 |    SUBPLAN SCAN       |V$EVENT_NAME             |334     |1108        |1        |1055         |0          |2           |                                                                             |
      | |5 |    SUBPLAN SCAN       |V$EVENT_NAME             |334     |1108        |1        |1055         |0          |2           |                                                                             |
      | |5 |    SUBPLAN SCAN       |V$EVENT_NAME             |334     |1108        |1        |1055         |0          |2           |                                                                             |
      | |5 |    SUBPLAN SCAN       |V$EVENT_NAME             |334     |1108        |1        |1055         |0          |2           |                                                                             |
      | |5 |    SUBPLAN SCAN       |V$EVENT_NAME             |334     |1108        |1        |1055         |0          |2           |                                                                             |
      | |6 |    └─TABLE FULL SCAN  |TENANT_VIRTUAL_EVENT_NAME|334     |1107        |1        |1055         |0          |37          |                                                                             |
      | |6 |      TABLE FULL SCAN  |TENANT_VIRTUAL_EVENT_NAME|334     |1107        |1        |1055         |0          |37          |                                                                             |
      | |6 |      TABLE FULL SCAN  |TENANT_VIRTUAL_EVENT_NAME|334     |1107        |1        |1055         |0          |37          |                                                                             |
      | |6 |      TABLE FULL SCAN  |TENANT_VIRTUAL_EVENT_NAME|334     |1107        |1        |1055         |0          |37          |                                                                             |
      | |6 |      TABLE FULL SCAN  |TENANT_VIRTUAL_EVENT_NAME|334     |1107        |1        |1055         |0          |37          |                                                                             |
      | |6 |      TABLE FULL SCAN  |TENANT_VIRTUAL_EVENT_NAME|334     |1107        |1        |1055         |0          |37          |                                                                             |
      | |6 |      TABLE FULL SCAN  |TENANT_VIRTUAL_EVENT_NAME|334     |1107        |1        |1055         |0          |37          |                                                                             |
      | =============================================================================================================================                                                                             |
      | Outputs & filters:                                                                                                                                                                                        |
      | -------------------------------------                                                                                                                                                                     |
      |   0 - output([VIEW2.cast(ALL_VIRTUAL_ASH.SVR_IP, VARCHAR2(46 BYTE))], [VIEW2.cast(ALL_VIRTUAL_ASH.SVR_PORT, NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.SAMPLE_ID,                                     |
      |        NUMBER(-1, -85))], [VIEW2.ALL_VIRTUAL_ASH.SAMPLE_TIME], [cast(VIEW2.ALL_VIRTUAL_ASH.TENANT_ID, NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.USER_ID,                                             |
      |       NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.SESSION_ID, NUMBER(-1, -85))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.SESSION_TYPE, 0, cast('FOREGROUND',                                            |
      |        VARCHAR2(10 BYTE)), cast('BACKGROUND', VARCHAR2(10 BYTE))), VARCHAR2(10 BYTE))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.EVENT_NO, 0, cast('ON CPU', VARCHAR2(7                                     |
      |       BYTE)), cast('WAITING', VARCHAR2(7 BYTE))), VARCHAR2(7 BYTE))], [cast(VIEW2.ALL_VIRTUAL_ASH.SQL_ID, VARCHAR2(32 BYTE))], [cast(VIEW2.ALL_VIRTUAL_ASH.PLAN_ID,                                       |
      |        NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.TRACE_ID, VARCHAR2(64 BYTE))], [cast(V$EVENT_NAME.NAME, VARCHAR2(64 BYTE))], [cast(VIEW2.ALL_VIRTUAL_ASH.EVENT_NO,                                  |
      |        NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.EVENT_ID, NUMBER(-1, -85))], [cast(V$EVENT_NAME.PARAMETER1, VARCHAR2(64 BYTE))], [cast(VIEW2.ALL_VIRTUAL_ASH.P1,                                    |
      |        NUMBER(-1, -85))], [cast(V$EVENT_NAME.PARAMETER2, VARCHAR2(64 BYTE))], [cast(VIEW2.ALL_VIRTUAL_ASH.P2, NUMBER(-1, -85))], [cast(V$EVENT_NAME.PARAMETER3,                                           |
      |        VARCHAR2(64 BYTE))], [cast(VIEW2.ALL_VIRTUAL_ASH.P3, NUMBER(-1, -85))], [cast(V$EVENT_NAME.WAIT_CLASS, VARCHAR2(64 BYTE))], [cast(V$EVENT_NAME.WAIT_CLASS_ID,                                      |
      |        NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.TIME_WAITED, NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.SQL_PLAN_LINE_ID, NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.GROUP_ID,              |
      |        NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.PLAN_HASH, NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.THREAD_ID, NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.STMT_TYPE,                      |
      |        NUMBER(-1, -85))], [cast(VIEW2.ALL_VIRTUAL_ASH.TIME_MODEL, NUMBER(-1, -85))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_PARSE, 1, cast('Y', VARCHAR2(1                                             |
      |       BYTE)), cast('N', VARCHAR2(1 BYTE))), VARCHAR2(1 BYTE))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_PL_PARSE, 1, cast('Y', VARCHAR2(1 BYTE)), cast('N',                                             |
      |       VARCHAR2(1 BYTE))), VARCHAR2(1 BYTE))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_PLAN_CACHE, 1, cast('Y', VARCHAR2(1 BYTE)), cast('N', VARCHAR2(1 BYTE))),                                         |
      |        VARCHAR2(1 BYTE))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_SQL_OPTIMIZE, 1, cast('Y', VARCHAR2(1 BYTE)), cast('N', VARCHAR2(1 BYTE))), VARCHAR2(1 BYTE))],                                      |
      |        [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_SQL_EXECUTION, 1, cast('Y', VARCHAR2(1 BYTE)), cast('N', VARCHAR2(1 BYTE))), VARCHAR2(1 BYTE))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_PX_EXECUTION, |
      |        1, cast('Y', VARCHAR2(1 BYTE)), cast('N', VARCHAR2(1 BYTE))), VARCHAR2(1 BYTE))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_SEQUENCE_LOAD, 1, cast('Y',                                            |
      |        VARCHAR2(1 BYTE)), cast('N', VARCHAR2(1 BYTE))), VARCHAR2(1 BYTE))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_COMMITTING, 1, cast('Y', VARCHAR2(1 BYTE)),                                         |
      |        cast('N', VARCHAR2(1 BYTE))), VARCHAR2(1 BYTE))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_STORAGE_READ, 1, cast('Y', VARCHAR2(1 BYTE)), cast('N', VARCHAR2(1                                     |
      |       BYTE))), VARCHAR2(1 BYTE))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_STORAGE_WRITE, 1, cast('Y', VARCHAR2(1 BYTE)), cast('N', VARCHAR2(1 BYTE))), VARCHAR2(1                                      |
      |       BYTE))], [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_REMOTE_DAS_EXECUTION, 1, cast('Y', VARCHAR2(1 BYTE)), cast('N', VARCHAR2(1 BYTE))), VARCHAR2(1 BYTE))],                                          |
      |        [cast(ora_decode(VIEW2.ALL_VIRTUAL_ASH.IN_FILTER_ROWS, 1, cast('Y', VARCHAR2(1 BYTE)), cast('N', VARCHAR2(1 BYTE))), VARCHAR2(1 BYTE))], [cast(CASE WHEN                                           |
      |       BITAND(VIEW2.ALL_VIRTUAL_ASH.TIME_MODEL, 16384) > 0 THEN 'Y' ELSE 'N' END, VARCHAR2(1 BYTE))], [cast(CASE WHEN BITAND(VIEW2.ALL_VIRTUAL_ASH.TIME_MODEL,                                             |
      |       32768) > 0 THEN 'Y' ELSE 'N' END, VARCHAR2(1 BYTE))], [cast(CASE WHEN BITAND(VIEW2.ALL_VIRTUAL_ASH.TIME_MODEL, 65536) > 0 THEN 'Y' ELSE 'N' END, VARCHAR2(1                                         |
      |       BYTE))], [cast(VIEW2.ALL_VIRTUAL_ASH.PROGRAM, VARCHAR2(64 BYTE))], [cast(VIEW2.ALL_VIRTUAL_ASH.MODULE, VARCHAR2(64 BYTE))], [cast(VIEW2.ALL_VIRTUAL_ASH.ACTION,                                     |
      |        VARCHAR2(64 BYTE), filter(nil)                                                                                                                                                                     |
      |       limit(1), offset(nil)                                                                                                                                                                               |
      +-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      109 rows in set (0.026 sec)
      ```
