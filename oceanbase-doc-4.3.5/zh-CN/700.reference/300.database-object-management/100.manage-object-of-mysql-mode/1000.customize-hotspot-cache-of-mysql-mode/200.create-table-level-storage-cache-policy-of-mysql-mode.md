|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|

# 创建表级热点缓存策略

本文将向您介绍如何使用 SQL 语句创建表级热点缓存策略（`STORAGE_CACHE_POLICY`）：

* 创建普通表的热点缓存策略。
* 创建索引表的热点缓存策略。

## 注意事项

在共享存储模式下，才可以在创建表/索引时指定热点缓存策略。

## 创建普通表的热点缓存策略

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>对于 OceanBase 数据库 V4.3.5 版本，从 V4.3.5 BP2 版本开始在共享存储模式下，支持创建表时指定表级热点缓存策略的功能。</p>
</main>

创建表时指定表级别热点缓存策略是在 `CREATE TABLE` 语句后增加表选项 `STORAGE_CACHE_POLICY`，语法格式如下：

```sql
CREATE TABLE table_name (table_definition_list)
    STORAGE_CACHE_POLICY (storage_cache_policy_option);

storage_cache_policy_option:
    GLOBAL = {"hot" | "auto"}
    | timeline_strategy_list

timeline_strategy_list:
    BOUNDARY_COLUMN = column_name
    | BOUNDARY_COLUMN_UNIT = {"s" | "ms"}
    | HOT_RETENTION = intnum retention_time_unit

retention_time_unit:
    YEAR
    | MONTH
    | WEEK
    | DAY
    | HOUR
    | MINUTE
```

### 相关参数说明

`STORAGE_CACHE_POLICY` 为可选项，如果不指定 `STORAGE_CACHE_POLICY` 选项，则建表时默认使用租户配置项 [default_storage_cache_policy](../../../800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/2120.default_storage_cache_policy.md) 的值。`storage_cache_policy_option` 中不同属性以 Key-Value 格式定义。各个属性的语意如下：

* `GLOBAL = {"hot" | "auto"}`：用于指定全表数据的热点缓存策略，取值如下：

  * `hot`：表示指定表的所有数据都为热数据，在缓存盘空间足够的情况下，表下所有数据将会缓存到本地缓存盘。
  * `auto`：表示指定表的热数据为系统自动识别。

* `timeline_strategy_list`：表示时间轴策略参数列表，各参数间使用英文逗号分隔。热点缓存时间轴策略支持通过时间来判断分区数据是否为热数据的机制，系统根据配置的策略，自动调整本地缓存盘上的分区数据。

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>时间轴：按照 Range 分区定义的分区范围取值进行热数据缓存，当满足一定时间条件时，该分区的数据被判定为热数据。使用时间轴策略时，需要注意以下事项：<ul><li>仅支持 Range 分区表使用（Range 分区为一级或者二级都可以），因为需要时间来确定是否过期，但不能是双 Range 分区，会因为无法确定以哪个 Range 分区时间为准。</li><li>使用时间轴时，分区表达中只能有列名，不支持表达式转换。例如 <code>PARTITION BY RANGE COLUMNS(expr(col3))</code>。</li><li><code>BOUNDARY_COLUMN</code> 必须为分区键，如果分区键有多列，<code>BOUNDARY_COLUMN</code> 需为第一列，用来判断分区是否过期。</li></ul></p>
  </main>

  * `BOUNDARY_COLUMN = column_name`：用于判定热数据的列。支持整型（`BIGINT` 或者 `INT` 类型，格式为 Unix 时间戳）和时间类型（`TIMESTAMP`、`DATE`、`DATETIME` 或者 `YEAR` 类型）。

    * 如果 `BOUNDARY_COLUMN` 类型为整型时，表的分区方式支持 Range/Range Columns 分区类型。
    * 如果 `BOUNDARY_COLUMN` 类型为时间类型时，表的分区方式只能使用 Range Columns 分区类型。

  * `BOUNDARY_COLUMN_UNIT = {"s" | "ms"}`：用于指定参数 `BOUNDARY_COLUMN` 的时间单位。仅支持 `BOUNDARY_COLUMN` 为整型时设置此参数，整型数值用作时间戳时，需要给定时间戳单位，否则可能会导致错解析出来错误的时间。取值如下：

    * 当分区列为 `INT` 类型时，`BOUNDARY_COLUMN_UNIT` 取值只能为 `s`。
    * 当分区列为 `BIGINT` 类型时，`BOUNDARY_COLUMN_UNIT` 取值可以是 `s` 或者 `ms`。

      <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>如果格式非 Unix 时间戳，将不能正确识别 <code>INT</code> 类型表示的时间。</p>
      </main>

  * `HOT_RETENTION = intnum retention_time_unit`：用于配置热数据的时间范围。

    * `intnum`：表示整数。
    * `retention_time_unit`：表示时间单位，取值如下：

      * `YEAR`：表示年。
      * `MONTH`：表示月。
      * `WEEK`：表示周。
      * `DAY`：表示天。
      * `HOUR`：表示小时。
      * `MINUTE`：表示分钟。

### 示例

* 手动方式指定热点数据。

    ```sql
    CREATE TABLE tbl1 (
        col1 INT,
        col2 INT)
        STORAGE_CACHE_POLICY (GLOBAL = "hot");
    ```

* 时间轴方式指定热点数据。

    ```sql
    CREATE TABLE tbl2 (
        col1 BIGINT NOT NULL,
        col2 VARCHAR(50),
        col3  DATE NOT NULL)
        STORAGE_CACHE_POLICY (
            BOUNDARY_COLUMN = col3,
            HOT_RETENTION = 1 MONTH)
        PARTITION BY RANGE COLUMNS(col3) (
            PARTITION M202001 VALUES LESS THAN('2020/02/01'),
            PARTITION M202002 VALUES LESS THAN('2020/03/01'),
            PARTITION M202003 VALUES LESS THAN('2020/04/01'),
            PARTITION MMAX VALUES LESS THAN MAXVALUE);
    ```

## 创建索引表的热点缓存策略

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>对于 OceanBase 数据库 V4.3.5 版本，从 V4.3.5 BP2 版本开始在共享存储模式下，支持指定索引热点缓存策略的功能。</p>
</main>

可以使用以下方式指定索引热点缓存策略：

* 创建索引时，指定索引的表级热点缓存策略。
* 创建表时创建索引，指定索引的表级热点缓存策略。
* 给已有表增加索引时，指定索引的表级热点缓存策略。

更多有关创建索引的详细介绍，参见 [创建索引](../500.manage-indexes-of-mysql-mode/200.create-an-index-of-mysql-mode.md)。

### 创建索引时，指定索引的表级热点缓存策略

语法格式如下：

```sql
CREATE INDEX index_name ON table_name (column_name)
    STORAGE_CACHE_POLICY (storage_cache_policy_option);

storage_cache_policy_option:
    GLOBAL = {"hot" | "auto" | "none"}
    | timeline_strategy_list

timeline_strategy_list:
    BOUNDARY_COLUMN = column_name
    | BOUNDARY_COLUMN_UNIT = {"s" | "ms"}
    | HOT_RETENTION = intnum retention_time_unit

retention_time_unit:
    YEAR
    | MONTH
    | WEEK
    | DAY
    | HOUR
    | MINUTE
```

### 创建表时创建索引，指定索引的表级热点缓存策略

语法格式如下：

```sql
CREATE TABLE table_name (
    column_name column_definition,
    [column_name column_definition,...],
    INDEX index_name(column_name) STORAGE_CACHE_POLICY (storage_cache_policy_option)
    );

storage_cache_policy_option:
    GLOBAL = {"hot" | "auto" | "none"}
    | timeline_strategy_list

timeline_strategy_list:
    BOUNDARY_COLUMN = column_name
    | BOUNDARY_COLUMN_UNIT = {"s" | "ms"}
    | HOT_RETENTION = intnum retention_time_unit

retention_time_unit:
    YEAR
    | MONTH
    | WEEK
    | DAY
    | HOUR
    | MINUTE
```

### 给已有表增加索引时，指定索引的表级热点缓存策略

语法格式如下：

```sql
ALTER TABLE table_name ADD INDEX index_name(column_name)
    STORAGE_CACHE_POLICY (storage_cache_policy_option);

storage_cache_policy_option:
    GLOBAL = {"hot" | "auto" | "none"}
    | timeline_strategy_list

timeline_strategy_list:
    BOUNDARY_COLUMN = column_name
    | BOUNDARY_COLUMN_UNIT = {"s" | "ms"}
    | HOT_RETENTION = intnum retention_time_unit

retention_time_unit:
    YEAR
    | MONTH
    | WEEK
    | DAY
    | HOUR
    | MINUTE
```

### 相关参数说明

支持对索引表配置热点缓存策略：

* 对于局部索引，可以指定表级 `STORAGE_CACHE_POLICY`。如果未指定表级 `STORAGE_CACHE_POLICY`，则默认为 `none`，表示使用数据表的 `STORAGE_CACHE_POLICY` 配置，局部索引分区的热点缓存策略则跟随数据表的分区规则。

* 对于全局索引，除了指定表级的 `STORAGE_CACHE_POLICY`，如果索引表有分区的话，还可以指定索引表分区级的 `STORAGE_CACHE_POLICY`。全局索引如果未指定表级 `STORAGE_CACHE_POLICY`，则默认为 `none`。

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>在 V4.4.1 及其之后的版本中，全局索引如果未指定表级 <code>STORAGE_CACHE_POLICY</code>，如果主表为 Global 策略，就默认跟随主表的 <code>STORAGE_CACHE_POLICY</code>，如果主表为时间轴策略，则默认为 <code>hot</code> 策略。</p>
  </main>

设置表级别的 `STORAGE_CACHE_POLICY` 时，参数 `storage_cache_policy_option` 中不同属性以 Key-Value 格式定义。各个属性的语意如下：

* `GLOBAL = {"hot" | "auto" | "none"}`：用于指定索引的数据是否为热点数据，取值如下：

  * `hot`：表示指定索引为热存储，在缓存盘空间足够的情况下，索引表下所有数据将会缓存到本地缓存盘。
  * `auto`：表示指定索引表热数据为系统自动识别。
  * `none`：默认值，表示该索引的策略跟随主表 `STORAGE_CACHE_POLICY` 取值。

* `timeline_strategy_list`：表示时间轴策略参数列表，各参数间使用英文逗号分隔。热点缓存时间轴策略支持通过时间来判断分区数据是否为热数据的机制，系统根据配置的策略，自动调整本地缓存盘上的分区数据，不建议在局部索引上使用此参数。

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>时间轴：按照 Range 分区定义的分区范围取值进行热数据缓存，当满足一定时间条件时，该分区的数据被判定为热数据。使用时间轴策略时，需要注意以下事项：<ul><li>仅支持 Range 分区表使用（Range 分区为一级或者二级都可以），因为需要时间来确定是否过期，但不能是双 Range 分区，会因为无法确定以哪个 Range 分区时间为准。</li><li>使用时间轴时，分区表达中只能有列名，不支持表达式转换。例如 <code>PARTITION BY RANGE COLUMNS(expr(col3))</code>。</li><li><code>BOUNDARY_COLUMN</code> 必须为分区键，如果分区键有多列，<code>BOUNDARY_COLUMN</code> 需为第一列，用来判断分区是否过期。</li></ul></p>
  </main>

  * `BOUNDARY_COLUMN = column_name`：用于判定热数据的列。支持整型（`BIGINT` 或者 `INT` 类型，格式为 Unix 时间戳）和时间类型（`TIMESTAMP`、`DATE`、`DATETIME` 或者 `YEAR` 类型）。

    * 如果 `BOUNDARY_COLUMN` 类型为整型时，表的分区方式支持 Range/Range Columns 分区类型。
    * 如果 `BOUNDARY_COLUMN` 类型为时间类型时，表的分区方式只能使用 Range Columns 分区类型。

  * `BOUNDARY_COLUMN_UNIT = {"s" | "ms"}`：用于指定参数 `BOUNDARY_COLUMN` 的时间单位。仅支持 `BOUNDARY_COLUMN` 为整型时设置此参数，整型数值用作时间戳时，需要给定时间戳单位，否则可能会导致错解析出来错误的时间。取值如下：

    * 当分区列为 `INT` 类型时，`BOUNDARY_COLUMN_UNIT` 取值只能为 `s`。
    * 当分区列为 `BIGINT` 类型时，`BOUNDARY_COLUMN_UNIT` 取值可以是 `s` 或者 `ms`。

  * `HOT_RETENTION = intnum retention_time_unit`：用于配置热数据的时间范围。

    * `intnum`：表示整数。
    * `retention_time_unit`：表示时间单位，取值如下：

      * `YEAR`：表示年。
      * `MONTH`：表示月。
      * `WEEK`：表示周。
      * `DAY`：表示天。
      * `HOUR`：表示小时。
      * `MINUTE`：表示分钟。

### 示例

* 创建索引时，指定索引的表级 `STORAGE_CACHE_POLICY`：

  1. 创建表 `tbl3`。

      ```sql
      CREATE TABLE tbl3 (col1 INT, col2 INT, col3 INT);
      ```

  2. 创建索引 `idx1_tbl3` 并指定索引表的数据为热数据。

      ```sql
      CREATE INDEX idx1_tbl3 ON tbl3 (col1) LOCAL
          STORAGE_CACHE_POLICY (GLOBAL = "hot");
      ```

* 创建表时创建索引，指定索引表的数据为热数据。

    ```sql
    CREATE TABLE tbl4 (col1 INT, col2 INT,
        INDEX idx2 ((col1 + 1)) STORAGE_CACHE_POLICY (GLOBAL = "hot"), UNIQUE KEY ((col1 + col2)));
    ```

* 给已有表增加索引时，指定索引表的数据为热数据。

    ```sql
    ALTER TABLE tbl4 ADD INDEX idx3(col1, col2) GLOBAL
        STORAGE_CACHE_POLICY (GLOBAL = "hot");
    ```

## 相关文档

* [自定义热点缓存策略概述](100.customize-hotspot-cache-overview-of-mysql-mode.md)
* [修改表级热点缓存策略](400.modify-table-level-storage-cache-policy-of-mysql-mode.md)
* [修改分区级热点缓存策略](500.modify-partition-level-storage-cache-policy-of-mysql-mode.md)
* [CREATE TABLE](../../../500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/600.sql-statement-of-mysql-mode/2600.create-table-of-mysql-mode.md)
* [ALTER TABLE](../../../500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/600.sql-statement-of-mysql-mode/1600.alter-table-of-mysql-mode.md)
* [CREATE INDEX](../../../500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/600.sql-statement-of-mysql-mode/2200.create-index-of-mysql-mode.md)
* [自定义热点缓存策略运维指南](600.customize-hotspot-cache-operations-of-mysql-mode.md)