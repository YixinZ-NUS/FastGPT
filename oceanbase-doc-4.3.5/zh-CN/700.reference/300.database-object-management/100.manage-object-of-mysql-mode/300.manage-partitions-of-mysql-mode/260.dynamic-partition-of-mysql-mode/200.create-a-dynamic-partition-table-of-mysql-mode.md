|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|

# 创建动态分区表

OceanBase 数据库通过 `DYNAMIC_PARTITION_POLICY` 块，在建表时指定表的动态分区管理属性。

本文将向您介绍如何使用 SQL 语句创建动态分区表。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>对于 OceanBase 数据库 V4.3.5 版本，从 V4.3.5 BP2 版本开始支持指定 <code>DYNAMIC_PARTITION_POLICY</code> 创建动态分区表。</p>
</main>

## 使用限制及注意事项

* 当前版本创建动态分区表需要至少指定一个分区定义。
* 仅支持 Range Columns 分区和 Range 分区：

  * Range Columns 分区：分区键为 `date`、`datetime`、`timestamp`、`year`、`bigint`（指定 `BIGINT_PRECISION` 精度）类型的分区表可开启动态分区管理。
  * Range 分区：分区键为 `year`、`bigint`（指定 `BIGINT_PRECISION` 精度）类型的分区表可开启动态分区管理。

* 仅能对一级分区表和二级分区表的一级分区开启动态分区管理。
* 建表后预创建分区和删除过期分区的动作不会立刻执行，需要等待下一次动态分区管理任务自动调度，或者手动调度一次动态分区管理任务。调度动态分区管理任务的详细介绍，参见 [动态分区管理任务](500.dynamic-partition-management-task-of-mysql-mode.md)。

## 权限要求

创建动态分区表需要有 `CREATE` 权限。更多有关 OceanBase 数据库权限的详细介绍，参见 [MySQL 模式下的权限分类](../../../../../600.manage/500.security-and-permissions/300.access-control/200.user-and-permission/200.permission-of-mysql-mode/100.permission-classification-of-mysql.md)。

## 语法

创建动态分区表的 SQL 语句格式如下：

```sql
CREATE TABLE [IF NOT EXISTS] table_name (table_definition_list)
    DYNAMIC_PARTITION_POLICY [=] (dynamic_partition_policy_list)
    partition_option;

dynamic_partition_policy_list:
    dynamic_partition_policy_option [, dynamic_partition_policy_option ...]

dynamic_partition_policy_option:
    ENABLE = {true | false}
    | TIME_UNIT = {'hour' | 'day' | 'week' | 'month' | 'year'}
    | PRECREATE_TIME = {'-1' | '0' | 'n {hour | day | week | month | year}'}
    | EXPIRE_TIME = {'-1' | '0' | 'n {hour | day | week | month | year}'}
    | TIME_ZONE = {'default' | 'time_zone'}
    | BIGINT_PRECISION = {'none' | 'us' | 'ms' | 's'}
```

## 动态分区管理属性参数说明

|   **属性名称**   | **描述** | **是否必填** | **是否可修改** |
|------------------|----------|--------------|----------------|
| ENABLE           | 表示是否启用动态分区管理。取值如下：<ul><li>`true`：默认值，表示启用动态分区管理。</li><li>`false`：表示禁用动态分区管理。</li></ul>| 否 | 是 |
| TIME_UNIT        | 表示分区的时间单位，即自动创建分区边界的间隔。取值如下：<ul><li>`hour`：按小时划分分区。</li><li>`day`：按天划分分区。</li><li>`week`：按周（星期）划分分区。</li><li>`month`：按月划分分区。</li><li>`year`：按年划分分区。</li></ul>| 是 | 否 |
| PRECREATE_TIME   | 表示预创建时间。调度一次动态分区管理，会预创建分区使得 **最大分区上界 > now() + precreate_time**。取值如下：<ul><li>`-1`：默认值，表示不预创建分区。</li><li>`0`：表示仅预创建当前分区。</li><li>`n {hour \| day \| week \| month \| year}`：表示预创建对应时间跨度的分区。例如，`3 hour` 表示预创建 3 小时内的分区。</li></ul>  <main id="notice" type='explain'><h4>说明</h4><p><ul><li>需要预创建多个分区时，分区边界的间隔为 <code>TIME_UNIT</code>。</li><li>首个预创建的分区边界为现存最大分区边界按 <code>TIME_UNIT</code> 向上取整。</li></ul></p></main>| 否 | 是 |
| EXPIRE_TIME      | 表示分区过期时间。调度一次动态分区管理，会删除所有 **分区上界 < now() - expire_time** 的过期分区。取值如下：<ul><li>`-1`：默认值，表示分区永不过期。</li><li>`0`：表示除当前分区外，之前的所有分区均过期。</li><li>`n {hour \| day \| week \| month \| year}`：表示分区过期时间。例如，`1 day` 表示分区过期时间为 1 天。</li></ul>| 否 | 是 |
| TIME_ZONE        | 表示判断当前时间与时间类型（`date`、`datetime`、`year` 类型）分区键大小时，依赖的时区信息。取值如下：<ul><li>`default`：默认值，表示不额外配置时区，使用租户时区。除上述类型外，其他类型 `time_zone` 字段必须为 `default`。</li><li>`time_zone`：表示自定义时区偏移值。例如，`+8:00` 等时区偏移值。</li></ul>| 否 | 否 |
| BIGINT_PRECISION | 表示 `bigint` 类型分区键的时间戳精度。取值如下：<ul><li>`none`：默认值，表示无精度（分区键不为 `bigint` 类型）。</li><li>`us`：微秒精度。</li><li>`ms`：毫秒精度。</li><li>`s`：秒精度。</li></ul>| 否 | 否 |

更多有关创建表语法的详细参数说明信息，参见 [CREATE TABLE](../../../../500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/600.sql-statement-of-mysql-mode/2600.create-table-of-mysql-mode.md)。

### 动态分区参数限制

* `TIME_UNIT`：分区键为 `date` 类型时，参数 `TIME_UNIT` 不能使用 `hour`；分区键为 `year` 类型时，参数 `TIME_UNIT` 仅能使用 `year`。
* `PRECREATE_TIME`：最多预创建 2048 个分区。
* `TIME_ZONE`：分区键为 `date`、`datetime` 或 `year` 类型时，参数 `TIME_ZONE` 才可以指定自定义时区偏移值，其他类型只能为 `default`。
* `BIGINT_PRECISION`：只有分区键类型为 `bigint` 时，才可以指定该参数值为 `us`、`ms`、`s`，其他分区键类型时该参数值只能为 `none`。
* `TIME_UNIT`、`TIME_ZONE`、`BIGINT_PRECISION` 指定后不能修改。

## 示例

创建动态分区表 `test_tbl1`，设置动态分区属性为：

* 分区边界按每小时划分。
* 预创建当前时间之后的 3 小时内的分区。
* 删除分区上界早于当前时间 1 天前的分区。
* 使用北京时间（UTC+8）判断时间，确保分区边界和过期逻辑基于该时区。
* 分区键 `col2` 是 `DATETIME` 类型，无需配置 `bigint` 的时间戳精度。

```sql
CREATE TABLE test_tbl1 (col1 INT, col2 DATETIME)
    DYNAMIC_PARTITION_POLICY(
        ENABLE = true,
        TIME_UNIT = 'hour',
        PRECREATE_TIME = '3 hour',
        EXPIRE_TIME = '1 day',
        TIME_ZONE = '+8:00',
        BIGINT_PRECISION = 'none'
    )
    PARTITION BY RANGE COLUMNS (col2)(
        PARTITION P0 VALUES LESS THAN ('2025-04-15 13:30:00')
    );
```

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>建表后预创建分区和删除过期分区的动作不会立刻执行，需要等待下一次动态分区管理任务自动调度，或者手动调度一次动态分区管理任务。详细介绍，参见 <a href="500.dynamic-partition-management-task-of-mysql-mode.md">动态分区管理任务</a>。</p>
</main>

## 相关文档

* [动态分区概述](100.dynamic-partition-overview-of-mysql-mode.md)
* [查看动态分区表](300.view-dynamic-partition-table-of-mysql-mode.md)
* [修改动态分区表](400.modify-dynamic-partition-table-of-mysql-mode.md)
* [动态分区管理任务](500.dynamic-partition-management-task-of-mysql-mode.md)
