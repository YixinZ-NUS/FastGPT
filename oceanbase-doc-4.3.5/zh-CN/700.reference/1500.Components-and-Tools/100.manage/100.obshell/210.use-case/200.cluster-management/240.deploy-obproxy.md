# 部署 OBProxy

obshell 目前暂不支持通过 obshell 命令部署 OBProxy，本文将以一个三副本的 OceanBase 集群为例，介绍如何通过调用 API 部署 OBProxy 并关联该 OceanBase 集群。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <ul>
  <li><p>本文操作不限制 OBProxy 待关联的 OceanBase 集群是否由 obshell 管理。</p></li>
  <li><p>自 obshell V4.2.6 起支持部署 OBProxy。</p></li>
  </ul>
</main>

## 部署模式

本文中四台机器的使用情况如下，obshell 使用默认端口 `2886`。

| 角色 | 机器 | 备注 |
| --- | --- | --- |
| OBServer 节点 | 10.10.10.1 | OceanBase 数据库 zone1 |
| OBServer 节点 | 10.10.10.2 | OceanBase 数据库 zone2 |
| OBServer 节点 | 10.10.10.3 | OceanBase 数据库 zone3 |
| 部署 OBProxy 服务的节点 | 10.10.10.4  | 该节点已部署 obshell |

## 操作步骤

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>通过命令行命令调用 API 时，obshell 会对被调用的 API 进行安全校验。因此，您在每次调用 API 之前都需先参考 <a href='../../400.obshell-api-reference/20.api-hybrid-encryption.md'>API 混合加密</a> 一文对请求进行加密，并在 curl 命令中配置加密后的请求头部（<code>${request_headers}</code>）和请求体（<code>${request_body}</code>）。</p>
</main>

### 步骤一：启动 obshell

在待部署 OBProxy 服务的节点上启动 obshell，命令详细介绍可参见 [obshell agent start](../../300.obshell-clients/100.agent-commands.md)。

```shell
[admin@test004 ~]$ /home/admin/oceanbase/bin/obshell agent start --ip 10.10.10.4 -P 2886
```

### 步骤二：设置节点密码

调用 obshell 的 `/api/v1/agent/password` 接口设置节点密码。

:::tab

tab 命令行命令

命令行中调用对应 API 接口的说明可参见 [设置节点密码](../../400.obshell-api-reference/100.obshell-management/1500.set-node-password.md)。

```shell
[admin@test001 ~]$ curl -H "Content-Type: application/json" -H 'X-OCS-Header:${request_headers}' -X POST -d '${request_body}'  http://10.10.10.4:2886/api/v1/agent/password
```

加密前的请求体内容示例如下：

```json
{
  "password": "*****"
}
```

tab Python

通过 obshell-sdk-python 请求对应 API 方法的介绍可参见 [设置节点密码](../../500.obshell-sdk-reference/100.python/110.obshell-management/1500.set-node-password-of-python.md)。

```python
...
client = ClientSet("10.10.10.4", 2886)
client.v1.set_agent_password("*****")

# 若此 obshell 节点有管理的 OceanBase 集群，client 的创建需要指定集群的 root@sys 密码。
# client = ClientSet("10.10.10.4", 2886, PasswordAuth("***"))
...
```

:::

### 步骤三：创建 proxyro@sys 用户

OBProxy 需要通过 proxyro@sys 用户连接关联的 OceanBase 集群，如果目标集群未在 `sys` 租户下创建 `proxyro` 用户，需要先手动创建 `proxyro` 用户。

若目标集群未被 obshell 运维管理，可参见 [创建用户](../../../../../../600.manage/500.security-and-permissions/300.access-control/200.user-and-permission/200.permission-of-mysql-mode/110.create-a-user-of-mysql-mode.md) 内容创建 proxyro@sys 用户；若目标集群已被 obshell 运维管理，可调用集群内任一 obshell 的 `/api/v1/tenant/{name}/user` 接口创建 proxyro@sys 用户并赋予相应的权限，示例如下。

:::tab

tab 命令行命令

命令行中调用对应 API 接口的说明可参见 [创建用户](../../400.obshell-api-reference/500.tenant-management/820.create-user-of-tenant.md)。

```shell
[admin@test001 ~]$ curl -H "Content-Type: application/json" -H 'X-OCS-Header:${request_headers}' -X POST -d '${request_body}'  http://10.10.10.1:2886/api/v1/tenant/sys/user
```

加密前的请求体内容示例如下：

```json
{
  "user_name": "proxyro",
  "password": "*****",
  "global_privileges": [
    "CREATE",
    "DELETE"
  ],
  "db_privileges": [
    {
      "db_name": "oceanbase",
      "privileges": [
        "DROP"
      ]
    }
  ],
  "host_name": "%"
}
```

tab Python

通过 obshell-sdk-python 请求对应 API 方法的介绍可参见 [创建用户](../../500.obshell-sdk-reference/100.python/500.tenant-management/820.create-user-of-tenant-of-python.md)。

```python
...
client = ClientSet("10.10.10.1", 2886, PasswordAuth("****"))
db_priv = {
        "db_name": "oceanbase",
        "privileges": ["SELECT"]
    }
client.v1.create_user(user_name="proxyro", password="*****", db_privileges=[db_priv])
...
```

:::

### 步骤四：部署 OBProxy

您需访问 [OceanBase 软件下载中心](https://www.oceanbase.com/softwarecenter) 手动下载 OBProxy 安装包，将其复制到待部署 OBProxy 的机器上并解压到工作目录。之后调用目标 obshell 的 `/api/v1/obproxy` 接口部署 OBProxy 并关联目标集群。

:::tab

tab 命令行命令

命令行中调用对应 API 接口的说明可参见 [部署 OBProxy](../../400.obshell-api-reference/230.odp-management/100.deploy-odp.md)。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>API 调用后会创建一个异步运维任务，查看任务进度的方法可参见 <a href='../../400.obshell-api-reference/1000.task-management/2000.get-dag-detail.md'>获取任务的详细信息</a>。等待任务完成，则部署 OBProxy 完成。</p>
</main>

```shell
[admin@test001 ~]$ curl -H "Content-Type: application/json" -H 'X-OCS-Agent-Header:${request_headers}' -X POST -d '${request_body}'  http://10.10.10.4:2886/api/v1/obproxy
```

加密前的请求体内容示例如下：

```json
{
    "home_path": "/data/obproxy",
    "name": "myobproxy",
    "sql_port": 2883,
    "exporter_port": 2884,
    "rpc_port": 2885,
    "rs_list": "10.10.10.1:2881;10.10.10.2:2881;10.10.10.3:2881",
    "proxyro_password": "********",
    "obproxy_sys_password": "********",
    "parameters": {
        "server_tcp_keepidle": "5",
        "enable_strict_kernel_release": "false"
    }
}
```

tab Python

通过 obshell-sdk-python 请求对应 API 方法的介绍可参见 [创建 OBProxy](../../500.obshell-sdk-reference/100.python/230.odp-management/100.deploy-odp-of-python.md)。

```python
...
client = ClientSet("10.10.10.4", 2886, PasswordAuth(agent_password="****"))
client.v1.add_obproxy_sync(
    home_path="/data/obproxy",
    app_name="myobproxy",
    rs_list="10.10.10.1:2881;10.10.10.2:2881:10.10.10.3:2881",
    proxyro_password="********",
    obproxy_sys_password="********",
)
...
```

:::

### 步骤五：验证是否部署成功

可执行如下命令查看是否存在 OBProxy 进程。

```shell
[admin@test001 ~]$ ps -ef | grep obproxy
```

您也可通过该 OBProxy 代理访问 OceanBase 集群验证是否可成功连接。

```shell
obclient -h10.10.10.4 -uroot@sys#obdemo -P2883 -p -c -A
```

连接 OceanBase 集群的详细介绍可参见官网《OceanBase 数据库》文档 [连接 OceanBase 数据库](../../../../../../300.develop/100.application-development-of-mysql-mode/100.connect-to-oceanbase-database-of-mysql-mode/100.connection-methods-overview-of-mysql-mode.md) 章节。
