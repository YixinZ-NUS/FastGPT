# 替换故障节点

通过 obshell 替换集群内故障节点有两种方式：

- 通过调用 API 替换

- 通过 obshell 命令替换

本文将以一个 3 副本的 OceanBase 集群为例，介绍如何通过 obshell 替换集群内故障节点。

## 前提条件

- OceanBase 集群已被 obshell 运维管理，详细的判断方法及接管操作可参见 [接管非 obshell 部署集群](300.take-over-non-obshell-deployed-clusters.md)。

- OceanBase 集群中除故障节点外的所有 OBServer 节点和 obshell 都正常运行。

## 部署模式

本文中三台机器的使用情况如下（obshell 使用默认端口 2886）：

|     角色      |    机器    |          备注          |
| ------------- | ---------- | ---------------------- |
| OBServer 节点 | 10.10.10.1 | OceanBase 数据库 zone1 |
| OBServer 节点 | 10.10.10.2 | OceanBase 数据库 zone2 |
| OBServer 节点 | 10.10.10.3 | OceanBase 数据库 zone3，节点发生故障（宕机或 clog 盘损坏） |
| OBServer 节点 | 10.10.10.4 | 替换故障节点（`10.10.10.3`）的机器  |

## 通过 API 替换故障节点

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>obshell 会对被调用的 API 进行安全校验。因此，您在每次调用 API 之前都需先参考 <a href='../../400.obshell-api-reference/20.api-hybrid-encryption.md'>API 混合加密</a> 一文对请求进行加密，并在 curl 命令中配置加密后的请求头部（<code>${request_headers}</code>）和请求体（<code>${request_body}</code>）。</p>
</main>

### 步骤 1：调用集群扩容接口

调用任一除故障节点外的 obshell 的 `/api/v1/ob/scale_out` 接口可发起扩容，向故障节点所位于的 Zone 内增加新节点。

:::tab

tab 命令行命令

命令行中调用对应 API 接口的说明可参见 [集群扩容](../../400.obshell-api-reference/200.cluster-management/1400.scale-out.md)。

```shell

[admin@test001 ~]$ curl -H "Content-Type: application/json" -H 'X-OCS-Header:${request_headers}' -X POST -d '${request_body}'  http://10.10.10.1:2886/api/v1/ob/scale_out
```

加密前的请求体内容如下：

```json
{
  "agentInfo": {
      "ip": "10.10.10.4",
      "port": 2886
  },
  "obConfigs": {
      "redoDir":"/data/workspace/redo", 
      "dataDir":"/data/workspace/data", 
      "datafile_size":"24G", 
      "cpu_count":"16", 
      "memory_limit":"16G", 
      "system_memory":"4G", 
      "log_disk_size":"24G"
  },
  "zone": "zone3"
}
```

tab Python

通过 obshell-sdk-python 请求对应 API 方法的介绍可参见 [集群扩容](../../500.obshell-sdk-reference/100.python/200.cluster-management/1400.scale-out-of-python.md)。

```python
···
client = ClientSet("10.10.10.1", 2886, PasswordAuth("****"))
configs = {"redoDir":"/data/workspace/redo", "dataDir":"/data/workspace/data", 
            "datafile_size":"24G", "cpu_count":"16", "memory_limit":"16G", 
            "system_memory":"4G", "log_disk_size":"24G"}
client.v1.scale_out_sync("10.10.10.4", 2886, "zone3", configs)  # 调用 /api/v1/ob/scale_out
···
```

tab GO

通过 obshell-sdk-go 请求对应 API 方法的介绍可参见 [集群扩容](../../500.obshell-sdk-reference/200.go/200.cluster-management/1400.scale-out-of-go.md)。

```go
···
client, err := services.NewClientWithPassword("10.10.10.1", 2886, "****")
configs := map[string]string {
    "redoDir":"/data/workspace/redo", "dataDir":"/data/workspace/data", 
    "datafile_size":"24G", "cpu_count":"16", "memory_limit":"16G", 
    "system_memory":"4G", "log_disk_size":"24G"}
req := client.V1().NewScaleOutRequest("10.10.10.4", 2886, "zone3", configs)
dag, err := client.V1().ScaleOutSyncWithRequest(req)  // 调用 /api/v1/ob/scale_out
···
```

:::

### 步骤 2：调用集群缩容接口

调用任一 obshell 的 `/api/v1/ob/scale_in` 接口可将故障节点从集群中删除。

:::tab

tab 命令行命令

命令行中调用对应 API 接口的说明可参见 [集群缩容](../../400.obshell-api-reference/200.cluster-management/1500.scale-in.md)。

```shell
[admin@test001 ~]$ curl -H "Content-Type: application/json" -H 'X-OCS-Header:${request_headers}' -X POST -d '${request_body}'  http://10.10.10.1:2886/api/v1/ob/scale_in
```

加密前的请求体内容如下：

```json
{
  "agent_info": {
      "ip": "10.10.10.3",
      "port": 2886
  },
  "force_kill": true
}
```

tab Python

通过 obshell-sdk-python 请求对应 API 方法的介绍可参见 [集群缩容](../../500.obshell-sdk-reference/100.python/200.cluster-management/1500.scale-in-of-python.md)。

```python
···
client = ClientSet("10.10.10.1", 2886, PasswordAuth("****"))
client.v1.scale_in_sync("10.10.10.3", 2886, force_kill = True)  # 调用 /api/v1/ob/scale_in
···
```

tab GO

通过 obshell-sdk-go 请求对应 API 方法的介绍可参见 [集群缩容](../../500.obshell-sdk-reference/200.go/200.cluster-management/1500.scale-in-of-go.md)。

```go
···
client, err := services.NewClientWithPassword("10.10.10.1", 2886, "****")
req := client.V1().NewScaleInRequest("10.10.10.3", 2886).SetForceKill()
dag, err := client.V1().ScaleInSyncWithRequest(req)  // 调用 /api/v1/ob/scale_in
···
```

:::

## 通过 obshell 命令替换故障节点

### 步骤 1：启动 obshell

在待扩容到集群的节点（`10.10.10.4`）上启动 obshell，详情请参见 [启动和停止 obshell](../100.obshell-management/100.start-stop-obshell.md) 中 **启动 obshell**。

```shell
[admin@test004 ~]$ /home/admin/oceanbase/bin/obshell agent start --ip 10.10.10.4 -P 2886
```

### 步骤 2：新增节点

通过命令行扩容时，命令需要在待扩容到集群的节点上发起。在待扩容到集群的节点（示例中为 `10.10.10.4`）上执行 `obshell cluster scale-out` 命令。命令介绍请详见 [obshell 集群命令组](../../300.obshell-clients/200.cluster-commands.md) 中 **obshell cluster scale-out**。

若待扩容节点上未部署 obshell，可通过 obshell-sdk-python 或 obshell-sdk-go 部署 obshell，具体介绍可参见 [SDK 参考/Python/安装 obshell](../../500.obshell-sdk-reference/100.python/110.obshell-management/300.install-obshell-of-python.md) 或 [SDK 参考/GO/安装 obshell](../../500.obshell-sdk-reference/200.go/110.obshell-management/300.install-obshell-of-go.md)。

```shell
[admin@test004 ~]$ /home/admin/oceanbase/bin/obshell cluster scale-out -s '10.10.10.1:2886' -z 'zone3' -o 'memory_limit=16G,system_memory=8G,log_disk_size=24G,datafile_size=24G' --rp *****
```

### 步骤 3：删除故障节点

在除故障节点外的任一集群内节点（如 `10.10.10.1`）上执行 `obshell cluster scale-in` 命令强行删除故障节点。命令介绍请详见 [obshell 集群命令组](../../300.obshell-clients/200.cluster-commands.md) 中 **obshell cluster scale-in**。

```shell
[admin@test001 ~]$ /home/admin/oceanbase/bin/obshell cluster scale-in -s '10.10.10.3:2886' -f
```
