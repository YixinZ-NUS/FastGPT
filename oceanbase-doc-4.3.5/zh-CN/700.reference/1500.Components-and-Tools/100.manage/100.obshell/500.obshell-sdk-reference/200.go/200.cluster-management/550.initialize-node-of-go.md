# 初始化节点

本文介绍如何通过 obshell-sdk-go 初始化节点，目标是将部署 OceanBase 数据库所需的 RPM 包（包括 oceanbase-ce、oceanbase-ce-libs、oceanbase-ce-utils、obshell）发送给各个节点，并完成目录初始化。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>建议先查看 <a href='../100.quickstart-of-go.md'>obshell-sdk-go 快速上手</a> 内容，了解如何使用 obshell-sdk-go。</p>
</main>

## 注意事项

在执行初始化节点之前请先就将所需的 RPM 包下载到机器上。您可以手动下载，也可以使用 obshell-sdk-go 下载，使用 obshell-sdk-go 下载的介绍可参见 [下载 RPM 包](../1500.other-api/400.download-rpm-package-of-go.md)。

## 示例代码

:::tab

tab 强制清空目标目录

```go
package main

import (
    "github.com/oceanbase/obshell-sdk-go/util"
)

func initNode() error {
    pkgs := []string{
        "/root/download/oceanbase-ce-libs-4.2.5.0-100000052024102022.el7.x86_64.rpm",
        "/root/download/oceanbase-ce-4.2.5.0-100000052024102022.el7.x86_64.rpm",
        // 以上的两个软件包已经足够初始化 OceanBase 集群了，但为了后续运维方便建议同时安装下面两个软件包
        // utils 提供 ob_admin，在后续恢复中可以提供恢复窗口解析的能力
        "/root/download/oceanbase-ce-utils-4.2.5.0-100000052024102022.el7.x86_64.rpm",
        // 上文配置的 OceanBase 数据库 4.2.5.0 版本中已经包含了 obshell，但推荐使用最新版本的 obshell，所以这里单独安装了最新版本的 obshell
        "/root/download/obshell-4.2.4.3-12024110711.el7.x86_64.rpm",
    }

    ips := []string{
        "10.10.10.1",
        "10.10.10.2",
        "10.10.10.3",
    }

    workDir := "/data/ob" // OceanBase 数据库的工作目录，不需要提前创建，初始化 OBServer 节点时会自动创建
    nodeConfigs := make([]util.NodeConfig, 0)
    for _, ip := range ips {
        nodeConfigs = append(nodeConfigs, util.NewNodeConfig(ip, workDir, 2886))
    }

    // // util.UseRsync 标识是否使用 rsync 传输文件，默认为 false
    // // 使用 rsync 传输文件时，需要在 SDK 执行机器和目标机器之间配置免密登录，同时两边都需要安装 rsync
    // // 默认会使用 scp 和 并行sftp 传输文件，速度和 rsync 差不多
    // // 你可以通过 util.UseRsync = true 开启 rsync 传输
    // util.UseRsync  = false

    // // util.CHUNK_SIZE 用来控制并行 sftp 传输文件的 chunk 大小，默认为 64M
    // // util.CHUNK_SIZE 越小并行度越高，传输速度越快，但是会占用更多的 ssh 信道
    // // 当前 OceanBase 数据库中单个文件的最大大小约为 450M，其中 64M 可分为 7-8 个块
    // // 这将需要 7-8 个并发连接，由于 sshd 配置中的默认 MaxSessions 为 10，因此此值 64M 是一个合理的默认值
    // // 如果你想提高 sftp 分块传输的性能，你可以减小这个值以增加并发连接的数量
    // // 但是需要相应地增加目标机器上 sshd config 的 MaxSessions 配置
    // // 同时还需要调大 util.PARALLEL_SFTP_MAX 的值，以保证并行度的上限
    // // util.PARALLEL_SFTP_MAX 使用来保护并行 sftp 的最大并发数不要超过目标机器的 MaxSessions，默认为 8
    // util.CHUNK_SIZE = 64 * 1024 * 1024
    // util.PARALLEL_SFTP_MAX = 8

    // // util.SCP_THRESHOLD 用来控制 scp 传输文件大小，大于该值的文件会使用 scp 传输，默认为 1M
    // // 因为小文件使用内存备份批量传输效率更高，所以只有大于 util.SCP_THRESHOLD 的文件才会使用 scp 传输
    // // 可以通过设置 util.SCP_THRESHOLD = 0 来关闭 scp
    // util.SCP_THRESHOLD = 1 * 1024 * 1024

    // 初始化节点
    // 参数说明:
    // rpmPackagePaths: 所需要安装的软件包路径
    // forceClean: 是否强制清理 OBServer 节点工作目录，如果为 True，则工作目录会被清空并 kill 掉所有相关进程
    // configs: 节点配置信息
    err := util.InitNodes(pkgs, true, nodeConfigs...)
    if err != nil {
        return err
    }
    // 初始化完成
}
```

tab 不强制清空目标目录

```go
package main

import (
    "github.com/oceanbase/obshell-sdk-go/util"
)

func initNode() error {
    pkgs := []string{
        "/root/download/oceanbase-ce-libs-4.2.5.0-100000052024102022.el7.x86_64.rpm",
        "/root/download/oceanbase-ce-4.2.5.0-100000052024102022.el7.x86_64.rpm",
        // 以上的两个个软件包已经足够初始化 OceanBase 集群了，但为了后续运维方便建议同时安装下面两个软件包
        // utils 提供 ob_admin，在后续恢复中可以提供恢复窗口解析的能力
        "/root/download/oceanbase-ce-utils-4.2.5.0-100000052024102022.el7.x86_64.rpm",
        // 上文配置的 OceanBase 数据库 4.2.5.0 版本中已经包含了 obshell，但推荐使用最新版本的 obshell，所以这里单独安装了最新版本的 obshell
        "/root/download/obshell-4.2.4.3-12024110711.el7.x86_64.rpm",
    }

    ips := []string{
        "10.10.10.1",
        "10.10.10.2",
        "10.10.10.3",
    }

    workDir := "/data/ob" // OceanBase 数据库的工作目录，不需要提前创建，初始化 OBServer 节点时会自动创建
    nodeConfigs := make([]util.NodeConfig, 0)
    for _, ip := range ips {
        nodeConfigs = append(nodeConfigs, util.NewNodeConfig(ip, workDir, 2886))
    }

    // // util.UseRsync 标识是否使用 rsync 传输文件，默认为 false
    // // 使用 rsync 传输文件时，需要在 SDK 执行机器和目标机器之间配置免密登录，同时两边都需要安装 rsync
    // // 默认会使用 scp 和 并行sftp 传输文件，速度和 rsync 差不多
    // // 你可以通过 util.UseRsync = true 开启 rsync 传输
    // util.UseRsync  = false

    // // util.CHUNK_SIZE 用来控制并行 sftp 传输文件的 chunk 大小，默认为 64M
    // // util.CHUNK_SIZE 越小并行度越高，传输速度越快，但是会占用更多的 ssh 信道
    // // 当前 OceanBase 数据库中单个文件的最大大小约为 450M，其中 64M 可分为 7-8 个块
    // // 这将需要 7-8 个并发连接，由于 sshd 配置中的默认 MaxSessions 为 10，因此此值 64M 是一个合理的默认值
    // // 如果你想提高 sftp 分块传输的性能，你可以减小这个值以增加并发连接的数量
    // // 但是需要相应地增加目标机器上 sshd config 的 MaxSessions 配置
    // // 同时还需要调大 util.PARALLEL_SFTP_MAX 的值，以保证并行度的上限
    // // util.PARALLEL_SFTP_MAX 使用来保护并行 sftp 的最大并发数不要超过目标机器的 MaxSessions，默认为 8
    // util.CHUNK_SIZE = 64 * 1024 * 1024
    // util.PARALLEL_SFTP_MAX = 8

    // // util.SCP_THRESHOLD 用来控制 scp 传输文件大小，大于该值的文件会使用 scp 传输，默认为 1M
    // // 因为小文件使用内存备份批量传输效率更高，所以只有大于 util.SCP_THRESHOLD 的文件才会使用 scp 传输
    // // 可以通过设置 util.SCP_THRESHOLD = 0 来关闭 scp
    // util.SCP_THRESHOLD = 1 * 1024 * 1024

    // 初始化节点
    // 参数说明:
    // rpmPackagePaths: 所需要安装的软件包路径
    // forceClean: 是否强制清理 OBServer 节点工作目录，如果为 True，则工作目录会被清空并 kill 掉所有相关进程
    // configs: 节点配置信息
    err := util.InitNodes(pkgs, false, nodeConfigs...)
    if err != nil {
        return err
    }
    // 初始化完成
}
```

## 相关文档

通过 obshell-sdk-python 请求 API 方法的介绍可参见 [初始化节点](../../100.python/200.cluster-management/550.initialize-node-of-python.md)。
