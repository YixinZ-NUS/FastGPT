# 管理历史统计信息

统计信息历史管理功能主要是指统计信息状态发生改变时（统计信息被重新收集、设置、删除、导入、锁定等），会将统计信息发生改变之前的统计信息状态保存到统计信息历史记录表中，统计信息历史记录表可以查询某张表的一个历史统计信息改变情况，同时也能够恢复指定历史版本的统计信息。

## 统计信息历史表及视图

OceanBase 数据库优化器使用如下视图来保存统计信息历史记录：

  <main id="notice" >
    <h4>功能适用性</h4>
    <p>当前 OceanBase 数据库社区版仅支持 <code>DBA_TAB_STATS_HISTORY</code> 、 <code>DBA_TAB_COL_STATISTICS</code> 和 <code>DBA_TAB_HISTOGRAMS</code>  视图</p>
  </main>

* `ALL_TAB_STATS_HISTORY`、`DBA_TAB_STATS_HISTORY` 和 `USER_TAB_STATS_HISTORY` 用于保存表级的历史统计信息。

* `ALL_TAB_COL_STATISTICS`、`DBA_TAB_COL_STATISTICS` 和 `USER_TAB_COL_STATISTICS` 用于保存列级的基本历史统计信息。

* `ALL_TAB_HISTOGRAMS`、`DBA_TAB_HISTOGRAMS` 和 `USER_TAB_HISTOGRAMS` 用于保存列级的直方图历史统计信息。

表的字段基本上和保存统计信息的内部表字段一致，不同点是会多一个 `savtime` 列，用于记录统计信息状态发生改变的时间，同时可以通过如下的视图来查询统计信息历史变化情况。

||                                                视图名称                                                |               描述               |
|---|----------------------------------------------------------------------------------------------------|--------------------------------|
|MySQL 模式| oceanbase.DBA_TAB_STATS_HISTORY |  用于查询统计信息历史变化。 |
|Oracle 模式| <ul><li>ALL_TAB_STATS_HISTORY</ul></li> <ul><li>DBA_TAB_STATS_HISTORY</ul></li><ul><li> USER_TAB_STATS_HISTORY</ul></li> |  用于查询统计信息历史变化。 |

## 存储过程定义

OceanBase 的 Oracle/Mysql 两种模式均已支持，用法基本一致，如无特殊说明，则默认表示用法一致。

* `RESTORE_TABLE_STATS` 恢复指定时刻的表级历史统计信息。

* `RESTORE_SCHEMA_STATS` 恢复指定时刻的 schema 级历史统计信息。

* `PURGE_STATS` 删除指定时刻之前的历史统计信息。

* `ALTER_STATS_HISTORY_RETENTION` 修改历史统计信息的保留间隔时间，默认保留间隔时间为 31 天。

* `GET_STATS_HISTORY_RETENTION` 获取当前历史统计信息的保留间隔时间。

* `GET_STATS_HISTORY_AVAILABILITY` 获取当前可用的最早历史统计信息时间，无法恢复指定时间早于这个时间的历史统计信息。

具体的存储过程定义如下：

```sql
PROCEDURE restore_table_stats (
  ownname               VARCHAR2,
  tabname               VARCHAR2,
  as_of_timestamp       TIMESTAMP WITH TIME ZONE,
  restore_cluster_index BOOLEAN DEFAULT FALSE,
  force                 BOOLEAN DEFAULT FALSE,
  no_invalidate         BOOLEAN DEFAULT FALSE
);

PROCEDURE restore_schema_stats (
  ownname               VARCHAR2,
  as_of_timestamp       TIMESTAMP WITH TIME ZONE,
  force                 BOOLEAN DEFAULT FALSE,
  no_invalidate         BOOLEAN DEFAULT FALSE
);

PROCEDURE purge_stats(
  before_timestamp      TIMESTAMP WITH TIME ZONE
);

PROCEDURE alter_stats_history_retention(
  retention             NUMBER
);

FUNCTION get_stats_history_retention RETURN NUMBER;

FUNCTION get_stats_history_availability RETURN TIMESTAMP WITH TIME ZONE;
```

参数解释如下表所示。

|          参数           |          解释           |
|-----------------------|-----------------------|
| ownname               | <ul><li>Oracle 模式：用户名。如果用户名设置为 `NULL`，会默认使用当前登录用户名。</li><li>MySQL 模式：表所在数据库名称。                  |
| tabname               | 表名称。                  |
| as_of_timestamp       | 指定恢复时间。               |
| restore_cluster_index | 该参数暂未实现，不可用。          |
| force                 | 强制恢复，并忽略加锁。默认是 False。 |
| no_invalidate         | 该参数暂未实现，不可用。          |

## 统计信息历史清理策略

目前 OceanBase 数据库支持两种方式清理统计信息历史：自动清理和手动清理。

### 自动清理统计信息历史

由于 OceanBase 是分布式数据库，无法在 Server 中直接为新创建的租户自动设置清理任务。因此，需要在租户创建后，或在将低版本 Server 升级至新版本后，手动使用 DBMS_SCHEDULER.CREATE_JOB 创建定时任务，以实现自动清理功能。

```sql
##设置一个从现在开始，每隔一天执行自动清理统计信息历史的任务
DECLARE
BEGIN
   DBMS_SCHEDULER.CREATE_JOB(job_name => 'PRUGE_STATS',
                             job_type => 'PL/SQL Block',
                             job_action => 'call dbms_stats.purge_stats(NULL);',
                             repeat_interval => 'FREQ=DAILY;INTERVAL=1',
                             enabled => TRUE);
END;
/
```

默认的清理任务间隔是 31 天，即当一个表在 31 天内没有被更新（也就是说，该表的统计信息在这段时间内没有被重新收集或更新），在第 31 天时，该表的历史统计信息会被清理掉。您可以通过 `dbms_stats.alter_stats_history_retention()` 去设置，有效范围值为 \[0,365000\]。如果设置为 0，则表示清除所有历史统计信息，后续也不在记录。

### 手动清理统计信息历史

手动清理是指显示调用 `dbms_stats.purge_stats()` 命令去执行清理。该方法可以适用于特定时间点需要快速清理的场景。

## 示例

* 获取当前历史统计信息的保留间隔时间。

  ```sql
  SELECT dbms_stats.get_stats_history_retention() FROM DUAL;
  ```

* 获取当前可用的最早历史统计信息时间。

  ```sql
  SELECT dbms_stats.get_stats_history_availability() FROM DUAL;
  ```

* 修改历史统计信息的保留间隔时间为 15 天。

  ```sql
  CALL dbms_stats.alter_stats_history_retention(15);
  ```

* 指定恢复用户名 `test` 下的 `tbl1` 表在某个时刻下的统计信息。

  ```sql
  CALL dbms_stats.restore_schema_stats('test', 'tbl1', to_timestamp('2021-09-26 19:02:12.675729', 'YYYY-MM-DD HH24:MI:SS.FF'));
  ```

* 手动清理指定时刻的历史统计信息。

  ```sql
  CALL dbms_stats.purge_stats(to_timestamp('2021-09-26 19:02:12.675729', 'YYYY-MM-DD HH24:MI:SS.FF'));
  ```

## 相关文档

MySQL 模式下管理历史统计信息的存储过程文档：

* [RESTORE_TABLE_STATS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/3000.restore-table-stats-mysql.md)
* [RESTORE_SCHEMA_STATS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/3100.restore-schema-stats-mysql.md)
* [PURGE_STATS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/3400.purge-stats-mysql.md)
* [ALTER_STATS_HISTORY_RETENTION（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/200.alter-stats-history-retention-mysql.md)
* [GET_STATS_HISTORY_RETENTION（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/2000.get-stats-history-retention-mysql.md)
* [GET_STATS_HISTORY_AVAILABILITY（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/1900.get-stats-history-availability-mysql.md)

Oracle 模式下管理历史统计信息的存储过程文档：

* [RESTORE_TABLE_STATS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/3000.restore-table-stats-oracle.md)
* [RESTORE_SCHEMA_STATS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/3100.restore-schema-stats-oracle.md)
* [PURGE_STATS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/3400.purge-stats-oracle.md)
* [ALTER_STATS_HISTORY_RETENTION（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/200.alter-stats-history-retention-oracle.md)
* [GET_STATS_HISTORY_RETENTION（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/2000.get-stats-history-retention-oracle.md)
* [GET_STATS_HISTORY_AVAILABILITY（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/1900.get-stats-history-availability-oracle.md)
