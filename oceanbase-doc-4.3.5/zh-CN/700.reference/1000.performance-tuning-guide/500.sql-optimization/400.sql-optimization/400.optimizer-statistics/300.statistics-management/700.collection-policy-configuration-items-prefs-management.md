# 管理统计信息收集策略（Prefs）

统计信息 Prefs 主要用于配置统计信息收集过程中收集策略的默认值，例如 granularity、method_opt 等的默认值。

## 统计信息收集策略 Prefs 配置项

Oracle 模式下提供如下虚拟表来查询当前设置的 Prefs：

* `SYS.ALL_VIRTUAL_OPTSTAT_GLOBAL_PREFS_REAL_AGENT` 用于查询 `GLOBAL` 级的 Prefs设置。

* `SYS.ALL_VIRTUAL_OPTSTAT_USER_PREFS_REAL_AGENT` 用于查询表级的 Prefs 设置。

可配置的统计信息收集策略 Prefs 如下表所示。

|     Prefs 名称      |                   Prefs 取值                   |                               说明                               |
|-------------------|-------------------------------------------------|----------------------------------------------------------------|
| APPROXIMATE_NDV   | 取值范围： <ul><li> "TRUE"（默认值）</li>   <li> "FALSE" </li>  </ul>        | 计算 NDV 是否使用估算方式。需要注意，该 Prefs 不能插入`__all_optstat_user_prefs` 中。 |
| CASCADE           | 取值范围： <ul><li> "TRUE" </li>  <li> "FALSE" </li>  <li> "DBMS_STATS.AUTO_CASCADE"（默认值）</li>  </ul>     | 该参数暂未使用。       |
| DEGREE            | 默认值：NULL       | 收集并发度。                                                         |
| ESTIMATE_PERCENT  | 取值范围：\[0.000001, 100\] 默认值："DBMS_STATS.AUTO_SAMPLE_SIZE"。        | 采用比例。        |
| BLOCK_SAMPLE      | 默认值为 "FALSE"。        | 指定采样是否使用块采样。     |
| GRANULARITY       | 默认值为"AUTO"。                                                         | 收集分区粒度，语法和 `granularity` 相同。  |
| INCREMENTAL       | 取值范围： <ul><li> "TRUE"</li>   <li> "FALSE" （默认值）</li> </ul>         | 是否采用增量收集策略。     |
| INCREMENTAL_LEVEL | 取值范围： <ul><li> "PARTITION"</li>   <li> "TABLE"（默认值） </li> </ul>                                                               | 增量收集级别。目前只支持表级别。    |
| METHOD_OPT        | 默认值： "FOR ALL COLUMNS SIZE AUTO"   | 设置列级别的统计信息收集方式。语法和 `method_opt` 相同。                            |
| NO_INVALIDATE     | 取值范围： <ul><li> "TRUE" </li>  <li> "FALSE" </li>  <li> "DBMS_STATS.AUTO_INVALIDATE"（默认值）</li></ul>    | 该参数暂未使用。   |
| OPTIONS           | 取值范围： <ul><li> "GATHER"（默认值）</li>   <li>  "GATHER AUTO"  </li> </ul>                                                          | 该参数暂未使用。    |
| STALE_PERCENT     | 默认值：10     | 统计信息过期比例阈值。                                                    |
| STATS_RETENTION   | 取值范围：\[0-365000\] 默认值：31     | 统计信息历史保留的间隔时间。                                                 |

## 统计信息策略 Prefs 设置与获取

OceanBase 的 Oracle/Mysql 两种模式均已支持，用法基本一致，如无特殊说明，则默认表示用法一致。

### 全局统计信息策略 Prefs 设置与获取

全局统计信息策略 Prefs 通过如下存储过程进行设置与获取：

* `RESET_GLOBAL_PREF_DEFAULTS`

* `RESET_PARAM_DEFAULTS`

* `SET_GLOBAL_PREFS`

* `SET_PARAM`

* `GET_PARAM`

具体的定义如下：

```sql
PROCEDURE reset_global_pref_defaults;

PROCEDURE reset_param_defaults;

PROCEDURE set_global_prefs(
  pname         VARCHAR2,
  pvalue        VARCHAR2
);

PROCEDURE set_param(
  pname          VARCHAR2,
  pval           VARCHAR2
);

FUNCTION get_param (
  pname           VARCHAR2
)RETURN VARCHAR2;
```

参数解释如下：

* `pname`：Prefs 的名字。

* `pvalue`：Prefs 的值。

### 表级的统计信息策略 Prefs 设置与获取

表级统计信息策略 Prefs 通过如下存储过程进行设置与获取：

* `SET_SCHEMA_PREFS`

* `SET_TABLE_PREFS`

* `DELETE_SCHEMA_PREFS`

* `DELETE_TABLE_PREFS`

* `GET_PREFS`

具体的定义如下：

```sql
PROCEDURE set_schema_prefs(
  ownname        VARCHAR2,
  pname          VARCHAR2,
  pvalue         VARCHAR2
);

PROCEDURE set_table_prefs(
  ownname        VARCHAR2,
  tabname        VARCHAR2,
  pname          VARCHAR2,
  pvalue         VARCHAR2
);

PROCEDURE delete_schema_prefs(
  ownname        VARCHAR2,
  pname          VARCHAR2
);

PROCEDURE delete_table_prefs (
  ownname        VARCHAR2,
  tabname        VARCHAR2,
  pname          VARCHAR2
);

FUNCTION get_prefs (
  pname           VARCHAR2,
  ownname         VARCHAR2 DEFAULT NULL,
  tabname         VARCHAR2 DEFAULT NULL
) RETURN VARCHAR2;
```

参数解释如下表所示。

|   参数    |                解释                 |
|---------|-----------------------------------|
| ownname | <ul><li>Oracle 模式：用户名。如果用户名设置为 `NULL`，会默认使用当前登录用户名。</li><li>MySQL 模式：表所在数据库名称。  |
| tabname | 表名。                               |
| pname   | Prefs 的名字。                        |
| pvalue  | Prefs 的值。                         |

## 示例

* 设置全局级别的 `APPROXIMATE_NDV` 值为 `FALSE`。

  ```sql
  CALL dbms_stats.set_global_prefs('APPROXIMATE_NDV', 'FALSE');
  ```

* 还原全局级别的所有 Prefs 默认值。

  ```sql
  CALL reset_global_pref_defaults();
  ```

* 设置用户 `test` 的 `tbl1` 的收集策略的 `DEGREE` 值为 128。

  ```sql
  CALL dbms_stats.set_table_prefs('test', 'tbl1', 'DEGREE', '128');
  ```

* 删除用户 `test` 的 `tbl1` 表的首选项 `DEGREE`。

  ```sql
  CALL dbms_stats.delete_table_prefs('test', 'tbl1', 'DEGREE');
  ```

## 相关文档

### 全局统计信息策略 Prefs 设置与获取

MySQL 模式下全局统计信息策略 Prefs 设置与获取存储过程：

* [RESET_GLOBAL_PREF_DEFAULTS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/3200.reset-global-pref-defaults-mysql.md)

* [RESET_PARAM_DEFAULTS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/3300.reset-param-defaults-mysql.md)

* [SET_GLOBAL_PREFS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/3800.set-global-prefs-mysql.md)

* [SET_PARAM（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/3900.set-param-mysql.md)

* [GET_PARAM（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/2100.get-param-mysql.md)

Oracle 模式下全局统计信息策略 Prefs 设置与获取存储过程：

* [RESET_GLOBAL_PREF_DEFAULTS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/3200.reset-global-pref-defaults-oracle.md)

* [RESET_PARAM_DEFAULTS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/3300.reset-param-defaults-oracle.md)

* [SET_GLOBAL_PREFS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/3800.set-global-prefs-oracle.md)

* [SET_PARAM（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/3900.set-param-oracle.md)

* [GET_PARAM（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/2100.get-param-oracle.md)

### 表级的统计信息策略 Prefs 设置与获取

MySQL 模式下表级统计信息策略 Prefs 设置与获取存储过程：

* [SET_SCHEMA_PREFS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/4000.set-schema-prefs-mysql.md)

* [SET_TABLE_PREFS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/4100.set-table-prefs-mysql.md)

* [DELETE_SCHEMA_PREFS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/800.delete-schema-prefs-mysql.md)

* [DELETE_TABLE_PREFS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/900.delete-table-prefs-mysql.md)

* [GET_PREFS（MySQL 模式）](../../../../../600.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/15900.dbms-stats-mysql/2200.get-prefs-mysql.md)

Oracle 模式下表级统计信息策略 Prefs 设置与获取存储过程：

* [SET_SCHEMA_PREFS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/4000.set-schema-prefs-oracle.md)

* [SET_TABLE_PREFS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/4100.set-table-prefs-oracle.md)

* [DELETE_SCHEMA_PREFS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/800.delete-schema-prefs-oracle.md)

* [DELETE_TABLE_PREFS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/900.delete-table-prefs-oracle.md)

* [GET_PREFS（Oracle 模式）](../../../../../600.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/15900.dbms-stats-oracle/2200.get-prefs-oracle.md)
