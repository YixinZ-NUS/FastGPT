|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# OceanBase 数据库 Sysbench 测试

本文介绍如何使用 Sysbench 工具对 OceanBase 数据库进行性能测试。

## 什么是 Sysbench

Sysbench 是一个基于 LuaJIT 的多线程基准测试工具，支持通过编写脚本自定义测试逻辑。它能对 CPU、内存、线程、磁盘 I/O 及数据库等核心组件进行性能测试，常用于评估不同系统参数对数据库负载的影响。该工具无需修改源码，仅需自定义 Lua 脚本即可模拟多样化业务场景的测试需求。Sysbench 的测试类型包括：CPU 性能、磁盘 I/O 性能、线程调度性能、内存分配与访问速度、POSIX 线程性能及数据库性能。本次将重点针对数据库性能进行测试。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>为了提升用户体验和易用性，让每一个开发者在使用数据库时都能获得较好的性能，OceanBase 数据库在 V4.0.0 版本之后，做了大量的优化工作。本性能测试方法仅基于基础参数进行调优，让开发者获得较好的数据库性能体验。</p>
</main>

## 环境准备

测试前请按照如下要求进行测试环境准备：

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>该示例以 MySQL 租户为例。</p>
</main>

### 软件要求

* JDK：建议使用 1.8u131 及以上版本。

* make：执行 `yum install make` 命令安装。

* automake：执行 `yum install automake` 命令安装。

* autoconf：执行 `yum install autoconf` 命令安装。

* libtool：执行 `yum install libtool` 命令安装。

* GCC：执行 `yum install gcc` 命令安装。

* mariadb-devel：执行 `yum install mariadb-devel mariadb` 命令安装。

* JDBC：建议使用 `mysql-connector-java-5.1.47` 版本。
  
* Sysbench：建议使用 1.0 及以上版本。

* OBClient：详细信息请参考 [OBClient 文档](https://github.com/oceanbase/obclient/blob/master/README.md)。

   <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>使用 OBClient V2.2.0 及后续版本时，默认会启用 ob20 协议与全链路追踪功能，可能导致 Sysbench 性能下降。建议通过设置环境变量关闭此功能，即 <code>export ENABLE_PROTOCOL_OB20=0</code>。</p>
   </main>

* OceanBase 数据库：建议单独部署 ODP，详细信息请参考 [快速体验 OceanBase 数据库](../../../200.quickstart/100.quickly-experience-oceanbase-for-community.md)。

* IOPS：建议磁盘 IOPS 在 10000 以上。

### 租户规格配置

租户规格是基于 <a href="200.sysbench-benchmark-report-of-oceanbase-database.md">OceanBase 数据库 Sysbench 测试报告</a> 中的硬件配置进行配置的，您需要根据实际数据库的硬件配置进行动态调整。

* **集群部署**

   1. 本次测试需要用到 5 台机器，Sysbench 和 OBD 部署在一台机器上，ODP 单独部署在一台机器上。通过 OBD 部署 OceanBase 集群需要使用 3 台机器，OceanBase 集群规模为 1:1:1。

      <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>在 Sysbench 测试中，部署 Sysbench、ODP 和 OBD 的机器需根据 OBServer 总核数动态调整配置，具体规则如下：</p>
      <ul>
         <li>当 OBServer 总核数小于等于 47 核时，该机器仅需要 8 核 64G 即可。</li>
         <li>当 OBServer 总核数在 48 核和 72 核之间时，该机器需要 16 核 128G。</li>
         <li>当 OBServer 总核数大于等于 73 核时，该机器需要 32 核 128G。</li>
      </ul>
      </main>

   2. 部署成功后先新建进行 Sysbench 测试的租户及用户（`sys` 租户是管理集群的内置系统租户，请勿直接使用 `sys` 租户进行测试），设置租户的 `primary_zone` 为 RANDOM，RANDOM 表示新建表分区的 Leader 随机到这 3 台机器。

      <main id="notice" type='explain'>
        <h4>说明</h4>
        <p>部署集群时，不建议使用 <code>obd cluster autodeploy</code> 命令。此命令为确保系统稳定性，默认会限制资源利用上限（例如内存分配预留冗余空间）。建议手动调优配置文件，以充分提升资源利用率。</p>
      </main>

* **租户创建**

   可以通过 `OBD CLUSTER TENANT CREATE` 命令创建测试租户，对应的 SQL 语法如下：

   ```sql
   obd cluster tenant create <DEPLOY_NAME> -n <TENANT_NAME> --max-cpu=28 --memory-size=180G -–zone-list=zone1,zone2,zone3 -–primary-zone=RANDOM  --locality=F@zone1,F@zone2,F@zone3 --charset=utf8 -s 'ob_tcp_invited_nodes="%"' --optimize=<optimize>
   ```

   参数解释如下：

  * `DEPLOY_NAME`：集群名称。
  * `TENANT_NAME`：租户名称。
  * `--zone-list`：租户的 Zone 列表。
  * `--primary-zone`：租户的主 Zone。
  * `--locality`：副本在 Zone 间的分布情况。
  * `--charset`：租户的字符集。
  * `-s`：租户系统变量值。
  * `OPTIMIZE`：租户负载类型，包括 `express_oltp`、`complex_oltp`、`olap`、`htap`、 `kv` 五种负载类型，默认负载类型为 `htap`，适用于混合 OLAP 和 OLTP 工作负载。有关 OBD 部署的更多内容，参见 [obd cluster tenant create](https://www.oceanbase.com/docs/community-obd-cn-1000000000955364)。

    <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>对于 V4.3.x 及之后版本，在使用 OBD 部署时，可以通过设置配置项 <code>scenario</code> 选择合适的集群负载类型，未配置的情况下默认 <code>scenario</code> 为 <code>htap</code>。更多内容请参见 <a href="https://www.oceanbase.com/docs/community-obd-cn-1000000000955369">OBD 部署 OceanBase 数据库</a>。</p>
    </main>

   例如创建一个名为 `sysbench_tenant` 的租户，其所使用的集群名为 `obperf`，具有 28 核 CPU 和 180GB 内存的资源配置，并设置默认租户的负载类型与集群的场景保持一致。

   ```shell
   obd cluster tenant create obperf -n sysbench_tenant --max-cpu=28 --memory-size=180G -–zone-list=zone1,zone2,zone3 -–primary-zone=RANDOM  --locality=F@zone1,F@zone2,F@zone3 --charset=utf8 -s 'ob_tcp_invited_nodes="%"' --optimize=htap
   ```

    <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>本示例中 <code>--optimize=htap</code> 为默认负载类型，在生产环境中请根据实际的集群类型来选择合适的负载类型。</p>
    </main>

## 测试方法

测试环境准备好后，可基于以下 2 种方法进行 Sysbench 性能测试：

* **使用 OBD 工具一键执行 Sysbench 测试**

* **使用 Sysbench 工具手动执行 Sysbench 测试**

### 使用 OBD 工具一键执行 Sysbench 测试

**使用 OBD 工具进行 Sysbench 测试前，需要注意以下事项：**

* 使用 OBD 运行 Sysbench 的详细参数介绍请参考命令 <a href="https://www.oceanbase.com/docs/community-obd-cn-10000000000768424">obd test sysbench</a>。
* 使用 OBD 进行一键测试时，集群的部署必须是由 OBD 进行安装和部署，否则无法获取集群的信息，将导致无法根据集群的配置进行性能调优。
* 如果系统租户的密码通过终端登陆并修改，非默认空值，则需要您先在终端中将密码修改为默认值，之后通过 <a href="https://www.oceanbase.com/docs/community-obd-cn-10000000000768422">obd cluster edit-config</a> 命令在配置文件中为系统租户设置密码，配置项是 <code># root_password: # root user password</code>。在 <code>obd cluster edit-config</code> 命令执行结束后，您还需执行 <a href="https://www.oceanbase.com/docs/community-obd-cn-10000000000768422">obd cluster reload</a>
* 运行 <code>obd test sysbench</code> 后，系统会详细列出运行步骤和输出，数据量越大耗时越久。
* <code>obd test sysbench</code> 会自动完成所有操作，无需其他额外任何操作，包含测试数据的生成、OceanBase 参数优化、加载和测试。当中间环节出错时可以参考命令 <a href="https://www.oceanbase.com/docs/community-obd-cn-10000000000768424">obd test sysbench</a> 进行重试，例如可以跳过数据的生成直接进行加载和测试。

**使用 OBD 工具一键执行 Sysbench 测试的操作步骤如下：**

1. 安装依赖工具。

   ```shell
   sudo yum install -y yum-utils
   sudo yum-config-manager --add-repo https://mirrors.aliyun.com/oceanbase/OceanBase.repo
   ```

2. 安装 Sysbench 工具。

   ```shell
   sudo yum install ob-sysbench
   ```

3. 编写 `ob_sysbench.sh` 脚本。

   ```shell
   #!/bin/bash
   export ENABLE_PROTOCOL_OB20=0

   echo "run oltp_read_only test"
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_only.lua --table-size=1000000 --threads=32 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_only.lua --table-size=1000000 --threads=64 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_only.lua --table-size=1000000 --threads=128 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_only.lua --table-size=1000000 --threads=256 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_only.lua --table-size=1000000 --threads=512 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_only.lua --table-size=1000000 --threads=1024 --rand-type=uniform

   echo "run oltp_write_only test"
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_write_only.lua --table-size=1000000 --threads=32 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_write_only.lua --table-size=1000000 --threads=64 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_write_only.lua --table-size=1000000 --threads=128 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_write_only.lua --table-size=1000000 --threads=256 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_write_only.lua --table-size=1000000 --threads=512 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_write_only.lua --table-size=1000000 --threads=1024 --rand-type=uniform

   echo "run oltp_read_write test"
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_write.lua --table-size=1000000 --threads=32 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_write.lua --table-size=1000000 --threads=64 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_write.lua --table-size=1000000 --threads=128 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_write.lua --table-size=1000000 --threads=256 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_write.lua --table-size=1000000 --threads=512 --rand-type=uniform
   obd test sysbench <DEPLOY_NAME> --tenant=<TENANT_NAME> --script-name=oltp_read_write.lua --table-size=1000000 --threads=1024 --rand-type=uniform
   ```

   其中 `DEPLOY_NAME` 为部署集群的名称，`TENANT_NAME` 为租户名称，您需根据实际环境情况进行修改。

4. 执行测试脚本。

   ```shell
   chmod +x ob_sysbench.sh
   ./ob_sysbench.sh
   ```

5. （可选）测试完成并查看测试结果后，可将测试数据进行清理。

   ```shell
   obd test sysbench <deploy_name> --tenant=<tenant_name> --cleanup
   ```

### 使用 Sysbench 工具手动执行 Sysbench 测试

手动测试在选定集群负载类型和租户调优场景后进行，有助于深入掌握 OceanBase 数据库，特别是参数设置的优化。

#### 步骤一：创建测试租户

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>若测试租户已在环境准备阶段完成创建，可跳过本步骤。</p>
</main>

在系统租户（`sys` 租户）下执行的命令创建测试租户：

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>本次测试的 OceanBase 集群环境部署模式为 1:1:1。</p>
</main>

1. 创建资源单元 `mysql_box`。

   ```shell
   CREATE RESOURCE UNIT mysql_box
      MAX_CPU 28,
      MEMORY_SIZE '200G',
      MIN_IOPS 200000,
      MAX_IOPS 12800000,
      LOG_DISK_SIZE '300G';
   ```

2. 创建资源池 `mysql_pool`。

   ```sql
   CREATE RESOURCE POOL mysql_pool
      UNIT = 'mysql_box',
      UNIT_NUM = 1,
      ZONE_LIST = ('z1','z2','z3');
   ```

3. 创建 MySQL 模式租户 `mysql_tenant`。

   ```sql
   CREATE TENANT mysql_tenant
      RESOURCE_POOL_LIST = ('mysql_pool'),
      PRIMARY_ZONE = RANDOM,
      LOCALITY = 'F@z1,F@z2,F@z3'
      SET VARIABLES ob_compatibility_mode='mysql', ob_tcp_invited_nodes='%', secure_file_priv = "/";
   ```

#### 步骤二：进行环境调优

   开始测试前，先要进行 OceanBase 数据库调优。请在系统租户（`sys` 租户）下执行以下语句配置相关参数。

   ```sql
   ALTER SYSTEM SET enable_sql_audit=false;
   ALTER SYSTEM SET enable_perf_event=false;
   ALTER SYSTEM SET syslog_level='PERF';
   ALTER SYSTEM SET enable_record_trace_log=false;
   ```

#### 步骤三：安装 Sysbench

按照以下步骤安装 Sysbench。

1. 下载 Sysbench。

   详细信息参考 [Sysbench 下载地址](https://github.com/akopytov/sysbench/releases/tag/1.0.20)。

2. 解压 Sysbench。

   ```bash
   unzip ./1.0.20.zip
   ```

3. 编译 Sysbench。

   进入 Sysbench 解压后的目录，运行以下命令编译 Sysbench：

   ```bash
   [wieck@localhost ~] $ cd sysbench-1.0.20
   [wieck@localhost sysbench-1.0.20] $./autogen.sh
   [wieck@localhost sysbench-1.0.20] $./configure --prefix=/usr/sysbench/ --with-mysql-includes=/usr/include/mysql/ --with-mysql-libs=/usr/lib64/mysql/ --with-mysql
   [wieck@localhost sysbench-1.0.20] $make
   [wieck@localhost sysbench-1.0.20] $make install
   [wieck@localhost sysbench-1.0.20] $cp -r /usr/sysbench/share/sysbench/* /usr/sysbench/bin/
   ```

   参数说明：  

   | 参数名 | 说明 |
   | --- | --- |
   | --prefix | 指定 Sysbench 的安装目录。 |
   | --with-mysql-includes | 指定 mysql 的 includes 目录。 |
   | --with-mysql-libs | 指定 mysql 的 lib 目录。 |
   | --with-mysql | Sysbench 默认支持 MySQL |

4. 运行以下命令，验证 Sysbench 是否安装成功：

   ```bash
   [wieck@localhost sysbench-1.0.20] $./src/sysbench --help
   ```

   如果返回以下信息，则 Sysbench 安装成功。

   ```sql
   Usage:
      sysbench [options]... [testname] [command]
   Commands implemented by most tests: prepare run cleanup help
   ```

### 步骤四：生成数据

本次的测试配置为：

* 数据规模：每个测试表包含 100 万行数据，共创建 30 个测试表。
* 负载设置：使用 150 个并发线程模拟高负载。
* 统计方式：每 10 秒输出一次实时性能统计。
* 随机模式：采用均匀分布的随机数生成策略。
* 测试时长：持续运行 60 秒。

按照以下步骤进行 Sysbench 测试：

1. 初始化测试数据。

   ```bash
   /usr/sysbench/bin/sysbench oltp_read_write.lua --mysql-host=x.x.x.x --mysql-port=xxxx --mysql-db=test --mysql-user=$user@$tenant --mysql-password=xxx --table_size=1000000 --tables=30 --threads=150 --report-interval=10 --rand-type=uniform --time=60 cleanup
   ```

2. 生成测试数据。

   ```bash
   /usr/sysbench/bin/sysbench oltp_read_write.lua --mysql-host=x.x.x.x --mysql-port=xxxx --mysql-db=test --mysql-user=$user@$tenant --mysql-password=test --table_size=1000000 --tables=30 --threads=150 --report-interval=10 --rand-type=uniform --time=60 prepare
   ```

3. 执行性能测试。

   ```bash
   /usr/sysbench/bin/sysbench oltp_read_write.lua --mysql-host=x.x.x.x --mysql-port=xxxx --mysql-db=test --mysql-user=$user@$tenant --mysql-password=xxx --table_size=1000000 --tables=30 --threads=150 --report-interval=10 --time=60 --rand-type=uniform --db-ps-mode=disable run
   ```

   参数说明：

   | 参数名 | 说明 |
   | --- | --- |
   | --mysql-host | 运行 OceanBase 数据库机器的 IP。如果有 ODP 建议使用 ODP 的 IP。 |
   | --mysql-port | 端口号。 |
   | --mysql-db | 待连接的数据库。 |
   | --mysql-user | 用户名。 |
   | --mysql-password | 密码。 |
   | --table_size | 每张表初始化的数据数量。 |
   | --tables | 初始化表的数量。 |
   | --threads | 启动的线程数量。 |
   | --time | 运行时间。设置为 `0` 时表示不限制时间。 |
   | --report-interval | 运行期间日志，单位为秒。 |
   | --events | 最大请求数量，定义数量后可以不需要 --time 选项。 |
   | --rand-type | 访问数据时使用的随机生成函数。取值可以为 `special`、`uniform`、`gaussian` 或 `pareto`。 默认值为 `special`，早期值为 `uniform`。 |
   | --skip_trx=on | 在只读测试中打开或关闭事务。默认打开。 |
   | --percentile=N | 打印百分位 rt，默认值为 `95`。 |
   | oltp_write_only | 在 Sysbench 的 lua 目录下，自带有针对不同场景的测试用例，比如 insert 和 point_select 等。 |

#### 说明

 测试结果可参考 [OceanBase Sysbench 性能测试报告](200.sysbench-benchmark-report-of-oceanbase-database.md)。

## 常见报错信息

* 安装 Sysbench 失败。报错信息如下：

   ```bash
   automake 1.10.x (aclocal) wasn't found, exiting
   ```

   表示操作系统没有安装 Automake。运行以下命令安装 Automake：

   ```bash
   yum install automake.noarch
   ```

* 安装 Sysbench 失败。报错信息如下：

   ```bash
   libtoolize 1.4+ wasn't found, exiting
   ```

   表示操作系统没有安装 Libtool。运行以下命令安装 Libtool：

   ```bash
   yum install libtool
   ```

* 安装 Sysbench 失败。报错信息如下：

   ```bash
   drv_mysql.c:35:19: fatal error: mysql.h: No such file or directory
   ```

   表示操作系统没有安装 MySQL 的 lib 库。运行以下命令安装：

   ```bash
   yum install mysql-community-devel.x86_64
   ```

* 安装 Sysbench 失败。报错信息如下：

   ```bash
   cannot find MySQL client libraries in /usr/lib/mysql/
   ```

   执行以下命令查找 MySQL 的 lib 库。可能位于 `/usr/lib64/mysql`。  

   ```bash
   find /usr -name mysql
   ```

* 在 Sysbench 和 OceanBase 数据库配置均合理的情况下，性能还是很差。

   1. Sysbench 是对 CPU、内存、网络非常敏感的测试。如果客户端和目标测试数据库不在一个局域网中，网络延迟可能会影响 Sysbench 性能。

   2. 与 OceanBase 数据库集群使用了 ODP 有关，可以先对单个 OceanBase 数据库进程进行高并发压力测试，将结果和使用 ODP 的场景对比。

   3. 建议将 ODP 和 Sysbench 单独部署在同一台机器上，通过 ODP 进行 Sysbench 测试。

* 在高并发压力下，为什么系统的 CPU 利用率依然很低？

  虽然整体 CPU 偏低，但是部分模块的 CPU 可能达到很高的利用率。
