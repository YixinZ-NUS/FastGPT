| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   |                 |
|machine-translation||

# SET LOG_ARCHIVE_DEST

## 描述

`ALTER SYSTEM SET LOG_ARCHIVE_DEST` 语句用于为用户租户配置归档目的端。归档目的端的配置主要包括 `LOCATION`、`BINDING` 以及 `PIECE_SWITCH_INTERVAL` 等属性。

## 使用限制及注意事项

* 系统租户和 Meta 租户不支持备份恢复，不需要配置归档目的端。

* 目前 OceanBase 数据库支持的备份介质为 NFS、阿里云 OSS、Azure Blob（在 V4.3.5 版本中，从 V4.3.5 BP3 版本开始支持）、AWS S3 以及兼容 S3 协议的对象存储，例如：华为 OBS、Google GCS、腾讯云 COS。部分备份介质可能需要满足一些基本要求才能使用，有关各备份介质的具体要求，参见 [物理备份与恢复概述](../../../../../600.manage/600.backup-and-recovery/100.overview-of-physical-backup-and-recovery.md) 中的 **备份介质要求**。

* 配置 `LOCATION`、`BINDING` 以及 `PIECE_SWITCH_INTERVAL` 等时，各参数项之间通过空格分隔，同时设置各参数值的等号（=）前后不能有空格。

* 归档目的端配置成功后，不支持增量配置，即需要在每次执行 `ALTER SYSTEM SET LOG_ARCHIVE_DEST` 语句时均指定所有参数的值，否则未指定的参数将使用默认值。

## 权限要求

需要由 `sys` 租户的 `root` 用户（`root@sys`） 或各租户的管理员用户执行。其中：

* MySQL 模式的默认管理员用户为 `root` 用户。
* Oracle 模式的默认管理员用户为 `SYS` 用户。

## 语法

```shell
ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=archive_path [BINDING=archive_mode] [PIECE_SWITCH_INTERVAL=piece_switch_interval]' [TENANT = tenant_name];
```

## 参数说明

| 参数                   | 描述                                                                                                                                      |
|-----------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| archive_path          | 指定归档路径。有关该参数的详细说明，参见下方 [archive_path](#archive_path)。   |
| archive_mode          | 配置归档和业务的优先模式，可选。目前支持 Optional 模式和 Mandatory 模式。如果不设置，默认为 Optional 模式。<ul> <li>Optional 模式：表示以用户业务优先。在该模式下，当归档（日志归档）速度跟不上日志生成的速度时，日志有可能来不及归档就被回收了，导致发生断流。</li> <li> Mandatory 模式：表示以归档优先。在该模式下，如果归档跟不上用户数据的写入，可能会导致用户无法写入。</li></ul> |
| piece_switch_interval | 配置 Piece 的切换周期，可选，取值范围为 \[1d, 7d\]。如果不设置，默认为 `1d`。有关 Piece 的详细介绍，请参见 [日志归档概述](../../../../../600.manage/600.backup-and-recovery/300.log-archive/100.overview-of-log-archive.md)。                                                                        |
| tenant_name           | 系统租户指定待配置归档目的端的租户名。<main id="notice" type='notice'> <h4>注意</h4><p>仅系统租户在执行此命令时需要通过 <code>TENANT tenant_name</code> 子句指定待操作的租户，用户租户只能对本租户执行此命令，故不需要指定该子句。</p></main>                        |

### archive_path

用于指定归档路径。下面分别对不同类型的介质的 `archive_path` 格式进行说明。

#### NFS

```sql
ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=file://your-nfs-server-path/your-archive-path';
```

其中，`file://your-nfs-server-path/your-archive-path` 用于指定 NFS 服务器路径和归档路径。

#### 对象存储

```sql
# 阿里云 OSS
ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=oss://your-bucket-name/your-archive-path?host=oss-your-region.aliyuncs.com&access_id=your-access-id&access_key=your-access-key[&delete_mode={delete | tagging}][&checksum_type={md5 | no_checksum}][&enable_worm={true | false}]';

# AWS S3
ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://your-bucket-name/your-archive-path?host=s3.your-region.amazonaws.com&access_id=your-access-id&access_key=your-access-key&s3_region=your-s3-region[&delete_mode={delete | tagging}][&checksum_type={md5 | crc32}]';

# 兼容 S3 协议的对象存储
ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://your-bucket-name/your-archive-path?host=host=your-service.com&access_id=your-access-id&access_key=your-access-key[&addressing_model={virtual_hosted_style | path_style}][&checksum_type=md5]';

# Azure Blob
ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=azblob:////your-bucket-name/your-archive-path?host=host=your-service.com&access_id=your-access-id&access_key=your-access-key[&delete_mode={delete | tagging}][&checksum_type=md5]';
```

相关参数说明如下：

<main id="notice" type='notice'>
<h4>注意</h4>
<p>使用对象存储作为归档介质时，对象存储路径的各项参数由 <code>&</code> 符号进行分隔，请确保您输入的参数值中仅包含英文字母大小写、数字、<code>/-_$+=</code> 以及通配符。如果您输入了上述以外的其他字符，可能会导致设置失败。</p>
</main>

* `host`：对象存储服务的访问域名。

  对于 Azure Blob 对象存储，其 `host` 参数对应的值可通过容器属性或存储账户的连接串拼接得到，并且要求 `host` 参数的前缀必须指定为 `http://` 或 `https://`。同时，由于 Azure Blob 默认开启了安全传输，默认是通过 `https://` 来访问，如果需要通过 `http://` 来访问，需要关闭 Azure Blob 的安全传输选项。关闭 Azure Blob 安全传输选项的详细操作，参见 [Azure Blob 官网文档](https://learn.microsoft.com/en-us/azure/storage/common/storage-require-secure-transfer?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json&bc=%2Fazure%2Fstorage%2Fblobs%2Fbreadcrumb%2Ftoc.json)。

* `access_id`：对象存储的访问秘钥 ID。

* `access_key`：对象存储的访问密钥。

* `delete_mode`：配置归档文件的清理模式，OSS、AWS S3、COS（以 S3 协议访问）、Azure Blob 的可选参数，与其他参数之间通过 `&` 符号连接。该参数当前支持以下两种取值：

  * `delete` ：表示清理模式为直接删除满足清理要求的归档文件。

    配置为该模式后，当您通过自动方式清理归档文件时，对于满足清理要求的归档文件，系统会直接将其删除。

  * `tagging`：表示清理模式为对满足清理要求的归档文件设置 `Tag`，归档文件将仍然保留。

    配置为该模式后，当您通过自动方式清理归档文件时，对于满足清理要求的归档文件，系统会给这些文件设置标签，标签的 `key` 为 `"delete_mode"`，`value` 为 `"tagging"`，以便后续用户可以通过设置的标签在对象存储上对这些文件的生命周期进行管理。

* `checksum_type`：指定归档文件的校验算法，用于校验归档文件的完整性。如果未显式指定，所有对象存储默认均使用 MD5 校验算法。根据不同的对象存储，该参数支持的取值如下：

  * `md5`：使用 MD5 算法校验归档文件的完整性。

    <main id="notice" type='notice'>
    <h4>注意</h4>
    <p>MD5 校验对于 <code>GetObject</code> 接口不生效。</p>
    </main>

  * `no_checksum`：不校验归档文件的完整性。仅 OSS、Azure Blob 支持该取值。对于通过 S3 协议接入的对象存储，包括 AWS S3、OBS、GCS、COS 等，由于受到 S3 SDK 的限制，不支持该取值。

  * `crc32`：使用 CRC32 算法校验归档文件的完整性。仅 AWS S3 支持该取值。

* `enable_worm`：可选参数，当归档目的端为阿里云 OSS 且目的端 Bucket 配置了合规保留策略（WORM）时，需将该参数设置为 `True`。

  OSS 的保留策略具有 WORM（Write Once Read Many）特性，满足用户以不可删除、不可篡改的方式保存和使用数据。当用户为 Bucket 配置保留策略并锁定策略后，在保留策略指定的 Object 的保留时间到期前，仅支持在该 Bucket 中上传和读取 Object。待 Object 的保留时间到期后，才可以修改或删除该 Object。

  <main id="notice" type='notice'>
  <h4>注意</h4>
  <ul><li>在 V4.3.5 版本中，从 V4.3.5 BP2 版本开始支持指定 <code>enable_worm</code> 参数。</li>
  <li>由于 OceanBase 数据库当前不会替代您设置合规保留策略，请在设置备份路径前确保 OSS Bucket 已正确设置保留策略（WORM 策略）并锁定。</li>
  <li>如果待设置的路径对应的 Bucket 设置并锁定了 WORM 策略，而在配置归档目的端时未指定 <code>enable_worm=true</code>，则语句执行后，系统将会报错，提示需要设置<code>enable_worm=true</code>。</li>
  <li><code>enable_worm</code> 参数一旦设置后，后续不支持变更。</li>
  <li>设置归档路径后，如果用户为该路径对应的 Bucket 设置并锁定了 WORM 策略，则归档可能会因无法向目标路径追加写而报 <code>-9140</code> 的错误，提示 <code>the object is locked by worm</code>。当发现归档任务因 WORM 策略导致执行失败后，需要用户重新配置新的归档路径，并且指定<code>enable_worm=true</code>。</li>
  <li>使用配置了 WORM 策略的 Bucket 作为归档路径时，推荐归档的清理模式使用 <code>tagging</code> 模式。</li></ul>
  </main>

  `enable_worm` 参数支持的取值如下：

  * `true`：是，表示 OceanBase 数据库会按照 WORM 的规范对该路径执行写入及删除操作。值设置为 `true` 时，要求同时显式配置 `checksum_type=md5`。

  * `false`：否。未显式指定该参数时，其默认值为 `false`。

* `s3_region`：Amazon S3 存储桶所在的区域。归档介质为 AWS S3 时，必须指定的参数。

* `addressing_model`：设置访问对象存储的 URL 格式，通过 S3 兼容协议访问的对象存储（OBS、GCS、COS 等）的可选参数，与其他参数之间通过 `&` 符号连接。该参数当前支持以下两种取值：

  * `virtual_hosted_style`：默认值，表示以 Virtual-hosted-style 访问对象存储。
  * `path_style`：表示以 Path-style 访问对象存储。

  例如，用户租户设置本租户使用 OBS 作为归档介质，并以 Virtual-hosted-style 格式访问 OBS，示例语句如下：

  ```shell
  ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test-bucket/backup/archive?host=obs.****.myhuaweicloud.com&access_id=****&access_key=****&addressing_model=virtual_hosted_style';
  ```

## 示例

* 系统租户

  * 系统租户为租户 `mysql_tenant` 配置归档路径，归档介质为 NFS，采用用户业务优先模式，且每隔一天切分一个 Piece。

    ```shell
    obclient [oceanbase]> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=file:///data/nfs/backup/archive BINDING=Optional PIECE_SWITCH_INTERVAL=1d' TENANT = mysql_tenant;
    ```

  * 系统租户为租户 `mysql_tenant` 配置归档路径，归档介质为 OSS，归档文件的清理模式为 `delete`，使用 MD5 算法校验归档文件的完整性。

    ```shell
    obclient [oceanbase]> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=oss://oceanbase-test-bucket/backup/archive?host=***.aliyun-inc.com&access_id=***&access_key=***&delete_mode=delete&checksum_type=md5' TENANT = mysql_tenant;
    ```

  * 系统租户为租户 `mysql_tenant` 配置归档路径，归档介质为 OSS，归档文件的清理模式为 `delete`，不校验归档文件的完整性。

    ```shell
    obclient [oceanbase]> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=oss://oceanbase-test-bucket/backup/archive?host=***.aliyun-inc.com&access_id=***&access_key=***&delete_mode=delete&checksum_type=no_checksum' TENANT = mysql_tenant;
    ```

  * 系统租户为租户 `mysql_tenant` 配置归档路径，归档介质为 OSS，归档文件的清理模式为 `tagging`，并使用 MD5 算法校验归档文件的完整性。该路径配置了 `enable_worm=true` 时，系统将按照 WORM 的规范对该路径执行写入和删除操作。

    <main id="notice" type='notice'>
    <h4>注意</h4>
    <p>OceanBase 数据库当前不会替代您设置合规保留策略，请在设置归档路径前确保 OSS Bucket 已正确设置保留策略（WORM 策略）并锁定。</p>
    </main>

    ```shell
    obclient [oceanbase]> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=oss://oceanbase-test-bucket/backup/archive?host=***.aliyun-inc.com&access_id=***&access_key=***&delete_mode=tagging&checksum_type=md5&enable_worm=true' TENANT = mysql_tenant;
    ```

  * 系统租户为租户 `mysql_tenant` 配置归档路径，归档介质为 AWS S3，归档文件的清理模式为 `delete`，采用用户业务优先模式，且每隔一天切分一个 Piece。

    ```shell
    obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test-bucket/backup/archive?host=s3.<region>.amazonaws.com&access_id=******&access_key=******&s3_region=******&delete_mode=delete BINDING=Optional PIECE_SWITCH_INTERVAL=1d' TENANT = mysql_tenant;
    ```

  * 系统租户为租户 `mysql_tenant` 配置归档路径，归档介质为 AWS S3，归档文件的清理模式为 `tagging`，使用 CRC32 算法校验归档文件的完整性。

    ```shell
    obclient [oceanbase]> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test-bucket/backup/archive?host=s3.<region>.amazonaws.com&access_id=***&access_key=***&s3_region=***&delete_mode=tagging&checksum_type=crc32' TENANT = mysql_tenant;
    ```

  * 系统租户为租户 `mysql_tenant` 配置归档路径，归档介质为 OBS，通过 S3 协议访问。

    ```shell
    obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test-bucket/backup/archive?host=obs.****.myhuaweicloud.com&access_id=****&access_key=****' TENANT = mysql_tenant;
    ```

  * 系统租户为租户 `mysql_tenant` 配置归档路径，归档介质为 GCS，通过 S3 协议访问。

    ```shell
    obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test-bucket/backup/archive?host=https://storage.googleapis.com&access_id=****&access_key=****' TENANT = mysql_tenant;
    ```

  * 系统租户为租户 `mysql_tenant` 配置归档路径，归档介质为 COS，归档文件的清理模式为 `delete`，通过 S3 协议访问。

    <main id="notice" type='notice'>
    <h4>注意</h4>
    <p>使用 COS 作为归档介质时，需要先设置集群级配置项 <a href="../../../../800.configuration-items-and-system-variables/100.system-configuration-items/300.cluster-level-configuration-items/16620.ob_storage_s3_url_encode_type.md">ob_storage_s3_url_encode_type</a>，详细操作可参见 <a href="../../../../../600.manage/600.backup-and-recovery/300.log-archive/200.preparation-before-log-archive.md">日志归档的准备工作</a>。</p>
    </main>

    ```shell
    obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test/backup/archive?host=cos.ap-***.myqcloud.com&access_id=***&access_key=***&delete_mode=delete' TENANT = mysql_tenant;
    ```

  * 系统租户为租户 `mysql_tenant` 配置归档路径，归档介质为 Azure Blob，配置清理模式为 `delete`，同时指定校验算法为 `md5`，采用用户业务优先模式，且每隔一天切分一个 Piece。

    ```shell
    obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=azblob://oceanbase-test-bucket/backup/archive?host=http://****.blob.core.windows.net&access_id=****&access_key=****&delete_mode=delete&checksum_type=md5 BINDING=Optional PIECE_SWITCH_INTERVAL=1d' TENANT = mysql_tenant;
    ```

* 用户租户

  * 租户 `mysql_tenant` 为本租户配置归档路径，归档介质为 NFS，采用用户业务优先模式，且每隔一天切分一个 Piece。

    ```shell
    obclient [oceanbase]> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=file:///data/nfs/backup/archive BINDING=Optional PIECE_SWITCH_INTERVAL=1d';
    ```

  * 租户 `mysql_tenant` 为本租户配置归档路径，归档介质为 OSS，归档文件的清理模式为 `tagging`，使用 MD5 算法校验归档文件的完整性。

    ```shell
    obclient [oceanbase]> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=oss://oceanbase-test-bucket/backup/archive?host=***.aliyun-inc.com&access_id=***&access_key=***&delete_mode=tagging&checksum_type=md5';
    ```

  * 租户 `mysql_tenant` 为本租户配置归档路径，归档介质为 OSS，归档文件的清理模式为 `tagging`，不校验归档文件的完整性。

    ```shell
    obclient [oceanbase]> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=oss://oceanbase-test-bucket/backup/archive?host=***.aliyun-inc.com&access_id=***&access_key=***&delete_mode=tagging&checksum_type=no_checksum';
    ```

  * 租户 `mysql_tenant` 为本租户配置归档路径，归档介质为 OSS，归档文件的清理模式为 `tagging`，使用 MD5 算法校验归档文件的完整性。该路径配置了 `enable_worm=true` 时，系统将按照 WORM 的规范对该路径执行写入和删除操作。

    <main id="notice" type='notice'>
    <h4>注意</h4>
    <p>OceanBase 数据库当前不会替代您设置合规保留策略，请在设置归档路径前确保 OSS Bucket 已正确设置保留策略（WORM 策略）并锁定。</p>
    </main>

    ```shell
    obclient [oceanbase]> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=oss://oceanbase-test-bucket/backup/archive?host=***.aliyun-inc.com&access_id=***&access_key=***&delete_mode=tagging&checksum_type=md5&enable_worm=true';
    ```

  * 租户 `mysql_tenant` 为本租户配置归档路径，归档介质为 AWS S3，归档文件的清理模式为 `delete`，采用用户业务优先模式，且每隔一天切分一个 Piece。

    ```shell
    obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test-bucket/backup/archive?host=s3.<region>.amazonaws.com&access_id=******&access_key=******&s3_region=******&delete_mode=delete BINDING=Optional PIECE_SWITCH_INTERVAL=1d';
    ```

  * 租户 `mysql_tenant` 为本租户配置归档路径，归档介质为 AWS S3，归档文件的清理模式为 `tagging`，使用 CRC32 算法校验归档文件的完整性。

    ```shell
    obclient [oceanbase]> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test-bucket/backup/archive?host=s3.<region>.amazonaws.com&access_id=***&access_key=***&s3_region=***&delete_mode=tagging&checksum_type=crc32';
    ```

  * 租户 `mysql_tenant` 为本租户配置归档路径，归档介质为 OBS，通过 S3 协议访问。

    ```shell
    obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test-bucket/backup/archive?host=obs.****.myhuaweicloud.com&access_id=****&access_key=****';
    ```

  * 租户 `mysql_tenant` 为本租户配置归档路径，归档介质为 GCS，通过 S3 协议访问。

    ```shell
    obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test-bucket/backup/archive?host=https://storage.googleapis.com&access_id=****&access_key=****';
    ```

  * 租户 `mysql_tenant` 为本租户配置归档路径，归档介质为 COS，归档文件的清理模式为 `delete`，通过 S3 协议访问。

    <main id="notice" type='notice'>
    <h4>注意</h4>
    <p>使用 COS 作为归档介质时，需要先设置集群级配置项 <a href="../../../../800.configuration-items-and-system-variables/100.system-configuration-items/300.cluster-level-configuration-items/16620.ob_storage_s3_url_encode_type.md">ob_storage_s3_url_encode_type</a>，详细操作可参见 <a href="../../../../../600.manage/600.backup-and-recovery/300.log-archive/200.preparation-before-log-archive.md">日志归档的准备工作</a>。</p>
    </main>

    ```shell
    obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=s3://oceanbase-test/backup/archive?host=cos.ap-***.myqcloud.com&access_id=***&access_key=***&delete_mode=delete';
    ```

  * 租户 `mysql_tenant` 为本租户配置归档路径，归档介质为 Azure Blob，配置清理模式为 `delete`，同时指定校验算法为 `md5`，采用用户业务优先模式，且每隔一天切分一个 Piece。

    ```shell
    obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=azblob://oceanbase-test-bucket/backup/archive?host=http://****.blob.core.windows.net&access_id=****&access_key=****&delete_mode=delete&checksum_type=md5 BINDING=Optional PIECE_SWITCH_INTERVAL=1d';
    ```

## 相关文档

* [ARCHIVELOG](200.archivelog.md)

* [NOARCHIVELOG](210.noarchivelog.md)

* [日志归档前准备](../../../../../600.manage/600.backup-and-recovery/300.log-archive/200.preparation-before-log-archive.md)