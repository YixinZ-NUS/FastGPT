|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|
|machine-translation||

# V$ACTIVE_SESSION_HISTORY

<main id="notice" type='explain'>
  <h4>说明</h4>
    <ul><li>对于 V4.3.x 版本，该视图从 V4.3.5 版本开始更名为 <a href="30400.v-ob_active_session_history-of-mysql-mode.md">V$OB_ACTIVE_SESSION_HISTORY</a>；对于 V4.2.x 版本，该视图从 V4.2.2 版本开始更名为 <a href="30400.v-ob_active_session_history-of-mysql-mode.md">V$OB_ACTIVE_SESSION_HISTORY</a>。</li>
  <li>该视图从 V4.0.0 版本开始引入。</li></ul>
</main>

## 功能描述

视图 `V$ACTIVE_SESSION_HISTORY` 展示本租户下当前 OBServer 节点的活跃会话历史记录。

## 字段说明

| 字段名称 | 类型 | 是否可以为 NULL | 描述 |
| --- | --- | --- | --- |
| SVR_IP                      | varchar(46)                           | NO   | 样本所属服务器  IP |
| SVR_PORT                    | bigint(20)                            | NO   | 样本所属服务器端口号 |
| SAMPLE_ID                   | bigint(20)                            | NO   | 样本本机唯一编号 |
| SAMPLE_TIME                 | timestamp(6)                          | NO   | 采样时间 |
| CON_ID                      | bigint(20)                            | NO   | 租户 ID |
| USER_ID                     | bigint(20)                            | NO   | 被采样会话的用户 ID |
| SESSION_ID                  | bigint(20)                            | NO   | 被采样会话的 ID <br> 对于 V4.3.x 版本：<ul><li> V4.3.5 BP2 之前版本：<br>在所有连接方式（直连模式/ODP 模式）下，该字段均表示 Server Session ID。</li><li> V4.3.5 BP2 及之后版本：<ul><li>在直连模式下：<br>该字段表示 Server Session ID。</li> <li>在 ODP 模式下：</li><ul><li>当 ODP 中的配置项 <code>client_session_id_version = 2</code> 时，该字段表示 Client Session ID。 </li> <li>当 <code>client_session_id_version = 1</code> 时，该字段表示 Server Session ID。</li></ul></ul></li></ul> |
| SESSION_TYPE                | varchar(10)                           | NO   | 会话类型：<li>FOREGROUND：前台会话，即：用户会话<li>BACKGROUND：后台会话 |
| SESSION_STATE               | varchar(7)                            | NO   | 会话状态：<li>ON CPU：当前没有等待，正在执行 SQL 逻辑<li>WAITING：当前正在等待，详细等待内容参考 `EVENT` 字段 |
| SQL_ID                      | varchar(32)                           | NO   | SQL ID |
| PLAN_ID                     | bigint(20)                            | NO   |采样到的 SQL 在 PLAN CACHE 中的计划 ID，用于将采样点与计划关联起来|
| TRACE_ID                    | varchar(64)                           | NO   | 算子的 Trace ID |
| EVENT                       | varchar(64)                           | NO   | 等待事件的描述 |
| EVENT_NO                    | bigint(20)                            | NO   | 等待事件内部编号，用于和其他表关联查询 |
| EVENT_ID                    | bigint(20)                            | NO   | 表示当前等待事件的 ID <main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| P1TEXT                      | varchar(64)                           | NO   | 等待事件的参数 1 的名称，EVENT 不同，这里的名称也会相应变化 |
| P1                          | bigint(20)                            | NO   | 等待事件参数 1 的值 |
| P2TEXT                      | varchar(64)                           | NO   | 等待事件的参数 2 的名称，EVENT 不同，这里的名称也会相应变化 |
| P2                          | bigint(20)                            | NO   | 等待事件参数 2 的值 |
| P3TEXT                      | varchar(64)                           | NO   | 等待事件的参数 3 的名称，EVENT 不同，这里的名称也会相应变化 |
| P3                          | bigint(20)                            | NO   | 等待事件参数 3 的值 |
| WAIT_CLASS                  | varchar(64)                           | NO   | 等待事件所属类型 |
| WAIT_CLASS_ID               | bigint(20)                            | NO   | 等待事件所属类型的 ID，用于和其他表关联查询 |
| TIME_WAITED                 | bigint(20)                            | NO   | 该等待事件的总等待时间，单位为微秒（us） |
| SQL_PLAN_LINE_ID            | bigint(20)                            | NO   | 会话在采样时 SQL 算子在 SQL 计划中的编号   |
| GROUP_ID                    | bigint(20)                            | NO   | 所属资源组 ID。     |
| PLAN_HASH                   | bigint(20) unsigned                   | NO   | 当前执行 SQL 命令对应 Plan Hash。     |
| THREAD_ID                   | bigint(20)                            | NO   | 当前活跃会话所在的线程 ID。    |
| STMT_TYPE                   | bigint(20)                            | NO   | 当前活跃会话的 SQL 类型。     |
| TIME_MODEL                  | bigint(20)                            | NO   | time model 信息，是所有 IN_XXX 字段（如 IN_PARSE、IN_PL_PARSE 等）的数据组成的集合。     |
| IN_PARSE                    | varchar(1)                            | NO   | 会话在采样时是否正在做 SQL Parse |
| IN_PL_PARSE                 | varchar(1)                            | NO   | 会话在采样时是否正在做 SQL PL Parse |
| IN_PLAN_CACHE               | varchar(1)                            | NO   | 会话在采样时是否正在做 Plan Cache 匹配 |
| IN_SQL_OPTIMIZE             | varchar(1)                            | NO   | 会话在采样时是否正在做 SQL 解析优化 |
| IN_SQL_EXECUTION            | varchar(1)                            | NO   | 会话在采样时是否正在做 SQL 执行 |
| IN_PX_EXECUTION             | varchar(1)                            | NO   | 会话在采样时是否正在做 SQL 并行执行。当会话处于本状态时，一定也处于 IN_SQL_EXECUTION 状态 |
| IN_SEQUENCE_LOAD            | varchar(1)                            | NO   | 会话在采样时是否正在做自增列或 SEQUENCE 取值 |
| IN_COMMITTING               | varchar(1)                            | NO   | 当前采样点是否处于事务提交阶段<main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.2.1 版本开始引入。</p></main> |
| IN_STORAGE_READ             | varchar(1)                            | NO   | 当前采样点是否处于存储读阶段<main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.2.1 版本开始引入。</p></main> |
| IN_STORAGE_WRITE            | varchar(1)                            | NO   | 当前采样点是否处于存储写阶段<main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.2.1 版本开始引入。</p></main> |
| IN_REMOTE_DAS_EXECUTION     | varchar(1)                            | NO   | 当前采样点是否处于 DAS 远程执行阶段<main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.2.1 版本开始引入。</p></main> |
| IN_FILTER_ROWS              | varchar(1)                            | NO   | 表示当前采样点的是否处于存储下压执行阶段。 |
| IN_RPC_ENCODE               | varchar(1)                            | NO   | 当前 SQL 正在进行的序列化操作。   |
| IN_RPC_DECODE               | varchar(1)                            | NO   | 当前 SQL 正在进行的反序列化操作。     |
| IN_CONNECTION_MGR           | varchar(1)                            | NO   | 当前 SQL 正在进行建链接操作。     |
| PROGRAM                     | varchar(64)                           | NO   | 当前采样点正在执行的程序名:<ul><li>后台线程：指线程名称，例如 `observer`、`WrTimer` 等  </li><li>前台线程:<ul><li>普通请求为 `user@client_ip (thread_name)`  </li><li>`inner_sql` 远程执行为 `INNER SQL REMOTE EXEC (thread_name)` </li><li>DAS 远程执行为 `DAS REMOTE EXEC (thread_name)` </li></ul> </li></ul>|
| MODULE                      | varchar(64)                           | NO   | 会话在采样时记录的 MODULE 值，通过 `DBMS_APPLICATION_INFO.SET_MODULE` 包设置。 |
| ACTION                      | varchar(64)                           | NO   | 会话在采样时记录的 ACTION 值，通过 `DBMS_APPLICATION_INFO.SET_ACTION` 包设置。 |
| CLIENT_ID                   | varchar(64)                           | NO   | 会话在采样时记录的 CLIENT_ID 值，通过 `DBMS_SESSION.set_identifier` 包设置。 |
| BACKTRACE                   | varchar(512)                          | NO   | 辅助调试字段，用于记录事件发生时的代码调用栈。该字段的值一直为 NULL |
| TM_DELTA_TIME               | bigint(20)                            | NO   | 计算 time model 的时间间隔，单位为微秒<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| TM_DELTA_CPU_TIME           | bigint(20)                            | NO   | 过去 `TM_DELTA_TIME` 时间段内在 CPU 上花费的时间量<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| TM_DELTA_DB_TIME            | bigint(20)                            | NO   | 过去 `TM_DELTA_TIME` 时间段内在数据库调用中花费的时间量<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| TOP_LEVEL_SQL_ID            | CHAR(32)                              | NO   | 顶层 SQL ID<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| IN_PLSQL_COMPILATION        | varchar(1)                            | NO   | 当前 PL 编译状态：Y/N<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| IN_PLSQL_EXECUTION          | varchar(1)                            | NO   | 当前 PL 执行状态：Y/N<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| PLSQL_ENTRY_OBJECT_ID       | bigint(20)                            | NO   | 顶层 PL 的 OBJECT ID<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| PLSQL_ENTRY_SUBPROGRAM_ID   | bigint(20)                            | NO   | 顶层 PL 的 Sub project ID<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| PLSQL_ENTRY_SUBPROGRAM_NAME | varchar(32)                           | NO   | 顶层 PL 的 Sub project name<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| PLSQL_OBJECT_ID             | bigint(20)                            | NO   | 当前正在执行的 PL object ID<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| PLSQL_SUBPROGRAM_ID         | bigint(20)                            | NO   | 当前正在执行的 PL subprogram ID<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| PLSQL_SUBPROGRAM_NAME       | varchar(32)                           | NO   | 当前正在执行的 PL subprogram  name<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.2 版本开始引入。</li></ul></main> |
| TX_ID                       | bigint(20)                            | NO  | 当前事务 ID<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.3 版本开始引入。</li></ul></main>     |
| BLOCKING_SESSION_ID         | bigint(20)                            | NO  | 如果当前会话被阻塞，显示阻塞该会话的会话 ID，目前仅在锁冲突场景生效，展示持有锁的会话 ID<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.3 版本开始引入。</li></ul></main>      |
| TABLET_ID                   | bigint(20)                            | NO  | 当前 SQL 正在处理的 Tablet 的 ID<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.5 版本开始引入。</li></ul></main>     |
| PROXY_SID                   | bigint(20)                            | NO  | 代理会话 ID<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 版本开始引入。</li><li>对于 V4.2.x 版本，该字段从 V4.2.5 版本开始引入。</li></ul></main>     |
| DELTA_READ_IO_REQUESTS      | bigint(20)          | NO  |  两次采样之间读的次数<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 BP2 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.5 BP3 版本开始引入。</li></ul></main>    |
| DELTA_READ_IO_BYTES         | bigint(20)          | NO  |  两次采样之间读的文件累计大小<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 BP2 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.5 BP3 版本开始引入。</li></ul></main>    |
| DELTA_WRITE_IO_REQUESTS     | bigint(20)          | NO  |  两次采样之间写的次数<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 BP2 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.5 BP3 版本开始引入。</li></ul></main>    |
| DELTA_WRITE_IO_BYTES        | bigint(20)          | NO  |  两次采样之间写的文件累计大小<main id="notice" type='explain'><h4>说明</h4><ul><li>对于 V4.3.x 版本，该字段从 V4.3.5 BP2 版本开始引入。</li> <li>对于 V4.2.x 版本，该字段从 V4.2.5 BP3 版本开始引入。</li></ul></main>    |

## 查询示例

查询本租户下当前 OBServer 节点的活跃会话历史记录。

```shell
obclient [oceanbase]> SELECT * FROM oceanbase.V$ACTIVE_SESSION_HISTORY limit 1\G
```

查询结果如下：

```shell
*************************** 1. row ***************************
                     SVR_IP: xx.xx.xx.xx
                   SVR_PORT: 2882
                  SAMPLE_ID: 1163552
                SAMPLE_TIME: 2025-04-28 17:22:18.567996
                     CON_ID: 1002
                    USER_ID: 0
                 SESSION_ID: 2305843009213709012
               SESSION_TYPE: BACKGROUND
              SESSION_STATE: WAITING
                     SQL_ID: NULL
                    PLAN_ID: 0
                   TRACE_ID: NULL
                      EVENT: latch: config lock wait
                   EVENT_NO: 132
                   EVENT_ID: 40
                     P1TEXT: address
                         P1: 140013133706752
                     P2TEXT: number
                         P2: 1073791885
                     P3TEXT: tries
                         P3: 0
                 WAIT_CLASS: CONCURRENCY
              WAIT_CLASS_ID: 104
                TIME_WAITED: 10408
           SQL_PLAN_LINE_ID: NULL
                   GROUP_ID: 0
                  PLAN_HASH: NULL
                  THREAD_ID: 50828
                  STMT_TYPE: NULL
                 TIME_MODEL: 0
                   IN_PARSE: N
                IN_PL_PARSE: N
              IN_PLAN_CACHE: N
            IN_SQL_OPTIMIZE: N
           IN_SQL_EXECUTION: N
            IN_PX_EXECUTION: N
           IN_SEQUENCE_LOAD: N
              IN_COMMITTING: N
            IN_STORAGE_READ: N
           IN_STORAGE_WRITE: N
    IN_REMOTE_DAS_EXECUTION: N
             IN_FILTER_ROWS: N
              IN_RPC_ENCODE: N
              IN_RPC_DECODE: N
          IN_CONNECTION_MGR: N
                    PROGRAM: T1002_ServerProbeSrv
                     MODULE: ServerProbeSrv
                     ACTION: NULL
                  CLIENT_ID: NULL
                  BACKTRACE: NULL
              TM_DELTA_TIME: 1016561
          TM_DELTA_CPU_TIME: 2105
           TM_DELTA_DB_TIME: 525347
           TOP_LEVEL_SQL_ID: NULL
       IN_PLSQL_COMPILATION: N
         IN_PLSQL_EXECUTION: N
      PLSQL_ENTRY_OBJECT_ID: NULL
  PLSQL_ENTRY_SUBPROGRAM_ID: NULL
PLSQL_ENTRY_SUBPROGRAM_NAME: NULL
            PLSQL_OBJECT_ID: NULL
        PLSQL_SUBPROGRAM_ID: NULL
      PLSQL_SUBPROGRAM_NAME: NULL
                      TX_ID: NULL
        BLOCKING_SESSION_ID: NULL
                  TABLET_ID: NULL
                  PROXY_SID: 2305843009213709012
     DELTA_READ_IO_REQUESTS: 0
        DELTA_READ_IO_BYTES: 0
    DELTA_WRITE_IO_REQUESTS: 0
       DELTA_WRITE_IO_BYTES: 0
```

## 相关视图或文档

获取活跃会话历史记录后，可以按需生成 ASH 报告进行分析。有关 ASH 的详细介绍，参见 [ASH 报告](../../../../700.reference/1000.performance-tuning-guide/400.performance-diagnosis/500.ash-report-diagnosis/100.ash-introduction.md)。