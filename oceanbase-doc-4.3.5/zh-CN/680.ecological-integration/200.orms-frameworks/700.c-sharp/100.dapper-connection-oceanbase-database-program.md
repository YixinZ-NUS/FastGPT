|description|本文介绍如何使用 C# 的 Dapper ORM 框架连接 OceanBase 数据库，实现创建表、插入数据和查询数据等基本操作。|
|---|---|
|keywords|C#, .NET, Dapper, OceanBase, 数据库连接, ORM 框架, 生态集成|
|dir-name|Dapper|
|dir-name-en|Dapper|
|category|生态集成|
|type|框架和驱动|
|tenant-type|MySQL Mode|

# 使用 Dapper 连接 OceanBase 数据库

Dapper 是一个轻量级的对象关系映射(ORM)工具，适用于 .NET 平台。本文将介绍如何使用 Dapper 连接 OceanBase 数据库的 MySQL 模式。

## 前提条件

* 已安装 .NET SDK 6.0 或更高版本
* 已安装 Visual Studio 或 VS Code
* 已部署 OceanBase 数据库并且创建了 MySQL 模式租户

## 操作步骤

1. 创建新项目
2. 安装必要的 NuGet 包
3. 配置数据库连接
4. 创建数据模型
5. 实现数据访问层
6. 运行示例程序

### 步骤一：创建新项目

1. 打开终端，运行以下命令创建新的控制台应用：

   ```bash
   dotnet new console -n DapperOceanBaseDemo
   cd DapperOceanBaseDemo
   ```

### 步骤二：安装必要的 NuGet 包

1. 安装 Dapper、MySQL 连接器和相关依赖包：

   ```bash
   # 核心包
   dotnet add package Dapper
   dotnet add package MySql.Data
   
   # 配置相关
   dotnet add package Microsoft.Extensions.Configuration --version 8.0.0
   dotnet add package Microsoft.Extensions.Configuration.FileExtensions --version 8.0.0
   dotnet add package Microsoft.Extensions.Configuration.Json --version 8.0.0
   
   # 密码加密
   dotnet add package BCrypt.Net-Next --version 4.0.3
   ```

### 步骤三：配置数据库连接

1. 创建 `appsettings.json` 文件并添加数据库连接字符串：

   ```json
   {
     "ConnectionStrings": {
       "DefaultConnection": "Server=your_server;Port=2881;Database=your_database;Uid=your_username;Pwd=your_password;"
     }
   }
   ```

2. 修改项目文件 (`.csproj`) 确保 `appsettings.json` 被复制到输出目录：

   ```xml
   <ItemGroup>
     <None Update="appsettings.json">
       <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
     </None>
   </ItemGroup>
   ```

### 步骤四：创建数据模型

1. 创建 `Models` 文件夹并添加 `User.cs` 类：

   ```csharp
   namespace DapperOceanBaseDemo.Models;

   public class User
   {
       public int Id { get; set; }
       public string Username { get; set; }
       public string Email { get; set; }
       public string PasswordHash { get; set; }
       public DateTime CreatedAt { get; set; }
       public DateTime? UpdatedAt { get; set; }
   }
   ```

### 步骤五：实现数据访问层

1. 创建 `Repositories` 文件夹并添加 `UserRepository.cs` 类：

   ```csharp
   using System.Data;
   using Dapper;
   using DapperOceanBaseDemo.Models;
   using Microsoft.Extensions.Configuration;
   using MySql.Data.MySqlClient;

   namespace DapperOceanBaseDemo.Repositories;

   public class UserRepository
   {
       private readonly string _connectionString;

       public UserRepository(IConfiguration configuration)
       {
           _connectionString = configuration.GetConnectionString("DefaultConnection");
       }

       public async Task<User> GetUserByIdAsync(int id)
       {
           using IDbConnection db = new MySqlConnection(_connectionString);
           return await db.QueryFirstOrDefaultAsync<User>(
               "SELECT * FROM users WHERE Id = @Id LIMIT 1", new { Id = id });
       }

       public async Task<int> CreateUserAsync(User user)
       {
           const string sql = @"
               INSERT INTO users (Username, Email, PasswordHash, CreatedAt, UpdatedAt)
               VALUES (@Username, @Email, @PasswordHash, @CreatedAt, @UpdatedAt);
               SELECT LAST_INSERT_ID();";

           using IDbConnection db = new MySqlConnection(_connectionString);
           return await db.ExecuteScalarAsync<int>(sql, new
           {
               user.Username,
               user.Email,
               user.PasswordHash,
               CreatedAt = DateTime.UtcNow,
               UpdatedAt = (DateTime?)null
           });
       }
   }
   ```

### 步骤六：实现主程序

修改 `Program.cs` 文件：

```csharp
using DapperOceanBaseDemo.Models;
using DapperOceanBaseDemo.Repositories;
using Microsoft.Extensions.Configuration;
using System.Text;

var configuration = new ConfigurationBuilder()
    .SetBasePath(Directory.GetCurrentDirectory())
    .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
    .Build();

var userRepository = new UserRepository(configuration);

// Create a new user
var newUser = new User
{
    Username = "testuser",
    Email = "test@example.com",
    PasswordHash = BCrypt.Net.BCrypt.HashPassword("your_secure_password")
};

try
{
    var userId = await userRepository.CreateUserAsync(newUser);
    Console.WriteLine($"User created with ID: {userId}");

    // Query the user
    var user = await userRepository.GetUserByIdAsync(userId);
    if (user != null)
    {
        Console.WriteLine($"Retrieved user: {user.Username}, Email: {user.Email}");
    }
}
catch (Exception ex)
{
    Console.WriteLine($"An error occurred: {ex.Message}");
}
```

## 创建数据库表

在运行程序之前，请确保已在 OceanBase 数据库中创建相应的表：

```sql
CREATE TABLE IF NOT EXISTS users (
    Id INT AUTO_INCREMENT PRIMARY KEY,
    Username VARCHAR(50) NOT NULL,
    Email VARCHAR(100) NOT NULL UNIQUE,
    PasswordHash VARCHAR(255) NOT NULL,
    CreatedAt DATETIME NOT NULL,
    UpdatedAt DATETIME NULL,
    INDEX idx_email (Email)
);
```

## 运行程序

1. 确保已更新 `appsettings.json` 中的数据库连接字符串。

2. 在终端中运行：

   ```bash
   dotnet run
   ```

## 相关文档

* [Dapper 官方文档](https://github.com/DapperLib/Dapper/blob/main/docs/readme.md)
* [.NET 数据库访问最佳实践](https://docs.microsoft.com/zh-cn/ef/core/)
* [OceanBase 官方文档](https://www.oceanbase.com/docs)
