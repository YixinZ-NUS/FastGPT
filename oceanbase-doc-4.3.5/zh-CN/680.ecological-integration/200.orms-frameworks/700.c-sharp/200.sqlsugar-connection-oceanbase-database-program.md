|description|本文介绍如何使用 C# 的 SqlSugar ORM 框架连接 OceanBase 数据库，实现创建表、插入数据和查询数据等基本操作。|
|---|---|
|keywords|C#, .NET, SqlSugar, OceanBase, 数据库连接, ORM 框架, 生态集成|
|dir-name|SqlSugar|
|dir-name-en|SqlSugar|
|category|生态集成|
|type|框架和驱动|
|tenant-type|MySQL Mode|

# 使用 SqlSugar 连接 OceanBase 数据库

SqlSugar 是一个功能丰富且易于使用的 ORM 框架，支持 .NET 平台。本文将介绍如何使用 SqlSugar 连接 OceanBase 数据库的 MySQL 模式。

## 前提条件

* 已安装 .NET SDK 6.0 或更高版本
* 已安装 Visual Studio 或 VS Code
* 已部署 OceanBase 数据库并且创建了 MySQL 模式租户

## 操作步骤

1. 创建新项目
2. 安装必要的 NuGet 包
3. 配置数据库连接
4. 创建数据模型
5. 实现数据访问层
6. 运行示例程序

### 步骤一：创建新项目

1. 打开终端，运行以下命令创建新的控制台应用：

   ```bash
   dotnet new console -n SqlSugarOceanBaseDemo
   cd SqlSugarOceanBaseDemo
   ```

### 步骤二：安装必要的 NuGet 包

1. 安装 SqlSugar 核心包和 MySQL 数据库提供程序：

   ```bash
   # ORM 核心包
   dotnet add package SqlSugarCore
   
   # 数据库提供程序
   dotnet add package MySql.Data
   
   # 配置相关
   dotnet add package Microsoft.Extensions.Configuration --version 8.0.0
   dotnet add package Microsoft.Extensions.Configuration.FileExtensions --version 8.0.0
   dotnet add package Microsoft.Extensions.Configuration.Json --version 8.0.0
   
   # 密码加密
   dotnet add package BCrypt.Net-Next --version 4.0.3
   ```

### 步骤三：配置数据库连接

1. 创建 `appsettings.json` 文件并添加数据库连接字符串：

   ```json
   {
     "ConnectionStrings": {
       "DefaultConnection": "Server=your_server;Port=2881;Database=your_database;Uid=your_username;Pwd=your_password;"
     }
   }
   ```

2. 修改项目文件 (`.csproj`) 确保 `appsettings.json` 被复制到输出目录：

   ```xml
   <ItemGroup>
     <None Update="appsettings.json">
       <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
     </None>
   </ItemGroup>
   ```

### 步骤四：创建数据模型

1. 创建 `Models` 文件夹并添加 `User.cs` 类：

   ```csharp
   using SqlSugar;

   namespace SqlSugarOceanBaseDemo.Models;

   [SugarTable("users")]
   public class User
   {
       [SugarColumn(IsPrimaryKey = true, IsIdentity = true)]
       public int Id { get; set; }
       
       [SugarColumn(Length = 50, IsNullable = false)]
       public string Username { get; set; }
       
       [SugarColumn(Length = 100, IsNullable = false)]
       public string Email { get; set; }
       
       [SugarColumn(Length = 255, IsNullable = false)]
       public string PasswordHash { get; set; }
       
       [SugarColumn(IsNullable = false)]
       public DateTime CreatedAt { get; set; }
       
       [SugarColumn(IsNullable = true)]
       public DateTime? UpdatedAt { get; set; }
   }
   ```

### 步骤五：实现数据访问层

1. 创建 `Services` 文件夹并添加 `DatabaseContext.cs` 类：

   ```csharp
   using Microsoft.Extensions.Configuration;
   using SqlSugar;
   using System;
   using System.IO;

   namespace SqlSugarOceanBaseDemo.Services;

   public class DatabaseContext
   {
       public SqlSugarScope Db { get; private set; }

       public DatabaseContext(IConfiguration configuration)
       {
           Db = new SqlSugarScope(new ConnectionConfig()
           {
               ConnectionString = configuration.GetConnectionString("DefaultConnection"),
               DbType = DbType.MySql,
               IsAutoCloseConnection = true,
               InitKeyType = InitKeyType.Attribute
           },
           db =>
           {
               db.Aop.OnLogExecuting = (sql, pars) =>
               {
                   Console.WriteLine($"SQL: {sql}");
                   if (pars != null)
                   {
                       foreach (var param in pars)
                       {
                           Console.WriteLine($"  -> {param.ParameterName}: {param.Value}");
                       }
                   }
               };
               
               db.Aop.OnError = (exp) =>
               {
                   Console.WriteLine($"Error: {exp.Message}");
                   return true;
               };
               
               db.Aop.OnLogExecuted = (sql, pars) =>
               {
                   Console.WriteLine($"Execution time: {db.Ado.SqlExecutionTime.TotalMilliseconds}ms");
               };
               
               db.InitKeyType = InitKeyType.Attribute;
           };
           
           Db.CodeFirst.InitTables(typeof(Models.User));
       }
   }
   ```

2. 创建 `Repositories` 文件夹并添加 `UserRepository.cs` 类：

   ```csharp
   using SqlSugar;
   using SqlSugarOceanBaseDemo.Models;
   using System.Collections.Generic;
   using System.Threading.Tasks;

   namespace SqlSugarOceanBaseDemo.Repositories;

   public class UserRepository
   {
       private readonly ISqlSugarClient _db;

       public UserRepository(ISqlSugarClient db)
       {
           _db = db;
       }

       public async Task<List<User>> GetAllUsersAsync()
       {
           return await _db.Queryable<User>().ToListAsync();
       }

       public async Task<User> GetUserByIdAsync(int id)
       {
           return await _db.Queryable<User>().FirstAsync(u => u.Id == id);
       }

       public async Task<int> CreateUserAsync(User user)
       {
           user.CreatedAt = DateTime.UtcNow;
           return await _db.Insertable(user).ExecuteReturnIdentityAsync();
       }

       public async Task<bool> UpdateUserAsync(User user)
       {
           user.UpdatedAt = DateTime.UtcNow;
           return await _db.Updateable(user).ExecuteCommandHasChangeAsync();
       }

       public async Task<bool> DeleteUserAsync(int id)
       {
           return await _db.Deleteable<User>().Where(u => u.Id == id).ExecuteCommandHasChangeAsync();
       }
   }
   ```

### 步骤六：实现主程序

修改 `Program.cs` 文件：

```csharp
using Microsoft.Extensions.Configuration;
using SqlSugarOceanBaseDemo.Models;
using SqlSugarOceanBaseDemo.Repositories;
using SqlSugarOceanBaseDemo.Services;
using System;
using System.IO;
using System.Threading.Tasks;

var configuration = new ConfigurationBuilder()
    .SetBasePath(Directory.GetCurrentDirectory())
    .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
    .Build();

var dbContext = new DatabaseContext(configuration);
var userRepository = new UserRepository(dbContext.Db);

var newUser = new User
{
    Username = "testuser",
    Email = "test@example.com",
    PasswordHash = BCrypt.Net.BCrypt.HashPassword("your_secure_password")
};

try
{
    var createdUser = await userRepository.CreateUserAsync(newUser);
    Console.WriteLine($"User created with ID: {createdUser.Id}");

    var user = await userRepository.GetUserByIdAsync(createdUser.Id);
    if (user != null)
    {
        Console.WriteLine($"Retrieved user: {user.Username}, Email: {user.Email}");
        
        user.Username = "updated_username";
        var updated = await userRepository.UpdateUserAsync(user);
        Console.WriteLine($"User updated: {updated}");
        
        var users = await userRepository.GetAllUsersAsync();
        Console.WriteLine($"Total users: {users.Count}");
        
        var deleted = await userRepository.DeleteUserAsync(user.Id);
        Console.WriteLine($"User deleted: {deleted}");
    }
}
catch (Exception ex)
{
    Console.WriteLine($"An error occurred: {ex.Message}");
}
```

## 运行程序

1. 确保已更新 `appsettings.json` 中的数据库连接字符串

2. 在终端中运行：

   ```bash
   dotnet run
   ```

## 相关文档

* [SqlSugar 官方文档](https://www.donet5.com/Home/Doc)
* [.NET 数据库访问最佳实践](https://docs.microsoft.com/zh-cn/ef/core/)
* [OceanBase 官方文档](https://www.oceanbase.com/docs)
