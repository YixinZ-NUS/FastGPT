# 使用旁路导入加速海量数据导入

## 背景介绍

OceanBase 目前主流使用 **Load Data**、**obloader** 和 **OMS** 三种数据导入方式，均通过 `INSERT` 语句写入数据。然而，`INSERT` 操作需经过 **SQL 查询、事务处理、LSM-Tree 存储** 等流程。由于 OceanBase 采用 **LSM-Tree 存储结构**，`INSERT` 数据会先写入内存表（MemTable），再通过多轮 **转储（Flush）** 和 **合并（Compaction）** 存入最终的 **SSTable**。这一过程消耗大量 CPU 资源，导致导入速度较慢。

为解决此问题，OceanBase 引入 **旁路导入技术**，绕过中间处理步骤，直接将数据写入底层的 **Major SSTable**。该技术不仅适用于数据导入，还可加速需大量写入的 SQL 操作（如 `INSERT INTO SELECT`）。

[ClickBench](https://benchmark.clickhouse.com/) 是 ClickHouse 提出的一个AP benchmark。通过这个 AP Benchmark 可以测试 OceanBase 数据库在 AP 场景下的查询性能。在运行这个 Benchmark 之前，首先需要导入数据。**导入数据** 这一步可以体验 OceanBase 数据库导入数据的性能。当然在 TPCH，TPCDS 等 AP Benchmark 上都可以使用旁路导入准备数据。本教程将指导您使用旁路导入技术，加速海量数据导入，体验 OceanBase 的高效性能。

## 适用场景

* **AP 场景数据准备**：如 ClickHouse Benchmark、TPC-H/TPC-DS 等分析型测试。
* **批量写入加速**：替代 `INSERT INTO SELECT` 等高吞吐写入操作。

通过旁路导入技术，可显著提升数据导入效率，适用于需快速加载海量数据的场景。

## 技术架构

数据导入可采用两种路径。

* 传统路径：蓝色箭头所示的传统路径需要经过 SQL 查询、事务处理、数据存储等一系列模块。

* 旁路导入路径：而绿色箭头所示旁路导入路径主要是对导入的数据进行类型转换，然后按照主键进行排序（如果有的话），最后将排序后的数据写入到 **Major SSTable** 中。旁路导入是一条短路径，能减少系统资源消耗，加快导入速度。

如下图所示：

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer/tutorial/bypass/bypass-structure.png)

## 前提条件

### 环境准备

* 环境要求：

  * 确保已部署 OceanBase 4.3 或更高版本集群，并创建 MySQL 模式的租户环境。
  * 本实验采用 16c32g 资源规格，后续所有步骤及测试结果均基于此配置完成。

  要了解如何部署 OceanBase 集群，参见 [部署概述](../400.deploy/100.deploy-overview.md)。部署完成后，您可以通过 sys 租户执行以下 SQL 语句查看集群和租户信息：

  ```sql
  -- 验证集群信息
  SELECT * FROM GV$OB_SERVERS;

  -- 验证租户信息
  SELECT * FROM oceanbase.DBA_OB_TENANTS;
  ```

* 权限要求：

  确保所创建的租户具备 `INSERT` 和 `SELECT` 权限。更多有关 OceanBase 数据库权限的详细介绍，请参见 [MySQL 模式下的权限分类](../600.manage/500.security-and-permissions/300.access-control/200.user-and-permission/200.permission-of-mysql-mode/100.permission-classification-of-mysql.md)。

### 数据准备

#### 下载测试数据

* 访问 [ClickHouse 官网](https://benchmark.clickhouse.com/) 下载 [**hits 数据集**](https://datasets.clickhouse.com/hits_compatible/hits.tsv.gz)。

* 解压数据至指定路径（例如：`/path/to/hits.tsv`）。

## 操作步骤

### 步骤一：创建列存表

* 执行建表语句（列存表通过 `WITH COLUMN GROUP` 定义）：

  ```sql
  CREATE TABLE hits
  (
    WatchID BIGINT NOT NULL,
    JavaEnable SMALLINT NOT NULL,
    Title TEXT NOT NULL,
    GoodEvent SMALLINT NOT NULL,
    EventTime TIMESTAMP NOT NULL,
    EventDate Date NOT NULL,
    CounterID INTEGER NOT NULL,
    ClientIP INTEGER NOT NULL,
    RegionID INTEGER NOT NULL,
    UserID BIGINT NOT NULL,
    CounterClass SMALLINT NOT NULL,
    OS SMALLINT NOT NULL,
    UserAgent SMALLINT NOT NULL,
    URL TEXT NOT NULL,
    Referer TEXT NOT NULL,
    IsRefresh SMALLINT NOT NULL,
    RefererCategoryID SMALLINT NOT NULL,
    RefererRegionID INTEGER NOT NULL,
    URLCategoryID SMALLINT NOT NULL,
    URLRegionID INTEGER NOT NULL,
    ResolutionWidth SMALLINT NOT NULL,
    ResolutionHeight SMALLINT NOT NULL,
    ResolutionDepth SMALLINT NOT NULL,
    FlashMajor SMALLINT NOT NULL,
    FlashMinor SMALLINT NOT NULL,
    FlashMinor2 TEXT NOT NULL,
    NetMajor SMALLINT NOT NULL,
    NetMinor SMALLINT NOT NULL,
    UserAgentMajor SMALLINT NOT NULL,
    UserAgentMinor VARCHAR(255) NOT NULL,
    CookieEnable SMALLINT NOT NULL,
    JavascriptEnable SMALLINT NOT NULL,
    IsMobile SMALLINT NOT NULL,
    MobilePhone SMALLINT NOT NULL,
    MobilePhoneModel TEXT NOT NULL,
    Params TEXT NOT NULL,
    IPNetworkID INTEGER NOT NULL,
    TraficSourceID SMALLINT NOT NULL,
    SearchEngineID SMALLINT NOT NULL,
    SearchPhrase TEXT NOT NULL,
    AdvEngineID SMALLINT NOT NULL,
    IsArtifical SMALLINT NOT NULL,
    WindowClientWidth SMALLINT NOT NULL,
    WindowClientHeight SMALLINT NOT NULL,
    ClientTimeZone SMALLINT NOT NULL,
    ClientEventTime TIMESTAMP NOT NULL,
    SilverlightVersion1 SMALLINT NOT NULL,
    SilverlightVersion2 SMALLINT NOT NULL,
    SilverlightVersion3 INTEGER NOT NULL,
    SilverlightVersion4 SMALLINT NOT NULL,
    PageCharset TEXT NOT NULL,
    CodeVersion INTEGER NOT NULL,
    IsLink SMALLINT NOT NULL,
    IsDownload SMALLINT NOT NULL,
    IsNotBounce SMALLINT NOT NULL,
    FUniqID BIGINT NOT NULL,
    OriginalURL TEXT NOT NULL,
    HID INTEGER NOT NULL,
    IsOldCounter SMALLINT NOT NULL,
    IsEvent SMALLINT NOT NULL,
    IsParameter SMALLINT NOT NULL,
    DontCountHits SMALLINT NOT NULL,
    WithHash SMALLINT NOT NULL,
    HitColor CHAR NOT NULL,
    LocalEventTime TIMESTAMP NOT NULL,
    Age SMALLINT NOT NULL,
    Sex SMALLINT NOT NULL,
    Income SMALLINT NOT NULL,
    Interests SMALLINT NOT NULL,
    Robotness SMALLINT NOT NULL,
    RemoteIP INTEGER NOT NULL,
    WindowName INTEGER NOT NULL,
    OpenerName INTEGER NOT NULL,
    HistoryLength SMALLINT NOT NULL,
    BrowserLanguage TEXT NOT NULL,
    BrowserCountry TEXT NOT NULL,
    SocialNetwork TEXT NOT NULL,
    SocialAction TEXT NOT NULL,
    HTTPError SMALLINT NOT NULL,
    SendTiming INTEGER NOT NULL,
    DNSTiming INTEGER NOT NULL,
    ConnectTiming INTEGER NOT NULL,
    ResponseStartTiming INTEGER NOT NULL,
    ResponseEndTiming INTEGER NOT NULL,
    FetchTiming INTEGER NOT NULL,
    SocialSourceNetworkID SMALLINT NOT NULL,
    SocialSourcePage TEXT NOT NULL,
    ParamPrice BIGINT NOT NULL,
    ParamOrderID TEXT NOT NULL,
    ParamCurrency TEXT NOT NULL,
    ParamCurrencyID SMALLINT NOT NULL,
    OpenstatServiceName TEXT NOT NULL,
    OpenstatCampaignID TEXT NOT NULL,
    OpenstatAdID TEXT NOT NULL,
    OpenstatSourceID TEXT NOT NULL,
    UTMSource TEXT NOT NULL,
    UTMMedium TEXT NOT NULL,
    UTMCampaign TEXT NOT NULL,
    UTMContent TEXT NOT NULL,
    UTMTerm TEXT NOT NULL,
    FromTag TEXT NOT NULL,
    HasGCLID SMALLINT NOT NULL,
    RefererHash BIGINT NOT NULL,
    URLHash BIGINT NOT NULL,
    CLID INTEGER NOT NULL,
    PRIMARY KEY (CounterID, EventDate, UserID, EventTime, WatchID)
  ) with column group (each column);
  ```

### 步骤二：执行旁路导入

#### 旁路导入

```sql
LOAD DATA
/*+
  query_timeout(10000000000)
  parallel(32)
  direct(true, 0)  -- 启用旁路导入模式
*/
INFILE '/path/to/hits.tsv'
INTO TABLE hits
FIELDS TERMINATED BY '\t'
ENCLOSED BY ''
ESCAPED BY '';
```

执行完成后，可观察到旁路导入的执行时间。

#### 非旁路导入对比

```sql
LOAD DATA
/*+
  query_timeout(10000000000)
  parallel(32)
*/
INFILE '/path/to/hits.tsv'
INTO TABLE hits
FIELDS TERMINATED BY '\t'
ENCLOSED BY ''
ESCAPED BY '';
```

执行完成后，可观察到非旁路导入的执行时间。

## 性能对比

| **场景**         | **执行时间（秒）** |
|------------------|-------------------|
| **旁路导入**     | 249              |
| **非旁路导入**   | 767              |

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>本实验采用 16c32g 资源规格，执行环境有差异，执行时间也有出入，上述表格中的执行时间可做参考。</p>
</main>

**结论**：旁路导入速度提升 **3 倍以上**，适用于大规模数据导入场景（如 TPC-H/TPC-DS 测试数据准备）。

## 相关文档

[旁路导入概述](../620.obap/300.obap-data-collection/300.obap-import-data/20.bypass-import/100.overview-of-bypass-import.md)