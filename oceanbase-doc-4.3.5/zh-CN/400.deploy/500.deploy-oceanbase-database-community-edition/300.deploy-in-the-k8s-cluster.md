# 在 Kubernetes 环境中部署 OceanBase 集群

本文结合示例介绍如何通过 ob-operator 在 Kubernetes 环境中部署 OceanBase 集群。

## 前提条件

在开始之前，请确保您已满足以下条件：

- 您有可用的 Kubernetes 集群且至少有 9 个可用 CPU，33 GB 可用内存 和 360 GB 的可用存储空间。

- ob-operator 依赖 cert-manager，请确保您已安装 cert-manager。cert-manager 的安装方法请参考对应的[安装文档](https://cert-manager.io/docs/installation/)。

- 连接 OceanBase 集群时，您需已安装 MySQL 客户端或 OBClient。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>本文以 ob-operator V2.3.1 为例介绍操作步骤，其他版本可能略有不同。不同版本的操作步骤可参见 <a href='https://www.oceanbase.com/docs/community-ob-operator-doc-1000000001666234'>ob-operator 手册</a> 中对应版本内容。</p>
</main>

## 操作步骤

### 步骤一：部署 ob-operator

使用 ob-operator 可以简化 OceanBase 数据库在 Kubernetes 中的部署和运维，您可通过以下三种方式部署 ob-operator。

:::tab

tab 使用 okctl 进行部署

1. 下载安装 `okctl`

   ```shell
   curl -sL https://raw.githubusercontent.com/oceanbase/ob-operator/master/scripts/install-okctl.sh | bash
   sudo mv ./okctl /usr/local/bin
   ```

2. 安装 ob-operator

   在成功安装 `okctl` 之后，您可以使用如下命令安装 ob-operator。

   ```shell
   okctl install ob-operator
   ```

3. 确认 ob-operator 安装成功

   ```shell
   kubectl get pod -n oceanbase-system
   ```

   如 ob-operator 安装成功，将会输出如下内容：

   ```shell
   # desired output
   NAME                                            READY   STATUS    RESTARTS   AGE
   oceanbase-controller-manager-86cfc8f7bf-4hfnj   2/2     Running   0          1m
   ```

tab 使用 Helm 部署

您可执行以下命令部署 ob-operator。

```shell
helm repo add ob-operator https://oceanbase.github.io/ob-operator/
helm install ob-operator ob-operator/ob-operator --namespace=oceanbase-system --create-namespace
```

其中，`--namespace` 用于设置命名空间，可根据需要自定义，建议使用 `oceanbase-system`。

tab 使用配置文件部署

您可执行如下命令使用配置文件部署 ob-operator。

```shell
kubectl apply -f https://raw.githubusercontent.com/oceanbase/ob-operator/stable/deploy/operator.yaml
```

**ob-operator 自定义**

如果您需要对 ob-operator 进行自定义修改，可执行如下命令下载配置文件。

```shell
wget https://raw.githubusercontent.com/oceanbase/ob-operator/stable/deploy/operator.yaml
```

根据自身需求修改配置文件后，执行如下命令进行自定义部署。配置文件中的配置项的详细含义可参见 [配置 ob-operator](https://www.oceanbase.com/docs/community-ob-operator-doc-1000000001666230)。

```shell
kubectl apply -f operator.yaml
```

:::

### 步骤二：部署 OceanBase 集群

1. 准备存储类

   ob-operator 在部署 OceanBase 集群时需要创建 PVC 作为 OceanBase 集群的存储。本文中使用 local-path-provisioner 来管理 PVC。部署命令如下：

   ```shell
   kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.24/deploy/local-path-storage.yaml
   ```

   更多信息可以参考 [local-path-provisioner](https://github.com/rancher/local-path-provisioner)。

2. 创建 Namespace

   执行如下命令创建部署 OceanBase 集群使用的 Namespace。

   ```shell
   kubectl create namespace oceanbase
   ```

   创建后可执行 `kubectl get namespace oceanbase` 命令查看是否创建成功（状态为 `Active`）。

3. 创建集群

   通过 okctl 命令可以快速的创建集群，命令如下。

   ```shell
   okctl cluster create obcluster -n oceanbase --image oceanbase/oceanbase-cloud-native:4.3.5.0-100000202024123117 -p ******* --zones=zone1=1 --zones=zone2=1 --zones=zone3=1
   ```

   以上命令将会创建一个 3 个 zone 的集群，资源和存储使用默认最小的配置，如果您希望自定义其他配置，可以使用以下命令获取完整支持的参数。

   ```shell
   okctl cluster create -h
   ```

   输出如下：

   ```shell
   Create an ob cluster
   
   Usage:
     okctl cluster create <cluster_name> [flags]
   
   Flags:
         --backup-storage-address string   The storage class of the backup storage
         --backup-storage-path string      The size of the backup storage
         --cluster-name string             Cluster name, if not specified, use resource name in k8s instead
         --cpu int                         The cpu of the observer (default 2)
         --data-storage-class string       The storage class of the data storage (default "local-path")
         --data-storage-size int           The size of the data storage (default 50)
     -h, --help                            help for create
         --id int                          The id of the cluster
         --image string                    The image of the observer (default "quay.io/oceanbase/oceanbase-cloud-native:4.3.3.1-101000012024102216")
         --log-storage-class string        The storage class of the log storage (default "local-path")
         --log-storage-size int            The size of the log storage (default 20)
         --memory int                      The memory of the observer (default 10)
         --mode string                     The mode of the cluster (default "service")
     -n, --namespace string                The namespace of the cluster (default "default")
         --parameters stringToString       Other parameter settings in OBCluster, e.g., __min_full_resource_pool_memory (default [__min_full_resource_pool_memory=2147483648,system_memory=1G])
         --redo-log-storage-class string   The storage class of the redo log storage (default "local-path")
         --redo-log-storage-size int       The size of the redo log storage (default 50)
     -p, --root-password string            The root password of the cluster
     -z, --zones stringToString            The zones of the cluster, e.g. '--zones=<zone>=<replica>' (default [z1=1])
   ```

   如果您需要更多的自定义配置，可以使用配置文件的方式进行创建，具体创建方法请参见官网《OceanBase K8s 运维工具》文档 [集群创建](https://www.oceanbase.com/docs/community-ob-operator-doc-1000000001666252)。

### 步骤三：（可选）部署 ODP

ODP 提供路由用户请求的能力，可以将用户的请求路由到正确的 OBServer 节点。您可通过以下脚本部署 ODP 集群。

```shell
curl -sL https://raw.githubusercontent.com/oceanbase/ob-operator/refs/heads/master/scripts/setup-obproxy.sh | bash -s -- --proxy-image oceanbase/obproxy-ce:4.3.3.0-5 -n oceanbase obcluster
```

## 连接 OceanBase 集群

部署 OceanBase 集群后，您可参考本节步骤直连 OceanBase 集群。如部署有 ODP，也可通过 ODP 来连接 OceanBase 集群。

:::tab

tab 直连 OceanBase 集群

1. 获取 OceanBase 集群 Pod 地址

   ```shell
   kubectl get pods -n oceanbase -l ref-obcluster=obcluster -o wide
   ```

   示例中的 `oceanbase` 对应 `-n`（执行 okctl 命令时）/`metadata`.`namespace`（使用配置文件时）的值，`obcluster` 对应 `<cluster_name>`（执行 okctl 命令时）/`metadata`.`name`（使用配置文件时）的值，您需根据实际配置进行替换。

   输出如下：

   ```shell
   NAME                                READY   STATUS    RESTARTS   AGE    IP            NODE     NOMINATED NODE   READINESS GATES
   obcluster-1-zone2-c76d303299a9      2/2     Running   0          4m     10.10.10.1    node-x   <none>           <none>
   obcluster-1-zone3-2cdf3cd8a05e      2/2     Running   0          4m     10.10.10.2    node-x   <none>           <none>
   obcluster-1-zone1-94904330202f      2/2     Running   0          4m     10.10.10.3    node-x   <none>           <none>
   ```

2. 连接 OceanBase 集群

   您可以使用任一节点的 IP 连接到 OceanBase 集群，对应的连接命令如下。

   ```shell
   mysql -h10.10.10.1 -P2881 -uroot@sys -p oceanbase -A -c
   ```

tab 通过 ODP 连接 OceanBase 集群

1. 获取 ODP 服务地址

   在部署好 ODP 集群之后，您可以通过以下命令来获取 ODP 服务地址。

   ```shell
   kubectl get svc svc-obproxy-obcluster -n oceanbase
   ```

   输出如下：

   ```shell
   NAME                      TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE
   svc-obproxy-obcluster     ClusterIP   10.10.10.4   <none>        2883/TCP,2884/TCP   97s
   ```

2. 连接 OceanBase 集群

   使用查询到的服务地址连接 OceanBase 集群，命令如下。

   ```shell
   mysql -h10.10.10.4 -P2883 -uroot@sys#obcluster -p
   ```

:::

## 部署 OceanBase Dashboard

OceanBase Dashboard 是与 ob-operator 配套的白屏运维工具，具有集群管理、租户管理、备份管理、性能监控、OBProxy 管理和终端连接等功能。

### 安装 OceanBase Dashboard

OceanBase Dashboard 的安装方式有以下两种。

:::tab

tab 使用 okctl 工具安装

okctl 提供了安装 OceanBase Dashboard 的命令，确认已安装 okctl 后，您可以执行以下命令进行安装 OceanBase Dashboard。

```shell
okctl install ob-dashboard
```

tab 使用 Helm 安装

确认已经安装了 Helm 之后，执行下面三条命令即可在默认命名空间安装 OceanBase Dashboard。

```shell
helm repo add ob-operator https://oceanbase.github.io/ob-operator/
helm repo update ob-operator
helm install oceanbase-dashboard ob-operator/oceanbase-dashboard
```

若要在其他命名空间安装 OceanBase Dashboard，可将最后一条安装命令替换为如下命令。

```shell
helm install oceanbase-dashboard ob-operator/oceanbase-dashboard -n <namespace> --create-namespace
```

其中，`<namespace>` 需设置为待安装 OceanBase Dashboard 的目标命名空间，若目标命名空间不存在，可配置 `--create-namespace` 进行创建。若您的集群支持 LoadBalancer 服务，也可在安装时配置 `--set service.type=LoadBalancer`，指定创建 LoadBalancer 类型的服务。

:::

执行安装命令后，您可通过如下命令查询 OceanBase Dashboard 是否完成安装。

```shell
kubectl get deployment oceanbase-dashboard-oceanbase-dashboard
```

输出如下，`READY` 列显示 `1/1` 即表示已经安装完成，可进行后续操作。

```shell
NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
oceanbase-dashboard-oceanbase-dashboard   1/1     1            1           2m10s
```

### 访问 OceanBase Dashboard

OceanBase Dashboard 默认创建的登录账号和密码均为 `admin`，使用默认账号和密码登陆之后会提示修改密码。

您有如下三种方法访问 OceanBase Dashboard，可根据实际情况选择合适的访问方法。

- 通过 NodePort 访问：OceanBase Dashboard 默认创建 NodePort 类型的服务，您可通过 NodePort 访问 OceanBase Dashboard。

- 通过 LoadBalancer 访问：若您的集群支持 LoadBalancer 服务，可通过 LoadBalancer 访问 OceanBase Dashboard。

- 通过 Port Forward 临时访问：若您的集群节点端口不可访问，无法使用上述两种服务，可通过 Port Forward 临时访问 OceanBase Dashboard。

:::tab

tab 通过 NodePort 访问

OceanBase Dashboard 默认创建 NodePort 类型的服务，您可通过执行如下命令获取服务在节点上暴露的端口。需要注意的是，服务的名称会根据您指定的 Helm Chart 名称变化而变化，具体可参考安装 OceanBase Dashboard 时输出中的第一条指令中的服务名称，本文示例中为 `oceanbase-dashboard-oceanbase-dashboard`。

```shell
kubectl get svc oceanbase-dashboard-oceanbase-dashboard
```

输出如下：

```shell
NAME                                      TYPE       CLUSTER-IP   EXTERNAL-IP  PORT(S)        AGE
oceanbase-dashboard-oceanbase-dashboard   NodePort   10.10.10.1   <none>       80:30176/TCP   13m
```

通过浏览器访问该 K8s 节点的 `PORT` 端口即可打开 OceanBase Dashboard 登录界面。服务的端口号由 K8s 动态分配，节点 IP 可通过执行 `kubectl get nodes -o wide` 命令查看。

tab 通过 LoadBalancer 访问

您可在安装 OceanBase Dashboard 指定创建 LoadBalancer 类型的服务，也可在安装 OceanBase Dashboard 后，执行如下命令将服务类型修改为 LoadBalancer。

```shell
kubectl patch -n oceanbase-dashboard svc oceanbase-dashboard-oceanbase-dashboard --type=merge --patch='{"spec": {"type": "LoadBalancer"}}'
```

修改完成后集群将为 OceanBase Dashboard 服务分配外部 IP，通过该外部 IP 即可访问 OceanBase Dashboard 的页面。修改后等待一段时间再次查看服务信息会看到 External IP 字段已被赋值。

```shell
kubectl get svc oceanbase-dashboard-oceanbase-dashboard
```

输出如下：

```shell
NAME                                      TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)        AGE
oceanbase-dashboard-oceanbase-dashboard   LoadBalancer   10.10.10.1      10.10.10.2     80:18082/TCP   1d5h
```

在浏览器中输入 `http://10.10.10.2:18082` 即可访问 OceanBase Dashboard，这里仅以 `EXTERNAL-IP` 为 `10.10.10.2`，`PORT` 为 `18082` 为例，您需根据实际输出进行替换。

tab 通过 Port Forward 临时访问

若您集群节点的端口不可访问，无法使用 NodePort 类型的服务暴露 OceanBase Dashboard，也不支持 LoadBalancer 的服务，可以使用 `kubectl port-forward` 命令将 OceanBase Dashboard 暴露到当前机器指定端口进行临时访问，例如执行下面的命令可将 OceanBase Dashboard 暴露在您当前机器（执行这条命令的机器）的 `18081` 端口。

```shell
kubectl port-forward -n default services/oceanbase-dashboard-oceanbase-dashboard 18081:80 --address 0.0.0.0
```

通过其他电脑的浏览器访问该机器的 `18081` 端口，可以打开登录界面。若执行上述命令的机器是您的个人电脑，打开浏览器访问 `http://127.0.0.1:18081` 即可访问到服务。

:::

### 查看监控指标

访问到 OceanBase Dashboard 页面后，您可单击左侧的 **集群** 和 **租户**，选择查看集群或租户的监控信息。页面展示示例如下。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>除了针对集群和租户的性能指标监控功能外，OceanBase Dashboard 还提供了集群管理、租户管理、备份管理、 OBProxy 管理和终端连接等功能。</p>
</main>

集群监控指标如下：

![集群监控指标](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.3.0/400.deploy/500.community/300.deploy-in-the-k8s-cluster-01.png)

租户监控指标如下：

![租户监控指标](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.3.0/400.deploy/500.community/300.deploy-in-the-k8s-cluster-02.png)

## 相关文档

- [创建租户](https://www.oceanbase.com/docs/community-ob-operator-doc-1000000000659342)

- [GitHub 文档](https://oceanbase.github.io/ob-operator/zh-Hans/)

- [GitHub 代码仓库](https://github.com/oceanbase/ob-operator)
