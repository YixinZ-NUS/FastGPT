# 通过 OCP 部署 OceanBase 集群

本文以 x86 架构的 CentOS Linux 7.9 镜像作为环境介绍如何使用 OCP 白屏部署 OceanBase 数据库。

## 前提条件

* 您已部署 OCP，详细操作请参考 [部署社区版 OceanBase 云平台](https://www.oceanbase.com/docs/common-ocp-1000000002078206)。

* 当前登录 OCP 的用户为 **ADMIN** 角色或 **ORG_ADMIN** 角色。

* 已上传部署所需的 oceanbase-ce、 oceanbase-ce-libs 和 oceanbase-ce-utils 软件包至 OCP，详细操作可参见官网《OceanBase 云平台》文档 [软件包管理/上传软件包](https://www.oceanbase.com/docs/common-ocp-1000000002077811)。

* （可选）若您创建的是多副本 OceanBase 集群，则需当前 OCP 中已存在可用的 ODP 集群。如何新增 ODP 集群可参考官网《OceanBase 云平台》文档 [OBProxy 管理/创建 OBProxy 集群](https://www.oceanbase.com/docs/common-ocp-1000000002077790)。

## 操作步骤

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>本文以 OCP V4.3.4 社区版本为例提供操作指导。不同 OCP 版本的操作界面可能不同，请以实际界面为准。</p>
</main>

### 步骤一：添加机器到 OCP 资源池

部署 OceanBase 集群前，您需先参考本节内容将机器添加到 OCP 资源池。

1. 登录 OCP。

2. 在左侧导航栏中单击 **主机**，进入 **主机** 页面。

3. 在 **主机** 页面右上角单击 **添加主机**。

4. 在弹出的对话框中填写机器信息。

   ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.3.5/400.deploy/500.deploy-oceanbase-database-community-edition/200.deploy-by-ocp-02.png)

   各字段填写说明如下表所示。

   |   **字段** |         **描述**     |
   |------------|----------------------|
   | **IP 地址**  | 待添加机器的 IP，请输入新主机的 IPv4 地址，支持同时添加多个 IP 地址（多个 IP 之间用英文逗号分隔）。  |
   | **SSH 端口** | 默认为 `22`。               |
   | **机型**   | 为配置相同的主机指定的一个标签，便于 OCP 更好地管理主机。如果没有对应的机型，可在下拉菜单中单击 **新增机型**，添加新的机型。|
   | **机房**   | 选择机器所处机房。如果没有对应的机房，可在下拉菜单中单击 **新增机房** 在 OCP 中新增机房信息。机房信息包括 **机房** 与 **区域**。<ul><li>机房是 OceanBase 集群需要记录的一种主机属性，这个属性会作为 OceanBase 集群负载均衡和 SQL 语句路由策略的参考项，请按照实际情况填写。</li><li>区域用于表示主机所处的地理区域，是 OceanBase 集群需要记录的主机属性之一，对于 OceanBase 集群的负载均衡和 SQL 语句路由策略会有一定的影响，请按照实际情况填写。</li></ul><main id="notice" type='explain'><h4>说明</h4><p>OCP V3.1.1 版本开始支持多可用区模式，新增机房时，将在当前 OCP 所在的可用区中创建新的机房。</p></main>|
   | **主机类型**     | 有 **物理机**、**容器** 和 **ECS** 三种选项。选择 **容器** 类型时，需要填写 **端口映射**，即指定 ocp-agent 与宿主机、ocp export 与宿主机一共 2 组的映射关系，对应的格式为 `<主机端口>:<docker 中 ocp-agent 端口>,<主机端口>:<docker 中 ocp-exporter 端口 1>`。   |
   | **凭据**   | 选择远程登录物理机使用的凭据，您可以在下拉菜单中单击 **新增凭据** 来新建凭据。 </br> 新增凭据时需注意：<ul><li>**凭据名**：以英文字母开头、英文或数字结尾，可包含英文、数字和下划线，且长度为 2 ~ 64。</li><li>**授权类型**：包含 **密码验证**、**公钥验证** 和 **已配置免密** 三种类型。</li> <li>**用户类型**：支持拥有 root 权限的 SSH 用户，拥有 root 权限的普通用户须先配置免密执行 sudo 指令。OCP 目前仅支持配置所有指令免密执行 sudo，即在 `/etc/sudoers` 文件中，添加 `username ALL=(ALL) NOPASSWD:ALL`。</li></ul>|
   | **主机别名（可选）**   | 选填，为主机设置其它名称。   |
   | **说明（可选）**     | 主机的注释，便于更好地管理主机。      |

5. 填写完成后，单击 **确定**。

### 步骤二：创建 OceanBase 集群

您可参考本节介绍通过 OCP 创建 OceanBase 集群。

1. 在 OCP 白屏界面中根据实际业务场景，找到新建集群的入口。

   * 如果您没有可管理的集群，系统会在 **集群** 页面提示您新建集群，可直接在提示信息中单击 **创建集群**。

   * 如果您已有可管理的集群，可单击左侧 **集群** 后，在 **集群** 页面右上角单击 **创建集群**。
  
   <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>OCP 默认创建分布式集群，您可在 <b>创建集群</b> 页面右上角选择部署的集群模式（<b>分布式集群</b> 和 <b>单机集中式</b>）。此处以创建 <b>分布式集群</b> 为例进行介绍。</p></main>

2. 在 **创建集群** 页面，设置集群的基础信息。

   ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.3.5/400.deploy/500.deploy-oceanbase-database-community-edition/200.deploy-by-ocp-03.png)

   基础信息相关说明如下表所示。

   |    **配置**       |     **描述**    |
   |-------------------|-----------------|
   | **集群类型**      | 选择 **主集群**。<main id="notice" type='notice'><h4>功能适用性</h4><p>OCP 社区版仅支持新建主集群。</p></main>  |
   | **集群名称**      | 自定义待管理的集群的名称。集群名称必须以英文字母开头、英文或数字结尾，可包含英文、数字和下划线，且长度为 2 ~ 32。 |
   | **root@sys 密码** | 支持自定义或随机生成。密码需要满足以下复杂度条件：</br> <ul><li>长度：8 \~ 32 字符</li><li>包含以下四种类型字符至少三种及以上：数字（0~9）、大写字母（A~Z）、小写字母（a~z）、特殊符号 `~!@#%^&*_-+=|(){}[]:;,.?/`</li></ul>输入密码后，您可以单击 **复制密码**，将自定义或随机生成的密码复制到剪贴板。 |
   | **OceanBase 版本**   | 可以从列表中选择已有的 OceanBase 数据库版本，也可以在下拉菜单中单击 **上传软件包**，上传 OceanBase 数据库 RPM 包。     |
   | **关联 OBProxy 集群** | 该选项用于关联已有的 ODP 集群，如您创建的是多副本的 OceanBase 集群，建议您打开 **关联 OBProxy 集群** 开关，为该 OceanBase 集群关联 ODP 集群。关联后您的业务涉及的 SQL 请求将会被精准转发到相应的副本，使您对 OceanBase 数据库的访问效果能够媲美访问单机数据库。<ul><li>默认使用 `proxyro@sys` 用户关联，您无需填写用户名和密码。</li><li>在下拉框中选择要关联的 ODP 集群。如下拉框中没有可关联的 ODP 集群，请参考本文 **前提条件** 中的链接添加 ODP 集群。</li></ul> <main id="notice" type='notice'><h4>注意</h4><ul><li>仅可选择与 OceanBase 集群网络一致且非空的 OBProxy 集群。</li><li><p>当 <b>OceanBase 版本</b> 中选择的集群为 V4.0 及以上版本时，仅支持关联 V4.0.0 及以上版本的 OBProxy 集群。</p></li></ul></main> |
   | **负载类型** | 可在下拉框中选择对应的负载类型，OCP 会根据不同的负载类型为 OceanBase 集群设置不同的配置。负载类型的具体说明如下：<ul><li><b>Express OLTP</b>：适用于贸易、支付核心系统、互联网高吞吐量应用程序等工作负载。没有外键等限制，没有存储过程，没有长交易，没有大交易，没有复杂的联接，没有复杂的子查询。</br>版本限制：适用于 OceanBase 数据库 V4.2.5 及以上版本。</li><li><b>HTAP</b>：适用于混合 OLAP 和 OLTP 工作负载。通常用于从活动运营数据、欺诈检测和个性化建议中获取即时见解。</br>版本限制：适用于 OceanBase 数据库 V4.2.5 及以上版本。</li><li><b>OLAP</b>：用于实时数据仓库分析场景。</br>版本限制：适用于 OceanBase 数据库 V4.3.0 及以上版本。</li><li><b>Complex OLTP</b>：适用于银行、保险系统等工作负载。它们通常具有复杂的联接、复杂的相关子查询、用 PL 编写的批处理作业，以及长事务和大事务。有时对短时间运行的查询使用并行执行。</br>版本限制：适用于 OceanBase 数据库 V4.2.5 及以上版本。</li><li><b>OBKV</b>：用于键值工作负载和类似 hbase 的宽列工作负载，这些工作负载通常具有非常高的吞吐量并且对延迟敏感。</br>版本限制：适用于 OceanBase 数据库 V4.2.5 及以上版本。</li></ul> |

3. 设置集群的部署模式信息。

   默认添加 3 个 Zone 的信息，如果您希望部署的集群 Zone 的个数大于 3 个，您可以在下方单击 **+ 新增Zone** 按钮，增加 Zone 信息。如果部署的集群 Zone 的个数小于 3 个，您可以单击 Zone 后面的删除图标。

   ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.3.5/400.deploy/500.deploy-oceanbase-database-community-edition/200.deploy-by-ocp-04.png)

   每个 Zone 需要设置的信息及其说明如下表所示。

   |       **配置**     |            **描述**               |
   |--------------------|-----------------------------------|
   | **Zone 名称**      | 一般会有一个默认名称，您可以根据需要自定义名称。Zone 名称必须以英文字母开头、英文或数字结尾，可包含英文、数字和下划线，且长度为 2 ~ 32。部署多 Zone 的 OceanBase 集群必须有一个 Zone 与主 Zone 的 Region 相同。 |
   | **机房**           | Zone 所在的机房，一个 Zone 只能存在于一个机房。|
   | **机型（可选）**   | 如果选择了机型，后面主机列表会根据机型进行过滤。 |
   | **CPU 架构**   | 当选择的 **OceanBase 版本** 中存在多个不同架构的安装包时，需选择匹配此软件包的主机硬件架构。<main id="notice" type='notice'><h4>注意</h4><ul><li><p>默认架构类型为第一个安装包的架构类型，支持切换。切换指定架构后，<b>主机</b> 列表中即展示该架构的主机。</p></li><li><p>为不同的 Zone 设置不同的架构时，混合架构部署模式可能存在稳定性与性能问题，请谨慎操作。</p></li></ul></main>        |
   | **主机**           | 您可以选择多个主机，或进行添加主机的操作。           |
   | **Root Service 位置** | 您需选择一个 IP 作为 Root Service 所在的机器。多副本的 OceanBase 集群，其每个 Zone 都需指定一个 Root Service。        |
   | **Zone 优先级排序**  | 为集群 sys 租户的主副本分布指定优先级。最高优先级的 Zone 会被视为 Primary Zone，且只能有一个。如不指定，默认以第一个 Zone 为第一优先级。排序方法如下：<ol><li>勾选左侧列表框中的一个或多个 Zone。左侧列表框中显示了当前集群中所有可选的 Zone。</li><li> 单击中间的 > 按钮。此时勾选的 Zone 就会被移动到 <b>优先级排序</b> 列表中。同时勾选的多个 Zone 具有相同的优先级。</li><li>重复 1、2 动作，添加低一优先级的 Zone。</li><li>如需调整优先级，可在 <b>优先级排序</b> 列表中拖拽以调整顺序。列表中从上到下，优先级依次递减。</li></ol>   |

4. 选择是否为集群开启 Cgroup。

   Cgroup 主要用于 OceanBase 集群内租户之间以及租户内的 CPU 资源隔离。当您创建的 OceanBase 集群为 V4.0 及以上版本时，系统会默认开启 Cgroup，以实现更强的 CPU/IOPS 隔离性。开启 Cgroup 会造成大约 7% 的性能下降，若您的业务场景为单租户、小规格（<14C）以及需要更高的数据库性能时，建议您关闭 Cgroup。同时，若主机上的操作系统内核版本低于 4.1.9，集群将无法创建租户，此时系统将默认关闭 Cgroup 且不显示 Cgroup 开关。

5. 设置 CPU 超卖。

   您可打开 **CPU 超卖设置** 开关，配置 CPU 超卖额度。默认值为 120%，可通过滑动块或输入框配置超卖比例，取值范围为 101%~200%。

   系统不同的租户负载可以有控制地交错运行，配置 CPU 资源时可以进行超卖设置来提升资源利用率。如果不同业务场景的负载出现交叠，OceanBase 集群在运行过程中可能会产生负载过载等情况，会出现不同租户间进行线程竞争 CPU 的现象，进而导致实际业务场景变慢。

6. 打开 **参数设置** 模块，并配置集群参数。

   ![3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF.png)

   * 当您在 **基本设置** 中配置了负载类型时，系统将默认选择与负载类型对应的参数模板。

   * 您可通过如图 ① 处，逐个添加启动参数项并为其配置值。OceanBase 数据库参数介绍可参见 [配置项总览](../../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/200.system-configuration-items-overview-list.md)。

   * 您也可通过如图 ② 处，单击 **选择参数模板** 选择一个参数模板，系统会将模板中的参数连同配置自动填充到此处。您也可单击 **新建集群参数模板**，为集群创建参数模板，详情可参见官网《OceanBase 云平台》文档 [集群管理/管理集群参数模板](https://www.oceanbase.com/docs/common-ocp-1000000002077892)。

   OCP 系统提供如下六种内置模板，模板中包含了常用的参数设置，您可直接应用模板进行集群的初始化设置。具体说明如下：

   |           模板            |                                   说明                                   |
   | ------------------------- | ------------------------------------------------------------------------ |
   | COMPLEX_OLTP 默认参数模板 | 对应 **Complex OLTP** 负载类型，该模板仅适用于 OceanBase 数据库 V4.2.5 及以上版本。 |
   | HTAP 默认参数模板         | 对应 **HTAP** 负载类型，该模板仅适用于 OceanBase 数据库 V4.2.5 及以上版本。         |
   | KV 默认参数模板           | 对应 **OBKV** 负载类型，该模板仅适用于 OceanBase 数据库 V4.2.5 及以上版本。         |
   | EXPRESS_OLAP 默认参数模板 | 对应 **Express OLAP** 负载类型，该模板仅适用于 OceanBase 数据库 V4.2.5 及以上版本。 |
   | OLAP 默认参数模板         | 对应 **OLAP** 负载类型，该模板仅适用于 OceanBase 数据库 V4.3.0 及以上版本。         |
   | 2.2.77 默认参数模板       | OceanBase 集群 V2.2.77 版本推荐使用的参数设置，供生产环境使用。          |

7. 打开 **自定义配置**，支持您执行集群级别用户配置（如操作系统属主用户）、路径设置（如软件安装路径、数据盘路径、日志盘路径）以及端口设置（如 SQL 端口、RPC 端口）。

   * 配置操作系统所属主用户：
  
     该用户为配置安装、运行 OBServer 的操作系统用户，不支持编辑。您可通过调整 ocp.operation.default.os.user 参数的默认配置来修改此用户，该参数的修改仅在创建分布式集群、创建 OBProxy 集群 和 创建仲裁服务 时产生影响，不影响已有集群的其他配置。

   * 配置路径：

     | 配置 | 描述 |
     |---|----|
     | 软件安装路径 | <ul><li>当 <b>操作系统所属主用户</b> 为 admin 时，<b>软件安装路径</b> 默认为 <code>/home/admin/oceanbase</code>，支持自定义路径。</li><li>当 <b>操作系统所属主用户</b> 为非 admin 时，<b>软件安装路径</b>默认为 <code>/opt/oceanbase/oceanbase</code>，支持自定义路径。</li></ul>  |
     | 数据盘路径 | 默认为 /data/1，支持自定义路径。 |
     | 日志盘路径 | 默认为 /data/log1，支持自定义路径。生产环境下，OceanBase 数据库建议日志盘空间为主机内存空间的三倍以及以上；同时，为了避免出现性能问题，不建议数据目录和日志目录挂载在同一块磁盘上。<main id="notice" type='explain'><h4>说明</h4><p>从 OCP V4.3.0 BP1 开始，当创建如下版本的 OceanBase 集群时，slog 目录将置于日志盘中，不再与数据盘绑定。此时若配置 <code>log_disk_size=0</code>，会被视为 clog 独占，即默认 <code>log_disk_percentage</code> 为 90%。如果 slog 与 clog 所在磁盘的大小小于 40GiB，此时为 slog 预留的空间则不足 4GiB，可能会影响 slog 的写入。</p><ul><li>V4.2.4.0 ≤ OceanBase 数据库版本 ＜ V4.3.0.0</li><li>OceanBase 数据库版本 ≥ V4.3.1.0</li></ul>更多 slog 相关说明，请参见 <a href="../../../../700.reference/100.oceanbase-database-concepts/1200.observer-node-architecture/100.observer-installation-directory-structure.md">OBServer 节点安装目录结构</a>。</main> |

     配置完成后，单击 **测试**，校验路径是否可用。若不可用，您可根据测试结果进行排查，或将路径修改为其它可用路径。

   * 配置端口：

     |   配置   |             描述              |
     | -------- | ----------------------------- |
     | SQL 端口 | 默认为 2881，支持自定义端口。 |
     | RPC 端口 | 默认为 2882，支持自定义端口。 |

     配置完成后，单击 **测试**，校验端口是否已被占用。若被占用，您需重新配置可用端口。

     ![5](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%BE%E7%BD%AE.png)

8. 完成测试后，单击 **提交**。

9. 在弹出的 **确认提交信息** 对话框中，确认信息无误后，单击 **确定**。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p> 您可在页面右上侧单击 <b>任务中心</b> 查看该任务的执行进度。</p>
</main>

## 相关文档

集群部署完成后，需创建业务租户，详细信息请参见官网《OceanBase 云平台》文档 [租户管理/新建主租户](https://www.oceanbase.com/docs/common-ocp-1000000002077836)。
