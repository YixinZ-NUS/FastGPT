# （可选）规划磁盘

OceanBase 数据库的服务器依赖数据盘、事务日志盘和 OceanBase 数据库的安装盘。如果是个人试用场景，您可以将所有数据放到一块盘上并跳过此步骤。如果用于生产环境，建议将数据分别挂载至三块磁盘。

如果您的机器上没有三块磁盘，或者您使用的是 RAID 磁盘阵列, 您需要对磁盘或者磁盘阵列的逻辑卷进行分区。建议您采用以下方案分区：

* 数据盘

  数据盘用来存储基线数据，路径由配置参数 `data_dir` 指定。在您首次启动 OceanBase 集群时，`${data_dir}/{sstable,slog}` 将自动创建。数据盘的大小由 `datafile_disk_percentage`/`datafile_size` 参数决定，您也可在部署完成后通过 `datafile_next` 和 `datafile_maxsize` 配置项完成磁盘文件的动态扩容，详细的介绍可参见 [配置磁盘数据文件的动态扩容](../../../../700.reference/200.system-management/1000.disk-data-file-management/100.disk-data-file-dynamic-expansion.md)。

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>OceanBase 数据库当前版本支持将 <code>slog</code> 从数据（data）盘中独立出来，即 <code>slog</code> 与数据文件无需在同一个磁盘上。更多有关 OceanBase 数据库安装目录的信息，请参见 <a href="../../../../700.reference/100.oceanbase-database-concepts/1200.observer-node-architecture/100.observer-installation-directory-structure.md">OBServer 节点安装目录结构</a>。</p>
  </main>

* 事务日志盘

  事务日志盘的路径由配置参数 `clog_dir` 指定。建议您将事务日志盘的大小设置为 OceanBase 数据库内存的 3 倍到 4 倍及以上。在您首次启动 OceanBase 集群时，`${clog_dir}` 将自动创建，事务日志盘包含多个固定大小的文件，您可以根据您的需要自动创建和清除事务日志。事务日志达到磁盘总量的 80% 时，将触发自动清除。但是，只有在事务日志对应的内存数据已经合并至基线数据中时，事务日志才能被删除。

  在相同数据量的情况下，事务日志的大小约为内存数据大小的三倍。因此事务日志盘所需空间上限与两次合并后的数据总量成正比。经验公式：事务日志文件大小 = 增量数据内存上限的 3~4 倍。

* OceanBase 数据库安装盘

  OceanBase 数据库安装盘的路径由配置参数 `home_path` 指定。建议您为 OceanBase 数据库安装盘预留至少 200 G 空间以保存 7 天及以上的日志。OceanBase 数据库的 RPM 包安装目录位于 `${home_path}` 下。其中，基线数据文件和事务日志文件会通过软链接分别指向独立的数据盘和事务日志盘。OceanBase 数据库的运行日志位于 `${home_path}/log` 下。运行日志会不断增长，并且 OceanBase 数据库无法自动删除运行日志，因此您需要定时删除运行日志。

## 磁盘挂载

### 挂载要求

* OCP 服务器的磁盘挂载点要求如下表所示。

  | 挂载点 | 大小 | 用途 | 文件系统格式 |
  |--------|---------|-----|---------|
  | /home | 100 GB~300 GB | 各组件运行日志盘 | 建议 ext4 或 xfs |
  | /data/log1 | 分配给 observer 的内存大小的 3~4 倍 | OCP 元数据库日志盘 | 建议 ext4 或 xfs |
  | /data/1 | 取决于所需存储的数据大小 | OCP 元数据库数据盘 | 建议 ext4 或 xfs |

* OBServer 节点的磁盘挂载点要求如下表所示。

  | 目录 | 大小 | 用途 | 文件系统格式 |
  |-------|--------|-------|-----------|
  | /home | 100 GB~300 GB | observer 数据库安装盘 | 建议 ext4 或 xfs |
  | /data/log1 | 分配给 observer 的内存大小的 3~4 倍 | observer 进程日志盘 | 建议 ext4 或 xfs |
  | /data/1 | 取决于所需存储的数据大小 | observer 进程数据盘 | 建议 ext4 或 xfs |

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <ul>
    <li><p>建议根目录不小于 50 GB。如果使用 LVM，建议创建时使用条带化参数。示例如下：<code>lvcreate -n data -L 3000G obvg --stripes=3 --stripesize=128</code>。</p></li>
    <li><p>建议在生产环境上数据盘与日志盘以及安装盘使用不同的磁盘，避免出现性能问题。</p></li>
    </ul>
  </main>

### 挂载操作

磁盘挂载需要在 root 用户下操作，存在以下两种操作方式，您可根据实际情况选择合适的磁盘挂载操作：

* 使用 LVM 工具挂载磁盘（推荐）。
* 使用 fdisk 工具挂载磁盘。

:::tab

tab 使用 LVM 工具挂载磁盘

1. 查看磁盘信息

   使用 `fdisk -l` 命令识别可用磁盘及分区，确认目标设备（如 `/dev/sdb1`）。

   ```shell
   [root@test001 ~]# fdisk -l
   ```

2. （可选）安装 LVM 工具

   若未预装 LVM，需执行如下命令安装 LVM，如果已安装 LVM，则跳过此步骤。

   * Debian/Ubuntu 系统

     ```shell
     [root@test001 ~]# apt-get install lvm2
     ```

   * CentOS/RHEL 系统

     ```shell
     [root@test001 ~]# yum install lvm2
     ```

3. 创建物理卷（PV）

   将分区初始化为物理卷。

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>分区初始化为物理券时，会重新格式化分区（数据会丢失），需谨慎操作。</p>
   </main>

   ```shell
   [root@test001 ~]# pvcreate /dev/sdb1
   ```

   创建后可执行 `pvs` 命令验证物理卷创建结果。

4. 创建卷组（VG）

   合并多个物理卷为一个 VG。

   ```shell
   [root@test001 ~]# vgcreate vg01 /dev/sdb1 /dev/sdc1
   ```

   合并后可执行 `vgs` 命令查看卷组信息。

5. 创建逻辑卷（LV）

   从 VG 中划分 100G 的逻辑卷，此处仅为示例，逻辑卷的大小可根据实际情况设置。

   ```shell
   [root@test001 ~]# lvcreate -L 100G -n lv01 vg01
   ```

   创建后可执行 `lvs` 命令查看逻辑卷信息。

6. 格式化和挂载

   1. 格式化为 ext4 文件系统

      ```shell
      [root@test001 ~]# mkfs.ext4 /dev/vg01/lv01
      ```

   2. 创建挂载点

      ```shell
      [root@test001 ~]# mkdir -p /data/1
      ```

   3. 临时挂载

      ```shell
      [root@test001 ~]# mount /dev/vg01/lv01 /data/1
      ```

7. 设置开机自动挂载

   编辑 `/etc/fstab` 文件，添加挂载配置：

   ```shell
   [root@test001 ~]# vim /etc/fstab
   ```

   在 `/etc/fstab` 文件中添加如下内容：

   ```shell
   /dev/vg01/lv01  /data/1  ext4  defaults,noatime,nodiratime,nodelalloc,barrier=0  0  0
   ```

tab 使用 fdisk 工具挂载磁盘

1. 查看磁盘信息

   使用 `fdisk -l` 命令识别可用磁盘及分区，确认目标设备（如 `/dev/sdb1`）。

   ```shell
   [root@test001 ~]# fdisk -l
   ```

2. 创建分区

   使用 fdisk 工具创建新分区，例如 `fdisk /dev/sdb1`，输入 `n` 创建主分区，最后保存（`w`）。

   ```shell
   [root@test001 ~]# fdisk /dev/sdb1
   ```

3. 格式化和挂载

   1. 格式化为 ext4 文件系统。

      ```shell
      [root@test001 ~]# mkfs.ext4 /dev/sdb1
      ```

   2. 创建挂载点

      ```shell
      [root@test001 ~]# mkdir -p /data/1
      ```

   3. 临时挂载

      ```shell
      [root@test001 ~]# mount /dev/sdb1 /data/1
      ```

4. 设置开机自动挂载。

   编辑 `/etc/fstab` 文件，添加挂载配置：

   ```shell
   [root@test001 ~]# vim /etc/fstab
   ```

   在 `/etc/fstab` 文件中添加如下内容：

   ```shell
   /dev/sdb1  /data/1  ext4  defaults,noatime,nodiratime,nodelalloc,barrier=0  0  0
   ```

:::

## 查看磁盘

磁盘挂载后，可执行以下命令检查磁盘划分情况：

```shell
[root@test001 ~]# df -h
```

返回结果如下：

```shell
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs         31G     0   31G   0% /dev
tmpfs            31G     0   31G   0% /dev/shm
tmpfs            31G  516K   31G   1% /run
tmpfs            31G     0   31G   0% /sys/fs/cgroup
/dev/vda1       493G  171G  302G  37% /
tmpfs           6.2G     0  6.2G   0% /run/user/0
/dev/sdb1     984G    77M  934G  1%  /data/1
/dev/vdc1     196G     61M   186G  1%  /data/log1
/dev/vdb1     492G    73M   467G  1%  /home/admin/oceanbase
```

结果说明：

* `/data/1` 为数据盘，大小为 1 TB。

* `/data/log1` 存放日志。

* `/home/admin/oceanbase` 存放 OceanBase 数据库的二进制文件和运行日志。

确保配置文件中的 `data_dir`、`redo_dir` 和 `home_path` 对应的磁盘已经完成挂载。`data_dir` 和 `redo_dir` 对应目录为空，`data_dir` 对应目录的磁盘已使用率必须低于 4%。

## 设置目录权限

在磁盘挂载完成后，需要查看磁盘挂载所对应的目录的权限。您可执行如下命令查看集群相关文件目录权限。

此处以 `data` 目录为例：

```shell
[root@test001 data]# ls -al
```

返回结果如下，表示目录的所有者是 admin 组的 admin 用户：

```shell
drwxr-xr-x 2 admin admin 4096 2 月 9 18:43 .
drwxr-xr-x 2 admin admin 4096 2 月 9 18:43 log1
```

若查看目录权限后，发现 admin 用户无相关文件的权限，可执行如下命令修改文件所属用户：

```shell
[root@test001 ~]# chown -R admin:admin /data/log1
[root@test001 ~]# chown -R admin:admin /data
```

此处 `/data/log1`、`/data` 为示例挂载目录，您需根据您真实的挂载目录进行替换。
