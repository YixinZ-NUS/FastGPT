| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   | Oracle Mode     |
|machine-translation||

# Online and offline DDL operations

## Online DDL

- **Definition**: During an online DDL operation, users can continue to access the database, including reading and writing data.
- **Advantages**: Online DDL operations have minimal impact on business operations and can be performed while the system is running, making them ideal for high-availability scenarios.
- **Characteristics**: They usually support concurrent access and involve fewer locks, thereby reducing downtime.

## Offline DDL

- **Definition**: During an offline DDL operation, the related tables are locked, preventing users from accessing the corresponding data in the database.
- **Advantages**: Simple and easy to implement, suitable for scenarios with minimal impact on business operations.
- **Characteristics**: Offline DDL operations cause some downtime, affecting normal queries and transaction processing.

## Transaction correlation

- **Transaction**: A transaction is a group of operations that must either all succeed or all fail, ensuring data consistency during execution.
- Online and offline DDL operations are usually performed separately. In some database management systems, DDL operations may not be controlled by transactions (especially offline DDL).

## Transaction wait strategies

- **Online DDL**: Typically does not need to wait for the current transaction to end and can be executed concurrently.
- **Offline DDL**: Usually needs to wait for the current transaction to end since the related table is locked during execution.

The following table describes the online DDL operations supported by OceanBase Database V4.x in Oracle mode.

| Type | Operation | Time spent | Remarks | DDL support after creating mlog |
|-------------|--------------------------|--------------------------|--------------------|--------------------|
|   Index operation      |       Add an index            | Related to the data volume, because data is reorganized (or rewritten)  | This operation mainly involves global indexes, local indexes, global indexes with specified partitions, and spatial indexes (supported in OceanBase Database V4.1.0 and later). | Supported |
|   Index operation      |       Drop an index            | Related to whether active transactions exist | N/A | Supported |
|   Index operation      |       Rename an index            | Only for metadata modification | N/A | Supported |
|   Index operation      |      Hybrid index operations      | Related to the operation with the longest execution time | For example, the `ALTER TABLE t1 ADD INDEX i4(c1), DROP INDEX i2, RENAME INDEX i1 TO i1x` syntax is not supported in Oracle mode. | Not supported |
|  Column operation | Add, change, or delete the skip index type    | Only for table schema modification | N/A | Not supported |
|   Column operation    | Add a column to the end of a table  | Only for metadata modification | For example, add a LOB (TEXT) column by executing a statement such as  `ALTER TABLE tbl1 ADD c3 LOB`. | Supported <main id="notice" type='notice'> <h4>Note</h4> <p>For OceanBase Database V4.3.5, support for adding columns to the base table of materialized view logs is available starting from V4.3.5 BP1.</p> </main> |
|  Column operation | Add a virtual column | Only for metadata modification | N/A | Not supported |
|  Column operation | Drop a column <main id="notice" type='explain'><h4>Note</h4><p>For OceanBase Database V4.3.5, the <code>DROP COLUMN</code> operation as an Online DDL feature was introduced starting from V4.3.5 BP1. </p></main>| Only for metadata modification | N/A | Not supported |
|  Column operation | Set a `NOT NULL` constraint on a column | Related to the data volume, because data is queried | N/A | Not supported |
|  Column operation | Set a `NULL` constraint on a column | Only for metadata modification | N/A | Not supported |
|  Column operation | Set a default value for a column | Only for metadata modification | N/A | Not supported |
|  Column operation | Drop the default value of a column | Only for metadata modification | N/A | Not supported |
|  Column operation | Change the value of an auto-increment column | Only for metadata modification | N/A | Not supported |
|  Column operation | Rename a column | Only for metadata modification | N/A | Not supported |
|  Column operation | Increase the length or precision of the data type for a column  | Only for metadata modification | For example, increase the length of the `INT` type, increase the length of the `VARCHAR` type, or convert the `NUMBER` type. | Not supported |
|  Column operation | Hybrid column operations   | Related to the operation with the longest execution time | All single-column operations and most hybrid column operations are online DDL operations. For information about how to determine whether a DDL operation is an online operation, see the **Determine whether a DDL operation is an online operation** section in this topic. | Not supported |
|  FOREIGN KEY constraint operation |  Add a FOREIGN KEY, CHECK, or NOT NULL constraint | Related to the data volume, because data is queried | N/A | You can add a FOREIGN KEY or CHECK constraint, but not a NOT NULL constraint. |
|  FOREIGN KEY constraint operation |  Drop a FOREIGN KEY, CHECK, or NOT NULL constraint | Related to the data volume, because data is queried | N/A | You can drop a FOREIGN KEY constraint but not a CHECK or NOT NULL constraint. |
|  Table operation | Rename a table | Only for metadata modification | N/A | Not supported |
|  Table operation | Change the row format | Only for metadata modification | N/A | Not supported |
|  Table operation | Change the block size | Only for metadata modification | N/A | Not supported |
|  Table operation | Change the compression algorithm | Only for metadata modification | N/A | Not supported |
|  Table operation | Optimize a tablespace | Only for metadata modification | N/A | Not supported |
|  Tables | Convert row-based storage to columnar storage <main id="notice" type='notice'><h4>Notice</h4><p>Specify the <code>DELAYED</code> option when you execute the <code>ALTER TABLE</code> statement to perform Online DDL. </p></main>| Only the table schema is modified |N/A| Not supported |
|  Tables | Convert row-based storage to hybrid row-column storage <main id="notice" type='notice'><h4>Notice</h4><p>Specify the <code>DELAYED</code> option when you execute the <code>ALTER TABLE</code> statement to perform Online DDL. </p></main>| Only the table schema is modified |N/A| Not supported |
|  Partition operation | Add a partition | Only for metadata modification | N/A | Not supported |
|  Partitions | Modify only the auto-partitioning attribute | Only metadata is modified  |  For example: <ul><li>`ALTER TABLE t1 PARTITION BY RANGE() SIZE('xxx');`</li><li>`ALTER TABLE t1 PARTITION BY RANGE();`</li><li>`ALTET TABLE t1 PARTITION BY RANGE() SIZE('ulimited');`</li><li>`ALTER TABLE t1 PARTITION BY RANGE (xxx) SIZE('xxx');`</li></ul>| Not supported |

The following table describes the offline DDL operations supported by OceanBase Database V4.x in Oracle mode.

|     Type     |       Operation                |         Time spent       |      Remarks     | DDL support after mlog creation|
|-------------|--------------------------|--------------------------|--------------------|--------------------|
|  Column operation | Add an auto-increment column | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
|  Column operation | Set a column as the primary key | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
|  Column operation | Add or drop a `STORED` generated column | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
|  Column operation | Drop a column | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
| Column operation | Hybrid column operations  | If an offline column operation is involved, the operation is upgraded to an offline DDL operation. | N/A | Not supported |
| Column operation | Clean up obsolete columns | Related to data size, requires data reorganization  |N/A| Not supported |
|  Columns | Drop a `VIRTUAL` column | Related to data size, requires data reorganization  |N/A| Not supported |
|  Primary key operation | Add or drop a primary key | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
| Table operation   | Truncate a table | Related to whether active transactions exist | N/A | Not supported |
| Table operation   | Drop a table | Related to whether active transactions exist | N/A | Not supported |
| Table operation | Convert a rowstore table into a columnstore table <main id="notice" type='notice'><h4>Notice</h4><p>Do not specify the <code>DELAYED</code> option when you execute the <code>ALTER TABLE</code> statement to perform Offline DDL. </p></main> | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
| Table operation | Convert a rowstore table into a hybrid rowstore-columnstore table <main id="notice" type='notice'><h4>Notice</h4><p>Do not specify the <code>DELAYED</code> option when you execute the <code>ALTER TABLE</code> statement to perform Offline DDL. </p></main> | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
| Table operation | Convert a columnstore table into a rowstore table | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
| Table operation | Convert a columnstore table into a hybrid rowstore-columnstore table | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
| Table operation | Convert a hybrid rowstore-columnstore table into a columnstore table | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
| Table operation | Convert a hybrid rowstore-columnstore table into a rowstore table | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
| Partition operation | Modify partitioning rules | Related to the data volume, because data is reorganized (or rewritten) | N/A | Not supported |
| Partition operation | Drop a partition | Related to whether active transactions exist | A partition-level table lock is added to the partition. | Not supported |
| Partition operation | Truncate a partition | Related to whether active transactions exist | A partition-level table lock is added to the partition. | Not supported |
| Partition operation | Exchange a partition | Related to whether active transactions exist | A partition-level table lock is added to the partition. | Not supported |
|  Partitions | Manual partition split              | Data volume-related, requires data reorganization |  N/A  | Not supported |
|  Partitions | Modify the auto-partitioning attribute and partitioning rule | Data volume-related |  For example: `ALTER TABLE t1 PARTITION BY RANGE(xxx) SIZE('xxx') (PARTITION...);`| Not supported |

## Determine whether a DDL operation is an online operation

In OceanBase Database, the online/offline attribute of a DDL operation has significant impact on business. This section describes how to determine whether a DDL operation is an online operation. For some DDL operations, such as changing the type of a column or a hybrid DDL operation, we recommend that you first determine whether the operation is an online DDL operation.

### Method for determining whether a DDL operation is an online operation

It is impossible to list all online and offline operations. Before you perform a hybrid DDL operation, we recommend that you first determine whether the hybrid DDL operation is an online operation.

**Technical mechanism of offline DDL operations**:

In OceanBase Database, offline DDL operations use the "table rebuild" method. Specifically, an offline DDL operation creates a temporary hidden table (invisible to users) and migrates the data of the original table to the new table. After the data migration is completed, the temporary table is renamed to the name of the original table, and the old table is deleted. Therefore, the `table_id` changes after an offline DDL operation. You must not perform DML operations during the DDL operation.

You can use this principle to determine whether a DDL operation is online DDL.

**Method**:

Execute the following SQL statement before and after a DDL operation is performed. If the table ID does not change, the DDL operation is an online operation. If the table ID changes, the DDL operation is an offline operation.

```sql
select distinct(table_id) from DBA_OB_TABLE_LOCATIONS where table_name='xxx';
```

**Procedure**:

Perform the following steps to determine whether a DDL operation is an online operation:

1. Create an empty table for verification.

    ```sql
    CREATE TABLE t10(a INT, b INT);
    ```

2. Query the current table ID.

    ```sql
    SELECT distinct(table_id)
    FROM DBA_OB_TABLE_LOCATIONS
    WHERE table_name='t10';
    ```

3. Perform a DDL operation.

    ```sql
    ALTER TABLE t10 ADD c INT, ADD CONSTRAINT c_idx UNIQUE(c);
    ```

4. Query the table ID again.

    ```sql
    SELECT distinct(table_id)
    FROM DBA_OB_TABLE_LOCATIONS
    WHERE table_name='t10';
    ```

5. If the table IDs returned in Step 2 and Step 4 are the same, the DDL operation is an online operation. If they are different, the DDL operation is an offline operation.

<main id="notice" type='explain'>
  <h4>Note</h4>
  <p>You cannot use this method to determine whether a table or partition operation is an online DDL operation. </p>
</main>