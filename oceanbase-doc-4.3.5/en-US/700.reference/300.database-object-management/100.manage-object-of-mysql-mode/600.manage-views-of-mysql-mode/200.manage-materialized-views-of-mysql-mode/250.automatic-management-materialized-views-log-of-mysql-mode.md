|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|

# Automatic management of materialized view logs

For OceanBase Database V4.3.5, automatic management of materialized view logs (mlogs) is supported starting with V4.3.5 BP4.

Automatic management of mlogs includes two main aspects:

1. When a materialized view is created, the system analyzes its dependencies on base tables and automatically creates the required mlogs.
2. The system periodically trims mlogs in the background, deletes mlogs that are no longer needed, and optimizes the column sets in mlogs to reduce maintenance overhead.

## Limitations

Mlogs are automatically created or updated only when a materialized view is explicitly declared as a materialized view with incremental refresh (by specifying `REFRESH FAST`) or a real-time materialized view (by specifying `ENABLE ON QUERY COMPUTATION`).

## Considerations

* When updating an mlog definition, OceanBase Database creates a new mlog table and replaces the original one. During this process, an incremental refresh is performed on all associated incremental refresh materialized views to flush incremental data from the original mlog into the materialized views, ensuring safe replacement. If a base table is associated with many materialized views and contains substantial incremental data, updating the mlog definition may be time-consuming. Please be aware of this potential impact in advance.

* It is recommended not to set the `mlog_trim_interval` too short, as this may cause mlogs to be mistakenly trimmed. If this occurs, you may need to recreate or update the mlog when creating a materialized view.

## Related configuration

OceanBase Database provides two parameters to control mlog automatic management:

* [enable_mlog_auto_maintenance](../../../../800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/2670.enable_mlog_auto_maintenance.md): Controls whether automatic management of materialized view logs is enabled.
* [mlog_trim_interval](../../../../800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/5650.mlog_trim_interval.md): Specifies the interval for scheduling automatic mlog trimming tasks.

## Example

Enable the mlog auto management feature.

<main id="notice" type='explain'>
  <h4>Note</h4>
  <p>In OceanBase Database V4.3.5 BP4: <ul><li>For a new tenant, the default value of the <code>enable_mlog_auto_maintenance</code> parameter is <code>True</code>, which means the mlog auto management feature is enabled by default.</li><li>For a tenant upgraded from a version earlier than V4.3.5 BP4, the default value of the <code>enable_mlog_auto_maintenance</code> parameter is <code>False</code>, which means the mlog auto management feature is disabled by default.</li></ul></p>
</main>

```shell
obclient> ALTER SYSTEM SET enable_mlog_auto_maintenance = True;
```

### Example 1: Automatically create an mlog

1. Create a table named `test_tbl1`.

    ```shell
    obclient> CREATE TABLE test_tbl1(col1 INT, col2 INT, col3 INT);
    ```

2. Create a materialized view with incremental refresh named `mv_test_tbl1` on the `test_tbl1` table. OceanBase Database automatically creates an mlog for the `col2` column of the `test_tbl1` table.

    ```shell
    obclient> CREATE MATERIALIZED VIEW mv_test_tbl1
        REFRESH FAST
        AS SELECT
               col2,
               count(*) cnt
           FROM test_tbl1
           GROUP BY col2;
    ```

3. View the information about the materialized view logs on the `test_tbl1` table.

    ```shell
    obclient> DESC mlog$_test_tbl1;
    ```

    The return result is as follows:

    ```shell
    +------------+-----------------+------+------+---------+-------+
    | Field      | Type            | Null | Key  | Default | Extra |
    +------------+-----------------+------+------+---------+-------+
    | col2       | int(11)         | YES  |      | NULL    |       |
    | SEQUENCE$$ | bigint(20)      | NO   | PRI  | NULL    |       |
    | DMLTYPE$$  | varchar(1)      | YES  |      | NULL    |       |
    | OLD_NEW$$  | varchar(1)      | YES  |      | NULL    |       |
    | M_ROW$$    | bigint unsigned | NO   | PRI  | NULL    |       |
    +------------+-----------------+------+------+---------+-------+
    5 rows in set
    ```

### Example 2: Automatically update the mlog definition

1. Create a table named `test_tbl2`.

    ```shell
    obclient> CREATE TABLE test_tbl2(col1 INT, col2 INT, col3 INT);
    ```

2. Create a materialized view with incremental refresh named `mv1_test_tbl2` on the `test_tbl2` table. OceanBase Database automatically creates an mlog for the `col2` column on the `test_tbl2` table.

    ```shell
    obclient> CREATE MATERIALIZED VIEW mv1_test_tbl2
        REFRESH FAST
        AS SELECT
               col2,
               count(*) cnt
           FROM test_tbl2
           GROUP BY col2;
    ```

3. View the information about the materialized view log on the `test_tbl2` table.

    ```shell
    obclient> DESC mlog$_test_tbl2;
    ```

    The return result is as follows:

    ```shell
    +------------+-----------------+------+------+---------+-------+
    | Field      | Type            | Null | Key  | Default | Extra |
    +------------+-----------------+------+------+---------+-------+
    | col2       | int(11)         | YES  |      | NULL    |       |
    | SEQUENCE$$ | bigint(20)      | NO   | PRI  | NULL    |       |
    | DMLTYPE$$  | varchar(1)      | YES  |      | NULL    |       |
    | OLD_NEW$$  | varchar(1)      | YES  |      | NULL    |       |
    | M_ROW$$    | bigint unsigned | NO   | PRI  | NULL    |       |
    +------------+-----------------+------+------+---------+-------+
    5 rows in set
    ```

4. Create a materialized view with incremental refresh named `mv2_test_tbl2` on the `test_tbl2` table. OceanBase Database detects that the current mlog table contains only the `col2` column and modifies the existing mlog definition to add the `col3` column to the mlog table.

    ```shell
    obclient> CREATE MATERIALIZED VIEW mv2_test_tbl2
        REFRESH FAST
        AS SELECT
               col3,
               count(*) cnt
           FROM test_tbl2
           GROUP BY col3;
    ```

5. View the information about the materialized view log on the `test_tbl2` table again. You can observe that the mlog table definition for the `test_tbl2` table contains the `col2` and `col3` columns.

    ```shell
    obclient> DESC mlog$_test_tbl2;
    ```

    The return result is as follows:

    ```shell
    +------------+-----------------+------+------+---------+-------+
    | Field      | Type            | Null | Key  | Default | Extra |
    +------------+-----------------+------+------+---------+-------+
    | col2       | int(11)         | YES  |      | NULL    |       |
    | col3       | int(11)         | YES  |      | NULL    |       |
    | SEQUENCE$$ | bigint(20)      | NO   | PRI  | NULL    |       |
    | DMLTYPE$$  | varchar(1)      | YES  |      | NULL    |       |
    | OLD_NEW$$  | varchar(1)      | YES  |      | NULL    |       |
    | M_ROW$$    | bigint unsigned | NO   | PRI  | NULL    |       |
    +------------+-----------------+------+------+---------+-------+
    6 rows in set
    ```

### Example 3: Automatic mlog pruning

1. Create a table named `test_tbl3`.

    ```shell
    obclient> CREATE TABLE test_tbl3(col1 INT, col2 INT, col3 INT);
    ```

2. Create a materialized view with incremental refresh named `mv1_test_tbl3` on the `test_tbl3` table. OceanBase Database automatically creates an mlog for the `col2` column on the `test_tbl3` table.

    ```shell
    obclient> CREATE MATERIALIZED VIEW mv1_test_tbl3
        REFRESH FAST
        AS SELECT
               col2,
               count(*) cnt
           FROM test_tbl3
           GROUP BY col2;
    ```

3. Create a materialized view with incremental refresh named `mv2_test_tbl3` on the `test_tbl3` table. OceanBase Database detects that the current mlog table contains only the `col2` column and modifies the existing mlog definition by adding the `col3` column to the mlog table.

    ```shell
    obclient> CREATE MATERIALIZED VIEW mv2_test_tbl3
        REFRESH FAST
        AS SELECT
            col3,
            count(*) cnt
        FROM test_tbl3
        GROUP BY col3;
    ```

4. View the information about the materialized view logs on the `test_tbl3` table. You can observe that the mlog table definition for the `test_tbl3` table contains the `col2` and `col3` columns.

    ```shell
    obclient> DESC mlog$_test_tbl3;
    ```

    The return result is as follows:

    ```shell
    +------------+-----------------+------+------+---------+-------+
    | Field      | Type            | Null | Key  | Default | Extra |
    +------------+-----------------+------+------+---------+-------+
    | col2       | int(11)         | YES  |      | NULL    |       |
    | col3       | int(11)         | YES  |      | NULL    |       |
    | SEQUENCE$$ | bigint(20)      | NO   | PRI  | NULL    |       |
    | DMLTYPE$$  | varchar(1)      | YES  |      | NULL    |       |
    | OLD_NEW$$  | varchar(1)      | YES  |      | NULL    |       |
    | M_ROW$$    | bigint unsigned | NO   | PRI  | NULL    |       |
    +------------+-----------------+------+------+---------+-------+
    6 rows in set
    ```

5. Change the mlog pruning interval to observe the pruning result faster.

    ```shell
    obclient> ALTER SYSTEM SET mlog_trim_interval = '5s';
    ```

6. Drop the materialized view `mv1_test_tbl3`.

    ```shell
    obclient> DROP MATERIALIZED VIEW mv1_test_tbl3;
    ```

7. After 5 seconds, check the information about the materialized view logs on the `test_tbl3` table. You can observe that the mlog table definition for the `test_tbl3` table contains only the `col3` column.

    ```shell
    obclient> DESC mlog$_test_tbl3;
    ```

    The return result is as follows:

    ```shell
    +------------+-----------------+------+------+---------+-------+
    | Field      | Type            | Null | Key  | Default | Extra |
    +------------+-----------------+------+------+---------+-------+
    | col3       | int(11)         | YES  |      | NULL    |       |
    | SEQUENCE$$ | bigint(20)      | NO   | PRI  | NULL    |       |
    | DMLTYPE$$  | varchar(1)      | YES  |      | NULL    |       |
    | OLD_NEW$$  | varchar(1)      | YES  |      | NULL    |       |
    | M_ROW$$    | bigint unsigned | NO   | PRI  | NULL    |       |
    +------------+-----------------+------+------+---------+-------+
    5 rows in set
    ```

8. Drop the materialized view `mv2_test_tbl3`.

    ```shell
    obclient> DROP MATERIALIZED VIEW mv2_test_tbl3;
    ```

9. After 5 seconds, check the information about the materialized view logs on the `test_tbl3` table. You can observe that the mlog table for the `test_tbl3` table no longer exists.

    ```shell
    obclient> DESC mlog$_test_tbl3;
    ```

    The return result is as follows:

    ```shell
    ERROR 1146 (42S02): Table 'test_db.mlog$_test_tbl3' doesn't exist
    ```

10. Restore the mlog pruning interval.

    ```shell
    obclient> ALTER SYSTEM SET mlog_trim_interval = '1d';
    ```

## References

* [Overview of materialized views](100.materialized-views-overview-of-mysql-mode.md)
* [Materialized view logs](200.materialized-views-log-of-mysql-mode.md)
* [Create a materialized view](300.create-materialized-views-of-mysql-mode.md)
* [Drop a materialized view](700.delete-materialized-views-of-mysql-mode.md)
