|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# Generate an ASH report

You can call the Active Session History (ASH) PL package to generate an ASH report.

## SQL syntax

The ASH PL package consists of the following parameters:

:::tab
tab MySQL mode

```sql
obclient [oceanbase]> call dbms_workload_repository.ash_report(
  'BTIME', 
  'ETIME', 
  'SQL_ID', 
  'TRACE_ID', 
  'WAIT_CLASS',
  'REPORT_TYPE',
  'SVR_IP',
  'SVR_PORT',
  'TENANT_ID');
```

tab Oracle mode

```sql
obclient [SYS]> call dbms_workload_repository.ash_report(     
  BTIME => 'xxxx', 
  ETIME => 'xxxx',  
  SQL_ID => 'xxxx',
  TRACE_ID => 'xxxx', 
  WAIT_CLASS => 'xxxx',
  REPORT_TYPE => 'xxxx',
  SVR_IP => 'xxxx',
  SVR_PORT=> 'xxxx',
  TENANT_ID => 'xxxx');
```

:::

The parameters are described as follows:

| **Parameter** | **Description** |
| -------- | -------- |
| BTIME       | The start time of sampling. Required. |
| ETIME       | The end time of sampling. Required. |
| SQL_ID      | The `SQL_ID` of the SQL statement to sample. If this parameter is not specified or set to `NULL`, no restriction is applied to the `SQL_ID`. |
| TRACE_ID    | The `TRACE_ID` of the SQL statement to sample. If this parameter is not specified or set to `NULL`, no restriction is applied to the `TRACE_ID`. |
| WAIT_CLASS  | The event type to sample. Valid values are the same as those of the `WAIT_CLASS` field in the `GV$OB_ACTIVE_SESSION_HISTORY` view. If this parameter is not specified or set to `NULL`, no restriction is applied to the wait type. |
| REPORT_TYPE | The report type. Valid values include `HTML` and `TEXT`. If this parameter is not specified or set to `NULL`, the default value is `TEXT`. |
| SVR_IP      | The IP address of the node to generate the ASH report. If this parameter is not specified or set to `NULL`, no restriction is applied to the `SVR_IP`. |
| SVR_PORT    | The port of the node to generate the ASH report. If this parameter is not specified or set to `NULL`, no restriction is applied to the `SVR_PORT`.|
| TENANT_ID   | The ID of the tenant to generate the ASH report. If this parameter is not specified or set to `NULL`, no restriction is applied to the `TENANT_ID`. |

<main id="notice" type='notice'>
  <h4>Notice</h4>
  <ul>
  <li>If you do not specify the SVR_IP, SVR_PORT, or TENANT_ID parameter, the following information will be collected:<ul><li>In the sys tenant, information about all IP addresses, ports, and tenants will be collected. </li><li>In a user tenant, information about all IP addresses and ports in the tenant will be collected. </li></ul></li>
  <li>In MySQL mode, if you explicitly specify a value for a non-required parameter, you must explicitly set the other non-required parameters to `NULL`. Otherwise, the parameters will be ignored. </li></ul>
</main>

You can query the `GV$OB_ACTIVE_SESSION_HISTORY` view to obtain information about the ASH PL package. The `GV$OB_ACTIVE_SESSION_HISTORY` view provides session activity information. Any session that is connected to the database and waiting in the queue is considered an active session. Each session is sampled by a set of rows returned by the `GV$OB_ACTIVE_SESSION_HISTORY` view, and each active session is displayed in the view during the sampling period. For more information about this view, see [GV$OB_ACTIVE_SESSION_HISTORY (MySQL mode)](../../../700.system-views/400.system-view-of-mysql-mode/300.performance-view-of-mysql-mode/400.gv-ob_active_session_history-of-mysql-mode.md) and [GV$OB_ACTIVE_SESSION_HISTORY (Oracle mode)](../../../700.system-views/500.system-view-of-oracle-mode/300.performance-view-of-oracle-mode/600.gv-ob_active_session_history-of-oracle-mode.md).

## Procedure

To generate an ASH report, perform the following steps.

:::tab
tab MySQL mode

1. Log in to a MySQL tenant of the cluster as a tenant administrator and enter OceanBase Database.

    ```shell
    $ obclient -h172.xx.xxx.xxx -Pxxxx -uroot@mysql -pxxxx -A
    ```

2. Display the report information on the console.

    Call the ASH PL package and specify the start and end times of the diagnostic period and the format for displaying the report.

    <main id="notice" type='explain'>
      <h4>Note</h4>
      <p>We recommend that you set the format to TEXT when you view the report on the console. </p>
    </main>

    * Display the report content on the console in TEXT format.

      Set the diagnostic start time to `2024-02-22 19:26:47`, the diagnostic end time to `2024-06-22 19:27:07`, and the report display format to `TEXT`. Set other parameters as needed.

      ```shell
      obclient [test]> CALL DBMS_WORKLOAD_REPOSITORY.ASH_REPORT(  '2023-09-22 10:26:47',  '2024-06-22 20:27:07', NULL, NULL, NULL, 'TEXT', NULL, NULL, NULL);
      ```

      Here is a portion of the generated report:

      ```shell
        ASH Report

                Cluster Name: test424
            Observer Version: OceanBase 4.2.4.0 (200000342024061210-c4c0c18741e45a1d40889b6147c3132574xxxxxx)
        Operation System Info: Linux(3.10.0-327.ali2019.alios7.x86_64)_x86_64
        User Input Begin Time: 2023-09-22 10:26:47
            User Input End Time: 2024-06-22 20:27:07
            Analysis Begin Time: 2024-06-13 18:24:34
            Analysis End Time: 2024-06-14 16:42:55
                Elapsed Time: 80300
                Num of Sample: 16433
        Average Active Sessions: 0.20

        Top Active Tenants:
        - this section lists top active tenant information
        - Total Count: num of records during ash report analysis time period
        - Wait Event Count: num of records when session is on wait event
        - On CPU Count: num of records when session is on cpu
        - Avg Active Sessions: average active sessions during ash report analysis time period
        - % Activity: activity(cpu + wait) percentage for given tenant
        +---------+------------+------------------+-----------------------+-------------------+--------------------+-----------+
        |Tenant ID|Session Type|       Total Count|       Wait Event Count|       On CPU Count| Avg Active Sessions| % Activity|
        +---------+------------+------------------+-----------------------+-------------------+--------------------+-----------+
        |     1002|  BACKGROUND|             16401|                   1951|              14450|                0.20|     99.81%|
        |     1002|  FOREGROUND|                32|                     22|                 10|                0.00|      0.20%|
        +---------+------------+------------------+-----------------------+-------------------+--------------------+-----------+
      ```

    * Display the report content on the console in HTML format.

      Set the diagnostic start time to `2024-02-22 19:26:47`, the diagnostic end time to `2024-06-22 19:27:07`, and the report display format to `HTML`. Set other parameters as needed.

      ```shell
      obclient [test]>CALL DBMS_WORKLOAD_REPOSITORY.ASH_REPORT(  '2023-09-22 10:26:47',  '2024-06-22 20:27:07', NULL, NULL, NULL, 'HTML', NULL, NULL, NULL);
      ```

      Here is a portion of the generated report:

      ```shell
            Observer Version: OceanBase 4.2.4.0 (200000342024061210-c4c0c18741e45a1d40889b6147c3132574xxxxxx)
        Operation System Info: Linux(3.10.0-327.ali2019.alios7.x86_64)_x86_64
        User Input Begin Time: 2024-02-22 19:26:47
            User Input End Time: 2024-06-22 19:27:07
            Analysis Begin Time: 2024-06-13 18:24:34
            Analysis End Time: 2024-06-14 17:04:21
                Elapsed Time: 81586
                Num of Sample: 16814
        Average Active Sessions: 0.21
        </pre><ul id=110></ul><a class="ash_html" name='Top Active Tenants'></a>          <h2 class="ash_html">Top Active Tenants<br></h2><ul><li class='ash_html'>this section lists top active tenant information</li>
        <li class='ash_html'>Total Count: num of records during ash report analysis time period</li>
        <li class='ash_html'>Wait Event Count: num of records when session is on wait event</li>
        <li class='ash_html'>On CPU Count: num of records when session is on cpu</li>
        <li class='ash_html'>Avg Active Sessions: average active sessions during ash report analysis time period</li>
        <li class='ash_html'>% Activity: activity(cpu + wait) percentage for given tenant</li>
      ```

3. (Optional) View the report information on the local machine.

   You can view the report information in TXT file or HTML page format. Here, we use the HTML page format as an example.

    1. Log in to the physical server.

        ```shell
        [admin@xxxxxx.eu95sqa /home/admin]
        ```

    2. Create an ASH report script file named `ash_report.html` on the OBServer node.

        ```shell
        [admin@xxxxxx.eu95sqa /home/admin]
        $vim ash_report_my.html
        ```

    3. Generate the script content.

        ```shell
        tee ash_report_my.html
        CALL DBMS_WORKLOAD_REPOSITORY.ASH_REPORT(  '2023-09-22 10:26:47',  '2024-06-22 20:27:07', NULL, NULL, NULL, 'HTML', NULL, NULL, NULL);
        notee
        ```

    4. Log in to the database and run the `ash_report_my.html` script.

        ```shell
        $ obclient -h172.xx.xxx.xxx -Pxxxx -uroot@mysql -pxxxx -A
        ```

        ```shell
        obclient [test]> source ash_report_my.html;
        ```

        After the script is successfully executed, the HTML report content will be displayed on the console.

    5. Exit the database and go to the physical server to find the `ash_report_my.html` file.

        ```shell
        [admin@k08j13249.eu95sqa /home/admin]
        $ls
        ALTER                              ash_report_my.html
        ```

        The path of the `ash_report_my.html` file is found to be `home/admin/ash_report_my.html`.

    6. Export the file from the physical server to the local machine.

       1. Open a new shell window and go to the directory where you want to save the file.

          ```shell
          PS C:\Users\xxx\Desktop\ASH>
          ```

       2. Use the `scp` command to import the `ash_report_my.html` file from the physical server to the local machine.

          ```shell
          scp admin@xx.xx.xx.xx:/home/admin/ash_report_my.html  /
          ```

       3. Open the `ash_report_my.html` file in the local directory to view the report information.

tab Oracle mode

1. Log in to an Oracle tenant of the cluster as the `SYS` user and enter OceanBase Database.

    ```shell
    $ obclient -h172.xx.xxx.xxx -Pxxxx -usys@oracle -pxxxx -A
    ```

2. Execute the `SET SERVEROUTPUT ON` statement to enable the console to display the output content.

    ```shell
    obclient [SYS]> SET SERVEROUTPUT ON;
    ```

3. Display the report information on the console.

    Call the ASH PL package and specify the start and end times of the diagnostic period and the format for displaying the report.

    <main id="notice" type='explain'>
      <h4>Note</h4>
      <p>We recommend that you set the format to TEXT when you view the report on the console. </p>
    </main>

    * Display the report content on the console in TEXT format.

      Set the diagnostic start time to `2024-02-22 19:26:47`, the diagnostic end time to `2024-06-22 19:27:07`, and the report display format to `TEXT`. Set other parameters as needed.

      ```shell
      obclient [SYS]>CALL DBMS_WORKLOAD_REPOSITORY.ASH_REPORT(TO_DATE('2024-02-22 19:26:47', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-06-22 19:27:07', 'YYYY-MM-DD HH24:MI:SS'), REPORT_TYPE=> 'TEXT');
      ```

      Here is a portion of the generated report:

      ```shell
              ASH Report
                  Cluster Name: test424
              Observer Version: OceanBase 4.2.4.0 (200000342024061210-c4c0c18741e45a1d40889b6147c313257xxxxxxxxx)
          Operation System Info: Linux(3.10.0-327.ali2019.alios7.x86_64)_x86_64
          User Input Begin Time: 2024-02-2219:26:47
            User Input End Time: 2024-06-2219:27:07
            Analysis Begin Time: 2024-06-1318:26:41
              Analysis End Time: 2024-06-1414:51:12
                  Elapsed Time: 73471
                  Num of Sample: 14750
        Average Active Sessions: 0.20
        Top Active Tenants:
          - this section lists top active tenant information
          - Total Count: num of records during ash report analysis time period
          - Wait Event Count: num of records when session is on wait event
          - On CPU Count: num of records when session is on cpu
          - Avg Active Sessions: average active sessions during ash report analysis time period
          - % Activity: activity(cpu + wait) percentage for given tenant
        +---------+------------+------------------+-----------------------+-------------------+--------------------+-----------+
        |Tenant ID|Session Type|       Total Count|       Wait Event Count|       On CPU Count| Avg Active Sessions| % Activity|
        +---------+------------+------------------+-----------------------+-------------------+--------------------+-----------+
        |     1004|  BACKGROUND|             14725|                   1670|              13055|                0.20|     99.83%|
        |     1004|  FOREGROUND|                25|                     11|                 14|                0.00|      0.17%|
        +---------+------------+------------------+-----------------------+-------------------+--------------------+-----------+
      ```

    * Display the report content on the console in HTML format.

      Set the diagnostic start time to `2024-02-22 19:26:47`, the diagnostic end time to `2024-06-22 19:27:07`, and the report display format to `HTML`. Set other parameters as needed.

      ```shell
      obclient [SYS]>CALL DBMS_WORKLOAD_REPOSITORY.ASH_REPORT(TO_DATE('2024-02-22 19:26:47', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-06-22 19:27:07', 'YYYY-MM-DD HH24:MI:SS'), REPORT_TYPE=> 'HTML');
      ```

      Here is a portion of the generated report:

      ```shell
              Observer Version: OceanBase 4.2.4.0 (200000342024061210-c4c0c18741e45a1d40889b6147c313257xxxxxxxxx)
          Operation System Info: Linux(3.10.0-327.ali2019.alios7.x86_64)_x86_64
          User Input Begin Time: 2024-02-2219:26:47
            User Input End Time: 2024-06-2219:27:07
            Analysis Begin Time: 2024-06-1318:26:41
              Analysis End Time: 2024-06-1414:54:29
                  Elapsed Time: 73668
                  Num of Sample: 14806
        Average Active Sessions: 0.20
        </pre><ul id=110></ul><a class="ash_html" name='Top Active Tenants'></a>          <h2 class="ash_html">Top Active Tenants<br></h2><ul><li class='ash_html'>this section lists top active tenant information</li>
        <li class='ash_html'>Total Count: num of records during ash report analysis time period</li>
        <li class='ash_html'>Wait Event Count: num of records when session is on wait event</li>
        <li class='ash_html'>On CPU Count: num of records when session is on cpu</li>
        <li class='ash_html'>Avg Active Sessions: average active sessions during ash report analysis time period</li>
        <li class='ash_html'>% Activity: activity(cpu + wait) percentage for given tenant</li>
      ```

4. (Optional) View the report information on the local machine.

   You can view the report information in TXT file or HTML page format. Here, we use the HTML page format as an example.

    1. Log in to the physical server.

        ```shell
        [admin@xxxxxx.eu95sqa /home/admin]
        ```

    2. Create an ASH report script file named `ash_report.html` on the OBServer node.

        ```shell
        [admin@xxxxxx.eu95sqa /home/admin]
        $vim ash_report.html
        ```

    3. Generate the script content.

        ```shell
        set serveroutput on;
        tee ash_report.html
        CALL DBMS_WORKLOAD_REPOSITORY.ASH_REPORT(        TO_DATE('2024-02-22 19:26:47', 'YYYY-MM-DD HH24:MI:SS'),        TO_DATE('2024-06-22 19:27:07', 'YYYY-MM-DD HH24:MI:SS'), REPORT_TYPE=> 'HTML'   );
        notee
        ```

    4. Log in to the database and run the `ash_report.html` script.

        ```shell
        $ obclient -h172.xx.xxx.xxx -Pxxxx -usys@oracle -pxxxx -A
        ```

        ```shell
        obclient [SYS]> source ash_report.html;
        ```

        After the script is successfully executed, the HTML report content will be displayed on the console.

    5. Exit the database and go to the physical server to find the `ash_report.html` file.

        ```shell
        [admin@k08j13249.eu95sqa /home/admin]
        $ls
        ALTER                              ash_report.html
        ```

        The path of the `ash_report.html` file is found to be `home/admin/ash_report.html`.

    6. Export the file from the physical server to the local machine.

       1. Open a new shell window and go to the directory where you want to save the file.

          ```shell
          PS C:\Users\xxx\Desktop\ASH>
          ```

       2. Use the `scp` command to import the `ash_report.html` file from the physical server to the local machine.

          ```shell
          scp admin@xx.xx.xx.xx:/home/admin/ash_report.html  /
          ```

       3. Open the `ash_report.html` file in the local directory to view the report information.

:::

## References

* [Overview of ASH](../500.ash-report-diagnosis/100.ash-introduction.md).
* [Analyze an ASH report](../500.ash-report-diagnosis/300.analyze-ash-report.md).