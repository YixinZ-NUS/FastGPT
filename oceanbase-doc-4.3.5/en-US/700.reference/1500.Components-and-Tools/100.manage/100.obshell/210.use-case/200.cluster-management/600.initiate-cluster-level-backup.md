# Initiate a cluster-level backup

You can initiate a cluster-level (all tenants) backup of OceanBase Database in obshell in two ways:

- Call an API

- Use an obshell command

This topic describes how to initiate a cluster-level backup in obshell for an OceanBase cluster with three replicas.

## Prerequisites

- The OceanBase cluster has been managed by obshell. For more information about how to determine whether the OceanBase cluster is managed by obshell and how to take over the cluster, see [Take over a non-obshell-deployed cluster](300.take-over-non-obshell-deployed-clusters.md).

- All OBServer nodes of the OceanBase cluster and obshell are running.

## Deployment modes

The following table describes the three servers used in this topic (obshell uses the default port 2886):

|     Role      |    IP Address    |          Description          |
| ------------- | ---------- | ---------------------- |
| OBServer node | 10.10.10.1 | Zone 1 of OceanBase Database |
| OBServer node | 10.10.10.2 | Zone 2 of OceanBase Database |
| OBServer node | 10.10.10.3 | Zone 3 of OceanBase Database |

## Back up the cluster by using an API

<main id="notice" type='explain'>
  <h4>Note</h4>
  <p>obshell will verify the security of the called API. Therefore, you must encrypt the request and configure the encrypted request header (<code>${request_headers}</code>) and request body (<code>${request_body}</code>) in the curl command before you call the API each time. </p>
</main>

### Step 1: (Optional) Set the cluster-level backup configuration

You can call the `/api/v1/obcluster/backup/config` API of any obshell to set the cluster-level backup configuration.

<main id="notice" type='explain'>
  <h4>Note</h4>
  <p>If you have already configured a cluster-level backup, you do not need to call this API again. </p>
</main>

:::tab

tab CLI

For more information about how to call the corresponding API in the CLI, see [Set the cluster-level backup configuration](../../400.obshell-api-reference/600.backup-management/200.configure-backup-configuration-for-cluster-level-tenants.md). This API creates an asynchronous task. For more information about how to query the task progress, see [Get task details](../../400.obshell-api-reference/1000.task-management/2000.get-dag-detail.md). Wait for the task to complete, and then the configuration is completed.

```shell
[admin@test001 ~]$ curl -H "Content-Type: application/json" -H 'X-OCS-Header:${request_headers}' -X POST -d '${request_body}' http://10.10.10.1:2886/api/v1/obcluster/backup/config
```

The request body before encryption is as follows:

```shell
{
  "backup_base_uri":"file:///data/backup",
  "log_archive_concurrency":50
}
```

tab Python

For more information about how to request the corresponding API method by using obshell-sdk-python, see [Set the cluster-level backup configuration](../../500.obshell-sdk-reference/100.python/600.backup-management/200.backup-configuration-for-cluster-of-python.md).

```python
...
client = ClientSet("10.10.10.1", 2886, PasswordAuth("****"))
client.v1.post_cluster_backup_config_sync(
    "file:///data/backup",
    log_archive_concurrency=100,
)
...
```

tab GO

For more information about how to request the corresponding API method by using obshell-sdk-go, see [Set the cluster-level backup configuration](../../500.obshell-sdk-reference/200.go/600.backup-management/200.backup-configuration-for-cluster-of-go.md).

```go
...
client, err := services.NewClientWithPassword("10.10.10.1", 2886, "****")
request := client.V1().NewClusterBackupConfigPostRequest("file:///data/backup")
request.SetArchiveLagTarget("10s").SetLogArchiveConcurrency(100).
dag, err := client.V1().ClusterBackupConfigSyncWithRequest(request)
...
```

:::

### Step 2: Initiate a cluster-level backup

You can call the `/api/v1/obcluster/backup` API of any obshell to initiate a cluster-level backup.

:::tab

tab CLI

For more information about how to call the corresponding API in the CLI, see [Initiate a cluster-level backup](../../400.obshell-api-reference/600.backup-management/600.initiate-cluster-level-tenant-backup.md). This API creates an asynchronous task. For more information about how to query the task progress, see [Get task details](../../400.obshell-api-reference/1000.task-management/2000.get-dag-detail.md). Wait for the task to complete, and then the backup is completed.

```shell
[admin@test001 ~]$ curl -H "Content-Type: application/json" -H 'X-OCS-Header:${request_headers}' -X POST -d '${request_body}' http://10.10.10.1:2886/api/v1/obcluster/backup
```

The request body before encryption is as follows:

```shell
{
    "mode":"full"
}
```

tab Python

For more information about how to request the corresponding API method by using obshell-sdk-python, see [Initiate a cluster-level backup](../../500.obshell-sdk-reference/100.python/600.backup-management/600.initiate-cluster-level-tenant-backup-of-python.md).

```python
...
client = ClientSet("10.10.10.1", 2886, PasswordAuth("****"))
client.v1.start_cluster_backup_sync("full")
...
```

tab GO

For more information about how to request the corresponding API method by using obshell-sdk-go, see [Initiate a cluster-level backup](../../500.obshell-sdk-reference/200.go/600.backup-management/600.initiate-cluster-level-tenant-backup-of-go.md).

```go
...
client, err := services.NewClientWithPassword("10.10.10.1", 2886, "****")
request := client.V1().NewClusterBackupRequest()
request.SetBackupMode("full")
dag, err := client.V1().ClusterBackupWithRequest(request)
...
```

:::

### Step 3: View the cluster-level backup task

You can call the `/api/v1/obcluster/backup/overview` API of any obshell to view the cluster-level backup task.

:::tab

tab CLI

For more information about how to call the corresponding API in the CLI, see [View the cluster-level backup task](../../400.obshell-api-reference/600.backup-management/800.view-cluster-level-tenant-backup-tasks.md).

```shell
[admin@test001 ~]$ curl -H "Content-Type: application/json" -H 'X-OCS-Header:${request_headers}' -X GET http://10.10.10.1:2886/api/v1/obcluster/backup/overview
```

tab Python

For more information about how to request the corresponding API method by using obshell-sdk-python, see [View the cluster-level backup task](../../500.obshell-sdk-reference/100.python/600.backup-management/800.view-cluster-level-tenant-backup-tasks-of-python.md).

```python
...
client = ClientSet("10.10.10.1", 2886, PasswordAuth("****"))
client.v1.get_cluster_backup_overview()
...
```

tab GO

For more information about how to request the corresponding API method by using obshell-sdk-go, see [View the cluster-level backup task](../../500.obshell-sdk-reference/200.go/600.backup-management/800.view-cluster-level-tenant-backup-tasks-of-go.md).

```go
...
client, err := services.NewClientWithPassword("10.10.10.1", 2886, "****")
res, err := client.V1().GetClusterBackupOverview()
...
```

:::

## Back up the cluster by using an obshell command

### Step 1: Execute a cluster backup

You can execute the `obshell cluster backup` command on any node to configure the cluster-level backup and initiate a backup. For more information about this command, see [obshell cluster commands](../../300.obshell-clients/200.cluster-commands.md).

```shell
[admin@test001 ~]$ /home/admin/oceanbase/bin/obshell cluster backup -u 'file:///data/backup' 
```

### Step 2: Query the backup task

For more information about this command, see [obshell backup commands](../../300.obshell-clients/400.backup-commands.md).

```shell
[admin@test001 ~]$ /home/admin/oceanbase/bin/obshell backup show
```