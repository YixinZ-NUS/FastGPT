|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# Cancel a replica task

There is a restriction on the execution of a disaster recovery task: a tenant log stream allows only one replica task at a time, excluding replica migration tasks. As a result, some emergency tasks may need to wait for the completion of the existing task before they can be executed. If you need to prioritize the execution of an emergency task, you can manually cancel the running replica task by using the `ALTER SYSTEM CANCEL REPLICA TASK` command.

## Limitations

* You can cancel only a replica adding or migration task.

  <main id="notice" type='explain'>
  <h4>Note</h4>
  <p>In the current version, if a replica migration task is generated due to a unit migration and the destination of the migration task has no units, the system will automatically cancel the corresponding replica migration task. You do not need to manually cancel it. </p>
  </main>

* You can cancel replica tasks of all tenants in the `sys` tenant but cancel only replica tasks of the current tenant in a user tenant.

## Prerequisites

* You have the `ALTER SYSTEM` privilege.

* You have the `SELECT` privilege on the following views:

  * `DBA_OB_LS_REPLICA_TASKS` and `CDB_OB_LS_REPLICA_TASKS`

  * `DBA_OB_LS_REPLICA_TASK_HISTORY` and `CDB_OB_LS_REPLICA_TASK_HISTORY`

## Procedure

Assume that a task to migrate a read-only replica of log stream `1001` of a tenant named `tenant1` is in progress and a full-featured replica needs to be added to an available OBServer node to ensure high availability upon an exception of the cluster. However, the read-only replica involves a large amount of data, and the replica migration task is unlikely to complete anytime soon. Consequently, the emergency task to add a full-featured replica cannot be performed immediately. In this case, you can cancel the ongoing replica migration task and perform the emergency task with priority.

1. Log in to the target tenant.

    Here is an example:

    ```shell
    obclient -h172.30.xxx.xxx -P2883 -uroot@tenant1#obdemo -pxxxx -A
    ```

    For more information about how to connect to a database, see [Overview (MySQL mode)](../../../../300.develop/100.application-development-of-mysql-mode/100.connect-to-oceanbase-database-of-mysql-mode/100.connection-methods-overview-of-mysql-mode.md) or [Overview (Oracle mode)](../../../../300.develop/200.application-development-of-oracle-mode/100.connect-to-oceanbase-database-of-oracle-mode/100.connection-methods-overview-of-oracle-mode.md).

2. Query the ongoing replica task.

    * `sys` tenant

      ```shell
      obclient [oceanbase]> SELECT * FROM oceanbase.CDB_OB_LS_REPLICA_TASKS;
      ```

      For more information about the fields in the `CDB_OB_LS_REPLICA_TASKS` view, see [CDB_OB_LS_REPLICA_TASKS](../../../../700.reference/700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/9900.o-cdb_ob_ls_replica_tasks-of-sys-tenant.md).

    * User tenant

      :::tab
      tab MySQL mode

      Execute the following statement in MySQL mode:

      ```shell
      obclient [oceanbase]> SELECT * FROM oceanbase.DBA_OB_LS_REPLICA_TASKS;
      ```

      tab Oracle mode

      Execute the following statement in Oracle mode:

      ```shell
      obclient [SYS]> SELECT * FROM SYS.DBA_OB_LS_REPLICA_TASKS;
      ```

      :::

      A sample query result is as follows:

      ```shell
      +-------+-----------------+------------------------------------+-------------+----------+-----------------------+-------------------------+-----------------------------+---------------------+-----------------------+-------------------------+-----------------------------+---------------------+--------------------+----------------------+-----------+------------------+--------------------+---------------------+---------------------+---------------------+---------------------------------------------+
      | LS_ID | TASK_TYPE       | TASK_ID                            | TASK_STATUS | PRIORITY | TARGET_REPLICA_SVR_IP | TARGET_REPLICA_SVR_PORT | TARGET_PAXOS_REPLICA_NUMBER | TARGET_REPLICA_TYPE | SOURCE_REPLICA_SVR_IP | SOURCE_REPLICA_SVR_PORT | SOURCE_PAXOS_REPLICA_NUMBER | SOURCE_REPLICA_TYPE | DATA_SOURCE_SVR_IP | DATA_SOURCE_SVR_PORT | IS_MANUAL | TASK_EXEC_SVR_IP | TASK_EXEC_SVR_PORT | CREATE_TIME         | START_TIME          | MODIFY_TIME         | COMMENT                                     |
      +-------+-----------------+------------------------------------+-------------+----------+-----------------------+-------------------------+-----------------------------+---------------------+-----------------------+-------------------------+-----------------------------+---------------------+--------------------+----------------------+-----------+------------------+--------------------+---------------------+---------------------+---------------------+---------------------------------------------+
      |  1001 | MIGRATE REPLICA | Y13CE64586BD4-000610C5F3EDBBCB-0-0 | INPROGRESS  | LOW      | 100.xx.xxx.002        |                    5072 |                           2 | FULL                | 100.xx.xxx.003        |                    5073 |                           2 | FULL                | 100.xx.xxx.003     |                 5073 | FALSE     | 100.xx.xxx.002   |               5072 | 2024-02-07 15:23:04 | 2024-02-07 15:23:04 | 2024-02-07 15:23:04 | migrate replica due to unit group not match |
      +-------+-----------------+------------------------------------+-------------+----------+-----------------------+-----------------------  +-----------------------------+---------------------+-----------------------+-------------------------+-----------------------------+---------------------+--------------------+----------------------+-----------+------------------+--------------------+---------------------+---------------------+---------------------+---------------------------------------------+
      1 row in set
      ```

      The query result shows that the replica task with the task type of `MIGRATE REPLICA` is in progress. Record the task ID of the task.

      For more information about the fields in the `DBA_OB_LS_REPLICA_TASKS` view, see [DBA_OB_LS_REPLICA_TASKS](../../../../700.reference/700.system-views/400.system-view-of-mysql-mode/200.dictionary-view-of-mysql-mode/18200.oceanbase-dba_ob_ls_replica_tasks-of-mysql-mode.md).

3. Execute the `ALTER SYSTEM CANCEL REPLICA TASK` statement to cancel the ongoing replica task.

   The syntax is as follows:

   ```sql
   ALTER SYSTEM CANCEL REPLICA TASK TASK_ID [=] 'task_id' [TENANT [=] 'tenant_name'];
   ```

   The parameters in the syntax are described as follows:

   * `task_id`: the task ID of the replica task to be canceled.

   * `tenant_name`: the name of the target tenant. You can specify another tenant in the `sys` tenant and specify only the current tenant in a user tenant. If this parameter is not explicitly specified, the name of the current tenant is used. You cannot use the `all`, `all_user`, or `all_meta` option in this statement to specify all tenants, all user tenants, or all meta tenants.

   * This statement cancels only one replica task of the tenant at a time.

   Here is an example:

   ```shell
   obclient> ALTER SYSTEM CANCEL REPLICA TASK TASK_ID = 'Y13CE64586BD4-000610C5F3EDBBCB-0-0';
   ```

4. Check whether the replica task is canceled.

    * `sys` tenant

      ```shell
      obclient [oceanbase]> SELECT * FROM oceanbase.CDB_OB_LS_REPLICA_TASK_HISTORY WHERE TASK_ID = 'Y13CE64586BD4-000610C5F3EDBBCB-0-0';
      ```

      For more information about the fields in the `CDB_OB_LS_REPLICA_TASK_HISTORY` view, see [CDB_OB_LS_REPLICA_TASK_HISTORY](../../../../700.reference/700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/9950.o-cdb_ob_ls_replica_task_history-of-sys-tenant.md).

    * User tenant

      :::tab
      tab MySQL mode

      Execute the following statement in MySQL mode:

      ```shell
      obclient [oceanbase]> SELECT * FROM oceanbase.DBA_OB_LS_REPLICA_TASK_HISTORY WHERE TASK_ID = 'Y13CE64586BD4-000610C5F3EDBBCB-0-0';
      ```

      tab Oracle mode

      Execute the following statement in Oracle mode:

      ```shell
      obclient [SYS]> SELECT * FROM SYS.DBA_OB_LS_REPLICA_TASK_HISTORY WHERE TASK_ID = 'Y13CE64586BD4-000610C5F3EDBBCB-0-0';
      ```

      :::

      A sample query result is as follows:

      ```shell
      +-------+-----------------+------------------------------------+-------------+----------+-----------------------+-------------------------+-----------------------------+---------------------+-----------------------+-------------------------+-----------------------------+---------------------+--------------------+----------------------+-----------+------------------+--------------------+---------------------+---------------------+---------------------+---------------------+-------------------------------------------------------------------------------------------------+---------------------------------------------+
      | LS_ID | TASK_TYPE       | TASK_ID                            | TASK_STATUS | PRIORITY | TARGET_REPLICA_SVR_IP | TARGET_REPLICA_SVR_PORT | TARGET_PAXOS_REPLICA_NUMBER | TARGET_REPLICA_TYPE | SOURCE_REPLICA_SVR_IP | SOURCE_REPLICA_SVR_PORT | SOURCE_PAXOS_REPLICA_NUMBER | SOURCE_REPLICA_TYPE | DATA_SOURCE_SVR_IP | DATA_SOURCE_SVR_PORT | IS_MANUAL | TASK_EXEC_SVR_IP | TASK_EXEC_SVR_PORT | CREATE_TIME         | START_TIME          | MODIFY_TIME         | FINISH_TIME         | EXECUTE_RESULT                                                                                  | COMMENT                                     |
      +-------+-----------------+------------------------------------+-------------+----------+-----------------------+-------------------------+-----------------------------+---------------------+-----------------------+-------------------------+-----------------------------+---------------------+--------------------+----------------------+-----------+------------------+--------------------+---------------------+---------------------+---------------------+---------------------+-------------------------------------------------------------------------------------------------+---------------------------------------------+
      |  1001 | MIGRATE REPLICA | Y13CE64586BD4-000610C5F3EDBBCB-0-0 | CANCELED    | LOW      | 100.xx.xxx.002        |                    5072 |                           2 | FULL                | 100.xx.xxx.003        |                    5073 |                           2 | FULL                | 100.xx.xxx.003     |                 5073 | FALSE     | 100.xx.xxx.002   |               5072 | 2024-02-07 15:54:35 | 2024-02-07 15:54:31 | 2024-02-07 15:54:35 | 2024-02-07 15:54:34 | ret:-4072, OB_CANCELED; elapsed:4109659; comment:[storage] receive task reply from storage rpc; | migrate replica due to unit group not match |
      +-------+-----------------+------------------------------------+-------------+----------+-----------------------+-------------------------+-----------------------------+---------------------+-----------------------+-------------------------+-----------------------------+---------------------+--------------------+----------------------+-----------+------------------+--------------------+---------------------+---------------------+---------------------+---------------------+-------------------------------------------------------------------------------------------------+---------------------------------------------+
      1 row in set
      ```

      The query result shows that the status of the task is `CANCELED`.

      For more information about the fields in the `DBA_OB_LS_REPLICA_TASK_HISTORY` view, see [DBA_OB_LS_REPLICA_TASK_HISTORY](../../../../700.reference/700.system-views/400.system-view-of-mysql-mode/200.dictionary-view-of-mysql-mode/27600.dba_ob_ls_replica_task_history-of-mysql-mode.md).

## References

* [Add replicas](300.add-replica.md)

* [Remove replicas](400.reduce-replica.md)

* [Convert the type of a replica](450.change-the-replica-type.md)

* [Modify the number of Paxos replicas of a log stream](800.modify-paxos-replica-number.md)

* [Migrate replicas](700.unit-migration.md)
