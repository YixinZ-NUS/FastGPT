|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# Troubleshoot SQL execution errors

SQL execution errors are common in database O&M and can directly impact business operations. There are many reasons why SQL statements may fail to execute, such as unsuccessful database connections, insufficient user privileges, syntax errors, or data that does not meet query conditions.

To help you quickly identify root causes and efficiently resolve issues, the following sections outline a clear and practical process for troubleshooting SQL errors. This process provides specific steps to improve resolution efficiency and minimize business impact, supporting your routine O&M tasks.

The diagram below illustrates the SQL execution error troubleshooting process.

![SQL execution error troubleshooting process](https://obportal.s3.ap-southeast-1.amazonaws.com/doc/img/OceanBase-Database-EN/sql-error-troubleshooting.png)

## Procedure

When an SQL execution error occurs, you can troubleshoot the issue by following the procedure below.

After an SQL execution error occurs, check the SQL error message. If the error message contains an error code, troubleshoot the issue based on the error code. If the error message does not contain an error code, determine the error type. The error may be caused by application execution or by manual SQL execution:

1. If the error is an application execution error, refer to [Application exception: error message does not contain an OceanBase error code](1300.application-exception-without-ob-error-code.md) and [Application exception: error message contains an OceanBase error code](1400.application-exception-with-ob-error-code.md) for troubleshooting methods.

2. If the error is a manual SQL execution error, determine whether the error can be manually reproduced.

   1. If the error cannot be reproduced, search for relevant information in the Knowledge Base using the SQL statement for troubleshooting.
   2. If the error can be reproduced, recreate the error scenario. Connect to the OceanBase cluster through port 2881 or 2883 according to the original scenario, and execute the original SQL statement to reproduce the issue.

      After reproducing the SQL execution error, perform the following steps to collect information for troubleshooting:

      1. Execute the following statement to obtain the `trace_id`:

         <main id="notice" type='notice'>
         <h4>Notice</h4>
         <p>You must execute the following statement immediately after the SQL statement that causes the error. Otherwise, the <code>trace_id</code> obtained will not correspond to the SQL statement that caused the error.</p>
         </main>

         :::tab
         tab MySQL-compatible mode

         The statement to obtain the `trace_id` in MySQL-compatible mode is:

         ```shell
         obclient> SELECT last_trace_id();
         ```

         tab Oracle-compatible mode

         The statement to obtain the `trace_id` in Oracle-compatible mode is:

         ```shell
         obclient> SELECT last_trace_id() FROM DUAL;
         ```

         :::

      2. Use the obtained `trace_id` to find the host that executed the SQL statement.

         OceanBase clusters are typically deployed across multiple nodes. You can execute the following statement to identify the node that executed the SQL statement, and then filter logs on that node.

         :::tab
         tab MySQL-compatible mode

         Execute the following statement in MySQL-compatible mode:

         ```shell
         obclient> SELECT * FROM oceanbase.GV$OB_SQL_AUDIT WHERE trace_id=last_trace_id;
         ```

         Replace `'last_trace_id'` with the actual `trace_id` obtained in the previous step.

         tab Oracle-compatible mode

         Execute the following statement in Oracle-compatible mode:

         ```shell
         obclient> SELECT * FROM SYS.GV$OB_SQL_AUDIT WHERE trace_id=last_trace_id;
         ```

         Replace `'last_trace_id'` with the actual `trace_id` obtained in the previous step.

         :::

         In the query result from the `GV$OB_SQL_AUDIT` view, the host indicated by `svr_ip` is the one that executed the SQL statement.

      3. Use the `ssh` command to log in to the host based on the obtained host information.

      4. Navigate to the log directory.

         For example, if the OceanBase Database installation directory is `/home/admin/oceanbase`, the logs are stored in that path. The actual log path may vary depending on your environment.

         ```shell
         cd /home/admin/oceanbase/log
         ```

      5. Execute the following commands to filter logs:

         ```shell
         grep "${trace_id}" observer.log
         ```

         ```shell
         grep "${trace_id}" observer.log.xxx
         ```

         Replace `${trace_id}` with the `trace_id` obtained in the previous steps. `observer.log.xxx` refers to a log file with a timestamp. Replace `xxx` with the actual timestamp corresponding to when the SQL error was reproduced.

      6. Analyze the issue using the information provided in the logs, along with the error code or related error messages.

         For more information about logs and error codes, see [Log overview](../800.logging/100.logging-overview.md) and [Error information overview](../../700.reference/900.error-code/600.error-code-of-mysql-mode/100.use-error-information-of-mysql-mode.md).

         If the log information is unclear, contact technical support for assistance.

## Case studies

The following case studies describe typical scenarios in which SQL execution errors occur and how they are resolved.

:::tab
tab MySQL-compatible mode

* After reproducing the SQL error, the database returns an error code in the result.

  * If a `SELECT` statement contains numerous `OR` conditions, many `IN` conditions connected by `AND`, or multiple `AND NOT` conditions, executing the statement may result in the error `-4013, No memory or reach tenant memory limit`.

* The error code appears in the log.

  * When processing a `longtext` field in an SQL statement, the error `ErrorCode=5098` may be returned.

  * An SQL execution error `error 4119 (RPC packet to send too long)` may occur. You can search the `observer.log` file using the `trace_id` and find the message `obrpc packet payload exceeded its limit`.

* Other error messages may appear in the log.

  * If an SQL statementâ€™s filter conditions involve more than 64 different fields, the error `-4002 Invalid argument` may be returned.

tab Oracle-compatible mode

* After reproducing the SQL error, the database returns an error code in the result.

  * For a query involving columns `c1`, `c2`, and `c3`, where `c1` and `c2` are indexed and multiple `IN` expressions exist on `c1` or `c2`, any vector expression formed by `c1`, `c2`, and `c3` may result in an `internal error` with error code `ORA-00600` during execution.

* The error code is returned after SQL execution and also appears in the log.

  * Executing an SQL statement may result in a `Timeout` error with error code `ORA-00600`.

:::

## References

* [Search for logs of a specific SQL request](../800.logging/600.view-logs/100.search-for-logs-of-a-sql-query.md)

* [Use tracing feature to search for logs of the last SQL request](../800.logging/600.view-logs/200.search-for-logs-of-a-sql-query-using-trace.md)

* [Log overview](../800.logging/100.logging-overview.md)