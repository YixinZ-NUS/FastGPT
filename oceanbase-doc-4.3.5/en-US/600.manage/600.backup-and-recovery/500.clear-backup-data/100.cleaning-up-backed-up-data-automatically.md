|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# Automatic cleanup of expired backups

After a backup is successfully performed, you can set retention policies for tenants based on your business requirements. Tenants with retention policies will trigger an automatic cleanup process every hour to ensure that expired backups are promptly removed.

The current version only supports the automatic cleanup of expired backups and does not support manual cleanup of expired backups.

## Considerations

* Log archive data can be cleared only after data backups are performed. If no data backup files exist, the system does not automatically clean up log archive data.

* Automatic cleanup is supported only for the backup and archive destinations specified by using the `DATA_BACKUP_DEST` and `LOG_ARCHIVE_DEST` parameters. If the backup or archive destination is changed, the data in the original backup or archive destination cannot be cleared by using OceanBase Database.

* Automatic cleanup retains at least one valid backup copy. If only one valid backup copy exists, this copy will not be cleared.

* Different backup media have varying results for automatic backup cleaning:

  * For backup media like NFS or object storage compatible with the S3 protocol (such as OBS, GCS, etc.), the system will directly delete backup files that meet the requirements during data cleanup.
  * For scenarios where the backup destination is S3/COS (accessed via the S3 protocol), the method of cleaning backup files depends on the value of the `delete_mode` parameter in `data_backup_dest` and `log_archive_dest`. For detailed information on this parameter, refer to [SET LOG_ARCHIVE_DEST](../../../700.reference/500.sql-reference/100.sql-syntax/100.system-tenants/200.alter-system/150.set-log-archive-dest.md) and [SET DATA_BACKUP_DEST](../../../700.reference/500.sql-reference/100.sql-syntax/100.system-tenants/200.alter-system/3500.set-data-backup-dest.md).

* Specifically, for paths where the `enable_worm=true` parameter is configured, the system will select backup sets that meet the conditions for cleanup based on the time specified by `RECOVERY_WINDOW`. However, whether the cleanup is successful depends on the cleanup mode corresponding to the path (the value of the `delete_mode` parameter) and the retention policy of the corresponding bucket.

  <main id="notice" type='notice'>
  <h4>Notice</h4>
  <p>The <code>enable_worm=true</code> parameter is applicable in scenarios where a compliance retention policy (WORM) is enabled. Starting from version V4.3.5 BP2, OceanBase Database supports using Alibaba Cloud OSS buckets configured with a WORM policy as backup or archive paths.</p>
  </main>
  
  For example, if a backup set is outside the time specified by `RECOVERY_WINDOW` but still within the WORM (Write Once Read Many) retention period, then:

  * If the cleanup mode of the backup set is `delete`, OceanBase Database will fail to clean up the backup set. Cleanup can only occur after the retention period of the object expires.

  * If the cleanup mode is `tagging`, OceanBase Database will tag the backup set, and the object storage will execute the deletion after the lifecycle ends and the WORM retention period has passed.

## Set a cleanup policy

### Set a cleanup policy in a user tenant

1. Log in to the database as the tenant administrator of the user tenant.

2. Set a cleanup policy to enable the automatic cleanup feature for the tenant.

   The statement is as follows:

   ```shell
   obclient> ALTER SYSTEM ADD DELETE BACKUP POLICY policy_name RECOVERY_WINDOW recovery_window;
   ```

   where:

   * The `POLICY` parameter specifies the name of the cleanup policy. Set the value to `default`. This indicates that automatic cleanup applies only to backups specified by the `data_backup_dest` and `log_archive_dest` parameters.

   * The `RECOVERY_WINDOW` parameter specifies the time window during which backup data can be restored. For more information about this parameter, see [recovery_window](../500.clear-backup-data/500.parameters-of-cleaning-up-backup.md).

   Example:

   ```shell
   obclient> ALTER SYSTEM ADD DELETE BACKUP POLICY 'default' RECOVERY_WINDOW '7d';
   ```

### Set a cleanup policy in the sys tenant

1. Log in to the `sys` tenant of the cluster as the `root` user.

2. Set a cleanup policy to enable the automatic cleanup feature for the tenant.

   The statement is as follows:

   ```shell
   obclient> ALTER SYSTEM ADD DELETE BACKUP POLICY policy_name RECOVERY_WINDOW recovery_window TENANT tenant_name;
   ```

   where:

   * The `POLICY` parameter specifies the name of the cleanup policy. Set the value to `default`. This indicates that automatic cleanup applies only to backups specified by the `data_backup_dest` and `log_archive_dest` parameters.

   * The `RECOVERY_WINDOW` parameter specifies the time window during which backup data can be restored. For more information about this parameter, see [recovery_window](../500.clear-backup-data/500.parameters-of-cleaning-up-backup.md).

   * The `TENANT` parameter specifies the tenant for which the cleanup policy takes effect. Specify the name of a user tenant. You can specify only one tenant name.

  <main id="notice" type='notice'>
  <h4>Notice</h4>
  <p>You can set a cleanup policy only at the tenant level. You cannot set a cleanup policy at the cluster level. Moreover, the statement in a single session can set cleanup policies for only one tenant. </p>
  </main>

   Here is an example of setting a cleanup policy for a MySQL tenant in the sys tenant:

   ```shell
   obclient> ALTER SYSTEM ADD DELETE BACKUP POLICY 'default' RECOVERY_WINDOW '7d' TENANT MySQL;
   ```

## Query the cleanup policies

Both system tenants and user tenants can query views to obtain the cleanup policies that have been set.

1. Log in to the database as the tenant administrator of the system tenant or user tenant.

2. Query the cleanup policies set for the tenant.

    * Query the `oceanbase.CDB_OB_BACKUP_DELETE_POLICY` view in the sys tenant to obtain the cleanup policies set for all tenants.

      Here is an example:

      ```shell
      obclient> SELECT * FROM oceanbase.CDB_OB_BACKUP_DELETE_POLICY;
      +-----------+-------------+-----------------+
      | TENANT_ID | POLICY_NAME | RECOVERY_WINDOW |
      +-----------+-------------+-----------------+
      |      1002 | default     | 7d              |
      +-----------+-------------+-----------------+
      1 row in set
      ```

    * Query the `oceanbase.DBA_OB_BACKUP_DELETE_POLICY` view or the `sys.DBA_OB_BACKUP_DELETE_POLICY` view to obtain the cleanup policies set for the current tenant.

      * For a MySQL tenant

        ```sql
        obclient [(none)]> SELECT * FROM oceanbase.DBA_OB_BACKUP_DELETE_POLICY;
        +-------------+-----------------+
        | POLICY_NAME | RECOVERY_WINDOW |
        +-------------+-----------------+
        | default     | 7d              |
        +-------------+-----------------+
        1 row in set
        ```

      * For an Oracle tenant

        ```sql
        obclient [SYS]> SELECT * FROM sys.DBA_OB_BACKUP_DELETE_POLICY;
        +-------------+-----------------+
        | POLICY_NAME | RECOVERY_WINDOW |
        +-------------+-----------------+
        | default     | 7d              |
        +-------------+-----------------+
        1 row in set
        ```