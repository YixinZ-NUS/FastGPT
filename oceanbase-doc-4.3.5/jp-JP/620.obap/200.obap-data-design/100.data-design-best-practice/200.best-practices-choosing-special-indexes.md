# Unit 2：特殊インデックス作成

AP（分析処理）型データベースにおいて特殊なインデックスを作成する際は、以下のベストプラクティスを参考にすることができます。

## JSON複数値インデックス

### 適用シナリオ

JSON複数値インデックスは、JSONドキュメント内の配列フィールドに特化して設計されたインデックスタイプであり、複数の値やプロパティに対するクエリが必要なシナリオに適しています。これにより、該当クエリのパフォーマンスを大幅に向上させることが可能です。複数値インデックスは、主に以下のようなシナリオに適しています：

+ **多対多の関連クエリ**：2つのエンティティ間に多対多の関係が存在する場合、複数値インデックスを使用することでクエリの処理を高速化できます。たとえば、俳優は複数の映画に出演でき、1本の映画にも複数の俳優が出演する可能性があります。JSON配列を使用して映画に関わるすべての俳優のデータを格納し、JSONの複数値インデックスを使用して、特定の俳優が出演したすべての映画のクエリを高速で実行できます。
+ **タグとカテゴリのクエリ**：エンティティが複数のタグやカテゴリを持つ場合、複数値インデックスを使用して関連するクエリを高速化できます。例えば、ある商品が複数のタグプロパティを持つ場合、タグをJSON配列として格納することで、特定のタグまたは複数のタグを含む商品を高速でクエリを実行できます。

     JSON複数値インデックスは、JSON配列に基づき、WHERE句で以下の3種類の述語を含むクエリの高速化によく利用されます：

    - [MEMBER OF()](https://dev.mysql.com/doc/refman/8.0/en/json-search-functions.html#operator_member-of)
    - [JSON_CONTAINS()](https://dev.mysql.com/doc/refman/8.0/en/json-search-functions.html#function_json-contains)
    - [JSON_OVERLAPS()](https://dev.mysql.com/doc/refman/8.0/en/json-search-functions.html#function_json-overlaps)

     JSON複数値インデックスの詳細については、[複数値インデックス](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974623)を参照してください。

### ベストプラクティスの操作例

以下の例を通して、JSON複数値インデックスの利用シナリオを説明します。ユーザー情報を格納するテーブルがあり、ユーザーID、氏名、年齢、そして趣味を記録しているとします。趣味はJSON配列として保存され、1人のユーザーが複数の趣味を持つことができます。趣味はJSON配列の形式で保存されてます。これらの趣味はユーザーに付与された「タグ」として理解できます。テーブル構造およびサンプルデータは次の通りです：

```sql
create table user_info(user_id bigint, name varchar(1024), age bigint, hobbies json);
insert into user_info values(1, "LiLei", 18, '["reading", "knitting", "hiking"]');
insert into user_info values(2, "HanMeimei", 17, '["reading", "Painting", "Swimming"]');
insert into user_info values(3, "XiaoMing", 19, '["hiking", "Camping", "Swimming"]');
```

商品広告の配信においては、ユーザーの趣味に応じた精度の高いターゲティングが求められます。例えば、登山用アウトドア製品の広告を配信する前に、「hiking」という趣味を持つユーザーを抽出する必要があります。対応するクエリステートメントは以下のとおりです：

```sql
OceanBase(root@test)>select user_id, name from user_info where JSON_CONTAINS(hobbies->'$[*]', CAST('["hiking"]' AS JSON));
+---------+----------+
| user_id | name     |
+---------+----------+
|       1 | LiLei    |
|       3 | XiaoMing |
+---------+----------+

-- このクエリを初めて実行する際には、フルテーブルスキャンが必要となる可能性があり、パフォーマンスが低下することがあります。
OceanBase(root@test)>explain select user_id, name from user_info where JSON_CONTAINS(hobbies->'$[*]', CAST('["hiking"]' AS JSON));
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Query Plan                                                                                                                                                              |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ====================================================                                                                                                                    |
| |ID|OPERATOR       |NAME     |EST.ROWS|EST.TIME(us)|                                                                                                                    |
| ----------------------------------------------------                                                                                                                    |
| |0 |TABLE FULL SCAN|user_info|2       |3           |                                                                                                                    |
| ====================================================                                                                                                                    |
| Outputs & filters:                                                                                                                                                      |
| -------------------------------------                                                                                                                                   |
|   0 - output([user_info.user_id], [user_info.name]), filter([JSON_CONTAINS(JSON_EXTRACT(user_info.hobbies, '$[*]'), cast('[\"hiking\"]', JSON(536870911)))]), rowset=16 |
|       access([user_info.hobbies], [user_info.user_id], [user_info.name]), partitions(p0)                                                                                |
|       is_index_back=false, is_global_index=false, filter_before_indexback[false],                                                                                       |
|       range_key([user_info.__pk_increment]), range(MIN ; MAX)always true                                                                                                |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
```

上記のクエリプランから分かるように、クエリ全体でフルテーブルスキャンが必要であり、各行のJSON配列に対してフィルタリングおよび照合が逐次行われています。JSON自体のフィルタ処理にも一定のコストがかかるため、フィルタ対象のレコード数が一定以上になると、クエリのパフォーマンスに深刻な影響を及ぼします。この場合、hobbies列に対してJSON複数値インデックスを作成することで、このクエリのパフォーマンスを大幅に向上させることができます。

現在、JSON複数値インデックスの後付け作成機能はデフォルトで無効になっています。これを有効にするには、sysテナントで後付けJSON複数値インデックス機能のスイッチをオンにする必要があります。

```sql
alter system set _enable_add_fulltext_index_to_existing_table = true;
```

```sql
-- クエリプランを見ると、テーブル全体のスキャンが必要であることが表示されています。パフォーマンスを最適化するために、hobbies列に対してJSON複数値インデックスの作成を推奨します：
CREATE INDEX idx1 ON user_info ( (CAST(hobbies->'$[*]' AS char(512) ARRAY)) );

-- インデックス作成後にクエリを再実行すると、パフォーマンスが大幅に向上します
OceanBase(root@test)>explain select user_id, name from user_info where JSON_CONTAINS(hobbies->'$[*]', CAST('["hiking"]' AS JSON));
+--------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Query Plan                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ==========================================================                                                                                                   |
| |ID|OPERATOR       |NAME           |EST.ROWS|EST.TIME(us)|                                                                                                   |
| ----------------------------------------------------------                                                                                                   |
| |0 |TABLE FULL SCAN|user_info(idx1)|1       |10          |                                                                                                   |
| ==========================================================                                                                                                   |
| Outputs & filters:                                                                                                                                           |
| -------------------------------------                                                                                                                        |
|   0 - output([user_info.user_id], [user_info.name]), filter([JSON_CONTAINS(JSON_EXTRACT(user_info.hobbies, '$[*]'), cast('[\"hiking\"]', JSON(536870911)))]) |
|       access([user_info.__pk_increment], [user_info.hobbies], [user_info.user_id], [user_info.name]), partitions(p0)                                         |
|       is_index_back=true, is_global_index=false, filter_before_indexback[false],                                                                             |
|       range_key([user_info.SYS_NC_mvi_21], [user_info.__pk_increment], [user_info.__doc_id_1733716274684183]), range(hiking,MIN,MIN ; hiking,MAX,MAX)        |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------+
11 rows in set (0.005 sec)
```

注意すべき点として、JSON複数値インデックスは追加のストレージ容量を消費し、書き込みパフォーマンスに影響を与える可能性があります。複数値インデックスを含むJSONフィールドに対して修正(挿入、更新、削除などの操作)を行うと、インデックスも同時に更新されるため、書き込み処理のオーバーヘッドが増加します。そのため、JSON複数値インデックスを使用する際は、そのメリットとデメリットを十分に考慮し、必要に応じて作成することが求められます。

## 全文インデックス

### 適用シナリオ

大量のテキストデータに対してあいまい検索を行う必要があるシナリオにおいて、テーブル全体をスキャンして各行のデータをあいまいクエリにかける方法では、テキストが大きくデータ量が多い場合にパフォーマンスが要求を満たせないことがよくあります。また、近似マッチングや関連性によるソートなど、より複雑なクエリシナリオは、SQLをリライトるだけでは対応が困難です。

こうした課題を解決するために登場したのが 全文インデックス です。全文インデックスはテキストを事前に処理し、キーワードに基づくインデックスを構築することで、全文検索の効率を大幅に向上させます。全文インデックスはさまざまなシナリオで活用可能であり、以下にいくつか具体的な例を挙げます：

+ **社内ナレッジベース**：多くの大手企業は、自社の社内ナレッジベースシステムを構築しており、プロジェクトドキュメントや会議記録、研究報告書などの資料を蓄積・管理しています。全文インデックスを活用することで、従業員は必要な情報をより迅速かつ正確に検索できるようになり、業務効率が向上します。
+ **オンライン図書館および電子書籍プラットフォーム**：大量の書籍リソースをユーザーに提供するサービスにおいて、全文インデックスは非常に重要です。ユーザーが、書名、著者名、さらには書籍内の一節などをキーワードとして入力すると、システムは全文インデックスに基づいて迅速に条件に合致する結果を特定します。
+ **ニュースポータルおよびソーシャルメディアサイト**：これらのプラットフォームでは、毎日膨大な量の新規コンテンツが生成されており、記事、投稿、コメントなどが含まれます。全文インデックスを活用することで、ユーザーは関心のあるトピックや出来事、人物名などで情報の流れを絞り込み、最も関連性の高いコンテンツを取得できます。
+ **法律文書検索システム**：法律業界では、契約書、判決書、法律・法規の条文など、多数の文書のレビュー作業が発生します。高性能な全文検索エンジンは、弁護士の業務プロセスを大幅に効率化し、判例や引用条文、関連する法的根拠を迅速に検索可能にします。
+ **医療健康情報システム**：医療分野では、医師が患者の過去のカルテや最新の医学論文、その他の参考資料を頻繁に参照する必要があります。全文インデックスを活用することで、医療スタッフは関連情報へより迅速かつ容易にアクセスでき、より正確な診断判断を下すことが可能になります。

大量の非構造化テキストデータを管理し、クエリを実行するようなアプリケーションは、全文インデックスの導入を検討することで、検索効率を向上させることができます。OceanBase全文インデックス機能の詳細については、[全文インデックス](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974629)を参照してください。

### ベストプラクティスの操作例

ドキュメントデータを格納するテーブルを定義し、ドキュメントに対して全文インデックスを設定します。全文インデックスを利用することで、指定したキーワードを含む文書を高速に検索でき、さらに 類似度の高いものから順に並べ替えて取得 することが可能になります。

```sql
obclient> CREATE TABLE Articles (
    ->     id INT AUTO_INCREMENT,
    ->     title VARCHAR(255) ,
    ->     content TEXT ,
    ->     PRIMARY KEY (id),
    ->     FULLTEXT ft1 (content) WITH PARSER SPACE
    -> );
Query OK, 0 rows affected (0.67 sec)


-- データの挿入
obclient> INSERT INTO Articles (title, content) VALUES
    -> ('Introduction to OceanBase', 'OceanBase is an open-source relational database management system.'),
    -> ('Full-Text Search in Databases', 'Full-text search allows for searching within the text of documents stored in a database. It is particularly useful for finding specific information quickly.'),
    -> ('Advantages of Using OceanBase', 'OceanBase offers several advantages such as high performance, reliability, and ease of use. ');
Query OK, 3 rows affected (0.10 sec)
Records: 3  Duplicates: 0  Warnings: 0

obclient> select * from Articles;
+----+-------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+
| id | title                         | content                                                                                                                                                      |
+----+-------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  1 | Introduction to OceanBase     | OceanBase is an open-source relational database management system.                                                                                           |
|  2 | Full-Text Search in Databases | Full-text search allows for searching within the text of documents stored in a database. It is particularly useful for finding specific information quickly. |
|  3 | Advantages of Using OceanBase | OceanBase offers several advantages such as high performance, reliability, and ease of use.                                                                  |
+----+-------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+
3 rows in set (0.08 sec)

-- マッチするドキュメントをクエリ
obclient> select id,title, content,match(content) against('OceanBase database') score from Articles where match(content) against('OceanBase database');
+----+-------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
| id | title                         | content                                                                                                                                                      | score               |
+----+-------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
|  1 | Introduction to OceanBase     | OceanBase is an open-source relational database management system.                                                                                           |  0.5699481865284975 |
|  3 | Advantages of Using OceanBase | OceanBase offers several advantages such as high performance, reliability, and ease of use.                                                                  |   0.240174672489083 |
|  2 | Full-Text Search in Databases | Full-text search allows for searching within the text of documents stored in a database. It is particularly useful for finding specific information quickly. | 0.20072992700729927 |
+----+-------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
3 rows in set (0.08 sec)


-- EXPLAINコマンドを使用することで、クエリプランを確認し、そのパフォーマンスを分析することができます。
obclient> explain select id,title, content,match(content) against('OceanBase database') score from Articles where match(content) against('OceanBase database');
+-----------------------------------------------------------------------------------------------------------------------------------------------------+
| Query Plan                                                                                                                                          |
+-----------------------------------------------------------------------------------------------------------------------------------------------------+
| ==============================================================                                                                                      |
| |ID|OPERATOR             |NAME         |EST.ROWS|EST.TIME(us)|                                                                                      |
| --------------------------------------------------------------                                                                                      |
| |0 |SORT                 |             |17      |145         |                                                                                      |
| |1 |└─TEXT RETRIEVAL SCAN|articles(ft1)|17      |138         |                                                                                      |
| ==============================================================                                                                                      |
| Outputs & filters:                                                                                                                                  |
| -------------------------------------                                                                                                               |
|   0 - output([articles.id], [articles.title], [articles.content], [MATCH(articles.content) AGAINST('OceanBase database')]), filter(nil), rowset=256 |
|       sort_keys([MATCH(articles.content) AGAINST('OceanBase database'), DESC])                                                                      |
|   1 - output([articles.id], [articles.title], [articles.content], [MATCH(articles.content) AGAINST('OceanBase database')]), filter(nil), rowset=256 |
|       access([articles.id], [articles.content], [articles.title]), partitions(p0)                                                                   |
|       is_index_back=true, is_global_index=false,                                                                                                    |
|       calc_relevance=true, match_expr(MATCH(articles.content) AGAINST('OceanBase database')),                                                       |
|       pushdown_match_filter(MATCH(articles.content) AGAINST('OceanBase database'))                                                                  |
+-----------------------------------------------------------------------------------------------------------------------------------------------------+
15 rows in set (0.08 sec)
```

上記のAPシナリオにおける、データベース内での特殊なインデックス作成に関するベストプラクティスガイドを参考にしてください。これらのインデックスを適切に活用することで、データベースクエリの効率とパフォーマンスを向上させることができます。
