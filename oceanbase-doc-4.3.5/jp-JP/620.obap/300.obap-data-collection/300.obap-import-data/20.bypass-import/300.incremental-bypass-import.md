|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 増分ダイレクトロード

テーブルに既存データがある状態で増分データをインポートしたい場合、増分ダイレクトロード機能を利用できます。フルダイレクトロードでも増分データをインポートできますが、フルダイレクトロードで増分データをインポートする過程では、すべての元データをオーバーライドするため、インポートのパフォーマンスが低下します。増分ダイレクトロード機能は、フルダイレクトロードとは異なり、インポートのプロセスで増分データのみを操作するため、インポートのパフォーマンスを保証できます。

本記事では、`LOAD DATA`ステートメント、`INSERT INTO SELECT`ステートメント、`CREATE TABLE AS SELECT`ステートメントを使用して、増分ダイレクトロードを実現する方法について説明します。

## 注意点

ダイレクトロードを使用する際の注意点は、以下のとおりです：

* 増分ダイレクトロードのデータはダンプをトリガーするため、データ量が少なくて数分以内にインポートが完了する場合は、増分ダイレクトロードの使用は推奨されません。
* 増分ダイレクトロードは、ターゲットテーブルに非一意のローカルインデックスがある場合をサポートします。
* `LOAD DATA`ステートメントは複数行トランザクションでの実行をサポートしており、実行時に先行するトランザクションを自動的にコミットします。
* `INSERT INTO SELECT`ステートメントを使用してデータをダイレクトロードする場合は、PDML (Parallel Data Manipulation Language、並列データ操作言語)のみがサポートされており、非PDMLではダイレクトロードを使用できません。
* `LOAD DATA`ステートメントと `INSERT INTO SELECT`ステートメントで指定パーティションのダイレクトロードを使用する場合は、ターゲットテーブルはレプリケーションテーブルであってはならず、自動インクリメント列、識別列、Global Indexを含むことはできません。
* V4.3.5バージョンについて、V4.3.5 BP1バージョン以降の増分ダイレクトロードでは、以下の点が変更されています：

  * ターゲットテーブルのパーティションがHash/Keyパーティションの場合、パーティションレベルのダイレクトロードをサポートします。
  * ヒープテーブルにローカル一意のインデックスが1つある場合のみをサポートします。ターゲットテーブルに複数のローカル一意のインデックスまたはグローバル一意のインデックスが存在する場合、インポート操作は失敗します。
  * `LOAD DATA` / `INSERT INTO SELECT`ステートメントにおいて、複数のインポートタスクで重複するパーティションがある場合、パーティションの並列インポートはサポートされません。重複するパーティションがない場合、パーティションの並列インポートをサポートします。
  * セッション変数 [foreign_key_checks](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001972140)の値がFalseの場合、ダイレクトロード操作は外部キー制約の検証を実行しません。

## LOAD DATAステートメントを使用したデータのダイレクトロード

`LOAD DATA`ステートメントは `DIRECT()` ヒントを使用して増分ダイレクトロードを実行します。ヒントが指定されていない場合は、構成パラメータ [default_load_mode](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001976661)に基づいてデータインポート動作を決定します。

### 使用制限

* インポート中は同時に2つの書き込み操作ステートメントを実行できません(つまり、同じテーブルに同時に書き込むことはできません)。インポート中はテーブルがロックされて、インポート中はずっと読み取り操作のみ可能だからです。
* トリガー(Trigger)での使用はサポートされていません。
* 生成列を含むテーブルはサポートされていません(特定のインデックスは隠れた生成列を作成する場合があります。例：KEY `idx_c2` (`c2`(16)) GLOBAL)。
* 単一行で2MBを超えるデータのインポートはサポートされていません。
* Liboblogとフラッシュバッククエリ(Flashback Query)はサポートされていません。
* 外部キーを持つテーブルは、増分ダイレクトロードをサポートしません。

### 使用構文

```sql
LOAD DATA /*+ [DIRECT(need_sort,max_error,{'inc'|'inc_replace'})] parallel(N) */ [REMOTE_OSS | LOCAL] INFILE 'file_name' INTO TABLE table_name [PARTITION(PARTITION_OPTION)] [COMPRESSION]...
```

`LOAD DATA`構文の詳細については、[LOAD DATA](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974145)を参照してください。

**パラメータの説明：**

|パラメータ|説明|
|------|------|
| DIRECT() | ヒントを使用してダイレクトロード機能を有効にします。<code>DIRECT()</code> パラメータの説明は以下のとおりです：<ul><li><code>need_sort</code>：書き込まれるデータがソートを必要とするかどうかを表します。値は <code>bool</code> 型：<ul><li><code>true</code>：ソートが必要であることを表します。</li><li><code>false</code>：ソートが不要であることを表します。</li></ul></li><li><code>max_error</code>：許容される最大のエラー行数を表します。値は <code>INT</code> 型で、この値を超えるとインポートタスクの実行が失敗します。</li><li><code>inc\|inc_replace</code>：増分ダイレクトロードの2つのモードを表します。値は英語のシングルクォート(')で囲む必要があります。<ul><li><code>inc</code>：インクリメンタルインポートを表します。主キーの重複をチェックし、<code>INSERT</code> と <code>IGNORE</code> セマンティクスをサポートします。</li><li><code>inc_replace</code>：インクリメンタルインポートを表しますが、主キーの重複をチェックしません。<code>REPLACE</code> セマンティクスに相当するインクリメンタルインポートです。</li></ul></li></ul><main id="notice" type='notice'><h4>注意</h4><p><code>load_mode</code> が <code>inc_replace</code> の場合、<code>LOAD DATA</code> ステートメントで <code>REPLACE</code> または <code>IGNORE</code> キーワードは使用できません。</p></main>|
| parallel(N)         | 必須項目です。データロードの並列度で、デフォルトは4です。|
| REMOTE_OSS \| LOCAL | オプション項目です。<ul><li> <code>REMOTE_OSS</code> はオブジェクトストレージからデータを読み取るかどうかを指定するために使用されます。現在サポートされているオブジェクトストレージには、Alibaba Cloud OSS、AWS S3、およびOBS、GCS、COSなどのS3互換オブジェクトストレージが含まれます。</li><li> <code>LOCAL</code> は、クライアントのローカルファイルシステムからデータを読み取るかどうかを指定するために使用されます。</li><li><code>REMOTE_OSS</code> と <code>LOCAL</code> を使用しない場合、サーバー側(OBServerノード)のファイルシステムからデータを読み取ります。</li></ul> |
| file_name           | 入力ファイルのパスとファイル名を指定します。このパラメータ形式は <code>REMOTE_OSS \| LOCAL</code> のタイプと相互に対応しています：<ul><li><code>REMOTE_OSS</code> を指定した場合、<code>file_name</code> はインポートファイルがオブジェクトストレージ上にあることを表します。一般的にサポートされているオブジェクトストレージ形式は以下のとおりです：<ul><li><b>Alibaba Cloud OSS</b>：<code>LOAD DATA /\*+ [APPEND \| DIRECT(need_sort,max_error)] parallel(N) \*/ REMOTE_OSS INFILE 'oss://\$PATH/\$FILENAME/?host=\$HOST&access_id=\$ACCESS_ID&access_key=\$ACCESS_KEY' INTO TABLE table_name ...;</code></li><li><b>AWS S3</b>：<code>LOAD DATA /\*+ [APPEND \| DIRECT(need_sort,max_error)] parallel(N) \*/ REMOTE_OSS INFILE 's3://\$PATH/\$FILENAME/?host=\$HOST&access_id=\$ACCESS_ID&access_key=\$ACCESS_KEY&s3_region=S3_REGION' INTO TABLE table_name ...;</code></li><li><b>S3互換のオブジェクトストレージ</b>：<code>LOAD DATA /\*+ [APPEND \| DIRECT(need_sort,max_error)] parallel(N) \*/ REMOTE_OSS INFILE 's3://\$PATH/\$FILENAME/?host=\$HOST&access_id=\$ACCESS_ID&access_key=\$ACCESS_KEY' INTO TABLE table_name ...;</code></li></ul></li><li><code>LOCAL</code> を指定した場合、インポートファイルがクライアント上にあることを表します。この時の構文は <code>LOAD DATA /*+ [APPEND \| DIRECT(need_sort,max_error)] parallel(N) */ REMOTE_OSS INFILE '/\$PATH/\$FILENAME' INTO TABLE table_name ...;</code> です。</li><li><code>REMOTE_OSS</code> と <code>LOCAL</code> の両方を指定しない場合、インポートファイルがOBServerノード上にあることを表します。この場合、構文は <code>LOCAL</code> のみ指定した場合と同じです。</li></ul>上記の各パラメータの説明は以下のとおりです：<ul><li><code>\$PATH</code>：ストレージバケット内のファイルパスを指定します。ファイルが所在するディレクトリを表します。</li><li><code>\$FILENAME</code>：ファイル名を指定します。アクセスする具体的なファイルを表します。</li><li><code>\$HOST</code>：OSSサービスのホスト名またはCDN高速化のドメイン名を指定します。つまり、アクセスするOSSサービスのアドレスです。</li><li><code>\$ACCESS_ID</code>：OSSサービスへのアクセスに必要なAccess Key IDを指定します。認証に使用されます。</li><li><code>\$ACCESSKEY</code>：OSSサービスへのアクセスに必要なAccess Key Secretを指定します。認証に使用されます。</li><li><code>S3_REGION</code>：Amazon S3ストレージバケットが所在するリージョンを指定します。オブジェクトストレージがAWS S3の場合、必須指定パラメータです。</li></ul><main id="notice" type='explain'><h4>説明</h4> <p>OSS上のファイルをインポートする際は、以下の情報を確認する必要があります：<ul><li>OSSストレージバケットとファイルへのアクセス権限を確認します。指定されたストレージバケットとファイルを読み取るのに十分な権限が必要です。通常は、OSSコンソールまたはOSS APIを通じてアクセス権限を設定します。アクセスキー(Access Key IDとAccess Key Secret)を適切な権限を持つ認証情報として設定する必要があります。</li><li>データベースサーバーがネットワーク接続経由で指定された <code>$HOST</code> アドレスに接続し、OSSサービスにアクセスできることを確認してください。OSSサービスのCDN高速化ドメイン名を使用している場合は、CDN設定が正しく、ネットワーク接続が正常であることも確認する必要があります。</li></ul></p> </main>  |
| table_name                       | データをインポートするテーブル名。テーブルの任意の列数の指定できます。  |
| PARTITION_OPTION                 | パーティションダイレクトロード時のパーティション名を指定します：<ul><li>partition_option_list：パーティションのリスト。同時に複数のパーティションに挿入する場合はカンマ(,)で区切ります。 </li> <li>subpartition_option_list：サブパーティションのリスト。同時に複数のパーティションに挿入する場合はカンマ(,)で区切ります。</li></ul>|
| COMPRESSION                      | 圧縮ファイル形式を指定します。値は以下のとおりです：<ul><li><code>AUTO</code>：ファイル名のサフィックスに基づいて圧縮アルゴリズムを自動検出します。<br><code>AUTO</code> パラメータを使用する場合、サフィックス名ごとに対応する圧縮形式があります。<ul><li><code>.gz</code>GZIP圧縮ファイルに対応。</li><li><code>.deflate</code>：DEFLATE圧縮ファイルに対応。</li><li><code>.zst/.zstd</code>：ZSTD圧縮ファイルに対応。</li></ul></li><li><code>NONE</code>：ファイルが圧縮されていないことを表します。</li><li><code>GZIP</code>：GZIP圧縮ファイル。</li><li><code>DEFLATE</code>：メタデータなしのGZIP圧縮ファイル。</li><li><code>ZSTD</code>：ZSTD圧縮ファイル。</li></ul>ファイルの圧縮形式を明確に指定するか、プログラムによってファイル名のサフィックスに基づいて圧縮形式を検出させることができます。|

<main id="notice" type='explain'>
   <h4>説明</h4>
   <p><code>LOAD DATA</code>ステートメントの増分ダイレクトロードも、フルダイレクトロードと同様に、ワイルドカード方式での複数ファイルインポートをサポートします。ただし、<code>LOAD DATA</code>文のワイルドカードが有効なのはOBServerのローカルマシン上のみです（他のマシンからOBServerにログインして<code>LOAD DATA</code>文でワイルドカードを使用しても機能しません）。</p>
</main>

### 使用例

LOAD DATAステートメントの増分ダイレクトロードの操作手順は、フルダイレクトロードの手順と同じで、<code>full</code> フィールドの値を <code>inc</code> または <code>inc_replace</code> に置き換えるだけです。

  <main id="notice" type='explain'>
     <h4>説明</h4>
     <p>以下の例は、サーバー側のファイルからデータをインポートする方法です。OceanBaseデータベースの <code>LOAD DATA</code>ステートメントは、データのダイレクトロードに加えて、ローカルファイルの読み込み(<code>LOCAL INFILE</code>)もサポートしています。<code>LOAD DATA LOCAL INFILE</code> の詳細な例については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971206"><code>LOAD DATA</code>ステートメントを使用したデータインポート</a>を参照してください</p>
   </main>

:::tab
tab MySQLモード

1. OBServerノードが配置されているマシンにログインし、`/home/admin` ディレクトリにテストデータ `tbl1` を作成します。

    <main id="notice" type='explain'>
    <h4>説明</h4>
    <p>OceanBaseデータベースの <code>LOAD DATA</code>ステートメントは、OBServerノードのローカルにある入力ファイルの読み込みのみをサポートしています。そのため、インポートする前にファイルをいずれかのOBServerにコピーする必要があります。</p>
    </main>

    ```shell
    [xxx@xxx /home/admin]# ssh admin@10.10.10.1
    ```

    ```shell
    [admin@xxx /home/admin]# vi tbl1.csv
    1,11
    2,22
    3,33
    ```

2. インポートファイルのパスを設定します。

    システム変数 `secure_file_priv` を設定して、ファイルのインポートまたはエクスポート時にアクセス可能なパスを設定します。

    <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>セキュリティ上の理由により、システム変数 <code>secure_file_priv</code> を設定する場合は、ローカルソケット接続を介してデータベースに接続し、このグローバル変数を変更するSQLステートメントを実行する必要があります。詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001972189">secure_file_priv</a> を参照してください。</p>
    </main>

    1. 接続したいOBServerノードが配置されているマシンにログインします。

        ```shell
        [xxx@xxx /home/admin]# ssh admin@10.10.10.1
        ```

    2. 以下のコマンドを実行し、ローカルのUnixソケット接続メソッドを使用してテナント `mysql001` に接続します。

        ```shell
        obclient -S /home/admin/oceanbase/run/sql.sock -uroot@mysql001 -p******
        ```

    3. インポートパスを `/home/admin` に設定します。

        ```shell
        obclient [(none)]> SET GLOBAL secure_file_priv = "/home/admin";
        Query OK, 0 rows affected
        ```

3. データベースに再接続した後、`LOAD /*+ DIRECT */ DATA` ステートメントを使用してデータをインポートします。

    1. テーブル `tbl1` を作成します。

       ```shell
       obclient [test]> CREATE TABLE tbl1 (
                           col1 INT PRIMARY KEY,
                           col2 INT
                        )
                        PARTITION BY RANGE (col1)
                           SUBPARTITION BY RANGE (col1) (
                              PARTITION p0 VALUES LESS THAN (100) (
                                    SUBPARTITION p0_1 VALUES LESS THAN (50),
                                    SUBPARTITION p0_2 VALUES LESS THAN (100)
                              ),
                              PARTITION p1 VALUES LESS THAN (200) (
                                    SUBPARTITION p1_1 VALUES LESS THAN (150),
                                    SUBPARTITION p1_2 VALUES LESS THAN (200)
                              )
                        );
       Query OK, 0 rows affected
       ```

    2. テーブル `tbl1` にデータがあるかどうかをクエリします。テーブルが空であることが表示されます。

       ```shell
       obclient [test]> SELECT * FROM tbl1;
       Empty set
       ```

    3. ダイレクトロードを使用して、`tbl1.csv` ファイルのデータをテーブル `tbl1` にインポートします。

       * テーブル `tbl1` のすべての列を指定して、データをインポートします。

         ```shell
         obclient [test]> LOAD DATA /*+ direct(true,1024,'inc_replace') parallel(16) */ INFILE '/home/admin/tbl1.csv' INTO TABLE tbl1 FIELDS TERMINATED BY ',';
         Query OK, 3 rows affected
         Records: 3  Deleted: 0  Skipped: 0  Warnings: 0
         ```

       * テーブル `tbl1` の指定された任意の列を指定して、データをインポートします。例：`col1`、`col2` 列を指定。

         ```shell
         obclient [test]> LOAD DATA /*+ direct(true,1024,'inc_replace') parallel(16) */ INFILE '/home/admin/tbl1.csv' INTO TABLE tbl1 FIELDS TERMINATED BY ','(col1,col2);
         Query OK, 3 rows affected
         Records: 3  Deleted: 0  Skipped: 0  Warnings: 0
         ```

       * (オプション)テーブル `tbl1` のパーティションを指定して、データをインポートします。

         ```shell
         obclient [test]> LOAD DATA /*+ direct(true,1024,'inc_replace') parallel(16) */ INFILE '/home/admin/tbl1.csv' INTO TABLE tbl1 partition(p0, p1)  FIELDS TERMINATED BY ',';
         ```

       * (オプション)テーブル `tbl1` のサブパーティションを指定して、データをインポートします。

         ```shell
         obclient [test]> LOAD DATA /*+ direct(true,1024,'inc_replace') parallel(16) */ INFILE '/home/admin/tbl1.csv' INTO TABLE tbl1 partition(p0sp0_1, p1sp1_1)  FIELDS TERMINATED BY ',';
         ```

       * 構成パラメータ `default_load_mode` を使用して、データをインポートします。

         1. `default_load_mode` の値を `INC_DIRECT_WRITE` または `INC_REPLACE_DIRECT_WRITE` に設定します。

            ```shell
            obclient [test]> ALTER SYSTEM SET default_load_mode ='INC_DIRECT_WRITE';
            ```

         2. `LOAD DATA`ステートメントでヒントを指定しません。

            ```shell
            obclient [test]> LOAD DATA INFILE '/home/admin/tbl1.csv' INTO TABLE tbl2 FIELDS TERMINATED BY ',';
            ```

    4. テーブル `tbl1` にデータがインポートされているかどうかを検証します。

       ```shell
       obclient [test]>  SELECT * FROM tbl1;
       ```

       クエリ結果は以下のとおりです：

       ```shell
        +------+------+
        | col1 | col2 |
        +------+------+
        |    1 |   11 |
        |    2 |   22 |
        |    3 |   33 |
        +------+------+
        3 rows in set
       ```

       結果は、テーブル `tbl2` にデータがインポートされたことを示しています。

tab Oracleモード

1. OBServerノードが配置されているマシンにログインし、`/home/admin` ディレクトリにテストデータ `tbl1` を作成します。

    <main id="notice" type='explain'>
    <h4>説明</h4>
    <p>OceanBaseデータベースの <code>LOAD DATA</code>ステートメントは、OBServerノードのローカルにある入力ファイルの読み込みのみをサポートしています。そのため、インポートする前にファイルをいずれかのOBServerにコピーする必要があります。</p>
    </main>

    ```shell
    [xxx@xxx /home/admin]# ssh admin@10.10.10.1
    ```

    ```shell
    [admin@xxx /home/admin]# vi tbl1.csv
    1,11
    2,22
    3,33
    ```

2. インポートファイルのパスを設定します。

    システム変数 `secure_file_priv` を設定して、ファイルのインポートまたはエクスポート時にアクセス可能なパスを設定します。

    <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>セキュリティ上の理由により、システム変数 <code>secure_file_priv</code> を設定する場合は、ローカルソケット接続を介してデータベースに接続し、このグローバル変数を変更するSQLステートメントを実行する必要があります。詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001972189">secure_file_priv</a> を参照してください。</p>
    </main>

    1. 接続したいOBServerノードが配置されているマシンにログインします。

        ```shell
        [xxx@xxx /home/admin]# ssh admin@10.10.10.1
        ```

    2. 以下のコマンドを実行して、ローカルUnixソケット接続を介してテナント `oracle001` に接続します。

        ```shell
        obclient -S /home/admin/oceanbase/run/sql.sock -usys@oracle001 -p******
        ```

    3. インポートパスを `/home/admin` に設定します。

        ```shell
        obclient [(none)]> SET GLOBAL secure_file_priv = "/home/admin";
        Query OK, 0 rows affected
        ```

3. データベースに再接続した後、`LOAD /*+ DIRECT */ DATA` ステートメントを使用してデータをインポートします。

    1. テーブル `tbl2` を作成します。

       ```shell
       obclient [test]> CREATE TABLE tbl2 (
                           col1 INT PRIMARY KEY,
                           col2 INT
                        )
                        PARTITION BY RANGE (col1)
                           SUBPARTITION BY RANGE (col1) (
                              PARTITION p0 VALUES LESS THAN (100) (
                                    SUBPARTITION sp0_1 VALUES LESS THAN (50),
                                    SUBPARTITION sp0_2 VALUES LESS THAN (100)
                              ),
                              PARTITION p1 VALUES LESS THAN (200) (
                                    SUBPARTITION sp1_1 VALUES LESS THAN (150),
                                    SUBPARTITION sp1_2 VALUES LESS THAN (200)
                              )
                        );
       Query OK, 0 rows affected
       ```

    2. テーブル `tbl2` にデータがあるかどうかをクエリします。テーブルが空であることが表示されます。

       ```shell
       obclient [test]> SELECT * FROM tbl2;
       Empty set
       ```

    3. ダイレクトロードを使用して、`tbl1.csv` ファイルのデータをテーブル `tbl2` にインポートします。

       * テーブル `tbl2` のすべての列を指定して、データをインポートします。

         ```shell
         obclient [test]> LOAD DATA /*+ direct(true,1024,'inc_replace') parallel(16) */ INFILE '/home/admin/tbl1.csv' INTO TABLE tbl2 FIELDS TERMINATED BY ',';
         Query OK, 3 rows affected
         Records: 3  Deleted: 0  Skipped: 0  Warnings: 0
         ```

       * テーブル `tbl2` の指定された任意の列を指定して、データをインポートします。例：`col1`、`col2` 列を指定。

         ```shell
         obclient [test]> LOAD DATA /*+ direct(true,1024,'inc_replace') parallel(16) */ INFILE '/home/admin/tbl1.csv' INTO TABLE tbl2 FIELDS TERMINATED BY ','(col1,col2);
         Query OK, 3 rows affected
         Records: 3  Deleted: 0  Skipped: 0  Warnings: 0
         ```

       * (オプション)テーブル `tbl2` のパーティションを指定して、データをインポートします。

         ```shell
         obclient [test]> LOAD DATA /*+ direct(true,1024,'inc_replace') parallel(16) */ INFILE '/home/admin/tbl1.csv' INTO TABLE tbl2 partition(p0, p1)  FIELDS TERMINATED BY ',';
         ```

       * (オプション)テーブル `tbl2` のサブパーティションを指定して、データをインポートします。

         ```shell
         obclient [test]> LOAD DATA /*+ direct(true,1024,'inc_replace') parallel(16) */ INFILE '/home/admin/tbl1.csv' INTO TABLE tbl2 partition(p0sp0_1, p1sp1_1)  FIELDS TERMINATED BY ',';
         ```

       * 構成パラメータ `default_load_mode` を使用して、データをインポートします。

         1. `default_load_mode` の値を `INC_DIRECT_WRITE` または `INC_REPLACE_DIRECT_WRITE` に設定します。

            ```shell
            obclient [test]> ALTER SYSTEM SET default_load_mode ='INC_DIRECT_WRITE';
            ```

         2. `LOAD DATA`ステートメントでヒントを指定しません。

            ```shell
            obclient [test]> LOAD DATA INFILE '/home/admin/tbl1.csv' INTO TABLE tbl2 FIELDS TERMINATED BY ',';
            ```

    4. テーブル `tbl2` にデータがインポートされているかどうかを確認します。

       ```shell
       obclient [test]>  SELECT * FROM tbl2;
       ```

       クエリ結果は以下のとおりです：

       ```shell
        +------+------+
        | col1 | col2 |
        +------+------+
        |    1 |   11 |
        |    2 |   22 |
        |    3 |   33 |
        +------+------+
        3 rows in set
       ```

       結果は、テーブル `tbl2` にデータがインポートされたことを示しています。

:::

## INSERT INTO SELECTステートメントを使用したデータのダイレクトロード

`INSERT INTO SELECT`ステートメントは、`direct()` に加えて `enable_parallel_dml` ヒントを使用することにより、ダイレクトロードを実行します。ヒントが指定されていない場合は、構成パラメータ [default_load_mode](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001976661)に基づいてデータのインポート動作を決定します。

### 使用制限

* PDML (Parallel Data Manipulation Language、並列データ操作言語)のみがサポートされています。非PDMLではダイレクトロードを使用できません。並列DMLの詳細については、[並列DML](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001973796)を参照してください。
* インポート中は同時に2つの書き込み操作ステートメントを実行できません(つまり、同じテーブルに同時に書き込むことはできません)。インポート中はテーブルがロックされて、インポート中はずっと読み取り操作のみ可能だからです。
* トリガー(Trigger)での使用はサポートされていません。
* 生成列を含むテーブルはサポートされていません(特定のインデックスは隠れた生成列を作成する場合があります。例：KEY `idx_c2` (`c2`(16)) GLOBAL)。
* Liboblogとフラッシュバッククエリ(Flashback Query)はサポートされていません。
* インデックス(主キーを除く)を持つテーブルは、増分ダイレクトロードをサポートしません。
* 外部キーを持つテーブルは、増分ダイレクトロードをサポートしません。

### 使用構文

```sql
INSERT /*+ [DIRECT(need_sort,max_error,{'inc'|'inc_replace'})] enable_parallel_dml parallel(N) */ INTO  table_name [PARTITION(PARTITION_OPTION)] select_sentence
```

`INSERT INTO` 構文の詳細については、[INSERT (MySQLモード)](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974137)および [INSERT (Oracleモード)](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975129)を参照してください。

**パラメータの説明：**

|パラメータ|説明|
|------|------|
| DIRECT() | ヒントを使用してダイレクトロード機能を有効にします。<code>DIRECT()</code> パラメータの説明は以下のとおりです：<ul><li><code>need_sort</code>：書き込まれるデータがソートを必要とするかどうかを表します。値は <code>bool</code> 型：<ul><li><code>true</code>：ソートが必要であることを表します。</li><li><code>false</code>：ソートが不要であることを表します。</li></ul></li><li><code>max_error</code>：許容される最大のエラー行数を表します。値は <code>INT</code> 型で、この値を超えるとインポートタスクの実行が失敗します。</li><li><code>inc\|inc_replace</code>：増分ダイレクトロードの2つのモードを表します。値は英語のシングルクォート(')で囲む必要があります。<ul><li><code>inc</code>：インクリメンタルインポートを表します。主キーの重複をチェックし、<code>INSERT</code> と <code>IGNORE</code> セマンティクスをサポートします。</li><li><code>inc_replace</code>：インクリメンタルインポートを表しますが、主キーの重複をチェックしません。<code>REPLACE</code> セマンティクスに相当するインクリメンタルインポートです。</li></ul></li></ul>|
| enable_parallel_dml | データをロードする際の並列度。<main id="notice" type='explain'><h4>説明</h4><p>一般的に、並列DMLを有効にするためには、<code>enable_parallel_dml</code> ヒントと <code>parallel</code> ヒントを組み合わせて使用する必要があります。ただし、ターゲットテーブルのSchemaでテーブルレベルの並列度が指定されている場合は、<code>enable_parallel_dml</code> ヒントのみを指定するだけで十分です。</p></main>|
| parallel(N) | データをロードする際の並列度。必須項目で、値は1より大きい整数です。|
| table_name                       | データをインポートするテーブル名。テーブルの任意の列数の指定できます。  |
| PARTITION_OPTION                   | パーティションダイレクトロード時のパーティション名を指定します：<ul><li>partition_option_list：パーティションのリスト。同時に複数のパーティションに挿入する場合はカンマ(,)で区切ります。 </li> <li>subpartition_option_list：サブパーティションのリスト。同時に複数のパーティションに挿入する場合はカンマ(,)で区切ります。</li></ul>|

### 使用例

`INSERT INTO SELECT`ステートメントの増分ダイレクトロードの操作手順は、フルダイレクトロードの手順と同じで、<code>full</code> フィールドの値を <code>inc</code> または <code>inc_replace</code> に置き換えるだけです。

:::tab
tab MySQLモード

**例1：INSERT INTO SELECTを使用した増分ダイレクトロードの完全な例です。**

ダイレクトロードを使用して、テーブル `tbl2` の一部のデータをテーブル `tbl1` にインポートします。

1. テーブル `tbl1` にデータがあるかどうかをクエリします。テーブルが空であることが表示されます。

   ```shell
   obclient [test]> SELECT * FROM tbl1;
   Empty set
   ```

2. テーブル `tbl2` にデータがあるかどうかをクエリします。

   ```shell
   obclient [test]> SELECT * FROM tbl2;
   ```

   テーブル `tbl2` にデータがあることをクエリできます。

   ```shell
    +------+------+------+
    | col1 | col2 | col3 |
    +------+------+------+
    |    1 | a1   |   11 |
    |    2 | a2   |   22 |
    |    3 | a3   |   33 |
    +------+------+------+
    3 rows in set
   ```

3. ダイレクトロードを使用して、テーブル `tbl2` のデータをテーブル `tbl1` にインポートします。

   * `INSERT INTO SELECT`ステートメントのヒントを指定します。

     * パーティションを指定しないインポート。

         ```shell
         obclient [test]> INSERT /*+ DIRECT(true, 0, 'inc_replace') enable_parallel_dml parallel(16) */ INTO tbl1 SELECT t2.col1,t2.col3 FROM tbl2 t2;
         Query OK, 3 rows affected
         Records: 3  Duplicates: 0  Warnings: 0
         ```

     * (オプション)パーティションを指定するインポート。

         ```shell
         obclient [test]> INSERT /*+ DIRECT(true, 0, 'inc_replace') enable_parallel_dml parallel(16) */ INTO tbl1 partition(p0, p1) SELECT t2.col1,1 FROM tbl2 partition(p0, p1) t2;
         Query OK, 3 rows affected
         Records: 3  Duplicates: 0  Warnings: 0
         ```

         ```shell
         obclient [test]> INSERT /*+ DIRECT(true, 0, 'inc_replace') enable_parallel_dml parallel(16) */ INTO tbl1 partition(p0, p1) SELECT t2.col1,1 FROM tbl2 partition(p0sp0_1, p1sp1_1) t2;
         Query OK, 3 rows affected
         Records: 3  Duplicates: 0  Warnings: 0
         ```

   * `INSERT INTO SELECT`ステートメントでヒントを指定しません。

      構成パラメータ `default_load_mode` の値を `INC_DIRECT_WRITE` または `INC_REPLACE_DIRECT_WRITE` に設定します。

      ```shell
      obclient [test]> ALTER SYSTEM SET default_load_mode ='INC_DIRECT_WRITE';
      ```

      ```shell
      obclient [test]> INSERT INTO tbl1 SELECT t2.col1,t2.col3 FROM tbl1 t2;
      ```

4. テーブル `tbl1` にデータがインポートされているかどうかを検証します。

   ```shell
   obclient [test]> SELECT * FROM tbl1;
   ```

   クエリ結果は以下のとおりです：

   ```shell
    +------+------+
    | col1 | col2 |
    +------+------+
    |    1 |   11 |
    |    2 |   22 |
    |    3 |   33 |
    +------+------+
    3 rows in set
   ```

   結果は、テーブル `tbl1` にデータがインポートされたことを示しています。

5. (オプション) `EXPLAIN EXTENDED` ステートメントの戻り結果の `Note` で、ダイレクトロードでデータが書き込まれたかどうかを確認します。

    ```shell
    obclient [test]> EXPLAIN EXTENDED INSERT /*+ direct(true, 0, 'inc_replace') enable_parallel_dml parallel(16) */ INTO tbl1 SELECT t2.col1,t2.col3 FROM tbl2 t2;
    ```

    結果は次のとおりです：

    ```shell
    +--------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | Query Plan                                                                                                                                                   |
    +--------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ==============================================================================                                                                               |
    | |ID|OPERATOR                           |NAME           |EST.ROWS|EST.TIME(us)|                                                                               |
    | ------------------------------------------------------------------------------                                                                               |
    | |0 |PX COORDINATOR                     |               |3       |27          |                                                                               |
    | |1 |└─EXCHANGE OUT DISTR               |:EX10001       |3       |27          |                                                                               |
    | |2 |  └─INSERT                         |               |3       |26          |                                                                               |
    | |3 |    └─EXCHANGE IN DISTR            |               |3       |1           |                                                                               |
    | |4 |      └─EXCHANGE OUT DISTR (RANDOM)|:EX10000       |3       |1           |                                                                               |
    | |5 |        └─SUBPLAN SCAN             |ANONYMOUS_VIEW1|3       |1           |                                                                               |
    | |6 |          └─PX BLOCK ITERATOR      |               |3       |1           |                                                                               |
    | |7 |            └─TABLE FULL SCAN      |t2             |3       |1           |                                                                               |
    | ==============================================================================                                                                               |
    | Outputs & filters:                                                                                                                                           |
    | -------------------------------------                                                                                                                        |
    |   0 - output(nil), filter(nil), rowset=16                                                                                                                    |
    |   1 - output(nil), filter(nil), rowset=16                                                                                                                    |
    |       dop=16                                                                                                                                                 |
    |   2 - output(nil), filter(nil)                                                                                                                               |
    |       columns([{tbl1: ({tbl1: (tbl1.__pk_increment(0x7efa518277d0), tbl1.col1(0x7efa518119c0), tbl1.col3(0x7efa51811e00))})}]), partitions(p0),              |
    |       column_values([T_HIDDEN_PK(0x7efa51827c10)], [column_conv(INT,PS:(11,0),NULL,ANONYMOUS_VIEW1.col1(0x7efa51826f50))(0x7efa51828030)], [column_conv(INT, |
    |       PS:(11,0),NULL,ANONYMOUS_VIEW1.col3(0x7efa51827390))(0x7efa5182ff60)])                                                                                 |
    |   3 - output([T_HIDDEN_PK(0x7efa51827c10)], [ANONYMOUS_VIEW1.col1(0x7efa51826f50)], [ANONYMOUS_VIEW1.col3(0x7efa51827390)]), filter(nil), rowset=16          |
    |   4 - output([T_HIDDEN_PK(0x7efa51827c10)], [ANONYMOUS_VIEW1.col1(0x7efa51826f50)], [ANONYMOUS_VIEW1.col3(0x7efa51827390)]), filter(nil), rowset=16          |
    |       dop=16                                                                                                                                                 |
    |   5 - output([ANONYMOUS_VIEW1.col1(0x7efa51826f50)], [ANONYMOUS_VIEW1.col3(0x7efa51827390)]), filter(nil), rowset=16                                         |
    |       access([ANONYMOUS_VIEW1.col1(0x7efa51826f50)], [ANONYMOUS_VIEW1.col3(0x7efa51827390)])                                                                 |
    |   6 - output([t2.col1(0x7efa51825f10)], [t2.col3(0x7efa518267c0)]), filter(nil), rowset=16                                                                   |
    |   7 - output([t2.col1(0x7efa51825f10)], [t2.col3(0x7efa518267c0)]), filter(nil), rowset=16                                                                   |
    |       access([t2.col1(0x7efa51825f10)], [t2.col3(0x7efa518267c0)]), partitions(p0)                                                                           |
    |       is_index_back=false, is_global_index=false,                                                                                                            |
    |       range_key([t2.__pk_increment(0x7efa51856410)]), range(MIN ; MAX)always true                                                                            |
    | Used Hint:                                                                                                                                                   |
    | -------------------------------------                                                                                                                        |
    |   /*+                                                                                                                                                        |
    |                                                                                                                                                              |
    |       USE_PLAN_CACHE( NONE )                                                                                                                                 |
    |       PARALLEL(16)                                                                                                                                           |
    |       ENABLE_PARALLEL_DML                                                                                                                                    |
    |       DIRECT(TRUE, 0, 'INC_REPLACE')                                                                                                                         |
    |   */                                                                                                                                                         |
    | Qb name trace:                                                                                                                                               |
    | -------------------------------------                                                                                                                        |
    |   stmt_id:0, stmt_type:T_EXPLAIN                                                                                                                             |
    |   stmt_id:1, INS$1                                                                                                                                           |
    |   stmt_id:2, SEL$1                                                                                                                                           |
    | Outline Data:                                                                                                                                                |
    | -------------------------------------                                                                                                                        |
    |   /*+                                                                                                                                                        |
    |       BEGIN_OUTLINE_DATA                                                                                                                                     |
    |       PARALLEL(@"SEL$1" "t2"@"SEL$1" 16)                                                                                                                     |
    |       FULL(@"SEL$1" "t2"@"SEL$1")                                                                                                                            |
    |       USE_PLAN_CACHE( NONE )                                                                                                                                 |
    |       PARALLEL(16)                                                                                                                                           |
    |       ENABLE_PARALLEL_DML                                                                                                                                    |
    |       OPTIMIZER_FEATURES_ENABLE('4.3.3.0')                                                                                                                   |
    |       DIRECT(TRUE, 0, 'INC_REPLACE')                                                                                                                         |
    |       END_OUTLINE_DATA                                                                                                                                       |
    |   */                                                                                                                                                         |
    | Optimization Info:                                                                                                                                           |
    | -------------------------------------                                                                                                                        |
    |   t2:                                                                                                                                                        |
    |       table_rows:3                                                                                                                                           |
    |       physical_range_rows:3                                                                                                                                  |
    |       logical_range_rows:3                                                                                                                                   |
    |       index_back_rows:0                                                                                                                                      |
    |       output_rows:3                                                                                                                                          |
    |       table_dop:16                                                                                                                                           |
    |       dop_method:Global DOP                                                                                                                                  |
    |       avaiable_index_name:[tbl2]                                                                                                                             |
    |       stats info:[version=0, is_locked=0, is_expired=0]                                                                                                      |
    |       dynamic sampling level:0                                                                                                                               |
    |       estimation method:[DEFAULT, STORAGE]                                                                                                                   |
    |   Plan Type:                                                                                                                                                 |
    |       DISTRIBUTED                                                                                                                                            |
    |   Note:                                                                                                                                                      |
    |       Degree of Parallelism is 16 because of hint                                                                                                           |
    |       Direct-mode is enabled in insert into select                                                                                                           |
    +--------------------------------------------------------------------------------------------------------------------------------------------------------------+
    77 rows in set (0.009 sec)
    ```

**例2：Range-Hashコンポジット・パーティションテーブルに対して、パーティションを指定してデータをダイレクトロードします。**

ターゲットテーブルはサブパーティションです。パーティションはRange、サブパーティションはHashで、パーティションを指定して増分ダイレクトロードを行います。

1. RangeパーティションとHashサブパーティションの2つのパーティションを含むテーブル `tbl1` を作成します。

   ```shell
   obclient [test]> CREATE TABLE tbl1(col1 INT,col2 INT)
                     PARTITION BY RANGE COLUMNS(col1)
                        SUBPARTITION BY HASH(col2) SUBPARTITIONS 3 (
                           PARTITION p0 VALUES LESS THAN(10),
                           PARTITION p1 VALUES LESS THAN(20));
   ```

2. ダイレクトロードを使用して、テーブル `tbl2` のデータをテーブル `tbl1` の `p0`、`p1` パーティションにインポートします。

   ```shell
   obclient [test]> insert /*+ direct(true, 0, 'inc_replace') enable_parallel_dml parallel(3) append */ into tbl1 partition(p0,p1) select * from tbl2 where col1 <20;
   ```

tab Oracleモード

**例1：INSERT INTO SELECTを使用した増分ダイレクトロードの完全な例です。**

ダイレクトロードを使用して、テーブル `tbl4` の一部のデータをテーブル `tbl3` にインポートします。

1. テーブル `tbl3` にデータがあるかどうかをクエリします。テーブルが空であることが表示されます。

   ```shell
   obclient [test]> SELECT * FROM tbl3;
   Empty set
   ```

2. テーブル `tbl4` にデータがあるかどうかをクエリします。

   ```shell
   obclient [test]> SELECT * FROM tbl4;
   ```

   テーブル `tbl4` にデータがあることをクエリしました。

   ```shell
   +------+------+------+
   | COL1 | COL2 | COL3 |
   +------+------+------+
   |    1 | a1   |   11 |
   |    2 | a2   |   22 |
   |    3 | a3   |   33 |
   +------+------+------+
   3 rows in set (0.000 sec)
   ```

3. ダイレクトロードを使用して、テーブル `tbl4` のデータをテーブル `tbl3` にインポートします。

   * `INSERT INTO SELECT`ステートメントの ヒントを指定します。

     * パーティションを指定しないインポート。

         ```shell
         obclient [test]> INSERT /*+ direct(true, 0, 'inc_replace') enable_parallel_dml parallel(16) */ INTO tbl3 SELECT t2.col1, t2.col3 FROM tbl4 t2 WHERE ROWNUM <= 10000;
         Query OK, 3 rows affected
         Records: 3  Duplicates: 0  Warnings: 0
         ```

     * (オプション)パーティションを指定するインポート。

         ```shell
         obclient [test]> INSERT /*+ DIRECT(true, 0, 'inc_replace') enable_parallel_dml parallel(16) */ INTO tbl3 partition(p0, p1) SELECT t2.col1,1 FROM tbl4 partition(p0, p1) t2;
         Query OK, 3 rows affected
         Records: 3  Duplicates: 0  Warnings: 0
         ```

         ```shell
         obclient [test]> INSERT /*+ DIRECT(true, 0, 'inc_replace') enable_parallel_dml parallel(16) */ INTO tbl3 partition(p0, p1) SELECT t2.col1,1 FROM tbl4 partition(p0sp0_1, p1sp1_1) t2;
         Query OK, 3 rows affected
         Records: 3  Duplicates: 0  Warnings: 0
         ```

   * `INSERT INTO SELECT`ステートメントの ヒントを指定しません。

      構成パラメータ `default_load_mode` の値を `INC_DIRECT_WRITE` または `INC_REPLACE_DIRECT_WRITE` に設定します。

      ```shell
      obclient [test]> ALTER SYSTEM SET default_load_mode ='INC_DIRECT_WRITE';
      ```

      ```shell
      obclient [test]> INSERT INTO tbl3 SELECT t2.col1, t2.col3 FROM tbl4 t2 WHERE ROWNUM <= 10000;
      ```

4. テーブル `tbl3` にデータがインポートされているかどうかを検証します。

   ```shell
   obclient [test]> SELECT * FROM tbl3;
   ```

   クエリ結果は以下のとおりです：

   ```shell
   +------+------+
   | col1 | col3 |
   +------+------+
   |    1 |   11 |
   |    2 |   22 |
   |    3 |   33 |
   +------+------+
   3 rows in set
   ```

   結果は、テーブル `tbl3` にデータがインポートされたことを示しています。

5. (オプション) `EXPLAIN EXTENDED` ステートメントの戻り結果の `Note` で、ダイレクトロードでデータが書き込まれたかどうかを確認します。

    ```shell
    obclient [test]> EXPLAIN EXTENDED INSERT /*+ direct(true, 0, 'inc_replace') enable_parallel_dml parallel(16) */ INTO tbl3 SELECT t2.col1,t2.col3 FROM tbl4 t2 WHERE ROWNUM <= 10000;

    結果は次のとおりです：

    ```shell
    +--------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | Query Plan                                                                                                                                                         |
    +--------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | =========================================================================================                                                                          |
    | |ID|OPERATOR                                      |NAME           |EST.ROWS|EST.TIME(us)|                                                                          |
    | -----------------------------------------------------------------------------------------                                                                          |
    | |0 |PX COORDINATOR                                |               |3       |34          |                                                                          |
    | |1 |└─EXCHANGE OUT DISTR                          |:EX10002       |3       |33          |                                                                          |
    | |2 |  └─INSERT                                    |               |3       |32          |                                                                          |
    | |3 |    └─EXCHANGE IN DISTR                       |               |3       |7           |                                                                          |
    | |4 |      └─EXCHANGE OUT DISTR (RANDOM)           |:EX10001       |3       |7           |                                                                          |
    | |5 |        └─MATERIAL                            |               |3       |3           |                                                                          |
    | |6 |          └─SUBPLAN SCAN                      |ANONYMOUS_VIEW1|3       |3           |                                                                          |
    | |7 |            └─LIMIT                           |               |3       |3           |                                                                          |
    | |8 |              └─EXCHANGE IN DISTR             |               |3       |3           |                                                                          |
    | |9 |                └─EXCHANGE OUT DISTR          |:EX10000       |3       |1           |                                                                          |
    | |10|                  └─LIMIT                     |               |3       |1           |                                                                          |
    | |11|                    └─PX BLOCK ITERATOR       |               |3       |1           |                                                                          |
    | |12|                      └─COLUMN TABLE FULL SCAN|T2             |3       |1           |                                                                          |
    | =========================================================================================                                                                          |
    | Outputs & filters:                                                                                                                                                 |
    | -------------------------------------                                                                                                                              |
    |   0 - output(nil), filter(nil), rowset=16                                                                                                                          |
    |   1 - output(nil), filter(nil), rowset=16                                                                                                                          |
    |       dop=16                                                                                                                                                       |
    |   2 - output(nil), filter(nil)                                                                                                                                     |
    |       columns([{TBL3: ({TBL3: (TBL3.__pk_increment(0x7efaad22b0e0), TBL3.COL1(0x7efaad2123f0), TBL3.COL3(0x7efaad212830))})}]), partitions(p0),                    |
    |       column_values([T_HIDDEN_PK(0x7efaad22b520)], [column_conv(NUMBER,PS:(-1,0),NULL,ANONYMOUS_VIEW1.COL1(0x7efaad22a860))(0x7efaad22b930)], [column_conv(NUMBER, |
    |       PS:(-1,0),NULL,ANONYMOUS_VIEW1.COL3(0x7efaad22aca0))(0x7efaad233850)])                                                                                       |
    |   3 - output([T_HIDDEN_PK(0x7efaad22b520)], [ANONYMOUS_VIEW1.COL1(0x7efaad22a860)], [ANONYMOUS_VIEW1.COL3(0x7efaad22aca0)]), filter(nil), rowset=16                |
    |   4 - output([T_HIDDEN_PK(0x7efaad22b520)], [ANONYMOUS_VIEW1.COL1(0x7efaad22a860)], [ANONYMOUS_VIEW1.COL3(0x7efaad22aca0)]), filter(nil), rowset=16                |
    |       is_single, dop=1                                                                                                                                             |
    |   5 - output([ANONYMOUS_VIEW1.COL1(0x7efaad22a860)], [ANONYMOUS_VIEW1.COL3(0x7efaad22aca0)]), filter(nil), rowset=16                                               |
    |   6 - output([ANONYMOUS_VIEW1.COL1(0x7efaad22a860)], [ANONYMOUS_VIEW1.COL3(0x7efaad22aca0)]), filter(nil), rowset=16                                               |
    |       access([ANONYMOUS_VIEW1.COL1(0x7efaad22a860)], [ANONYMOUS_VIEW1.COL3(0x7efaad22aca0)])                                                                       |
    |   7 - output([T2.COL1(0x7efaad229470)], [T2.COL3(0x7efaad229f40)]), filter(nil), rowset=16                                                                         |
    |       limit(cast(FLOOR(cast(10000, NUMBER(-1, -85))(0x7efaad227ef0))(0x7efaad25ac30), BIGINT(-1, 0))(0x7efaad25b6d0)), offset(nil)                                 |
    |   8 - output([T2.COL1(0x7efaad229470)], [T2.COL3(0x7efaad229f40)]), filter(nil), rowset=16                                                                         |
    |   9 - output([T2.COL1(0x7efaad229470)], [T2.COL3(0x7efaad229f40)]), filter(nil), rowset=16                                                                         |
    |       dop=16                                                                                                                                                       |
    |  10 - output([T2.COL1(0x7efaad229470)], [T2.COL3(0x7efaad229f40)]), filter(nil), rowset=16                                                                         |
    |       limit(cast(FLOOR(cast(10000, NUMBER(-1, -85))(0x7efaad227ef0))(0x7efaad25ac30), BIGINT(-1, 0))(0x7efaad25b6d0)), offset(nil)                                 |
    |  11 - output([T2.COL1(0x7efaad229470)], [T2.COL3(0x7efaad229f40)]), filter(nil), rowset=16                                                                         |
    |  12 - output([T2.COL1(0x7efaad229470)], [T2.COL3(0x7efaad229f40)]), filter(nil), rowset=16                                                                         |
    |       access([T2.COL1(0x7efaad229470)], [T2.COL3(0x7efaad229f40)]), partitions(p0)                                                                                 |
    |       limit(cast(FLOOR(cast(10000, NUMBER(-1, -85))(0x7efaad227ef0))(0x7efaad25ac30), BIGINT(-1, 0))(0x7efaad25b6d0)), offset(nil), is_index_back=false,           |
    |        is_global_index=false,                                                                                                                                      |
    |       range_key([T2.__pk_increment(0x7efaad25a720)]), range(MIN ; MAX)always true                                                                                  |
    | Used Hint:                                                                                                                                                         |
    | -------------------------------------                                                                                                                              |
    |   /*+                                                                                                                                                              |
    |                                                                                                                                                                    |
    |       USE_PLAN_CACHE( NONE )                                                                                                                                       |
    |       PARALLEL(16)                                                                                                                                                 |
    |       ENABLE_PARALLEL_DML                                                                                                                                          |
    |       DIRECT(TRUE, 0, 'INC_REPLACE')                                                                                                                               |
    |   */                                                                                                                                                               |
    | Qb name trace:                                                                                                                                                     |
    | -------------------------------------                                                                                                                              |
    |   stmt_id:0, stmt_type:T_EXPLAIN                                                                                                                                   |
    |   stmt_id:1, INS$1                                                                                                                                                 |
    |   stmt_id:2, SEL$1                                                                                                                                                 |
    |   stmt_id:3, parent:SEL$1  > SEL$658037CB > SEL$DCAFFB86                                                                                                           |
    | Outline Data:                                                                                                                                                      |
    | -------------------------------------                                                                                                                              |
    |   /*+                                                                                                                                                              |
    |       BEGIN_OUTLINE_DATA                                                                                                                                           |
    |       PARALLEL(@"SEL$DCAFFB86" "T2"@"SEL$1" 16)                                                                                                                    |
    |       FULL(@"SEL$DCAFFB86" "T2"@"SEL$1")                                                                                                                           |
    |       USE_COLUMN_TABLE(@"SEL$DCAFFB86" "T2"@"SEL$1")                                                                                                               |
    |       MERGE(@"SEL$658037CB" < "SEL$1")                                                                                                                             |
    |       USE_PLAN_CACHE( NONE )                                                                                                                                       |
    |       PARALLEL(16)                                                                                                                                                 |
    |       ENABLE_PARALLEL_DML                                                                                                                                          |
    |       OPTIMIZER_FEATURES_ENABLE('4.3.3.0')                                                                                                                         |
    |       DIRECT(TRUE, 0, 'INC_REPLACE')                                                                                                                               |
    |       END_OUTLINE_DATA                                                                                                                                             |
    |   */                                                                                                                                                               |
    | Optimization Info:                                                                                                                                                 |
    | -------------------------------------                                                                                                                              |
    |   T2:                                                                                                                                                              |
    |       table_rows:3                                                                                                                                                 |
    |       physical_range_rows:3                                                                                                                                        |
    |       logical_range_rows:3                                                                                                                                         |
    |       index_back_rows:0                                                                                                                                            |
    |       output_rows:3                                                                                                                                                |
    |       table_dop:16                                                                                                                                                 |
    |       dop_method:Global DOP                                                                                                                                        |
    |       avaiable_index_name:[TBL4]                                                                                                                                   |
    |       stats info:[version=0, is_locked=0, is_expired=0]                                                                                                            |
    |       dynamic sampling level:0                                                                                                                                     |
    |       estimation method:[DEFAULT, STORAGE]                                                                                                                         |
    |   Plan Type:                                                                                                                                                       |
    |       DISTRIBUTED                                                                                                                                                  |
    |   Note:                                                                                                                                                            |
    |       Degree of Parallelism is 16 because of hint                                                                                                                 |
    |       Direct-mode is enabled in insert into select                                                                                                                 |
    |   Expr Constraints:                                                                                                                                                |
    |       cast(FLOOR(cast(10000, NUMBER(-1, -85))), BIGINT(-1, 0)) >= 1 result is TRUE                                                                                 |
    +--------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    96 rows in set (0.007 sec)
    ```

**例2：Range-Hashコンポジット・パーティションテーブルに対して、一次パーティションを指定してデータをダイレクトロードします。**

ターゲットテーブルはコンポジット・パーティションテーブルです。一次パーティションはRange、サブパーティションはHashで、一次パーティションを指定して増分ダイレクトロードを行います。

1. RangeパーティションとHashサブパーティションの2つのパーティションを含むテーブル `tbl1` を作成します。

   ```shell
   obclient [test]> CREATE TABLE tbl1_1 (
                        col1 INT,
                        col2 INT
                     )
                     PARTITION BY RANGE (col1)
                     SUBPARTITION BY HASH (col2)
                     SUBPARTITION TEMPLATE (
                        SUBPARTITION sp1,
                        SUBPARTITION sp2,
                        SUBPARTITION sp3
                     )
                     (
                        PARTITION p0 VALUES LESS THAN (10),
                        PARTITION p1 VALUES LESS THAN (20)
                     );
   ```

2. ダイレクトロードを使用して、テーブル `tbl2` のデータをテーブル `tbl1` の `p0`、`p1` パーティションにインポートします。

   ```shell
   obclient [test]> insert /*+ direct(true, 0, 'inc_replace') enable_parallel_dml parallel(3) append */ into tbl1 partition(p0,p1) select * from tbl2 where col1 <20;
   ```

:::

## CREATE TABLE AS SELECTステートメントを使用したデータのダイレクトロード

`CREATE TABLE AS SELECT`ステートメントは `DIRECT()` ヒントおよび `PARALLE()` ヒントを設定してダイレクトロードのデータロード方式を指定します。ヒントが指定されていない場合は、構成パラメータ [default_load_mode](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001976661)に基づいてデータインポート動作を決定します。

### 使用構文

```sql
CREATE /*+ [DIRECT(need_sort,max_error,{'inc'|'inc_replace'})] parallel(N) */ TABLE table_name [AS] select_sentence
```

`CREATE TABLE AS SELECT` 構文の詳細については、[CREATE TABLE (MySQLモード)](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974140)および [CREATE TABLE (Oracleモード)](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975088)を参照してください。

**パラメータの説明：**

|パラメータ|説明|
|------|------|
| DIRECT()      | ヒントを使用してダイレクトロード機能を有効にします。<code>DIRECT()</code> パラメータの説明は以下のとおりです：<ul><li><code>need_sort</code>：書き込まれるデータがソートを必要とするかどうかを表します。値は <code>bool</code> 型：<ul><li><code>true</code>：ソートが必要であることを表します。</li><li><code>false</code>：ソートが不要であることを表します。</li></ul></li><li><code>max_error</code>：許容される最大のエラー行数を表します。値は <code>INT</code> 型で、この値を超えるとインポートタスクの実行が失敗します。</li><li><code>inc\|inc_replace</code>：増分ダイレクトロードの2つのモードを表します。値は英語のシングルクォート(')で囲む必要があります。<ul><li><code>inc</code>：インクリメンタルインポートを表します。主キーの重複をチェックし、<code>INSERT</code> と <code>IGNORE</code> セマンティクスをサポートします。</li><li><code>inc_replace</code>：インクリメンタルインポートを表しますが、主キーの重複をチェックしません。<code>REPLACE</code> セマンティクスに相当するインクリメンタルインポートです。</li></ul></li></ul><main id="notice" type='notice'><h4>注意</h4><p><code>load_mode</code> が <code>inc_replace</code> の場合、<code>LOAD DATA</code> ステートメントで <code>REPLACE</code> または <code>IGNORE</code> キーワードは使用できません。</p></main>|
| parallel(N) | データをロードする際の並列度。必須項目で、値は1より大きい整数です。|

### 使用例

:::tab
tab MySQLモード

ダイレクトロードを使用して、テーブル `tbl1` のデータを他のテーブルにインポートします。

1. テーブル `tbl1` を作成します。

   ```shell
   obclient [test]> CREATE TABLE tbl1(c1 int);
   ```

2. テーブル `tbl1` にデータを挿入します。

   ```shell
   obclient [test]> INSERT INTO tbl1 VALUES (1),(2),(3);
   ```

3. テーブル `tbl1` のデータをクエリします。

   ```shell
   obclient [test]> SELECT * FROM tbl1;
   ```

   クエリ結果は以下のとおりです：

   ```shell
   +------+
   | c1   |
   +------+
   |    1 |
   |    2 |
   |    3 |
   +------+
   3 rows in set (0.027 sec)
   ```

4. ダイレクトロードを使用して、テーブル `tbl1` のデータをテーブル `tbl2` にインポートします。

   * `CREATE TABLE AS SELECT`ステートメントの ヒントを指定します。

      * `inc` ヒントを使用してデータをダイレクトロードします。

         ```shell
         obclient [test]> CREATE /*+ direct(true, 0, 'inc') parallel(4) */ TABLE tbl2 AS SELECT * FROM tbl1;
         ```

      * `inc_replace` ヒントを使用してデータをダイレクトロードします。

         ```shell
         obclient [test]> CREATE /*+ direct(true, 0, 'inc_replace') parallel(4) */ TABLE tbl2 AS SELECT * FROM tbl1;
         ```

   * `CREATE TABLE AS SELECT`ステートメントの ヒントを指定しません。

      構成パラメータ `default_load_mode` の値を `INC_DIRECT_WRITE` または `INC_REPLACE_DIRECT_WRITE` に設定します。

      ```shell
      obclient [test]> ALTER SYSTEM SET default_load_mode ='INC_DIRECT_WRITE';
      ```

      ```shell
      obclient [test]> CREATE TABLE tbl2 AS SELECT * FROM tbl1;
      ```

5. テーブル `tbl2` にデータがインポートされているかどうかを確認します。

   ```shell
   obclient [test]> SELECT * FROM tbl2;
   ```

   クエリ結果は以下のとおりです：

   ```shell
   +------+
   | c1   |
   +------+
   |    1 |
   |    3 |
   |    2 |
   +------+
   3 rows in set (0.050 sec)
   ```

   結果は、テーブル `tbl2` にデータがインポートされたことを示しています。

tab Oracleモード

ダイレクトロードを使用して、テーブル `tbl1` のデータを他のテーブルにインポートします。

1. テーブル `tbl1` を作成します。

   ```shell
   obclient [SYS]> CREATE TABLE tbl1(c1 int);
   ```

2. テーブル `tbl1` にデータを挿入します。

   ```shell
   obclient [SYS]> INSERT INTO tbl1 VALUES (1),(2),(3);
   ```

3. テーブル `tbl1` のデータをクエリします。

   ```shell
   obclient [SYS]> SELECT * FROM tbl1;
   ```

   クエリ結果は以下のとおりです：

   ```shell
   +------+
   | C1   |
   +------+
   |    1 |
   |    2 |
   |    3 |
   +------+
   3 rows in set (0.045 sec)
   ```

4. ダイレクトロードを使用して、テーブル `tbl1` のデータをテーブル `tbl2` にインポートします。

   * `CREATE TABLE AS SELECT`ステートメントの ヒントを指定します。

      * `inc` ヒントを使用してデータをダイレクトロードします。

         ```shell
         obclient [SYS]> CREATE /*+ direct(true, 0, 'inc') parallel(4) */ TABLE tbl2 AS SELECT * FROM tbl1;
         ```

      * `inc_replace` ヒントを使用してデータをダイレクトロードします。

         ```shell
         obclient [SYS]> CREATE /*+ direct(true, 0, 'inc_replace') parallel(4) */ TABLE tbl2 AS SELECT * FROM tbl1;
         ```

   * `CREATE TABLE AS SELECT`ステートメントの ヒントを指定しません。

      構成パラメータ `default_load_mode` の値を `INC_DIRECT_WRITE` または `INC_REPLACE_DIRECT_WRITE` に設定します。

      ```shell
      obclient [SYS]> ALTER SYSTEM SET default_load_mode ='INC_DIRECT_WRITE';
      ```

      ```shell
      obclient [SYS]> CREATE TABLE tbl2 AS SELECT * FROM tbl1;
      ```

5. テーブル `tbl2` にデータがインポートされているかどうかを確認します。

   ```shell
   obclient [SYS]> SELECT * FROM tbl2;
   ```

   クエリ結果は以下のとおりです：

   ```shell
   +------+
   | C1   |
   +------+
   |    3 |
   |    2 |
   |    1 |
   +------+
   3 rows in set (0.013 sec)
   ```

   結果は、テーブル `tbl2` にデータがインポートされたことを示しています。

:::

## 関連ドキュメント

* [テーブル間のデータ移行](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971214)
* [SQL実行計画の概要](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001973793)

* [接続方法の概要](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971653)

* [テーブルの削除](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001973679)
