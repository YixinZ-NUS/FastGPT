# OceanBaseルーティングポリシー設定ガイド

## 主なユースケースと解決策

### ケース1：TPとAPを区別できる場合(読み書き分離を推奨)

**概要**：業務において、オンライントランザクション(TP、例：注文処理)と分析(AP、例：ユーザー行動統計)を明確に区別でき、かつAP系の分析処理では結果整合性を許容できる場合には、ルーティングポリシーを用いてリソースを分離します。

**解決策**：

+ **読み書き分離の設定**：

    - **実装方法**：
        * TPリクエストを**リーダーレプリカ(Leader)**にルーティングし、トランザクションの一貫性と低レイテンシを保証します。
        * APリクエストをカラムストアレプリカントにルーティングします。これにより、APリクエストはカラムストア上で実行され、集計クエリが高速化されます。

 詳細は、ドキュメント[OceanBase読み書き分離の設定](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001973854)および[カラムストアレプリカの使用](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001976349)を参照してください。

+ **フォロワー優先読み取りポリシー**：

    - **実装方法**：AP系のクエリはフォロワーレプリカ(Follower)から優先的に読み取り、リーダーレプリカはTPリクエストのみを処理します。

詳細は、ドキュメント[フォロワー優先読み取りの設定](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001973853)を参照してください。

#### ケース2：TPとAPを分離できない場合

**概要**：AP系の分析処理で強力な整合性が求められる、あるいはTPとAPの業務を切り分けることが困難な場合。

**解決策**：

+ **実装方法**：すべてのリクエストをリーダーレプリカ(Leader)に強制的にルーティングします。例えば、以下のパラメータを設定します。

```sql
-- 弱い整合性での読み取りを無効化
SET GLOBAL OB_READ_CONSISTENCY='STRONG';
```

<main id="notice" >
<h4>注意</h4>
<p>クラウド版のOceanBaseデータベースは、OceanBaseデータベースの挙動が一部異なります。クラウド版ではプライマリエンドポイント(primary endpoint、OceanBase Cloud独自の概念)に直接接続するため、すべてのリクエストはデフォルトで強力な整合性でルーティングされます。ただし、この設定ではAP系のクエリがリーダーレプリカのリソースを占有してしまう可能性があるため、クラウドコンソールからリソースグループの分離を有効にする必要があります。詳細は、<a href="https://www.oceanbase.com/docs/common-oceanbase-cloud-1000000001018073">OceanBase Cloudプライマリエンドポイントの設定</a>を参照してください。</p>
</main>

## その他のルーティングポリシー

| **ポリシーの種類** | **適用シナリオ** |
| --- | --- |
| **LDCルーティング** | 複数リージョンにまたがるデプロイメントで、最寄りのレプリカにアクセスする |
| **重み付けルーティング** | ノードの負荷に応じて動的にリクエストを分散する |
| **ランダムルーティング** | 読み取りリクエストをすべての利用可能なレプリカに均等に分散する |

詳細は、ドキュメント[ODPルーティングのベストプラクティス](https://en.oceanbase.com/docs/common-best-practices-10000000001797707)を参照してください。

### おすすめのドキュメント

+ クラウドをご利用の場合：[OceanBase Cloudドキュメント](https://www.oceanbase.com/docs/common-oceanbase-cloud-1000000001018073)をご参照ください。
+ [ODPの読み書き分離ルーティングポリシー](https://en.oceanbase.com/docs/community-odp-en-10000000001007328)
+ [OceanBaseの読み書き分離におけるベストプラクティス](https://en.oceanbase.com/docs/common-best-practices-10000000001714402)
+ [OceanBase APシナリオにおける読み書き分離の設定ガイド](https://en.oceanbase.com/docs/common-best-practices-10000000002470747)
