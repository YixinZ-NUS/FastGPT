|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|

# Go

本記事では、Goアプリケーションのサンプルで、Go-SQL-Driver/MySQLドライバーを使用してOceanBase データベースに接続し、使用する方法について説明します。

## 前提条件

ローカル環境にGo言語がデプロイされていることを確認してください。

## Goアプリケーションの作成

### ステップ1：データベース接続文字列の取得

OceanBase データベースのデプロイ担当者または管理者から、該当するデータベース接続文字列を取得します。例：

```sql
obclient  -h100.88.xx.xx -uroot@test -p****** -P2881 -Doceanbase
```

データベース接続文字列には、データベースへのアクセスに必要なパラメータ情報が含まれています。アプリケーションを作成する前に、データベース接続文字列を用いてデータベースへのログインを検証し、接続文字列のパラメータが正確であるか確認することができます。

パラメータの説明：

* **-h**：OceanBaseデータベースへの接続IPアドレス。ODP (OceanBase Database Proxy)のアドレスである場合もあります。
* **-u**：テナントの接続ユーザー名。書式は**ユーザー@テナント#クラスタ名**となります。クラスタのデフォルトテナントは'sys'、テナントのデフォルト管理者ユーザーは'root'です。データベースに直接接続する場合は、クラスタ名の部分は不要ですが、ODP経由で接続する場合は指定する必要があります。
* **-p**：ユーザーのパスワードです。
* **-P**：OceanBaseデータベースの接続ポート番号であり、ODPのリスニングポートでもあります。
* * **-D**：接続対象のデータベース名です。

### ステップ2：Go-SQL-Driver/MySQLのインストール

Go言語のバージョンによって、インストール方法は異なります。

#### go getによるインストール (Go V1.13 ～ V1.16に適用)

インストールコマンドは以下のとおりです：

```bash
go get -u github.com/go-sql-driver/mysql
```

`Go-SQL-Driver/MySQL`の詳細については、[Github](https://github.com/go-sql-driver/mysql)を参照してください。

#### go installによるインストール

バージョンまたはネットワークの問題により、`go get`コマンドを使ってインストールできない場合は、以下の方法で`go-sql-driver/mysql`をインストールすることができます。

1. `go/src`ディレクトリに移動し、GitHub上にある`go-sql-driver/mysql`のリポジトリをクローンします。

    ```bash
    cd /usr/local/go/src
    git clone https://github.com/go-sql-driver/mysql.git
    ```

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p><code>/usr/local/go/src</code> の部分は、ご自身の環境でGoが実際にインストールされているディレクトリパスに置き換えて操作してください。</p>
   </main>

2. `go install` コマンド使用してインストールします。

    ```bash
    go install mysql
    ```

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>Goのバージョンによっては、<code>go install</code>がデフォルトでパッケージを探すディレクトリが<code>/src</code>ではない場合があります。その際は、<code>go install</code>の実行時に表示されるエラーメッセージで、実際に参照しているディレクトリを確認する必要があります。例えば、<code>cannot find package &quot;mysql&quot; in: /usr/local/go/src/vendor/mysql</code> というエラーが表示された場合、<code>mysql</code>フォルダを<code>/src/vendor</code>ディレクトリ配下に配置してから、再度インストールコマンドを実行してください。</p>
   </main>

### ステップ3：アプリケーションの作成

サンプルファイル`test.go`を作成します。コードは以下のとおりです：

```go
package main

import (
    "database/sql"
    "fmt"
    "log"

    _ "mysql"
    //go-sql-driver/mysqlのインストールパスを正確に入力してください。srcディレクトリにインストールした場合、"mysql"と直接記述できます。
)

type Str struct {
    Name       string
}

func main() {
    select_all()
    }

func select_all() {
    conn := "root:@tcp(127.0.0.1:2881)/test"
    db, err := sql.Open("mysql", conn)
    if err != nil {
        log.Fatal(err)
    }

    defer db.Close()

    if err != nil {
        log.Fatal(err)
    }
    fmt.Printf("success to connect OceanBase with go_mysql driver\n")
    //t1を作成
    db.Query("create table t1(str varchar(256))")
    //データを挿入
    db.Query("insert into  t1 values ('Hello OceanBase')")
    //データを検索
    res, err := db.Query("SELECT * FROM t1")
    //t1を削除
    db.Query("drop table t1")
    if err != nil {
        log.Fatal(err)
    }

    defer res.Close()

    if err != nil {
        log.Fatal(err)
    }

    for res.Next() {

        var str Str
        res.Scan(&str.Name)
        fmt.Printf("%s\n", str.Name)
    }
}
```

コード内のデータベース接続パラメータ、ご自身の環境に合わせて修正してください。以下の項目を参考に、「ステップ1」で取得したデータベース接続文字列の対応する値を設定します。

```go
//フォーマット
conn := "{username}:{password}@tcp({hostname}:{port})/{dbname}"
//例
conn := "root:@tcp(127.0.0.1:2881)/test"
```

パラメータの説明：

* **username**：`-u`の値を使用します。テナントの接続ユーザー名で、書式は**ユーザー@テナント#クラスタ名**となります。クラスタのデフォルトテナントは'sys'、テナントのデフォルト管理者ユーザーは'root'です。データベースに直接接続する場合は、クラスタ名の部分は不要ですが、ODP経由で接続する場合は指定する必要があります。

* **password**：`-p`の値を使用します。ユーザーのパスワードです。

* **host**：`-h`の値を使用します。OceanBaseデータベースへの接続IPアドレス。ODP (OceanBase Database Proxy)のアドレスである場合もあります。

* **port**：`-P`の値を使用します。OceanBaseデータベースの接続ポート番号であり、ODPのリスニングポートでもあります。

* **dbname**：`-D`の値を使用します。接続対象のデータベース名です。

### ステップ4：アプリケーションの実行

コードの編集が完了したら、以下のコマンドで実行が可能になります：

```bash
//一時的な環境変数の設定です。Goが実際にインストールされているパスを記述してください。
export PATH=$PATH:/usr/local/go/bin

//go runコマンドでgoファイルを実行する
go run test.go

//または、go buildでバイナリファイルを作成して実行する
go build test.go
./test
```

実行後、以下の内容が返された場合は、データベースへの接続に成功し、サンプル文が正しく実行されたことを意味します：

```bash
success to connect OceanBase with go_mysql driver
Hello OceanBase
```

## 詳細情報

OceanBaseデータベースのオープンソースコミュニティには、Go サンプルアプリケーションの完全なサンプルも用意されています。詳細については、[Go サンプルアプリケーション](https://github.com/oceanbase/ob-samples/tree/master/golang/go-sql-driver)を参照してください。
