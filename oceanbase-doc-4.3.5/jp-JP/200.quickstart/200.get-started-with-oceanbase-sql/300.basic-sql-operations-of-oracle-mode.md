|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|Oracle Mode|

# SQLの基本操作(Oracleモード)

この記事では、OceanBaseデータベースのOracleモードにおける基本的なSQL操作について説明します。

  <main id="notice" >
    <h4>適用対象</h4>
    <p>この内容はOceanBaseデータベースEnterprise Editionにのみ適用されます。OceanBaseデータベースCommunity Editionは、MySQLモードのみご利用いただけます。</p>
  </main>

## テーブルの操作

このセクションでは、データベースでのテーブルの作成、表示、変更、削除に関する構文と例を示します。

### テーブルの作成

`CREATE TABLE`文を使用して、データベースに新しいテーブルを作成します。

例：テーブル`test`を作成します。

```sql
obclient> CREATE TABLE test (c1 INT PRIMARY KEY, c2 VARCHAR(3));
Query OK, 0 rows affected
```

`CREATE TABLE`文に関する構文の詳細については、[CREATE TABLE](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975088)を参照してください。

### テーブルの変更

`ALTER TABLE`文を使用して、既存のテーブルの構造を変更します。これには、テーブルおよびテーブル属性の変更、列の追加、列および属性の変更、列の削除などが含まれます。

例：

* テーブル`test`の列`c2`のデータ型を変更します。

  ```sql
  obclient> DESCRIBE test;
  +-------+-------------+------+-----+---------+-------+
  | FIELD | TYPE        | NULL | KEY | DEFAULT | EXTRA |
  +-------+-------------+------+-----+---------+-------+
  | C1    | NUMBER(38)  | NO   | PRI | NULL    | NULL  |
  | C2    | VARCHAR2(3) | YES  | NULL| NULL    | NULL  |
  +-------+-------------+------+-----+---------+-------+
  2 rows in set

  obclient> ALTER TABLE test MODIFY c2 CHAR(10);
  Query OK, 0 rows affected

  obclient> DESCRIBE test;
  +-------+------------+------+-----+---------+-------+
  | FIELD | TYPE       | NULL | KEY | DEFAULT | EXTRA |
  +-------+------------+------+-----+---------+-------+
  | C1    | NUMBER(38) | NO   | PRI | NULL    | NULL  |
  | C2    | CHAR(10)   | YES  | NULL| NULL    | NULL  |
  +-------+------------+------+-----+---------+-------+
  2 rows in set
  ```

* テーブル`test`に列を追加、および削除します。

  ```sql
  obclient> ALTER TABLE test ADD c3 int;
  Query OK, 0 rows affected

  obclient> DESCRIBE test;
  +-------+------------+------+-----+---------+-------+
  | FIELD | TYPE       | NULL | KEY | DEFAULT | EXTRA |
  +-------+------------+------+-----+---------+-------+
  | C1    | NUMBER(38) | NO   | PRI | NULL    | NULL  |
  | C2    | CHAR(10)   | YES  | NULL| NULL    | NULL  |
  | C3    | NUMBER(38) | YES  | NULL| NULL    | NULL  |
  +-------+------------+------+-----+---------+-------+
  3 rows in set

  obclient> ALTER TABLE test DROP COLUMN c3;
  Query OK, 0 rows affected

  obclient> DESCRIBE test;
  +-------+------------+------+-----+---------+-------+
  | FIELD | TYPE       | NULL | KEY | DEFAULT | EXTRA |
  +-------+------------+------+-----+---------+-------+
  | C1    | NUMBER(38) | NO   | PRI | NULL    | NULL  |
  | C2    | CHAR(10)   | YES  | NULL| NULL    | NULL  |
  +-------+------------+------+-----+---------+-------+
  2 rows in set
  ```

`ALTER TABLE`文に関する構文の詳細については、[ALTER TABLE](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975084)を参照してください。

### テーブルの削除

`DROP TABLE`文を使用して、テーブルを削除します。

例：テーブル`test`を削除します。

```sql
obclient> DROP TABLE test;
Query OK, 0 rows affected
```

`DROP TABLE`文に関する構文の詳細については、[DROP TABLE](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975084)を参照してください。

## インデックスの操作

インデックスは、テーブル上に作成されて、データベーステーブルの一列または複数列の値を並べ替えたものです。その主な役割は、クエリの速度を向上させ、データベースシステムのパフォーマンス負荷を低減することにあります。

### インデックスの作成

`CREATE INDEX`文を使用して、テーブルのインデックスを作成します。

例：テーブル`test`のインデックスを作成します。

```sql
obclient> DESCRIBE test;
+-------+------------+------+-----+---------+-------+
| FIELD | TYPE       | NULL | KEY | DEFAULT | EXTRA |
+-------+------------+------+-----+---------+-------+
| C1    | NUMBER(38) | NO   | PRI | NULL    | NULL  |
| C2    | CHAR(10)   | YES  | NULL| NULL    | NULL  |
+-------+------------+------+-----+---------+-------+
2 rows in set

obclient> CREATE INDEX test_index ON test (c1, c2);
Query OK, 0 rows affected
```

`CREATE INDEX`文に関する構文の詳細については、[CREATE INDEX](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975098)を参照してください。

### インデックスの確認

* ビュー`ALL_INDEXES`を使用して、テーブルのすべてのインデックスを確認します。

  ```sql
  obclient> SELECT OWNER,INDEX_NAME,INDEX_TYPE,TABLE_OWNER,TABLE_NAME FROM ALL_INDEXES WHERE table_name='TEST'\G
  *************************** 1. row ***************************
                    OWNER: SYS
              INDEX_NAME: TEST_OBPK_1664353339491130
              INDEX_TYPE: NORMAL
              TABLE_OWNER: SYS
              TABLE_NAME: TEST
  *************************** 2. row ***************************
                    OWNER: SYS
              INDEX_NAME: TEST_INDEX
              INDEX_TYPE: NORMAL
              TABLE_OWNER: SYS
              TABLE_NAME: TEST
  2 rows in set
  ```

* `USER_IND_COLUMNS`を使用して、テーブルインデックスの詳細を確認します。

  ```sql
  obclient> SELECT * FROM USER_IND_COLUMNS WHERE table_name='TEST'\G
  *************************** 1. row ***************************
          INDEX_NAME: TEST_OBPK_1664353339491130
          TABLE_NAME: TEST
        COLUMN_NAME: C1
    COLUMN_POSITION: 1
      COLUMN_LENGTH: 22
        CHAR_LENGTH: 0
            DESCEND: ASC
  COLLATED_COLUMN_ID: NULL
  *************************** 2. row ***************************
          INDEX_NAME: TEST_INDEX
          TABLE_NAME: TEST
        COLUMN_NAME: C1
    COLUMN_POSITION: 1
      COLUMN_LENGTH: 22
        CHAR_LENGTH: 0
            DESCEND: ASC
  COLLATED_COLUMN_ID: NULL
  *************************** 3. row ***************************
          INDEX_NAME: TEST_INDEX
          TABLE_NAME: TEST
        COLUMN_NAME: C2
    COLUMN_POSITION: 2
      COLUMN_LENGTH: 10
        CHAR_LENGTH: 10
            DESCEND: ASC
  COLLATED_COLUMN_ID: NULL
  3 rows in set
  ```

### インデックスの削除

`DROP INDEX`文を使用して、テーブルのインデックスを削除します。

例：インデックス`test_index`を削除します。

```sql
obclient> DROP INDEX test_index;
Query OK, 0 rows affected
```

`DROP INDEX`文に関する構文の詳細については、[DROP INDEX](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975119)を参照してください。

## データの挿入

`INSERT`文を使用して、テーブルに一つまたは複数のレコードを追加します。

例：

* `CREATE TABLE`を使用して、テーブル`t1`を作成し、1行のデータを挿入します。

  ```sql
  obclient> CREATE TABLE t1(c1 INT PRIMARY KEY, c2 INT);
  Query OK, 0 rows affected

  obclient> SELECT * FROM t1;
  Empty set

  obclient> INSERT INTO t1 VALUES(1,1);
  Query OK, 1 row affected

  obclient> SELECT * FROM t1;
  +----+------+
  | c1 | c2   |
  +----+------+
  |  1 |    1 |
  +----+------+
  1 row in set
  ```

* サブクエリにデータを直接挿入します。

  ```sql
  obclient> INSERT INTO (SELECT * FROM t1) VALUES(2,2);
  Query OK, 1 row affected

  obclient> SELECT * FROM t1;
  +----+------+
  | C1 | C2   |
  +----+------+
  |  1 |    1 |
  |  2 |    2 |
  +----+------+
  2 rows in set
  ```

* `RETURNING`句を含むデータ挿入します。

  ```sql
  obclient> INSERT INTO t1 VALUES(3,3) RETURNING c1;
  +----+
  | C1 |
  +----+
  |  3 |
  +----+
  1 row in set

  obclient> SELECT * FROM t1;
  +----+------+
  | C1 | C2   |
  +----+------+
  |  1 |    1 |
  |  2 |    2 |
  |  3 |    3 |
  +----+------+
  3 rows in set
  ```

`INSERT`文に関する構文の詳細については、[INSERT](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975129)を参照してください。

## データの削除

`DELETE`文を使用して、データを削除します。

例：テーブル`t1`から`c1 = 2`の行を削除します。

```sql
obclient> DELETE FROM t1 WHERE c1 = 2;
Query OK, 1 row affected

obclient> SELECT * FROM t1;
+----+------+
| C1 | C2   |
+----+------+
|  1 |    1 |
|  3 |    3 |
+----+------+
2 rows in set
```

`DELETE`文に関する構文の詳細については、[DELETE](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975130)を参照してください。

## データの更新

`UPDATE`文を使用して、テーブルのフィールド値を変更します。

例:

* テーブル`t1`の`t1.c1 = 1`に該当する行について、`c2`列の値を`100`に変更します。

  ```sql
  obclient> UPDATE t1 SET t1.c2 = 100 WHERE t1.c1 = 1;
  Query OK, 1 row affected
  Rows matched: 1  Changed: 1  Warnings: 0

  obclient> SELECT * FROM t1;
  +----+------+
  | C1 | C2   |
  +----+------+
  |  1 |  100 |
  |  3 |    3 |
  +----+------+
  2 rows in set
  ```

* 更新対象としてサブクエリを指定し、`v.c1 = 3`の条件で`c2`列の値を`300`に変更します。

  ```sql
  obclient> UPDATE (SELECT * FROM t1) v SET v.c2 = 300 WHERE v.c1 = 3;
  Query OK, 1 row affected
  Rows matched: 1  Changed: 1  Warnings: 0

  obclient> SELECT * FROM t1;
  +----+------+
  | C1 | C2   |
  +----+------+
  |  1 |  100 |
  |  3 |  300 |
  +----+------+
  2 rows in set
  ```

`UPDATE`文に関する構文の詳細については、[UPDATE](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975124) の章を参照してください。

## データの照会

`SELECT`文を使用して、テーブルの内容を照会します。

例：

* `CREATE TABLE`を使用して、テーブル`t2`を作成します。テーブル`t2`から`name`データを読み取ります。

  ```sql
  obclient> CREATE TABLE t2 (id INT, name VARCHAR(50), num INT);
  Query OK, 0 rows affected

  obclient> INSERT INTO t2 VALUES(1,'a',100),(2,'b',200),(3,'a',50);
  Query OK, 3 rows affected
  Records: 3  Duplicates: 0  Warnings: 0

  obclient> SELECT * FROM t2;
  +------+------+------+
  | ID   | NAME | NUM  |
  +------+------+------+
  |    1 | a    |  100 |
  |    2 | b    |  200 |
  |    3 | a    |   50 |
  +------+------+------+
  3 rows in set

  obclient> SELECT name FROM t2;
  +------+
  | NAME |
  +------+
  | a    |
  | b    |
  | a    |
  +------+
  3 rows in set
  ```

* クエリ結果の中から、`name`の重複を除外します。

  ```sql
  obclient> SELECT DISTINCT name FROM t2;
  +------+
  | NAME |
  +------+
  | a    |
  | b    |
  +------+
  2 rows in set
  ```

* テーブル`t2`から、`name = 'a'`の条件に一致する`id`、`name`、`num`を取得します。

  ```sql
  obclient> SELECT id, name, num FROM t2 WHERE name = 'a';
  +------+------+------+
  | ID   | NAME | NUM  |
  +------+------+------+
  |    1 | a    |  100 |
  |    3 | a    |   50 |
  +------+------+------+
  2 rows in set
  ```

`SELECT`文に関する構文の詳細については、[SELECT](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001976262)を参照してください。

## トランザクションのコミット

`COMMIT`文を使用して、トランザクションをコミットします。

トランザクションをコミットするまで、現在のセッションでのみ表示可能であり、他のデータベースセッションからは見えません。変更内容は永続化されていませんので、`ROLLBACK`文を使用してロールバックすることができます。

トランザクションをコミットすると、行った変更は、すべてのデータベースセッションから参照可能になります。変更は永続化に成功し、`ROLLBACK`文を使用してロールバックすることができません。

例：`CREATE TABLE`文を使用して、テーブル`t_insert`を作成します。`COMMIT`文を使用して、トランザクションをコミットします。

```sql
obclient> CREATE TABLE t_insert(
     id number NOT NULL PRIMARY KEY,
     name varchar(10) NOT NULL,
     value number NOT NULL,
     gmt_create date NOT NULL DEFAULT sysdate
 );
Query OK, 0 rows affected

obclient> INSERT INTO t_insert(id, name, value, gmt_create) VALUES(1,'CN',10001, sysdate),(2,'US',10002, sysdate),(3,'EN',10003, sysdate);
Query OK, 3 rows affected
Records: 3  Duplicates: 0  Warnings: 0

obclient> SELECT * FROM t_insert;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 22-AUG-22  |
|  2 | US   | 10002 | 22-AUG-22  |
|  3 | EN   | 10003 | 22-AUG-22  |
+----+------+-------+------------+
3 rows in set

obclient> INSERT INTO t_insert(id, name, value) VALUES(4,'JP',10004);
Query OK, 1 row affected

obclient> COMMIT;
Query OK, 0 rows affected

obclient> exit;
Bye

obclient> obclient -h127.0.0.1 -us**@oracle -P2881 -p******

obclient> SELECT * FROM t_insert;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 22-AUG-22  |
|  2 | US   | 10002 | 22-AUG-22  |
|  3 | EN   | 10003 | 22-AUG-22  |
|  4 | JP   | 10004 | 22-AUG-22  |
+----+------+-------+------------+
4 rows in set
```

トランザクション制御文に関する詳細は、[トランザクション管理の概要](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971687)を参照してください。

## トランザクションのロールバック

`ROLLBACK`文を使用して、トランザクションをロールバックすることができます。

トランザクションのロールバックとは、トランザクションのすべての変更内容を取り消すことを意味します。コミットされていない現在のトランザクション全体をロールバックすることも、トランザクション内の任意のセーブポイントまで戻すことも可能です。特定のセーブポイントまでロールバックする場合は、`ROLLBACK`文と`TO SAVEPOINT`文を組み合わせて使用する必要があります。

ここで、

* すべてのトランザクションをロールバックすると、以下のようになります：
  * トランザクションが終了します
  * すべての変更が破棄されます
  * すべてのセーブポイントがクリアされます
  * トランザクションが保持しているすべてのロックが解放されます

* 特定のセーブポイントまでロールバックすると、以下のようになります：
  * トランザクションは終了しません
  * セーブポイント以前に行った変更は保持され、セーブポイント以降に行った変更は破棄されます
  * セーブポイント以降のセーブポイントが削除されます (そのセーブポイント自体は削除されません)
  * セーブポイント設定後にトランザクションが確保したすべてのロックが解放されます。

例：トランザクションのすべての変更をロールバックします。

```sql
obclient> SELECT * FROM t_insert;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 29-SEP-22  |
|  2 | US   | 10002 | 29-SEP-22  |
|  3 | EN   | 10003 | 29-SEP-22  |
|  4 | JP   | 10004 | 29-SEP-22  |
+----+------+-------+------------+
4 rows in set

obclient> INSERT INTO t_insert(id, name, value) VALUES(5,'FR',10005),(6,'RU',10006);
Query OK, 3 rows affected
Records: 3  Duplicates: 0  Warnings: 0

obclient> SELECT * FROM t_insert;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 22-AUG-22  |
|  2 | US   | 10002 | 22-AUG-22  |
|  3 | EN   | 10003 | 22-AUG-22  |
|  4 | JP   | 10004 | 22-AUG-22  |
|  5 | FR   | 10005 | 22-AUG-22  |
|  6 | RU   | 10006 | 22-AUG-22  |
+----+------+-------+------------+
6 rows in set

obclient> ROLLBACK;
Query OK, 0 rows affected

obclient> SELECT * FROM t_insert;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 29-SEP-22  |
|  2 | US   | 10002 | 29-SEP-22  |
|  3 | EN   | 10003 | 29-SEP-22  |
|  4 | JP   | 10004 | 29-SEP-22  |
+----+------+-------+------------+
3 rows in set
```

トランザクション制御文に関する詳細は、[トランザクション管理の概要](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971687)を参照してください。
