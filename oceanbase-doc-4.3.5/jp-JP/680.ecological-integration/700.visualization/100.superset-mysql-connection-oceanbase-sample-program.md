|description|  |
|---|---|
|keywords| |
|dir-name|Superset|
|dir-name-en|Superset|
|tenant-type|MySQL Mode|

# SupersetとOceanBaseを使用したデータ分析

本記事では、Supersetを使用してOceanBaseデータベースに接続する方法について説明します。

## 前提条件

* ローカルでSupersetの設定と実行が完了していること。詳細については、[Superset Quick Start](https://superset.apache.org/docs/quickstart/#1-get-superset)を参照してください。
* OceanBaseデータベースがインストール済みで、MySQLモードのテナントが作成されていること。
* 利用可能なデータセットの準備が整っていること。本記事で使用されているサンプルデータセットは、[Kaggle](https://www.kaggle.com/datasets/vizeno/earthquake-data-overview)から取得したものです。

## 操作手順

### ステップ1：データベース接続文字列を取得する

OceanBaseデータベースのデプロイ担当者または管理者から、該当するデータベース接続文字列を取得します。例：

```
obclient -h$host -P$port -u$user_name -p$password -D$database_name
```

**パラメータの説明：**

* `$host`：OceanBaseデータベースへの接続IPアドレスを提供します。OceanBaseデータベースプロキシ(OceanBase Database Proxy、ODP)接続方式はODPアドレスを使用し、直接接続方式はOBServerノードのIPアドレスを使用します。
* `$port`：OceanBaseデータベースへの接続ポートを提供します。ODP接続方式のデフォルトポートは`2883`で、ODPデプロイ時にカスタマイズ可能です。直接接続方式のデフォルトポートは`2881`で、OceanBaseデータベースのデプロイ時にカスタマイズ可能です。
* `$database_name`：アクセス対象のデータベース名。

    <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>テナントに接続するユーザーは、データベースに対する <code>CREATE</code>、<code>INSERT</code>、<code>DROP</code>、および <code>SELECT</code> 権限が付与されていなければなりません。ユーザー権限の詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974758">MySQLモードの権限分類</a>を参照してください。</p>
    </main>

* `$user_name`：テナントの接続アカウント。ODP接続の一般的な形式：`ユーザー名@テナント名#クラスタ名` または `クラスタ名:テナント名:ユーザー名`、直接接続方式の形式：`ユーザー名@テナント名`。
* `$password`：アカウントのパスワード。

接続文字列の詳細については、[OBClientを使用してOceanBaseテナントに接続する](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971649)を参照してください。

**例：**

```shell
obclient -hxxx.xxx.xxx.xxx -P2881 -utest_user001@mysql001 -p****** -Dtest
```

### ステップ2：SupersetコンソールでOceanBaseデータベースに接続する

1. 実行中のSupersetコンソールページを開き、右上で **+ > Data > Connect database** を選択します。

2. ポップアップウィンドウで、以下の設定を完了します：

    1. 最初のステップ **Select a database to connect** で、MySQLデータベースタイプを選択します。
    2. 次に **Enter the required MySQL credentials** で、**ステップ1：データベース接続文字列を取得する** 内の接続文字列情報に基づいて、**HOST**、**PORT**、**DATABASE NAME**、**USERNAME**、**PASSWORD** を順次入力します。**DISPLAY NAME** の内容はカスタマイズ可能です。

3. **CONNECT** をクリックし、**FINISH** をクリックします。

### ステップ3：データをインポートし、テーブルを作成する

1. **ステップ1：データベース接続文字列を取得する** 内の接続文字列を使用してOceanBaseデータベースにログインし、テーブルを作成します。テーブル作成ステートメントは以下のとおりです：

   ```sql
   CREATE TABLE earthquakes (
    Place VARCHAR(255),
    Latitude DECIMAL(10, 6),
    Longitude DECIMAL(10, 6),
    Country VARCHAR(100),
    Continent VARCHAR(100),
    Magnitude DECIMAL(3, 1)
   );
   ```

2. `LOAD DATA`ステートメントを使用して、準備したデータセットをテーブルにインポートできます。ステートメントの例：

   ```sql
   LOAD DATA INFILE '/path/earthquake_dataset.csv'
   INTO TABLE earthquakes
   FIELDS TERMINATED BY ','
   ENCLOSED BY '"'
   LINES TERMINATED BY '\n'
   IGNORE 1 LINES
   (Place, Latitude, Longitude, Country, Continent, Magnitude);
   ```

   データ量が多い場合、またはインポート時にデータ変換が必要な場合は、[データロードツール](https://en.oceanbase.com/docs/obloader-obdumper-en)を使用してデータセットをインポートすることを推奨します。

   インポートが成功した後、以下のステートメントを使用して検証します：

   ```shell
   obclient> SELECT COUNT(*) FROM earthquakes;
   +----------+
   | COUNT(*) |
   +----------+
   |     1264 |
   +----------+
   1 row in set
   ```

### ステップ4：Supersetでデータセットを作成する

1. Supersetコンソールに戻り、右上の **+ > Data > Create dataset** を選択します。

2. **New dataset**ページで、以下の設定を完了します：

    |構成パラメータ|説明|
    |----|----|
    |DATABASE|ステップ2で**DISPLAY NAME**として定義したデータベース名を選択します。|
    |SCHEMA|ステップ1で作成したOceanBaseデータベースを選択します。|
    |TABLE|ステップ3で作成したテーブルを選択します。|

3. **CREATE DATASET AND CREATE CHART**をクリックして、データセットの作成を完了します。

## 次の操作

データセットを作成した後、実際の状況に応じて、チャートタイプを選択し、**CREATE NEW CHART**をクリックして、ニーズに合わせてチャートを設定することができます。チャート設定に関する詳細は、[Superset公式ドキュメント](https://superset.apache.org/docs/creating-charts-dashboards/exploring-data)を参照してください。
