|description|  |
|---|---|
|keywords| |
|dir-name|n8n|
|dir-name-en|n8n|
|tenant-type|MySQL Mode|

# OceanBaseデータベースとn8nの連携

n8nは、ネイティブAI機能を搭載したワークフロー自動化プラットフォームです。技術チームにはコードによる柔軟性を、そしてノーコードによる迅速さを提供します。400種類以上の連携機能、標準搭載されたAI機能、そしてフェアコードライセンスにより、データとデプロイメントを完全に制御しながら、強力な自動化を構築できます。

この記事では、n8nの強力な機能を活用して、チャットメッセージでOceanBaseデータベースを動作させるワークフローテンプレート「Chat to OceanBase」を構築する方法を紹介します。

## 前提条件

* OceanBaseデータベースのデプロイが完了し、MySQLモードのユーザーテナントが作成されていること。テナント作成の詳細については、[テナントの作成](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971591)を参照してください。

* 本記事はDockerコンテナプラットフォーム上で行います。[Dockerコンテナー環境](https://docs.docker.com/get-started/get-docker/)がセットアップ済みであることを確認してください。

## ステップ1：データベース接続情報を取得する

OceanBaseデータベースのデプロイ担当者または管理者に連絡し、対応するデータベース接続文字列を取得します。例：

```sql
obclient -h$host -P$port -u$user_name -p$password -D$database_name
```

**パラメータの説明：**

* `$host`：OceanBaseデータベースへの接続IPアドレスです。OceanBaseデータベースプロキシ(OceanBase Database Proxy、ODP)経由で接続する場合はODPのアドレスを、直接接続する場合はOBServerノードのIPアドレスを使用します。
* `$port`：OceanBaseデータベースの接続ポートです。ODP経由の接続ではデフォルトで`2883`が使用されますが、ODPのデプロイ時にカスタマイズ可能です。直接接続の場合はデフォルトで`2881`が使用され、OceanBaseデータベースのデプロイ時にカスタマイズできます。
* `$database_name`：アクセスするデータベースの名前です。

    <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>テナントに接続するユーザーは、データベースに対する <code>CREATE</code>、<code>INSERT</code>、<code>DROP</code>、および <code>SELECT</code> 権限が付与されていなければなりません。ユーザー権限の詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974758">MySQLモードの権限分類</a>を参照してください。</p>
    </main>

* `$user_name`：テナントへの接続アカウントです。ODP経由で接続する場合の一般的な形式は`ユーザー名@テナント名#クラスタ名`または`クラスタ名:テナント名:ユーザー名`。直接接続の場合は`ユーザー名@テナント名`となります。
* `$password`：アカウントのパスワードです。

接続文字列の詳細については、[OBClientを使用してOceanBaseテナントに接続する](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971649)を参照してください。

## ステップ2：テストテーブルの作成とデータ挿入

ワークフローの構築を始める前に、まずOceanBaseデータベースに書籍情報を格納するためのサンプルテーブルを作成し、サンプルデータをいくつか挿入します。

```sql
CREATE TABLE books (
    id VARCHAR(255) PRIMARY KEY,
    isbn13 VARCHAR(255),
    author TEXT,
    title VARCHAR(255),
    publisher VARCHAR(255),
    category TEXT,
    pages INT,
    price DECIMAL(10,2),
    format VARCHAR(50),
    rating DECIMAL(3,1),
    release_year YEAR
);

INSERT INTO books (
    id, isbn13, author, title, publisher, category, pages, price, format, rating, release_year
) VALUES (
    'database-internals',
    '978-1492040347',
    '"Alexander Petrov"',
    'Database Internals: A deep-dive into how distributed data systems work',
    'O\'Reilly',
    '["databases","information systems"]',
    350,
    47.28,
    'paperback',
    4.5,
    2019
);

INSERT INTO books (
    id, isbn13, author, title, publisher, category, pages, price, format, rating, release_year
) VALUES (
    'designing-data-intensive-applications',
    '978-1449373320',
    '"Martin Kleppmann"',
    'Designing Data-Intensive Applications: The Big Ideas Behind Reliable, Scalable, and Maintainable Systems',
    'O\'Reilly',
    '["databases"]',
    590,
    31.06,
    'paperback',
    4.4,
    2017
);

INSERT INTO books (
    id, isbn13, author, title, publisher, category, pages, price, format, rating, release_year
) VALUES (
    'kafka-the-definitive-guide',
    '978-1491936160',
    '["Neha Narkhede", "Gwen Shapira", "Todd Palino"]',
    'Kafka: The Definitive Guide: Real-time data and stream processing at scale',
    'O\'Reilly',
    '["databases"]',
    297,
    37.31,
    'paperback',
    3.9,
    2017
);

INSERT INTO books (
    id, isbn13, author, title, publisher, category, pages, price, format, rating, release_year
) VALUES (
    'effective-java',
    '978-1491936160',
    '"Joshua Block"',
    'Effective Java',
    'Addison-Wesley',
    '["programming languages", "java"]',
    412,
    27.91,
    'paperback',
    4.2,
    2017
);

INSERT INTO books (
    id, isbn13, author, title, publisher, category, pages, price, format, rating, release_year
) VALUES (
    'daemon',
    '978-1847249616',
    '"Daniel Suarez"',
    'Daemon',
    'Quercus',
    '["dystopia","novel"]',
    448,
    12.03,
    'paperback',
    4.0,
    2011
);

INSERT INTO books (
    id, isbn13, author, title, publisher, category, pages, price, format, rating, release_year
) VALUES (
    'cryptonomicon',
    '978-1847249616',
    '"Neal Stephenson"',
    'Cryptonomicon',
    'Avon',
    '["thriller", "novel"]',
    1152,
    6.99,
    'paperback',
    4.0,
    2002
);

INSERT INTO books (
    id, isbn13, author, title, publisher, category, pages, price, format, rating, release_year
) VALUES (
    'garbage-collection-handbook',
    '978-1420082791',
    '["Richard Jones", "Antony Hosking", "Eliot Moss"]',
    'The Garbage Collection Handbook: The Art of Automatic Memory Management',
    'Taylor & Francis',
    '["programming algorithms"]',
    511,
    87.85,
    'paperback',
    5.0,
    2011
);

INSERT INTO books (
    id, isbn13, author, title, publisher, category, pages, price, format, rating, release_year
) VALUES (
    'radical-candor',
    '978-1250258403',
    '"Kim Scott"',
    'Radical Candor: Be a Kick-Ass Boss Without Losing Your Humanity',
    'Macmillan',
    '["human resources","management", "new work"]',
    404,
    7.29,
    'paperback',
    4.0,
    2018
);
```

## ステップ3：ツールをデプロイする

### n8nのプライベートデプロイ

n8nは、Node.jsをベースとしたワークフロー自動化プラットフォームで、豊富な連携機能と柔軟な拡張性を備えています。プライベート環境にデプロイすることで、ワークフローの実行環境を詳細に制御し、データのセキュリティとプライバシーを確保できます。このステップでは、Docker環境でn8nをデプロイする方法について説明します。

```shell
sudo docker run -d   --name n8n   -p 5678:5678   -e N8N_SECURE_COOKIE=false   n8nio/n8n
```

### Ollamaツールを使用したQwen3モデルのデプロイ

Ollamaは、オープンソースのAIモデルサーバーで、さまざまなAIモデルのデプロイと管理をサポートします。Ollamaを利用すれば、Qwen3モデルをローカル環境に簡単にデプロイし、AI Agentの機能を実装できます。ここでは、まずDocker環境でOllamaをデプロイし、その後Ollamaツールを用いてQwen3モデルをデプロイする手順を説明します。

```shell
# Docker環境でOllamaをデプロイ
sudo docker run -d  -p 11434:11434 --name ollama ollama/ollama
# Qwen3モデルをデプロイ
sudo docker exec -it ollama sh -c 'ollama run qwen3:latest'
```

## ステップ4：AI Agentワークフローを構築する

n8nは豊富なノードを提供しており、AI Agentワークフローを簡単に構築できます。このステップでは、n8nを使用して「Chat to OceanBase」データベースのワークフローテンプレートを構築する方法を説明します。合計5つのノードを追加する必要があり、具体的な手順は以下の通りです。

1. トリガーの追加

    HTTPリクエストを受け取るために、HTTPトリガーノードを追加します。

    ![4-1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/n8n-1.png)

2. AI Agentノードの追加

    AI Agentのリクエストを処理するために、AI Agentノードを追加します。

    ![4-2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/n8n-2.png)

3. Ollama Chat Modelノードの追加

    モデルには無料の選択肢が複数ありますが、この例ではQwen3を使用します。モデルを選択した後、Ollamaアカウントを設定します。

    ![4-3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/n8n-4.png)

    ![4-4](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/n8n-3.jpg)

4. Simple Memoryノードの追加

    Simple Memoryノードは短期記憶の役割を果たし、チャット中の直近5回のやり取りを記憶します。

    ![4-5](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/n8n-5.png)

5. Toolノードの追加

    Toolノードは、OceanBaseデータベースのデータベース操作を実行するために使用します。AI agent-toolの下にMySQLツールを追加します。

    ![4-6](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/n8n-6.png)

    MySQLツールの設定は以下の通りです：

    ![4-7](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/n8n-8-1.png)

    上図の`編集`アイコンをクリックし、MySQLの接続情報を設定します。

    ![4-8](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/n8n-7-1.png)

    設定完了後、このウィンドウを閉じます。設定パネルの右上にある`Test step`をクリックして簡単なSQLでデータベース接続をテストするか、直接`Back to canvas`をクリックしてメイン画面に戻ることもできます。

6. 保存をクリックして、ワークフローの構築を完了します。

    5つすべてのノードの設定が完了したら、「保存」をクリックしてワークフローの構築を完了させます。これでワークフローのテストを開始できます。

    ![4-9](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/n8n-9.png)

## 画面表示

構築が完了したワークフローの画面は以下の通りです。

![0](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/n8n-%E5%B1%95%E7%A4%BA%EF%BC%88%E9%AB%98%E6%B8%85%EF%BC%89.png)
