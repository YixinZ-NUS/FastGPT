|description|  |
|---|---|
|keywords| |
|dir-name|Trae|
|dir-name-en|Trae|
|tenant-type|MySQL Mode|

# OceanBase MCP ServerとTraeの連携

[MCP（Model Context Protocol）](https://modelcontextprotocol.io/introduction)は、Anthropic社が2024年11月に発表し、オープンソース化したプロトコルです。大規模言語モデル（LLM）が外部のツールやデータソースと直接やり取りできるよう設計されています。MCPを使えば、ユーザーがLLMの出力をコピー＆ペーストして手動で実行する必要はなく、LLMからツールへ直接指示を送り、そのままアクションを実行させることが可能になります。

[OceanBase MCP Server](https://github.com/oceanbase/mcp-oceanbase/tree/main/src/oceanbase_mcp_server)は、MCPプロトコルを介して大規模言語モデルとOceanBaseデータベースを連携させ、SQL文の実行を可能にするサーバーです。GitHubでオープンソースとして公開されており、対応するクライアントを利用すれば、プロジェクトのプロトタイプを素早く構築できます。

[Trae](https://www.trae.com.cn)は、MCP Serverと連携できるIDEで、公式サイトから最新バージョンを入手可能です。

本記事では、Trae IDEとOceanBase MCP Serverを組み合わせ、バックエンドアプリケーションを迅速に構築する手順を紹介します。

## 前提条件

* OceanBaseデータベースのデプロイが完了し、MySQLモードのユーザーテナントが作成されていること。テナント作成の詳細については、[テナントの作成](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971591)を参照してください。

* [Python 3.11以降のバージョン](https://www.python.org/downloads/)と対応する[pip](https://pip.pypa.io/en/stable/installation/)をインストールします。お使いのマシンにインストールされているPythonのバージョンが古い場合は、Minicondaを使用してPython 3.11以降の新しい環境を作成することができます。詳細は[Minicondaインストールガイド](https://docs.anaconda.com/miniconda/install/)を参照してください。

* お使いのオペレーティングシステムに応じて、[Git](https://git-scm.com//downloads)をインストールします。

* Pythonパッケージマネージャーのuvをインストールします。インストール完了後、`uv --version`コマンドでインストールが成功したかを確認できます。

    ```shell
    pip install uv
    uv --version
    ```

* [Trae IDE](https://www.trae.com.cn/ide/download)をダウンロードし、お使いのオペレーティングシステムに合った適切なバージョンを選択してインストールします。

## ステップ1：データベース接続情報を取得する

OceanBaseデータベースのデプロイ担当者または管理者に連絡し、対応するデータベース接続文字列を取得します。例：

```sql
obclient -h$host -P$port -u$user_name -p$password -D$database_name
```

**パラメータの説明：**

* `$host`：OceanBaseデータベースへの接続IPアドレスです。OceanBaseデータベースプロキシ(OceanBase Database Proxy、ODP)経由で接続する場合はODPのアドレスを、直接接続する場合はOBServerノードのIPアドレスを使用します。
* `$port`：OceanBaseデータベースの接続ポートです。ODP経由の接続ではデフォルトで`2883`が使用されますが、ODPのデプロイ時にカスタマイズ可能です。直接接続の場合はデフォルトで`2881`が使用され、OceanBaseデータベースのデプロイ時にカスタマイズできます。
* `$database_name`：アクセスするデータベースの名前です。

    <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>テナントに接続するユーザーは、データベースに対する <code>CREATE</code>、<code>INSERT</code>、<code>DROP</code>、および <code>SELECT</code> 権限が付与されていなければなりません。ユーザー権限の詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974758">MySQLモードの権限分類</a>を参照してください。</p>
    </main>

* `$user_name`：テナントへの接続アカウントです。ODP経由で接続する場合の一般的な形式は`ユーザー名@テナント名#クラスタ名`または`クラスタ名:テナント名:ユーザー名`。直接接続の場合は`ユーザー名@テナント名`となります。
* `$password`：アカウントのパスワードです。

接続文字列の詳細については、[OBClientを使用してOceanBaseテナントに接続する](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971649)を参照してください。

## ステップ2：OceanBase MCP Serverを設定する

### OceanBase MCP Serverリポジトリのクローン

下記のコマンドを実行して、ソースコードをローカルにダウンロードします。

```shell
git clone https://github.com/oceanbase/mcp-oceanbase.git
```

ソースコードのディレクトリに移動します。

```shell
cd mcp-oceanbase
```

### 依存関係のインストール

`mcp-oceanbase`ディレクトリで下記のコマンドを実行して仮想環境を作成し、依存関係をインストールします。

```shell
uv venv
source .venv/bin/activate
uv pip install .
```

### Traeクライアントの作業ディレクトリを作成

Traeの作業ディレクトリを手動で作成し、Traeで開きます。今後Traeが生成するファイルはこのディレクトリに配置されます。

<!-- ![2-1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-1.png) -->

### TraeクライアントでOceanBase MCP Serverを設定

ショートカットキー`Ctrl + U` (Windows)または`Command + U` (MacOS)を使用してチャットダイアログを開き、右上の歯車アイコンをクリックして`MCP`を選択します。

<!-- ![2-2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-2.png) -->

### MCP Serversの追加と設定

1. `MCP Serversを追加`をクリックし、`手動で設定`を選択します。

    <!-- ![2-3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-3.png)

    ![2-4](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-4.png) -->

2. 設定ファイルに情報を入力します。まず編集ボックス内のサンプル内容を削除してください。

    <!-- ![2-5](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-5.png) -->

    その後、以下の内容を入力します。

    ```json
    {
      "mcpServers": {
        "oceanbase": {
          "command": "uv",
          "args": [
            "--directory",
            // mcp-oceanbaseフォルダの絶対パスに置き換える必要があります
            "/path/to/your/mcp-oceanbase/src/oceanbase_mcp_server",
            "run",
            "oceanbase_mcp_server"
          ],
          "env": {
            // ご利用のOceanBaseデータベースの接続情報に置き換える必要があります
            "OB_HOST": "***",
            "OB_PORT": "***",
            "OB_USER": "***",
            "OB_PASSWORD": "***",
            "OB_DATABASE": "***"
          }
        }
      }
    }
    ```

3. 設定が成功すると、`使用可能`のステータスが表示されます。

    <!-- ![2-6](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-6.png) -->

### MCP Serverのテスト

1. `Builder with MCP`を選択します。

    <!-- ![2-7](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-7.png) -->

2. 表示されたダイアログボックスに、次のプロンプトを入力します：`testデータベースにはいくつのテーブルがありますか？`。Traeクライアントが実行予定のSQL文を表示します。内容を確認し、問題がなければ`実行`ボタンをクリックします。

    <!-- ![2-8](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-8.png) -->

3. 実行結果として、`test`データベース内のすべてのテーブル名が表示されます。これにより、OceanBaseデータベースへの接続が正常に確立されたことを確認できます。

    <!-- ![2-9](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-9.png) -->

### FastAPIを使用してRESTful APIスタイルのプロジェクトを迅速に作成する

FastAPIは、PythonでRESTful APIを迅速に構築できるWebフレームワークです。ここでは、`customer`テーブルを作成し、テストデータを挿入したうえで、FastAPIプロジェクトを自動生成します。

1. customerテーブルの作成

    ダイアログボックスに次のプロンプトを入力します：`customerテーブルを作成してください。主キーはIDで、name、age、telephone、locationの各フィールドを含めてください`。SQL文を確認し、問題がなければ`実行`ボタンをクリックします。

    <!-- ![2-10](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-10.png) -->

2. テストデータの挿入

    ダイアログボックスに次のプロンプトを入力します：`customerテーブルに10件のデータを挿入してください`。SQL文を確認し、問題がなければ`実行`ボタンをクリックします。

    <!-- ![2-11](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-11.png) -->

    挿入が成功すると、実行結果が表示されます。

    <!-- ![2-12](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-12.png) -->

3. FastAPIプロジェクトの作成

    ダイアログボックスに次のプロンプトを入力します：`FastAPIプロジェクトを作成し、customerテーブルに基づいたRESTful APIを生成してください`。SQL文を確認し、問題がなければ`実行`ボタンをクリックします。

    <!-- ![2-13](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/integrations/AI/trae-13.png) -->

    このステップでは3つのファイルが自動生成されます。AIが生成する内容は完全ではない場合があるため、初めて使用する際は`すべて受け入れる`を選択し、後からニーズに合わせて修正することを推奨します。

4. 仮想環境の作成と依存関係のインストール

    以下のコマンドを実行し、現在のディレクトリで`uv`パッケージ管理ツールを使って仮想環境を作成し、依存パッケージをインストールします。

    ```shell
    uv venv
    source .venv/bin/activate
    uv pip install -r requirements.txt
    ```

5. FastAPIプロジェクトの起動

    以下のコマンドを実行して、FastAPIプロジェクトを起動します。

    ```shell
    uvicorn main:app --reload
    ```

6. テーブル内のデータの確認

    コマンドラインで以下のコマンドを実行するか、他のリクエストツールを使用して、テーブル内のデータを確認します。

    ```shell
    curl http://127.0.0.1:8000/customers
    ```

    <!-- 返回结果如下：

    ```json
    [{"ID":1,"name":"张三","age":25,"telephone":"13800138000","location":"北京"},{"ID":2,"name":"李四","age":30,"telephone":"13900139000","location":"上海"},{"ID":3,"name":"王五","age":35,"telephone":"13700137000","location":"广州"},{"ID":4,"name":"赵六","age":22,"telephone":"13600136000","location":"深圳"},{"ID":5,"name":"孙七","age":40,"telephone":"13500135000","location":"成都"},{"ID":6,"name":"周八","age":28,"telephone":"13400134000","location":"杭州"},{"ID":7,"name":"吴九","age":33,"telephone":"13300133000","location":"南京"},{"ID":8,"name":"郑十","age":27,"telephone":"13200132000","location":"武汉"},{"ID":9,"name":"陈十一","age":31,"telephone":"13100131000","location":"西安"},{"ID":10,"name":"林十二","age":24,"telephone":"13000130000","location":"重庆"}]
    ``` -->

    これにより、追加、削除、変更、検索のためのRESTful APIが正常に生成されたことが確認できます。

    ```shell
    from fastapi import FastAPI
    from pydantic import BaseModel
    import mysql.connector

    app = FastAPI()

    # データベース接続設定
    config = {
        'user': '*******',
        'password': '******',
        'host': 'xx.xxx.xxx.xx',
        'database': 'test',
        'port':xxxx,
        'raise_on_warnings': True
    }

    class Customer(BaseModel):
        id: int
        name: str
        age: int
        telephone: str
        location: str

    @app.get('/customers')
    async def get_customers():
        cnx = mysql.connector.connect(**config)
        cursor = cnx.cursor(dictionary=True)
        query = 'SELECT * FROM customer'
        cursor.execute(query)
        results = cursor.fetchall()
        cursor.close()
        cnx.close()
        return results

    @app.get('/customers/{customer_id}')
    async def get_customer(customer_id: int):
        cnx = mysql.connector.connect(**config)
        cursor = cnx.cursor(dictionary=True)
        query = 'SELECT * FROM customer WHERE ID = %s'
        cursor.execute(query, (customer_id,))
        result = cursor.fetchone()
        cursor.close()
        cnx.close()
        return result

    @app.post('/customers')
    async def create_customer(customer: Customer):
        cnx = mysql.connector.connect(**config)
        cursor = cnx.cursor()
        query = 'INSERT INTO customer (ID, name, age, telephone, location) VALUES (%s, %s, %s, %s, %s)'
        data = (customer.id, customer.name, customer.age, customer.telephone, customer.location)
        cursor.execute(query, data)
        cnx.commit()
        cursor.close()
        cnx.close()
        return {'message': 'Customer created successfully'}

    @app.put('/customers/{customer_id}')
    async def update_customer(customer_id: int, customer: Customer):
        cnx = mysql.connector.connect(**config)
        cursor = cnx.cursor()
        query = 'UPDATE customer SET name = %s, age = %s, telephone = %s, location = %s WHERE ID = %s'
        data = (customer.name, customer.age, customer.telephone, customer.location, customer_id)
        cursor.execute(query, data)
        cnx.commit()
        cursor.close()
        cnx.close()
        return {'message': 'Customer updated successfully'}

    @app.delete('/customers/{customer_id}')
    async def delete_customer(customer_id: int):
        cnx = mysql.connector.connect(**config)
        cursor = cnx.cursor()
        query = 'DELETE FROM customer WHERE ID = %s'
        cursor.execute(query, (customer_id,))
        cnx.commit()
        cursor.close()
        cnx.close()
        return {'message': 'Customer deleted successfully'}
    ```
