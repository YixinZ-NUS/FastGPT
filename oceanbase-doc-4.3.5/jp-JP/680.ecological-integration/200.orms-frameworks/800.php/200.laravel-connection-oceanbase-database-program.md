|---------|------|
| description | 本記事では、Laravel Eloquent ORMを使用してOceanBaseデータベースに接続し、テーブルの作成、データの挿入、データのクエリといった基本的な操作を実装する方法について説明します。 |
| keywords | Laravel, Eloquent, PHP, OceanBase, データベース接続, ORM, MySQLモード |
| dir-name | Laravel Eloquent ORM |
| dir-name-en |  |
| tenant-type | MySQLモード |

# Laravel Eloquent ORMサンプルプログラム

Laravelは、洗練されたPHPのWeb開発フレームワークです。組み込みのEloquent ORMは、シンプルなActiveRecordの実装を提供し、データベース操作を簡単かつ直感的にします。

本記事では、Laravel Eloquent ORMを使用してOceanBaseデータベースに接続し、テーブルの作成、データの挿入、データのクエリといった基本的な操作を実装する方法について説明します。

## 前提条件

- PHP 8.0以降がインストール済みであること。
- Composerパッケージ管理ツールがインストール済みであること。
- OceanBaseデータベースがインストールされ、MySQLモードのテナントが作成済みであること。
- OceanBaseデータベースの接続文字列を取得済みであること。

## 操作手順

1. OceanBaseデータベースの接続文字列を取得します。
2. Laravelプロジェクトを作成し、依存関係をインストールします。
3. データベース接続を設定します。
4. モデルとデータベースマイグレーションを作成します。
5. データベース操作コードを記述します。
6. プログラムを実行し、結果を検証します。

### ステップ1：OceanBaseデータベースの接続文字列を取得する

OceanBaseデータベースのデプロイ担当者または管理者に連絡して、対応するデータベース接続文字列を取得します。

```shell
obclient -h$host -P$port -u$user_name -p$password -D$database_name
```

**パラメータの説明**

* `$host`：OceanBaseデータベースの接続IPを指定します。OceanBase Database Proxy (ODP)接続方式ではODPアドレスを使用し、直接接続方式ではOBServerノードのIPアドレスを使用します。
* `$port`：OceanBaseデータベースの接続ポートを指定します。ODP接続方式のデフォルトは`2883`ですが、ODPのデプロイ時にカスタマイズ可能です。直接接続方式のデフォルトは`2881`ですが、OceanBaseデータベースのデプロイ時にカスタマイズ可能です。
* `$database_name`：アクセスするデータベースの名前です。

    <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>テナントに接続するユーザーは、そのデータベースに対する<code>CREATE</code>、<code>INSERT</code>、<code>UPDATE</code>、<code>SELECT</code>権限を持っている必要があります。ユーザー権限に関する詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974758">MySQLモードの権限分類</a>をご参照ください。</a>。</p>
    </main>

* `$user_name`：テナントの接続アカウントを指定します。ODP接続の一般的な形式は：`ユーザー名@テナント名#クラスタ名`または`クラスタ名:テナント名:ユーザー名`です。直接接続方式の形式は：`ユーザー名@テナント名`です。
* `$password`：アカウントのパスワードを指定します。

接続文字列に関する詳細については、[OBClientによるOceanBaseテナントへの接続](../../../300.develop/100.application-development-of-mysql-mode/100.connect-to-oceanbase-database-of-mysql-mode/300.connect-to-an-oceanbase-tenant-by-using-obclient-of-mysql-mode.md)をご参照ください。

**例：**

```shell
obclient -hxxx.xxx.xxx.xxx -P2881 -utest_user001@mysql001 -p****** -Dtest
```

### ステップ2：Laravelと依存関係のインストール

1. Composerを使用して新しいLaravelプロジェクトを作成します：

    ```bash
    composer create-project laravel/laravel laravel-oceanbase
    cd laravel-oceanbase
    ```

2. インストールを確認します：

    ```bash
    php artisan --version
    ```

### ステップ3：データベース接続を設定する

`config/database.php`ファイルを編集し、MySQL接続オプションを設定します：

```php
'mysql' => [
    'driver' => 'mysql',
    'host' => env('DB_HOST', '127.0.0.1'),
    'port' => env('DB_PORT', '2881'),
    'database' => env('DB_DATABASE', 'forge'),
    'username' => env('DB_USERNAME', 'forge'),
    'password' => env('DB_PASSWORD', ''),
    'charset' => 'utf8mb4',
    'collation' => 'utf8mb4_unicode_ci',
    'prefix' => '',
    'strict' => true,
    'engine' => null,
],
```

### ステップ4：モデルとテーブル構造を作成する

1. Userモデル`app/Models/User.php`を作成します：

    ```php
    <?php

    namespace App\Models;

    use Illuminate\Database\Eloquent\Model;
    use Illuminate\Support\Facades\Schema;

    class User extends Model
    {
        protected $table = 'users';

        protected $fillable = ['username', 'email', 'age'];

        /**
         * ユーザーテーブルを作成します
         */
        public static function createTable()
        {
            if (!Schema::hasTable('users')) {
                Schema::create('users', function ($table) {
                    $table->id();
                    $table->string('username', 100);
                    $table->string('email', 100)->unique();
                    $table->integer('age')->nullable();
                    $table->timestamps();
                });

                return true;
            }
            return false;
        }
    }
    ```

### ステップ5：データベース操作コードを記述する

1. コントローラー`app/Http/Controllers/UserController.php`を作成します：

    ```php
    <?php

    namespace App\Http\Controllers;

    use App\Models\User;
    use Illuminate\Http\Request;

    class UserController extends Controller
    {
        // ユーザーテーブルを作成
        public function __construct()
        {
            User::createTable();
        }

        // ユーザーを作成
        public function create(Request $request)
        {
            $user = User::create([
                'username' => $request->input('username'),
                'email' => $request->input('email'),
                'age' => $request->input('age'),
            ]);

            return response()->json($user);
        }

        // ユーザーをクエリ
        public function show($id)
        {
            $user = User::findOrFail($id);
            return response()->json($user);
        }

        // ユーザーを更新
        public function update(Request $request, $id)
        {
            $user = User::findOrFail($id);
            $user->update([
                'username' => $request->input('username', $user->username),
                'email' => $request->input('email', $user->email),
                'age' => $request->input('age', $user->age),
            ]);

            return response()->json($user);
        }

        // ユーザーを削除
        public function delete($id)
        {
            $user = User::findOrFail($id);
            $user->delete();

            return response()->json(['message' => '用户删除成功']);
        }

        // 全てのユーザーをクエリ
        public function index()
        {
            $users = User::all();
            return response()->json($users);
        }
    }
    ```

2. ルート`routes/api.php`を追加します：

    ```php
    <?php

    use Illuminate\Support\Facades\Route;
    use App\Http\Controllers\UserController;

    // 手動で /apiプレフィックスを追加
    Route::prefix('api')->group(function () {
        Route::get('/users', [UserController::class, 'index']);
        Route::post('/users', [UserController::class, 'create']);
        Route::get('/users/{id}', [UserController::class, 'show']);
        Route::put('/users/{id}', [UserController::class, 'update']);
        Route::delete('/users/{id}', [UserController::class, 'delete']);
    });
    ```

3. `app/Providers/AppServiceProvider.php`ファイルを修正します：

    ```php
    <?php

    namespace App\Providers;

    use Illuminate\Support\ServiceProvider;

    class AppServiceProvider extends ServiceProvider
    {
        /**
        * Register any application services.
        */
        public function register(): void
        {
            //
        }

        /**
        * Bootstrap any application services.
        */
        public function boot(): void
        {
            //$this->loadRoutesFrom(base_path('routes/api.php'));
        }
    }
    ```

### ステップ6：プログラムを実行し、結果を検証する

1. 開発サーバーを起動します：

    ```bash
    php artisan serve
    ```

2. APIツール（Postmanなど）を使用して、以下のインターフェースをテストします：

    - `GET http://localhost:8000/api/users` - ユーザーリストを取得
    - `POST http://localhost:8000/api/users` - 新規ユーザーを作成
    - `GET http://localhost:8000/api/users/1` - 指定ユーザーを取得
    - `PUT http://localhost:8000/api/users/1` - ユーザーを更新
    - `DELETE http://localhost:8000/api/users/1` - ユーザーを削除

## 関連ドキュメント

- [Laravelデータベースドキュメント](https://laravel.com/docs/database)
- [Laravel Eloquent ORM](https://laravel.com/docs/eloquent)
- [OceanBaseデータベースドキュメント](https://jp.oceanbase.com/docs/oceanbase-database)
- [PHP公式ドキュメント](https://www.php.net/manual/ja/index.php)