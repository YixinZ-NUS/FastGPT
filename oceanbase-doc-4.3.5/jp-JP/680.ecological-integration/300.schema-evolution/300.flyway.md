|description| |
|---|---|
|dir-name|Flyway|
|dir-name-en|Flyway|

## Flywayを使用してOceanBaseデータベースを統合し、バージョン管理を実現する

Flywayは、オープンソースのデータベースバージョン管理ツールです。履歴レコードテーブルを作成してデータベースの状態を追跡し、自動化された移行を実現します。本記事では、OceanBaseデータベースにFlywayを統合し、Schema変更の自動デプロイとバージョン追跡を実現する方法について説明します。

## 前提条件

OceanBaseデータベースがデプロイ済みで、ユーザーテナントが作成されていること。ユーザーテナントの作成の詳細情報については、[テナントの作成](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971591)を参照してください。

## 操作手順

### ステップ1：データベース接続情報を取得する

OceanBaseデータベースのデプロイ担当者または管理者から、該当するデータベース接続文字列を取得します。例：

```shell
obclient -h$host -P$port -u$user_name -p$password -D$database_name
```

**パラメータの説明：**

* `$host`：OceanBaseデータベースへの接続IPアドレスを提供します。OceanBaseデータベースプロキシ(OceanBase Database Proxy、ODP)接続方式はODPアドレスを使用し、直接接続方式はOBServerノードのIPアドレスを使用します。
* `$port`：OceanBaseデータベースへの接続ポートを提供します。ODP接続方式のデフォルトポートは `2883` で、ODPデプロイ時にカスタマイズ可能です。直接接続方式のデフォルトポートは `2881` で、OceanBaseデータベースのデプロイ時にカスタマイズ可能です。
* `$database_name`：アクセス対象のデータベース名。

    <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>テナントに接続するユーザーは、データベースに対する <code>CREATE</code>、<code>INSERT</code>、<code>DROP</code>、および <code>SELECT</code> 権限が付与されていなければなりません。ユーザー権限の詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974758">MySQLモードの権限分類</a>を参照してください。</p>
    </main>

* `$user_name`：テナントの接続アカウント。ODP接続の一般的な形式：`ユーザー名@テナント名#クラスタ名` または `クラスタ名:テナント名:ユーザー名`。直接接続方式の形式：`ユーザー名@テナント名`。
* `$password`：アカウントのパスワード。

接続文字列の詳細については、[OBClientを使用してOceanBaseテナントに接続する](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971649)を参照してください。

### ステップ2：統合設定

#### MySQL互換性モードテナント

OceanBaseデータベースのMySQL互換モードテナントは、flyway-core 10.0.0以降のバージョンを使用し、mysql-connector-javaおよびflyway-database-oceanbaseコンポーネントに依存することを推奨します。Flywayの以前のバージョンをサポートする必要がある場合は、OceanBaseデータベースのテクニカルサポートにお問い合わせください。

1. Mavenの依存関係を設定します。

    プロジェクトの `pom.xml` ファイルに以下の依存関係を追加します：

    ```xml
    <dependencies>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-core</artifactId>
        <version>11.3.2</version>
    </dependency>
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>5.1.47</version>
    </dependency>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-database-oceanbase</artifactId>
        <version>10.7.2</version>
    </dependency>
    </dependencies>
    ```

2. 移行スクリプトを作成します。

    Mavenプロジェクトの `resources` ディレクトリ内に `db/migration` フォルダを作成し、その中に以下の2つのSQLファイルを作成します：

    * ファイル1：V1_1__create_person_table.sql

        ```sql
        CREATE TABLE person (
            id INT NOT NULL,
            name VARCHAR(20) NOT NULL
        );
        ```

    * ファイル2：V2_1__add_person_table.sql

        ```sql
        INSERT INTO person (id, name)
        VALUES (1, 'apple');
        ```

3. Javaテストクラスをコンパイルします。

    JavaクラスFlywayTestを作成します。Flywayを使用してデータベースを移行します。前提条件で取得した接続文字列に基づいて、コード内のデータベース接続情報を修正してください。

    ```java
    public class FlywayTest {
        public static void main(String[] args) {
            String url = "jdbc:mysql://host:port/dbName";
            String user = "username";
            String password = "password";
            Flyway flyway = Flyway.configure()
                    .dataSource(url, user, password)
                    .load();
            flyway.baseline();
            flyway.migrate();
        }
    }
    ```

    **パラメータの説明：**

    * `host`：OceanBaseデータベースへの接続アドレス。
    * `port`：OceanBaseデータベースへの接続ポート。
    * `dbName`：アクセス対象のデータベース名。
    * `username`：データベースのアカウント名。
    * `password`：アカウントパスワード。

4. テストを実行します。

    FlywayTestを実行した後、OceanBaseデータベースに作成されたpersonテーブルと挿入されたデータを確認することができます。

    <!-- ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/25V1/800.integration/flyway/1.png) -->

#### Oracle互換モードのテナント

OceanBaseデータベースのOracle互換モードテナントは、flyway-core 10.9.0以降のバージョンを必要とし、oceanbase-client、flyway-mysqlおよびflyway-database-oceanbaseコンポーネントを使用する必要があります。

<main id="notice" type='explain'>
    <h4>説明</h4>
    <p>flyway-database-oceanbaseは現在、直接ダウンロードすることができません。OceanBaseデータベースのテクニカルサポートにお問い合わせください。</p>
</main>

1. Mavenの依存関係を設定します。

    プロジェクトの `pom.xml` ファイルに以下の依存関係を追加します：

    ```xml
    <dependencies>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-core</artifactId>
        <version>10.9.0</version>
    </dependency>
    <dependency>
        <groupId>com.oceanbase</groupId>
        <artifactId>oceanbase-client</artifactId>
        <version>2.4.11</version>
    </dependency>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-mysql</artifactId>
        <version>10.7.0</version>
    </dependency>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-database-oceanbase</artifactId>
        <version>10.16.1</version>
        <scope>system</scope>
        <systemPath>/path/to/your/flyway-database-oceanbase-10.16.1.jar</systemPath>
    </dependency>
    </dependencies>
    ```

2. 移行スクリプトを作成します。

    Mavenプロジェクトの `resources` ディレクトリ内に `db/migration` フォルダを作成し、その中に以下の2つのSQLファイルを作成します：

    * ファイル1：V1_1__create_person_table.sql

        ```sql
        CREATE TABLE person (
            id INT NOT NULL,
            name VARCHAR(20) NOT NULL
        );
        ```

    * ファイル2：V2_1__add_person_table.sql

        ```sql
        INSERT INTO person (id, name)
        VALUES (1, 'apple');
        ```

3. Javaテストクラスをコンパイルします。

    JavaクラスFlywayTestを作成します。Flywayを使用してデータベースを移行します。前提条件で取得した接続文字列に基づいて、コード内のデータベース接続情報を修正してください。

    ```java
    public class FlywayTest {
        public static void main(String[] args) {
            String url = "jdbc:oceanbase://host:port/";
            String user = "username";
            String password = "password";
            Flyway flyway = Flyway.configure()
            .dataSource(url, user, password)
            .load();
            flyway.baseline();
            flyway.migrate();
        }
    }
    ```

    **パラメータの説明：**

    * `host`：OceanBaseデータベースへの接続アドレス。
    * `port`：OceanBaseデータベースへの接続ポート。
    * `username`：データベースのアカウント名。
    * `password`：アカウントパスワード。

4. テストを実行します。

    FlywayTestを実行した後、OceanBaseデータベースに作成されたpersonテーブルと挿入されたデータを確認することができます。

    <!-- ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/cloud/25V1/800.integration/flyway/2.png) -->
