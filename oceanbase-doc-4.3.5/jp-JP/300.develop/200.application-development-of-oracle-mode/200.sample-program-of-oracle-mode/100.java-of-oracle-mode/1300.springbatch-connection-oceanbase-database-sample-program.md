|description||
|---|---|
|keywords||
|dir-name|Jfinal|
|dir-name-en||
|tenant-type|Oracle Mode|

# Jfinal

本記事では、JfinalフレームワークとOceanBaseデータベースを使用して、テーブルの作成、データの挿入、データのクエリなどの基本操作を実現するアプリケーションの構築方法を紹介します。

<div role="videolist">
      <a role='link' href='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/java/java-oceanbase-Jfinal/java-oceanbase-jfinal.zip'>
          <img src='https://file.oceanbase.com/doc/img/lQLPJyFovGIOcJQWFrAqhLlgRRsPvwU-H7hJ_i0A_22_22.png'/>
          クリックしてjava-oceanbase-Jfinalサンプルプロジェクトをダウンロード
      </a>
      <!-- <a role='video' href='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/video-center/video/video/06%20java-ob-jfinal_e06.mp4'>
          <img src='https://mdn.alipayobjects.com/huamei_22khvb/afts/img/A*DFPmToHK6hgAAAAAAAAAAAAADiGDAQ/original'/>
          Jfinal 连接 OceanBase 数据库示例程序（Oracle 模式）
       </a> -->
</div>

## 前提条件

* OceanBaseデータベースがインストール済みであること。
* JDK 1.8とMavenがインストール済みであること。
* IntelliJ IDEAがインストール済みであること。

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>この記事でコードを実行するために使用したツールは、IntelliJ IDEA 2021.3.2（Community Edition）バージョンです。ご自身の好みに合わせて、適切なツールを選択してサンプルコードを実行することも可能です。</p>
</main>

## 操作手順

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>本記事で示されている操作手順は、Windows環境に基づいています。他のOS環境やコンパイラを使用している場合は、操作手順が若干異なる場合があります。 </p>
</main>

1. OceanBaseデータベースの接続文字列を取得します。
2. `java-oceanbase-Jfinal` プロジェクトをIDEAにインポートします。
3. `java-oceanbase-Jfinal` プロジェクトのTomcat実行環境を構築します。
4. `java-oceanbase-Jfinal` プロジェクトのデータベース接続情報を変更します。
5. `java-oceanbase-Jfinal` プロジェクトを実行します。

### ステップ１：OceanBaseデータベースの接続文字列を取得する

1. OceanBaseデータベースのデプロイ担当者または管理者から、該当するデータベース接続文字列を取得します。

    ```shell
    obclient -hxx.xx.xx.xx -P2883 -uroot@sys#cluster -p**** -A
    ```

2. デプロイ済みのOceanBaseデータベースに基づいて、以下のURLの対応する情報を入力します。

    <main id="notice" type='explain'>
    <h4>説明</h4>
    <p><code>config.properties</code> ファイルに、このURL情報が必要です。</p>
    </main>

    ```java
    jdbc:oceanbase://host:port/schema_name?user=$user_name&password=$password
    ```

    **パラメータの説明：**

    * `host`：OceanBaseデータベースへの接続IPアドレス。ODP接続方式ではODPアドレスを使用し、直接接続方式ではOBServerノードのIPアドレスを使用します。
    * `port`：OceanBaseデータベースの接続ポートを提供します。ODP接続方式のデフォルトポートは `2883` で、ODPデプロイ時にカスタマイズすることができます。直接接続方式のデフォルトポートは `2881` で、OceanBaseデータベースのデプロイ時にカスタマイズすることができます。
    * `schema_name`：アクセスするスキーマ名です。
    * `user_name`：テナントの接続アカウント。ODP接続方式の一般的な形式は2種類あります：`ユーザー名@テナント名#クラスタ名` または `クラスタ名:テナント名:ユーザー名`。直接接続方式の形式：`ユーザー名@テナント名`。
    * `password`：アカウントのパスワード。

詳細なURLパラメータの説明については、[データベースURL](https://en.oceanbase.com/docs/common-oceanbase-connector-j-en-10000000002244946)を参照してください。

### ステップ2：`java-oceanbase-Jfinal` プロジェクトをIDEAにインポートする

1. **IntelliJ IDEA** を開き、**File > Open...** オプションを選択します。

   ![file](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/java/mybatis/file.jpg)

2. 表示された **Open File or Project** ウィンドウで、対応するプロジェクトファイルを選択し、**OK** をクリックしてプロジェクトファイルのインポートを完了します。

3. IntelliJ IDEAは、プロジェクト内のさまざまなファイルの種類を自動的に認識し、**Project** ツールウィンドウで、プロジェクトのディレクトリ構造、ファイルリスト、モジュールリスト、依存関係などの情報を確認できます。**Project** ツールウィンドウは通常、IntelliJ IDEA画面の左側にあり、デフォルトでは開いています。**Project** ツールウィンドウが閉じている場合は、メニューバーの **View > Tool Windows > Project** をクリックするか、ショートカットキー **Alt + 1** を使用して再表示できます。

    <main id="notice" type='explain'>
    <h4>説明</h4>
    <p>IntelliJ IDEAでプロジェクトをインポートすると、IntelliJ IDEAはプロジェクト内のpom.xmlファイルを自動的に検出し、ファイルに記述されている依存関係に基づいて必要な依存ライブラリを自動的にダウンロードし、プロジェクトに追加します。</p>
    </main>

4. プロジェクトの状況を確認します。

   ![Jfinal](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/java/java-oceanbase-Jfinal/chakan%20jfinal.jpg)

### ステップ3：`java-oceanbase-Jfinal` プロジェクトのTomcat動作環境を構築する

1. Tomcat 8.5.95バージョンをダウンロードします。
   [Apache Tomcat公式Webサイト](https://tomcat.apache.org) からTomcat 8.5.95バージョンの圧縮ファイルをダウンロードします。ダウンロードした圧縮ファイルを、Tomcatをインストールするディレクトリに解凍します。

2. IDEAでTomcatを設定します。
   IntelliJ IDEAを開き、**File** メニューから **Settings > Plugins** を選択します。**Settings** ウィンドウの中央にある検索ボックスで **Smart Tomcat** を検索し、ダウンロード後 **Apply** をクリックします。すると、**Settings** ウィンドウの左下に **Tomcat Server** タブが表示されます。**Tomcat Server** タブに移動して、右側の **+** ボタンをクリックし、解凍したTomcatディレクトリを選択し、**Apply** をクリックし、**OK** をクリックして設定を完了します。

   ![Tomcat server](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/java/java-oceanbase-Jfinal/Tomcat%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/Tomcat%20server.jpg)

3. Tomcat実行設定を作成します。

    IDEAの上部ツールバーで、**Run > Edit Configurations** を選択します。**Run/Debug Configurations** ウィンドウで、**+** ボタンをクリックして、**Tomcat Server** を選択します。実行するサーバーの名前を **Name** に入力し、**Configuration** 選択ボックスで、インストールしたバージョンに対応する **Tomcat Server** を選択し、**Context path** の値を `/` に変更し、**SSL port** の値を `8080` と入力します。**Before launch** 選択ボックスで、**+** をクリックして、**Launch Web Browser** を選択します。**Edit** をクリックして、URLに `http://localhost:8080/hello/getData` と入力します。**Apply** をクリックしてから **OK** をクリックし、設定を完了します。

    ![apache tomcat8.5.95](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/java/java-oceanbase-Jfinal/Tomcat%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/apache%20tomcat8.5.95.jpg)

4. Tomcatサーバーを実行します。

   IDEAの上部のツールバーで、作成したTomcat実行のための設定を選択します。**緑色の三角形** の実行ボタンをクリックしてTomcatサーバーを起動します。IDEAの **Run** ウィンドウでTomcatサーバーの起動ログを確認できます。

### ステップ4：`java-oceanbase-Jfinal` プロジェクトのデータベース接続情報を修正する

**ステップ１：OceanBaseデータベース接続文字列を取得する** に記載されている情報に基づいて、`config.properties` ファイルのデータベース接続情報を修正します。

**例：**

* データベースドライバーの名前：`com.oceanbase.jdbc.Driver`
* OBServerノードのIPアドレスは `10.10.10.1` です。
* アクセスポートは2881を使用します。
* アクセスするスキーマ名は `sys` です。
* テナントの接続アカウントは `sys@xyoracle` です。`xyoracle` はOceanBaseデータベース内に作成されたOracleモードのユーザーテナントであり、`sys` はテナント `xyoracle` のユーザー名です。
* パスワードは `******` です。

**サンプルコードは以下のとおりです：**

```java
db.app.driver=com.oceanbase.jdbc.Driver
db.app.url=jdbc:oceanbase://10.10.10.1:2881/sys
db.app.user=sys@xyoracle
db.app.password=******
db.app.poolInitialSize=3
db.app.poolMaxSize=10
db.app.connectionTimeoutMillis=100
db.app.validationQuery=select 1 from dual
```

### ステップ5：`java-oceanbase-Jfinal` プロジェクトを実行する

1. 実行パス。

    IDEAの上部のツールバーで、作成したTomcat実行のための設定を選択します。**緑色の三角形** の実行ボタンをクリックしてTomcatサーバーを起動します。GoogleまたはIEブラウザでパス `http://localhost:8080/hello/getData` を開き、実行結果を確認します。

2. 実行結果。

    ```xml
    [{"ID":1,"NAME":"John"},{"ID":2,"NAME":"Jane"}]
    ```

## プロジェクトコードについて

[java-oceanbase-Jfinal](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/java/java-oceanbase-Jfinal/java-oceanbase-jfinal.zip) をクリックして、`java-oceanbase-Jfinal` という名前の圧縮ファイルをダウンロードします。

解凍すると、`java-oceanbase-Jfinal` という名前のフォルダが作成されます。ディレクトリ構造は以下のとおりです：

```java
│--pom.xml
│
├─.idea
│
├─src
│  ├─main
│  │  ├─java
│  │  │  └─com
│  │  │      └─oceanbase
│  │  │          └─testjfinal
│  │  │              ├─config
│  │  │              │   └─UserConfig.java
│  │  │              │
│  │  │              ├─controller
│  │  │              │   └─UserController.java
│  │  │              │
│  │  │              └─pojo
│  │  │                  └─User.java
│  │  │
│  │  ├─resources
│  │  │    └─config.properties
│  │  │
│  │  └─webapp
│  │      └─WEB-INF
│  │          └─web.xml
│  │
│  │
│  │
│  └─test
│      └─java
│
│
└─target
```

**ファイルの説明：**

* `pom.xml`：Mavenプロジェクトの設定ファイルは、プロジェクトの依存関係、プラグイン、ビルドなどの情報が含まれます。
* `.idea`：IDE（統合開発環境）で使用されるディレクトリで、プロジェクト関連の設定情報を格納するために使用されます。
* `src`：通常、プロジェクトのソースコードを格納するディレクトリを表すために使用されます。
* `main`: 主要なソースコードとリソースファイルを格納するディレクトリ。
* `java`: Javaソースコードを格納するディレクトリ。
* `com`: Javaパッケージを格納するルートディレクトリ。
* `oceanbase`: プロジェクトを格納するルートディレクトリ。
* `testjfinal`：JFinalフレームワークに関連するコードを格納します。
* `config`：アプリケーションの設定クラスファイルを含む、設定ファイルディレクトリ。
* `UserConfig.java`：ユーザー設定クラスファイル。
* `controller`：アプリケーションのコントローラークラスファイルを含む、コントローラーディレクトリ。
* `UserController.java`：ユーザーコントローラークラスファイル。
* `pojo`: JavaBeanまたはエンティティクラスを格納します。
* `User.java`：ユーザーエンティティクラスを格納します。
* `resources`: 設定ファイルやSQLファイルなどの、リソースファイルを格納するディレクトリ。
* `config.properties`: データベース接続情報の設定ファイルを格納します。
* `webapp`：Webアプリケーションのディレクトリで、Webアプリケーションの静的リソースと設定ファイルが含まれています。
* `WEB-INF`：WebアプリケーションのWEB-INFディレクトリで、設定ファイルやその他の保護されたリソースファイルを格納するために使用されます。
* `web.xml`：Webアプリケーションのデプロイメント記述子ファイル。
* `test`: テストコードとリソースファイルを格納するディレクトリです。
* `target`: コンパイル済みのClassファイル、Jarパッケージなどのファイルを格納するディレクトリ。

### pom.xmlコードの紹介

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>例を確認するだけの場合、デフォルトコードを使用してください。修正する必要はありません。以下の説明に従って、必要に応じて <code>pom.xml</code> ファイルを変更することもできます。</p>
</main>

`pom.xml` 設定ファイルの内容は以下のとおりです：

1. ファイル宣言ステートメントです。

    このファイルがXMLファイルであり、使用しているXMLのバージョンが `1.0` で、文字エンコーディング方式が `UTF-8` であることを宣言しています。

    **コード：**

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    ```

2. POMのネームスペースとPOMモデルのバージョンを設定します。

   1. `xmlns` を使用して、POMのネームスペースを `http://maven.apache.org/POM/4.0.0` と指定します。
   2. `xmlns:xsi` を使用して、XMLネームスペースを `http://www.w3.org/2001/XMLSchema-instance` と指定します。
   3. `xsi:schemaLocation` を使用して、POMのネームスペースを `http://maven.apache.org/POM/4.0.0` と指定し、POMのXSDファイルの場所を `http://maven.apache.org/xsd/maven-4.0.0.xsd` と指定します。
   4. `<modelVersion>` 要素を使用して、このPOMファイルで使用されるPOMモデルのバージョンを `4.0.0` と指定します。

   **コード：**

   ```xml
   <project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
   </project>
   ```

3. 基本情報を設定します。

   1. `<groupId>` を使用して、プロジェクト識別子を `com.oceanbase` と指定します。
   2. `<artifactId>` を使用して、プロジェクトの依存関係を `java-oceanbase-jfinal` と指定します。
   3. `<version>` を使用して、プロジェクトのバージョン番号を `1.0-SNAPSHOT` と指定します。
   4. `<packaging>` を使用して、プロジェクトのパッケージング方式をWARファイル（Webアプリケーションアーカイブファイル）と指定します。

   **コード：**

   ```xml
    <groupId>com.oceanbase</groupId>
    <artifactId>java-oceanbase-jfinal</artifactId>
    <version>1.0-SNAPSHOT</version>
    <!-- Packaging method (default to jar) -->
    <packaging>war</packaging>
   ```

4. Mavenバージョンを設定します。

   <maven.compiler.source> と <maven.compiler.target> を使用して、コンパイラのソースコードバージョンとターゲットコードバージョンをどちらもJava 8と指定します。

   **コード：**

   ```xml
    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>
   ```

5. コア依存関係を設定します。

   1. 依存関係が属する組織をcom.jfinal、名前をjfinal、バージョン番号を5.0.6と指定します。この依存関係を使用することで、JFinalフレームワークの機能を利用できます。

        **コード：**

        ```xml
        <dependency>
            <groupId>com.jfinal</groupId>
            <artifactId>jfinal</artifactId>
            <version>5.0.6</version>
        </dependency>
        ```

   2. 依存関係が属する組織を `com.alibaba`、名前を `druid`、バージョン番号を `1.2.8` と指定します。この依存関係を使用することで、Druidライブラリを利用して、データベース接続の取得と解放を管理および最適化できます。

      **コード：**

        ```xml
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
            <version>1.2.8</version>
        </dependency>
        ```

   3. 依存関係が属する組織を `com.oceanbase`、名前を `oceanbase-client`、バージョン番号を `2.4.3` と指定します。この依存関係を使用することで、OceanBaseが提供するクライアント機能（接続、クエリ、トランザクションなど）を利用できます。

      **コード：**

        ```xml
            <dependencies>
            <dependency>
                <groupId>com.oceanbase</groupId>
                <artifactId>oceanbase-client</artifactId>
                <version>2.4.3</version>
            </dependency>
            </dependencies>
        ```

### config.propertiesファイルの解説

`config.properties` ファイルは、OceanBaseデータベースへのデータベース接続情報を設定します。データベースドライバーのクラス名、接続URL、ユーザー名、パスワード、接続プールの関連設定を含みます。これらの構成パラメータは、アプリケーション内でデータベース接続を取得および管理し、データベース操作を実行するために使用されます。

* `db.app.driver` を使用して、データベースドライバープログラムを `com.oceanbase.jdbc.Driver` と指定します。OceanBaseデータベースとの接続を確立するために使用されます。
* `db.app.url` を使用して、データベース接続用のURLを指定します。
* `db.app.user` を使用して、データベース接続用のユーザー名を指定します。
* `db.app.password` を使用して、データベース接続用のパスワードを指定します。
* `db.app.poolInitialSize` を使用して、データベース接続プールの初期サイズを `3` に設定します。最初に3つのデータベース接続が作成されます。
* `db.app.poolMaxSize` を使用して、データベース接続プールの最大数を `10` に設定します。接続プール内で最大10個のデータベース接続を作成できます。
* `db.app.connectionTimeoutMillis` を使用して、データベース接続のタイムアウト時間を `100 ms` に設定します。データベース接続を取得する際、100 msを超えても接続を取得できない場合、タイムアウト例外がスローされます。
* `db.app.validationQuery` を使用して、データベース接続の有効性を検証するために使用するSQLクエリを `select 1 from dual` と指定します。接続プールから接続を取得する際に、このクエリを実行して接続の有効性が検証されます。

  **コード：**

  ```java
    db.app.driver=com.oceanbase.jdbc.Driver
    db.app.url=jdbc:oceanbase://host:port/schema_name
    db.app.user=user_name
    db.app.password=******
    db.app.poolInitialSize=3
    db.app.poolMaxSize=10
    db.app.connectionTimeoutMillis=100
    db.app.validationQuery=select 1 from dual
  ```

### web.xmlコードの紹介

`web.xml` ファイルは、Webアプリケーションのフィルターを設定するために使用されます。

`web.xml` 設定ファイルの内容は以下のとおりです：

1. ファイル宣言ステートメントです。

    このファイルがXMLファイルであり、使用しているXMLのバージョンが `1.0` で、文字エンコーディング方式が `UTF-8` であることを宣言しています。

    **コード：**

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    ```

2. XMLのネームスペースとXMLモデルバージョンを設定します。

   1. `xmlns:xsi` を使用して、XMLネームスペースを `http://www.w3.org/2001/XMLSchema-instance` と指定します。
   2. `xmlns` を使用して、XMLのネームスペースを `http://java.sun.com/xml/ns/javaee` と指定します。
   3. `xsi:schemaLocation` を使用して、XMLネームスペースを `http://java.sun.com/xml/ns/javaee`、XMLのXSDファイルの場所を `http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd` と指定します。
   4. `<id>` および `<version>` 要素を使用して、WebアプリケーションのIDを `WebApp_ID` と指定し、バージョン番号を `3.0` と指定します。

   **コード：**

   ```xml
    <web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns="http://java.sun.com/xml/ns/javaee"
             xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
             id="WebApp_ID"
             version="3.0">
   ```

3. JFinalフィルターを設定します。

    Webアプリケーション内でJFinalフレームワークを使用するため、`jfinal` という名前のフィルターを設定します。フィルタークラスを `com.jfinal.core.JFinalFilter` と指定します。初期化パラメータ `configClass` を指定することにより、JFinalフレームワークの設定クラスの位置を `com.oceanbase.testjfinal.config.UserConfig` と指定します。このフィルターは、Webアプリケーション内で JFinalフレームワークを使用するためのもので、指定された設定クラスに基づいて JFinalフレームワークの動作が設定されます。

   **コード：**

   ```xml
    <filter>
        <filter-name>jfinal</filter-name>
        <filter-class>com.jfinal.core.JFinalFilter</filter-class>
        <init-param>
            <param-name>configClass</param-name>
            <!-- your jfinal configuration location -->
            <param-value>com.oceanbase.testjfinal.config.UserConfig</param-value>
        </init-param>
    </filter>
   ```

4. JFinalフィルターのマッピングを設定します。

    `jfinal` フィルターはすべてのリクエストパスに適用され、このフィルターはアプリケーション内のすべてのリクエストに適用されます。

   **コード：**

   ```xml
    <filter-mapping>
        <filter-name>jfinal</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
   ```

### UserConfig.javaファイルの紹介

`UserConfig.java` ファイルは、アプリケーションのルーティング、プラグイン、データベース接続などの関連情報の設定に使用されます。

`UserConfig.java` ファイルのコードは、主に以下の部分が含まれます：

1. 他のクラスとインターフェースをインポートします。

    現在のファイルに以下のインターフェースとクラスが含まれていることを宣言します：

    * `StatFilter` クラス：データベースアクセスのパフォーマンスを統計します。
    * `JdbcConstants` クラス：データベースのタイプの定数を定義します。
    * `WallFilter` クラス：SQLインジェクション攻撃を防ぎます
    * `PropKit` クラス：設定ファイルを読み取ります。
    * `ActiveRecordPlugin` クラス：データベースを操作します。
    * `Db` クラス：データベースの操作を実行します。
    * `OracleDialect` クラス：データベースの方言を指定します。
    * `DruidPlugin` クラス：データベースに接続するために使用されます。
    * `Engine` クラス：テンプレートエンジンを設定します。
    * `UserController` クラス：ユーザー関連のリクエストを処理します。
    * `User` クラス：ユーザーデータの転送とストレージに使用されます。

    **コード：**

    ```java
    import com.alibaba.druid.filter.stat.StatFilter;
    import com.alibaba.druid.util.JdbcConstants;
    import com.alibaba.druid.wall.WallFilter;
    import com.jfinal.config.*;
    import com.jfinal.kit.PropKit;
    import com.jfinal.plugin.activerecord.ActiveRecordPlugin;
    import com.jfinal.plugin.activerecord.Db;
    import com.jfinal.plugin.activerecord.dialect.OracleDialect;
    import com.jfinal.plugin.druid.DruidPlugin;
    import com.jfinal.template.Engine;
    import com.oceanbase.testjfinal.controller.UserController;
    import com.oceanbase.testjfinal.pojo.User;
    ```

2. `UserConfig` クラスを定義します。

    `JFinalConfig` クラスの各メソッドをオーバーライドすることで、定数、ルーティング、プラグイン、データベース接続などの情報を設定できます。

   1. `configConstant` メソッドを定義します。

      JFinalフレームワークの設定に使用される定数で、`PropKit` を使用して設定ファイルから設定を読み取ります。

        **コード：**

        ```java
        @Override
        public void configConstant(Constants constants) {
            PropKit.use("config.properties");
        }
        ```

   2. `configRoute` メソッドを定義します。

      ルーティングマッピングを設定するために、`routes.add` メソッドを使用して、`"/hello"` パスを `UserController` クラスのデフォルトアクセスページにマッピングします。

        **コード：**

        ```java
        @Override
        public void configRoute(Routes routes) {
            routes.add("/hello", UserController.class, "/");
        }
        ```

   3. `configEngine` メソッドを定義します。

      テンプレートエンジンを設定するために使用されます。

        **コード：**

        ```java
        @Override
        public void configEngine(Engine engine) {
        }
        ```

   4. `configPlugin` メソッドを定義します。

      アプリケーションのプラグインを設定します。`init` メソッドを呼び出してデータベース接続とテーブル構造を初期化し、`DruidPlugin` と `ActiveRecordPlugin` プラグインを作成して、`plugins` に追加します。同時に、`activeRecordPlugin` の `addMapping` メソッドを呼び出して、データベーステーブルとエンティティクラスのマッピング関係を追加し、`TEST_USER` テーブルを `User` クラスにマッピングします。

        **コード：**

        ```java
        @Override
        public void configPlugin(Plugins plugins) {
            init();
            DruidPlugin druidPlugin = createDruidPlugin();
            plugins.add(druidPlugin);

            ActiveRecordPlugin activeRecordPlugin = createActiveRecordPlugin(druidPlugin);
            activeRecordPlugin.addMapping("TEST_USER", User.class);
            plugins.add(activeRecordPlugin);
        }
        ```

   5. `createDruidPlugin` メソッドを定義します。

      `DruidPlugin` プラグインの作成と関連パラメータの設定に使用されます。接続プールサイズ、SQLファイアウォール、接続エラー処理などが含まれます。

      * `PropKit` の `get` メソッドを呼び出して、URL、ユーザー名、パスワード、ドライバークラスなど、設定ファイル内のデータベース接続関連のプロパティ値を取得します。次に `DruidPlugin` オブジェクトを作成し、取得したプロパティ値を用いて初期化します。
      * `addFilter` メソッドを呼び出して、`DruidPlugin` に `StatFilter` インスタンスを追加します。これは、データベースアクセスのパフォーマンスを統計するために使用されます。`WallFilter` インスタンスを作成し、`setDbType` メソッドでデータベースタイプをOceanBaseに設定して、`DruidPlugin` に追加してSQLファイアウォールフィルタリングを実行します。
      * `setInitialSize` メソッドを呼び出して接続プールの初期サイズを設定します。`setMaxPoolPreparedStatementPerConnectionSize` メソッドで各接続プールのプリペアドステートメントの最大数を設定します。`setTimeBetweenConnectErrorMillis` メソッドで2回の接続エラー間の時間間隔を設定します。`setValidationQuery` メソッドで接続の検証クエリステートメントを設定します。最後に、作成された `DruidPlugin` インスタンスを返します。

        **コード：**

        ```java
        private DruidPlugin createDruidPlugin() {
            DruidPlugin druidPlugin = new DruidPlugin(
                    PropKit.get("db.app.url"),
                    PropKit.get("db.app.user"),
                    PropKit.get("db.app.password"),
                    PropKit.get("db.app.driver")
            );

            druidPlugin.addFilter(new StatFilter());
            WallFilter wallFilter = new WallFilter();
            wallFilter.setDbType(JdbcConstants.OCEANBASE);
            druidPlugin.addFilter(wallFilter);

            druidPlugin.setInitialSize(PropKit.getInt("db.app.poolInitialSize"));
            druidPlugin.setMaxPoolPreparedStatementPerConnectionSize(PropKit.getInt("db.app.poolMaxSize"));
            druidPlugin.setTimeBetweenConnectErrorMillis(PropKit.getInt("db.app.connectionTimeoutMillis"));
            druidPlugin.setValidationQuery("select 1 from dual");

            return druidPlugin;
        }
        ```

   6. `init` メソッドを定義します。

      データベース接続の初期化とデータベーステーブルの作成に使用されます。`initDbConnection` メソッドを呼び出してデータベース接続を初期化し、`ActiveRecordPlugin` インスタンスを返します。次に、SQLステートメントを実行して、ユーザーテーブル `TEST_USER` が存在するかどうかを確認します。ユーザーテーブルが存在しない場合、`CREATE TABLE` ステートメントを実行して `TEST_USER` という名前のデータベーステーブルを作成します。このテーブルには `ID` と `NAME` の2つのフィールドが含まれます。最後に `ActiveRecordPlugin` プラグインの接続をクローズし、データベース接続を解放します。

        **コード：**

        ```java
        public void init() {
            ActiveRecordPlugin arp = initDbConnection();
            boolean tableExists = Db.queryInt("SELECT COUNT(*) FROM USER_TABLES WHERE TABLE_NAME = 'TEST_USER'") > 0;
            if (!tableExists) {
                String sql = "CREATE TABLE TEST_USER (ID NUMBER(10), NAME VARCHAR2(50))";
                Db.update(sql);
            }
            arp.stop();
        }
        ```

   7. `initDbConnection` メソッドを定義します。

      データベースへの接続を初期化するために使用されます。まず、`createDruidPlugin` メソッドを呼び出して `DruidPlugin` オブジェクトを作成し、変数 `druidPlugin` に割り当てます。このメソッドは、`DruidPlugin` の作成と設定を担当し、データベース接続プールの管理に使用されます。次に、`createActiveRecordPlugin` メソッドを呼び出して `ActiveRecordPlugin` オブジェクトを作成し、`DruidPlugin` オブジェクトをパラメータとしてこのメソッドに転送します。このメソッドは、`ActiveRecordPlugin` の作成と設定を担当し、データベース操作の管理に使用されます。その後、`druidPlugin.start` メソッドを呼び出して、`DruidPlugin` を起動し、データベース接続プールを初期化します。最後に `activeRecordPlugin.start` メソッドを呼び出して `ActiveRecordPlugin` を起動します。このメソッドは、設定に基づいてデータベース操作に関する設定を初期化します。

        **コード：**

        ```java
        private ActiveRecordPlugin initDbConnection() {
            DruidPlugin druidPlugin = createDruidPlugin();
            ActiveRecordPlugin activeRecordPlugin = createActiveRecordPlugin(druidPlugin);

            druidPlugin.start();
            activeRecordPlugin.start();

            return activeRecordPlugin;
        }
        ```

   8. `ConfigInterceptor` および `ConfigHandler` メソッドを定義します。

      システム初期化時にグローバル設定を行うために使用されます。

        **コード：**

        ```java
        @Override
        public void configInterceptor(Interceptors interceptors) {
        }

        @Override
        public void configHandler(Handlers handlers) {
        }
        ```

### UserController.javaファイルの紹介

`UserController.java` ファイルは、`getData` メソッドを使用してデータをデータベースに挿入し、データクエリを実行し、クエリ結果をJSON形式でクライアントに返します。JFinalフレームワークが提供する `Db` クラスを用いてデータベース操作を実行し、カスタムの `User` クラスを用いてデータマッピングを行うことで、データベース操作とデータ返却機能を実現します。

`UserController.java` ファイルのコードは主に以下の部分が含まれます：

1. 他のクラスとインターフェースをインポートします。

    現在のファイルに以下のインターフェースとクラスが含まれていることを宣言します：

    * `Controller` クラス：リクエストとレスポンスを処理します。
    * `Db` クラス：データベースの操作を実行します。
    * `User` クラス：データベーステーブルにマッピングします。
    * `List` インターフェース：クエリ結果セットを操作します。

    **コード：**

    ```java
    import com.jfinal.core.Controller;
    import com.jfinal.plugin.activerecord.Db;
    import com.oceanbase.testjfinal.pojo.User;

    import java.util.List;
    ```

2. `UserController` クラスを定義します。

   JFinalフレームワークにコントローラーを提供し、`getData` メソッドを使用してデータベースへのデータ挿入とデータ検索操作を実行します。

   1. データを挿入します。`Db.update` メソッドを使用してSQL挿入ステートメントを実行し、`TEST_USER` という名前のテーブルに2つのデータを挿入します。ID は `1` と `2`、名前はそれぞれ `John` と `Jane` です。
   2. データをクエリします。`User.dao.find` メソッドを使用してSQLクエリステートメントを実行し、`TEST_USER` テーブルに対してすべてのデータのクエリを実行します。クエリ結果は `List` タイプの変数 `users` に代入されます。
   3. JSONデータをレンダリングします。`renderJson` メソッドを使用して、`users` オブジェクトに格納されたデータをJSON形式でレンダリングし、クライアントに返します。
   4. 例外処理を行います。操作の実行中に例外をキャッチした場合、`catch` ステートメントブロックで例外のスタック情報を出力します。

    **コード：**

    ```java
    public class UserController extends Controller {
        public void getData(){

            try {

                // データの挿入
                String insertDataSql = "INSERT INTO TEST_USER (ID, NAME) VALUES (?, ?)";
                Db.update(insertDataSql, 1, "John");
                Db.update(insertDataSql, 2, "Jane");
                //データのクエリ
                List<User> users;
                users = User.dao.find("SELECT * FROM TEST_USER");
                renderJson(users);
            }catch (Exception e){
                e.printStackTrace();
            }
        }

    }
    ```

### User.javaファイルの紹介

`User.java` ファイルは、データベーステーブルとJavaオブジェクトのマッピングを実現するために使用されます。

`User.java` ファイルのコードには、主に以下の部分が含まれます：

1. `Model` クラスをインポートします。

   `Model` クラスはデータベーステーブルのマッピングとデータの操作に使用されます。

2. `User` クラスを定義します。

   `User` クラスは、継承した `Model` クラスが提供するメソッドを使用してデータベース操作を行います。

    **コード：**

    ```java
    import com.jfinal.plugin.activerecord.Model;


        public class User extends Model<User> {
            public static final User dao = new User();

    }
    ```

### 全コード表示

:::tab
tab pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.oceanbase</groupId>
    <artifactId>java-oceanbase-jfinal</artifactId>
    <version>1.0-SNAPSHOT</version>
    <!-- Packaging method (default to jar) -->
    <packaging>war</packaging>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>
    <dependencies>
        <dependency>
            <groupId>com.jfinal</groupId>
            <artifactId>jfinal</artifactId>
            <version>5.0.6</version>
        </dependency>


        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
            <version>1.2.8</version>
        </dependency>

        <dependency>
            <groupId>com.oceanbase</groupId>
            <artifactId>oceanbase-client</artifactId>
            <version>2.4.3</version>
        </dependency>
    </dependencies>
</project>
```

tab config.properties

```properties
db.app.driver=com.oceanbase.jdbc.Driver
db.app.url=jdbc:oceanbase://host:port/schema_name
db.app.user=user_name
db.app.password=
db.app.poolInitialSize=3
db.app.poolMaxSize=10
db.app.connectionTimeoutMillis=100
db.app.validationQuery=select 1 from dual
```

tab web.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://java.sun.com/xml/ns/javaee" xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd" id="WebApp_ID" version="3.0">
    <filter>
        <filter-name>jfinal</filter-name>
        <filter-class>com.jfinal.core.JFinalFilter</filter-class>
        <init-param>
            <param-name>configClass</param-name>
            <!-- your jfinal configuration location -->
            <param-value>com.oceanbase.testjfinal.config.UserConfig</param-value>
        </init-param>
    </filter>

    <filter-mapping>
        <filter-name>jfinal</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
</web-app>
```

tab UserConfig.java

```java
package com.oceanbase.testjfinal.config;

import com.alibaba.druid.filter.stat.StatFilter;
import com.alibaba.druid.util.JdbcConstants;
import com.alibaba.druid.wall.WallFilter;
import com.jfinal.config.*;
import com.jfinal.kit.PropKit;
import com.jfinal.plugin.activerecord.ActiveRecordPlugin;
import com.jfinal.plugin.activerecord.Db;
import com.jfinal.plugin.activerecord.dialect.OracleDialect;
import com.jfinal.plugin.druid.DruidPlugin;
import com.jfinal.template.Engine;
import com.oceanbase.testjfinal.controller.UserController;
import com.oceanbase.testjfinal.pojo.User;

public class UserConfig extends JFinalConfig {
    @Override
    public void configConstant(Constants constants) {
        // Read properties configuration
        PropKit.use("config.properties");
    }

    @Override
    public void configRoute(Routes routes) {
        // Set the default access page for project startup, which does not need to be set in the web.
        routes.add("/hello", UserController.class, "/");
    }

    @Override
    public void configEngine(Engine engine) {
    }

    @Override
    public void configPlugin(Plugins plugins) {
        init();
        DruidPlugin druidPlugin = createDruidPlugin();
        plugins.add(druidPlugin);

        ActiveRecordPlugin activeRecordPlugin = createActiveRecordPlugin(druidPlugin);
        activeRecordPlugin.addMapping("TEST_USER", User.class);
        plugins.add(activeRecordPlugin);
    }

    private DruidPlugin createDruidPlugin() {
        DruidPlugin druidPlugin = new DruidPlugin(
                PropKit.get("db.app.url"),
                PropKit.get("db.app.user"),
                PropKit.get("db.app.password"),
                PropKit.get("db.app.driver")
        );

        druidPlugin.addFilter(new StatFilter());
        WallFilter wallFilter = new WallFilter();
        wallFilter.setDbType(JdbcConstants.OCEANBASE);
        druidPlugin.addFilter(wallFilter);

        druidPlugin.setInitialSize(PropKit.getInt("db.app.poolInitialSize"));
        druidPlugin.setMaxPoolPreparedStatementPerConnectionSize(PropKit.getInt("db.app.poolMaxSize"));
        druidPlugin.setTimeBetweenConnectErrorMillis(PropKit.getInt("db.app.connectionTimeoutMillis"));
        druidPlugin.setValidationQuery("select 1 from dual");

        return druidPlugin;
    }

    private ActiveRecordPlugin createActiveRecordPlugin(DruidPlugin druidPlugin) {
        ActiveRecordPlugin activeRecordPlugin = new ActiveRecordPlugin(druidPlugin);
        activeRecordPlugin.setDialect(new OracleDialect());

        return activeRecordPlugin;
    }

    public void init() {
        ActiveRecordPlugin arp = initDbConnection();
        boolean tableExists = Db.queryInt("SELECT COUNT(*) FROM USER_TABLES WHERE TABLE_NAME = 'TEST_USER'") > 0;
        if (!tableExists) {
            String sql = "CREATE TABLE TEST_USER (ID NUMBER(10), NAME VARCHAR2(50))";
            Db.update(sql);
        }
        arp.stop();
    }

    private ActiveRecordPlugin initDbConnection() {
        DruidPlugin druidPlugin = createDruidPlugin();
        ActiveRecordPlugin activeRecordPlugin = createActiveRecordPlugin(druidPlugin);

        druidPlugin.start();
        activeRecordPlugin.start();

        return activeRecordPlugin;
    }

    @Override
    public void configInterceptor(Interceptors interceptors) {
    }

    @Override
    public void configHandler(Handlers handlers) {
    }
}
```

tab UserController.java

```java
package com.oceanbase.testjfinal.controller;

import com.jfinal.core.Controller;
import com.jfinal.plugin.activerecord.Db;
import com.oceanbase.testjfinal.pojo.User;

import java.util.List;

public class UserController extends Controller {
    public void getData(){

        try {

            // データの挿入
            String insertDataSql = "INSERT INTO TEST_USER (ID, NAME) VALUES (?, ?)";
            Db.update(insertDataSql, 1, "John");
            Db.update(insertDataSql, 2, "Jane");
            //データのクエリ
            List<User> users;
            users = User.dao.find("SELECT * FROM TEST_USER");
            renderJson(users);
        }catch (Exception e){
            e.printStackTrace();
        }
    }

}
```

tab User.java

```java
package com.oceanbase.testjfinal.pojo;

import com.jfinal.plugin.activerecord.Model;


    public class User extends Model<User> {
        public static final User dao = new User();

}
```

:::

## 関連ドキュメント

その他のOceanBase Connector/Jに関する情報は、[OceanBase JDBCドライバー](https://en.oceanbase.com/docs/common-oceanbase-connector-j-en)を参照してください。
