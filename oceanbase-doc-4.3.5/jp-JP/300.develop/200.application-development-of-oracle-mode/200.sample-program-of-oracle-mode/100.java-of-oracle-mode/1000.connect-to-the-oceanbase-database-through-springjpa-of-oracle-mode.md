|description||
|---|---|
|keywords||
|dir-name|SpringDataJPA|
|dir-name-en||
|tenant-type|Oracle Mode|

# SpringDataJPA

本記事では、SpringDataJPAフレームワークとOceanBaseデータベースを使用して、テーブルの作成、データの挿入、クエリなどの基本的な操作を実現するアプリケーションの構築方法を紹介します。

<div role="videolist">
      <a role='link' href='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/java/java-oceanbase-springdatajpa/java-oceanbase-springdatajpa.zip'>
          <img src='https://file.oceanbase.com/doc/img/lQLPJyFovGIOcJQWFrAqhLlgRRsPvwU-H7hJ_i0A_22_22.png'/>
          クリックしてjava-oceanbase-springdatajpaサンプルプロジェクトをダウンロード
      </a>
      <!-- <a role='video' href='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/video-center/video/video/04%20java-ob-springdatajpa_e04.mp4'>
          <img src='https://mdn.alipayobjects.com/huamei_22khvb/afts/img/A*DFPmToHK6hgAAAAAAAAAAAAADiGDAQ/original'/>
          SpringDataJPA 连接 OceanBase 数据库示例程序（Oracle 模式）
       </a> -->
</div>

## 前提条件

* OceanBaseデータベースがインストール済みであること。
* JDK 1.8とMavenがインストール済みであること。
* IntelliJ IDEAがインストール済みであること。

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>この記事でコードを実行するために使用したツールは、IntelliJ IDEA 2021.3.2（Community Edition）バージョンです。ご自身の好みに合わせて、適切なツールを選択してサンプルコードを実行することも可能です。</p>
</main>

## 操作手順

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>本記事で示されている操作手順は、Windows環境に基づいています。他のOS環境やコンパイラを使用している場合は、操作手順が若干異なる場合があります。 </p>
</main>

1. OceanBaseデータベースの接続文字列を取得します。
2. `java-oceanbase-springdatajpa` プロジェクトをIDEAにインポートします。
3. `java-oceanbase-springdatajpa` プロジェクトのデータベース接続情報を修正します。
4. `java-oceanbase-springdatajpa` プロジェクトを実行します。

### ステップ１：OceanBaseデータベースの接続文字列を取得する

1. OceanBaseデータベースのデプロイ担当者または管理者から、該当するデータベース接続文字列を取得します。

    ```shell
    obclient -hxx.xx.xx.xx -P2883 -uroot@sys#cluster -p**** -A
    ```

2. デプロイ済みのOceanBaseデータベースに基づいて、以下のURLの対応する情報を入力します。

    <main id="notice" type='explain'>
    <h4>説明</h4>
    <p> <code>application.yml</code> ファイルには、このURL情報が必要です。</p>
    </main>

    ```java
    jdbc:oceanbase://host:port/schema_name?user=$user_name&password=$password&characterEncoding=utf-8&useSSL=false&serverTimezone=GMT%2B8
    ```

    **パラメータの説明：**

    * `host`：OceanBaseデータベースへの接続IPアドレス。ODP接続方式ではODPアドレスを使用し、直接接続方式ではOBServerノードのIPアドレスを使用します。
    * `port`：OceanBaseデータベースへの接続ポート。ODP接続方式のデフォルトポートは`2883`で、ODPデプロイ時にカスタマイズ可能です。直接接続方式のデフォルトポートは`2881`で、OceanBaseデータベースのデプロイ時にカスタマイズ可能です。
    * `schema_name`：アクセスするスキーマ名です。
    * `user_name`：テナントの接続アカウント。ODP接続方式の一般的な形式には次の2種類があります：`ユーザー名@テナント名#クラスタ名` または `クラスタ名:テナント名:ユーザー名`。直接接続方式の形式：`ユーザー名@テナント名`。
    * `password`：アカウントのパスワード。
    * `characterEncoding=utf-8&useSSL=false&serverTimezone=GMT%2B8`:追加の接続プロパティです。

        * `characterEncoding`：データベースURLオプションをサポートする文字エンコーディングです。デフォルト値は `utf8` です。
        * `useSSL`：強制接続時に `SSL/TLS` を使用するかどうかを指定します。 デフォルト値は `false` です。
        * `serverTimezone`：サーバーのタイムゾーンを設定します。デフォルト値は中国標準時です。

その他のURLパラメータの説明情報については、[データベースURL](https://en.oceanbase.com/docs/common-oceanbase-connector-j-en-10000000002244946)を参照してください。

### ステップ2：`java-oceanbase-springdatajpa` プロジェクトをIDEAにインポートする

1. **IntelliJ IDEA** を開き、**File > Open...** オプションを選択します。

   ![file](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/java/mybatis/file.jpg)

2. 表示された **Open File or Project** ウィンドウで、対応するプロジェクトファイルを選択し、**OK** をクリックしてプロジェクトファイルのインポートを完了します。

3. IntelliJ IDEA は、プロジェクト内のさまざまなファイルの種類を自動的に認識し、**Project** ツールウィンドウで、プロジェクトのディレクトリ構造、ファイルリスト、モジュールリスト、依存関係などの情報を確認できます。**Project** ツールウィンドウは通常、IntelliJ IDEA画面の左側にあり、デフォルトでは開いています。**Project** ツールウィンドウが閉じている場合は、メニューバーの **View > Tool Windows > Project** をクリックするか、ショートカットキー **Alt + 1** を使用して再表示できます。

    <main id="notice" type='explain'>
    <h4>説明</h4>
    <p>IntelliJ IDEAでプロジェクトをインポートすると、IntelliJ IDEAはプロジェクト内のpom.xmlファイルを自動的に検出し、ファイルに記述されている依存関係に基づいて必要な依存ライブラリを自動的にダウンロードし、プロジェクトに追加します。</p>
    </main>

4. プロジェクトの状況を確認します。

  ![springdatajpa](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/java/java-oceanbase-springdatajpa/chakan%20springdatajpa.jpg)

### ステップ3：`java-oceanbase-springdatajpa` プロジェクトのデータベース接続情報を修正する

**ステップ１：OceanBaseデータベースの接続文字列を取得する** に記載されている情報に基づいて、`application.yml` ファイル内のデータベース接続情報を修正します。

**例：**

* データベースドライバーの名前：`com.oceanbase.jdbc.Driver`
* OBServerノードのIPアドレスは `10.10.10.1` です。
* アクセスポートは2881を使用します。
* アクセスするスキーマ名は `sys` です。
* テナントの接続アカウントは `sys@xyoracle` です。`xyoracle` はOceanBaseデータベース内に作成されたOracleモードのユーザーテナントであり、`sys` はテナント `xyoracle` のユーザー名です。
* パスワードは `******` です。

**サンプルコードは以下のとおりです：**

```java
spring:
  datasource:
    driver-class-name: com.oceanbase.jdbc.Driver
    url: jdbc:oceanbase://10.10.10.1:2881/sys?characterEncoding=utf-8&useSSL=false&serverTimezone=GMT%2B8
    username: sys@xyoracle
    password:******
    type: com.alibaba.druid.pool.DruidDataSource
```

### ステップ4：`java-oceanbase-springdatajpa` プロジェクトを実行する

#### 実行パス

1. プロジェクト構造の **src > test > java** フォルダから `TestSpringDataJpaApplicationTests.java` ファイルを見つけます。
2. ツールメニューバーで **Run > Run... > TestSpringDataJpaApplicationTests.contextLoads** を選択するか、右上の緑色の三角形をクリックして直接実行します。
3. IDEAのコンソールを使用して、プロジェクトのログ情報と出力結果を確認します。

#### 実行結果

```java
User{id=4, username='insert4'}
User{id=5, username='insert5'}
User{id=6, username='insert6'}
User{id=7, username='insert7'}
User{id=8, username='insert8'}
```

## プロジェクトコードについて

[java-oceanbase-springdatajpa](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/java/java-oceanbase-springdatajpa/java-oceanbase-springdatajpa.zip) をクリックしてプロジェクトコードをダウンロードしてください。これは `java-oceanbase-springdatajpa` という名前の圧縮ファイルです。

解凍すると、`java-oceanbase-springdatajpa` という名前のフォルダが作成されます。ディレクトリ構造は以下のとおりです：

```java
│--pom.xml
│
├─.idea
│
├─src
│  ├─main
│  │  ├─java
│  │  │  └─com
│  │  │      └─oceanbase
│  │  │          └─testspringdatajpa
│  │  │              │--TestSpringDataJpaApplication.java
│  │  │              │
│  │  │              ├─dao
│  │  │              │   └─UserRepository.java
│  │  │              │
│  │  │              ├─entity
│  │  │              │   └─User.java
│  │  │              │
│  │  │              └─service
│  │  │                  │--UserService.java
│  │  │                  │
│  │  │                  └─impl
│  │  │                      └─--UserServiceImpl.java
│  │  │
│  │  └─resources
│  │      │--application.yml
│  │      │
│  │      ├─static
│  │      └─templates
│  └─test
│      └─java
│          └─com
│              └─oceanbase
│                  └─testspringdatajpa
│                      └─--TestSpringDataJpaApplicationTests.java
│
└─target
```

**ファイルの説明：**

* `pom.xml`：Mavenプロジェクトの設定ファイルは、プロジェクトの依存関係、プラグイン、ビルドなどの情報が含まれます。
* `.idea`：IDE（統合開発環境）で使用されるディレクトリで、プロジェクト関連の設定情報を格納するために使用されます。
* `src`：通常、プロジェクトのソースコードを格納するディレクトリを表すために使用されます。
* `main`: 主要なソースコードとリソースファイルを格納するディレクトリ。
* `java`: Javaソースコードを格納するディレクトリ。
* `com`: Javaパッケージを格納するルートディレクトリ。
* `oceanbase`: プロジェクトを格納するルートディレクトリ。
* `testspringdatajpa`：プロジェクトのすべてのJavaクラスが含まれているJavaパッケージのルートディレクトリです。
* `TestSpringDataJpaApplication.java`：Spring Bootアプリケーションのエントリクラス。
* `dao`: データアクセスオブジェクト（Data Access Object）パッケージを格納するディレクトリで、データベースや他のデータストレージサービスにアクセスするために使用されます。
* `UserRepository.java`：ユーザーデータアクセスインターフェースで、ユーザーデータの追加、削除、更新、クエリ操作を定義します。
* `entity`：エンティティクラスのディレクトリで、データベーステーブルに対応するJavaクラスを格納するために使用されます。
* `User.java`：ユーザー永続化オブジェクトで、ユーザーデータテーブルのフィールドをマッピングするために使用されます。
* `service`：サービスインターフェースディレクトリで、ビジネスロジックインターフェースを定義するために使用されます。
* `UserService.java`：ユーザーサービスインターフェースで、ユーザーデータの操作メソッドを定義しています。
* `impl`：サービス実装ディレクトリで、ビジネスロジックの実装クラスを格納するために使用されます。
* `UserServiceImpl.java`：ユーザーサービスの実装クラスで、UserServiceインターフェースで定義されたメソッドを実装しています。
* `resources`: リソースファイルを格納するディレクトリで、設定ファイル、SQLファイルなどが含まれます。
* `application.yml`：アプリケーションの設定ファイルで、データベース接続など情報の設定に使用されます。
* `static`：CSS、JavaScriptなどの静的ファイルを格納します。
* `templates`：HTMLテンプレートなどのテンプレートファイルを格納します。
* `test`: テストコードとリソースファイルを格納するディレクトリです。
* `TestSpringDataJpaApplicationTests.java`: Spring Data JPAに関連する機能を実行および検証するためのクラスを格納します。
* `target`: コンパイル済みのClassファイル、Jarパッケージなどのファイルを格納するディレクトリ。

### pom.xmlのコード紹介

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>例を確認するだけの場合、デフォルトコードを使用してください。変更する必要はありません。以下の説明に従って、必要に応じて <code>pom.xml</code> ファイルを変更することもできます。</p>
</main>

`pom.xml` 設定ファイルの内容は以下のとおりです：

1. ファイル宣言ステートメントです。

    このファイルがXMLファイルであり、使用しているXMLのバージョンが `1.0` で、文字エンコーディング方式が `UTF-8` であることを宣言しています。

    **コード：**

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    ```

2. POMのネームスペースとPOMモデルのバージョンを設定します。

   1. `xmlns` を使用して、POMのネームスペースを `http://maven.apache.org/POM/4.0.0` と指定します。
   2. `xmlns:xsi` を使用して、XMLネームスペースを `http://www.w3.org/2001/XMLSchema-instance` に指定します。
   3. `xsi:schemaLocation` を使用して、POMのネームスペースを `http://maven.apache.org/POM/4.0.0`、POMのXSDファイルの場所を `https://maven.apache.org/xsd/maven-4.0.0.xsd` と指定します。
   4. `<modelVersion>` 要素を使用して、このPOMファイルで使用されるPOMモデルのバージョンを `4.0.0` に指定します。

   **コード：**

   ```xml
   <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
        <modelVersion>4.0.0</modelVersion>
   ```

3. 親要素の情報を設定します。

   1. `<groupId>` を使用して、親要素の識別子を `org.springframework.boot` と指定します。
   2. `<artifactId>` を使用して、親要素の依存関係を `spring-boot-starter-parent` と指定します。
   3. `<version>` を使用して、親要素のバージョン番号を `2.7.0` と指定します。
   4. `relativePath` を使用して、親要素のパスが空であることを示します。

   **コード：**

   ```xml
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.7.0</version>
        <relativePath/>
    </parent>
   ```

4. 基本情報を設定します。

   1. `<groupId>` を使用して、プロジェクト識別子を `com.oceanbase` に指定します。
   2. `<artifactId>` を使用して、プロジェクトの依存関係を `java-oceanbase-springdatajpa` と指定します。
   3. `<version>` を使用して、プロジェクトのバージョン番号を `0.0.1-SNAPSHOT` と指定します。
   4. `description` を使用して、プロジェクトの情報を `Demo project for Spring Boot` として紹介します。

   **コード：**

   ```xml
    <groupId>com.oceanbase</groupId>
    <artifactId>java-oceanbase-springdatajpa</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>java-oceanbase-springdatajpa</name>
    <description>Demo project for Spring Boot</description>
   ```

5. Javaバージョンを設定します。

    プロジェクトで使用するJavaバージョンを1.8と指定します。

    **コード：**

    ```xml
      <properties>
          <java.version>1.8</java.version>
      </properties>
    ```

6. コア依存関係を設定します。

   1. 依存関係が所属する組織を `org.springframework.boot`、名前を `spring-boot-starter-data-jpa` と指定します。この依存ライブラリにはJPAを使用したデータアクセスに必要な依存関係と設定が含まれています。Spring Boot Starter Data JPAはSpring Bootのスターターです。

        **コード：**

        ```xml
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        ```

   2. 依存関係が所属する組織を `org.springframework.boot`、名前を `spring-boot-starter-web` と指定します。この依存ライブラリにはSpring Bootを使用したWeb開発に必要な依存関係と設定が含まれています。Spring Bootのスターターです。

        **コード：**

        ```xml
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        ```

   3. 依存関係が所属する組織を `org.springframework.boot`、名前を `spring-boot-starter-test`、スコープを `test` と指定します。この依存関係により、JUnit、Mockito、HamcrestなどのSpring Bootが提供するテストフレームワークとツールを利用できます。

        **コード：**

        ```xml
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        ```

   4. 依存関係が所属する組織を `com.alibaba`、名前を `druid`、バージョン番号を `1.2.8` と指定します。この依存関係により、Druidライブラリを使用して、データベース接続の取得と解放を管理・最適化できます。

      **コード：**

        ```xml
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
            <version>1.2.8</version>
        </dependency>
        ```

   5. 依存関係が所属する組織を `com.oceanbase`、名前を `oceanbase-client`、バージョン番号を `2.4.3` と指定します。この依存関係により、OceanBaseが提供するクライアント機能（接続、クエリ、トランザクションなど）を使用できます。

      **コード：**

        ```xml
            <dependencies>
            <dependency>
                <groupId>com.oceanbase</groupId>
                <artifactId>oceanbase-client</artifactId>
                <version>2.4.2</version>
            </dependency>
            </dependencies>
        ```

7. Mavenプラグインを設定します。

   依存関係が所属する組織を `org.springframework.boot`、名前を `spring-boot-maven-plugin` と指定します。このプラグインはSpring Bootアプリケーションを実行可能なJARパッケージまたはWARパッケージにパッケージ化するために使用され、直接実行できます。他のプラグインやツールとの競合を避けるため、ビルドプロセスでLombok依存関係を追加しています。

   **コード：**

   ```xml
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
   ```

### application.ymlのコード紹介

`application.yml` ファイルはSpring Bootアプリケーションの設定ファイルで、いくつかの重要な構成パラメータが含まれています。アプリケーションのコンテキストパス、リスニングポート番号、データベース接続情報、およびJPA関連のプロパティを設定します。

`application.yml` ファイルのコードには、主に以下のセクションが含まれています:

* `Server` セクション
  * `servlet`：Servlet関連のプロパティを設定するために使用されます。
  * `context-path`：アプリケーションのコンテキストパスを `testspringdatajpa` と指定します。
  * `port`：アプリケーションがリッスンするポート番号を8890と指定します。

  **コード：**

    ```yml
    server:
    servlet:
        context-path: /testspringdatajpa
    port: 8890
    ```

* `Spring` セクション
  * `datasource`：データソース関連のプロパティ、つまりデータベース接続情報を設定するために使用されます。
    * `driver-class-name`：データベースドライバーのクラス名を `com.oceanbase.jdbc.Driver` と指定します。
    * `url`：データベースの接続URLを指定します。データベースのアドレス、ポート番号、データベース名などの情報が含まれます。
    * `username`：データベースに接続するためのユーザー名を指定します。
    * `password`：データベースに接続するためのパスワードを指定します。
    * `type`：データソースとしてDruid接続プールを使用することを指定します。

    **コード：**

    ```yml
    spring:
    datasource:
        driver-class-name: com.oceanbase.jdbc.Driver
        url: jdbc:oceanbase://host:port/schema_name?characterEncoding=utf-8&useSSL=false&serverTimezone=GMT%2B8
        username: user_name
        password: ******
        type: com.alibaba.druid.pool.DruidDataSource
    ```

  * `JPA` セクション
    * `hibernate`：Hibernate関連のプロパティを設定するために使用されます。
      * `ddl-auto`：起動時にデータベース構造を自動的に更新するようHibernateを `update` と指定します。
      * `show-sql`：コンソールにSQLステートメントを表示するかどうかを `true` と指定します。
      * `format-sql`：表示されるSQLステートメントをフォーマットするかどうかを `true` と指定します。
    * `open-in-view`：`Open-in-View` モードを有効にするかどうかを `false` と指定します。

    **コード：**

    ```yml
    jpa:
        hibernate:
        ddl-auto: update
        show-sql: true
        format-sql: true
        open-in-view: false
    ```

### userRepository.javaファイルの紹介

`userRepository.java` ファイルはDAOインターフェースを通じて、ユーザーエンティティ（User）に対するデータベース操作メソッドを定義しています。SQLステートメントとHQLステートメントを使用して操作するカスタム更新・クエリメソッドが含まれています。

`userRepository.java` ファイルのコードには、主に以下のセクションが含まれています：

1. 他のクラスとインターフェースをインポートします。

    このファイルに以下のインターフェースとクラスが含まれていることを宣言します：

    * `User` クラス：サービスクラスでユーザーオブジェクトを操作および処理するために使用されます。
    * `JpaRepository` インターフェース：このインターフェースを継承することにより、基本的なCRUD操作メソッドを取得するために使用されます。
    * `Modifying` アノテーション：修正操作のメソッドをマークするために使用されます。
    * `Query` アノテーションは、カスタムクエリメソッドを定義するために使用されます。
    * `Param` アノテーションは、メソッドのパラメータをクエリステートメントのパラメータにマッピングするために使用されます。
    * `Repository` アノテーションは、DAOインターフェースをSpringのリポジトリコンポーネントとしてマークするために使用されます。

    **コード：**

    ```java
    import com.oceanbase.testspringdatajpa.entity.User;
    import org.springframework.data.jpa.repository.JpaRepository;
    import org.springframework.data.jpa.repository.Modifying;
    import org.springframework.data.jpa.repository.Query;
    import org.springframework.data.repository.query.Param;
    import org.springframework.stereotype.Repository;
    ```

2. `UserRepository` インターフェースを定義します。

   `UserRepository` インターフェースは、ユーザーデータにアクセスするために使用されます。Springの `Repository` コンポーネントとしてマークし、`bean` の名前を `userRepository` と指定します。
   1. `@Query` アノテーションを使用してSQLステートメントを指定し、`nativeQuery = true` を使用してネイティブSQLステートメントを使用します。
   2. `@Modifying` アノテーションを使用してカスタム更新メソッドを定義し、ネイティブSQLステートメントを使用して更新操作を行います。
   3. `@Query` アノテーションを使用してHQL（Hibernate Query Language）ステートメントを指定し、`@Param` アノテーションを使用してメソッドパラメータをHQLステートメント内のパラメータにマッピングします。

    **コード：**

    ```java
    @Repository("userRepository")
    public interface UserRepository extends JpaRepository<User, Integer> {

        @Query(value = "update test_springdatajpa_2 set username=?1 where id=?2", nativeQuery = true)
        @Modifying
        int updateById(String name, String id);

        @Query("SELECT u FROM User u WHERE u.username = :username")
        User findUser(@Param("username") String username);
    }
    ```

### User.javaファイルの紹介

`User.java` ファイルは、ユーザーオブジェクトを表すUserクラスを定義します。

`User.java` ファイルのコードには、主に以下の部分が含まれます：

1. 他のクラスをインポートします。
   `javax.persistence.*`：`javax.persistence` パッケージ内のすべてのクラスをインポートするために使用されます。`javax.persistence` はJava Persistence API（JPA）の標準パッケージで、オブジェクト関係マッピング（ORM）を行うためのインターフェースとアノテーションのセットを提供しています。

    **コード：**

    ```java
    import javax.persistence.*;
    ```

2. `User` オブジェクトを定義します。
   JPAアノテーションを使用して、エンティティクラスとテーブルのマッピング関係を識別します。テーブル名、主キー、フィールド名などが含まれます。
   `@Entity` アノテーションを使用して、このクラスをエンティティクラスとしてマークします。`@Table` アノテーションを使用して、対応するデータベーステーブル名を指定します。`@Id` アノテーションを使用して、エンティティクラスの主キーをマークします。`@GeneratedValue` アノテーションを使用して、主キーの生成戦略を指定します。`@Column` アノテーションは、フィールド名と制約条件を指定するために使用します。このクラスは `id` と `username` という2つのプロパティを持ち、それぞれユーザーの一意の識別子とユーザー名を表します。空の `User` オブジェクトを作成するためのデフォルトコンストラクタも提供されています。

    **コード：**

    ```java
    @Entity
    @Table(name = "test_springdatajpa_2")
    public class User {
        @Id
        @GeneratedValue(strategy = GenerationType.TABLE)
        @Column(name = "id", nullable = false)
        private Integer id;

        @Column(name = "username")
        private String username;

        public User() {
        }
    }
    ```

3. `id` と `name` の値を取得および設定します。
   このエンティティクラスは、`id` と `username` プロパティを初期化するためのパラメータ付きコンストラクタを提供します。
   4つのメソッドが定義されており、`id` と `name` プロパティの値を取得および設定するために使用されます。
   * `getId` メソッドは `id` 値を取得するために使用されます。
   * `setId` メソッドは `id` 値を設定するために使用されます。
   * `getName` メソッドはユーザー名 `name` の値を取得するために使用されます。
   * `setName` メソッドはユーザー名 `name` の値を設定するために使用されます。

    **コード：**

    ```java

    public User(Integer id, String username) {
        this.id = id;
        this.username = username;
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }
    ```

4. `User` オブジェクトの文字列表現を返します。

    `User` クラスの `toString` メソッドをオーバーライドして、`User` オブジェクトの文字列表現を返します。
    `@Override` を定義して、親クラスの同名メソッドをオーバーライドします。`toString` メソッドを定義して、`User` オブジェクトの文字列表現を返すために使用します。文字列連結を使用して、`id` と `name` プロパティの値を文字列としてフォーマットし、呼び出し元の `User` に返します。

    **コード：**

    ```java
    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", username='" + username + '\'' +
                '}';
    }
    ```

### UserServiceImpl.javaファイルの紹介

`UserServiceImpl.java` ファイルは、JPAを使用してデータベースを操作し、ユーザーデータの追加、削除、更新、クエリを行います。

`UserServiceImpl.java` ファイルのコードには、主に以下のセクションが含まれています：

1. 他のクラスとインターフェースをインポートします。

   このファイルに以下のインターフェースとクラスが含まれていることを宣言します：
   * `UserRepository` クラス:データアクセスオブジェクト（DAO）に定義されたメソッドをサービスクラスで注入して呼び出すために使用されます。
   * `User` クラス：サービスクラスでユーザーオブジェクトを操作および処理するために使用されます。
   * `UserService` クラス：サービスクラスに定義されたメソッドを他のクラスで注入して呼び出すために使用されます。
   * `Autowired` アノテーション：依存オブジェクトを自動的に注入するために使用されます。
   * `Page` クラス：ページネーションクエリ結果をカプセル化するために使用されます。
   * `PageRequest` クラス：ページネーションリクエストオブジェクトを作成するために使用されます。
   * `Pageable` インターフェース：ページネーションリクエストを定義するためのインターフェースです。
   * `Sort` クラス:照合順序を定義するために使用されます。
   * `Service` アノテーション：クラスをサービスクラスとしてマークするために使用されます。
   * `Transactional` アノテーション：トランザクションメソッドをマークするために使用されます。
   * `Iterator` クラス：コレクションをイテレーションするために使用されます。
   * `Optional` クラス：空である可能性のあるオブジェクトを処理するために使用されます。

    **コード：**

    ```java
    import com.oceanbase.testspringdatajpa.dao.UserRepository;
    import com.oceanbase.testspringdatajpa.entity.User;
    import com.oceanbase.testspringdatajpa.service.UserService;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.data.domain.Page;
    import org.springframework.data.domain.PageRequest;
    import org.springframework.data.domain.Pageable;
    import org.springframework.data.domain.Sort;
    import org.springframework.stereotype.Service;
    import org.springframework.transaction.annotation.Transactional;

    import java.util.Iterator;
    import java.util.Optional;
    ```

2. `UserServiceImpl` クラスは、`UserService` インターフェースで宣言されたメソッドを実装しています。

    `UserRepository` を依存性注入することで、データベースへのアクセスを実現します。具体的には、ユーザーデータの挿入、削除、更新、クエリのメソッドを実装し、ページネーションクエリもサポートしています。`@Transactional` アノテーションを使用してトランザクションサポートを有効化し、データベース操作がトランザクション内で実行されることを保証します。

    1. `UserRepository` プロパティを構築します。
       プライベートな `UserRepository` プロパティを定義し、コンストラクタで `@Autowired` アノテーションを使用して依存性注入を行います。コンストラクタインジェクションを使用して `UserRepository` の依存関係を注入し、`userRepository` プロパティを使用してユーザーデータにアクセスおよび操作します。

        **コード：**

        ```java
        private final UserRepository userRepository;

        @Autowired
        public UserServiceImpl(UserRepository userRepository) {
            this.userRepository = userRepository;
        }
        ```

    2. ユーザーデータを挿入します。
       `insertUser` メソッドは `User` オブジェクトをパラメータとして受け取り、`UserRepository` の `save` メソッドを呼び出して、ユーザーオブジェクトをデータベースに保存します。

        **コード：**

        ```java
        @Override
        public void insertUser(User user) { userRepository.save(user); }
        ```

    3. ユーザーデータを削除します。
       `deleteUser` メソッドでは、`UserRepository` の `existsById` メソッドを呼び出して、指定されたidのユーザーが存在するかどうかを判断します。存在する場合は削除操作を行い、存在しない場合はそのまま戻ります。

        **コード：**

        ```java
        @Override
        public void deleteUser(Integer id) {
            if (!userRepository.existsById(id)) {
                return;
            }
        }
        ```

    4. ユーザーデータを更新します。
       `updateUser` メソッドでは、`UserRepository` の `save` メソッドを呼び出し、ユーザーオブジェクトをデータベースに保存して更新操作を実行します。同時に、更新操作が成功したことを示す整数値 `1` を返します。
       また、ユーザー名と `id` に基づいてユーザーデータを更新するメソッドも、`UserRepository` の `updateById` メソッドを呼び出して更新操作を実行し、更新結果を返します。

        **コード：**

        ```java
        @Override
        public int updateUser(User user) {
            userRepository.save(user);
            return 1;
        }

        //update based on name and id
        @Override
        public int updateUserById(String name, String id) {
            return userRepository.updateById(name, id);
        }
        ```

    5. ユーザーデータのクエリを実行します。
       1. `ID` に基づいてユーザーデータのクエリを実行します。
          `selectUserById` メソッドでは、`UserRepository` の `findById` メソッドを呼び出してユーザーデータのクエリを実行し、結果を `Optional` オブジェクトにカプセル化します。次に、`Optional` の `orElse` メソッドを呼び出して、`Optional` オブジェクト内の値を取得し、`user` 変数に代入します。最後に、クエリで取得したユーザーオブジェクトを返します。
       2. ユーザー名に基づいてユーザーデータのクエリを実行します。
          `selectUserByName` メソッドでは、`UserRepository` の `findUser` メソッドを呼び出して、ユーザー名に基づいてユーザーデータのクエリを実行し、クエリで取得したユーザーオブジェクトを直接返します。

        **コード：**

        ```java
        @Override
        public User selectUserById(Integer id) {
            Optional<User> optional = userRepository.findById(id);
            User user = optional.orElse(null);
            return user;
        }
        @Override
        public User selectUserByName(String username) {
            return userRepository.findUser(username);
        }
        ```

    6. すべてのユーザーデータのページネーションクエリを実行します。
       `selectUserAll` メソッドでは、`Sort` オブジェクトを作成して照合順序を指定し、`Pageable` オブジェクトを作成してページネーションパラメータを指定します。`UserRepository` の `findAll` メソッドを呼び出してユーザーデータのクエリを実行し、`Page` オブジェクトを返します。次に、`Page` オブジェクトの `iterator` メソッドを呼び出して、ユーザーデータのイテレータを取得します。最後に、ユーザーデータのイテレータを返します。

        **コード：**

        ```java
        @Override
        public Iterator<User> selectUserAll(Integer pageNum, Integer pageSize) {
            Sort sort = Sort.by(Sort.Direction.ASC, "id");
            Pageable pageable = PageRequest.of(pageNum, pageSize, sort);
            Page<User> users = userRepository.findAll(pageable);
            Iterator<User> userIterator = users.iterator();
            return userIterator;
        }
        ```

### UserService.javaファイルの紹介

`UserService.java` ファイルは、JPAを使用してデータベースを操作し、ユーザーデータの追加、削除、更新、クエリを行います。

`UserService.java` ファイルのコードには、主に以下のセクションが含まれています：

1. 他のクラスとインターフェースをインポートします。

   このファイルに以下のクラスが含まれていることを宣言します：
   * `User` クラス：サービスクラスでユーザーオブジェクトを操作および処理するために使用されます。
   * `Iterator` クラスは、コレクションをイテレーションするために使用されます。

    **コード：**

    ```java
    import com.oceanbase.testspringdatajpa.entity.User;

    import java.util.Iterator;
    ```

2. `UserService` インターフェースを定義します。
   `UserService` インターフェースを使用して、ユーザーデータの挿入、削除、更新、クエリのメソッドを定義します。以下のメソッドとクラスが含まれています：
   * `insertUser` メソッドは、ユーザーデータの挿入に使用されます。
   * `deleteUser` メソッドは、ユーザーデータの削除に使用されます。
   * `updateUser` メソッドは、ユーザーデータの更新に使用されます。
   * `updateUserById` メソッドは、`id` に基づいてユーザーの `name` を更新するために使用されます。
   * `selectUserById` メソッドは、`id` に基づいてユーザーデータのクエリを実行するために使用されます。
   * `selectUserByName` メソッドは、ユーザー名に基づいてユーザーデータのクエリを実行するために使用されます。
   * `selectUserAll` メソッドは、すべてのユーザーデータのページネーションクエリを実行するために使用されます。

   * `User` クラスは、サービスクラスとしてユーザーオブジェクトを操作および処理するために使用されます。
   * `Iterator` クラスは、コレクションをイテレーションするために使用されます。

    **コード：**

    ```java
    public interface UserService {
        void insertUser(User user);

        void deleteUser(Integer id);

        int updateUser(User user);

        int updateUserById(String name, String id);

        User selectUserById(Integer id);

        User selectUserByName(String username);
        Iterator<User> selectUserAll(Integer pageNum, Integer pageSize);
    }
    ```

### TestSpringDataJpaApplication.javaファイルの紹介

`TestSpringDataJpaApplication.java` ファイルは、Spring Bootアプリケーションの起動と設定に使用されます。

`TestSpringDataJpaApplication.java` ファイルのコードには、主に以下のセクションが含まれています：

1. クラスとインターフェースを定義します。
   このファイルに以下のクラスが含まれていることを宣言します：
   * `SpringApplication` クラスは、Spring Bootアプリケーションを起動するために使用されます。
   * `@SpringBootApplication` アノテーションは、Spring Bootアプリケーションのエントリクラスをマークするために使用されます。

    **コード：**

    ```java
    import org.springframework.boot.SpringApplication;
    import org.springframework.boot.autoconfigure.SpringBootApplication;
    ```

2. `TestSpringDataJpaApplication` クラスを定義します。
   `@SpringBootApplication` アノテーションを使用してSpring Bootアプリケーションのエントリクラスをマークし、`main` メソッドで `SpringApplication.run` メソッドを呼び出してアプリケーションを起動します。

    **コード：**

    ```java
    @SpringBootApplication
    public class TestSpringDataJpaApplication {

        public static void main(String[] args) {
            SpringApplication.run(TestSpringDataJpaApplication.class, args);
        }
    }
    ```

### TestSpringDataJpaApplicationTests.javaファイルの紹介

`TestSpringDataJpaApplicationTests.java` ファイルは、Spring Bootアプリケーションの起動と設定に使用されます。

`TestSpringDataJpaApplicationTests.java` ファイルのコードには、主に以下のセクションが含まれています：

1. 他のクラスとインターフェースをインポートします。
   このファイルに以下のクラスが含まれていることを宣言します：
   * `User` クラス：サービスクラスでユーザーオブジェクトを操作および処理するために使用されます。
   * `UserService` クラスは、他のクラスで注入されることにより、サービスクラスで定義されたメソッドを呼び出すために使用されます。
   * `@Test` アノテーションは、テストメソッドをマークするために使用されます。
   * `Autowired` アノテーションは、依存関係オブジェクトの自動注入に使用されます。
   * `@SpringBootTest` アノテーションは、Spring Bootアプリケーションのテストに使用されます。
   * `Iterator` クラスは、コレクションをイテレーションするために使用されます。

    **コード：**

    ```java
    import com.oceanbase.testspringdatajpa.entity.User;
    import com.oceanbase.testspringdatajpa.service.UserService;
    import org.junit.jupiter.api.Test;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.boot.test.context.SpringBootTest;

    import java.util.Iterator;
    ```

2. `UserService` メソッドを定義します。
   Spring Bootアプリケーションの `UserService` サービスの各メソッドをテストするために使用されます。`UserService` 依存関係を注入し、各メソッドを呼び出してユーザーデータの挿入、削除、更新、クエリの機能をテストし、関連する結果を出力します。

   1. `@Autowired` アノテーションを使用します。
      `UserService` インターフェースの実装クラスを `userService` 変数に自動的に注入します。

        **コード：**

        ```java
        @Autowired
        private UserService userService;
        ```

   2. `contextLoads` メソッドを使用してテストを行います。

      1. ユーザーデータを挿入します。
         `for` ループを使用して、`userService` の `insertUser` メソッドを呼び出し、10人分のユーザーデータを挿入します。

         **コード：**

            ```java
            for (int i = 1; i <= 10; i++) {
                userService.insertUser(new User(i, "insert" + i));
            }
            ```

      2. ユーザーデータを削除します。
         `userService` の `deleteUser` メソッドを呼び出し、idが1のユーザーデータを削除します。

         **コード：**

            ```java
            userService.deleteUser(1);
            ```

      3. ユーザーデータを更新します。
         `userService` の `updateUser` メソッドを呼び出し、idが2のユーザーデータを更新します。

         **コード：**

            ```java
            userService.updateUser(new User(2, "update"));
            ```

      4. ユーザーデータのクエリを実行します。
         * `userService` の `selectUserById` メソッドを呼び出して、idに基づいてユーザーデータのクエリを実行し、結果を `user` 変数に代入します。`user` オブジェクトを出力します。
         * `userService` の `selectUserByName` メソッドを呼び出して、ユーザー名に基づいてユーザーデータのクエリを実行し、結果を `userByName` 変数に代入します。`userByName` オブジェクトを出力します。

         **コード：**

            ```java
            User user = userService.selectUserById(2);
            System.out.println("user = " + user);
            User userByName = userService.selectUserByName("insert");
            System.out.println("userByName = " + userByName);
            ```

      5. ユーザーデータのページネーションクエリを実行します。
         `userService` の `selectUserAll` メソッドを呼び出して、すべてのユーザーデータのページネーションクエリを実行し、結果を `userIterator` 変数に代入します。`forEachRemaining` メソッドを使用して `userIterator` をイテレーションし、各ユーザーオブジェクトを出力します。

         **コード：**

            ```java
            Iterator<User> userIterator = userService.selectUserAll(0, 5);
            userIterator.forEachRemaining(System.out::println);
            ```

### 全コード表示

:::tab
tab pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.7.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.oceanbase</groupId>
    <artifactId>java-oceanbase-springdatajpa</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>java-oceanbase-springdatajpa</name>
    <description>Demo project for Spring Boot</description>
    <properties>
        <java.version>1.8</java.version>
    </properties>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
            <version>1.2.8</version>
        </dependency>

        <dependency>
            <groupId>com.oceanbase</groupId>
            <artifactId>oceanbase-client</artifactId>
            <version>2.4.2</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```

tab application.yml

```yml
server:
  servlet:
    context-path: /testspringdatajpa
  port: 8890

spring:
  datasource:
    driver-class-name: com.oceanbase.jdbc.Driver
    url: jdbc:oceanbase://host:port/schema_name?characterEncoding=utf-8&useSSL=false&serverTimezone=GMT%2B8
    username: user_name
    password: ******
    type: com.alibaba.druid.pool.DruidDataSource
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    format-sql: true
    open-in-view: false
```

tab userRepository.java

```java
package com.oceanbase.testspringdatajpa.dao;

import com.oceanbase.testspringdatajpa.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;


@Repository("userRepository")
public interface UserRepository extends JpaRepository<User, Integer> {
    //Custom repository handwritten SQL, placeholder value transfer form
    @Query(value = "update test_springdatajpa_2 set username=?1 where id=?2", nativeQuery = true)
    @Modifying
    int updateById(String name, String id);

    //SPEL expression, hql syntax
    @Query("SELECT u FROM User u WHERE u.username = :username")
    User findUser(@Param("username") String username);//Mapping parameter username to database field username
}
```

tab User.java

```java
package com.oceanbase.testspringdatajpa.entity;

import javax.persistence.*;

@Entity
@Table(name = "test_springdatajpa_2")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.TABLE)

    @Column(name = "id", nullable = false)
    private Integer id;

    @Column(name = "username")
    private String username;

    public User() {
    }

    public User(Integer id, String username) {
        this.id = id;
        this.username = username;
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", username='" + username + '\'' +
                '}';
    }
}
```

tab UserServiceImpl.java

```java
package com.oceanbase.testspringdatajpa.service.impl;

import com.oceanbase.testspringdatajpa.dao.UserRepository;
import com.oceanbase.testspringdatajpa.entity.User;
import com.oceanbase.testspringdatajpa.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Iterator;
import java.util.Optional;


@Transactional
@Service("userService")
public class UserServiceImpl implements UserService {
    private final UserRepository userRepository;

    @Autowired
    public UserServiceImpl(UserRepository userRepository) {
        this.userRepository = userRepository;
    }


    //insert
    @Override
    public void insertUser(User user) { userRepository.save(user); }

    //delete
    @Override
    public void deleteUser(Integer id) {
        if (!userRepository.existsById(id)) {
            return;
        }
    }

    //update
    @Override
    public int updateUser(User user) {
        userRepository.save(user);
        return 1;
    }

    //update based on name and id
    @Override
    public int updateUserById(String name, String id) {
        return userRepository.updateById(name, id);
    }

    // select one user
    @Override
    public User selectUserById(Integer id) {
        Optional<User> optional = userRepository.findById(id);
        User user = optional.orElse(null);
        return user;
    }

    //query user based on username
    @Override
    public User selectUserByName(String username) {
        return userRepository.findUser(username);
    }


    @Override
    public Iterator<User> selectUserAll(Integer pageNum, Integer pageSize) {
        //By passing parameters to this method, physical pagination can be achieved, which is very simple.
        Sort sort = Sort.by(Sort.Direction.ASC, "id");
        Pageable pageable = PageRequest.of(pageNum, pageSize, sort);
        Page<User> users = userRepository.findAll(pageable);
        Iterator<User> userIterator = users.iterator();
        return userIterator;
    }
}
```

tab UserService.java

```java
package com.oceanbase.testspringdatajpa.service;

import com.oceanbase.testspringdatajpa.entity.User;

import java.util.Iterator;



public interface UserService {
    //insert
    void insertUser(User user);

    //delete
    void deleteUser(Integer id);

    //update
    int updateUser(User user);

    //customize SQL and modify name based on id
    int updateUserById(String name, String id);

    //select one user
    User selectUserById(Integer id);

    //customize SQL to query users based on username
    User selectUserByName(String username);

    //query all users
    Iterator<User> selectUserAll(Integer pageNum, Integer pageSize);
}
```

tab TestSpringDataJpaApplication.java

```java
package com.oceanbase.testspringdatajpa;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;



@SpringBootApplication
public class TestSpringDataJpaApplication {

    public static void main(String[] args) {
        SpringApplication.run(TestSpringDataJpaApplication.class, args);
    }

}
```

tab TestSpringDataJpaApplicationTests.java

```java
package com.oceanbase.testspringdatajpa;

import com.oceanbase.testspringdatajpa.entity.User;
import com.oceanbase.testspringdatajpa.service.UserService;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.Iterator;


@SpringBootTest
class TestSpringDataJpaApplicationTests {
    @Autowired
    private UserService userService;

    @Test
    void contextLoads() {
        //insert
        for (int i = 1; i <= 10; i++) {
            userService.insertUser(new User(i, "insert" + i));
        }
        //delete
        userService.deleteUser(1);
        //update
        userService.updateUser(new User(2, "update"));
        //selectUserById
        User user = userService.selectUserById(2);
        System.out.println("user = " + user);
        //selectUserByName
        User userByName = userService.selectUserByName("insert");
        System.out.println("userByName = " + userByName);
        //query all users
        Iterator<User> userIterator = userService.selectUserAll(0, 5);
        userIterator.forEachRemaining(System.out::println);
    }
}
```

:::

## 関連ドキュメント

その他のOceanBase Connector/Jに関する情報は、[OceanBase JDBCドライバー](https://en.oceanbase.com/docs/common-oceanbase-connector-j-en)を参照してください。
