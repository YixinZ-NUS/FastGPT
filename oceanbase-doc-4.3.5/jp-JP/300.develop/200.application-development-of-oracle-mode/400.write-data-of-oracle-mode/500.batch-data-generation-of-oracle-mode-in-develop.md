|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|Oracle Mode|

# テストデータの一括生成

本記事では、Shellスクリプト、ストアドプロシージャ、ODCを使用して、テストデータを一括生成する方法を紹介します。

## 前提条件

* OceanBaseクラスタをデプロイし、Oracleモードのテナントを作成していること。OceanBaseクラスタのデプロイに関する詳細については、[デプロイの概要](../../../400.deploy/100.deploy-overview.md)を参照してください。
* 既に `CREATE TABLE`、`INSERT`、`SELECT` の権限を保有していること。現在のユーザー権限を確認するための操作情報については、[ユーザー権限の確認](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974764)を参照してください。この権限を保有していない場合は、管理者に連絡して権限の付与を依頼してください。ユーザー権限の付与に関する操作情報については、[直接権限付与](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974768)を参照してください。

## Shellスクリプトによるテストデータの一括生成

Shellスクリプトを作成してSQLスクリプトを一括生成することで、大量のテストデータを挿入する作業を効率化でき、煩雑なSQLステートメントを手動で作成する手間を省くことができます。この方法により、必要に応じて大量のテストデータを生成することができ、作業効率を向上させるとともに、手動操作による作業量を削減できます。

### 操作手順

1. テストテーブルを作成します。
2. Shellスクリプトを作成します。
3. SQLスクリプトを実行します。
4. データを確認します。

#### ステップ１：テストテーブルを作成する

データベース管理ツール（コマンドラインやグラフィカルツールなど）を使用して、テストデータを格納するためのデータベースを作成し、そのデータベース内に対応するテストテーブル構造を作成します。

1. 準備済みのOracleモードのテナントに接続します。

    **例：**

    ```shell
    obclient -hxxx.xxx.xxx.xxx -P2881 -usys@oracle001 -p****** -A
    ```

2. テストテーブルを作成します。

    **例：**

    以下のSQLステートメントを実行し、テストテーブル `test_sql_file_tbl1` を作成します。

    ```sql
    obclient [SYS]> CREATE TABLE test_sql_file_tbl1 (id NUMBER, name VARCHAR2(20), email VARCHAR2(50));
    ```

    テーブルの作成に関するその他の詳細情報については、[テーブルの作成](../300.database-object-planning-of-oracle-mode/200.create-table-of-oracle-mode-in-develop.md)を参照してください。

#### ステップ2：Shellスクリプトを作成する

テキストエディタを使用して、Shellスクリプトファイルを作成します。ファイルの拡張子には `.sh` を使用できます。Shellスクリプト内で出力リダイレクト記号（`>` または `>>`）を使用して、生成されたテストデータをSQLスクリプトファイルに書き込みます。ループやイテレーションの過程で生成されたデータをSQL（`INSERT`）ステートメントの形でSQLスクリプトファイルに書き込みます。

1. ターミナルを開きます。
2. Shellスクリプトファイルを作成します。

    `vi` または `vim` エディタを使用して、新しいShellスクリプトファイルを作成します。

    **例：**

    以下のコマンドを実行して、Shellスクリプト `generate_sql.sh` を作成します。

    ```shell
    vi generate_sql.sh
    ```

3. 編集モードに入ります。

    <kbd>i</kbd> キーまたは <kbd>Insert</kbd> キーを押して `vi` または `vim` エディタの挿入モードに入ると、挿入モードでファイルの内容を編集できます。

4. Shellスクリプトのロジックを作成します。

    編集モードで、Shellスクリプトのロジックとコマンドを作成します。これらのコマンドは、Shellコマンド、条件ステートメント、ループ構造、関数などにすることができます。

    **例：**

    `generate_sql.sh` スクリプトの内容は以下のとおりです：

    ```shell
    #!/bin/bash

    # SQLファイル名の定義
    SQL_FILE="insert_test_sql_file_tbl1.sql"

    # SQLファイルの作成
    touch $SQL_FILE

    # SQLステートメントの定義
    INSERT_SQL="INSERT INTO test_sql_file_tbl1 (id, name, email) VALUES "

    # 100,000件のユーザーレコードをループで生成する
    for ((i=1; i<=100000; i++))
    do
        user_id=$i
        user_name="user_$i"
        user_email="user_$i@example.com"
        values="($user_id, '$user_name', '$user_email')"
        if (($i == 100000))
        then
            INSERT_SQL="$INSERT_SQL$values;"
        else
            INSERT_SQL="$INSERT_SQL$values, "
        fi
    done

    # SQLステートメントをSQLファイルに書き込む
    echo $INSERT_SQL >> $SQL_FILE
    ```

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p><ul><li>このスクリプトは、<code>insert_test_sql_file_tbl1.sql</code> という名前のSQLファイルを生成し、100,000件のユーザーレコードを挿入します。必要に応じて、SQLステートメントとループで生成されるユーザーレコードの数を変更することができます。</li><li>大量のデータを挿入する際は、関連するサーバーのリソース使用状況を事前に確認し、リソース不足によるデータ挿入の失敗やパフォーマンスの低下を防いでください。</li></ul></p>
    </main>

5. ファイルを保存します。

    <kbd>Esc</kbd> キーを押して挿入モードを終了し、`:wq` コマンドを入力してファイルを保存して `vi` または `vim` エディタを終了します。

6. Shellスクリプトファイルを実行します。

    作成したShellスクリプトをターミナルで実行すると、SQLスクリプトが生成されます。

    **例：**

    以下のコマンドを実行して、作成したShellスクリプトを実行します。このコマンドは、現在のディレクトリに、100,000件の `INSERT` ステートメントを含む `insert_test_sql_file_tbl1.sql` という名前のSQLスクリプトファイルを生成します。

    ```shell
    sudo bash generate_sql.sh
    ```

#### ステップ3：SQLスクリプトを実行する

以下のコマンドを使用して、SQLスクリプトファイルのデータをデータベースにインポートします。

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>SQLスクリプトの実行の詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001970949">SQLファイルからOceanBaseデータベースにデータのインポート</a>を参照してください。</p>
</main>

1. ターミナルまたはコマンドラインインターフェースを開き、OceanBaseデータベースのOracleモードテナントに接続します。

    **例：**

    ```shell
    obclient -hxxx.xxx.xxx.xxx -P2881 -usys@oracle001 -p****** -A
    ```

2. データベースのコマンドラインインターフェースでは、`source` コマンドを使用してSQLスクリプトを実行します。

    **例：**

    ```shell
    obclient [SYS]> source /home/admin/test_data/insert_test_sql_file_tbl1.sql
    ```

    <main id="notice" type='explain'>
    <h4>説明</h4>
    <p>SQLスクリプトファイルを実行する際には、フルパスでSQLスクリプトファイルのパスを指定してください。</p>
    </main>

    実行結果は次のとおりです：

    ```shell
    Query OK, 100000 rows affected
    Records: 100000  Duplicates: 0  Warnings: 0
    ```

#### ステップ4：データを確認する

以下のSQLステートメントを実行し、`test_sql_file_tbl1` のデータ行数を確認します。

```sql
obclient [SYS]> SELECT count(*) FROM test_sql_file_tbl1;
```

実行結果は次のとおりです：

```shell
+----------+
| COUNT(*) |
+----------+
|   100000 |
+----------+
1 row in set
```

## ストアドプロシージャを使用してテストデータを一括生成する

ストアドプロシージャを使用したテストデータの一括生成は、効果的なメソッドの1つです。ストアドプロシージャを作成することで、大量のテストデータを自動的に生成できます。

### 操作手順

1. テストテーブルを作成します。
2. ストアドプロシージャを作成します。
3. ストアドプロシージャを呼び出します。
4. データを確認します。

#### ステップ１：テストテーブルを作成する

データベース管理ツール（コマンドラインやグラフィカルツールなど）を使用して、テストデータを格納するためのデータベースを作成し、そのデータベース内に対応するテストテーブル構造を作成します。

1. 準備済みのOracleモードのテナントに接続します。

    **例：**

    ```shell
    obclient -hxxx.xxx.xxx.xxx -P2881 -usys@oracle001 -p****** -A
    ```

2. テストテーブルを作成します。

    **例：**

    以下のSQLステートメントを実行して、テーブル `test_pro_tbl1` を作成します。このテーブルには、3つのフィールドが含まれます：

    * `id` は整数型のフィールドです。
    * `name` は文字列型のフィールドで、最大長は50文字です。
    * `enrollment_date` は日付型のフィールドであり、日付データを格納するために使用されます。

    ```shell
    obclient [SYS]> CREATE TABLE test_pro_tbl1 (
      id NUMBER,
      name VARCHAR2(50),
      enrollment_date DATE);
    ```

#### ステップ2：ストアドプロシージャを作成する

1. カスタム区切り文字を指定します。

    **例：**

    `DELIMITER` コマンドを使用して、カスタム区切り文字 `//` を指定します。

    ```sql
    obclient [SYS]> DELIMITER //
    ```

2. ストアドプロシージャを作成します。

    **例：**

    以下のSQLステートメントを実行して、ストアドプロシージャ `pro_generate_data` を作成します。入力パラメータは `n` で、挿入するデータの件数を指定するために使用されます。ループステートメントと `INSERT` ステートメントを使って、データを生成して挿入します。この中で、`test_pro_tbl1` はデータ挿入先のテーブル名で、`id`、`name` と `enrollment_date` はデータ挿入先のフィールド名です。`i` はループカウンターを表し、`CONCAT` 関数は名前を生成するために使用され、`DATE_ADD` 関数は日付を生成するために使用されます。

    ```sql
    obclient [SYS]> CREATE OR REPLACE PROCEDURE pro_generate_data(n IN INT) IS
    i INT := 1;
    BEGIN
    WHILE i <= n LOOP
    INSERT INTO test_pro_tbl1 (id, name, enrollment_date) VALUES (i, 'Name' || i, TO_DATE('2022-01-01', 'YYYY-MM-DD') + i);
    i := i + 1;
    END LOOP;
    END;
    //
    ```

    ストアドプロシージャの作成の詳細については、[ストアドプロシージャ](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974376)を参照してください。

3. デフォルトのセミコロン（;）区切り文字に戻します。

    ```sql
    obclient [SYS]> DELIMITER ;
    ```

#### ステップ3：ストアドプロシージャを呼び出す

`CALL` ステートメントを使用してストアドプロシージャを呼び出し、テストデータを生成するロジックを実行します。ストアドプロシージャにパラメータを渡すことで、生成するデータの数を指定できます。

**例：**

以下のSQLステートメントを実行し、ストアドプロシージャ `pro_generate_data` を呼び出し、パラメータ値として100,000を渡します。これは、100,000件のデータ挿入が必要であることを示します。

```sql
obclient [SYS]> CALL pro_generate_data(100000);
```

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>入力パラメータのサイズを増減することで、テストデータの数を制御できます。パラメータのサイズ調整時には、データベースのパフォーマンスとストレージ容量の制限を考慮する必要があります。過剰なデータ生成により、データベースがクラッシュしたり、ストレージ容量が不足したりするのを防ぐためです。</p>
</main>

#### ステップ4：データを確認する

以下のSQLステートメントを実行して、`test_pro_tbl1` のデータ行数を確認します。

```shell
obclient [SYS]> SELECT count(*) FROM test_pro_tbl1;
```

実行結果は次のとおりです：

```shell
+----------+
| COUNT(*) |
+----------+
|   100000 |
+----------+
1 row in set
```

## ODCを使用してテストデータを一括生成する

OceanBase開発者センター（OceanBase Developer Center、ODC）は、OceanBaseデータベース用に特別に設計されたエンタープライズレベルのデータベース開発プラットフォームです。ODCの詳細については、[OceanBase開発者センターとは](https://en.oceanbase.com/docs/odc-en)を参照してください。

ODCは、データベースのパフォーマンステストや機能検証など、大量のモックデータが必要とされるシナリオで、テーブルのフィールドタイプに基づいてデータを迅速に生成するモックデータ機能を提供します。ODCモックデータに関するその他の詳細情報については、[モックデータ](https://en.oceanbase.com/docs/community-odc-en-10000000000842074)を参照してください。

## 関連ドキュメント

* データベースへの接続に関するその他の詳細情報については、[接続方法の概要](../100.connect-to-oceanbase-database-of-oracle-mode/100.connection-methods-overview-of-oracle-mode.md)を参照してください。
* テーブルの削除に関するその他の詳細情報については、[テーブルの削除](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001973619)を参照してください。
* データの削除に関するその他の詳細情報については、[データの削除](300.delete-data-of-oracle-mode-in-develop.md)を参照してください。
