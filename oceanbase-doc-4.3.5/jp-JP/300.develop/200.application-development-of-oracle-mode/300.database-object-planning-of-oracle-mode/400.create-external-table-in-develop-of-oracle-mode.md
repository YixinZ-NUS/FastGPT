|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|Oracle Mode|

# 外部テーブルの作成

本記事では、SQLステートメントを使用して外部テーブルを作成する方法について紹介します。また、外部テーブルを作成するための前提条件、外部テーブルの概要、注意事項などについても紹介し、いくつかの例も提供します。

## 外部テーブルの概要

外部テーブルは、論理的なテーブルオブジェクトを指し、その実際のデータストレージの位置はデータベース内部ではなく、外部ストレージサービスに保存されています。

外部テーブルの情報については、[外部テーブルについて](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974568)を参照してください。

## 前提条件

外部テーブルを作成する前に、以下の事項を確認する必要があります：

* OceanBaseクラスタをデプロイし、Oracleモードのテナントを作成していること。OceanBaseクラスタのデプロイに関する詳細については、[デプロイの概要](../../../400.deploy/100.deploy-overview.md)を参照してください。

* OceanBaseデータベースのOracleテナントに接続していること。データベースへの接続に関する詳細については、[接続方法の概要](../100.connect-to-oceanbase-database-of-oracle-mode/100.connection-methods-overview-of-oracle-mode.md)を参照してください。

* 外部テーブルを作成するには、現在のユーザーが `CREATE TABLE` 権限を持っている必要があります。現在のユーザー権限を確認するための操作情報については、[ユーザー権限の確認](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974764)を参照してください。この権限を保有していない場合は、管理者に連絡して権限の付与を依頼してください。ユーザー権限の付与に関する操作情報については、[直接権限付与](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974768)を参照してください。

## 注意事項

* 外部テーブルはクエリ操作のみを実行でき、DML操作を実行することはできません。

* 外部テーブルをクエリする際に、外部テーブルがアクセスしている外部ファイルが削除されている場合、システムはエラーを報告せず、空の行を返します。

* 外部テーブルがアクセスするファイルは外部ストレージシステムによって管理されているため、外部ストレージが利用できない場合、外部テーブルのクエリ実行時にエラーが発生します。

* 外部テーブルのデータは外部データソースに保存されているため、クエリを実行する際にはネットワーク超えやファイルシステムなどの要素が関与し、クエリのパフォーマンスに影響を与える可能性があります。そのため、外部テーブルを作成する際には、適切なデータソースと最適化戦略を選択し、クエリの効率を向上させる必要があります。

## コマンドラインで外部テーブルを作成する

[CREATE EXTERNAL TABLE](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975075) ステートメントを使用して外部テーブルを作成してください。

### 外部テーブル名の定義

外部テーブルを作成する際には、まず外部テーブルに名前を付ける必要があります。混乱や誤解を避けるために、外部テーブルに名前を付ける際には、通常のテーブルと外部テーブルを区別するための特定の命名ルールやプレフィックスを使用することを推奨します。例えば、外部テーブルの名前の末尾に `_csv` というサフィックスを付けることができます。

例：

学生情報に関する外部テーブルを作成する際には、`students_csv` という名前を付けることができます。

```sql
CREATE EXTERNAL TABLE students_csv external_options
```

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>外部テーブルの他のプロパティが追加されていないため、上記のSQLステートメントは実行できません。</p>
</main>

### 列の定義

外部テーブルの列には、`DEFAULT`、`NOT NULL`、`UNIQUE`、`CHECK`、`PRIMARY KEY`、`FOREIGN KEY` などの制約を定義することはできません。

外部テーブルでサポートされる列タイプは通常のテーブルと同じです。OceanBaseデータベースのOracleモードでサポートされているデータ型および詳細な説明については、[組み込みデータ型の概要](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001975141)を参照してください。

### LOCATIONを定義する

`LOCATION` オプションは、外部テーブルファイルの保存先パスを指定するために使用されます。通常、外部テーブルのデータファイルは単独のディレクトリに保存され、そのフォルダ内にはサブディレクトリを含むことができます。テーブルを作成する際、外部テーブルはそのディレクトリ内のすべてのファイルを自動的に収集します。

OceanBaseデータベースは、以下の2種類のパス形式をサポートしています：

* ローカルLocation形式：`LOCATION = '[file://] local_file_path'`

  <main id="notice" type='notice'>
  <h4>注意</h4>
  <p>ローカルLocation形式を使用するシナリオでは、システム変数 <code>secure_file_priv</code> を設定してアクセス可能なパスを設定する必要があります。詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001972189">secure_file_priv</a>を参照してください。</p>
  </main>

* リモートLocationの形式は以下のとおりです：

  <main id="notice" type='notice'>
    <h4>注意</h4>
    <p>オブジェクトストレージパスを使用する際、オブジェクトストレージパスの各パラメータは <code>&</code> 記号で区切られます。入力するパラメータ値には英字の大文字と小文字、数字、<code>/-_$+=</code> およびワイルドカードのみ含まれていることを確認してください。上記以外の他の文字を入力した場合、設定が失敗する可能性があります。</p>
  </main>

  * `LOCATION = '{oss|S3}://$ACCESS_ID:$ACCESS_KEY@$HOST:s3_region/remote_file_path'` の中で、`$ACCESS_ID`、`$ACCESS_KEY`、および `$HOST` は、Alibaba Cloud OSS、AWS S3、およびS3プロトコルに互換性のあるオブジェクトストレージにアクセスするために必要な設定のアクセス情報です。`s3_region` はS3を使用する際に選択したリージョン情報であり、これらの機密性の高いアクセス情報は暗号化された形式でデータベースのシステムテーブルに保存されます。

  * ファイルがHDFS上にある場合、以下の形式を使用します：

    * 単一のNameNode（NN）のアドレスを使用してクラスタにアクセスする場合の形式は：`LOCATION = hdfs://localhost:port/PATH` です。ここで、`localhost` はHDFSのアドレスを指し、`port` はHDFSのポート番号を指し、`PATH` はHDFS内のファイルパスを指します。

      * Kerberos認証を使用する場合の形式は：`LOCATION = 'hdfs://localhost:port/user?principal=xxx&keytab=xxx&krb5conf=xxx&configs=xxx'` です。その中で：

        * `principal`：認証されたログインユーザーを指します。
        * `keytab`：ユーザー認証の秘密鍵ファイルを指定します。
        * `krb5conf`：ユーザーがKerberos環境で使用する記述ファイルを指定します。
        * `configs`：追加のHDFS構成パラメータを指定します。デフォルトは空ですが、Kerberos環境の場合、通常このパラメータには値があり、設定が必要です。例：`dfs.data.transfer.protection=authentication,privacy` は、データ転送の保護レベルを `authentication` と `privacy` に指定します。

    * Hadoop HA（高可用性）の論理ネームサービスを使用してクラスタにアクセスする場合の形式は：`LOCATION = hdfs://nameserviceID/PATH` です。ここで、`nameserviceID` はHadoop HAの論理ネームサービスIDを指し、`PATH` はファイルパスを指します。

      <main id="notice" type='explain'>
        <h4>説明</h4>
        <p>クライアント側のOBServerの設定にHAクラスタの <code>nameservice</code> 定義とフェールオーバー戦略が含まれていることを確認してください。</p>
      </main>

      * Kerberos認証を使用する場合の形式は：`LOCATION = 'hdfs://nameserviceID/PATH?principal=xxx&keytab=xxx&krb5conf=xxx&configs=dfs.data.transfer.protection=${string}#dfs.nameservices=${nameservice id}#dfs.ha.namenodes.${nameservice id}=${namenode1}, ${namenode2}#dfs.namenode.rpc-address.${nameservice id}.${namenode1}=${namenode 1 address}#dfs.namenode.rpc-address.${nameservice id}.${namenode2}=${namenode 2 address}#dfs.ha.automatic-failover.enabled.${nameservice id}=true#dfs.client.failover.proxy.provider.${nameservice id}=org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider'` です。その中で：

        * `principal`：ログイン認証ユーザーを指し、非主ノードのNameNode (NN)の`principal`を設定します。
        * `keytab` と `krb5conf`：単一NameNodeの場合と同様に設定します。
        * `configs`：追加のHDFS構成パラメータを指定します。複数の構成パラメータを設定する必要があり、HA構成パラメータとセキュリティ構成パラメータに関連します：

          * `dfs.data.transfer.protection=${string}`：クラスタの `dfs.data.transfer.protection` の設定と一致します。
          * `dfs.nameservices=${nameservice id}`：現在のHAクラスタの `namesevice`（エイリアス）を指定します。
          * `dfs.ha.namenodes.${nameservice id}=${namenode1}, ${namenode2}`：HAクラスタのnamenodeのバックアップIDリストを指定します。
          * `dfs.namenode.rpc-address.${nameservice id}.${namenode1}=${namenode 1 address}`：`namenode1` の具体的なnamenodeアドレスを設定し、クライアントのルーティングを容易にします。
          * `dfs.namenode.rpc-address.${nameservice id}.${namenode2}=${namenode 2 address}`：`namenode2` の具体的なnamenodeアドレスを設定し、クライアントのルーティングを容易にします。
          * `dfs.ha.automatic-failover.enabled.${nameservice id}=true`：HAクラスタが関連リクエストを受け取った際、自動的に利用可能なNameNodeにフェイルオーバーできるようにします。
          * `dfs.client.failover.proxy.provider.${nameservice id}=org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider`：HAクラスタでプライマリ／スタンバイの切り替えを行うロジックツールクラスを指定します。必要に応じてカスタムクラスを作成し、HAクラスタにアップロードすることも可能です。

      <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>HA関連の構成パラメータは <code>namespace</code> とバインディングされています。例えば、以下の例3の <code>mycluster</code> に注意してください。関連する構成パラメータを組み合わせて設定してください。</p>
      </main>

### FORMATを定義する

* `FORMAT = ( TYPE = 'CSV'... )` は、外部ファイルのフォーマットをCSVタイプとして指定するために使用されます。以下のパラメータがあります：
  * `TYPE`：外部ファイルのタイプを指定します。
  * `LINE_DELIMITER`：CSVファイルの行区切り文字を指定します。デフォルト値は `LINE_DELIMITER='\n'` です
  * `FIELD_DELIMITER`：CSVファイルの列区切り文字を指定します。デフォルト値は `FIELD_DELIMITER='\t'` です。
  * `ESCAPE`：CSVファイルのエスケープ文字を指定します。1バイトの文字のみ使用できます。デフォルト値は `ESCAPE ='\'` です。
  * `FIELD_OPTIONALLY_ENCLOSED_BY`：CSVファイル内のフィールド値を囲むための文字を指定します。デフォルト値は空です。

    <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>外部テーブルデータファイルに <code>NULL</code> 値（非文字列 <b>NULL</b>、すなわち <b>"NULL"</b> ではない）が含まれている場合、<code>FIELD_OPTIONALLY_ENCLOSED_BY</code> パラメータを明示的に設定する必要があり、そのパラメータの値は空にすることはできません。</p>
    </main>

  * `ENCODING`：ファイルの文字セットエンコーディング形式を指定します。現在のOracleモードがサポートしているすべての文字セットについては、[文字セットと照合順序](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974269)を参照してください。指定しない場合、デフォルト値はUTF8MB4です。
  * `NULL_IF`：`NULL` として扱う文字列を指定します。デフォルト値は空です。
  * `SKIP_HEADER`：ファイルのヘッダーをスキップし、スキップする行数を指定します。
  * `SKIP_BLANK_LINES`：空白行をスキップするかどうか指定します。デフォルト値は `FALSE` で、空白行をスキップしないことを示します。
  * `TRIM_SPACE`：ファイル内のフィールドの先頭および末尾の空白を削除するかどうか指定します。デフォルト値は `FALSE` で、ファイル内のフィールドの前後の空白を削除しないことを示します。
  * `EMPTY_FIELD_AS_NULL`：空文字列を `NULL` として扱うかどうかを指定します。デフォルト値は `FALSE` で、空文字列を `NULL` として扱わないことを示します。
* `FORMAT = ( TYPE = 'PARQUET'... )` は、外部ファイルのフォーマットをPARQUETタイプとして指定するために使用されます。
* `FORMAT = ( TYPE = 'ORC'... )` は、外部ファイルのフォーマットをORCタイプとして指定するために使用されます。

### （オプション）PATTERNを定義する

`PATTERN` オプションは、`LOCATION` ディレクトリ内のファイルをフィルタリングするための正規表現パターン文字列を指定するために使用されます。各 `LOCATION` ディレクトリ内のファイルパスについて、そのパターン文字列にマッチする場合、外部テーブルはこのファイルにアクセスします。マッチしない場合、外部テーブルはこのファイルをスキップします。このパラメータを指定しない場合、デフォルトで `LOCATION` ディレクトリ内のすべてのファイルにアクセスできます。外部テーブルは、`LOCATION` で指定されたパスにある `PATTERN` に一致するファイルのリストをデータベースシステムのテーブルに保存します。外部テーブルをスキャンする際は、このリストに基づいて外部ファイルにアクセスします。

### （オプション）外部テーブルのパーティションを定義する

#### 外部テーブルのパーティションを自動的に定義する

外部テーブルは、パーティションキーで定義された式に基づいて、パーティションを計算して追加します。クエリを実行する際に、パーティションキーの値または範囲を指定できます。この時、パーティションプルーニングが行われ、外部テーブルはそのパーティション内のファイルのみを読み取ります。

#### 外部テーブルのパーティションを手動で定義する

手動でパーティションを追加および削除する必要がある場合、外部テーブルにパーティションの自動管理を任せるのではなく、`PARTITION_TYPE = USER_SPECIFIED` フィールドを指定する必要があります。

## 例1

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>例に含まれるIPアドレスに関するコマンドはマスキング処理されていますので、検証時には自分のマシンの実際のIPアドレスを記入してください。</p>
</main>

以下は、外部ファイルがローカルおよびOceanBaseデータベースのOracleモードに存在する場合の外部テーブルを作成する例です。手順は次のとおりです：

1. 外部ファイルを準備する。

    以下のコマンドを実行して、OBServerノードにログインするマシンの `/home/admin/external_csv` ディレクトリ内に `test_tbl1.csv` ファイルを作成します。

    ```shell
    [admin@xxx /home/admin/external_csv]# vi test_tbl1.csv
    ```

    ファイルの内容は以下のとおりです：

    ```shell
    1,'Emma'
    2,'William'
    3,'Olivia'
    ```

2. インポートファイルのパスを設定します。

    <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>セキュリティ上の理由により、システム変数 <code>secure_file_priv</code> を設定する際は、ローカルSocket接続を通じてデータベースに接続し、このグローバル変数を変更するSQLステートメントを実行する必要があります。詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001972189">secure_file_priv</a>を参照してください。</p>
    </main>

    1. 以下のコマンドを実行して、OBServerノードが存在するマシンにログインします。

        ```shell
        ssh admin@10.10.10.1
        ```

    2. 以下のコマンドを実行して、ローカルUnixソケット接続を介してテナント `oracle001` に接続します。

        ```shell
        obclient -S /home/admin/oceanbase/run/sql.sock -usys@oracle001 -p******
        ```

    3. 以下のSQLコマンドを実行し、インポートパスを `/home/admin/external_csv` に設定します。

        ```sql
        SET GLOBAL secure_file_priv = "/home/admin/external_csv";
        ```

3. テナント `oracle001` に再接続します。

    例：

    ```shell
    obclient -h10.10.10.1 -P2881 -usys@oracle001 -p****** -A
    ```

4. 以下のSQLコマンドを実行して、外部テーブル `test_tbl1_csv` を作成します。

    ```sql
    CREATE EXTERNAL TABLE test_tbl1_csv (
        id INT,
        name VARCHAR(50)
        )
        LOCATION = '/home/admin/external_csv'
        FORMAT = (
          TYPE = 'CSV'
          FIELD_DELIMITER = ','
          FIELD_OPTIONALLY_ENCLOSED_BY =''''
          )
        PATTERN = 'test_tbl1.csv';
    ```

5. 以下のSQLコマンドを実行して、外部テーブル `test_tbl1_csv` のデータを確認します。

    ```sql
    SELECT * FROM test_tbl1_csv;
    ```

    実行結果は次のとおりです：

    ```shell
    +------+---------+
    | ID   | NAME    |
    +------+---------+
    |    1 | Emma    |
    |    2 | William |
    |    3 | Olivia  |
    +------+---------+
    3 rows in set
    ```

## 例2

HDFSの外部テーブルを作成するには、OceanBaseデータベースをJava SDKがインストールされた環境で使用する必要があります。Java SDK環境のデプロイに関する詳細については、[OceanBaseデータベースJava SDK環境のデプロイ](../../../400.deploy/300.deploy-oceanbase-enterprise-edition/500.deploy-the-ob-java-sdk-environment.md)をご参照ください。

HDFS外部テーブルの作成例

**Kerberosを使用する：**

```shell
CREATE EXTERNAL TABLE ext_data(ID NUMBER(32), NAME VARCHAR2(30),SCORE NUMBER(32))
FORMAT = (
TYPE = 'CSV'
FIELD_DELIMITER = ','
FIELD_OPTIONALLY_ENCLOSED_BY ='"'
)
LOCATION = 'hdfs://localhost:8020/user?principal=principal_str&keytab=/path/to/keytab&krb5conf=/path/to/krb5conf_file&configs=xxx=xxx#xxx=xxx'
PATTERN = 'data.csv';
```

その中で：

* `principal`：ログイン認証ユーザーを指定します。
* `keytab`:ユーザー認証の秘密鍵ファイルを指定します。
* `krb5conf`:ユーザーがKerberos環境で使用する記述ファイルを指定します。
* `configs`: 追加のHDFS構成パラメータを指定します。デフォルトは空ですが、Kerberos環境の場合、通常このパラメータには値があり、設定が必要です。例：`dfs.data.transfer.protection=authentication,privacy` は、データ転送の保護レベルを `authentication` と `privacy` に指定します。

**Kerberosを使用しない：**

```shell
CREATE EXTERNAL TABLE ext_data(ID NUMBER(32), NAME VARCHAR2(30),SCORE NUMBER(32))
FORMAT = (
  TYPE = 'CSV'
  FIELD_DELIMITER = ','
  FIELD_OPTIONALLY_ENCLOSED_BY ='"'
)
LOCATION = 'hdfs://localhost:8020/user'
PATTERN = 'test_tbl1.csv';
```

## 関連ドキュメント

外部テーブルのアクセス可能なファイルの確認と更新に関する情報については、[外部ファイルの管理](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974570)を参照してください。
