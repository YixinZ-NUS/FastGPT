|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|Oracle Mode|

# クエリ結果のロック SELECT FOR UPDATE

OceanBaseデータベースはマルチバージョン同時実行制御（MVCC）をサポートしています。デフォルトでは、読み取りトランザクションは書き込みトランザクションの実行をブロックしませんが、`SELECT ... FOR UPDATE` の方法を使用して読み取りトランザクションの対象にロックをかけることで、書き込みトランザクションをブロックすることができます。

本記事では具体的な例を通じて、`SELECT FOR UPDATE` を使用してクエリ結果をロックする方法を紹介します。

## 例

`SELECT FOR UPDATE` を使用してクエリ結果をロックします。

1. サンプルテーブルを作成し、適切なデータを挿入します。

   1. 以下のSQLステートメントを実行して、`test_tbl1` テーブルを作成します。

      ```sql
      CREATE TABLE test_tbl1(id number,
         name VARCHAR(18),
         c_date date,
         PRIMARY KEY (id)
         );
      ```

   2. 以下のSQLステートメントを実行して、`test_tbl1` テーブルにデータを挿入します。

      ```sql
      INSERT INTO test_tbl1 VALUES(1,'A1',date'2019-09-09'),
         (2,'B1',date'2019-06-06'),
         (3,'C1',date'2019-05-05'),
         (4,'D1',date'2020-02-02'),
         (5,'F1',date'2021-01-01');
      ```

   3. 以下のSQLステートメントを実行して、トランザクションをコミットします。

      ```sql
      COMMIT;
      ```

2. **セッション1** では、`FOR UPDATE` 構文を使用して、テーブル `test_tbl1` 中の `id` 値が `1` となるレコードに対してクエリを実行し、行ロックを追加します。全ての並列する更新がブロックされ、待機します。

   ```sql
   SELECT name,c_date FROM test_tbl1 WHERE id = 1 FOR UPDATE;
   ```

   実行結果は次のとおりです：

   ```shell
   +------+-----------+
   | NAME | C_DATE    |
   +------+-----------+
   | A1   | 09-SEP-19 |
   +------+-----------+
   1 row in set
   ```

3. **セッション2** で、次のSQLステートメントを実行して、テーブル `test_tbl1` の `id` 値が `1` に等しい行の対応する `name` のを `A1A1` に変更します。このSQLステートメントは、**セッション1** のトランザクションが `ROLLBACK` または `COMMIT` されるまで待機し、その後に実行されます。

   ```sql
   UPDATE test_tbl1 SET name = 'A1A1'  WHERE id = 1;
   ```

   実行結果は次のとおりです：

   ```shell
   OBE-30006: resource busy; acquire with WAIT timeout expired
   ```

4. **セッション1** で、以下のSQLステートメントを実行してトランザクションをコミットします。

   ```sql
   COMMIT;
   ```

5. **セッション2** で、再び **ステップ3** の更新ステートメントを実行します。

   ```sql
   UPDATE test_tbl1 SET name = 'A1A1'  WHERE id = 1;
   ```

   実行結果は次のとおりです：

   ```shell
   Query OK, 1 row affected
   Rows matched: 1  Changed: 1  Warnings: 0
   ```

6. **セッション2** で、以下のSQLステートメントを実行してトランザクションをコミットします。

   ```sql
   COMMIT;
   ```

7. **セッション1** で更新されたデータをクエリします。

   ```sql
   SELECT name,c_date FROM test_tbl1 WHERE id = 1;
   ```

   実行結果は次のとおりです：

   ```shell
   +------+-----------+
   | NAME | C_DATE    |
   +------+-----------+
   | A1A1 | 09-SEP-19 |
   +------+-----------+
   1 row in set
   ```

## 関連ドキュメント

[ロックメカニズム](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974672)
