|description||
|---|---|
|keywords||
|dir-name|C3P0|
|dir-name-en||
|tenant-type|MySQL Mode|

# C3P0

本記事では、C3P0接続プール、MySQL Connector/J、およびOceanBaseデータベースを用いてアプリケーションを構築し、テーブル作成・データの挿入・更新・削除・クエリなどの基本的なデータベース操作を実装する方法を紹介します。

<div role="videolist">
      <a role='link' href='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/c3p0-mysql-jdbc/c3p0-mysql-jdbc.zip'>
          <img src='https://file.oceanbase.com/doc/img/lQLPJyFovGIOcJQWFrAqhLlgRRsPvwU-H7hJ_i0A_22_22.png'/>
          c3p0-mysql-jdbcサンプルプロジェクトをダウンロード
      </a>
      <!-- <a role='video' href='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/video-center/video/video/01%20c3p0-mysql-jdbc.mp4'>
          <img src='https://mdn.alipayobjects.com/huamei_22khvb/afts/img/A*DFPmToHK6hgAAAAAAAAAAAAADiGDAQ/original'/>
          C3P0 连接池连接 OceanBase 数据库示例程序（MySQL 模式）
      </a> -->
</div>

## 前提条件

* OceanBaseデータベースがインストール済みで、MySQLモードのテナントが作成されていること。
* JDK 1.8とMavenがインストール済みであること。
* Eclipseがインストール済みであること。

    <main id="notice" type='explain'>
    <h4>説明</h4>
    <p>この記事でコードの実行にはEclipse IDE for Java Developers 2022-03バージョンを使用しています。ご自身の好みに合わせて、適切なツールを選択してサンプルコードを実行することも可能です。</p>
    </main>

## 操作手順

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>本記事の操作手順はWindows環境に基づいています。他のOS環境やコンパイラを使用する場合は、操作手順が若干異なる場合があります。</p>
</main>

1. `c3p0-mysql-jdbc`プロジェクトをEclipseにインポートします。
2. OceanBaseデータベースのURLを取得します。
3. `c3p0-mysql-jdbc`プロジェクトのデータベース接続情報を修正します。
4. `c3p0-mysql-jdbc`プロジェクトを実行します。

### ステップ1：c3p0-mysql-jdbcプロジェクトのEclipseへのインポート

1. Eclipseを開き、メニューバーから**File**->**Open Projects from File System**を選択します。

2. ポップアップダイアログで、**Directory**ボタンをクリックしてプロジェクトのディレクトリを選択し、**Finish**をクリックしてインポートを完了します。

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>Eclipseを使用してMavenプロジェクトをインポートすると、プロジェクト内の<code>pom.xml</code>ファイルを自動的に検出し、その記述に基づいて必要な依存ライブラリをダウンロードしてプロジェクトに追加します。</p>
    </main>

    ![Import](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/c3p0-mysql-jdbc/1Import.png)

3. プロジェクトの状況を確認します。

    ![p1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/c3p0-mysql-jdbc/2p1.png)

### ステップ2：OceanBaseデータベースのURLを取得する

1. OceanBaseデータベースのデプロイ担当者または管理者から、該当するデータベース接続文字列を取得します。

    **例：**

    ```shell
    obclient -hxxx.xxx.xxx.xxx -P2881 -utest_user001@mysql001 -p****** -Dtest
    ```

    接続文字列に関する詳細については、[OBClientを使用したOceanBaseテナントへの接続](../300.connect-to-an-oceanbase-tenant-by-using-obclient-of-mysql-mode.md)を参照してください。

2. OceanBaseデータベース接続文字列の情報に基づいて、以下のURLの対応する情報を入力します。

    ```shell
    jdbc:mysql://$host:$port/$database_name?user=$user_name&password=$password
    ```

    **パラメータの説明：**

    * `$host`：OceanBaseデータベースへの接続IPアドレス。OceanBaseデータベースプロキシ(OceanBase Database Proxy、ODP)接続方式ではODPアドレスを使用し、直接接続方式ではOBServerノードのIPアドレスを使用します。
    * `$port`：OceanBaseデータベースへの接続ポート。ODP接続方式のデフォルトポートは`2883`で、ODPデプロイ時にカスタマイズ可能です。直接接続方式のデフォルトポートは`2881`で、OceanBaseデータベースのデプロイ時にカスタマイズ可能です。
    * `$database_name`：アクセス対象のデータベース名。

        <main id="notice" type='notice'>
          <h4>注意</h4>
          <p>テナントに接続するユーザーは、データベースに対する<code>CREATE</code>、<code>INSERT</code>、<code>DELETE</code>、<code>UPDATE</code>、および<code>SELECT</code>権限が付与されていなければなりません。その他のユーザー権限の詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974758">MySQLモードの権限分類</a>を参照してください。</p>
        </main>

    * `user_name`：テナントの接続アカウント。ODP接続方式の一般的な形式は2種類あります：`ユーザー名@テナント名#クラスタ名`または`クラスタ名:テナント名:ユーザー名`。直接接続方式の形式：`ユーザー名@テナント名`。
    * `password`：アカウントのパスワード。

    MySQL Connector/Jの接続プロパティの詳細については、[Configuration Properties](https://dev.mysql.com/doc/connector-j/en/connector-j-reference-configuration-properties.html)を参照してください。

    **例：**

    ```shell
    jdbc:mysql://xxx.xxx.xxx.xxx:2881/test?user=test_user001@mysql001&password=******
    ```

### ステップ3：c3p0-mysql-jdbcプロジェクトのデータベース接続情報の修正

**ステップ2：OceanBaseデータベースURLの取得**で取得した情報を使用して、ファイル`c3p0-mysql-jdbc/src/main/resources/c3p0-config.xml`のデータベース接続情報を修正します。

**例：**

* OBServerノードのIPアドレスは`xxx.xxx.xxx.xxx`です。
* アクセスポートは2881を使用します。
* アクセスするデータベース名は`test`です。
* テナントの接続アカウントは`test_user001@mysql001`です。`mysql001`はOceanBaseデータベース内で作成されたMySQLモードのユーザーテナントです。`test_user001`はテナント`mysql001`のユーザー名です。
* パスワードは`******`です。

**コード：**

```java
...
        <property name="jdbcUrl">jdbc:mysql://xxx.xxx.xxx.xxx:2881/test</property>
        <property name="user">test_user001@mysql001</property>
        <property name="password">******</property>
...
```

### ステップ4：c3p0-mysql-jdbcプロジェクトの実行

1. プロジェクトナビゲータービューで、**src/main/java**ディレクトリを見つけて展開します。

2. **Main.java**ファイルを右クリックし、**Run As**->**Java Application**を選択します。

    ![run](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/c3p0-mysql-jdbc/4run.png)

3. Eclipseのコンソールウィンドウで、プロジェクトのログ情報と出力結果を確認します。

    ![log](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/c3p0-mysql-jdbc/5log.png)

4. OceanBaseクライアント（OBClient）で以下のSQLステートメントを実行して結果を確認することもできます。

    ```shell
    obclient [test]> SELECT * FROM test_c3p0;
    ```

    **実行結果は以下のとおりです：**

    ```shell
    +------+--------------+
    | id   | name         |
    +------+--------------+
    |    5 | test_update  |
    |    6 | test_insert6 |
    |    7 | test_insert7 |
    |    8 | test_insert8 |
    |    9 | test_insert9 |
    +------+--------------+
    5 rows in set
    ```

## プロジェクトコードについて

[c3p0-mysql-jdbc](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/c3p0-mysql-jdbc.zip) をクリックしてプロジェクトコードをダウンロードします。これは、`c3p0-oceanbase-jdbc.zip`という名前の圧縮ファイルです。

解凍すると、`c3p0-mysql-jdbc`という名前のフォルダが作成されます。ディレクトリ構造は以下のとおりです：

```shell
c3p0-mysql-jdbc
├── src
│   └── main
│       ├── java
│       │   └── com
│       │        └── example
│       │           └── Main.java
│       └── resources
│           └── c3p0-config.xml
└── pom.xml
```

**ファイルの説明：**

* `src`：ソースコードのルートディレクトリです。
* `main`：アプリケーションの主要なロジックを含むメインコードディレクトリです。
* `java`：Javaソースコードディレクトリです。
* `com`：Javaパッケージディレクトリです。
* `example`：サンプルプロジェクトのパッケージディレクトリです。
* `Main.java`：メインクラス。テーブルの作成やデータの挿入などのロジックを含みます。
* `resources`：設定ファイルなどを含むリソースファイルディレクトリです。
* `c3p0-config.xml`：C3P0接続プールの設定ファイルです。
* `pom.xml`：プロジェクトの依存関係とビルド設定を管理するために使用されるMavenプロジェクトの設定ファイルです。

### pom.xmlコードの紹介

`pom.xml`ファイルはMavenプロジェクトの設定ファイルで、プロジェクトの依存関係、プラグイン、ビルドルールなどの情報を定義しています。MavenはJavaプロジェクト管理ツールで、依存関係のダウンロード、プロジェクトのコンパイル、パッケージングなどの操作を自動化できます。

本記事の`pom.xml`ファイルのコードは、主に以下のいくつかの部分が含まれます：

1. ファイル宣言ステートメントです。

    このファイルがXMLファイルであり、使用しているXMLのバージョンが`1.0`で、文字エンコーディング方式が`UTF-8`であることを宣言しています。

    **コード：**

    ```java
    <?xml version="1.0" encoding="UTF-8"?>
    ```

2. POMのネームスペースとPOMモデルのバージョンを設定します。

    1. `xmlns`を使用して、POMのネームスペースを`http://maven.apache.org/POM/4.0.0`と指定します。
    2. `xmlns:xsi`を使用して、XMLネームスペースを`http://www.w3.org/2001/XMLSchema-instance`と指定します。
    3. `xsi:schemaLocation`を使用して、POMのネームスペースを`http://maven.apache.org/POM/4.0.0`、POMのXSDファイルの場所を`http://maven.apache.org/xsd/maven-4.0.0.xsd`と指定します。
    4. `<modelVersion>`要素を使用して、このPOMファイルで使用されるPOMモデルバージョンを`4.0.0`と指定します。

    **コード：**

    ```java
    <project xmlns="http://maven.apache.org/POM/4.0.0"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
      <modelVersion>4.0.0</modelVersion>

     <!-- その他の設定 -->

    </project>
    ```

3. 基本情報を設定します。

    1. `<groupId>`で、プロジェクトが属する組織を`com.example`と指定します。
    2. `<artifactId>`で、プロジェクトの名前を`testc3p0`と指定します。
    3. `<version>`で、プロジェクトのバージョン番号を`1.0-SNAPSHOT`と指定します。

    **コード：**

    ```java
        <groupId>com.example</groupId>
        <artifactId>testc3p0</artifactId>
        <version>1.0-SNAPSHOT</version>
    ```

4. プロジェクトソースファイルのプロパティを設定します。

    Mavenのコンパイラプラグインを`maven-compiler-plugin`と指定し、ソースコードとターゲットJavaバージョンをどちらも8に設定しています。これは、プロジェクトのソースコードがJava 8の機能を使用して記述されており、コンパイルされたバイトコードもJava 8ランタイム環境と互換性があることを意味します。この設定により、プロジェクトはコンパイル時および実行時にJava 8の構文と機能を正しく処理できるようになります。

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>Java 1.8とJava 8は、同じバージョンの異なる命名ルールです。</p>
    </main>

    **コード：**

    ```java
        <build>
            <plugins>
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-compiler-plugin</artifactId>
                    <configuration>
                        <source>8</source>
                        <target>8</target>
                    </configuration>
                </plugin>
            </plugins>
        </build>
    ```

5. プロジェクトが依存するコンポーネントを設定します。

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>このセクションのコードは、プロジェクトが依存するコンポーネントがMySQL Connector/Jの8.0.25バージョンであることを定義しています。他のバージョンの情報については、<a href="https://downloads.mysql.com/archives/c-j/">MySQL Connector/J</a>を参照してください。</p>
    </main>

    `<dependency>`タグを使用して、依存関係を定義します。

    * `mysql-connector-java`

    1. `<groupId>`：`mysql`
    2. `<artifactId>`：`mysql-connector-java`
    3. `<version>`：　`8.0.25`

    * `c3p0`接続プール

    1. `<groupId>`：　`com.mchange`
    2. `<artifactId>`：　`c3p0`
    3. `<version>`：　`0.9.5.5`

    **コード：**

    ```java
        <dependencies>
            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
                <version>8.0.25</version>
            </dependency>
            <dependency>
                <groupId>com.mchange</groupId>
                <artifactId>c3p0</artifactId>
                <version>0.9.5.5</version>
            </dependency>
        </dependencies>
    ```

### c3p0-config.xmlコードの紹介

`c3p0-config.xml`ファイルは、C3P0接続プールの設定ファイルです。データベースへの接続に関するプロパティの設定に使用されます。各`<property>`要素の値を設定することで、データベースドライバー、接続URL、ユーザー名、パスワード、接続プールのサイズなどのプロパティを設定できます。

本記事の`c3p0-config.xml`ファイルのコードは、主に以下の部分が含まれます：

1. ファイル宣言ステートメントです。

    このファイルがXMLファイルであり、使用しているXMLのバージョンが`1.0`で、文字エンコーディング方式が`UTF-8`であることを宣言しています。

    **コード：**

    ```java
    <?xml version="1.0" encoding="UTF-8"?>
    ```

2. 基本情報を設定します。

   1. `<c3p0-config>`を使用して、c3p0接続プールの設定情報を含みます。
   2. `<named-config name="oceanbase">`を使用して、`oceanbase`という名前の署名設定を定義しています。コード内で、この名前を使用して署名設定を参照し、`oceanbase`データベースに関連する接続情報と接続プールのプロパティを取得できます。

   **コード：**

   ```java
   <c3p0-config>
       <named-config name="oceanbase">

           // 各<property>要素の値を設定する

       </named-config>
   </c3p0-config>
   ```

3. データベースドライバーを設定します。

    `<property>`を使用して、OceanBaseデータベースへの接続時に使用するMySQL JDBCドライバーのクラス名を`com.msql.cj.jdbc.Driver`と指定します。

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>MySQL Connector/J実装クラスの名前情報については、<a href="https://dev.mysql.com/doc/connector-j/8.1/en/connector-j-reference-driver-name.html">Driver/Datasource Class Name</a>を参照してください。</p>
    </main>

    **コード：**

    ```java
            <property name="driverClass">com.mysql.cj.jdbc.Driver</property>
    ```

4. データベース接続情報を設定します。

    1. データベース接続のURLを設定します。これには、ホストIPアドレス、ポート番号、アクセスする必要があるデータベースとURLパラメータなどの情報が含まれます。
    2. データベースのユーザー名を設定します。
    3. データベースのパスワードを設定します。

    **コード：**

    ```java
            <property name="jdbcUrl">jdbc:mysql://$host:$port/$database_name</property>
            <property name="user">$user_name</property>
            <property name="password">$password</property>
    ```

    **パラメータの説明：**

    * `$host`：OceanBaseデータベースへの接続IPアドレス。ODP接続方式ではODPアドレスを使用し、直接接続方式ではOBServerノードのIPアドレスを使用します。
    * `$port`：OceanBaseデータベースへの接続ポートを提供します。ODP接続方式のデフォルトポートは`2883`で、ODPデプロイ時にカスタマイズすることができます。直接接続方式のデフォルトポートは`2881`で、OceanBaseデータベースのデプロイ時にカスタマイズすることができます。
    * `$database_name`：アクセス対象のデータベース名。
    * `$user_name`：テナントの接続アカウント。ODP接続方式の形式：`ユーザー名@テナント名#クラスタ名`または`クラスタ名:テナント名:ユーザー名`。直接接続方式の形式：`ユーザー名@テナント名`。
    * `$password`：アカウントのパスワード。

5. 他のc3p0データベース接続プールの構成パラメータを設定します。

    1. 接続プールで必要に応じて一度に追加する接続数を20に設定します。つまり、接続プール内の接続が不足した場合、接続数が一度に20追加されます。
    2. 接続プールの初期サイズを10に設定します。つまり、接続プールの起動時に10個の接続が事前に作成されます。
    3. 接続プールの最小接続数を5に設定します。つまり、接続プールで維持される最小接続数は5以上です。
    4. 接続プールの最大接続数を30に設定します。つまり、接続プールで許可される最大接続数は30を超えません。
    5. 各接続の最大キャッシュステートメント数を0に設定します。つまり、ステートメントはキャッシュされません。
    6. 各接続における接続プールの最大キャッシュステートメント数を0に設定します。つまり、各接続でステートメントはキャッシュされません。
    7. c3p0で使用するヘルパースレッドの数を3に設定します。これらのヘルパースレッドは、低速なJDBC操作の実行に使用されます。
    8. c3p0接続のプロパティチェック周期を3秒に設定します。つまり3秒ごとに接続のプロパティをチェックします。
    9. 接続取得のタイムアウトを1000ミリ秒に設定します。つまり、1000ミリ秒以内に接続を取得できない場合、タイムアウト例外が発生します。
    10. 接続プール内のアイドル接続のチェック周期を3秒に設定します。つまり、3秒ごとにアイドル接続の状態をチェックします。
    11. 接続プールの接続の最大アイドル時間を10秒に設定します。つまり、接続が10秒以内に使用されない場合、接続は閉じられます。
    12. 接続プールで最大接続数を超える接続の最大アイドル時間を5秒に設定します。つまり、接続数が最大接続数を上回り、かつ5秒以上アイドル状態が続くと、接続が閉じられます。
    13. 接続取得時の再試行遅延時間を1000ミリ秒に設定します。つまり、接続の取得に失敗した場合、1000ミリ秒後に再試行します。
    14. c3p0の自動テストテーブルを`Test`に設定します。これは接続が有効かどうかをテストするための特別なテーブルです。
    15. 接続プールに接続を返却する際に、接続の有効性をテストするかどうかを設定します。trueに設定されている場合、接続が接続プールに返却される際に接続の有効性テストが行われます。

    **コード：**

    ```java
           <property name="acquireIncrement">20</property>
           <property name="initialPoolSize">10</property>
           <property name="minPoolSize">5</property>
           <property name="maxPoolSize">30</property>
           <property name="maxStatements">0</property>
           <property name="maxStatementsPerConnection">0</property>
           <property name="numHelperThreads">3</property>
           <property name="propertyCycle">3</property>
           <property name="checkoutTimeout">1000</property>
           <property name="idleConnectionTestPeriod">3</property>
           <property name="maxIdleTime">10</property>
           <property name="maxIdleTimeExcessConnections">5</property>
           <property name="acquireRetryDelay">1000</property>
           <property name="automaticTestTable">Test</property>
           <property name="testConnectionOnCheckin">true</property>
    ```

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>具体的なプロパティ（パラメータ）の設定は、プロジェクトの要件とデータベースの特性によって異なります。実際の状況に応じて調整と設定を行うことを推奨します。C3P0接続プールの構成パラメータの詳細については、<a href="https://www.mchange.com/projects/c3p0/">C3P0</a>を参照してください。</p>
</main>

**C3P0接続プールの一般的な基本構成パラメータ：**

<table>
   <tr>
       <th>分類</th>
       <th>プロパティ</th>
       <th>省略値</th>
       <th>説明</th>
   </tr>
   <tr>
       <td rowspan=4>必須項目</td>
       <td>driverClass</td>
       <td>N/A</td>
       <td>ドライバークラス名</td>
   </tr>
   <tr>
       <td>jdbcUrl</td>
       <td>N/A</td>
       <td>データベースへの接続URLを指定するために使用されます。</td>
   </tr>
   <tr>
       <td>user</td>
       <td>N/A</td>
       <td>データベースへの接続時に使用するユーザー名の指定に使用されます。</td>
   </tr>
   <tr>
       <td>password</td>
       <td>N/A</td>
       <td>データベースへの接続に使用されるパスワードの指定に使用されます。</td>
   </tr>
   <tr>
       <td rowspan=6>基本設定</td>
       <td>acquireIncrement</td>
       <td>3</td>
       <td>接続プールから一度に取得する接続数を設定するために使用されます。例えば、<code>acquireIncrement</code> の値が20で、接続プールに現在アイドル状態の接続が5つしかない場合、接続を取得すると、接続プールはアプリケーションのニーズを満たすために、一度に20の新しい接続を作成します。</td>
   </tr>
   <tr>
       <td>acquireRetryAttempts</td>
       <td>30</td>
       <td>データベースから新しい接続を取得できなかった場合の再試行回数を設定するために使用されます。この値がゼロ以下である場合、C3P0は接続の取得を無限に試行し続けます。</td>
   </tr>
   <tr>
       <td>maxIdleTime</td>
       <td>0</td>
       <td>接続プール内の最大アイドル時間を設定するために使用されます。0は、アイドル接続が期限切れにならないことを意味します。例えば、<code>maxIdleTime</code> を10秒に設定すると、接続プール内の接続が10秒以上アイドル状態になっても使用されなかった場合、接続プールによって閉じられ、削除されます。次回アプリケーションが再度接続をリクエストすると、接続プールは新しい接続を再作成します。</td>
   </tr>
   <tr>
       <td>maxPoolSize</td>
       <td>15</td>
       <td>接続プールの最大接続数を設定するために使用されます。接続プールの接続数が <code>maxPoolSize</code> で指定された値に達すると、新しい接続リクエストは、接続が接続プールに解放されるまでブロックされます。</td>
   </tr>
   <tr>
       <td>MinPoolSize</td>
       <td>3</td>
       <td>接続プールの最小接続数を設定するために使用されます。接続が使用されていない場合でも、接続プールは少なくとも <code>minPoolSize</code> で指定された数の接続を保持します。</td>
   </tr>
   <tr>
       <td>initialPoolSize</td>
       <td>3</td>
       <td>接続プールの起動時に事前に作成する接続数を設定するために使用されます。その値は、<code>minPoolSiz</code> と <code>maxPoolSize</code> の間である必要があります。つまり、接続プールを初期化すると <code>initialPoolSize</code> で指定された数の接続が作成されます。
       </td>
   </tr>
   <tr>
       <td rowspan=9>選択可能な構成パラメータ</td>
       <td>acquireRetryDelay</td>
       <td>1000</td>
       <td>接続取得時の再試行遅延時間の設定に使用されます。単位はミリ秒です。アプリケーションが接続プールから接続を取得する際に、接続プール内に利用可能な接続がない場合、接続取得に失敗する可能性があります。このとき、接続プールは <code>acquireRetryDelay</code> の設定に従って再試行します。</td>
   </tr>
   <tr>
       <td>autoCommitOnClose</td>
       <td>false</td>
       <td>接続が閉じられる際にトランザクションを自動的にコミットするかどうかを設定するために使用されます。デフォルト値は <code>false</code> で、これは接続が閉じられる際にトランザクションは自動的にコミットされないことを意味します。アプリケーションが接続を閉じる前に明示的にトランザクションをコミットする必要がある場合は、<code>autoCommitOnClose</code> を <code>true</code> に設定できます。 <main id="notice" type='notice'><h4>注意</h4><p>自動的にコミットされたトランザクションは、データの不整合や損失を引き起こす可能性があります。そのため、<code>autoCommitOnClose</code> は、トランザクションの整合性を確保しながら慎重に使用する必要があります。ほとんどの場合、トランザクションを手動で管理して、トランザクションのコミットまたはロールバックが適切なタイミングで行われるようにすることを推奨します。</p></main> </td>
   </tr>
   <tr>
       <td>automaticTestTable</td>
       <td>null</td>
       <td>接続プールの自動テストテーブルを設定するために使用されます。C3P0は、指定された名前の空のテーブルを作成し、そのテーブルに対するクエリを使用してConnectionをテストします。デフォルト値は <code>null</code> です。テストステートメントが実行されないことを意味します。例えば、<code>automaticTestTable</code> を <code>Test</code> に設定すると、C3P0は <code>Test</code> という名前の空のテーブルを作成し、独自のクエリステートメントを使用してテストを実行します。<main id="notice" type='explain'><h4>説明</h4><p>接続プールで <code>automaticTestTable</code> と <code>preferredTestQuery</code> の両方が設定されている場合、C3P0は <code>preferredTestQuery</code> を優先的に使用してテストクエリを実行し、<code>automaticTestTable</code> の設定は無視されます。</p></main></td>
   </tr>
   <tr>
       <td>idleConnectionTestPeriod</td>
       <td>0</td>
       <td>接続プールがアイドル接続の検出を実行する時間間隔の設定に使用されます。単位はミリ秒です。つまり、接続プールは一定の時間間隔で、アイドル状態の接続に対してテストを実行します。デフォルト値は0です。アイドル接続検出は実行されないことを意味します。</td>
   </tr>
   <tr>
       <td>maxStatements</td>
       <td>0</td>
       <td>接続プールの最大プリペアドステートメント数を設定するために使用されます。<main id="notice" type='explain'><h4>説明</h4><p><ul><li><code>maxStatements</code> と <code>maxStatementsPerConnection</code> が両方とも0の場合、ステートメントキャッシュは有効になりません。</li><li><code>maxStatements</code>が0で、<code>maxStatementsPerConnection</code> が0以外の値の場合、ステートメントキャッシュは有効になりますが、グローバルな制限は適用されず、各接続の最大制限のみが有効になります。</li><li><code>maxStatements</code> は、接続プール内のすべての接続でキャッシュされるステートメントの合計数を制御します。<code>maxStatements</code> を設定する場合は、かなり大きな数値にする必要があります。これは、接続プール内の各接続には独立した異なるキャッシュステートメントセットを必要とするためです。</li></ul></p></main></td>
   </tr>
   <tr>
       <td>maxStatementsPerConnection</td>
       <td>0</td>
       <td>各接続で許可される最大プリペアドステートメント数を設定するために使用されます。<main id="notice" type='explain'><h4>説明</h4><p><ul><li><code>maxStatements</code> と <code>maxStatementsPerConnection</code> が両方とも0の場合、ステートメントキャッシュは有効になりません。</li><li><code>maxStatementsPerConnection</code> が0で、<code>maxStatements</code> が0以外の値の場合、ステートメントキャッシュが有効になり、グローバル制限が強制されますが、個々の接続に対するキャッシュステートメント数の制限は設定されません。</li></ul></p>
</main>
       </td>
   </tr>
   <tr>
       <td>numHelperThreads</td>
       <td>3</td>
       <td>非同期処理タスク用のヘルパースレッドの数を指定するために使用されます。<main id="notice" type='explain'><h4>説明</h4><p><ul><li>ヘルパースレッド数が多いほど、並行処理できるタスクが増加し、接続プールの処理能力と応答速度が向上します。</li><li>過剰なヘルパースレッドを設定するとシステムリソースの消耗が過剰になる場合があるため、システムのハードウェア構成とパフォーマンステストに基づいて、<code>numHelperThreads</code> の値を適切に設定する必要があります。</li></ul></p></main></td>
   </tr>
   <tr>
       <td>preferredTestQuery</td>
       <td>null</td>
       <td>すべての接続テストで実行されるテストステートメントを定義します。接続テストを使用する場合、テストの速度を大幅に向上させることができます。<main id="notice" type='notice'><h4>注意</h4><p>テスト用のテーブルは、初期データソースの時点で存在している必要があります。</p></main></td>
   </tr>
   <tr>
       <td>checkoutTimeout</td>
       <td>0</td>
       <td>接続プールから接続を取得するためのタイムアウト時間を、ミリ秒単位と指定します。デフォルト値は0で、タイムアウト制限がないことを意味します。接続プールが使い果たされてクライアントが <code>getConnection()</code> を呼び出した後、新しい接続を取得するまでの待機する時間です。タイムアウトすると、<code>SQLException</code> がスローされます。</td>
   </tr>
   <tr>
       <td rowspan=3>推奨されない構成パラメータ</td>
       <td>breakAfterAcquireFailure</td>
       <td>false</td>
       <td>接続の取得に失敗した場合、接続プールの取得操作を中断するかどうかを制御するために使用されます。接続の取得に失敗すると、接続プールから接続を取得するために待機しているすべてのスレッドで例外がスローされます。ただし、データソースは有効なまま保持され、次回 <code>getConnection()</code> を呼び出す際に引き続き接続の取得を試みます。<ul><li><code>true</code> に設定した場合、接続の取得が複数回失敗すると、接続プールは接続の取得を試行しなくなり、直ちに失敗して例外をスローします。</li><li><code>false</code> に設定した場合、接続プールは接続の取得のタイムアウト時間になるまで、接続の取得を試行し続けます。</li></ul></td>
   </tr>
   <tr>
       <td>testConnectionOnCheckout</td>
       <td>false</td>
       <td>接続プールから接続を取得する際に、接続をテストするかどうかの指定に使用されます。<ul><li><code>true</code> に設定した場合、接続を取得する際に接続テストが実行されます。この機能は慎重に使用してください。データベースの呼び出し回数が少なくとも2倍に増加します。</li><li><code>false</code> に設定した場合、接続テストは実行されません。</li></ul><main id="notice" type='explain'><h4>説明</h4><p>接続テストを実行すると接続が有効であることを確認できますが、一定のオーバーヘッドが増加します。そのため、接続テストを有効にするかどうかは、具体的なアプリケーションのニーズとパフォーマンス要件に基づいて決定する必要があります。接続の可用性に対するアプリケーションの要求が高い場合、接続テストを有効にすることができます。ただし、接続プール内の接続が頻繁に取得および解放されると、接続テストが頻繁に行われ、パフォーマンスに影響を与える可能性があります。</p></main></td>
   </tr>
   <tr>
       <td>testConnectionOnCheckin</td>
       <td>false</td>
       <td>接続を接続プールに返却する際に、接続をテストするかどうかの指定に使用されます。<ul><li><code>true</code> に設定した場合、接続を接続プールに返却する際、接続テストが実行されます。この機能は慎重に使用してください。同様に、データベースの呼び出しが少なくとも2倍に増加する可能性があります。</li><li><code>false</code> に設定した場合、接続テストは実行されません。</li></ul><main id="notice" type='explain'><h4>説明</h4><p>接続テストを実行すると接続が有効であることを確認できますが、一定のオーバーヘッドが増加します。そのため、接続テストを有効にするかどうかは、具体的なアプリケーションのニーズとパフォーマンス要件に基づいて決定する必要があります。接続の可用性に対するアプリケーションの要求が高い場合、接続テストを有効にすることができます。ただし、接続プール内の接続が頻繁に取得および返却されると、接続テストが頻繁に行われ、パフォーマンスに影響を与える可能性があります。</p></main></td>
   </tr>
</table>

### Main.javaコードの紹介

`Main.java`ファイルは、サンプルプログラムの一部であり、c3p0接続プールを使用してデータベース接続を取得し、トランザクション内で一連のデータベース操作を実行する方法を示しています。これには、テーブルの作成、データの挿入、データの削除、データの更新、データのクエリ、およびクエリ結果の出力が含まれます。これは、c3p0接続プールを使用してデータベース接続を管理し、トランザクション操作を実行することで、データベース操作の効率とパフォーマンスを向上させる方法を示しています。

本記事の`Main.java`ファイルのコードには、主に以下のいくつの部分が含まれます：

1. パッケージを定義し、`java.sql`のインターフェースをインポートします。

    1. 現在のコードが属するパッケージ名を`com.example`と宣言します。
    2. `java.sql.Connection`クラスをインポートします。これはデータベース接続を表すために使用されます。
    3. `java.sql.PreparedStatement`クラスをインポートします。これはプリコンパイルされたデータベース操作の実行に使用されます。
    4. `java.sql.ResultSet`クラスをインポートします。これは、データベースクエリ結果セットを表すために使用されます。
    5. `com.mchange.v2.c3p0.ComboPooledDataSource`クラスをインポートします。これはc3p0接続プールに使用されます。

    **コード：**

    ```java
    package com.example;

    import java.sql.Connection;
    import java.sql.PreparedStatement;
    import java.sql.ResultSet;
    import com.mchange.v2.c3p0.ComboPooledDataSource;
    ```

2. クラス名とメソッドを定義します。

    1. プログラムのエントリポイントとして、`Main`という名前のpublicクラスを定義します。クラス名はファイル名と一致させる必要があります。
    2. プログラムの実行開始点として、public staticメソッド`main`を定義します。
    3. `try-with-resources`ステートメントを使用して、データベース接続を取得し、プリコンパイルされたSQLステートメントを作成します。
    4. データベーストランザクション操作。
    5. 発生する可能性のある例外をキャッチし、例外スタック情報を出力します。
    6. c3p0接続プールからデータベース接続を取得するための、プライベート静的メソッド`getConnection`を定義します。メソッド内部では、まず`ComboPooledDataSource`オブジェクト`cpds`を作成し、`oceanbase`パラメータで接続プールの設定を指定します。次に、`cpds.getConnection()`メソッドで接続プールからデータベース接続を取得し、それを返します。

    **コード：**

    ```java
    public class Main {

        public static void main(String[] args) {
            try (
                // データベース接続を取得する
                // プリコンパイルされたSQLステートメントを作成する
                ) {

                // データベーストランザクション操作：トランザクションの開始、テーブルの作成、データの挿入、データの削除、データの更新、データのクエリ、およびトランザクションのコミット

            } catch (Exception e) {
                e.printStackTrace();
            }
        }

        private static Connection getConnection() throws Exception {
            ComboPooledDataSource cpds = new ComboPooledDataSource("oceanbase");
            return cpds.getConnection();
        }
    }
    ```

3. データベース接続を取得します。

    データベース接続を取得して`conn`変数に代入します。

    **コード：**

    ```java
                 Connection conn = getConnection();
    ```

4. プリコンパイルされたSQLステートメントを作成します。

    1. `test_c3p0`という名前のデータベーステーブルを作成するためのプリコンパイルされたSQLステートメントを作成します。
    2. `test_c3p0`テーブルにデータを挿入するためのプリコンパイルされたSQLステートメントを作成します。
    3. `test_c3p0`テーブルからデータを削除するためのプリコンパイルされたSQLステートメントを作成します。
    4. `test_c3p0`テーブルのデータを更新するためのプリコンパイルされたSQLステートメントを作成します。
    5. `test_c3p0`テーブルからデータをクエリするためのプリコンパイルされたSQLステートメントを作成します。

    **コード：**

    ```java
                 PreparedStatement stmtCreate = conn.prepareStatement("CREATE TABLE test_c3p0 (id INT, name VARCHAR(32))");
                 PreparedStatement stmtInsert = conn.prepareStatement("INSERT INTO test_c3p0 VALUES (?, ?)");
                 PreparedStatement stmtDelete = conn.prepareStatement("DELETE FROM test_c3p0 WHERE id < ?");
                 PreparedStatement stmtUpdate = conn.prepareStatement("UPDATE test_c3p0 SET name = ? WHERE id = ?");
                 PreparedStatement stmtSelect = conn.prepareStatement("SELECT * FROM test_c3p0")
    ```

5. トランザクションを開始します。

    データベース接続の自動コミットを`false`に設定することで、トランザクションのメカニズムを有効化します。

    **コード：**

    ```java
                conn.setAutoCommit(false);
    ```

6. テーブルを作成します。

    テーブル作成のSQLステートメントを実行します。

    **コード：**

    ```java
                stmtCreate.execute();
    ```

7. データを挿入します。

    `for`ループを使用して`test_c3p0`テーブルに10件のデータを挿入します。1列目の値は変数`i`の値、2列目の値は文字列`test_insert`に変数`i`の値を結合したものです。

    **コード：**

    ```java
                for (int i = 0; i < 10; i++) {
                    stmtInsert.setInt(1, i);
                    stmtInsert.setString(2, "test_insert" + i);
                    stmtInsert.executeUpdate();
                }
    ```

8. データを削除します。

    削除ステートメントのパラメータを5に設定して、削除操作を実行します。

    **コード：**

    ```java
                stmtDelete.setInt(1, 5);
                stmtDelete.executeUpdate();
    ```

9. データを更新します。

    更新ステートメントの最初のパラメータを`test_update`、2番目のパラメータは5に設定して、更新操作を実行します。

    **コード：**

    ```java
                stmtUpdate.setString(1, "test_update");
                stmtUpdate.setInt(2, 5);
                stmtUpdate.executeUpdate();
    ```

10. データをクエリします。

    1. クエリステートメントを実行し、クエリ結果を`ResultSet`オブジェクト`rs`に格納します。
    2. whileループを使用して、rs.next() で結果セットに次の行のデータがあるかどうかを判断します。ある場合は、ループ内のコードを実行します。
    3. ループ内のコードは、各行データの`id`列と`name`列の値を出力します。
    4. 結果セットをクローズし、関連リソースを解放します。

    **コード：**

    ```java
                ResultSet rs = stmtSelect.executeQuery();
                while (rs.next()) {
                    System.out.println(rs.getInt("id") + "   " + rs.getString("name"));
                }
                rs.close();
    ```

11. トランザクションをコミットします。

    **コード：**

    ```java
                conn.commit();
    ```

### 全コード表示

:::tab
tab pom.xml

```java
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.oceanbase</groupId>
    <artifactId>testc3p0</artifactId>
    <version>1.0-SNAPSHOT</version>
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <source>8</source>
                    <target>8</target>
                </configuration>
            </plugin>
        </plugins>
    </build>

    <dependencies>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.25</version>
        </dependency>
        <dependency>
            <groupId>com.mchange</groupId>
            <artifactId>c3p0</artifactId>
            <version>0.9.5.5</version>
        </dependency>
    </dependencies>
</project>
```

tab c3p0-config.xml

```java
<?xml version="1.0" encoding="UTF-8"?>
<c3p0-config>
    <named-config name="oceanbase">
        <!-- Configure Database Driver -->
        <property name="driverClass">com.mysql.cj.jdbc.Driver</property>
        <!-- Configure Database Link Address -->
        <property name="jdbcUrl">jdbc:mysql://$host:$port/$database_name</property>
        <!-- Configure database username -->
        <property name="user">$user_name</property>
        <!-- Configure database password -->
        <property name="password">$password</property>
        <!-- How many connection objects does the database Connection pool want from the database at one time -->
        <property name="acquireIncrement">20</property>
        <!-- Initialize connections -->
        <property name="initialPoolSize">10</property>
        <!-- Minimum number of connections -->
        <property name="minPoolSize">5</property>
        <!-- The maximum number of connections reserved in the Connection pool. Default: 15 -->
        <property name="maxPoolSize">30</property>
        <!-- JDBC standard parameter used to control the number of PreparedStatements loaded within the data source. However, the pre cached statements belong to a single connection rather than the entire Connection pool. So setting this parameter requires considering multiple factors. If both maxStatements and maxStatementsPerConnection are 0, the cache is turned off. Default:0 -->
        <property name="maxStatements">0</property>
        <!-- MaxStatementsPerConnection defines the maximum number of cached statements owned by a single connection in the Connection pool. Default: 0 -->
        <property name="maxStatementsPerConnection">0</property>
        <!-- C3p0 is an asynchronous operation, and slow JDBC operations are completed by the helper process. Expanding these operations can effectively improve performance by enabling multiple operations to be executed simultaneously through multithreading. Default:3 -->
        <property name="numHelperThreads">3</property>
        <!-- The user can wait up to 300 seconds before modifying the system configuration parameters. Default: 300 -->
        <property name="propertyCycle">3</property>
        <!-- The default setting for obtaining the connection timeout is to wait for a unit of milliseconds -->
        <property name="checkoutTimeout">1000</property>
        <!-- Check all free connections in the Connection pool every few seconds. Default: 0 -->
        <property name="idleConnectionTestPeriod">3</property>
        <!-- The maximum idle time, within seconds, if not used, the connection will be discarded. If it is 0, it will never be discarded. Default: 0 -->
        <property name="maxIdleTime">10</property>
        <!-- Configure the lifetime of the connection. Connections beyond this time will be automatically disconnected and discarded by the Connection pool. Of course, the connection being used will not be immediately disconnected, but will wait for it to close before disconnecting. When configured to 0, there is no restriction on the lifetime of the connection. -->
        <property name="maxIdleTimeExcessConnections">5</property>
        <!-- The interval time between two connections, in milliseconds. Default: 1000 -->
        <property name="acquireRetryDelay">1000</property>
        <!-- C3p0 will create an empty table called Test and use its built-in query statement for testing. If this parameter is defined, the property preferredTestQuery will be ignored. You cannot perform any operations on this Test table, it will only be used for c3p0 testing. Default: null -->
        <property name="automaticTestTable">Test</property>
        <!-- Test if the connection is valid when obtaining it -->
        <property name="testConnectionOnCheckin">true</property>
    </named-config>
</c3p0-config>
```

tab Main.java

```java
package com.example;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import com.mchange.v2.c3p0.ComboPooledDataSource;

public class Main {

    public static void main(String[] args) {
        try (Connection conn = getConnection();

             PreparedStatement stmtCreate = conn.prepareStatement("CREATE TABLE test_c3p0 (id INT, name VARCHAR(32))");
             PreparedStatement stmtInsert = conn.prepareStatement("INSERT INTO test_c3p0 VALUES (?, ?)");
             PreparedStatement stmtDelete = conn.prepareStatement("DELETE FROM test_c3p0 WHERE id < ?");
             PreparedStatement stmtUpdate = conn.prepareStatement("UPDATE test_c3p0 SET name = ? WHERE id = ?");
             PreparedStatement stmtSelect = conn.prepareStatement("SELECT * FROM test_c3p0")) {

            // Begin transaction
            conn.setAutoCommit(false);

            // Create table
            stmtCreate.execute();

            // Insert data
            for (int i = 0; i < 10; i++) {
                stmtInsert.setInt(1, i);
                stmtInsert.setString(2, "test_insert" + i);
                stmtInsert.executeUpdate();
            }

            // Delete data
            stmtDelete.setInt(1, 5);
            stmtDelete.executeUpdate();

            // Update data
            stmtUpdate.setString(1, "test_update");
            stmtUpdate.setInt(2, 5);
            stmtUpdate.executeUpdate();

            // Query data
            ResultSet rs = stmtSelect.executeQuery();
            while (rs.next()) {
                System.out.println(rs.getInt("id") + "   " + rs.getString("name"));
            }
            rs.close();

            // Commit transaction
            conn.commit();

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private static Connection getConnection() throws Exception {
        ComboPooledDataSource cpds = new ComboPooledDataSource("oceanbase");
        return cpds.getConnection();
    }
}
```

:::

## 関連ドキュメント

MySQL Connector/Jの詳細については、[Overview of MySQL Connector/J](https://dev.mysql.com/doc/connector-j/en/connector-j-overview.html)を参照してください。
