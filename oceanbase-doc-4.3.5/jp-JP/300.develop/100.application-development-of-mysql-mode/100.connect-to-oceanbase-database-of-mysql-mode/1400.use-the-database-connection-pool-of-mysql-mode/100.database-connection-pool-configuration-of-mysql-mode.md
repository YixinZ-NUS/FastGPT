|description|MySQLモードにおけるデータベース接続プールの設定方法と推奨されるパラメータ設定について紹介します。|
|---|---|
|keywords|接続プール、JDBC、MySQLモード、データベース接続|
|dir-name|データベース接続プール設定|
|dir-name-en||
|tenant-type|MySQL Mode|

# データベース接続プールの設定

データベース接続プールの設定は、システムとデータベース間の効率的で安定した接続を確保するための重要な手順です。適切に設定された接続プールは、データベース接続数を効果的に管理し、高同時実行アクセスによる接続枯渇を回避できます。さらに、適切なタイムアウトを設定することで、無効な接続をタイムリーにクリーンアップし、システム全体のパフォーマンスを維持することが可能です。

本記事では、接続プールの基本概念、異なる接続プールの比較、選択ガイド、接続プールパラメータの推奨設定、およびJDBC設定の重要なパラメータについて紹介し、開発者がデータベースアクセスを最適化するのを支援します。

## 接続プールの基本概念

データベース接続プールは、データベース接続を管理するための仕組みです。アプリケーションとデータベースの間に接続プールを構築し、あらかじめ一定数のデータベース接続を作成し、これらの接続をメモリに保存します。アプリケーションがデータベースにアクセスする必要があるとき、毎回新しい接続を作成するのではなく、接続プールから直接接続を取得し、使用後に接続を接続プールに返却することができます。

接続プールの主な利点には、次のものが含まれます：

* **パフォーマンスの向上**：接続の頻繁な作成と破棄によるオーバーヘッドを避けます。
* **リソース管理**：データベース接続の数を制御し、接続枯渇を防ぎます。
* **接続の再利用**：接続の利用率を向上させ、リソースの無駄を削減します。
* **接続モニタリング**：接続状態のモニタリングと統計情報を提供します。

## 接続プールパラメータ

接続プールには通常、以下のパラメータが含まれます：

* **初期接続数**：接続プールの初期化時に作成される接続の数。
* **最小接続数**：接続プール内に保持される最小接続数。
* **最大接続数**：接続プールで許可される最大接続数。
* **接続タイムアウト時間**：接続を取得するまでの最大待機時間。
* **アイドルタイムアウト時間**：接続がプール内でアイドル状態でいられる最大時間。この時間を超えると接続は回収されます。
* **検証間隔**: アイドル状態の接続をチェックする時間の間隔。
* **クエリの検出**：接続が有効であるかどうかを確認するためのSQLクエリ。

## 接続プール設定の推奨

* 管理コンソールの日常運用においては、最小接続数は2で十分です。具体的な接続数は、ビジネスの同時実行数とトランザクションの所要時間に応じて調整します。

* 接続のアイドルタイムアウト時間を設定します。30分を推奨しています。

  MySQLでは、デフォルトで8時間後に接続を切断しますが、クライアントはそれを認識できず、結果としてダーティ接続になります。接続プールは、ハートビートやtestOnBorrowなどのメカニズムを使用して、接続が有効かどうかを確認できます。この時間内に接続が使用されなかった場合、接続は直接切断されます。

## JDBC構成パラメータ

JDBCはJavaデータベース接続用インターフェースです。OceanBaseはJDBCドライバーを提供しており、JavaアプリケーションからOceanBaseデータベースへの接続をサポートしています。JDBCドライバーのダウンロードURLは：[OceanBase JDBCドライバー](https://jp.oceanbase.com/softwarecenter)。

JDBCにおけるいくつかの重要なパラメータは、必ず設定する必要があります。いずれも接続プールのConnectionPropertiesまたはJdbcUrlに設定することができます。具体的なパラメータとその説明は以下の表のとおりです。

| パラメータ           | 説明                                                |
|----------------|-----------------------------------------------------|
| socketTimeout  | ネットワークソケット(Socket)のタイムアウトをミリ秒単位で定義します。値が0の場合はタイムアウトしません。システム変数`max_statement_time`を設定することでもクエリの実行時間を制限できます。デフォルト値：0(標準設定)。|
| connectTimeout | 接続タイムアウト値をミリ秒単位で指定します。値が0の場合はタイムアウトしません。デフォルト値：30000。|

### JDBC設定例

本記事では、JDBC設定例を紹介します。

JDBCを使用してデータベースに接続する際は、最高のパフォーマンスを引き出すために、関連するパラメータを設定する必要があります。ここでは、いくつか関連するパラメータの設定をご紹介します。

JDBC接続の例は以下のとおりです：

```java
conn=jdbc:oceanbase://xxx.xxx.xxx.xxx:3306/test?rewriteBatchedStatements=TRUE&allowMultiQueries=TRUE&useLocalSessionState=TRUE&useUnicode=TRUE&characterEncoding=utf-8&socketTimeout=10000&connectTimeout=30000
```

この接続では、関連パラメータは以下のとおりです：

* `rewriteBatchedStatements`：TRUEに設定することが推奨されます。

  * OceanBaseのJDBCドライバーは、デフォルトではexecuteBatch()ステートメントを無視し、バッチ実行される一連のSQL文を一つずつに分割してデータベースに送信します。この場合、バッチ挿入は実質的に単一挿入となり、パフォーマンスの低下を招きます。実際にバッチ挿入を行うには、このパラメータをTRUEに設定する必要があります。これにより、ドライバはSQLをまとめてバッチ実行するようになります。具体的には、addBatchメソッドを使用して同じテーブルに対する複数のINSERT文を、一つのINSERT文内の複数のVALUES値の形式に結合し、バッチ挿入のパフォーマンスを向上させます。

  * 各INSERT文は、prepareStatementを使用してprepareした上でaddBatchする必要があります。そうでなければ、結合して実行することはできません。

* `allowMultiQueries`：TRUEに設定することが推奨されます。

  JDBCドライバーは、アプリケーションコードが複数のSQLをセミコロン(;)で連結して、1つのSQL文としてサーバーに送信することを許可しています。

* `useLocalSessionState`：トランザクションが頻繁にOceanBaseデータベースへ session 変数クエリ SQL を送信するのを避けるため、TRUEに設定してください。

  session変数は主に：autocommit、read_only、およびtransaction isolationです。

* `socketTimeout`：SQL実行時に、ソケットがSQLの応答を待機する時間。

* `connectTimeout`：接続確立を試みる際に待機する最大時間。

* `useCursorFetch`：`TRUE`に設定することが推奨されます。

  大量のデータを取得するクエリ文の場合、データベースサーバーはCursorを作成し、FetchSizeのサイズに応じてクライアントにデータを配信します。このプロパティを`TRUE`に設定すると、自動的に`useServerPrepStmts=TRUE`も設定されます。

* `useServerPrepStmts`：SQLをデータベースサーバーに送信するためにPSプロトコルを使用するかどうかを制御します。

  `TRUE`に設定されている場合、SQLはデータベース内で2つのステップで実行されます。

  * `？`を含むSQL文をデータベースサーバーに送信してPrepareします(`SQL_audit: request_type=5`)。

  * データベース内で実際のValueを使用してExecuteします(`SQL_audit: request_type=6`)。

* `cachePrepStmts`：JDBCドライバがプリペアドステートメント(PreparedStatement)のキャッシュ(PS cache)を有効にするかどうかを制御します。これにより、クライアントとサーバーの両方で`prepare`処理が繰り返し実行されるのを防ぎます。`useServerPrepStms=TRUE`を使用し、かつ同一のSQL文に対してバッチ実行を繰り返すような場合に`cachePrepStmts=TRUE`は有効です。バッチ実行は毎回`prepare`と`execute`の処理を含みますが、`cachePrepStmts=TRUE` に設定することで、この`prepare`操作の繰り返しを避けることができます。

* `prepStmtCacheSQLLimit`：プリペアドステートメントキャッシュ(PS cache)に保存可能なSQL文の最大長。この長さを超えるSQLはキャッシュされません。prepStmtCacheSize：PS cacheに保存できるSQL文の最大数。

* `maxBatchTotalParamsNum`：1回のバッチ操作でサポートされるパラメータ(batch内の`?`)の最大総数。パラメータ数がこの上限を超えた場合、バッチは分割して実行されます。
