|description||
|---|---|
|keywords||
|dir-name|JDBC|
|dir-name-en||
|tenant-type|MySQL Mode|

# JDBC設定例

本記事では、JDBC設定例を紹介します。JDBCは、Javaからデータベースを接続するためのインターフェースです。OceanBaseはJDBCドライバーを提供しており、JavaアプリケーションからOceanBaseデータベースへの接続をサポートしています。JDBCドライバーのダウンロード：[OceanBase JDBCドライバー](https://en.oceanbase.com/softwarecenter)。

JDBCでデータベースに接続する際、パフォーマンスを最大限に引き出すためには、いくつかの接続パラメータを適切に設定することが重要です。ここでは、一部のパラメータとその設定例を解説します。

JDBC接続の例：

```java
conn=jdbc:oceanbase://xxx.xxx.xxx.xxx:2881/test?rewriteBatchedStatements=TRUE&allowMultiQueries=TRUE&useLocalSessionState=TRUE&useUnicode=TRUE&characterEncoding=utf-8&socketTimeout=10000&connectTimeout=30000
```

この接続では、関連パラメータは以下のとおりです：

* `rewriteBatchedStatements`：TRUEに設定することが推奨されます。

  * OceanBaseのJDBCドライバーは、デフォルトではexecuteBatch()ステートメントを無視し、バッチ実行される一連のSQL文を一つずつに分割してデータベースに送信します。この場合、バッチ挿入は実質的に単一挿入となり、パフォーマンスの低下を招きます。実際にバッチ挿入を行うには、このパラメータをTRUEに設定する必要があります。これにより、ドライバはSQLをまとめてバッチ実行するようになります。具体的には、addBatchメソッドを使用して同じテーブルに対する複数のINSERT文を、一つのINSERT文内の複数のVALUES値の形式に結合し、バッチ挿入のパフォーマンスを向上させます。

  * 各INSERT文は、prepareStatementを使用してprepareした上でaddBatchする必要があります。そうでなければ、結合して実行することはできません。

* `allowMultiQueries`：TRUEに設定することが推奨されます。

  JDBCドライバーは、アプリケーションコードが複数のSQLをセミコロン(;)で連結して、1つのSQL文としてサーバーに送信することを許可しています。

* `useLocalSessionState`：トランザクションが頻繁にOceanBaseデータベースへ session 変数クエリ SQL を送信するのを避けるため、TRUEに設定してください。

  session変数は主に：autocommit、read_only、およびtransaction isolationです。

* `socketTimeout`：SQL実行時に、ソケットがSQLの応答を待機する時間。

* `connectTimeout`：接続確立を試みる際に待機する最大時間。

* `useCursorFetch`：`TRUE`に設定することが推奨されます。

  大量のデータを取得するクエリ文の場合、データベースサーバーはCursorを作成し、FetchSizeのサイズに応じてクライアントにデータを配信します。このプロパティを`TRUE`に設定すると、自動的に`useServerPrepStmts=TRUE`も設定されます。

* `useServerPrepStmts`：SQLをデータベースサーバーに送信するためにPSプロトコルを使用するかどうかを制御します。

  `TRUE`に設定されている場合、SQLはデータベース内で2つのステップで実行されます。

  * `？`を含むSQL文をデータベースサーバーに送信してPrepareします(`SQL_audit: request_type=5`)。

  * データベース内で実際のValueを使用してExecuteします(`SQL_audit: request_type=6`)。

* `cachePrepStmts`：JDBCドライバがプリペアドステートメント(PreparedStatement)のキャッシュ(PS cache)を有効にするかどうかを制御します。これにより、クライアントとサーバーの両方で`prepare`処理が繰り返し実行されるのを防ぎます。`useServerPrepStmts=TRUE`を使用し、かつ同一のSQL文に対してバッチ実行を繰り返すような場合に`cachePrepStmts=TRUE`は有効です。バッチ実行は毎回`prepare`と`execute`の処理を含みますが、`cachePrepStmts=TRUE` に設定することで、この`prepare`操作の繰り返しを避けることができます。

* `prepStmtCacheSQLLimit`：プリペアドステートメントキャッシュ(PS cache)に保存可能なSQL文の最大長。この長さを超えるSQLはキャッシュされません。prepStmtCacheSize：PS cacheに保存できるSQL文の最大数。

* `maxBatchTotalParamsNum`：1回のバッチ操作でサポートされるパラメータ(batch内の`?`)の最大総数。パラメータ数がこの上限を超えた場合、バッチは分割して実行されます。
