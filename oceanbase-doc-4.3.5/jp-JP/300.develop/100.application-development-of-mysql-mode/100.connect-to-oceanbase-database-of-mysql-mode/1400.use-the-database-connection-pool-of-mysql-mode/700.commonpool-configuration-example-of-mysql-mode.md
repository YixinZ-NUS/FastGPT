|description||
|---|---|
|keywords||
|dir-name|Commons Pool|
|dir-name-en||
|tenant-type|MySQL Mode|

# Commons Pool

本記事では、Commons Pool、MySQL Connector/J、およびOceanBaseデータベースを使用してアプリケーションを構築し、テーブルの作成、データの挿入、更新、削除、クエリ、テーブルの削除など、基本的なデータベース操作を実現する方法について説明します。

<div role="videolist">
      <a role='link' href='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/commonpool-mysql-client/commonpool-mysql-client.zip'>
          <img src='https://file.oceanbase.com/doc/img/lQLPJyFovGIOcJQWFrAqhLlgRRsPvwU-H7hJ_i0A_22_22.png'/>
          commonpool-mysql-clientサンプルプロジェクトをダウンロード
      </a>
      <!-- <a role='video' href='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/video-center/video/video/05%20commonpool-mysql-client.mp4'>
          <img src='https://mdn.alipayobjects.com/huamei_22khvb/afts/img/A*DFPmToHK6hgAAAAAAAAAAAAADiGDAQ/original'/>
          Commons Pool 连接 OceanBase 数据库示例程序（MySQL 模式）
      </a> -->
</div>

## 前提条件

* OceanBaseデータベースがインストール済みで、MySQLモードのテナントが作成されていること。
* JDK 1.8とMavenがインストール済みであること。
* Eclipseがインストール済みであること。

    <main id="notice" type='explain'>
    <h4>説明</h4>
    <p>この記事でコードの実行にはEclipse IDE for Java Developers 2022-03バージョンを使用しています。ご自身の好みに合わせて、適切なツールを選択してサンプルコードを実行することも可能です。</p>
    </main>

## 操作手順

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>本記事の操作手順はWindows環境に基づいています。他のOS環境やコンパイラを使用する場合は、操作手順が若干異なる場合があります。</p>
</main>

1. `commonpool-mysql-client`プロジェクトをEclipseにインポートします。
2. OceanBaseデータベースのURLを取得します。
3. `commonpool-mysql-client`プロジェクト内のデータベース接続情報を修正します。
4. `commonpool-mysql-client`プロジェクトを実行します。

### ステップ１：commonpool-mysql-clientプロジェクトをEclipseにインポートする

1. Eclipseを開き、メニューバーから**File**->**Open Projects from File System**を選択します。

2. ポップアップダイアログで、**Directory**ボタンをクリックしてプロジェクトのディレクトリを選択し、**Finish**をクリックしてインポートを完了します。

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>Eclipseを使用してMavenプロジェクトをインポートすると、プロジェクト内の<code>pom.xml</code>ファイルを自動的に検出し、その記述に基づいて必要な依存ライブラリをダウンロードしてプロジェクトに追加します。</p>
    </main>

    ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/commonpool-mysql-client/1.png)

3. プロジェクトの状況を確認します。

    ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/commonpool-mysql-client/2.png)

### ステップ2：OceanBaseデータベースのURLを取得する

1. OceanBaseデータベースのデプロイ担当者または管理者から、該当するデータベース接続文字列を取得します。

    **例：**

    ```shell
    obclient -hxxx.xxx.xxx.xxx -P2881 -utest_user001@mysql001 -p****** -Dtest
    ```

    接続文字列に関する詳細については、[OBClientによるOceanBaseテナントへの接続](../300.connect-to-an-oceanbase-tenant-by-using-obclient-of-mysql-mode.md)を参照してください。

2. OceanBaseデータベース接続文字列の情報に基づいて、以下のURLの対応する情報を入力します。

    ```shell
    jdbc:mysql://$host:$port/$database_name?user=$user_name&password=$password&useSSL=false
    ```

    **パラメータの説明：**

    * `$host`：OceanBaseデータベースへの接続IPアドレス。OceanBaseデータベースプロキシ(OceanBase Database Proxy、ODP)接続方式ではODPアドレスを使用し、直接接続方式ではOBServerノードのIPアドレスを使用します。
    * `$port`：OceanBaseデータベースへの接続ポート。ODP接続方式のデフォルトポートは`2883`で、ODPデプロイ時にカスタマイズ可能です。直接接続方式のデフォルトポートは`2881`で、OceanBaseデータベースのデプロイ時にカスタマイズ可能です。
    * `$database_name`：アクセス対象のデータベース名。

        <main id="notice" type='notice'>
          <h4>注意</h4>
          <p>テナントに接続するユーザーは、データベースに対する<code>CREATE</code>、<code>DROP</code>、<code>INSERT</code>、<code>DELETE</code>、<code>UPDATE</code>、<code>SELECT</code>権限が付与されていなければなりません。その他のユーザー権限の詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974758">MySQLモードの権限分類</a>を参照してください。</p>
        </main>

    * `user_name`：テナントの接続アカウント。ODP接続の一般的な形式：`ユーザー名@テナント名#クラスタ名`または`クラスタ名:テナント名:ユーザー名`。直接接続方式の形式：`ユーザー名@テナント名`。
    * `password`：アカウントのパスワード。

    MySQL Connector/Jの接続プロパティの詳細については、[Configuration Properties](https://dev.mysql.com/doc/connector-j/en/connector-j-reference-configuration-properties.html)を参照してください。

    **例：**

    ```shell
    jdbc:mysql://xxx.xxx.xxx.xxx:2881/test?user=test_user001@mysql001&password=******&useSSL=false
    ```

### ステップ3：commonpool-mysql-clientプロジェクトのデータベース接続情報を修正する

**ステップ2：OceanBaseデータベースのURLを取得する**で取得した情報に基づいて、ファイル`commonpool-mysql-client/src/main/resources/db.properties`内のデータベース接続情報を修正します。

![3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/commonpool-mysql-client/3.png)

**例：**

* OBServerノードのIPアドレスは`xxx.xxx.xxx.xxx`です。
* アクセスポートは2881を使用します。
* アクセスするデータベースの名前は`test`です。
* テナントの接続アカウントは`test_user001@mysql001`です。`test_user001`がユーザー名、`mysql001`がテナント名を表します。この`mysql001`は、OceanBaseデータベース上にMySQLモードで作成されたテナントです。
* パスワードは`******`です。

**コード：**

```java
...
db.url=jdbc:mysql://xxx.xxx.xxx.xxx:2881/test?useSSL=false
db.username=test_user001@mysql001
db.password=******
...
```

### ステップ4：commonpool-mysql-clientプロジェクトを実行する

1. プロジェクトナビゲータービューで、**src/main/java**ディレクトリを見つけて展開します。

2. **Main.java**ファイルを右クリックし、**Run As**->**Java Application**を選択します。

    ![4](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/commonpool-mysql-client/4.png)

3. Eclipseのコンソールウィンドウで出力結果を確認します。

    ![5](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/commonpool-mysql-client/5.png)

## プロジェクトコードについて

[commonpool-mysql-client](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/connection-pool/commonpool-mysql-client/commonpool-mysql-client.zip) をクリックして、プロジェクトコードをダウンロードします。これは、`commonpool-mysql-client.zip`いう名前の圧縮ファイルです。

解凍すると、`commonpool-mysql-client`という名前のフォルダが作成されます。ディレクトリ構造は以下のとおりです：

```shell
commonpool-mysql-client
├── src
│   └── main
│       ├── java
│       │   └── com
│       │       └── example
│       │           └── Main.java
│       └── resources
│           └── db.properties
└── pom.xml
```

**ファイルの説明：**

* `src`：ソースコードのルートディレクトリです。
* `main`：アプリケーションの主要なロジックを含むメインコードディレクトリです。
* `java`：Javaソースコードディレクトリです。
* `com`：Javaパッケージディレクトリです。
* `example`：サンプルプロジェクトのパッケージディレクトリです。
* `Main.java`：テーブルの作成、データの挿入、削除、更新、およびクエリなどのロジック処理を含むメインクラスプログラムのサンプルファイルです。
* `resources`：設定ファイルなどを含むリソースファイルディレクトリです。
* `db.properties`：データベース接続に関するパラメータを含む接続プールの設定ファイルです。
* `pom.xml`：プロジェクトの依存関係とビルド設定を管理するために使用されるMavenプロジェクトの設定ファイルです。

### pom.xmlコードの紹介

`pom.xml`ファイルはMavenプロジェクトの設定ファイルで、プロジェクトの依存関係、プラグイン、ビルドルールなどの情報を定義しています。MavenはJavaプロジェクト管理ツールで、依存関係のダウンロード、プロジェクトのコンパイル、パッケージングなどの操作を自動化できます。

本記事の`pom.xml`ファイルのコードは、主に以下のいくつかの部分が含まれます：

1. ファイル宣言ステートメントです。

    このファイルがXMLファイルであり、使用しているXMLのバージョンが`1.0`で、文字エンコーディング方式が`UTF-8`であることを宣言しています。

    **コード：**

    ```java
    <?xml version="1.0" encoding="UTF-8"?>
    ```

2. POMのネームスペースとPOMモデルのバージョンを設定します。

    1. `xmlns`で、POMのネームスペースを`http://maven.apache.org/POM/4.0.0`と指定します。
    2. `xmlns:xsi`で、XMLネームスペースを`http://www.w3.org/2001/XMLSchema-instance`と指定します。
    3. `xsi:schemaLocation`で、POMのネームスペースを`http://maven.apache.org/POM/4.0.0`、POMのXSDファイルの場所を`http://maven.apache.org/xsd/maven-4.0.0.xsd`と指定します。
    4. `<modelVersion>`要素を使用して、このPOMファイルで使用されるPOMモデルバージョンを`4.0.0`と指定します。

    **コード：**

    ```java
    <project xmlns="http://maven.apache.org/POM/4.0.0"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
      <modelVersion>4.0.0</modelVersion>

     <!-- その他の設定 -->

    </project>
    ```

3. 基本情報を設定します。

    1. `<groupId>`で、プロジェクトが属する組織を`com.example`と指定します。
    2. `<artifactId>`で、プロジェクトの名前を`commonpool-mysql-client`と指定します。
    3. `<version>`で、プロジェクトのバージョン番号を`1.0-SNAPSHOT`と指定します。

    **コード：**

    ```java
        <groupId>com.example</groupId>
        <artifactId>commonpool-mysql-client</artifactId>
        <version>1.0-SNAPSHOT</version>
    ```

4. プロジェクトソースファイルのプロパティを設定します。

    Mavenのコンパイラプラグインを`maven-compiler-plugin`と指定し、ソースコードとターゲットJavaバージョンをどちらも8に設定しています。これは、プロジェクトのソースコードがJava 8の機能を使用して記述されており、コンパイルされたバイトコードもJava 8ランタイム環境と互換性があることを意味します。この設定により、プロジェクトはコンパイル時および実行時にJava 8の構文と機能を正しく処理できるようになります。

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>Java 1.8とJava 8は、同じバージョンの異なる命名ルールです。</p>
    </main>

    **コード：**

    ```java
        <build>
            <plugins>
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-compiler-plugin</artifactId>
                    <configuration>
                        <source>8</source>
                        <target>8</target>
                    </configuration>
                </plugin>
            </plugins>
        </build>
    ```

5. プロジェクトが依存するコンポーネントを設定します。

    1. データベースとのインタラクションを実行するために、`mysql-connector-java`依存ライブラリを追加します：

       1. `<groupId>`：`mysql`
       2. `<artifactId>`：`mysql-connector-java`
       3. `<version>`：`5.1.40`

        **コード：**

        ```java
                <dependency>
                    <groupId>mysql</groupId>
                    <artifactId>mysql-connector-java</artifactId>
                    <version>5.1.40</version>
                </dependency>
        ```

    2. `commons-pool2`依存ライブラリを追加して、プロジェクトでその機能とクラスを使用できるようにします：

       1. `<groupId>`：`org.apache.commons`
       2. `<artifactId>`：`commons-pool2`
       3. `<version>`：`2.7.0`

        **コード：**

        ```java
                <dependency>
                    <groupId>org.apache.commons</groupId>
                    <artifactId>commons-pool2</artifactId>
                    <version>2.7.0</version>
                </dependency>
        ```

### db.propertiesコードの紹介

`db.properties`は本記事の例となる接続プールの設定ファイルであり、接続プールの設定プロパティが含まれています。これらのプロパティには、データベースURL、ユーザー名、パスワード、接続プールのその他のオプションが含まれます。

本記事の`db.properties`ファイルのコードは、主に以下のいくつかの部分が含まれます：

1. データベース接続パラメータを設定します。

    1. データベース接続のURLを設定します。これには、ホストIPアドレス、ポート番号、アクセスする必要があるデータベースが含まれます。
    2. データベースのユーザー名を設定します。
    3. データベースのパスワードを設定します。

    **コード：**

    ```java
    db.url=jdbc:mysql://$host:$port/$database_name?useSSL=false
    db.username=$user_name
    db.password=$password
    ```

    **パラメータの説明：**

    * `$host`：OceanBaseデータベースへの接続IPアドレス。ODP接続方式ではODPアドレスを使用し、直接接続方式ではOBServerノードのIPアドレスを使用します。
    * `$port`：OceanBaseデータベースへの接続ポート。ODP接続方式のデフォルトポートは`2883`で、ODPデプロイ時にカスタマイズ可能です。直接接続方式のデフォルトポートは`2881`で、OceanBaseデータベースのデプロイ時にカスタマイズ可能です。
    * `$database_name`：アクセス対象のデータベース名。
    * `$user_name`：テナントの接続アカウント。ODP接続の一般的な形式：`ユーザー名@テナント名#クラスタ名`または`クラスタ名:テナント名:ユーザー名`。直接接続方式の形式：`ユーザー名@テナント名`。
    * `$password`：アカウントのパスワード。

2. 他の接続プールのパラメータを設定します。

    1. 接続プールの最大接続数を10に設定します。これは、接続プールで同時に最大10個の接続を保持できることを意味します。
    2. 接続プールの最大アイドル接続数を5に設定します。接続プールの接続数が最大アイドル接続数を上回ると、余分な接続は閉じられます。
    3. 接続プールの最小アイドル接続数を2に設定します。接続プールで使用されている接続ががない場合でも、少なくとも2つのアイドル接続が保持されます。
    4. 接続プールから接続を取得するための最大待機時間を5000ミリ秒に設定します。接続プールに利用可能な接続がない場合、接続を取得する操作は最大待機時間を超えるまで待機します。

    **コード：**

    ```java
    pool.maxTotal=10
    pool.maxIdle=5
    pool.minIdle=2
    pool.maxWaitMillis=5000
    ```

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>具体的なプロパティ（パラメータ）の設定は、プロジェクトの要件とデータベースの特性によって異なります。実際の状況に応じて調整と設定を行うことを推奨します。</p>
</main>

**Commons Pool 2のよく使われる構成パラメータ：**

| パラメータ | 説明 |
| ------ | ------ |
| url | データベースタイプ、ホスト名、ポート番号、データベースの名前などの情報を含む、データベースに接続するURLアドレスを指定します。|
| username | データベースに接続するために必要なユーザー名。|
| password | データベースに接続するために必要なパスワード。|
| maxTotal | オブジェクトプールで作成できる最大オブジェクト数を指定します。|
| maxIdle | オブジェクトプールで保持できる最大アイドルオブジェクト数を指定します。|
| minIdle | オブジェクトプール内に保持される最小のアイドルオブジェクト数を指定します。|
| blockWhenExhausted | オブジェクトプールが枯渇した場合の`borrowObject`操作の動作を指定します。<ul><li>`true`：`borrowObject`メソッドは、利用可能なオブジェクトになるまでブロックされます。</li><li>`false`：`borrowObject`メソッドは、直ちに`NoSuchElementException`例外をスローします。</li></ul>|
| maxWaitMillis | プールが枯渇した場合、`borrowObject`メソッドが待機する最大時間（ミリ秒）を指定します。|
| testOnBorrow |`borrowObject`メソッドが呼び出し時にオブジェクトを検証するかどうかを指定します。<ul><li>`true`：`borrowObject`メソッドが呼び出されるたびに、オブジェクトの`validateObject`メソッドが呼び出され、検証が行われます。</li><li>`false`：検証は行いません。</li></ul>|
| testOnReturn |`returnObject`メソッドが呼び出されたときにオブジェクトを検証するかどうかを指定します。<ul><li>`true`：`returnObject`メソッドが呼び出されるたびに、オブジェクトの`validateObject`メソッドが呼び出され、検証が行われます。</li><li>`false`：検証は行いません。</li></ul>|
| testWhileIdle | オブジェクトがアイドル状態のときに検証するかどうかを指定します。詳細は以下のとおりです：<ul><li>`true`に設定されている場合、オブジェクトプール内のアイドルオブジェクトが借用される前に、定期的に`validateObject`メソッドを呼び出して検証します。この検証操作は、アイドルオブジェクトが引き続き有効で使用可能であることを確保します。</li><li>`false`に設定されている場合、アイドルオブジェクトは検証されません。つまり、`validateObject`メソッドは呼び出されません。</li></ul>|
| timeBetweenEvictionRunsMillis | アイドルオブジェクトのエビクションスレッドのスケジュール間隔（ミリ秒）を指定します。|
| numTestsPerEvictionRun | エビクションスレッドがスケジュールされるたびにチェックするアイドルオブジェクトの数を指定します。|

### Main.javaコードの紹介

`Main.java`ファイルはサンプルプログラムの一部であり、コードはCommons Pool 2を使用してデータベース操作を実行する方法を示しています。本記事の`Main.java`ファイルのコードには、主に以下の部分が含まれます：

1. パッケージを定義し、必要なクラスをインポートします。

    1. 現在のコードが属するパッケージ名を`com.example`と宣言します。
    2. `java.io.IOException`クラスをインポートし、入出力例外を処理するために使用されます。
    3. `java.sql.Connection`クラスをインポートし、データベースとの接続を表すために使用されます。このオブジェクトを使用してSQLステートメントを実行し、結果を取得できます。
    4. `java.sql.DriverManager`クラスをインポートし、ドライバーのロードとデータベース接続の確立を管理するために使用されます。このクラスを使用してデータベース接続を取得できます。
    5. `java.sql.ResultSet`クラスをインポートし、SQLクエリの結果セットを表すために使用されます。このオブジェクトを使用して、クエリ結果をイテレーションおよび操作できます。
    6. `java.sql.SQLException`クラスをインポートし、SQLステートメントに関連する例外を処理するために使用されます。
    7. `java.sql.Statement`クラスをインポートし、SQLステートメントのオブジェクトを実行するために使用されます。`Connection`オブジェクトの`createStatement`メソッドを使用して作成できます。
    8. `java.util.Properties`クラスをインポートします。これは、キーと値のペアの集合であり、設定情報をロードおよび保存するために使用されます。設定ファイルからデータベースの接続情報をロードすることができます。
    9. `org.apache.commons.pool2.ObjectPool`クラスをインポートします。これは、オブジェクトプールインターフェースであり、オブジェクトの取得や返却などの、プールされたオブジェクトの基本的な操作を定義しています。
    10. `org.apache.commons.pool2.PoolUtils`クラスをインポートし、オブジェクトプールの操作を便利にするためのユーティリティメソッドが提供されます。
    11. `org.apache.commons.pool2.PooledObject`クラスをインポートします。これは、オブジェクトプールの管理を実現したラッパーオブジェクトです。このインターフェースを実装することで、プールされたオブジェクトのライフサイクルを管理できます。
    12. `org.apache.commons.pool2.impl.GenericObjectPool`クラスをインポートします。これは`ObjectPool`インターフェースのデフォルト実装クラスであり、接続プールの基本機能を実現しています。
    13. `org.apache.commons.pool2.impl.GenericObjectPoolConfig`クラスをインポートします。これは`GenericObjectPool`の設定クラスであり、接続プールのプロパティを設定するために使用されます。
    14. `org.apache.commons.pool2.impl.DefaultPooledObject`クラスをインポートします。これは`PooledObject`インターフェースのデフォルト実現クラスであり、プールされたオブジェクトのラッパーを管理するために使用されます。これには実際の接続オブジェクトと、その他の管理情報を含めることができます。

    **コード：**

    ```java
    package com.example;

    import java.io.IOException;
    import java.sql.Connection;
    import java.sql.DriverManager;
    import java.sql.ResultSet;
    import java.sql.SQLException;
    import java.sql.Statement;
    import java.util.Properties;

    import org.apache.commons.pool2.ObjectPool;
    import org.apache.commons.pool2.PoolUtils;
    import org.apache.commons.pool2.PooledObject;
    import org.apache.commons.pool2.impl.GenericObjectPool;
    import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
    import org.apache.commons.pool2.impl.DefaultPooledObject;
    ```

2. `Main`クラスを作成し、`main`メソッドを定義します。

    `Main`クラスと`main`メソッドを定義し、`main`メソッドは、接続プールを使用してデータベースから一連の操作を実行する方法を示すために使用されます。具体的な手順は以下のとおりです：

    1. プログラムのエントリポイントとして、`Main`という名前のpublicクラスを定義します。クラス名はファイル名と一致させる必要があります。
    2. プログラムの実行開始点として、public staticメソッド`main`を定義します。

        1. データベース設定ファイルをロードする：

            1. データベース設定情報をストレージするための`Properties`オブジェクトを作成します。
            2. `Main`クラスのクラスローダーを使用して`db.properties`リソースファイルの入力ストリームを取得し、`Properties`オブジェクトの`load()`メソッドを使用してこの入力ストリームをロードし、プロパティファイルのキーと値のペアを`props`オブジェクトにロードされます。
            3. スローされる可能性がある`IOException`例外をキャッチして、例外スタック情報を出力します。

        2. データベース接続プールの設定を作成する：

            1. ジェネリックオブジェクトプールの設定オブジェクトを作成し、接続プールの動作を設定するために使用されます。
            2. 接続プールで許可される最大接続数を設定します。
            3. 接続プールで許可される最大アイドル接続数を設定します。
            4. 接続プールで許可される最小アイドル接続数を設定します。
            5. 接続を取得するための最大待機時間を設定します。

        3. データベース接続プールを作成する：スレッドセーフな接続プールオブジェクト`connectionPool`を作成し、`ConnectionFactory`オブジェクトと`poolConfig`設定オブジェクトを使用してジェネリックオブジェクトプールを作成し、スレッドセーフなオブジェクトプールでラップします。接続プールをスレッドセーフにラップすることで、マルチスレッド環境における接続の取得と解放操作の安全性を確保できます。
        4. データベース接続を取得して、接続プールの`borrowObject()`メソッドを使用してデータベース接続を取得し、`try`コードブロック内でその接続を使用してデータベース操作を行います。

            1. `createTable()`メソッドを呼び出して、テーブルを作成します。
            2. `insertData()`メソッドを呼び出して、データを挿入します。
            3. `selectData()`メソッドを呼び出して、データをクエリします。
            4. `updateData()`メソッドを呼び出して、データを更新します。
            5. `selectData()`メソッドを再度呼び出して、更新されたデータをクエリします。
            6. `deleteData()`メソッドを呼び出して、データを削除します。
            7. `selectData()`メソッドを再度呼び出して、削除後のデータをクエリします。
            8. `dropTable()`メソッドを呼び出して、テーブルを削除します。
            9. 例外をキャッチして出力します。

    3. 他のデータベース操作メソッドを定義します。

    **コード：**

    ```java
    public class Main {

        public static void main(String[] args) {
            // Load the database configuration file
            Properties props = new Properties();
            try {
                props.load(Main.class.getClassLoader().getResourceAsStream("db.properties"));
            } catch (IOException e) {
                e.printStackTrace();
            }

            // Create the database connection pool configuration
            GenericObjectPoolConfig<Connection> poolConfig = new GenericObjectPoolConfig<>();
            poolConfig.setMaxTotal(Integer.parseInt(props.getProperty("pool.maxTotal")));
            poolConfig.setMaxIdle(Integer.parseInt(props.getProperty("pool.maxIdle")));
            poolConfig.setMinIdle(Integer.parseInt(props.getProperty("pool.minIdle")));
            poolConfig.setMaxWaitMillis(Long.parseLong(props.getProperty("pool.maxWaitMillis")));

            // Create the database connection pool
            ObjectPool<Connection> connectionPool = PoolUtils.synchronizedPool(new GenericObjectPool<>(new ConnectionFactory(
                    props.getProperty("db.url"), props.getProperty("db.username"), props.getProperty("db.password")), poolConfig));

            // Get a database connection
            try (Connection connection = connectionPool.borrowObject()) {

                // Create table
                createTable(connection);

                // Insert data
                insertData(connection);
                // Query data
                selectData(connection);

                // Update data
                updateData(connection);
                // Query the updated data
                selectData(connection);

                // Delete data
                deleteData(connection);
                // Query the data after deletion

                selectData(connection);

                // Drop table
                dropTable(connection);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }

        // テーブルを作成するためのメソッドを定義する
        // データを挿入するためのメソッドを定義する
        // データを更新するたのメソッドを定義する
        // データを削除するためのメソッドを定義する
        // データをクエリするためのメソッドを定義する
        // テーブルを削除するためのメソッドを定義する
        // ConnectionFactoryクラスを定義する
    }
    ```

3. テーブルを作成するためのメソッドを定義します。

    `createTable`という名前のメソッドを定義して、`Connection`オブジェクトをパラメータとして受け取ります。具体的な手順は以下のとおりです：

    1. プライベート静的メソッド`createTable()`を定義し、`Connection`オブジェクトをパラメータとして受け取り、`SQLException`例外をスローする可能性があることを宣言します。
    2. 接続の`createStatement()`メソッドを使用して`Statement`オブジェクトを作成し、`try-with-resources`ステートメント内でそのオブジェクトを使用してデータベース操作を実行します。
    3. 文字列変数`sql`を定義し、テーブルを作成するためのSQLステートメントをストレージします。
    4. `Statement`オブジェクトの`executeUpdate()`メソッドを使用して`sql`ステートメントを実行し、テーブルを作成します。
    5. コンソールにテーブル作成が成功したことを示すメッセージを出力します。

    **コード：**

    ```java
        private static void createTable(Connection connection) throws SQLException {
            try (Statement statement = connection.createStatement()) {
                String sql = "CREATE TABLE test_commonpool (id INT,name VARCHAR(20))";
                statement.executeUpdate(sql);
                System.out.println("Table created successfully.");
            }
        }
    ```

4. データを挿入するためのメソッドを定義します。

    `insertData()`という名前のメソッドを定義し、`Connection`オブジェクトをパラメータとして受け取ります。具体的な手順は以下のとおりです：

    1. プライベート静的メソッド`insertData()`を定義し、`Connection`オブジェクトをパラメータとして受け取り、`SQLException`例外をスローする可能性があることを宣言します。
    2. 接続の`createStatement()`メソッドを使用して`Statement`オブジェクトを作成し、`try-with-resources`ステートメント内でそのオブジェクトを使用してデータベース操作を実行します。
    3. 文字列変数`sql`を定義し、データを挿入するためのSQLステートメントをストレージします。
    4. `Statement`オブジェクトの`executeUpdate()`メソッドを使用して`sql`ステートメントを実行し、データを挿入します。
    5. コンソールにデータ挿入が成功したことを示すメッセージを出力します。

    **コード：**

    ```java
        private static void insertData(Connection connection) throws SQLException {
            try (Statement statement = connection.createStatement()) {
                String sql = "INSERT INTO test_commonpool (id, name) VALUES (1,'A1'), (2,'A2'), (3,'A3')";
                statement.executeUpdate(sql);
                System.out.println("Data inserted successfully.");
            }
        }
    ```

5. データを更新するためのメソッドを定義します。

    `updateData()`という名前のメソッドを定義し、`Connection`オブジェクトをパラメータとして受け取ります。具体的な手順は以下のとおりです：

    1. プライベート静的メソッド`updateData()`を定義し、`Connection`オブジェクトをパラメータとして受け取り、`SQLException`例外をスローする可能性があることを宣言します。
    2. 接続の`createStatement()`メソッドを使用して`Statement`オブジェクトを作成し、`try-with-resources`ステートメント内でそのオブジェクトを使用してデータベース操作を実行します。
    3. 文字列変数`sql`を定義し、データを更新するためのSQLステートメントをストレージします。
    4. `Statement`オブジェクトの`executeUpdate()`メソッドを使用して`sql`ステートメントを実行し、データを更新します。
    5. コンソールにデータ更新が成功したことを示すメッセージを出力します。

    **コード：**

    ```java
        private static void updateData(Connection connection) throws SQLException {
            try (Statement statement = connection.createStatement()) {
                String sql = "UPDATE test_commonpool SET name = 'A11' WHERE id = 1";
                statement.executeUpdate(sql);
                System.out.println("Data updated successfully.");
            }
        }
    ```

6. データを削除するためのメソッドを定義します。

    `deleteData()`という名前のメソッドを定義し、`Connection`オブジェクトをパラメータとして受け取ります。具体的な手順は以下のとおりです：

    1. プライベート静的メソッド`deleteData()`を定義し、`Connection`オブジェクトをパラメータとして受け取り、`SQLException`例外をスローする可能性があることを宣言します。
    2. 接続の`createStatement()`メソッドを使用して`Statement`オブジェクトを作成し、`try-with-resources`ステートメント内でそのオブジェクトを使用してデータベース操作を実行します。
    3. 文字列変数`sql`を定義し、データを削除するためのSQLステートメントをストレージします。
    4. `Statement`オブジェクトの`executeUpdate()`メソッドを使用して`sql`ステートメントを実行し、データを削除します。
    5. コンソールにデータ削除が成功したことを示すメッセージを出力します。

    **コード：**

    ```java
        private static void deleteData(Connection connection) throws SQLException {
            try (Statement statement = connection.createStatement()) {
                String sql = "DELETE FROM test_commonpool WHERE id = 2";
                statement.executeUpdate(sql);
                System.out.println("Data deleted successfully.");
            }
        }
    ```

7. データのクエリを行うためのメソッドを定義します。

    `selectData()`という名前のメソッドを定義し、`Connection`オブジェクトをパラメータとして受け取ります。具体的な手順は以下のとおりです：

    1. プライベート静的メソッド`selectData()`を定義し、`Connection`オブジェクトをパラメータとして受け取り、`SQLException`例外をスローする可能性があることを宣言します。
    2. 接続の`createStatement()`メソッドを使用して`Statement`オブジェクトを作成し、`try-with-resources`ステートメント内でそのオブジェクトを使用してデータベース操作を実行します。
    3. 文字列変数`sql`を定義し、データをクエリするSQLステートメントをストレージします。
    4. `Statement`オブジェクトの`executeQuery()`メソッドを使用して`sql`ステートメントを実行し、結果を`ResultSet`オブジェクトにストレージします。
    5. `resultSet.next()`メソッドを使用して、次の行のデータが存在するかどうかを判断し、ループに入ります。
    6. `resultSet.getInt()`メソッドを使用して、現在の行の整数型データを取得します。このメソッドのパラメータはデータの列名です。
    7. `resultSet.getString()`メソッドを使用して、現在の行の文字列データを取得します。このメソッドのパラメータはデータの列名です。
    8. コンソールに現在の行のデータを出力します。

    **コード：**

    ```java
        private static void selectData(Connection connection) throws SQLException {
            try (Statement statement = connection.createStatement()) {
                String sql = "SELECT * FROM test_commonpool";
                ResultSet resultSet = statement.executeQuery(sql);
                while (resultSet.next()) {
                    int id = resultSet.getInt("id");
                    String name = resultSet.getString("name");
                    System.out.println("id: " + id + ", name: " + name);
                }
            }
        }
    ```

8. テーブルを削除するためのメソッドを定義します。

    `dropTable()`という名前のメソッドを定義し、`Connection`オブジェクトをパラメータとして受け取ります。具体的な手順は以下のとおりです：

    1. プライベート静的メソッド`dropTable()`を定義し、`Connection`オブジェクトをパラメータとして受け取り、`SQLException`例外をスローする可能性があることを宣言します。
    2. 接続の`createStatement()`メソッドを使用して`Statement`オブジェクトを作成し、`try-with-resources`ステートメント内でそのオブジェクトを使用してデータベース操作を実行します。
    3. 文字列変数`sql`を定義し、テーブルを削除するためのSQLステートメントをストレージします。
    4. `Statement`オブジェクトの`executeUpdate()`メソッドを使用して`sql`ステートメントを実行し、テーブルを削除します。
    5. コンソールにテーブル削除が成功したことを示すメッセージを出力します。

    **コード：**

    ```java
        private static void dropTable(Connection connection) throws SQLException {
            try (Statement statement = connection.createStatement()) {
                String sql = "DROP TABLE test_commonpool";
                statement.executeUpdate(sql);
                System.out.println("Table dropped successfully.");
            }
        }
    ```

9. `ConnectionFactory`クラスを定義します。

    `ConnectionFactory`という名前の静的内部クラスを定義します。このクラスは、`BasePooledObjectFactory`クラスを継承して、接続オブジェクトを作成と管理するためのメソッドを実現します。具体的な手順は以下のとおりです：

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p><code>@Override</code> は、メソッドが親クラスのメソッドをオーバーライドすることを示すアノテーションです。</p>
    </main>

    1. `ConnectionFactory`という名前の静的内部クラスを定義します。このクラスは、`org.apache.commons.pool2.BasePooledObjectFactory<Connection>`クラスを継承し、接続オブジェクトを作成と管理するためのファクトリクラスとして使用されます。
    2. プライベートな不変の文字列変数を定義し、データベースのURLをストレージします。
    3. プライベートな不変の文字列変数を定義し、データベースに接続するためのユーザー名をストレージします。
    4. プライベートな不変の文字列変数を定義し、データベースに接続するためのパスワードをストレージします。
    5. `ConnectionFactory`クラスのコンストラクターを定義し、クラスのメンバ変数`url`、`username`、`password`を初期化するために使用されます。コンストラクターは、データベースのURL、データベースに接続するユーザー名とパスワードの3つのパラメータを受け取り、これらのパラメータの値は対応するメンバ変数にそれぞれ代入します。このように、`ConnectionFactory`オブジェクトを作成するときに、コンストラクターを通じてデータベース関連の情報を渡すことができます。
    6. `BasePooledObjectFactory`クラスの`create()`メソッドをオーバーライドし、新しい接続オブジェクトを作成するために使用されます。
    7. `DriverManager`クラスの`getConnection()`メソッドを使用し、接続オブジェクトを作成して返します。
    8. `BasePooledObjectFactory`クラスの`destroyObject()`メソッドをオーバーライドし、接続オブジェクトを破棄するために使用されます。
    9. 接続オブジェクトの`close()`メソッドを呼び出して接続を閉じます。
    10. `BasePooledObjectFactory`クラスの`validateObject()`メソッドをオーバーライドし、接続オブジェクトの有効性を検証するために使用されます。
    11. 接続オブジェクトの`isValid()`メソッドを呼び出して接続が有効かどうかを確認し、タイムアウトを5000ミリ秒に設定します。
    12. `BasePooledObjectFactory`クラスの`wrap()`メソッドをオーバーライドし、接続オブジェクトを`PooledObject`オブジェクトにラップするために使用されます。
    13. `DefaultPooledObject`クラスのコンストラクターを使用して`PooledObject`オブジェクトを作成し、接続オブジェクトをパラメータとして渡します。

    **コード：**

    ```java
    static class ConnectionFactory extends org.apache.commons.pool2.BasePooledObjectFactory<Connection> {
            private final String url;
            private final String username;
            private final String password;

            public ConnectionFactory(String url, String username, String password) {
                this.url = url;
                this.username = username;
                this.password = password;
            }

            @Override
            public Connection create() throws Exception {
                return DriverManager.getConnection(url, username, password);
            }

            @Override
            public void destroyObject(org.apache.commons.pool2.PooledObject<Connection> p) throws Exception {
                p.getObject().close();
            }

            @Override
            public boolean validateObject(org.apache.commons.pool2.PooledObject<Connection> p) {
                try {
                    return p.getObject().isValid(5000);
                } catch (SQLException e) {
                    return false;
                }
            }

            @Override
            public PooledObject<Connection> wrap(Connection connection) {
                return new DefaultPooledObject<>(connection);
            }
        }
    ```

### 全コード表示

:::tab
tab pom.xml

```java
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.example</groupId>
    <artifactId>commonpool-mysql-client</artifactId>
    <version>1.0-SNAPSHOT</version>
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <source>8</source>
                    <target>8</target>
                </configuration>
            </plugin>
        </plugins>
    </build>

    <dependencies>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.40</version>
        </dependency>
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-pool2</artifactId>
            <version>2.7.0</version>
        </dependency>
    </dependencies>
</project>
```

tab db.properties

```java
# Database Configuration
db.url=jdbc:mysql://$host:$port/$database_name?useSSL=false
db.username=$user_name
db.password=$password

# Connection Pool Configuration
pool.maxTotal=10
pool.maxIdle=5
pool.minIdle=2
pool.maxWaitMillis=5000
```

tab Main.java

```java
package com.example;

import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Properties;

import org.apache.commons.pool2.ObjectPool;
import org.apache.commons.pool2.PoolUtils;
import org.apache.commons.pool2.PooledObject;
import org.apache.commons.pool2.impl.GenericObjectPool;
import org.apache.commons.pool2.impl.GenericObjectPoolConfig;
import org.apache.commons.pool2.impl.DefaultPooledObject;

public class Main {

    public static void main(String[] args) {
        // Load the database configuration file
        Properties props = new Properties();
        try {
            props.load(Main.class.getClassLoader().getResourceAsStream("db.properties"));
        } catch (IOException e) {
            e.printStackTrace();
        }

        // Create the database connection pool configuration
        GenericObjectPoolConfig<Connection> poolConfig = new GenericObjectPoolConfig<>();
        poolConfig.setMaxTotal(Integer.parseInt(props.getProperty("pool.maxTotal")));
        poolConfig.setMaxIdle(Integer.parseInt(props.getProperty("pool.maxIdle")));
        poolConfig.setMinIdle(Integer.parseInt(props.getProperty("pool.minIdle")));
        poolConfig.setMaxWaitMillis(Long.parseLong(props.getProperty("pool.maxWaitMillis")));

        // Create the database connection pool
        ObjectPool<Connection> connectionPool = PoolUtils.synchronizedPool(new GenericObjectPool<>(new ConnectionFactory(
                props.getProperty("db.url"), props.getProperty("db.username"), props.getProperty("db.password")), poolConfig));

        // Get a database connection
        try (Connection connection = connectionPool.borrowObject()) {

            // Create table
            createTable(connection);

            // Insert data
            insertData(connection);
            // Query data
            selectData(connection);

            // Update data
            updateData(connection);
            // Query the updated data
            selectData(connection);

            // Delete data
            deleteData(connection);
            // Query the data after deletion
            selectData(connection);

            // Drop table
            dropTable(connection);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private static void createTable(Connection connection) throws SQLException {
        try (Statement statement = connection.createStatement()) {
            String sql = "CREATE TABLE test_commonpool (id INT,name VARCHAR(20))";
            statement.executeUpdate(sql);
            System.out.println("Table created successfully.");
        }
    }

    private static void insertData(Connection connection) throws SQLException {
        try (Statement statement = connection.createStatement()) {
            String sql = "INSERT INTO test_commonpool (id, name) VALUES (1,'A1'), (2,'A2'), (3,'A3')";
            statement.executeUpdate(sql);
            System.out.println("Data inserted successfully.");
        }
    }

    private static void updateData(Connection connection) throws SQLException {
        try (Statement statement = connection.createStatement()) {
            String sql = "UPDATE test_commonpool SET name = 'A11' WHERE id = 1";
            statement.executeUpdate(sql);
            System.out.println("Data updated successfully.");
        }
    }

    private static void deleteData(Connection connection) throws SQLException {
        try (Statement statement = connection.createStatement()) {
            String sql = "DELETE FROM test_commonpool WHERE id = 2";
            statement.executeUpdate(sql);
            System.out.println("Data deleted successfully.");
        }
    }

    private static void selectData(Connection connection) throws SQLException {
        try (Statement statement = connection.createStatement()) {
            String sql = "SELECT * FROM test_commonpool";
            ResultSet resultSet = statement.executeQuery(sql);
            while (resultSet.next()) {
                int id = resultSet.getInt("id");
                String name = resultSet.getString("name");
                System.out.println("id: " + id + ", name: " + name);
            }
        }
    }

    private static void dropTable(Connection connection) throws SQLException {
        try (Statement statement = connection.createStatement()) {
            String sql = "DROP TABLE test_commonpool";
            statement.executeUpdate(sql);
            System.out.println("Table dropped successfully.");
        }
    }

    static class ConnectionFactory extends org.apache.commons.pool2.BasePooledObjectFactory<Connection> {
        private final String url;
        private final String username;
        private final String password;

        public ConnectionFactory(String url, String username, String password) {
            this.url = url;
            this.username = username;
            this.password = password;
        }

        @Override
        public Connection create() throws Exception {
            return DriverManager.getConnection(url, username, password);
        }

        @Override
        public void destroyObject(org.apache.commons.pool2.PooledObject<Connection> p) throws Exception {
            p.getObject().close();
        }

        @Override
        public boolean validateObject(org.apache.commons.pool2.PooledObject<Connection> p) {
            try {
                return p.getObject().isValid(5000);
            } catch (SQLException e) {
                return false;
            }
        }

        @Override
        public PooledObject<Connection> wrap(Connection connection) {
            return new DefaultPooledObject<>(connection);
        }
    }
}
```

:::

## 関連ドキュメント

MySQL Connector/Jの詳細については、[Overview of MySQL Connector/J](https://dev.mysql.com/doc/connector-j/en/connector-j-overview.html)を参照してください。
