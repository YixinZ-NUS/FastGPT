|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|

# トランザクションの開始

本記事では、OceanBaseデータベースで一般的に使用されるトランザクション開始ステートメントとその例を紹介します。

## トランザクションの開始

OceanBaseデータベースのMySQLモードにおけるトランザクション制御文は、MySQLデータベースと互換性があります。OceanBaseデータベースのMySQLモードでトランザクションを開始するには、以下の方法を使用します：

* `BEGIN` コマンドを実行する

  ```sql
  obclient [test]> BEGIN;      //トランザクションの開始
  obclient [test]> INSERT INTO table1 VALUES(1,1);
  obclient [test]> COMMIT;
  ```

* `START TRANSACTION` コマンドを実行する

  ```sql
  obclient [test]> START TRANSACTION; //トランザクションの開始
  obclient [test]> INSERT INTO table1 VALUES(1,1);
  obclient [test]> COMMIT;
  ```

* `autocommit = 0` を設定して（自動コミットをオフにする）、`INSERT`、`UPDATE`、`DELETE`、`SELECT FOR UPDATE` ステートメントを実行すると、システムは新しいトランザクションを開始します。

  ```sql
  obclient [test]> SET AUTOCOMMIT=0;
  obclient [test]> INSERT INTO table1 VALUES(1,1);  //トランザクションの開始
  obclient [test]> COMMIT;

  obclient [test]> SET AUTOCOMMIT=0;
  obclient [test]> UPDATE table1 SET id = 2 WHERE id = 1;  //トランザクションの開始
  obclient [test]> COMMIT;

  obclient [test]> SET AUTOCOMMIT=0;
  obclient [test]> DELETE FROM table1 WHERE id = 2;  //トランザクションの開始
  obclient [test]> COMMIT;

  obclient [test]> SET AUTOCOMMIT=0;
  obclient [test]> SELECT id FROM table1 WHERE id = 1 FOR UPDATE;  //トランザクションの開始
  obclient [test]> COMMIT;
  ```

トランザクションが開始されると、OceanBaseデータベースはトランザクションにトランザクションIDを割り当て、トランザクションを一意に識別します。

実際の運用において、複数の並行接続が同一のデータテーブルに対する操作を行う際に、2つのトランザクションが同じ行のデータに対する操作を行う可能性があります。クエリの読み取り操作では、`SELECT FOR UPDATE` ステートメントを使用してクエリ結果をロックすることで、他のDMLステートメントが該当レコードを同時に変更することを防ぐことができます。ステートメントの詳細な使用方法については、[クエリ結果のロックSELECT FOR UPDATE](../500.read-data-of-mysql-mode/300.use-operators-and-functions-in-query-of-mysql-mode/1000.lock-query-results-select-for-update-of-mysql-mode.md)を参照してください。

以下の例では、まず `SET autocommit=0` で自動コミット機能をオフにした後、`UPDATE` ステートメントを介してトランザクションを開始します。

```sql
obclient [test]> CREATE TABLE ordr(
id INT NOT NULL PRIMARY KEY,
name VARCHAR(10) NOT NULL,
value INT,
gmt_create DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP );
Query OK, 0 rows affected

obclient [test]>  INSERT INTO ordr(id, name, value)
VALUES (1,'CN',10001),(2,'US', 10002),(3,'EN', 10003);
Query OK, 3 rows affected
 Records: 3  Duplicates: 0  Warnings: 0

obclient [test]> SELECT * FROM ordr;
+----+------+-------+---------------------+
| id | name | value | gmt_create          |
+----+------+-------+---------------------+
|  1 | CN   | 10001 | 2022-10-19 14:51:12 |
|  2 | US   | 10002 | 2022-10-19 14:51:12 |
|  3 | EN   | 10003 | 2022-10-19 14:51:12 |
+----+------+-------+---------------------+
2 rows in set

obclient [test]> SET autocommit=0;
Query OK, 0 rows affected

obclient [test]> UPDATE ordr SET id=4 WHERE name='US';
Query OK, 1 row affected
Rows matched: 1  Changed: 1  Warnings: 0
```

実行が成功したら、`oceanbase.V$OB_TRANSACTION_PARTICIPANTS` を使用して、アクティブなトランザクションの参加者情報をクエリすることができます。

```sql
obclient [test]> SELECT * FROM oceanbase.V$OB_TRANSACTION_PARTICIPANTS;
*************************** 1. row ***************************
       TENANT_ID: 1002
          SVR_IP: xx.xx.xx.223
        SVR_PORT: 2882
      SESSION_ID: 3221487660
  SCHEDULER_ADDR: "xx.xx.xx.223:2882"
         TX_TYPE: UNDECIDED
           TX_ID: 110352
           LS_ID: 1001
    PARTICIPANTS: NULL
 CTX_CREATE_TIME: 2022-10-19 14:55:23.763474
 TX_EXPIRED_TIME: 2022-10-19 14:55:23.763474
           STATE: ACTIVE
          ACTION: START
PENDING_LOG_SIZE: 116
FLUSHED_LOG_SIZE: 0
            ROLE: LEADER
1 row in set
```

ビュー `oceanbase.V$OB_TRANSACTION_PARTICIPANTS` のフィールドと詳細については、[oceanbase.V$OB_TRANSACTION_PARTICIPANTS](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001973476)を参照してください。

## 関連ドキュメント

* [トランザクションのセーブポイント](300.transaction-savepoints-of-mysql-mode/100.mark-a-savepoint-of-mysql-mode.md)

* [トランザクションのコミット](../600.transaction-in-develop-of-mysql-mode/400.submit-transaction-of-mysql-mode.md)

* [トランザクションのロールバック](../600.transaction-in-develop-of-mysql-mode/500.roll-back-transactions-of-mysql-mode.md)
