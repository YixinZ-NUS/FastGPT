|description|本記事では、SQLAlchemyを使用してOceanBaseデータベースに接続し、テーブルの作成、データの挿入、更新、クエリといった基本的な操作を実行する方法について説明します。|
|---|---|
|keywords|SQLAlchemy、Python、OceanBase、データベース接続、ORM、MySQLモード|
|dir-name|SQLAlchemy|
|dir-name-en||
|tenant-type|MySQL Mode|

# SQLAlchemy

本記事では、SQLAlchemyを使用してOceanBaseデータベースに接続し、テーブルの作成、データの挿入、更新、クエリなどの基本的なデータベース操作を行う方法について紹介します。

## 前提条件

* Python 3.xとpipがインストール済みであること。
* OceanBaseデータベースをインストール済みで、MySQLモードのテナントが作成されていること。

## 操作手順

1. OceanBaseデータベースの接続文字列を取得します。
2. SQLAlchemyライブラリをインストールします。
3. `test.py` ファイルを作成し、データベース接続情報を入力します。
4. `test.py` ファイルを実行します。

### ステップ１：OceanBaseデータベースの接続文字列を取得する

OceanBaseデータベースのデプロイ担当者または管理者から、該当するデータベース接続文字列を取得します。

```shell
obclient -h$host -P$port -u$user_name -p$password -D$database_name
```

**パラメータの説明：**

* `$host`：OceanBaseデータベースへの接続IPアドレス。OceanBaseデータベースプロキシ(OceanBase Database Proxy、ODP)接続方式ではODPアドレスを使用し、直接接続方式ではOBServerノードのIPアドレスを使用します。
* `$port`：OceanBaseデータベースへの接続ポート。ODP接続方式のデフォルトポートは`2883`で、ODPデプロイ時にカスタマイズ可能です。直接接続方式のデフォルトポートは`2881`で、OceanBaseデータベースのデプロイ時にカスタマイズ可能です。
* `$database_name`：アクセス対象のデータベース名。

    <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>接続するテナントのユーザーには、データベースに対する <code>CREATE</code>、<code>INSERT</code>、<code>UPDATE</code> および <code>SELECT</code> の権限が付与されていなければなりません。その他のユーザー権限の詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974111">MySQLモードの権限分類</a>を参照してください。</p>
    </main>

* `$user_name`：テナントの接続アカウント。ODP接続の一般的な形式：`ユーザー名@テナント名#クラスタ名`または`クラスタ名:テナント名:ユーザー名`。直接接続方式の形式：`ユーザー名@テナント名`。
* `$password`：アカウントのパスワード。

その他の接続文字列に関する詳細は、[OBClientを使用したOceanBaseテナントへの接続](../../100.connect-to-oceanbase-database-of-mysql-mode/300.connect-to-an-oceanbase-tenant-by-using-obclient-of-mysql-mode.md)を参照してください。

**例：**

```shell
obclient -hxxx.xxx.xxx.xxx -P2881 -utest_user001@mysql001 -p****** -Dtest
```

### ステップ2：SQLAlchemyライブラリをインストールする

SQLAlchemyはPythonで最も広く使われているORM（オブジェクト関係マッピング）ライブラリの一つであり、SQLツールキットとORMシステムを提供し、データベース操作を簡素化できます。SQLAlchemyは、MySQL、PostgreSQL、SQLiteなど、さまざまなデータベースのバックエンドをサポートしています。

コマンドプロンプトまたはPowerShellターミナルを開き、以下のコマンドを実行してSQLAlchemyライブラリをインストールします。

```shell
pip install sqlalchemy mysqlclient
```

インストールが完了したら、以下のコマンドを実行してインストールが正常に完了したかどうかを確認します：

```shell
pip list | grep SQLAlchemy
```

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>SQLAlchemyは多機能ORMライブラリであり、2つの使用方法を提供しています：CoreとORM。CoreはSQL言語を提供し、ORMはオブジェクト関係マッピング機能を提供します。本記事の例は主にORMの方法を使用しています。</p>
</main>

### ステップ3：test.pyファイルを作成し、データベース接続情報を入力する

**ステップ１：OceanBaseデータベースの接続文字列を取得する** に記載されている情報に基づいて、`test.py`ファイルを作成して、データベース接続情報を入力します。

1. `test.py` という名前のファイルを作成します。

2. `test.py` ファイルに以下の内容を入力し、実際の状況に応じてデータベース接続情報を修正します。

   **`test.py` ファイルの内容例を以下に示します：**

   ```python
   from sqlalchemy import create_engine, Column, Integer, String, MetaData, Table
   from sqlalchemy.ext.declarative import declarative_base
   from sqlalchemy.orm import sessionmaker

   # データベース接続情報
   DB_USER = 'test_user001@mysql001'
   DB_PASSWORD = '******'
   DB_HOST = 'xxx.xxx.xxx.xxx'
   DB_PORT = 2881
   DB_NAME = 'test'

   # データベース接続URLの作成
   DATABASE_URL = f"mysql+mysqldb://{DB_USER}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_NAME}"

   # エンジンの作成
   engine = create_engine(DATABASE_URL)

   # 基底クラスの作成
   Base = declarative_base()

   # モデルの定義
   class User(Base):
       __tablename__ = 'users'

       id = Column(Integer, primary_key=True)
       name = Column(String(50), nullable=False)
       age = Column(Integer)

       def __repr__(self):
           return f"<User(id={self.id}, name='{self.name}', age={self.age})>"

   # テーブルの作成
   Base.metadata.create_all(engine)

   # セッションの作成
   Session = sessionmaker(bind=engine)
   session = Session()

   # データの挿入
   new_users = [
       User(name='John', age=20),
       User(name='Lucy', age=25),
       User(name='Tom', age=30)
   ]
   session.add_all(new_users)
   session.commit()

   # データの更新
   user = session.query(User).filter_by(name='Lucy').first()
   if user:
       user.age = 26
       session.commit()

   # データのクエリ
   users = session.query(User).all()
   for user in users:
       print(user)

   # セッションを閉じる
   session.close()
   ```

### ステップ4：test.pyファイルを実行する

コマンドプロンプトまたはPowerShellターミナルを開き、`test.py` ファイルを実行して、データをクエリし、結果を出力します。

1. `test.py` ファイルがあるディレクトリに移動します。

    **例：**

    ```shell
    cd D:\demo\demo
    ```

2. `test.py` ファイルを実行します。

    **例：**

    ```shell
    python test.py
    ```

    実行結果は次のとおりです：

    ```shell
    <User(id=1, name='John', age=20)>
    <User(id=2, name='Lucy', age=26)>
    <User(id=3, name='Tom', age=30)>
    ```

## エラー処理

SQLAlchemyを使用してOceanBaseデータベースに接続する際、さまざまなエラーが発生する可能性があります。以下は、一般的なエラーとその処理方法です：

1. **接続エラー**：データベースに接続できない場合は、ホスト名、ポート、ユーザー名、パスワード、データベース名を含む接続パラメータが正しいかどうか確認してください。

2. **権限エラー**：権限に関連するエラーが発生した場合は、ユーザーが必要な操作を実行するために十分な権限を持っていることを確認してください。

3. **SQL構文エラー**：SQLステートメントに構文エラーがある場合は、SQLステートメントの構文が正しいかどうか確認してください。

4. **データ型エラー**：挿入したデータ型がテーブルの定義とマッチしない場合は、挿入したデータ型が正しいことを確認してください。

コード内で `try-except` ステートメントを使用してこれらのエラーをキャッチし、処理することで、エラー発生時にプログラムがクラッシュすることなく適切に対処できるようにします。同時に、`logging` モジュールを使用してエラー情報を記録することで、デバッグや問題のトラブルシューティングを容易にします。

## 関連ドキュメント

* OceanBaseデータベースに接続するための詳細情報については、[接続方法の概要](../../100.connect-to-oceanbase-database-of-mysql-mode/100.connection-methods-overview-of-mysql-mode.md)を参照してください。

* データベースの作成に関する詳細については、[CREATE DATABASE](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974111)を参照してください。
