|description||
|---|---|
|keywords||
|dir-name|Go-SQL-Driver/MySQL|
|dir-name-en||
|tenant-type|MySQL Mode|

# Go-SQL-Driver/MySQL

本記事では、Go-SQL-Driver/MySQLドライバーとOceanBaseデータベースを使用してアプリケーションを構築し、テーブルの作成、データの挿入、クエリなどの基本的な操作を実行する方法を紹介します。

<div role="videolist">
      <a role='link' href='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/Go/go-oceanbase.zip'>
          <img src='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/download.png'/>
          クリックしてgo-oceanbaseサンプルプロジェクトをダウンロードします
      </a>
      <!-- <a role='video' href='https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/video-center/video/video/05%20go-ob_e05.mp4'>
          <img src='https://mdn.alipayobjects.com/huamei_22khvb/afts/img/A*DFPmToHK6hgAAAAAAAAAAAAADiGDAQ/original'/>
          Go-SQL-Driver/MySQLによりOceanBaseデータベースに接続するサンプルプログラム
       </a> -->
</div>

## 前提条件

OceanBaseデータベース、Go言語、および関連するドライバーをインストールし、環境変数が正しく設定されていること。

* OceanBaseデータベースがインストールされていること
* Go言語がインストールされていること
* Go-SQL-Driver/MySQLドライバーがインストールされていること

## 操作手順

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>本記事で示されている操作手順は、Windows環境で生成されたものです。他のOS環境やコンパイラを使用している場合は、操作手順が若干異なる場合があります。 </p>
</main>

1. （オプション）Go言語とドライバーをインストールします。
2. OceanBaseデータベース接続情報を取得します。
3. `go-oceanbase` プロジェクトのデータベース接続情報を修正します。
4. `go-oceanbase` プロジェクトを実行します。

### ステップ１：（オプション）Go言語とドライバーをインストールする

Go言語とGo-SQL-Driver/MySQLドライバーがインストール済みの場合は、この手順はスキップできます。インストールされていない場合は、以下の手順に従ってインストールすることができます。

1. Go言語をインストールする

    1. Go言語のインストールパッケージをダウンロードします：[Go公式Webサイト](https://golang.org/dl/) から、ご自身のOSに適したインストールパッケージをダウンロードできます。

        <main id="notice" type='explain'>
         <h4>説明</h4>
         <p>この記事で使用するGoインストールパッケージの名前はgo1.20.6.windows-amd64.msiです。</p>
        </main>

    2. Go言語をインストールします：ダウンロードしたインストールパッケージをダブルクリックし、指示に従ってインストールします。

    3. 環境変数を設定します：Go言語のインストールパスをシステムのPATH環境変数に追加します。
       * Windows環境では、**コントロールパネル > システムとセキュリティ > システム > システムの詳細設定 > 環境変数 > システム変数** で、Pathの値 `C:\usr\local\go\bin` を追加できます。
       * LinuxまたはmacOS環境では、`~/.bashrc` または `~/.bash_profile` ファイルを編集し、以下の内容を追加します：

            ```shell
            export PATH=$PATH:/usr/local/go/bin
            ```

        <main id="notice" type='explain'>
         <h4>説明</h4>
         <p><code>\usr\local\go\bin</code> はデフォルトのインストールディレクトリです。Go言語のインストール時にインストールディレクトリを変更した場合は、対応するディレクトリに置き換えてください。</p>
        </main>

    4. インストールの検証：Shellコマンドラインで以下のコマンドを入力して、Go言語のバージョン情報を確認し、インストールが成功したかどうかを検証します：

        ```shell
        C:\Users\admin\> go version
        go version go1.20.6 windows/amd64
        ```

2. Go-SQL-Driver/MySQLドライバーをインストールする

    Go言語のバージョンに応じて、異なるインストール方法を選択できます。Go-SQL-Driver/MySQLドライバーをインストールする際は、対応するプロジェクトディレクトリに移動して、コマンドラインターミナルを開く必要があります。`Go-SQL-Driver/MySQL` の詳細については、[Github](https://github.com/go-sql-driver/mysql)を参照してください。

    インストールコマンドは以下のとおりです：

    ```shell
    C:\Users\admin\Desktop\go-oceanbase>go get -u github.com/go-sql-driver/mysql
    go: downloading github.com/go-sql-driver/mysql v1.7.1
    go: added github.com/go-sql-driver/mysql v1.7.1
    ```

    バージョンまたはネットワークの問題により、`go get` コマンドでインストールできない場合は、`go install` コマンドを使用して `go-sql-driver/mysql` をインストールできます。

   1. githubの `go-sql-driver/mysql` リポジトリを `go/src` ディレクトリにクローンします。

        ```bash
        cd /usr/local/go/src
        git clone https://github.com/go-sql-driver/mysql.git
        ```

        <main id="notice" type='notice'>
            <h4>注意</h4>
            <p><code>/usr/local/go/src</code> をGoの実際のインストールディレクトリに置き換える必要があります。</p>
        </main>

   2. `go install` コマンドを使用してインストールします。

        ```bash
        go install mysql
        ```

        <main id="notice" type='notice'>
            <h4>注意</h4>
            <p>一部のバージョンの <code>go install</code> では、デフォルトの実行ディレクトリが <code>/src</code> でない場合があります。<code>go install</code> の実行結果のエラーメッセージから、実際のディレクトリを確認することができます。例えば、エラーメッセージ <code>cannot find package &quot;mysql&quot; in: /usr/local/go/src/vendor/mysql</code> の場合は、mysqlフォルダを <code>/src/vendor</code> ディレクトリに配置してからインストールコマンドを実行する必要があります。</p>
        </main>

   3. Go-SQL-Driver/MySQLドライバーがインストールされているか確認します。インストールに失敗した場合は、エラーメッセージに従って修正してください。

        ```bash
        go list -m github.com/go-sql-driver/mysql
        ```

### ステップ2：OceanBaseデータベース接続情報を取得する

OceanBaseデータベースのデプロイ担当者または管理者に連絡して、該当するデータベース接続文字列を取得します。

```sql
obclient  -h{host} -u{username} -p****** -P{port} -D{schema_name}
```

データベース接続文字列には、データベースへのアクセスに必要なパラメータ情報が含まれています。この接続文字列を使用して、データベースへのログインを検証し、接続文字列のパラメータ情報が正しいことを確認できます。

<main id="notice" type='explain'>
 <h4>説明</h4>
 <p><code>test.go</code> ファイルには、このURL情報が必要です。</p>
</main>

**パラメータの説明：**

* `host`：OceanBaseデータベースへの接続IPアドレス。ODP接続方式ではODPアドレスを使用し、直接接続方式ではOBServerノードのIPアドレスを使用します。
* `user_name`：テナントの接続アカウント。ODP接続の一般的な形式：`ユーザー名@テナント名#クラスタ名`または`クラスタ名:テナント名:ユーザー名`。直接接続方式の形式：`ユーザー名@テナント名`。
* `password`：アカウントのパスワード。
* `port`：OceanBaseデータベースの接続ポートを提供します。ODP接続方式のデフォルトポートは `2883` で、ODPデプロイ時にカスタマイズすることができます。直接接続方式のデフォルトポートは `2881` で、OceanBaseデータベースのデプロイ時にカスタマイズすることができます。
* `schema_name`：アクセスするスキーマ名です。

### ステップ3： `go-oceanbase` プロジェクトのデータベース接続情報を修正する

**ステップ2：OceanBaseデータベース接続情報を取得する** に記載されている情報に基づいて、`test.go` ファイル内のデータベース接続情報を修正します。`test.go` ファイルを選択し、右クリックして **開く方法** を選択すると、**メモ帳** またはその他のエディタで開くことができます。

![test.go](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/Go/testgo.jpg)

**例：**

* OBServerノードのIPアドレスは `10.10.10.1` です。
* アクセスポートは2881を使用します。
* アクセスするスキーマ名は `test` です。
* テナントの接続アカウントは `root@mysql` です。`root@mysql` はOceanBaseデータベースで作成されたMySQLモデルのユーザーテナントであり、`test` はテナント `root@mysql` のユーザー名です。
* パスワードは `******` です。

**サンプルコードは以下のとおりです：**

```go
conn := "root@mysql:******@tcp(10.10.10.1:2881)/test"
```

### ステップ4：`go-oceanbase` プロジェクトを実行する

コードの編集が完了したら、プロジェクトディレクトリでコマンドラインターミナルを開き、`go run` でGoファイルを以下のとおり実行します：

```shell
C:\Users\admin\Desktop\go-oceanbase>go run test.go
```

（オプション）LinuxまたはmacOS環境では、一時的な環境変数を設定してからでないと `go run` を実行できません。

```shell
export PATH=$PATH:/usr/local/go/bin
go run test.go
```

実行後、以下の内容が返された場合は、データベースへの接続に成功し、サンプルステートメントが正しく実行されたことを意味します：

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>この内容は、「テーブルt1の削除」を実行した後の結果をマスクしたものです。 </p>
</main>

```shell
C:\Users\admin\Desktop\go-oceanbase>go run test.go
success to connect OceanBase with go_mysql driver
Hello OceanBase
```

## プロジェクトコードについて

[go-oceanbase](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/Go/go-oceanbase.zip) をクリックしてプロジェクトコードをダウンロードします。`go-oceanbase` という名前の圧縮ファイルです。

解凍すると、`go-oceanbase` という名前のフォルダが作成されます。ディレクトリ構造は以下のとおりです：

```go
|-- go.mod
|-- go.sum
|-- test.go
```

**ファイルの説明：**

* `go.mod`：Go言語のモジュールファイルは、プロジェクトのモジュール依存関係とバージョン情報を定義するために使用されます。
* `go.sum`：Go V1.11以降のバージョンで追加されたモジュール管理ファイルであり、プロジェクトの依存モジュールとそのバージョン情報、および対応するチェックサム（Checksum）を記録するために使用されます。
* `test.go`： Goのソースコードファイルで、プロジェクトのサンプルコードが含まれています。

### go.modのコードの紹介

`go.mod` ファイルは、プロジェクトのモジュール名、Goのバージョン番号、および依存関係に関する宣言を定義するために使用されます。

`go.mod` ファイルには、以下の内容が含まれています：

* `module go-oceanbase`：これはプロジェクトのモジュール名であり、プロジェクトのネームスペースを定義しています。Go 1.16以降では、モジュール名とプロジェクトのルートディレクトリ名がマッチしている必要があります。
* `go 1.20`：これはプロジェクトに必要なGoのバージョンです。
* `require github.com/go-sql-driver/mysql v1.7.1 // indirect`：これはプロジェクトの依存関係宣言です。それはプロジェクトに必要な `github.com/go-sql-driver/mysql` モジュールのバージョンをV1.7.1に指定し、その依存関係が間接的な依存関係であり、別の依存関係である `go.sum` と関連付けられています。

### go.sumのコードの紹介

`go.sum` ファイルは、`github.com/go-sql-driver/mysql` の依存関係のバージョン情報を定義するために使用され、プロジェクトが正しい依存関係のバージョンを使用することを保証します。

`go.sum` ファイルには、以下の内容が含まれています：

* `github.com/go-sql-driver/mysql v1.7.1 h1:lUIinVbN1DY0xBg0eMOzmmtGoHwWBbvnWubQUrtU8EI=`
  モジュールのソースコードファイルのハッシュ値であり、プロジェクトをビルドする際に正しいバージョンが使用されていることを保証します。ここでのハッシュ値は `lUIinVbN1DY0xBg0eMOzmmtGoHwWBbvnWubQUrtU8EI=` です。
* `github.com/go-sql-driver/mysql v1.7.1/go.mod h1:OXbVy3sEdcQ2Doequ6Z5BW6fXNQTmx+9S1MCJN5yJMI=`
  モジュールの依存関係ファイルのハッシュ値であり、プロジェクトをビルドする際に正しい依存関係のバージョンが使用されていることを保証します。ここでのハッシュ値は `OXbVy3sEdcQ2Doequ6Z5BW6fXNQTmx+9S1MCJN5yJMI=` です。

### test.goのコードの紹介

`test.go` ファイルは、Go言語とOceanBaseデータベースのMySQLモードを使用して、データベースへの接続、テーブルの作成、データの挿入、データのクエリ、テーブルの削除などの操作を含むインタラクションする方法を定義しています。
`test.go` ファイルには、以下の内容が含まれています：

1. `main` パッケージを定義します。
     `package main` は、実行可能なプログラムのパッケージであることを示します。このパッケージには `main()` 関数が含まれており、プログラムの実行時にこの関数が実行されます。

2. `import` パッケージを定義します。

    `import` ステートメントで、以下の4つのパッケージをインポートしています：

    * `database/sql`：汎用のSQLデータベースアクセスインターフェースを提供するために使用されます。それは、さまざまな種類のSQLデータベースに接続し操作するための汎用のインターフェースと関数のセットを定義しています。
    * `fmt`：フォーマットされた入出力の提供に使用される関数です。これは、データを文字列形式にフォーマットしてコンソールやその他のデバイスに出力するための一連の関数を定義しています。
    * `log`：レコードログを提供するための関数です。それは、ログ情報をコンソールや他のデバイスに出力するための一連の関数を定義しています。
    * `github.com/go-sql-driver/mysql`：MySQLモードを提供するためのドライバーです。それは `database/sql` パッケージで定義されたインターフェースを実装しており、Go言語でMySQLモードに接続して操作できるようになっています。ここでは正しい `go-sql-driver/mysql` のインストールパスを記入する必要があります。

    **コードは以下のとおりです：**

    ```go
    import (
    "database/sql"
    "fmt"
    "log"

    _ "github.com/go-sql-driver/mysql"
    // go-sql-driver/mysqlのインストールパスを記入してください。
    )
    ```

3. `Str` 構造体を定義します。
   フィールド `Name` を含み、クエリ結果をストレージするために使用されます；`main()` 関数が定義されており、その中に `selectAll()` 関数が含まれていて、テーブルの作成、データの挿入、データのクエリ、テーブルの削除などの操作を完了するために使用されます。

    **コードは以下のとおりです：**

    ```go
    type Str struct {
    Name string
    }

    func main() {
    selectAll()
    }
    ````

4. `selectAll()` 関数を定義します。

    `selectAll()` 関数は、データベースへの接続、テーブルの作成、データの挿入、データのクエリ、テーブルの削除などの操作を含んでいます。

    1. データベースに接続します。
       接続文字列 `conn` を定義し、ユーザー名、パスワード、IPアドレス、ポート番号、データベース名などの情報を含むMySQLモードの接続パラメータが含まれています。`sql.Open()` 関数を呼び出してデータベース接続を開き、エラーが発生した場合はログを記録してプログラムを終了します。`defer` キーワードを使用してデータベース接続のクローズを遅延させ、関数の終了時に接続が閉じられることを保証します。

        **コードは以下のとおりです：**

        ```go
        conn := "user_name:******@tcp(host:port)/schema_name"
        // データベース接続パラメータ

        db, err := sql.Open("mysql", conn)
        if err != nil {
            log.Fatal(err)
        }
        ```

    2. コンソールにメッセージを出力します。
       `defer` キーワードを使用して `db.Close()` 関数の実行を遅延させ、関数の終了時にデータベース接続を閉じることを保証します。`fmt.Printf()` 関数を使用して、接続成功のメッセージをコンソールに出力します。

        **コードは以下のとおりです：**

        ```go
        defer db.Close()

        if err != nil {
            log.Fatal(err)
        }

        fmt.Printf("success to connect OceanBase with go_mysql driver\n")
        ```

    3. データを作成します。
       `t1` という名前のテーブルを作成し、長さ `256` の文字列タイプのフィールド `str` を設定しました。

        **コードは以下のとおりです：**

        ```go
            _, err = db.Query("create table t1(str varchar(256))")
        if err != nil {
            log.Fatal(err)
        }
        ```

    4. データを挿入します。
       テーブル `t1` に1行のデータを挿入し、その行データの `str` フィールドの値を `Hello OceanBase` に設定します。

        **コードは以下のとおりです：**

        ```go
        _, err = db.Query("insert into t1 values ('Hello OceanBase')")
        if err != nil {
            log.Fatal(err)
        }
        ```

    5. データをクエリします。
       テーブル `t1` のすべてのデータをクエリし、クエリ結果を変数 `res` に代入します。クエリが失敗した場合、エラーメッセージを返します。

        **コードは以下のとおりです：**

        ```go
        res, err := db.Query("SELECT * FROM t1")
        if err != nil {
            log.Fatal(err)
        }
        defer res.Close()

        for res.Next() {
            var str Str
            res.Scan(&str.Name)
            fmt.Printf("%s\n", str.Name)
        }
        ```

    6. データを削除します。
       テーブル `t1` を削除します。削除に失敗した場合は、エラーメッセージを返します。

        **コードは以下のとおりです：**

        ```go
        _, err = db.Query("drop table t1")
        if err != nil {
            log.Fatal(err)
        }
        ```

### 全コード表示

:::tab

tab go.mod

```go
module go-oceanbase
go 1.20
require github.com/go-sql-driver/mysql v1.7.1 // indirect
```

tab go.sum

```go
github.com/go-sql-driver/mysql v1.7.1 h1:lUIinVbN1DY0xBg0eMOzmmtGoHwWBbvnWubQUrtU8EI=
github.com/go-sql-driver/mysql v1.7.1/go.mod h1:OXbVy3sEdcQ2Doequ6Z5BW6fXNQTmx+9S1MCJN5yJMI=
```

tab test.go

```go
    package main

    import (
    "database/sql"
    "fmt"
    "log"

    _ "github.com/go-sql-driver/mysql"
    // go-sql-driver/mysqlのインストールパスを記入してください。
    )

    type Str struct {
    Name string
    }

    func main() {
    selectAll()
    }

    func selectAll() {
    conn := "user_name:******@tcp(host:port)/schema_name"
    // データベース接続パラメータ

    db, err := sql.Open("mysql", conn)
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    if err != nil {
        log.Fatal(err)
    }

    fmt.Printf("success to connect OceanBase with go_mysql driver\n")
    // テーブルt1の作成
    _, err = db.Query("create table t1(str varchar(256))")
    if err != nil {
        log.Fatal(err)
    }

    // データの挿入
    _, err = db.Query("insert into t1 values ('Hello OceanBase')")
    if err != nil {
        log.Fatal(err)
    }

    // データのクエリ
    res, err := db.Query("SELECT * FROM t1")
    if err != nil {
        log.Fatal(err)
    }
    defer res.Close()

    for res.Next() {
        var str Str
        res.Scan(&str.Name)
        fmt.Printf("%s\n", str.Name)
    }

    // テーブルt1の削除
    _, err = db.Query("drop table t1")
    if err != nil {
        log.Fatal(err)
    }
    }
```

:::

## 関連ドキュメント

Go-SQL-Driver/MySQLに関する情報は、OceanBaseデータベースのオープンソースコミュニティにも掲載されています。詳細については、[Go-SQL-Driver/MySQL](https://github.com/go-sql-driver/mysql#installation)を参照してください。
