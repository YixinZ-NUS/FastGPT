|description|本記事では、ActiveRecordを使用してOceanBaseデータベースに接続し、テーブルの作成、データの挿入、クエリなどの基本的な操作を実行する方法を紹介します。|
|---|---|
|keywords|Ruby、ActiveRecord、OceanBase、データベース接続、MySQLモード|
|dir-name|activerecord|
|dir-name-en||
|tenant-type|MySQL Mode|

# ActiveRecord

本記事では、ActiveRecordとOceanBaseデータベースを使用してアプリケーションを構築し、テーブルの作成、データの挿入、クエリなどの基本的な操作を実行する方法を紹介します。

## 前提条件

* RubyとRubyGemsがインストール済みであること。
* OceanBaseデータベースがインストール済みで、MySQLモードのテナントが作成されていること。

## 操作手順

1. RubyとRubyGemsのバージョンを確認する
2. 必要なgemをインストールする
3. OceanBaseデータベース接続情報を取得する
4. Railsアプリケーションを作成して設定する
5. サンプルプログラムを実行する

### ステップ１：RubyとRubyGemsのバージョンを確認する

ターミナルを開き、以下のコマンドを実行してRubyとRubyGemsのバージョンを確認します：

```shell
ruby -v
gem -v
```

### ステップ2：必要なgemをインストールする

1. システム依存関係のインストール（Ubuntuを例として）：

    ```shell
    sudo apt-get install ruby-dev mysql-client libmysqlclient-dev
    ```

2. RVM（Ruby Version Manager）を使用する場合：

    ```shell
    rvm requirements
    ```

3. rbenvを使用する場合：

    ```shell
    rbenv install -l  # 利用可能なバージョンを確認する
    rbenv install x.x.x  # 特定のバージョンをインストールする
    rbenv global x.x.x  # グローバルバージョンを設定する
    ```

4. `gem` を使用してActiveRecordとmysql2をインストールします：

    ```shell
    gem install activerecord mysql2
    ```

### ステップ3：OceanBaseデータベース接続情報を取得する

OceanBaseデータベースのデプロイ担当者または管理者から、該当するデータベース接続文字列を取得します。

```shell
mysql -h$host -P$port -u$user_name -p$password -D$database_name
```

**パラメータの説明：**

* `$host`：OceanBaseデータベースへの接続IPアドレスを提供する
* `$port`：OceanBaseデータベース接続ポートを提供する
* `$database_name`：アクセスするデータベースの名前
* `$user_name`：テナントの接続アカウントを提供する
* `$password`：アカウントのパスワードを提供する

### ステップ4：Railsアプリケーションを作成して設定する

1. 新しいRailsアプリケーションを作成します：

    ```shell
    rails new activerecord_oceanbase -d mysql
    ```

2. データベース接続情報を設定します：

    `config/database.yml` に以下の設定を追加します：

    ```yaml
    development:
      adapter: mysql2
      encoding: utf8mb4
      database: your_database
      username: your_username
      password: your_password
      host: your_host
      port: your_port
    ```

3. サンプルモデルを作成します：

    ```ruby
    # app/models/user.rb
    class User < ActiveRecord::Base
      validates :name, presence: true
    end
    ```

### ステップ5：サンプルプログラムを実行する

1. データベーステーブルを作成します：

    ```ruby
    # db/migrate/20230520_create_users.rb
    class CreateUsers < ActiveRecord::Migration[6.1]
      def change
        create_table :users do |t|
          t.string :name
          t.timestamps
        end
      end
    end
    ```

2. 移行を実行します：

    ```shell
    rails db:migrate
    ```

3. Railsコンソールでテストします：

    ```shell
    rails c
    ```

    ```ruby
    # レコードの作成
    user = User.create(name: "John Doe")
    ```

    ```ruby
    # レコードのクエリ
    users = User.all
    ```

## よくある質問

1. **接続エラー**：データベースに接続できない場合は、次のことを確認してください：
   * データベースのアドレスとポートが正しいかどうか
   * ユーザー名とパスワードが正しいかどうか
   * ネットワークが正常に接続されているかどうか

2. **権限エラー**：権限に関連するエラーが発生した場合は、ユーザーが必要な操作を実行するために十分な権限を持っていることを確認してください。

3. **SQL構文エラー**：SQLステートメントに構文エラーがある場合、SQLステートメントの構文が正しいかどうか確認してください。

## パフォーマンス最適化の推奨事項

1. ActiveRecordのバッチ操作メソッド（例えば `insert_all`）を使用する
2. 事前読み込み（preload）を使用してN+1クエリ問題を回避する
3. キャッシュを適切に利用する
4. データベースのインデックスを最適化する
