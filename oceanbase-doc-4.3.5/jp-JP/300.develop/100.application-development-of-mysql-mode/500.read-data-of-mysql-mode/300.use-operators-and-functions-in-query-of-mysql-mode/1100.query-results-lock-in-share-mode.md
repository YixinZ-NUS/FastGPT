|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|

# クエリ結果のロック LOCK IN SHARE MODE

`SELECT ... LOCK IN SHARE MODE` は、データをクエリする際に共有ロックを取得し、他のトランザクションによるデータの書き込み操作を防ぎますが、他のトランザクションによるデータの読み取り操作は許可されます。このステートメントを使用する際、読み取られたデータ行に共有モードのロックが設定されます。他のセッションはこれらの行を読み取ることができますが、現在のトランザクションがコミットされるまで、他のトランザクションはそれを変更することができません。

<main id="notice" type='notice'>
<h4>注意</h4>
<p>OceanBaseデータベースは <code>LOCK IN SHARE MODE</code> 共有ロック構文の機能をシミュレートし、書き込みロックを使用して実現しています。これにより、いくつかのソフトウェアの互換性の要件を満たしつつ、構文の正確性を保証します。書き込みロックを使用すると、<code>LOCK IN SHARE MODE</code> コマンドを追加した読み取り操作が相互にブロックされるため、一般的にはこの構文の使用は推奨されません。特に性能に敏感なシーンでは、使用を避けるべきです。</p>
</main>

本記事では、例を通じて `SELECT ... LOCK IN SHARE MODE` を使用してクエリ結果をロックする方法を紹介します。

## 例

1. **セッション1** で、以下のSQLステートメントを実行してトランザクションを開始します。

    ```sql
    START TRANSACTION;
    ```

2. **セッション1** では、`test_tbl1` テーブルの `id` 値が `1` のレコードに対して `LOCK IN SHARE MODE` 構文を使用してクエリを実行し、共有ロックを取得します。

    ```sql
    SELECT * FROM test_tbl1 WHERE id = 1 LOCK IN SHARE MODE;
    ```

    実行結果は次のとおりです：

    ```shell
    +------+------+
    | id   | name |
    +------+------+
    |    1 | A1   |
    +------+------+
    1 row in set
    ```

3. **セッション2** で、以下のSQLステートメントを実行してトランザクションを開始します。

    ```sql
    START TRANSACTION;
    ```

4. **セッション2** で、次のSQLステートメントを実行して、テーブル `test_tbl1` の `id` 値が `1` のレコードをクエリします。

    ```sql
    SELECT * FROM test_tbl1 WHERE id = 1;
    ```

    実行結果は次のとおりです：

    ```shell
    +------+------+
    | id   | name |
    +------+------+
    |    1 | A1   |
    +------+------+
    1 row in set
    ```

5. **セッション2** で、次のSQLステートメントを実行して、テーブル `test_tbl1` の `id` 値が `1` に等しい行の対応するnameのを 'A1A1A1' に変更します。このSQLステートメントは、**セッション1**のトランザクションがロールバックされるか `COMMIT` されるまで待機します。

    ```sql
    UPDATE test_tbl1 SET name = 'A1A1A1' WHERE id = 1;
    ```

    実行結果は次のとおりです：

    ```shell
    ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
    ```

6. **セッション1** で、以下のSQLステートメントを実行してトランザクションをコミットします。

    ```sql
    COMMIT;
    ```

7. **セッション2** で、再び**ステップ4**の更新ステートメントを実行します。

    ```sql
    UPDATE test_tbl1 SET name = 'A1A1A1' WHERE id = 1;
    ```

    実行結果は次のとおりです：

    ```shell
    Query OK, 1 row affected
    Rows matched: 1  Changed: 1  Warnings: 0
    ```

## 関連ドキュメント

[SELECT](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974942)
