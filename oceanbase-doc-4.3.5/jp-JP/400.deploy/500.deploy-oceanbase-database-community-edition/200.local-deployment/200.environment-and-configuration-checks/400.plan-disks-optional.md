# (オプション)ディスク計画

OceanBaseデータベースのサーバーは、データディスク、トランザクションログディスク、およびOceanBaseデータベースのインストールディスクに依存しています。個人ユーザーの場合は、すべてのデータを1つのディスクにまとめて配置し、この手順をスキップすることができます。企業ユーザーの場合は、データを3つのディスクにそれぞれマウントすることを推奨します。

お使いのマシンに3台のディスクがない場合、またはRAIDディスクアレイを使用している場合は、ディスクまたはディスクアレイの論理ボリュームをパーティション分割する必要があります。以下のパーティション分割方法を推奨します：

* データディスク

  データディスクは、ベースラインデータを格納するために使用され、そのパスは構成パラメータ `data_dir` で指定されます。OceanBaseクラスタを初めて起動すると、`${data_dir}/{sstable,slog}` が自動的に作成されます。データディスクのサイズは、`datafile_disk_percentage`/`datafile_size` パラメータによって決定されます。デプロイ完了後、`datafile_next` および `datafile_maxsize` 構成パラメータを使用してディスクファイルの動的拡張を行うことも可能です。詳細については、[ディスクデータファイルの動的拡張の設定](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971412)を参照してください。

  <main id="notice" type='explain'>
    <h4>説明</h4>
    <p>OceanBaseデータベースの現バージョンでは、<code>slog</code> をデータ(data)ディスクから独立させることがサポートされています。つまり、<code>slog</code> とデータファイルは同一ディスク上にある必要がありません。OceanBaseデータベースのインストールディレクトリに関する詳細は、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971319">OBServerノードのインストールディレクトリ構造</a>を参照してください。</p>
  </main>

* トランザクションログディスク

  トランザクションログディスクのパスは、構成パラメータ `clog_dir` で指定されます。OceanBaseデータベースのメモリ容量の3～4倍以上に、トランザクションログディスクのサイズを設定することを推奨します。OceanBaseクラスタを初めて起動すると、`${clog_dir}` が自動的に作成され、トランザクションログディスクには複数の固定サイズのファイルが含まれます。必要に応じて、トランザクションログを自動的に作成および削除することができます。トランザクションログがディスク総容量の80％ に達すると、自動クリアが実行されます。ただし、トランザクションログに対応するメモリ上のデータがベースラインデータにマージ済みの場合のみ、トランザクションログを削除することができます。

  同じデータ量の場合、トランザクションログのサイズはメモリデータサイズの約3倍となります。このため、トランザクションログディスクに必要な容量の上限は、2回のマージ後のデータ総量に比例します。経験式：トランザクションログファイルサイズは、増分データのメモリ上限の3～4倍となります。

* OceanBaseデータベースインストールディスク

  OceanBaseデータベースのインストールディレクトリは、構成パラメータ `home_path` で指定されます。OceanBaseデータベースのインストールディスクには、7日以上のログを保存するため、少なくとも200 GBの空き容量を確保することを推奨します。OceanBaseデータベースのRPMパッケージのインストールディレクトリは `${home_path}` にあります。ベースラインデータファイルとトランザクションログファイルは、それぞれ独立したデータディスクとトランザクションログディスクへのソフトリンクとなります。OceanBaseデータベースの動作ログは `${home_path}/log` ディレクトリにあります。実行ログは継続的に増加し、OceanBaseデータベースは実行ログを自動的に削除できないため、定期的に実行ログを削除する必要があります。

## ディスクのマウント

### マウント要件

* OCPサーバーのディスクマウントポイント要件は以下の表に示されています。

  | マウントポイント | サイズ | 用途 | ファイルシステム形式 |
  |--------|---------|-----|---------|
  | /home | 100 GB~300 GB | 各コンポーネントの実行ログディスク | 推奨: ext4またはxfs |
  | /data/log1 | observerに割り当てるメモリサイズの3〜4倍 | OCPメタデータベースのログディスク | 推奨: ext4またはxfs |
  | /data/1 | 保存する必要があるデータのサイズに応じて変更 | OCPメタデータベースのデータディスク | 推奨: ext4またはxfs |

* OBServerノードのディスクマウントポイント要件は以下の表に示されています。

  | ディレクトリ | サイズ | 用途 | ファイルシステム形式 |
  |-------|--------|-------|-----------|
  | /home | 100 GB~300 GB | observerデータベースのインストールディスク | 推奨: ext4またはxfs |
  | /data/log1 | observerに割り当てるメモリサイズの3〜4倍 | observerプロセスのログディスク | 推奨: ext4またはxfs |
  | /data/1 | 保存する必要があるデータのサイズに応じて変更 | observerプロセスのデータディスク | 推奨: ext4またはxfs |

  <main id="notice" type='explain'>
    <h4>説明</h4>
    <ul>
    <li><p>ルートディレクトリは50 GB以上であることを推奨します。LVMを使用する場合は、作成時にストライピングパラメータを使用することを推奨します。例: <code>lvcreate -n data -L 3000G obvg --stripes=3 --stripesize=128</code>。</p></li>
    <li><p>本番環境では、データディスク、ログディスク、およびインストールディスクに異なるディスクを使用することを推奨します。パフォーマンスの低下を防ぐためです。</p></li>
    </ul>
  </main>

### マウント操作

ディスクのマウントはrootユーザーで実行する必要があります。以下の2つの操作方法がありますので、実際の状況に応じて適切なディスクマウント操作を選択してください：

* LVMツールを使用してディスクをマウントする（推奨）。
* fdiskツールを使用してディスクをマウントする。

:::tab

tab LVMツールを使用してディスクをマウントする

1. ディスク情報を確認する

   `fdisk -l`コマンドを使用して利用可能なディスクとパーティションを識別し、ターゲットデバイス（例：`/dev/sdb1`）を確認します。

   ```shell
   [root@test001 ~]# fdisk -l
   ```

2. （オプション）LVMツールをインストールする

   LVMが事前にインストールされていない場合は、以下のコマンドを実行してLVMをインストールする必要があります。LVMが既にインストールされている場合は、このステップをスキップしてください。

   * Debian/Ubuntu系システム

     ```shell
     [root@test001 ~]# apt-get install lvm2
     ```

   * CentOS/RHEL系システム

     ```shell
     [root@test001 ~]# yum install lvm2
     ```

3. 物理ボリューム（PV）を作成する

   パーティションを物理ボリュームとして初期化します。

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>パーティションを物理ボリュームとして初期化すると、パーティションが再フォーマットされ（データが失われる可能性があります）、慎重な操作が必要です。</p>
   </main>

   ```shell
   [root@test001 ~]# pvcreate /dev/sdb1
   ```

   作成後、`pvs`コマンドを実行して物理ボリュームの作成結果を検証できます。

4. ボリュームグループ（VG）を作成する

   複数の物理ボリュームを1つのVGにまとめます。

   ```shell
   [root@test001 ~]# vgcreate vg01 /dev/sdb1 /dev/sdc1
   ```

   作成後、`vgs`コマンドを実行することで、ボリュームグループの情報を確認できます。

5. 論理ボリューム（LV）を作成する

   VGから100GBの論理ボリュームを分離します。ここでは例として100GBを設定していますが、実際の状況に応じて論理ボリュームのサイズを変更できます。

   ```shell
   [root@test001 ~]# lvcreate -L 100G -n lv01 vg01
   ```

   作成後、`lvs`コマンドを実行することで、論理ボリュームの情報を確認できます。

6. フォーマットとマウント

   1. ext4ファイルシステムでのフォーマット

      ```shell
      [root@test001 ~]# mkfs.ext4 /dev/vg01/lv01
      ```

   2. マウントポイントを作成する

      ```shell
      [root@test001 ~]# mkdir -p /data/1
      ```

   3. 一時的にマウントする

      ```shell
      [root@test001 ~]# mount /dev/vg01/lv01 /data/1
      ```

7. 起動時に自動マウントする設定を行う

   `/etc/fstab`ファイルを編集し、マウント設定を追加します：

   ```shell
   [root@test001 ~]# vim /etc/fstab
   ```

   `/etc/fstab`ファイルに以下の内容を追加します：

   ```shell
   /dev/vg01/lv01  /data/1  ext4  defaults,noatime,nodiratime,nodelalloc,barrier=0  0  0
   ```

tab fdiskツールを使用してディスクをマウントする

1. ディスク情報を確認する

   `fdisk -l`コマンドを使用して利用可能なディスクとパーティションを識別し、ターゲットデバイス（例：`/dev/sdb1`）を確認します。

   ```shell
   [root@test001 ~]# fdisk -l
   ```

2. パーティションを作成する

   fdiskツールを使用して新しいパーティションを作成します。例えば、`fdisk /dev/sdb1`と入力し、`n`を入力して主パーティションを作成し、最後に保存（`w`）します。

   ```shell
   [root@test001 ~]# fdisk /dev/sdb1
   ```

3. フォーマットとマウント

   1. ext4ファイルシステムにフォーマットする。

      ```shell
      [root@test001 ~]# mkfs.ext4 /dev/sdb1
      ```

   2. マウントポイントを作成します

      ```shell
      [root@test001 ~]# mkdir -p /data/1
      ```

   3. 一時的にマウントします

      ```shell
      [root@test001 ~]# mount /dev/sdb1 /data/1
      ```

4. 起動時に自動的にマウントする設定を行います。

   `/etc/fstab` ファイルを編集し、マウント設定を追加します：

   ```shell
   [root@test001 ~]# vim /etc/fstab
   ```

   `/etc/fstab` ファイルに以下の内容を追加します：

   ```shell
   /dev/sdb1  /data/1  ext4  defaults,noatime,nodiratime,nodelalloc,barrier=0  0  0
   ```

:::

## ディスクの確認

ディスクがマウントされた後、以下のコマンドを実行してディスクのパーティション状況を確認できます：

```shell
df -h
```

以下の結果が返されます：

```shell
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs         31G     0   31G   0% /dev
tmpfs            31G     0   31G   0% /dev/shm
tmpfs            31G  516K   31G   1% /run
tmpfs            31G     0   31G   0% /sys/fs/cgroup
/dev/vda1       493G  171G  302G  37% /
tmpfs           6.2G     0  6.2G   0% /run/user/0
/dev/vdd1     984G    77M  934G  1%  /data
/dev/vdc1     196G     61M   186G  1%  /redo
/dev/vdb1     492G    73M   467G  1%  /home/admin/oceanbase
```

結果の説明

* `/data` はデータディスクで、サイズは1 TBとなります。

* `/redo` はredoログを格納します。

* `/home/admin/oceanbase` には、OceanBaseデータベースのバイナリファイルと実行ログが保存されています。

設定ファイルの `data_dir`、`redo_dir`、および `home_path` に対応するディスクが、それぞれマウントされていることを確認します。`data_dir` と `redo_dir` のディレクトリは空でなければなりません。また、`data_dir` のディスク使用率は4%未満である必要があります。

## ディレクトリ権限の設定

ディスクのマウントが完了したら、ディスクマウントに対応するディレクトリの権限を確認する必要があります。クラスタ関連のファイルディレクトリの権限を確認するには、以下のコマンドを実行します。

ここでは `data` ディレクトリを例にします：

```shell
[root@test001 data]# ls -al
```

結果は次のとおりで、ディレクトリの所有者はadminグループのadminユーザーであることが示されます：

```shell
drwxr-xr-x 2 admin admin 4096 2 月 9 18:43 .
drwxr-xr-x 2 admin admin 4096 2 月 9 18:43 log1
```

ディレクトリの権限を確認した後、adminユーザーが関連ファイルにアクセスできない場合は、以下のコマンドを実行してファイルの所有者を変更します：

```shell
[root@test001 ~]# chown -R admin:admin /data/log1
[root@test001 ~]# chown -R admin:admin /data
```

ここでは `/data/log1`、`/data` がマウントディレクトリの例です。実際のマウントディレクトリに置き換える必要があります。
