# OCPを使用したOceanBaseクラスタのデプロイ

本記事では、x86アーキテクチャのCentOS Linux 7.9イメージを環境として、OCP GUIを用いてOceanBaseデータベースをデプロイする方法を説明します。

## 前提条件

* OCPは既にデプロイ済みです。詳細な手順については、[OceanBaseクラウドプラットフォームCommunity Editionのデプロイ](https://en.oceanbase.com/docs/common-ocp-10000000002169267)を参照してください。

* 現在OCPにログインしているユーザーは、**ADMIN** ロールまたは **ORG_ADMIN** ロールです。

* OceanBaseのデプロイに必要なoceanbase-ce、oceanbase-ce-libs、oceanbase-ce-utilsソフトウェアパッケージをOCPにアップロードしました。詳細については、OceanBase公式Webサイトのドキュメント「OceanBaseクラウドプラットフォーム」の [ソフトウェアパッケージ管理/ソフトウェアパッケージのアップロード](https://en.oceanbase.com/docs/common-ocp-10000000002169060)を参照することができます。

* (オプション)マルチレプリカのOceanBaseクラスタを作成する場合は、現在のOCPに利用可能なODPクラスタが既に存在している必要があります。ODPクラスタの追加方法については、公式Webサイトのドキュメント『OceanBaseクラウドプラットフォーム』の [OBProxy管理 / OBProxyクラスタの作成](https://en.oceanbase.com/docs/common-ocp-10000000002168933)を参照することができます。

## 操作手順

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>本記事では、OCP V4.3.4 Community Editionを例に操作手順を説明します。OCPのバージョンによって操作画面が異なる場合があります。実際の画面をご確認ください。</p>
</main>

### ステップ1：OCPリソースプールにマシンを追加する

OceanBaseクラスタをデプロイする前に、このセクションを参照して、マシンをOCPリソースプールに追加する必要があります。

1. OCPにログインします。

2. 左側のナビゲーションバーで **ホスト** をクリックして、**ホスト** ページに移動します。

3. **ホスト** ページの右上の **ホストを追加** をクリックします。

4. 表示されたダイアログボックスにマシン情報を入力します。

   <!-- ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.3.5/400.deploy/500.deploy-oceanbase-database-community-edition/200.deploy-by-ocp-02.png) -->

   各フィールドへの入力説明は以下の表のとおりです。

   |   **フィールド** |         **説明**     |
   |------------|----------------------|
   | **IPアドレス**  | 追加するマシンのIPアドレスです。新規ホストのIPv4アドレスを入力してください。複数のIPアドレスを追加する場合は、英語のカンマ(,)で区切ってください。  |
   | **SSHポート** | デフォルトは `22` です。               |
   | **マシンタイプ**   | OCPによるホスト管理を容易にするため、同じ構成のホストに割り当てられるタグです。対応するマシンタイプがない場合、ドロップダウンメニューで **マシンタイプを追加** をクリックして、新しいマシンタイプを追加することができます。|
   | **データセンター**   | 使用するマシンのデータセンターを選択します。対応するデータセンターがない場合、ドロップダウンメニューで **データセンターを追加** をクリックして、OCPにデータセンター情報を追加します。データセンター情報は **データセンター** と **リージョン** を含みます。<ul><li>データセンターは、OceanBaseクラスタが記録する必要があるホスト属性の1つです。この属性は、OceanBaseクラスタのロードバランシングとSQL文のルーティング戦略の参照項目として使用されるため、実際の状況に合わせて入力してください。</li><li>リージョンはホストの地理的な位置を表すもので、OceanBaseクラスタが記録する必要のあるホスト属性の1つです。OceanBaseクラスタのロードバランシングとSQL文のルーティング戦略に影響するため、実際の状況に合わせて入力してください。</li></ul><main id="notice" type='explain'><h4>説明</h4><p>OCP V3.1.1バージョンより、マルチゾーンモードがサポートされます。新しいデータセンターを追加する場合、現在のOCPが配置されているゾーンに新しいデータセンターが作成されます。</p></main>|
   | **ホストのタイプ**     | **物理マシン**、**コンテナ**、**ECS** の3つのオプションがあります。**コンテナ** タイプを選択する際は、**ポートマッピング**、つまりocp-agentとホスト、ocp exportとホストの計2組のマッピング関係を指定する必要があり、対応するフォーマットは `<ホストポート>：＜Docker内のocp-agentポート＞、＜ホストポート＞：<Dockerコンテナ内のocp-exporterポート1>` となります。   |
   | **認証情報**   | 物理マシンへのリモートログインに使用する認証情報を選択します。ドロップダウンメニューから **認証情報の追加** をクリックして、新しい認証情報を作成することができます。 </br> 認証情報の追加時には、次の点に注意してください：<ul><li>**認証情報名**：英字で始まり、英字または数字で終わり、英数字、アンダースコア(_)を含み、長さは2～64文字であること。</li><li>**認証タイプ**：**パスワード認証**、**公開鍵認証**、および **設定済みのパスワードレス認証** の3つのタイプがあります。</li> <li>**ユーザータイプ**：root権限を持つSSHユーザーをサポートします。root権限を持つ一般ユーザーは、sudoコマンドをパスワードレスで実行するよう事前に設定しておく必要があります。OCPは現在、すべてのコマンドをパスワードレスでsudo実行する設定のみをサポートしています。つまり、`/etc/sudoers` ファイルに `username ALL=(ALL) NOPASSWD:ALL` を追加します。</li></ul>|
   | **ホストエイリアス(オプション)**   | 任意項目で、ホストに別の名前を設定します。   |
   | **説明(オプション)**     | ホストに関する注釈で、ホスト管理の効率化に役立ちます。      |

5. 入力後、**OK** をクリックします。

### ステップ2：OceanBaseクラスタの作成

このセクションでは、OCPを使用してOceanBaseクラスタを作成する方法について説明します。

1. OCPのGUIで、実際のビジネスシナリオに基づき、新規クラスタ作成のエントリを探します。

   * 管理可能なクラスタがない場合、**クラスタ** ページで新規クラスタの作成を促すメッセージが表示されます。メッセージ内の **クラスタの作成** を直にクリックします。

   * 既に管理可能なクラスタがある場合は、左側の **クラスタ** をクリックし、**クラスタ** ページの右上にある **クラスタの作成** をクリックします。
  
   <main id="notice" type='explain'>
     <h4>説明</h4>
     <p>OCPはデフォルトで分散型クラスタを作成します。<b>クラスタの作成</b>ページの右上で、デプロイするクラスタモード(<b>分散型クラスタ</b>と<b>スタンドアロン集中型</b>)を選択できます。ここでは、<b>分散型クラスタ</b>の作成例を説明します。</p></main>

2. **クラスタの作成** ページで、クラスタの基本情報を設定します。

   <!-- ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.3.5/400.deploy/500.deploy-oceanbase-database-community-edition/200.deploy-by-ocp-03.png) -->

   基本情報に関する説明については、以下の表に示す通りです。

   |    **設定**       |     **説明**    |
   |-------------------|-----------------|
   | **クラスタタイプ**      | **プライマリクラスタ** を選択します。<main id="notice" type='notice'><h4>機能の適用性</h4><p>OCP Community Editionは、新規プライマリクラスタの作成のみをサポートします。</p></main>  |
   | **クラスタ名**      | 管理対象クラスタのカスタマイズ可能な名前です。クラスタ名は英字で始まり、英字または数字で終わり、英数字、アンダーバー(_)を含み、長さは2～32文字である必要があります。 |
   | **root@sysパスワード** | カスタマイズまたはランダム生成をサポートします。パスワードは以下の複雑さの条件を満たす必要があります：</br> <ul><li>長さ：8～32文字</li><li>以下の4種類の文字のうち、少なくとも3種類以上を含む：数字(0～9)、大文字(A～Z)、小文字(a～z)、特殊記号 `~!@#%^&amp;*_-+=|(){}[]:;,.?/`</li></ul>パスワードを入力後、**パスワードをコピー** をクリックすると、カスタマイズまたはランダムに生成されたパスワードをクリップボードにコピーできます。 |
   | **OceanBaseバージョン**   | リストから既存のOceanBaseデータベースバージョンを選択するか、またはドロップダウンメニューで **ソフトウェアパッケージのアップロード** をクリックして、OceanBaseデータベースRPMパッケージをアップロードすることができます。     |
   | **OBProxyクラスタの関連付け** | このオプションは、既存のODPクラスタを関連付けるために使用します。マルチレプリカのOceanBaseクラスタを作成する場合は、**OBProxyクラスタの関連付け** スイッチをオンにして、OceanBaseクラスタにODPクラスタを関連付けることを推奨します。関連付け後、お客様のビジネスに関連するSQLリクエストは、対応するレプリカに正確に転送されます。これにより、OceanBaseデータベースへのアクセス効果は、スタンドアロンデータベースへのアクセスと同等になります。<ul><li>デフォルトで `proxyro@sys` ユーザーが関連付けられているため、ユーザー名とパスワードを入力する必要はありません。</li><li>ドロップダウンリストから関連付けるODPクラスタを選択します。ドロップダウンリストに関連付け可能なODPクラスタがない場合、本記事の **前提条件** にあるリンクを参照して、ODPクラスタを追加してください。</li></ul> <main id="notice" type='notice'><h4>注意</h4><ul><li>OceanBaseクラスタネットワークと一致しており、かつ空でないOBProxyクラスタのみ選択可能です。</li><li><p>選択された<b>OceanBaseバージョン</b>のクラスタがV4.0およびそれ以降の場合、V4.0.0およびそれ以降のバージョンと関連するOBProxyクラスタのみがサポートされます。</p></li></ul></main> |
   | **負荷タイプ** | ドロップダウンリストから対応する負荷タイプを選択できます。OCPは、負荷タイプに応じてOceanBaseクラスタに異なる構成を設定します。負荷タイプの具体的な説明は以下のとおりです：<ul><li><b>Express OLTP</b>：貿易、決済基幹システム、インターネットの高スループットアプリケーションなどのワークロードに適しています。外部キー制約などはありません。ストアドプロシージャ、長時間トランザクション、大規模トランザクション、複雑な結合、複雑なサブクエリもありません。</br>バージョン制限：OceanBaseデータベースV4.2.5およびそれ以降のバージョンに対応しています。</li><li><b>HTAP</b>：ハイブリッドOLAPおよびOLTPワークロードに適しています。通常、リアルタイムの運用データ、不正検知、パーソナライズされたレコメンドから即時の見解を得るために使用されます。</br>バージョン制限：OceanBaseデータベースV4.2.5およびそれ以降のバージョンに対応しています。</li><li><b>OLAP</b>：リアルタイムデータウェアハウス分析シーンで使用されます。</br>バージョン制限：OceanBaseデータベースV4.3.0およびそれ以降のバージョンに適用されます。</li><li><b>Complex OLTP</b>：銀行、保険システムなどのワークロードに適しています。それらは通常、複雑な結合、複雑な相関サブクエリ、PLで記述されたバッチジョブ、および長時間トランザクションと大規模トランザクションを備えています。短時間実行のクエリに対して、パラレル実行を使用することがあります。</br>バージョン制限：OceanBaseデータベースV4.2.5およびそれ以降のバージョンに対応しています。</li><li><b>OBKV</b>：キーバリューワークロードとHBaseのようなワイドカラムワークロードに使用され、通常非常に高いスループットを必要とし、レイテンシに敏感です。</br>バージョン制限：OceanBaseデータベースV4.2.5およびそれ以降のバージョンに対応しています。</li></ul> |

3. クラスタのデプロイモードを設定します。

   デフォルトで3つのZoneの情報が追加されます。クラスタを4つ以上のZoneにデプロイする場合は、下部の **+ Zoneを追加** ボタンをクリックして、Zone情報を追加することができます。デプロイ済みクラスタのZone数が3未満の場合、Zoneの後ろにある削除アイコンをクリックすることができます。

   <!-- ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.3.5/400.deploy/500.deploy-oceanbase-database-community-edition/200.deploy-by-ocp-04.png) -->

   各Zoneに設定する必要がある情報とその説明は、以下の表のとおりです。

   |       **設定**     |            **説明**               |
   |--------------------|-----------------------------------|
   | **Zone名**      | 通常、デフォルト名が設定されていますが、必要に応じて名前を変更することができます。Zone名は英文字で始まり、英字または数字で終わり、英数字、アンダースコア(_)を含み、長さは2～32文字である必要があります。複数ZoneにデプロイされたOceanBaseクラスタは、主Zoneと同じリージョンを持つZoneを1つ持つ必要があります。 |
   | **データセンター**           | Zoneが属するデータセンターでは、1つのZoneは1つのデータセンターにのみ存在できます。|
   | **マシンタイプ(オプション)**   | マシンタイプを選択すると、後のホストリストはそのマシンタイプに基づいてフィルタリングされます。 |
   | **CPUアーキテクチャ**   | 選択した **OceanBaseバージョン** に複数の異なるアーキテクチャのインストールパッケージが存在する場合、このソフトウェアパッケージに対応するホストハードウェアアーキテクチャを選択する必要があります。<main id="notice" type='notice'><h4>注意</h4><ul><li><p>デフォルトのアーキテクチャタイプは、最初のインストールパッケージのアーキテクチャタイプで、切り替えがサポートされています。指定されたアーキテクチャに切り替えると、<b>ホスト</b>リストにそのアーキテクチャのホストが表示されます。</p></li><li><p>異なるZoneに異なるアーキテクチャを設定する場合、混合アーキテクチャのデプロイモードでは安定性とパフォーマンスの問題が発生する可能性があるため、慎重に操作してください。</p></li></ul></main>        |
   | **ホスト**           | 複数のホストを選択するか、ホストを追加することができます。           |
   | **Root Serviceの位置** | Root Serviceを配置するマシンのIPアドレスを選択する必要があります。マルチレプリカのOceanBaseクラスタでは、各Zoneに1つのRoot Serviceを指定する必要があります。        |
   | **Zone優先順位付け** | クラスタsysテナントのプライマリレプリカの分散に優先順位を指定します。最も優先順位の高いZoneはPrimary Zoneと見なされ、1つしか持つことができません。指定がない場合、最初のZoneが第一優先順位となります。ソート方法は以下のとおりです：<ol><li>左側のリストボックスから1つまたは複数のZoneを選択します。左側のリストボックスには、現在のクラスタで選択可能なすべてのZoneが表示されます。</li><li> 中央の > ボタンをクリックします。選択したZoneが<b>優先順位ソート</b>リストに移動します。複数のZoneを同時に選択すると、それらは同じ優先順位を持ちます。</li><li>ステップ1と2を繰り返し、優先順位が1つ低いZoneを追加します。</li><li>優先順位を調整する必要がある場合、<b>優先順位ソート</b>リスト内でドラッグして順序を変更することができます。リスト内では上から下へ優先順位が低くなります。</li></ol>   |

4. クラスタでCgroupを有効にするかどうかを選択します。

   Cgroupは、主にOceanBaseクラスタ内のテナント間およびテナント内のCPUリソースの分離に使用されます。作成するOceanBaseクラスタのバージョンがV4.0およびそれ以降の場合、システムはデフォルトでCgroupを有効化し、CPU / IOPSのより強力な分離を実現します。Cgroupを有効にすると、パフォーマンスが約7% 低下します。単一テナント、小規模(<14C)、および高いデータベースパフォーマンスが必要なユースケースでは、Cgroupを無効にすることを推奨します。また、ホストのOSカーネルバージョンが4.1.9より低い場合、クラスタはテナントを作成できず、システムはCgroupをデフォルトで無効にし、Cgroupスイッチは表示されません。

5. CPUのオーバーコミットを設定する。

   **CPUオーバーコミット設定** スイッチをオンにした後、CPUオーバーコミットの許容範囲の設定を行うことができます。デフォルト値は120％ です。スライダーまたは入力欄でオーバーコミット比率を設定でき、値の範囲は101％ ～200％ となります。

   システムの異なるテナントの負荷は、制御された形でインターリーブ実行でき、CPUリソースの設定においてオーバーコミットを設定することで、リソース利用率を向上させることができます。異なる業務シナリオの負荷が重なる場合、OceanBaseクラスタの運用中に負荷過多などの状況が発生し、テナント間でCPUを巡るスレッド競合が発生し、結果として実際の業務シナリオが遅延することがあります。

6. **パラメータ設定** モジュールを開き、クラスタパラメータを構成します。

   <!-- ![3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF.png) -->

   * **基本設定** で負荷タイプを設定すると、システムは負荷タイプに対応するパラメータテンプレートをデフォルトで選択します。

   * 図 ① のように、起動パラメータ項目を1つずつ追加することで、値を設定することができます。OceanBaseデータベースのパラメータについては、[構成項目概要](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001970983)を参照することができます。

   * 図 ② のように、**パラメータテンプレートの選択** をクリックしてパラメータテンプレートを選択することもできます。システムは、テンプレートのパラメータと設定をここに自動的に入力します。また、**クラスタパラメータテンプレートの作成** をクリックして、クラスタのパラメータテンプレートを作成することもできます。詳細については、公式Webサイト『OceanBaseクラウドプラットフォーム』ドキュメントの [クラスタ管理/クラスタパラメータテンプレートの管理](https://en.oceanbase.com/docs/common-ocp-10000000002169013)を参照してください。

   OCPシステムは、下記6種類の組み込みテンプレートを提供します。これらのテンプレートには一般的なパラメータ設定が含まれており、テンプレートを直接適用することでクラスタの初期設定を行うことができます。具体的な説明については以下のとおりです：

   |           テンプレート           |                                   説明                                   |
   | ------------------------- | ------------------------------------------------------------------------ |
   | COMPLEX_OLTPデフォルトパラメータテンプレート | **Complex OLTP** ワークロードタイプに対応しており、このテンプレートはOceanBaseデータベースV4.2.5およびそれ以降のバージョンにのみ適用されます。 |
   | HTAPデフォルトパラメータテンプレート         | **HTAP** 負荷タイプに対応しており、このテンプレートはOceanBaseデータベースV4.2.5およびそれ以降のバージョンにのみ適用されます。         |
   | KVデフォルトパラメータテンプレート           | **OBKV** 負荷タイプに対応しており、このテンプレートはOceanBaseデータベースV4.2.5およびそれ以降のバージョンにのみ適用されます。         |
   | EXPRESS_OLAPデフォルトパラメータテンプレート | **Express OLAP** 負荷タイプに対応しており、このテンプレートはOceanBaseデータベースV4.2.5およびそれ以降のバージョンにのみ適用されます。 |
   | OLAPデフォルトパラメータテンプレート         | **OLAP** 負荷タイプに対応しており、このテンプレートはOceanBaseデータベースV4.3.0およびそれ以降のバージョンにのみ適用されます。         |
   | 2.2.77デフォルトパラメータテンプレート       | OceanBaseクラスタV2.2.77バージョンで推奨されるパラメータ設定。本番環境での使用を推奨します。          |

7. **カスタム設定** を開くと、クラスタレベルのユーザー設定(OS所有者ユーザーなど)、パス設定(ソフトウェアインストールパス、データディスクパス、ログディスクパスなど)、ポート設定(SQLポート、RPCポートなど)の実行をサポートします。

   * オペレーティングシステムの所有者ユーザーを設定します：
  
     このユーザーは、OBServerのインストールと実行の設定を行うOSユーザーであり、編集はサポートされていません。ocp.operation.default.os.userパラメータのデフォルト設定を変更することで、このユーザーを変更することができます。この変更は、分散クラスタの作成、OBProxyクラスタの作成、およびアービトレーションサービスの作成時のみ影響し、既存クラスタの他の設定には影響しません。

   * パスの設定：

     | 設定 | 説明 |
     |---|----|
     | ソフトウェアインストールパス | <ul><li><b>OSの所有者ユーザー</b>がadminの場合、<b>ソフトウェアインストールパス</b>はデフォルトで <code>/home/admin/oceanbase</code> となり、カスタムパスをサポートします。</li><li><b>OSの所有者ユーザーが </b>admin以外の場合、</b>ソフトウェアのインストールパス</b>はデフォルトで <code>/opt/oceanbase/oceanbase</code> となり、カスタムパスもサポートされます。</li></ul>  |
     | データディスクパス | デフォルトは /data/1であり、カスタムパスをサポートします。 |
     | ログディスクパス | デフォルトは /data/log1であり、カスタムパスをサポートします。本番環境において、OceanBaseデータベースのログディスク容量はホストメモリ容量の3倍以上を推奨します。また、パフォーマンス問題を回避するため、データディレクトリとログディレクトリを同一ディスクにマウントすることは推奨しません。<main id="notice" type='explain'><h4>説明</h4><p>OCP V4.3.0 BP1以降、以下のバージョンのOceanBaseクラスタを作成する場合、slogディレクトリはログディスクに配置され、データディスクとは関連付けられなくなります。このとき、<code>log_disk_size=0</code> と設定すると、clog専用とみなされ、デフォルトで <code>log_disk_percentage</code> は90％ になります。slogとclogが存在するディスクのサイズが40 GiBより小さい場合、slogに確保される領域は4 GiB未満となり、slogへの書き込みに影響する可能性があります。</p><ul><li>V4.2.4.0 ≤ OceanBaseデータベースバージョン ＜V4.3.0.0</li><li>OceanBaseデータベースバージョン ≥ V4.3.1.0</li></ul>slogに関する詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971319">OBServerノードのインストールディレクトリ構造</a>を参照してください。</main> |

     設定完了後、**テスト** をクリックして、パスが使用可能かどうか検証します。使用できない場合は、テスト結果に基づいて問題を調査するか、パスを他の使用可能なパスに変更することができます。

   * ポートの設定：

     |   設定   |             説明              |
     | -------- | ----------------------------- |
     | SQLポート | デフォルトは2881で、カスタムポートをサポートしています。 |
     | RPCポート | デフォルトは2882であり、カスタムポートをサポートします。 |

     設定が完了したら、**テスト** をクリックして、ポートが既に使用されているかどうかを検証します。既に使用されている場合、使用可能なポートを再設定する必要があります。

     <!-- ![5](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%BE%E7%BD%AE.png) -->

8. テスト完了後、**送信** をクリックします。

9. 表示された **コミット情報の確認** ダイアログで、情報に誤りがないことを確認後、**OK** をクリックします。

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p> ページ右上の<b>タスクセンター</b>をクリックして、このタスクの実行状況を確認することができます。</p>
</main>

## 関連ドキュメント

クラスタのデプロイ完了後、業務テナントを作成する必要があります。詳細については、公式Webサイト『OceanBaseクラウドプラットフォーム』ドキュメントの [テナント管理/プライマリテナントの新規作成](https://en.oceanbase.com/docs/common-ocp-10000000002168891)を参照してください。
