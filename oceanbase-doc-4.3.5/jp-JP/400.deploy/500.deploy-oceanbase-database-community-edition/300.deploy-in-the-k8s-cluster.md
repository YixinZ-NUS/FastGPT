# Kubernetes環境におけるOceanBaseクラスタのデプロイ

本記事では、ob-operatorを使用してKubernetes環境にOceanBaseクラスタをデプロイする方法を、例を挙げて説明します。

## 前提条件

開始する前に、以下の条件を満たしていることを確認してください。

- 利用可能なKubernetesクラスタがあり、9個以上のCPU、33 GBの利用可能なメモリ、および360 GBの利用可能なストレージがあります。

- ob-operatorはcert-managerに依存しています。cert-managerがインストール済みであることを確認してください。cert-managerのインストール方法については、対応する [インストールガイド](https://cert-manager.io/docs/installation/)を参照してください。

- OceanBaseクラスタに接続するには、MySQLクライアントまたはOBClientがインストール済みである必要があります。

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>本記事では、ob-operator V2.2.0を例に操作手順を説明します。他のバージョンでは、若干異なる場合があります。異なるバージョンの操作手順については、<a href='https://en.oceanbase.com/docs/community-ob-operator-doc-en-10000000001735158'>ob-operatorマニュアル</a>の該当するバージョンを参照することができます。</p>
</main>

## 手順

### ステップ1：ob-operatorのデプロイ

`ob-operator` を使用すると、Kubernetes上でのOceanBaseデータベースのデプロイと運用管理を簡素化できます。以下の3つの方法で `ob-operator` をデプロイできます。

:::tab

tab okctlを使用したデプロイ

1. `okctl` のダウンロードとインストール

   ```shell
   curl -sL https://raw.githubusercontent.com/oceanbase/ob-operator/master/scripts/install-okctl.sh | bash
   sudo mv ./okctl /usr/local/bin
   ```

2. ob-operator のインストール

   `okctl` のインストール完了後、以下のコマンドを使用してob-operatorをインストールできます。

   ```shell
   okctl install ob-operator
   ```

3. ob-operatorのインストール確認

   ```shell
   kubectl get pod -n oceanbase-system
   ```

   ob-operatorが正しくインストールされている場合、以下のように出力されます：

   ```shell
   # desired output
   NAME                                            READY   STATUS    RESTARTS   AGE
   oceanbase-controller-manager-86cfc8f7bf-4hfnj   2/2     Running   0          1m
   ```

tab Helmを使用したデプロイ

以下のコマンドを実行してob-operatorをデプロイします。

```shell
helm repo add ob-operator https://oceanbase.github.io/ob-operator/
helm install ob-operator ob-operator/ob-operator --namespace=oceanbase-system --create-namespace
```

ここで、`--namespace` はネームスペースの設定に使用されます。必要に応じてカスタマイズ可能ですが、通常は `oceanbase-system` の使用を推奨します。

tab 設定ファイルを使用したデプロイ

以下のコマンドを実行し、設定ファイルを使用してob-operatorをデプロイします。

```shell
kubectl apply -f https://raw.githubusercontent.com/oceanbase/ob-operator/stable/deploy/operator.yaml
```

**ob-operatorのカスタマイズ**

ob-operator に対して独自の変更を加える必要がある場合は、以下のコマンドを実行して設定ファイルをダウンロードしてください。

```shell
wget https://raw.githubusercontent.com/oceanbase/ob-operator/stable/deploy/operator.yaml
```

要件に合わせて設定ファイルを修正した後、以下のコマンドを実行してカスタマイズした設定でデプロイを行います。設定ファイル内の各設定項目の詳細については、[ob-operator の設定](https://www.oceanbase.com/docs/community-ob-operator-doc-1000000001666230)を参照してください。

```shell
kubectl apply -f operator.yaml
```

:::

### ステップ2：OceanBaseクラスタのデプロイ

1. PVCを作成します

   ob-operatorはOceanBaseクラスタをデプロイする際、OceanBaseクラスタのストレージとしてPVCを作成する必要があります。本記事では、local-path-provisionerを使用してPVCを管理します。デプロイコマンドは以下のとおりです。

   ```shell
   kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.24/deploy/local-path-storage.yaml
   ```

   詳細については、[local-path-provisioner](https://github.com/rancher/local-path-provisioner)を参照することができます。

2. Namespaceを作成します

   以下のコマンドを実行して、OceanBaseクラスタのデプロイに使用されるNamespaceを作成します。

   ```shell
   kubectl create namespace oceanbase
   ```

   作成後、`kubectl get namespace oceanbase` コマンドを実行し、作成に成功したかどうか(ステータスが `Active` であること)を確認することができます。

3.クラスタの作成

   `okctl` コマンドを使用すると、クラスターを迅速に作成できます。コマンドは以下の通りです。

   ```shell
   okctl cluster create obcluster -n oceanbase --image oceanbase/oceanbase-cloud-native:4.3.5.0-100000202024123117 -p ******* --zones=zone1=1 --zones=zone2=1 --zones=zone3=1
   ```

   上記のコマンドは、3つのゾーンを持つクラスターを作成します。リソースとストレージにはデフォルトの最小構成が使用されます。その他の設定をカスタマイズしたい場合は、以下のコマンドを実行して、サポートされているすべてのパラメータを確認できます。

   ```shell
   okctl cluster create -h
   ```

   出力は以下の通りです：

   ```shell
   Create an ob cluster

   Usage:
     okctl cluster create <cluster_name> [flags]

   Flags:
         --backup-storage-address string   The storage class of the backup storage
         --backup-storage-path string      The size of the backup storage
         --cluster-name string             Cluster name, if not specified, use resource name in k8s instead
         --cpu int                         The cpu of the observer (default 2)
         --data-storage-class string       The storage class of the data storage (default "local-path")
         --data-storage-size int           The size of the data storage (default 50)
     -h, --help                            help for create
         --id int                          The id of the cluster
         --image string                    The image of the observer (default "quay.io/oceanbase/oceanbase-cloud-native:4.3.3.1-101000012024102216")
         --log-storage-class string        The storage class of the log storage (default "local-path")
         --log-storage-size int            The size of the log storage (default 20)
         --memory int                      The memory of the observer (default 10)
         --mode string                     The mode of the cluster (default "service")
     -n, --namespace string                The namespace of the cluster (default "default")
         --parameters stringToString       Other parameter settings in OBCluster, e.g., __min_full_resource_pool_memory (default [__min_full_resource_pool_memory=2147483648,system_memory=1G])
         --redo-log-storage-class string   The storage class of the redo log storage (default "local-path")
         --redo-log-storage-size int       The size of the redo log storage (default 50)
     -p, --root-password string            The root password of the cluster
     -z, --zones stringToString            The zones of the cluster, e.g. '--zones=<zone>=<replica>' (default [z1=1])
   ```

   さらに詳細なカスタム設定が必要な場合は、設定ファイルを使用して作成することができます。具体的な作成方法については、[クラスタの作成](https://en.oceanbase.com/docs/community-ob-operator-doc-en-10000000001735170)を参照することができます。

### ステップ3：（オプション）ODPのデプロイ

ODP（OceanBase Database Proxy）はユーザーリクエストのルーティング機能を提供し、リクエストを適切なOBServerノードへ転送します。以下のスクリプトを使用して、ODPクラスターをデプロイできます。

```shell
curl -sL https://raw.githubusercontent.com/oceanbase/ob-operator/refs/heads/master/scripts/setup-obproxy.sh | bash -s -- --proxy-image oceanbase/obproxy-ce:4.3.3.0-5 -n oceanbase obcluster
```

## OceanBaseクラスタへの接続

OceanBaseクラスタのデプロイ後、本セクションの手順を参照してクラスターに直接接続できます。ODPをデプロイしている場合は、ODP経由で接続することも可能です。

:::tab

tab OceanBaseクラスタへの直接接続

1. OceanBaseクラスタのPodアドレスの取得

   ```shell
   kubectl get pods -n oceanbase -l ref-obcluster=obcluster -o wide
   ```

   例の中の `oceanbase` は、`-n`（`okctl` コマンド実行時）または `metadata.namespace`（設定ファイル使用時）の値に対応し、`obcluster` は `<cluster_name>`（`okctl` コマンド実行時）または `metadata.name`（設定ファイル使用時）の値に対応します。実際の構成に合わせて置き換えてください。

   出力例：

   ```shell
   NAME                                READY   STATUS    RESTARTS   AGE    IP            NODE     NOMINATED NODE   READINESS GATES
   obcluster-1-zone2-c76d303299a9      2/2     Running   0          4m     10.10.10.1    node-x   <none>           <none>
   obcluster-1-zone3-2cdf3cd8a05e      2/2     Running   0          4m     10.10.10.2    node-x   <none>           <none>
   obcluster-1-zone1-94904330202f      2/2     Running   0          4m     10.10.10.3    node-x   <none>           <none>
   ```

2. OceanBaseクラスタへの接続

   任意のノードの IP アドレスを使用して OceanBaseクラスタに接続できます。接続コマンドは以下の通りです。

   ```shell
   mysql -h10.10.10.1 -P2881 -uroot@sys -p oceanbase -A -c
   ```

tab ODP経由でのOceanBaseクラスタへの接続

1. ODPサービスアドレスの取得

   ODPクラスタのデプロイ完了後、以下のコマンドを使用してODPのサービスアドレスを取得できます。

   ```shell
   kubectl get svc svc-obproxy-obcluster -n oceanbase
   ```

   出力例：

   ```shell
   NAME                      TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE
   svc-obproxy-obcluster     ClusterIP   10.10.10.4   <none>        2883/TCP,2884/TCP   97s
   ```

2. OceanBaseクラスタへの接続

   取得したサービスアドレスを使用して OceanBaseクラスタに接続します。コマンドは以下の通りです。

   ```shell
   mysql -h10.10.10.4 -P2883 -uroot@sys#obcluster -p
   ```

:::

## OceanBase Dashboard のデプロイ

OceanBase Dashboardは、ob-operatorと連携するGUI運用ツールであり、クラスター管理、テナント管理、バックアップ管理、パフォーマンス監視、OBProxy管理、ターミナル接続などの機能を備えています。

### OceanBase Dashboard のインストール

OceanBase Dashboardのインストール方法には、以下の2通りがあります。

:::tab

tab okctlツールを使用したインストール

okctlはOceanBase Dashboardをインストールするコマンドを提供しています。okctlがインストール済みであることを確認した後、以下のコマンドを実行してOceanBase Dashboardをインストールしてください。

```shell
okctl install ob-dashboard
```

tab Helmを使用したインストール

Helmがインストール済みであることを確認した後、以下の3つのコマンドを実行すると、デフォルトのネームスペースにOceanBase Dashboardがインストールされます。

```shell
helm repo add ob-operator https://oceanbase.github.io/ob-operator/
helm repo update ob-operator
helm install oceanbase-dashboard ob-operator/oceanbase-dashboard
```

他のネームスペースにインストールしたい場合は、最後のインストールコマンドを以下のように置き換えてください。

```shell
helm install oceanbase-dashboard ob-operator/oceanbase-dashboard -n <namespace> --create-namespace
```

ここで、`<namespace>` には OceanBase Dashboard のインストール先となるネームスペースを指定します。対象のネームスペースが存在しない場合は、`--create-namespace` を追加することで作成できます。また、ご利用のクラスターが LoadBalancer サービスをサポートしている場合は、インストール時に `--set service.type=LoadBalancer` を設定することで、LoadBalancer タイプのサービスを作成するように指定できます。

:::

インストールコマンドの実行後、以下のコマンドで OceanBase Dashboard のインストールが完了したか確認できます。

```shell
kubectl get deployment oceanbase-dashboard-oceanbase-dashboard
```

出力結果は以下の通りです。`READY` 列が `1/1` と表示されていればインストールは完了しており、以降の操作が可能です。

```shell
NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
oceanbase-dashboard-oceanbase-dashboard   1/1     1            1           2m10s
```

### OceanBase Dashboardへのアクセス

OceanBase Dashboardの初期ログインアカウントとパスワードは、いずれも `admin` です。デフォルトのアカウントとパスワードでログインすると、パスワードの変更が求められます。

OceanBase Dashboardにアクセスするには、以下の3つの方法があります。実際の環境に合わせて適切な方法を選択してください。

- NodePort経由でのアクセス：OceanBase DashboardはデフォルトでNodePortタイプのサービスを作成するため、NodePort経由でアクセスできます。

- LoadBalancer経由でのアクセス：ご利用のクラスターがLoadBalancerサービスをサポートしている場合、LoadBalancer経由でアクセスできます。

- Port Forwardによる一時的なアクセス：クラスターノードのポートに直接アクセスできず、上記2つの方法が利用できない場合、Port Forwardを使用して一時的にアクセスできます。

:::tab

tab NodePort 経由でのアクセス

OceanBase Dashboard はデフォルトで NodePort タイプのサービスを作成します。以下のコマンドを実行することで、サービスがノード上で公開しているポートを取得できます。なお、サービス名は指定した Helm Chart 名によって変化することに注意してください。具体的なサービス名は、OceanBase Dashboard インストール時の出力（最初の行）を参照してください。本記事の例では `oceanbase-dashboard-oceanbase-dashboard` とします。

```shell
kubectl get svc oceanbase-dashboard-oceanbase-dashboard
```

出力例：

```shell
NAME                                      TYPE       CLUSTER-IP   EXTERNAL-IP  PORT(S)        AGE
oceanbase-dashboard-oceanbase-dashboard   NodePort   10.10.10.1   <none>       80:30176/TCP   13m
```

ブラウザから対象 K8sノードの `PORT`（例では 30176）にアクセスすることで、OceanBase Dashboard のログイン画面を開くことができます。サービスのポート番号はK8sによって動的に割り当てられます。また、ノードIPは `kubectl get nodes -o wide` コマンドを実行して確認できます。

tab LoadBalancer経由でのアクセス

OceanBase Dashboard のインストール時にLoadBalancerタイプのサービス作成を指定することも可能ですが、インストール後に以下のコマンドを実行してサービスタイプをLoadBalancerに変更することもできます。

```shell
kubectl patch -n oceanbase-dashboard svc oceanbase-dashboard-oceanbase-dashboard --type=merge --patch='{"spec": {"type": "LoadBalancer"}}'
```

変更完了後、クラスターはOceanBase Dashboardサービスに対して外部IPを割り当てます。この外部IPを使用してOceanBase Dashboardのページにアクセスできます。変更後、しばらく待ってから再度サービス情報を確認すると、External IPフィールドに値が割り当てられているのが確認できます。

```shell
kubectl get svc oceanbase-dashboard-oceanbase-dashboard
```

出力例：

```shell
NAME                                      TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)        AGE
oceanbase-dashboard-oceanbase-dashboard   LoadBalancer   10.10.10.1      10.10.10.2     80:18082/TCP   1d5h
```

ブラウザに `http://10.10.10.2:18082` と入力すると、OceanBase Dashboard にアクセスできます。ここでは `EXTERNAL-IP` が `10.10.10.2`、`PORT` が `18082` である場合を例としています。実際の出力結果に合わせて値を置き換えてください。

tab Port Forwardによる一時的なアクセス

クラスターノードのポートに直接アクセスできず、NodePortタイプのサービスでOceanBase Dashboardを公開できない、かつLoadBalancerサービスもサポートされていない場合は、`kubectl port-forward` コマンドを使用して ceanBase Dashboardを現在のマシンの指定ポートに公開し、一時的にアクセスすることができます。例えば、以下のコマンドを実行すると、現在のマシン（このコマンドを実行しているマシン）の `18081` ポートにOceanBase Dashboardを公開できます。

```shell
kubectl port-forward -n default services/oceanbase-dashboard-oceanbase-dashboard 18081:80 --address 0.0.0.0
```

他のPCのブラウザから、そのマシン（コマンドを実行したマシン）の `18081` ポートにアクセスすると、ログイン画面を開くことができます。もし上記のコマンドを実行したのがご自身の PC である場合は、ブラウザで `http://127.0.0.1:18081` にアクセスすればサービスを利用できます。

:::

### モニタリング指標の確認

OceanBase Dashboardページにアクセス後、左側の **クラスタ** と **テナント** をクリックして、クラスタまたはテナントの監視情報を選択して確認することができます。ページ表示例を以下に示します。

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p>クラスタとテナントのパフォーマンス指標監視機能に加え、OceanBase Dashboardは、クラスタ管理、テナント管理、バックアップ管理、端末接続などのOceanBaseクラスタ運用保守に便利な機能を提供します。</p>
</main>

クラスタ監視指標については、以下のとおりです：

<!-- ![クラスタ監視指標](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.3.0/400.deploy/500.community/300.deploy-in-the-k8s-cluster-01.png) -->

テナント監視指標については、以下のとおりです：

<!-- ![テナント監視メトリクス](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.3.0/400.deploy/500.community/300.deploy-in-the-k8s-cluster-02.png) -->

## 関連ドキュメント

- [テナントの作成](https://en.oceanbase.com/docs/community-ob-operator-doc-en-10000000001195672)

- [GitHubドキュメント](https://oceanbase.github.io/ob-operator/zh-Hans/)

- [GitHubコードリポジトリ](https://github.com/oceanbase/ob-operator)
