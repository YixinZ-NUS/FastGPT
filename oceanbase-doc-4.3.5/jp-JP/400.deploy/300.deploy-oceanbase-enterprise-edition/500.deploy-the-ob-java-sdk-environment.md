|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# OceanBaseデータベースのJava SDK環境を構築する

OceanBaseデータベースは、外部テーブルのサードパーティデータソースとしてファイルシステムと接続するために、Java SDKとの連携に対応しています。この機能はJNI (Java Native Interface)フレームワークを使用して実装されているため、OceanBaseデータベースの環境にはJava SDKの構築が必要です。

## 環境の設定

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>HDFS/ODPS外部テーブル機能を使用する場合、OceanBaseデータベースが分散デプロイされている環境では、すべてのマシンノードで以下のJava環境のデプロイと依存関係のインストールを行う必要があります。単一のノードだけに設定することはできません。</p>
</main>

すべての環境構成と依存関係のインストールは、adminユーザーとして実行する必要があります。次のコマンドでユーザーを切り替えてください：

```bash
su - admin
```

### Java環境のデプロイと設定

1. [ダウンロード先](https://www.openlogic.com/openjdk-downloads)からOpenJDK JAVAのインストールパッケージをダウンロードします。

    <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>OpenJDK 8の最新バージョンを使用してください。</p>
    </main>

    本記事では、OpenJDK 8u422-b05バージョンのダウンロード手順を例に説明します。具体的な操作手順は以下のとおりです。

    ```shell
    [admin@xxx /home/admin/rpm]# wget https://builds.openlogic.com/downloadJDK/openlogic-openjdk/8u422-b05/openlogic-openjdk-8u422-b05-linux-x64.tar.gz
    ```

2. 対応するインストールパッケージを正常に解凍します。

    例は以下のとおりです。

    ```shell
    [admin@xxx /home/admin/rpm]# tar -zxvf openlogic-openjdk-8u422-b05-linux-x64.tar.gz
    ```

    ```shell
    [admin@xxx /home/admin/rpm]# ls openlogic-openjdk-8u422-b05-linux-x64
    ASSEMBLY_EXCEPTION  LICENSE  THIRD_PARTY_README  bin  demo  include  jre  lib  man  release  sample  src.zip
    ```

    インストールパスは以下のとおりです。

    ```shell
    /home/admin/rpm/openlogic-openjdk-8u422-b05-linux-x64
    ```

    <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>このパスは、現在のOBServerノードでJavaのホームディレクトリを設定するためのものです。これは、対応する構成パラメータob_java_homeの値に相当します。</p>
    </main>

### 依存関係のインストール

OceanBaseデータベースは、HDFS/ODPS外部テーブル機能を使用するには、以下のコンポーネントに依存します。

* devdeps-hdfs-sdk RPMパッケージ：

  このパッケージには、HDFS/ODPSなどの外部テーブルの実行に必要な共有ライブラリが含まれています。JVM環境とJNI（Java Native Interface）との相互作用を提供するためのコアインターフェースを備えています。このコンポーネントは、Java仮想マシンとローカル外部テーブル用Java SDKとの通信の橋渡しとして機能し、外部テーブル機能の安定した動作を保証します。

* devdeps-java-extensions RPMパッケージ：

  このパッケージは、HDFS 外部表や ODPS などのその他の外部データソースに必要な主要依存ライブラリ（JAR ファイル）を統合したものです。拡張パッケージには、完全な Java 実行時の依存チェーンが含まれており、分散環境における外部表機能の互換性とパフォーマンスの最適化を確保します。

#### 依存ライブラリHDFS.soのデプロイと設定

1. devdeps-hdfs-sdk RPMインストールパッケージを取得します。

    * Enterprise Editionのユーザーは、サポートチームまでお問い合わせください。devdeps-hdfs-sdk RPMインストールパッケージを取得できます。
    * Community Editionのユーザーは、[Alibaba Cloud OceanBaseイメージ](https://mirrors.aliyun.com/oceanbase/)ページの`development-kit/`ディレクトリをクリックし、開発ツールリソースディレクトリに移動して、devdeps-hdfs-sdk RPMインストールパッケージをダウンロードできます。

2. インストールパッケージを取得した後、次のコマンドを使用してインストールします。

    ```shell
    sudo rpm -Uvh devdeps-hdfs-sdk-3.3.6-xxxxx.xxx.xxx.rpm
    ```

    例：

    ```shell
    sudo rpm -Uvh devdeps-hdfs-sdk-3.3.6-112024123116.el7.x86_64.rpm
    ```

3. インストールが予想通りに完了したか確認します。

    `libhdfs.so`と`libhdfs.so.0.0.0`ファイルが存在し、それらのソフトウェアリンクが正常である必要があります。

    例：

    ```shell
    $ll /usr/local/oceanbase/deps/devel/lib
    total 376
    lrwxrwxrwx 1 root root     16 Dec 24 19:49 libhdfs.so -> libhdfs.so.0.0.0
    -rwxr-xr-x 1 root root 384632 Dec 24 19:09 libhdfs.so.0.0.0
    ```

#### 依存するjarパッケージのパス設定

1. devdeps-java-extensions RPMインストールパッケージを取得します。

    * Enterprise Editionのユーザーは、サポートチームに連絡してdevdeps-java-extensions RPMインストールパッケージを取得してください。
    * Community Editionのユーザーは、[Alibaba Cloud OceanBaseイメージ](https://mirrors.aliyun.com/oceanbase/)ページの`development-kit/`ディレクトリをクリックし、開発ツールリソースディレクトリに移動して、devdeps-java-extensions RPMインストールパッケージをダウンロードします。

      <main id="notice" type='notice'>
        <h4>注意</h4>
        <p><ul>
          <li>OceanBaseデータベースV4.3.5 BP1および以前のバージョン：1.0.0バージョンのdevdeps-java-extensions RPMインストールパッケージをダウンロードしてください。</li>
          <li>OceanBaseデータベースV4.3.5 BP2以降のバージョン：1.0.1バージョンのdevdeps-java-extensions RPMインストールパッケージをダウンロードしてください。</li>
          <li>OceanBaseデータベースV4.4.0バージョン：1.0.1バージョンのdevdeps-java-extensions RPMインストールパッケージをダウンロードしてください。</li></ul></p>
      </main>

2. インストールパッケージを取得したら、次のコマンドを実行してインストールします。

    ```shell
    sudo rpm -Uvh devdeps-java-extensions-x.x.x-xxxxxxxxxxxx.xxx.xxxxxx.rpm --prefix=/user_install_directory
    ```

    例は次のとおりです。

    ```shell
    sudo rpm -Uvh devdeps-java-extensions-1.0.0-122025032514.el7.x86_64.rpm --prefix=/home/admin/oceanbase
    ```

3. インストールが期待どおりに実行されているかを確認します。

    インストールパス`/home/admin/oceanbase/jni_packages/v1.0.0`配下の`oceanbase-odps-connector-jar-with-dependencies.jar`ファイルが存在するか確認します。

    例は次のとおりです。

    ```shell
    $ll /home/admin/oceanbase/jni_packages/v1.0.0
    total 52756
    drwxr-sr-x 4 root root     4096 Dec 24 20:25 hadoop
    drwxr-xr-x 3 root root     4096 Dec 24 20:25 lib
    -rw-r--r-- 1 root root 54008720 Dec 24 19:52 oceanbase-odps-connector-jar-with-dependencies.jar
    ```

    <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>このパスは、OBServer 起動時に JVM が読み込む実行可能な依存 JAR パッケージのパスを設定するためのものです。これは、対応する構成パラメータob_java_connector_pathの値に相当します。</p>
    </main>

## （オプション）observerプロセスを再起動する

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p><ul><li>JAVA SDK環境を初めて使用する場合は、observerプロセスの再起動は不要です。</li><li>現在のOBServerがサポートするJNI関連の設定は、柔軟かつ即時に変更・反映することはできません。そのため、Java環境変数の設定を変更する必要がある場合は、observerプロセスを再起動する必要があります。</li></ul></p>
</main>

HDFS/ODPS外部テーブル機能を使用する場合、対応するOBServerサーバーの設定が必要です。設定手順は以下のとおりです。

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>以下のすべての設定はクラスタレベルの設定であり、一度設定すれば全ノードで適用されます。個別ノードごとに設定する必要はありません。</p>
</main>

### ステップ1：Java実行環境に関する構成パラメータを構成する

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>以下の設定はすべてsysテナントで実行します。</p>
</main>

1. Java環境を有効にし、外部テーブルのSDK（Java SDK）へのアクセスを許可します。

    **例：**

    ```sql
    ALTER SYSTEM SET ob_enable_java_env = true;
    ```

    この設定の詳細については、ob_enable_java_envを参照してください。

2. 現在のOBServerノードで実行されているJavaのホームディレクトリを設定します。

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>このパスは、OpenJDK Javaのインストールパスから取得します。</p>
    </main>

    **例：**

    ```sql
    ALTER SYSTEM SET ob_java_home = "/home/admin/rpm/openlogic-openjdk-8u422-b05-linux-x64";
    ```

    この設定の詳細については、ob_java_homeを参照してください。

3. OBServer起動時のJVMがロードできる実行可能な依存JARファイルのパスを設定します。

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>このパスは、JARパッケージのRPMインストールパスから取得します。</p>
    </main>

    **例：**

    ```sql
    ALTER SYSTEM SET ob_java_connector_path = "/home/admin/oceanbase/jni_packages/v1.0.0";
    ```

    この設定の詳細については、ob_java_connector_pathを参照してください。

4. Java環境の起動に関連する設定を設定します。

   1. 対応するログフォルダのパスを作成します。

       ```shell
       mkdir -p /home/user/jvmlogs
       mkdir -p /home/user/jvmlogs/heapdumps
       ```

   2. Java実行時のJVM起動設定を設定します。

       **例：**

       ```sql
       ALTER SYSTEM SET ob_java_opts="-Xmx2048m -Xmn2048m -XX:-CriticalJNINatives -Djdk.lang.processReaperUseDefaultStackSize=true -Xrs -XX:+HeapDumpOnOutOfMemoryError -Xloggc:/home/admin/gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/home/admin/heapdumps/ -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+CMSClassUnloadingEnabled -XX:+TieredCompilation -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses ";
       ```

       この設定の詳細については、ob_java_optsを参照してください。

       <main id="notice" type='notice'>
         <h4>注意</h4>
         <p><ul><li>この設定を変更するには、observerプロセスを再起動する必要があります。現在のHDFS接続では、HDFSデータストリームを直接C++メモリヒープにコピーしているため、<code>-Xmx2048m -Xms2048m</code>の設定を適宜削減できます。</li><li>GCログファイルは、設定フォルダのパスが存在する場合にのみ生成されます。パスが存在しない場合は、生成されません。</li></ul></p>
       </main>

5. （オプション）ODPS用のJava SDK設定を設定します。

    <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>HDFS用Java SDKではこの設定は不要ですが、その他の設定はすべて同じです。</p>
    </main>

    Java SDKを使用するには、`_use_odps_jni_connector`を`true`に設定する必要があります。

    ```sql
    ALTER SYSTEM SET _use_odps_jni_connector = true;
    ```

### ステップ2（オプション）：sudo権限がない場合のhdfs-sdkパッケージの解凍

1. 現在の環境で`sudo`権限を使用してインストールコマンドを実行できない場合は、次の方法でdevdeps-hdfs-sdk RPMインストールパッケージを手動で解凍できます。必要に応じて、必要なパスに配置できます。

   ```bash
   rpm2cpio devdeps-hdfs-sdk-3.3.6-xxxxx.xxx.xxx.rpm | cpio -idmv
   ```

2. 解凍されたファイルを、ユーザーがアクセスできるカスタムパス（例`~/hdfs_lib`）に移動します。

   ```bash
   mv ./usr/local/oceanbase/deps/devel/lib/* ~/hdfs_lib/
   ```

3. OceanBaseのパス変数を設定します。

   sysテナントにログインし、次のコマンドを実行して、カスタムパスをシステム設定に登録します。

   ```sql
   ALTER SYSTEM SET _ob_additional_lib_path = './usr/local/oceanbase/deps/devel/lib/* ~/hdfs_lib/';
   ```

### ステップ3：observerプロセスの再起動

すべてのマシンのobserverプロセスを停止し、再び起動します。

1. `admin`ユーザーに切り替えます。

    ```shell
    [admin@xxx /home/admin/oceanbase/etc]# su - admin
    ```

2. observerプロセスを停止します。

    ```shell
    -bash-4.2$ kill -9 `pidof observer`
    ```

3. observerプロセスを再起動します。

    ```shell
    -bash-4.2$ cd /home/admin/oceanbase && /home/admin/oceanbase/bin/observer
    ```

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>observerプロセスを再度起動するには、起動パラメータを指定する必要はありません。以前の起動パラメータはすでにパラメータファイルに記録されています。</p>
    </main>

<!-- ## 関連ドキュメント

ODPS 外部テーブルの作成に関する詳細については、[外部テーブルの作成（MySQL モード）](../../700.reference/300.database-object-management/100.manage-object-of-mysql-mode/200.manage-tables-of-mysql-mode/1000.manage-external-tables-of-mysql-mode/200.create-a-external-table-of-mysql-mode.md) または [外部テーブルの作成（Oracle モード）](../../700.reference/300.database-object-management/200.manage-object-of-oracle-mode/100.manage-tables-of-oracle-mode/1000.manage-external-tables-of-oracle-mode/200.create-a-external-table-of-oracle-mode.md) を参照してください。 -->
