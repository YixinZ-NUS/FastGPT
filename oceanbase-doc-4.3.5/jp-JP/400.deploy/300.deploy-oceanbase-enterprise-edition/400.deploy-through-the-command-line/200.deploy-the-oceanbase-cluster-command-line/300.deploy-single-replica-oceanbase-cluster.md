|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# コマンドラインを使用した1レプリカOceanBaseクラスタのデプロイ

OceanBaseは1レプリカデプロイをサポートしています。1レプリカOceanBaseクラスタは拡張(ノードの追加)が可能なため、クラスタとも呼ばれています。

この記事では、コマンドラインを使用して1レプリカOceanBaseクラスタをデプロイする方法について説明します。

## 前提条件

OceanBaseデータベースをインストールする前に、以下の情報を確認する必要があります：

* OBServerサーバーの設定が完了していること。詳細については、[サーバー設定](../../200.preparations-before-deploy/200.configure-servers.md)および [oatcliを使用したOBServerサーバーの初期化](../100.configure-a-deployment-environment-command-line/100.initializing-the-observer-server-using-oatcli.md)を参照してください。

* OceanBaseデータベースのRPMパッケージを取得していること。詳細については、[インストールパッケージの準備](../../200.preparations-before-deploy/300.prepare-installation-packages.md)を参照してください。

## 操作手順

### ステップ1：RPMパッケージのインストール

1. OceanBaseデータベースのRPMパッケージをインストールします。

   ここで `$rpm_dir` はRPMパッケージを格納しているディレクトリを表し、`$rpm_name` はRPMパッケージの名前を表します。

   ```bash
   [root@xxx /]# cd $rpm_dir
   [root@xxx $rpm_dir]# rpm -ivh $rpm_name
   ```

   <main id="notice" type='explain'>
     <h4>説明</h4>
     <p>OceanBaseデータベースソフトウェアはディレクトリ <code>/home/admin/oceanbase</code> にインストールされます。</p>
   </main>

   例：

   ```shell
   [root@xxx /home/admin/rpm]# rpm -ivh oceanbase-4.2.0.0-100000052023073123.el7.x86_64.rpm
   Preparing...                          ################################# [100%]
   Updating / installing...
      1:oceanbase-4.2.0.0-100000052023073################################# [100%]
   ```

2. OceanBaseクライアントをインストールします。

   OceanBaseインスタンスはOracleまたはMySQLと互換性があります。Oracleテナントの場合、Javaプログラムで接続するには、OceanBaseが提供するJavaドライバーファイル(oceanbase-client-*.jar)を使用する必要があります。コマンドラインからOracleテナントにアクセスするには、さらにOBClientクライアントをインストールする必要があります。

   OBClientはOceanBaseのコマンドラインクライアントで、OceanBaseのMySQLテナントとOracleテナントにアクセスできます。

   例：

   ```shell
   [root@xxx $rpm_dir]# rpm -ivh obclient-1.2.6-20210510164331.el7.alios7.x86_64.rpm

   ##インストールの成功確認##
   [root@xxx $rpm_dir]# which obclient
   /usr/bin/obclient
   ```

### ステップ2：ディレクトリの設定

1. OceanBaseディレクトリをクリーンアップします(初回デプロイ時は不要)。

   以前のOceanBase環境をクリーンアップする場合、またはOceanBaseのインストールとデプロイ中に問題が発生し、環境が乱れたり、次回のインストールに影響を与えるファイルが生成されたりした場合、古いOceanBaseディレクトリを直接クリーンアップします。ここで、`$cluster_name` はクラスタ名です。

   ```shell
   [root@xxx admin]# su - admin
   -bash-4.2$ kill -9 `pidof observer`
   -bash-4.2$ rm -rf /data/1/$cluster_name
   -bash-4.2$ rm -rf /data/log1/$cluster_name
   -bash-4.2$ rm -rf /home/admin/oceanbase/store/$cluster_name /home/admin/oceanbase/log/* /home/admin/oceanbase/etc/*config*
   -bash-4.2$ ps -ef|grep observer
   ```

   例：

   ```shell
   [root@xxx admin]# su - admin
   -bash-4.2$ kill -9 `pidof observer`
   -bash-4.2$ rm -rf /data/1/obdemo
   -bash-4.2$ rm -rf /data/log1/obdemo
   -bash-4.2$ rm -rf /home/admin/oceanbase/store/obdemo /home/admin/oceanbase/log/* /home/admin/oceanbase/etc/*config*
   -bash-4.2$ ps -ef|grep observer
   ```

2. OceanBaseディレクトリを初期化します。

   OceanBaseのデータディレクトリは、通常、独立したディスク上に配置し、シンボリックリンクによってソフトウェアのホームディレクトリにリンクすることを推奨します。ここで、`$cluster_name` はクラスタ名です。

   <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>OceanBaseデータベースは、V4.3.0バージョンから、<code>slog</code> をデータ(data)ディスクから独立させることをサポートしています。つまり、<code>slog</code> とデータファイルを同じディスク上に存在する必要はありません。使用するディスクを設定して、<code>slog</code> と <code>clog</code> で同じSSDソリッドステートドライブを共有できます。OceanBaseデータベースのインストールディレクトリに関する詳細は、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971319">OBServerノードのインストールディレクトリ構造</a>を参照してください。</p>
   </main>

   ```shell
   [root@xxx admin]# su - admin
   -bash-4.2$ mkdir -p /data/1/$cluster_name/{etc3,sstable,slog}
   -bash-4.2$ mkdir -p /data/log1/$cluster_name/{clog,etc2}
   -bash-4.2$ mkdir -p /home/admin/oceanbase/store/$cluster_name
   -bash-4.2$ for t in {etc3,sstable,slog};do ln -s /data/1/$cluster_name/$t /home/admin/oceanbase/store/$cluster_name/$t; done
   -bash-4.2$ for t in {clog,etc2};do ln -s /data/log1/$cluster_name/$t /home/admin/oceanbase/store/$cluster_name/$t; done
   ```

   例：

   ```shell
   [root@xxx admin]# su - admin
   -bash-4.2$ mkdir -p /data/1/obdemo/{etc3,sstable,slog}
   -bash-4.2$ mkdir -p /data/log1/obdemo/{clog,etc2}
   -bash-4.2$ mkdir -p /home/admin/oceanbase/store/obdemo
   -bash-4.2$ for t in {etc3,sstable,slog};do ln -s /data/1/obdemo/$t /home/admin/oceanbase/store/obdemo/$t; done
   -bash-4.2$ for t in {clog,etc2};do ln -s /data/log1/obdemo/$t /home/admin/oceanbase/store/obdemo/$t; done
   ```

   <main id="notice" type='explain'>
     <h4>説明</h4>
     <p><code>obdemo</code> はクラスタ名で作成されるディレクトリで、カスタマイズ可能です。プロセスの起動時に使用されます。</p>
   </main>

   結果のチェック：

   ```shell
   -bash-4.2$ cd /home/admin/oceanbase
   -bash-4.2$ tree store/
   store/
   `-- obdemo
    |-- clog -> /data/log1/obdemo/clog
    |-- etc2 -> /data/log1/obdemo/etc2
    |-- etc3 -> /data/1/obdemo/etc3
    |-- slog -> /data/1/obdemo/slog
    `-- sstable -> /data/1/obdemo/sstable

   6 directories, 0 files
   ```

### ステップ3：OceanBaseクラスタの初期化

<main id="notice" type='explain'>
   <h4>説明</h4>
   <p>例に示すIPアドレスは匿名化処理されていますが、インストールの要件ではありません。デプロイ時には、ご自身のマシンの実際のIPアドレスを入力してください。</p>
</main>

1. observerプロセスを起動します。

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>observerプロセスは <code>admin</code> ユーザーで起動する必要があります。</p>
   </main>

   OceanBaseデータベースは、指定されたノードのIPアドレスとしてIPv4またはIPv6アドレスを使用したobserverプロセスの起動をサポートします。

   **IPv4を使用したobserverプロセスの起動：**

   ```shell
   cd /home/admin/oceanbase && /home/admin/oceanbase/bin/observer {-I $ip | -i $devname} -P $rpc_port -p $sql_port -z $zone_name -d /home/admin/oceanbase/store/$cluster_name -r '$ip:2882:2881' -c $cluster_id -n $cluster_name -o "system_memory=30G,datafile_size=500G,config_additional_dir=/data/1/$cluster_name/etc3;/data/log1/$cluster_name/etc2"
   ```

   **IPv6を使用したobserverプロセスの起動：**

   ```shell
   cd /home/admin/oceanbase && /home/admin/oceanbase/bin/observer -6 {-I $ip | -i $devname} -P $rpc_port -p $sql_port -z $zone_name -d /home/admin/oceanbase/store/$cluster_name -r '[$ip]:2882:2881' -c $cluster_id -n $cluster_name -o "system_memory=30G,datafile_size=500G,config_additional_dir=/data/1/$cluster_name/etc3;/data/log1/$cluster_name/etc2"
   ```

   **パラメータの説明：**

   |**パラメータ**|               **説明**     |
   |--------|----------------------------|
   | `-6`   | observerプロセスをIPv6で起動する場合は、`-6` を指定する必要があります。|
   | `-I` \| `-i`   | <ul><li>`-I`：起動するノードのIPアドレスを指定します。マルチマシンデプロイシナリオでは、127.0.0.1をターゲットIPアドレスとして指定することはできません。IPアドレス(例：`-I 10.10.10.1`)を指定してノードを起動することを推奨します。</li><li>`-i`：NIC名を指定します。`ifconfig` コマンドで確認できます。</li></ul><main id="notice" type='explain'><h4>説明</h4><p>IPアドレスとNIC名を同時に指定して(例：`-I 10.10.10.1 -i eth0`)ノードを起動することもできますが、非推奨です。</p></main>|
   | `-p`   | サービスポート番号を指定します。通常は `2881` を指定します。|
   | `-P`   | RPCポート番号を指定します。通常は `2882` を指定します。|
   | `-n`   | クラスタ名を指定します。カスタマイズ可能です。クラスタ名が重複しなければ問題ありません。|
   | `-z`   | 起動するobserverプロセスが所属するZoneを指定します。|
   | `-d`   | クラスタのメインディレクトリを指定します。初期化時に作成したディレクトリです。クラスタ名 `$cluster_name` 以外は変更しないでください。|
   | `-c`   | クラスタIDを指定します。一組の数字で、カスタマイズ可能です。異なるクラスタ間で重複しなければ問題ありません。|
   | `-l`   | ログレベルを指定します。|
   | `-r`   | RSリストを指定します。形式は `$ip:2882:2881` で、セミコロン(;)で区切ります。Root Service情報を表します。<main id="notice" type='notice'><h4>注意</h4><p>IPv6を使用してobserverプロセスを起動する際は、IPアドレスを <code>[]</code> で囲む必要があります。</p></main>|
   | `-o`   | クラスタ起動パラメータ(構成パラメータ)リストを指定します。オプションです。複数の構成パラメータに値を指定できます。複数の構成パラメータの値はカンマ(,)で区切ります。必要に応じて、適切な起動パラメータを選択し、各パラメータに適切な値を指定して、クラスタのパフォーマンスとリソース利用率を最適化してください。以下はクラスタ起動時によく使用される構成パラメータです：<ul><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971812">cpu_count</a>：システムのCPU数の合計を設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971860">system_memory</a>：システムがテナントID <code>500</code> のテナント用に予約するメモリ容量、つまりOceanBaseデータベース内部の予約メモリを指定します。マシンのメモリが少ない場合は、この値を小さくすることを検討できます。ただし、パフォーマンステスト時にメモリ不足が発生する可能性があることに注意してください。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971998">memory_limit</a>：利用可能なメモリサイズの合計を設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971955">datafile_size</a>：データファイルが使用するディスクの使用可能容量のサイズを設定します。つまり、OceanBaseデータベースのデータファイル <code>sstable</code> のサイズを指定します(最初に初期化される)。<code>/data/1/</code> の空き容量に基づいて、<code>100 G</code> 以上を推奨します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971961">datafile_disk_percentage</a>：ディスクデータファイルがディスクの総容量に占める割合です。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971927">datafile_next</a>：ディスクデータファイルの自動拡張のステップサイズを設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971912">datafile_maxsize</a>：ディスクデータファイルの自動拡張の最大容量を設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971989">config_additional_dir</a>：ローカルに設定ファイルを保存する複数のディレクトリを設定し、冗長性のために複数の設定ファイルを保存します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971764">log_disk_size</a>：Redoログディスクのサイズを設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971945">log_disk_percentage</a>：Redoログがその配置されているディスクの総容量に占める割合を設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971791">syslog_level</a>：システムログレベルを設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971913">syslog_io_bandwidth_limit</a>：システムログが使用可能なディスクI/O帯域幅の上限を設定します。帯域幅の上限を超えるシステムログは破棄されます。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971824">max_syslog_file_count</a>：ログファイルを再利用する前に保持できるログファイルの数を設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971847">enable_syslog_recycle</a>：OBServerノード起動前の古いログを記録するかどうかのスイッチを設定します。<code>max_syslog_file_count</code> と組み合わせて使用して、再利用ロジックが古いログファイルを考慮するかどうかを決定します。</li></ul>上記の構成パラメータのうち、<code>datafile_size</code>、<code>datafile_disk_percentage</code>、<code>datafile_next</code>、<code>datafile_maxsize</code> を組み合わせて使用することで、ディスクデータファイルの自動拡張を実現できます。詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971412">ディスクデータファイルの動的拡張の設定</a>を参照してください。クラスタ設定に関する詳細は、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971260">構成パラメータの概要 - クラスタレベルの構成パラメータ</a>を参照してください。|

   **IPv4を使用したobserverプロセスの起動例：**

   ```shell
   [root@xxx /home/admin]# su - admin
   -bash-4.2$ cd /home/admin/oceanbase && /home/admin/oceanbase/bin/observer -I 10.10.10.1 -P 2882 -p 2881 -z zone1 -d /home/admin/oceanbase/store/obdemo -r '10.10.10.1:2882:2881' -c 10001 -n obdemo -o "system_memory=30G,datafile_size=500G,config_additional_dir=/data/1/obdemo/etc3;/data/log1/obdemo/etc2"
   ```

   以下のコマンドを使用して、observerプロセスが正常に起動したかどうかを確認することができます：

   * `netstat -ntlp` コマンドで、`2881` と `2882` ポートがリッスンされている場合、プロセスは正常に起動しています。
   * `ps -ef|grep observer` コマンドでobserverプロセスの情報を確認することができます。

   例：

   ```shell
   -bash-4.2$ netstat -ntlp
   (Not all processes could be identified, non-owned process info
   will not be shown, you would have to be root to see it all.)
   Active Internet connections (only servers)
   Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
   tcp        0      0 0.0.0.0:2881            0.0.0.0:*               LISTEN      11111/observer
   tcp        0      0 0.0.0.0:2882            0.0.0.0:*               LISTEN      11111/observer
   ...        ...    ...                       ...                     ...         ...

   -bash-4.2$ ps -ef|grep observer
   admin    11111      0 43 17:58 ?        00:00:14 /home/admin/oceanbase/bin/observer -I 10.10.10.1 -P 2882 -p 2881 -z zone1 -d /home/admin/oceanbase/store/obdemo -r 10.10.10.1:2882:2881 -c 10001 -n obdemo -o system_memory=30G,datafile_size=500G,config_additional_dir=/data/1/obdemo/etc3;/data/log1/obdemo/etc2
   ```

   **IPv6を使用したobserverプロセスの起動例：**

   ```shell
   [root@xxx /home/admin]# su - admin
   ```

   ```shell

   -bash-4.2$ cd /home/admin/oceanbase && /home/admin/oceanbase/bin/observer -6 -I xxxx:xxxx:xxxx:xxxx:xxx:xxxx:xxxx:ebd8 -P 2882 -p 2881 -z zone1 -d /home/admin/oceanbase/store/obdemo -r '[xxxx:xxxx:xxxx:xxxx:xxx:xxxx:xxxx:ebd8]:2882:2881' -c 10001 -n obdemo -o "system_memory=30G,datafile_size=500G,config_additional_dir=/data/1/obdemo/etc3;/data/log1/obdemo/etc2"
   ```

2. クラスタのbootstrap操作を実行します。

   1. OBClientクライアントを介して、起動済みのobserverプロセスに接続します。パスワードは空です。

      ```shell
      [root@xxx /home/admin]# obclient -h127.0.0.1 -uroot -P2881 -p******
      ```

   2. SQLの最大実行時間を設定します。

      ```sql
      obclient [(none)]> SET SESSION ob_query_timeout=1000000000;
      ```

   3. Root Serviceマシンのリストを指定して、クラスタを起動します。

      * IPv4アドレスを使用してRoot Serviceマシンのリストを指定し、クラスタを起動します。

         ```sql
         obclient [(none)]> ALTER SYSTEM BOOTSTRAP ZONE 'zone1' SERVER '10.10.10.1:2882';
         ```

      * IPv6アドレスを使用してRoot Serviceマシンのリストを指定し、クラスタを起動します。

         ```sql
         obclient [(none)]> ALTER SYSTEM BOOTSTRAP ZONE 'zone1' SERVER '[xxxx:xxxx:xxxx:xxxx:xxx:xxxx:xxxx:ebd8]:2882';
         ```

   <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>この手順でエラーが発生した場合、その原因として、observerプロセスの起動パラメータの誤り、OBServerノードの関連ディレクトリのパーミッションの問題、ログディレクトリの空き容量が一定の割合を下回っている(データディレクトリと共通の大容量のディレクトリを使用していて、容量がデータディレクトリに占有されている)、ノードのメモリリソースの不足などが考えられます。これらの問題点を先に調査してから、OceanBaseディレクトリをクリーンアップして、最初からやり直してください。</p>
   </main>

3. クラスタの初期化成功を検証します。

   クラスタのbootstrap初期化操作が完了してから、`SHOW DATABASES;` コマンドを実行して検証します。クエリ結果のデータベースリストに `oceanbase` データベースが表示されれば、クラスタの初期化は成功しています。

4. パスワードを変更します。

   `sys` テナントの `root` ユーザーのパスワードはデフォルトで空です。初期化が成功してから、パスワードを変更してください。

   ```sql
   ALTER USER root IDENTIFIED BY '******';
   ```

## 次の操作

クラスタの作成後、ビジネスのニーズに応じてユーザーテナントを作成することができます。

コマンドラインを使用したユーザーテナントの作成の詳細情報については、[テナントの作成](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971591)を参照してください。

## 関連ドキュメント

* [OBClientを使用したOceanBaseテナントへの接続](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971649)
* [システム構成パラメータの概要](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971260)
* [ALTER USER](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974184)
* [ユーザーテナントの紹介](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971103)
* [CREATE TENANT](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001972305)
