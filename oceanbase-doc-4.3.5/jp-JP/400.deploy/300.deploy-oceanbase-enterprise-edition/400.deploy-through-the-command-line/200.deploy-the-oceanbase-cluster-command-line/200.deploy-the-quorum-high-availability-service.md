|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# コマンドラインを使用した2レプリカ + アービトレーションサービスのOceanBaseクラスタのデプロイ

OceanBaseデータベースは、V4.1バージョンからアービトレーションサービス(Arbitration Service)をサポートしています。これにより、2リージョン3センター構成での同一都市内のレプリカ障害時のRT増大の問題を解決するだけでなく、都市を跨いだ帯域幅の使用量を削減し、第3データセンターのコストを極限まで低減できます。

この記事では、コマンドラインを使用して、2台のマシンから構成されるOceanBaseクラスタと1つのアービトレーションサービスをデプロイする方法について説明します。

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p><ul><li>1つのOceanBaseクラスタで使用できるアービトレーションサービスは1つのみです。</li><li>アービトレーションサービスは現在、スタンドアロンデプロイのみをサポートしています。</li></ul></p>
</main>

## 前提条件

OceanBaseデータベースをインストールする前に、以下の情報を確認する必要があります：

* OBServerサーバーの設定が完了していること。詳細については、[サーバー設定](../../200.preparations-before-deploy/200.configure-servers.md)、[(オプション)クロックソースの設定](../100.configure-a-deployment-environment-command-line/200.configure-host-information.md)および [oatcliを使用したOBServerサーバーの初期化](../100.configure-a-deployment-environment-command-line/100.initializing-the-observer-server-using-oatcli.md)を参照してください。

* OceanBaseデータベースのRPMパッケージを取得していること。詳細については、[インストールパッケージの準備](../../200.preparations-before-deploy/300.prepare-installation-packages.md)を参照してください。

## 操作手順

### ステップ1：OceanBaseクラスタのデプロイ

1. 2台のOBServerサーバーにそれぞれRPMパッケージをインストールします。

    1. OceanBaseデータベースのRPMパッケージをインストールします。

        OceanBaseデータベースのRPMパッケージが保存されているディレクトリに移動します：

        ```shell
        [root@xxx /]# cd $rpm_dir
        ```

        OceanBaseデータベースのRPMパッケージをインストールします：

        ```shell
        [root@xxx $rpm_dir]# rpm -ivh $rpm_name [--prefix=/home/admin/oceanbase]
        ```

        ここで `$rpm_dir` はRPMパッケージを格納しているディレクトリを表し、`$rpm_name` はRPMパッケージの名前を表します。

        <main id="notice" type='explain'>
            <h4>説明</h4>
            <p>OceanBaseデータベースソフトウェアは、デフォルトでディレクトリ <code>/home/admin/oceanbase</code> にインストールされます。</p>
        </main>

        **例：**

        ```shell
        [root@xxx /home/admin/rpm]# rpm -ivh oceanbase-4.2.0.0-100000052023073123.el7.x86_64.rpm
        Preparing...                          ################################# [100%]
        Updating / installing...
            1:oceanbase-4.2.0.0-100000052023073################################# [100%]
        ```

    2. (オプション) OceanBaseクライアントをインストールします。

         OceanBaseクライアントOBClientは、OceanBaseデータベース専用のコマンドラインクライアントツールです。OBClientを使用すると、OceanBaseデータベースのMySQLテナントとOracleテナントに接続できます。OceanBaseデータベースのMySQLテナントのみに接続する場合は、MySQLクライアント(mysql)を使用してOceanBaseデータベースに接続することもできます。

         <main id="notice" type='notice'>
            <h4>注意</h4>
            <p><code>obclient</code> V2.2.1以前のバージョンは <code>libobclient</code> に依存しているため、先に <code>libobclient</code> をインストールする必要があります。OBClientのRPMパッケージとlibobclientのRPMパッケージを入手するには、テクニカルサポートにお問い合わせください。</p>
         </main>

         **例：**

         ```shell
         [root@xxx /home/admin/rpm]# rpm -ivh obclient-2.2.1-20221122151945.el7.alios7.x86_64.rpm
         Preparing...                          ################################# [100%]
         Updating / installing...
            1:obclient-2.2.1-20221122151945.el7################################# [100%]
         ```

         インストールが成功したかどうかを確認します：

         ```shell
         [root@xxx /home/admin/rpm]# which obclient
         /usr/bin/obclient
         ```

2. observerプロセスのディレクトリを設定します。

   1. (オプション)ディレクトリをクリーンアップします。

      新しいマシンにOceanBaseデータベースを初めてデプロイする場合は、ディレクトリのクリーンアップは不要です。

      以下の場合は、古いOceanBaseディレクトリをクリーンアップします：

      * 以前のOceanBase環境をクリーンアップする場合。
      * OceanBaseのインストールとデプロイ中に問題が発生し、環境が乱れたり、次回のインストールに影響するファイルが生成されたりした場合。

      ```shell
      [root@xxx /home/admin]# kill -9 `pidof observer`
      [root@xxx /home/admin]# rm -rf /data/1/$cluster_name
      [root@xxx /home/admin]# rm -rf /data/log1/$cluster_name
      [root@xxx /home/admin]# rm -rf /home/admin/oceanbase/store/$cluster_name
      [root@xxx /home/admin]# rm -rf /home/admin/oceanbase/log/* /home/admin/oceanbase/etc/*config*
      ```

      ここで、`$cluster_name` はクラスタ名です。

      **例：**

      ```shell
      [root@xxx /home/admin]# kill -9 `pidof observer`
      [root@xxx /home/admin]# rm -rf /data/1/obdemo
      [root@xxx /home/admin]# rm -rf /data/log1/obdemo
      [root@xxx /home/admin]# rm -rf /home/admin/oceanbase/store/obdemo
      [root@xxx /home/admin]# rm -rf /home/admin/oceanbase/log/* /home/admin/oceanbase/etc/*config*
      ```

   2. OceanBaseディレクトリを初期化します。

      OceanBaseのデータディレクトリは、通常、独立したディスク上に配置し、シンボリックリンクによってソフトウェアのホームディレクトリにリンクすることを推奨します。

      <main id="notice" type='explain'>
         <h4>説明</h4>
         <p>OceanBaseデータベースは、V4.3.0バージョンから、<code>slog</code> をデータ(data)ディスクから独立させることをサポートしています。つまり、<code>slog</code> とデータファイルを同じディスク上に存在する必要はありません。使用するディスクを設定して、<code>slog</code> と <code>clog</code> で同じSSDソリッドステートドライブを共有できます。OceanBaseデータベースのインストールディレクトリに関する詳細は、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971319">OBServerノードのインストールディレクトリ構造</a>を参照してください。</p>
      </main>

      以下のコマンドを使用して `admin` ユーザーに切り替えます：

      ```shell
      [root@xxx /home/admin]# su - admin
      ```

      `admin` ユーザーで以下のコマンドを実行して、関連ディレクトリを作成します：

      ```shell
      mkdir -p /data/1/$cluster_name/{etc3,sstable,slog}
      ```

      ```shell
      mkdir -p /data/log1/$cluster_name/{clog,etc2}
      ```

      ```shell
      mkdir -p /home/admin/oceanbase/store/$cluster_name
      ```

      `admin` ユーザーで以下のコマンドを実行して、シンボリックリンクを作成します：

      ```shell
      for t in {etc3,sstable,slog};do ln -s /data/1/$cluster_name/$t /home/admin/oceanbase/store/$cluster_name/$t; done
      ```

      ```shell
      for t in {clog,etc2};do ln -s /data/log1/$cluster_name/$t /home/admin/oceanbase/store/$cluster_name/$t; done
      ```

      ここで、`$cluster_name` はクラスタ名です。

      **例：**

      ```shell
      [root@xxx /home/admin]# su - admin
      -bash-4.2$ mkdir -p /data/1/obdemo/{etc3,sstable,slog}
      -bash-4.2$ mkdir -p /data/log1/obdemo/{clog,etc2}
      -bash-4.2$ mkdir -p /home/admin/oceanbase/store/obdemo
      -bash-4.2$ for t in {etc3,sstable,slog};do ln -s /data/1/obdemo/$t /home/admin/oceanbase/store/obdemo/$t; done
      -bash-4.2$ for t in {clog,etc2};do ln -s /data/log1/obdemo/$t /home/admin/oceanbase/store/obdemo/$t; done
      ```

      <main id="notice" type='explain'>
         <h4>説明</h4>
         <p><code>obdemo</code> はクラスタ名で作成されるディレクトリで、カスタマイズ可能です。プロセスの起動時に使用されます。</p>
      </main>

      **結果のチェック：**

      ```shell
      -bash-4.2$ cd /home/admin/oceanbase
      -bash-4.2$ tree store/
      store/
      `-- obdemo
         |-- clog -> /data/log1/obdemo/clog
         |-- etc2 -> /data/log1/obdemo/etc2
         |-- etc3 -> /data/1/obdemo/etc3
         |-- slog -> /data/1/obdemo/slog
         `-- sstable -> /data/1/obdemo/sstable

      6 directories, 0 files
      ```

3. OceanBaseクラスタを初期化します。

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p><ul><li>例に示すIPアドレスは匿名化処理されていますが、インストールの要件ではありません。デプロイ時には、ご自身のマシンの実際のIPアドレスを入力してください。</li><li>OceanBaseデータベースは、指定されたIPv4またはIPv6アドレスのサーバー上でobserverプロセスを起動できます。この記事の例では、IPv4アドレス上でobserverプロセスを起動する方法を示しています。IPv6アドレス上でobserverプロセスを起動する方法については、<a href="300.deploy-single-replica-oceanbase-cluster.md">コマンドラインを使用した1レプリカOceanBaseクラスタのデプロイ</a>を参照してください。</li></ul></p>
    </main>

    1. observerプロセスを起動します。

        各ノードの `admin` ユーザーで、observerプロセスを起動します。

        <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>2レプリカでは、各ノードの起動パラメータは完全に同一ではありません。observerの起動時には、Root Serviceが配置されている2台(または複数台)のマシンのみを指定し、クラスタ作成時にすべてのマシンを指定する必要はありません。クラスタの作成後、新しいマシンを追加できます。</p>
        </main>

        ```shell
        cd /home/admin/oceanbase && /home/admin/oceanbase/bin/observer {-I $ip | -i $devname} -P $rpc_port -p $sql_port -z $zone_name -d /home/admin/oceanbase/store/$cluster_name -r '$ip:2882:2881' -c $cluster_id -n $cluster_name -o "system_memory=30G,datafile_size=500G,config_additional_dir=/data/1/$cluster_name/etc3;/data/log1/$cluster_name/etc2"
        ```

        **パラメータの説明：**

        |**パラメータ**|               **説明**     |
        |--------|----------------------------|
        | `-I` \| `-i`   | <ul><li>`-I`：起動するノードのIPアドレスを指定します。マルチマシンデプロイシナリオでは、127.0.0.1をターゲットIPアドレスとして指定することはできません。IPアドレス(例：`-I 10.10.10.1`)を指定してノードを起動することを推奨します。</li><li>`-i`：NIC名を指定します。`ifconfig` コマンドで確認できます。</li></ul><main id="notice" type='explain'><h4>説明</h4><p>IPアドレスとNIC名を同時に指定して(例：`-I 10.10.10.1 -i eth0`)ノードを起動することもできますが、非推奨です。</p></main>|
        | `-p`   | サービスポート番号を指定します。通常は `2881` を指定します。|
        | `-P`   | RPCポート番号を指定します。通常は `2882` を指定します。|
        | `-n`   | クラスタ名を指定します。カスタマイズ可能です。クラスタ名が重複しなければ問題ありません。|
        | `-z`   | 起動するobserverプロセスが所属するZoneを指定します。|
        | `-d`   | クラスタのメインディレクトリを指定します。初期化時に作成したディレクトリです。クラスタ名 `$cluster_name` 以外は変更しないでください。|
        | `-c`   | クラスタIDを指定します。一組の数字で、カスタマイズ可能です。異なるクラスタ間で重複しなければ問題ありません。|
        | `-l`   | ログレベルを指定します。|
        | `-r`   | RSリストを指定します。形式は `$ip:2882:2881` で、セミコロン(;)で区切ります。Root Service情報を表します。|
        | `-o`   | クラスタ起動パラメータ(構成パラメータ)リストを指定します。オプションです。複数の構成パラメータに値を指定できます。複数の構成パラメータの値はカンマ(,)で区切ります。必要に応じて、適切な起動パラメータを選択し、各パラメータに適切な値を指定して、クラスタのパフォーマンスとリソース利用率を最適化してください。以下はクラスタ起動時によく使用される構成パラメータです：<ul><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971812">cpu_count</a>：システムのCPU数の合計を設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971860">system_memory</a>：システムがテナントID <code>500</code> のテナント用に予約するメモリ容量、つまりOceanBaseデータベース内部の予約メモリを指定します。マシンのメモリが少ない場合は、この値を小さくすることを検討できます。ただし、パフォーマンステスト時にメモリ不足が発生する可能性があることに注意してください。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971998">memory_limit</a>：利用可能なメモリサイズの合計を設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971955">datafile_size</a>：データファイルが使用するディスクの使用可能容量のサイズを設定します。つまり、OceanBaseデータベースのデータファイル <code>sstable</code> のサイズを指定します(最初に初期化される)。<code>/data/1/</code> の空き容量に基づいて、<code>100 G</code> 以上を推奨します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971961">datafile_disk_percentage</a>：ディスクデータファイルがディスクの総容量に占める割合です。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971927">datafile_next</a>：ディスクデータファイルの自動拡張のステップサイズを設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971912">datafile_maxsize</a>：ディスクデータファイルの自動拡張の最大容量を設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971989">config_additional_dir</a>：ローカルに設定ファイルを保存する複数のディレクトリを設定し、冗長性のために複数の設定ファイルを保存します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971764">log_disk_size</a>：Redoログディスクのサイズを設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971945">log_disk_percentage</a>：Redoログがその配置されているディスクの総容量に占める割合を設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971791">syslog_level</a>：システムログレベルを設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971913">syslog_io_bandwidth_limit</a>：システムログが使用可能なディスクI/O帯域幅の上限を設定します。帯域幅の上限を超えるシステムログは破棄されます。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971824">max_syslog_file_count</a>：ログファイルを再利用する前に保持できるログファイルの数を設定します。</li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971847">enable_syslog_recycle</a>：OBServerノード起動前の古いログを記録するかどうかのスイッチを設定します。<code>max_syslog_file_count</code> と組み合わせて使用して、再利用ロジックが古いログファイルを考慮するかどうかを決定します。</li></ul> 上記の構成パラメータのうち、<code>datafile_size</code>、<code>datafile_disk_percentage</code>、<code>datafile_next</code>、<code>datafile_maxsize</code> を組み合わせて使用することで、ディスクデータファイルの自動拡張を実現できます。詳細については、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971412">ディスクデータファイルの動的拡張の設定</a>を参照してください。クラスタ設定に関する詳細は、<a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971260">構成パラメータの概要 - クラスタレベルの構成パラメータ</a>を参照してください。|

        **例：**

        OBServerサーバーでobserverプロセスを起動します。例として `10.10.10.1` と `10.10.10.2` を使用します。

        **zone1:**

        ```shell
        [root@xxx admin]# su - admin
        -bash-4.2$ cd /home/admin/oceanbase && /home/admin/oceanbase/bin/observer -I 10.10.10.1 -P 2882 -p 2881 -z zone1 -d /home/admin/oceanbase/store/obdemo -r '10.10.10.1:2882:2881;10.10.10.2:2882:2881' -c 10001 -n obdemo -o "system_memory=30G,datafile_size=500G,config_additional_dir=/data/1/obdemo/etc3;/data/log1/obdemo/etc2"
        ```

        **zone2:**

        ```shell
        [root@xxx admin]# su - admin
        -bash-4.2$ cd /home/admin/oceanbase && /home/admin/oceanbase/bin/observer -I 10.10.10.2 -P 2882 -p 2881 -z zone2 -d /home/admin/oceanbase/store/obdemo -r '10.10.10.2:2882:2881;10.10.10.2:2882:2881' -c 10001 -n obdemo -o "system_memory=30G,datafile_size=500G,config_additional_dir=/data/1/obdemo/etc3;/data/log1/obdemo/etc2"
        ```

        以下のコマンドを使用して、observerプロセスが正常に起動したかどうかを確認することができます：

        * `netstat -ntlp` コマンドで、`2881` と `2882` ポートがリッスンされている場合、プロセスは正常に起動しています。
        * `ps -ef|grep observer` コマンドでobserverプロセスの情報を確認することができます。

        **例：**

        ```shell
        -bash-4.2$ netstat -ntlp
        (Not all processes could be identified, non-owned process info
        will not be shown, you would have to be root to see it all.)
        Active Internet connections (only servers)
        Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
        tcp        0      0 0.0.0.0:2881            0.0.0.0:*               LISTEN      11112/observer
        tcp        0      0 0.0.0.0:2882            0.0.0.0:*               LISTEN      11112/observer
        ...        ...    ...                       ...                     ...         ...

        -bash-4.2$ ps -ef|grep observer
        admin     11112      0 40 16:18 ?        00:00:17 /home/admin/oceanbase/bin/observer -I 10.10.10.1 -P 2882 -p 2881 -z zone1 -d /home/admin/oceanbase/store/obdemo -r 10.10.10.1:2882:2881;10.10.10.2:2882:2881 -c 10001 -n obdemo -o system_memory=30G,datafile_size=500G,config_additional_dir=/data/1/obdemo/etc3;/data/log1/obdemo/etc2
        ```

    2. クラスタのbootstrap操作を実行します。

        OBClientコマンドを使用して任意のノードに接続します。パスワードは空です。

        ```shell
        [root@xxx admin]# obclient -h127.0.0.1 -uroot -P2881 -p******

        obclient [(none)]> SET SESSION ob_query_timeout=1000000000;
        Query OK, 0 rows affected

        obclient [(none)]> ALTER SYSTEM BOOTSTRAP ZONE 'zone1' SERVER '10.10.10.1:2882',ZONE 'zone2' SERVER '10.10.10.2:2882';
        Query OK, 0 rows affected
        ```

        <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>この手順でエラーが発生した場合、その原因として、observerプロセスの起動パラメータの誤り、observer関連ディレクトリのパーミッションの問題、ログディレクトリの空き容量が一定の割合を下回っている(データディレクトリと共通の大容量のディレクトリを使用していて、容量がデータディレクトリに占有されている)、ノード間の時刻同期の問題、ノードのメモリリソースの不足などが考えられます。これらの問題点を先に調査してから、OceanBaseディレクトリをクリーンアップして、最初からデプロイし直してください。</p>
        </main>

    3. クラスタの初期化成功を検証します。

        クラスタのbootstrap初期化操作が完了してから、`SHOW DATABASES;` コマンドを実行して検証します。クエリ結果のデータベースリストに `oceanbase` データベースが表示されれば、クラスタの初期化は成功しています。

    4. パスワードを変更します。

        `sys` テナントの `root` ユーザーのパスワードはデフォルトで空です。初期化が成功してから、パスワードを変更してください。

        ```sql
        ALTER USER root IDENTIFIED BY '******';
        ```

### ステップ2：アービトレーションサービスのデプロイ

1. アービトレーションサーバーにOceanBaseのRPMパッケージをインストールします。

   OceanBaseデータベースのRPMパッケージが保存されているディレクトリに移動します：

   ```shell
   [root@xxx /]# cd $rpm_dir
   ```

   OceanBaseデータベースのRPMパッケージをインストールします：

   ```shell
   [root@xxx $rpm_dir]# rpm -ivh $rpm_name [--prefix=/home/admin/oceanbase]
   ```

   ここで `$rpm_dir` はRPMパッケージを格納しているディレクトリを表し、`$rpm_name` はRPMパッケージの名前を表します。

   <main id="notice" type='explain'>
      <h4>説明</h4>
      <p>OceanBaseデータベースソフトウェアは、デフォルトでディレクトリ <code>/home/admin/oceanbase</code> にインストールされます。</p>
   </main>

   **例：**

   ```shell
   [root@xxx /home/admin/rpm]# rpm -ivh oceanbase-4.2.0.0-100000052023073123.el7.x86_64.rpm
   Preparing...                          ################################# [100%]
   Updating / installing...
      1:oceanbase-4.2.0.0-100000052023073################################# [100%]
   ```

2. アービトレーションサーバープロセスのディレクトリを設定します。

    アービトレーションサーバーにアービトレーションサーバープロセスの `clog` ディレクトリを作成します。

    <main id="notice" type='explain'>
      <h4>説明</h4>
      <p><ul><li>アービトレーションサーバープロセスの起動時に、<code>-d</code> オプションで指定する <code>store</code> ディレクトリ内に <code>clog</code> ディレクトリが事前に作成されていることを確認する必要があります。</li><li><code>store</code> ディレクトリが配置されているディスクの容量を完全に使い切らないようにする必要があります。そうしないと、アービトレーションサーバーの機能に異常が発生します。</li></ul></p>
    </main>

    以下のコマンドで `admin` ユーザーに切り替えます：

    ```shell
    [root@xxx /home/admin]# su - admin
    ```

    `admin` ユーザーで以下のコマンドを実行して、関連ディレクトリを作成します：

    ```shell
    mkdir -p /home/admin/oceanbase/store/clog
    ```

3. アービトレーションサーバープロセスを起動します。

    アービトレーションサーバーの `admin` ユーザーで、アービトレーションモードでアービトレーションサーバープロセスを起動し、必要な起動パラメータを指定します。起動コマンドは以下のとおりです：

    ```shell
    cd /home/admin/oceanbase && /home/admin/oceanbase/bin/observer -m arbitration -P $rpc_port -d $obdir/store [{-I $ip | -i $devname}] [-l $log_level]  [-o "parameters_list"]
    ```

    **パラメータの説明：**

    | **パラメータ** | **説明**    |
    |----------|-------------|
    | `-m`     | アービトレーションモードを指定します。値は `arbitration` です。|
    | `-P`     | アービトレーションサーバープロセスのRPCポート番号を指定します。通常は `2882` を指定します。|
    | `-d`     | ストレージディレクトリのパスを指定します。通常は `/home/admin/oceanbase/store` で、このディレクトリに `clog` サブディレクトリが作成済みであることを確認する必要があります。|
    | `-I` \| `-i`   | オプション。<ul><li>`-I`：起動するノードのIPアドレスを指定します。</li><li>`-i`：NIC名を指定します。`ifconfig` コマンドで確認できます。</li></ul><main id="notice" type='explain'><h4>説明</h4><p>IPアドレスとNIC名を同時に指定して(例：`-I 10.10.10.1 -i eth0`)ノードを起動することもできますが、非推奨です。</p></main>|
    | `-l`     | ログレベルを指定します。オプションです。デフォルト値は `WDIAG` です。値の範囲：{`DEBUG`, `TRACE`, `WDIAG`, `EDIAG`, `INFO`, `WARN`, `ERROR`}。ログに関する詳細情報は、[ログレベル](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971120)を参照してください。|
    | `-o`     | 構成パラメータリストを指定します。オプションです。複数の構成パラメータに値を指定できます。値はカンマ(,)で区切ります。以下はアービトレーションサーバープロセスの起動時によく使用される構成パラメータです：<ul><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971812">cpu_count</a> </li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971860">system_memory</a> </li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971998">memory_limit</a> </li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001973812">__easy_memory_limit</a> </li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971764">log_disk_size</a> </li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971945">log_disk_percentage</a> </li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971791">syslog_level</a> </li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971913">syslog_io_bandwidth_limit</a> </li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971824">max_syslog_file_count</a> </li><li> <a href="https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971847">enable_syslog_recycle</a> </li></ul>  <main id="notice" type='notice'><h4>注意</h4><p>アービトレーションノードのログディレクトリが自動的にクリーンアップされてディスクがいっぱいになるのを防ぐために、<code>enable_syslog_recycle</code> を <code>True</code> に設定し、<code>max_syslog_file_count</code> に有効な値を設定する必要があります。そうしないと、ログファイルが継続的に増加し、ディスク容量を使い果たす可能性があります。</p></main>|

    **例：**

    アービトレーションサーバーでアービトレーションサーバープロセスを起動します。例として `10.10.10.3` を使用します。

    ```shell
    -bash-4.2$ cd /home/admin/oceanbase && /home/admin/oceanbase/bin/observer -m arbitration -P 2882 -d /home/admin/oceanbase/store -I 10.10.10.3 -o "enable_syslog_recycle=True,max_syslog_file_count=100"
    ```

    以下のコマンドを使用して、observerプロセスが正常に起動したかどうかを確認することができます：

    * `netstat -ntlp` コマンドで、`2882` ポートがリッスンされている場合、プロセスは正常に起動しています。
    * `ps -ef|grep observer` コマンドでobserverプロセスの情報を確認することができます。

    **例：**

    ```shell
    -bash-4.2$ netstat -ntlp
    (Not all processes could be identified, non-owned process info
    will not be shown, you would have to be root to see it all.)
    Active Internet connections (only servers)
    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
    tcp        0      0 0.0.0.0:2882            0.0.0.0:*               LISTEN      18231/observer
    ...

    -bash-4.2$ ps -ef|grep observer
    admin     18231      0  3 10:33 ?        00:00:00 /home/admin/oceanbase/bin/observer -m arbitration -P 2882 -d /home/admin/oceanbase/store -I 10.10.10.3
    ...
    ```

### ステップ3：クラスタへのアービトレーションサービスの追加

クラスタにアービトレーションサービスを追加するコマンドは次のとおりです：

```sql
ALTER SYSTEM ADD ARBITRATION SERVICE "$arb_server_ip:$arb_server_port";
```

<main id="notice" type='explain'>
   <h4>説明</h4>
   <p>アービトレーションサーバープロセスのアドレスは、<code>sys</code> テナントの内部テーブルに記録され、ビュー <code>DBA_OB_ARBITRATION_SERVICE</code> で確認できます。このコマンドは同期操作です。</p>
</main>

**例：**

```shell
obclient [(none)]> ALTER SYSTEM ADD ARBITRATION SERVICE "10.10.10.3:2882";
Query OK, 0 rows affected

obclient [(none)]> SELECT * FROM oceanbase.DBA_OB_ARBITRATION_SERVICE;
+---------------------+---------------------+-------------------------+---------------------+------------------------------+------+
| CREATE_TIME         | MODIFY_TIME         | ARBITRATION_SERVICE_KEY | ARBITRATION_SERVICE | PREVIOUS_ARBITRATION_SERVICE | TYPE |
+---------------------+---------------------+-------------------------+---------------------+------------------------------+------+
| 2023-03-06 17:29:36 | 2023-03-06 17:29:36 | default                 | 10.10.10.3:2882     | NULL                         | ADDR |
+---------------------+---------------------+-------------------------+---------------------+------------------------------+------+
1 row in set
```

### ステップ4：sysテナントでのアービトレーションサービスの有効化

テナントの作成時にアービトレーションサービスを有効化できます。新しいテナントの作成時のアービトレーションサービスの有効化に関する詳細情報は、[CREATE TENANT](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001972305)を参照してください。

テナントの作成時にアービトレーションサービスを有効化しなかった場合、テナントの作成後にアービトレーションサービスを有効化することもできます。

既存のテナントでアービトレーションサービスを有効にするには、以下のコマンドを実行します。

```sql
ALTER TENANT $tenant_name [SET] enable_arbitration_service = true;
```

**例：**

クラスタの `sys` テナントでアービトレーションサービスを有効化します。

```shell
obclient [(none)]> ALTER TENANT sys SET enable_arbitration_service = true;
Query OK, 0 rows affected
```

### ステップ5：テナントのアービトレーションサービスのステータス確認

1. テナントのアービトレーションサービスが有効になっているかどうかを確認します。

   ビュー `DBA_OB_TENANTS` でテナントの情報を参照し、`arbitration_service_status` 列で **アービトレーションサービスの有効化ステータス** を確認します。

   `arbitration_service_status` の値は以下のとおりです：

   * `ENABLED`：テナントでアービトレーションサービスが有効になっていることを示します。
   * `ENABLING`：テナントでアービトレーションサービスが有効化の過程にあることを示します。
   * `DISABLED`：テナントでアービトレーションサービスが無効になっていることを示します。
   * `DISABLING`：テナントでアービトレーションサービスが無効化の過程にあることを示します。

   **例：**

   ```shell
   obclient [(none)]> SELECT TENANT_ID,TENANT_NAME,ARBITRATION_SERVICE_STATUS FROM oceanbase.DBA_OB_TENANTS WHERE tenant_name = 'sys';
   +-----------+-------------+----------------------------+
   | TENANT_ID | TENANT_NAME | ARBITRATION_SERVICE_STATUS |
   +-----------+-------------+----------------------------+
   |         1 | sys         | ENABLED                    |
   +-----------+-------------+----------------------------+
   1 row in set
   ```

2. 現在のアービトレーションサービスが利用可能かどうかを確認します。

   テナントでアービトレーションサービスが有効化されると、有効化された時点でそのテナントで既に作成されていたすべてのログストリームはアービトレーションサービスを利用できます。しかし、有効化後に新しく作成されたログストリームにはアービトレーションサービスがない可能性があります。これは、ログストリームの作成が非厳格モードで実行され、アービトレーションサービスが正常に作成されるという保証がないためです。このような状況で、ユーザーは以下のSQL文を使用すると、テナントのすべてのログストリームにアービトレーションサービスがあるかどうかを確認できます。

   ```shell
   ##テナント内にアービトレーションレプリカが存在しないログストリームのリストをクエリする##
   (SELECT distinct ls_id FROM GV$OB_LOG_STAT WHERE tenant_id = xxx) except
   (SELECT ls_id FROM GV$OB_LOG_STAT WHERE tenant_id = xxx and role = 'LEADER' and arbitration_member = "$arb_server_ip:$arb_server_port");
   ```

   **例：**

   `sys` テナント内にアービトレーションレプリカが存在しないログストリームのリストをクエリします。空のセットが返された場合、現在のテナントのアービトレーションサービスは利用可能な状態です。

   ```shell
   obclient [oceanbase]> (SELECT distinct ls_id FROM GV$OB_LOG_STAT WHERE tenant_id = 1) except
   (SELECT ls_id FROM GV$OB_LOG_STAT WHERE tenant_id = 1 and role = 'LEADER' and arbitration_member = "10.10.10.3:2882");
   Empty set
   ```

## 次の操作

クラスタの作成後、ビジネスのニーズに応じてユーザーテナントを作成します。

コマンドラインを使用したユーザーテナントの作成の詳細情報については、[テナントの作成](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971591)を参照してください。

## 関連ドキュメント

* [OBClientを使用したOceanBaseテナントへの接続](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971649)
* [システム構成パラメータの概要](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971260)
* [ALTER USER](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974184)
* [ALTER TENANT](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001972313)
* [ユーザーテナントの紹介](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971103)
* [CREATE TENANT](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001972305)
* [アービトレーションサービスの有効化](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971566)
* [アービトレーションサービスの無効化](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971568)
* [デグレードタイムアウト時間の変更](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971573)
* [アービトレーションサービスの置換](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971570)
* [アービトレーションサービスの削除](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971567)
