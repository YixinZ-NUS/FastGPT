|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# OATのデプロイ

この記事では、Dockerを使用したOATのデプロイ方法について説明します。

## 前提条件

* OATサーバーをインストールするオペレーティングシステムが要件を満たしていること。詳細については、[サーバー設定](../200.preparations-before-deploy/200.configure-servers.md)を参照してください。
* Dockerをインストールし、起動済みであること。Dockerの推奨バージョンは、Community Edition 17.03以降です。

   <main id="notice" type='notice'>
   <h4>注意</h4>
   <p>oat-all-in-oneインストールパッケージを使用してOATをデプロイする場合は、oat-all-in-oneの<code>install.sh</code>スクリプトによってDockerが自動的にインストールされるため、Dockerを別途インストールする必要はありません。</p>
   </main>

* OATのデフォルトポート`7000`が使用されていないこと。
* サーバーの`root`ユーザー権限を持っていること。

## 操作手順

### プラン1：oat-all-in-oneインストールパッケージを使用したOATのデプロイ

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>oat-all-in-oneインストールパッケージを使用してデプロイする前に、ターミナルで<code>setenforce 0</code>コマンドを実行して、SELinux(Security-Enhanced Linux)を無効にすることを推奨します。</p>
</main>

1. `scp`コマンドを使用して、oat-all-in-oneインストールパッケージをサーバーにアップロードします。

   ここで、`oat_server_ip`はOATをデプロイするサーバーのIPアドレス、`oat_directory`はインストールパッケージを格納しているディレクトリ、`oat_xxx.tar`はインストールパッケージの名前です。

   ```shell
   scp <oat_directory/oat-all-in-one-xxx.tar> <oat_server_user>@<oat_server_ip>:oat_directory
   ```

   例：

   ```shell
   [root@xxx /home/admin/rpm]# scp oat-all-in-one-x86-411.tar admin@xxx.xxx.xxx.xxx:/home/admin/rpm
   admin@xxx.xxx.xxx.xxx's password:
   oat-all-in-one-x86-411.tar                                                                              100% 1649MB 401.9MB/s   00:04
   ```

2. oat-all-in-oneインストールパッケージを解凍します。

   例：

   ```shell
   [root@xxx /home/admin/rpm]# tar -xf oat-all-in-one-x86-411.tar
   ```

3. インストールスクリプト`install.sh`を実行します。

   解凍ディレクトリ`oat-all-in-one-x86`内のインストールスクリプト`install.sh`を実行します。

   ```shell
   sh oat-all-in-one-x86/install.sh
   ```

   Dockerがインストールされていない環境でこのコマンドを実行すると、Dockerが自動的にインストールされてOATがデプロイされ、既存のイメージとツールソフトウェアパッケージがスキャンされます。

   プロンプトに従って、以下の情報を順番に確認します：

   1. Dockerのルートディレクトリを指定してください。デフォルトは`/docker`で、カスタマイズ可能です。Dockerがインストール済みであれば、この手順はスキップされます。
   2. OATデータディレクトリのパスを指定してください。デフォルトは`/oat_data`で、カスタマイズ可能です。
   3. OAT HTTPリスニングポートを指定してください。デフォルトは`7000`で、カスタマイズ可能です。
   4. OATデータベースのポートを指定してください。デフォルトは`3306`で、カスタマイズ可能です。
   5. OAT管理者アカウントのパスワードを入力してください(初期ログインパスワードの設定)。カスタマイズ可能です。
   6. 返されたURLでOATにアクセスし、OATサービスの可用性を検証します。

   例：

   ```shell
   [root@xxx /home/admin/rpm]# sh oat-all-in-one-x86/install.sh
   ```

   プロンプトに従って、以下の設定を完了します：

   1. Dockerのルートディレクトリはデフォルトを使用します。そのままEnterキーを押します。

      ```shell
      Before installation, please set the config below:
      Input the docker root dir: /docker
      ```

   2. OATデータディレクトリのパスを`/home/admin/oat_data`に変更して、Enterキーを押します。

      ```shell
      Input the OAT data dir: /home/admin/oat_data
      ```

   3. OAT HTTPリスニングポートはデフォルトを使用します。そのままEnterキーを押します。

      ```shell
      Input the OAT HTTP listen port: 7000
      ```

   4. OATデータベースポートはデフォルトを使用します。そのままEnterキーを押します。

      ```shell
      Input the OAT database port: 3306
      ```

   5. OAT管理者アカウントのパスワード(初期ログインパスワード)はデフォルトを使用します。そのままEnterキーを押します。

      ```shell
      Input the OAT admin user password(login password): ******
      ```

   6. 返されたURLでOATにアクセスし、OATサービスの可用性を検証します。

      結果は次の通りとなります：

      ```shell
      Start prepare docker
      Docker is already exists, start check...
      Already installed docker check healthy, skip install docker
      Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.
      Start prepare OAT
      Loaded image: reg.docker.alibaba-inc.com/oceanbase/oat:4.1.1_20230512_x86
      f4f5dbe127f62f9ec016dabfc6b1b272da2dd7794c255aed9e335cb83192ad2b
      check OAT url http://127.0.0.1:7000/hc
      curl: (7) Failed connect to 127.0.0.1:7000; Connection refused
      OAT API not ready, please wait, sleep 5s retry...
      curl: (7) Failed connect to 127.0.0.1:7000; Connection refused
      OAT API not ready, please wait, sleep 5s retry...
      curl: (7) Failed connect to 127.0.0.1:7000; Connection refused
      OAT API not ready, please wait, sleep 5s retry...
      curl: (7) Failed connect to 127.0.0.1:7000; Connection refused
      OAT API not ready, please wait, sleep 5s retry...
      OAT API ready
      Copy images and binary_packages to OAT data dir
      Trigger OAT scan api to find images and binary_packages
      Trigger scan task success, please visit OAT web site and wait for scan task finished
      OAT is ready for visit
      url is: http://xxx.xxx.xxx.xxx:7000
      user/password is: XXXXX/******
      ```

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p><ul><li><code>install.sh</code>スクリプトは、OATコンテナの起動時にデフォルトで<code>--net host</code>(ホストネットワークモード)を使用します。他のネットワークモードに設定する必要がある場合は、OATコンテナをダウンロードして手動で起動してください。</li><li>x86(aarch64)版のoat-all-in-oneには、デフォルトでx86(aarch64)およびnoarchのイメージとソフトウェアパッケージのみが含まれています。aarch64(x86)アーキテクチャが必要な場合は、ご自身でダウンロードしてOATコンテナのマウントディレクトリにコピーし、スキャンタスクを実行して追加してください。</li></ul> </p>
</main>

### プラン2：OAT dockerイメージを使用したOATの独立デプロイ

1. `scp`コマンドを使用して、OATインストールパッケージをサーバーにアップロードします。

   ここで、`oat_server_ip`はOATをデプロイするサーバーのIPアドレス、`oat_directory`はインストールパッケージを格納しているディレクトリ、`oat_xxx.tar`はインストールパッケージの名前です。

   ```shell
   scp <oat_directory/oat_xxx.tar> <oat_server_user>@<oat_server_ip>:oat_directory
   ```

   例：

   ```shell
   [root@xxx /home/admin/rpm]# scp oat_4.1.0_20230331_x86.tgz admin@xxx.xxx.xxx.xxx:/home/admin/rpm
   admin@xxx.xxx.xxx.xxx's password:
   oat_4.1.0_20230331_x86.tgz                               100%  438MB   4.3MB/s   01:41
   ```

2. OATディレクトリをマウントします。

   サーバー上に`/data_dir`ディレクトリを作成して、OATの永続化データを保存します。`/data_dir`ディレクトリがOATコンテナにマウントされると、OATは自動的に`/data_dir/logs`、`/data_dir/images`、`/data_dir/db`ディレクトリを作成し、それぞれにOATのシステムログ、コンポーネントとプロダクトのDockerイメージ、OATのデータベースファイルを格納します。例：

   ```shell
   [root@xxx /]# mkdir -p /data_dir
   ```

3. OATインストールパッケージをイメージとしてロードします。

   OATインストールパッケージが保存されているディレクトリに移動し、以下のコマンドを実行します：

   ```shell
   [root@xxx /]# cd oat_directory

   [root@xxx /oat_directory]# docker load -i oat_xxx.tar
   ```

   例：

   ```shell
   [root@xxx /]# cd /home/admin/rpm

   [root@xxx /home/admin/rpm]# docker load -i oat_4.1.0_20230331_x86.tgz
   06f6bfff6616: Loading layer [==================================================>]  230.8MB/230.8MB
   e1505344677e: Loading layer [==================================================>]  3.072kB/3.072kB
   01ede0eada53: Loading layer [==================================================>]  690.2MB/690.2MB
   78073091fd9e: Loading layer [==================================================>]  8.704kB/8.704kB
   5d96997aeb89: Loading layer [==================================================>]  232.8MB/232.8MB
   17fa9a0a477e: Loading layer [==================================================>]  156.1MB/156.1MB
   Loaded image: reg.docker.alibaba-inc.com/oceanbase/oat:4.1.0_20230331_x86
   ```

4. `docker images`コマンドを使用して、OATイメージのタグを取得します。

   <main id="notice" type='explain'>
     <h4>説明</h4>
     <p>以下のコマンドは、ローカルにOATインストールパッケージが1つのみロードされている場合にのみ適用されます。複数のインストールパッケージがロードされている場合は、<code>docker images</code>コマンドで表示内容を確認し、コロン(:)を使用して最初の2列の内容を連結します。</p>
   </main>

   ```shell
   oat_image=`docker images | grep oat | awk '{printf $1":"$2"\n"}'`
   ```

   例：

   ```shell
   [root@xxx /home/admin/rpm]# oat_image=`docker images | grep oat | awk '{printf $1":"$2"\n"}'`
   ```

5. `docker run`コマンドを実行して、OATを起動します。

   `$oat_image`はOATイメージのタグです。

   ```shell
   docker run -d --net host --name oat -v /data_dir:/data --restart on-failure:5 $oat_image
   ```

   <main id="notice" type='explain'>
     <h4>説明</h4>
     <p><ul><li>OATのHTTPサービスはデフォルトで<code>7000</code>ポートをリッスンしますが、<code>-e HTTP_PORT=7001</code>パラメータを指定して他のポートに変更できます。</li><li><code>-e OAT_INITIAL_ADMIN_PASSWORD=xxx</code>パラメータを指定して、OATのパスワードを変更できます。</li><li>OATはMariaDBをデータストレージとして内蔵しており、デフォルトで<code>3306</code>ポートをリッスンしますが、<code>-e DB_PORT=3307</code>パラメータを指定して他のポートに変更できます。</li><li><code>--net host</code>パラメータを指定して起動することを推奨します。bridgeネットワークモードで起動されたコンテナは、<code>docker0</code>ブリッジの障害やOSパラメータ<code>ip_forward</code>の影響を受ける可能性があるためです。</li></ul></p>
   </main>

   例：

   ```shell
   [root@xxx /home/admin/rpm]# docker run -d --net host --name oat -v /data_dir:/data --restart on-failure:5 `docker images | grep oat | awk '{printf $1":"$2"\n"}'`
   79978776c4d478d36b0b61d6ccfb186d39dbd2d29695a27937d0fc654b58ffb9
   ```

## 次の操作

OATのデプロイが完了したら、OATにログインしてデプロイの成功を確認する必要があります。

1. ブラウザにOATのアクセスアドレスを入力し、Enterキーを押します。

   OATのアクセスアドレス：`http://oat_server_ip:7000`。

   ここで、`oat_server_ip`はOATをデプロイしたサーバーのIPアドレスです。

2. ブラウザのウィンドウにログイン画面が表示されれば、OATのインストールと起動に成功しています。

   表示されたログインページで、`admin`アカウントを使用してシステムにログインします。

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>OceanBaseアフターサービスサポートにお問い合わせいただき、OATのデフォルトユーザー名adminアカウントのデフォルトパスワードを取得してください。アカウントのセキュリティを確保するため、初回ログイン後、速やかにパスワードを変更してください。</p>
   </main>

   <!-- ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.1.0/4.deploy/3.deploy-oceanbase-database-enterprise/1%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2.png) -->

3. パスワードを設定してアカウントを有効化します。

   `admin`アカウントのデフォルトパスワードでログインし、パスワードを設定してアカウントを有効化します。

   <!-- ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.1.0/4.deploy/3.deploy-oceanbase-database-enterprise/0%E5%AF%86%E7%A0%81%E6%BF%80%E6%B4%BB-%E4%B8%AD%E6%96%87.png) -->

## 関連ドキュメント

OATのインストールに関する詳細は、[OATのインストール](https://en.oceanbase.com/docs/common-oat-10000000002095152)を参照してください。
