|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# OCPを使用した2レプリカ + アービトレーションサービスのOceanBaseクラスタのデプロイ

OceanBaseデータベースは、V4.1バージョンからアービトレーションサービス(Arbitration Service)をサポートしています。これにより、2リージョン3センター構成での同一都市内のレプリカ障害時のRT増大の問題を解決するだけでなく、都市を跨いだ帯域幅の使用量を削減し、第3データセンターのコストを極限まで低減できます。

この記事では、OCPを使用して、2台のマシンで構成されるOceanBaseクラスタと1つのアービトレーションメンバーをデプロイする方法について説明します。

<main id="notice" type='explain'>
   <h4>説明</h4>
   <p><ul><li>この記事では、OCP V4.2.1バージョンを例に操作手順を説明します。OCPのバージョンによって操作画面が異なる場合があります。実際の画面をご確認ください。</li><li>OceanBaseクラスタには1つのアービトレーションサービスのみ追加できます。</li></ul></p>
</main>

## 前提条件

* OCPをデプロイ済みであること。詳細については、[OCPのデプロイ](../200.deploy-ocp-use-oat/400.deploy-ocp.md)を参照してください。
* OceanBaseクラスタをデプロイするサーバーがOCPリソースプールに追加されていること。詳細については、[サーバーの追加](../100.configuring-the-deploy-environment-through-oat/100.add-server.md)を参照してください。
* OCPにログインしているユーザーが `CREATE CLUSTER` 権限を持っていること。詳細については、[ロールの概要](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001973979)と [OCPのデフォルトロール](https://en.oceanbase.com/docs/common-ocp-10000000002169916)を参照してください。
* OceanBaseデータベースV4.1.0以上のバージョンのRPMパッケージを取得していること。詳細については、[インストールパッケージの準備](../../200.preparations-before-deploy/300.prepare-installation-packages.md)を参照してください。

## 操作手順

### ステップ1：2レプリカクラスタの作成

1. OCPにログインします。

2. 左側のナビゲーションバーで、**クラスタ** をクリックします。

3. **クラスタ** ページの右上隅にある **クラスタの作成** をクリックします。

4. **クラスタの作成** ページの右上隅で、デフォルトで選択されている **分散クラスタ** を使用します。

5. **クラスタの作成** ページで、クラスタの基本情報を設定します。

   **基本設定** は以下の表のとおりです。

   |    **設定**       |     **説明**    |
   |-------------------|-----------------|
   | **クラスタタイプ**      | **プライマリクラスタ** または **スタンバイクラスタ** を選択できます。ここでは **プライマリクラスタ** を選択します。|
   | **クラスタ名**     | 管理するクラスタの名前をカスタマイズします。クラスタ名は英字で始める必要があり、英大文字、英小文字、数字、アンダースコア(_)を使用できます。長さは2～48文字です。|
   | **root@sysパスワード** | カスタマイズまたはランダム生成が可能です。パスワードは以下の複雑さの条件を満たす必要があります：</br> <ol><li>長さ：8～32文字。</li><li>数字を2つ以上、英大文字を2つ以上、英小文字を2つ以上、特殊文字を2つ以上含むこと。</li></ol>  </br>サポートされている特殊文字：<code>\~!@#%\^\&\*_-+=\`\|(){}\[\]:;',.?/</code> </br>また、**パスワードのコピー** をクリックすると、カスタマイズまたはランダム生成されたパスワードをクリップボードにコピーできます。 |
   | **OceanBaseバージョン** | リストから既存のOceanBaseデータベースのバージョンを選択するか、リストの下部にある **バージョンの追加** をクリックして、OceanBaseのRPMパッケージをアップロードできます。     |
   | **OBProxyクラスタの関連付け** | このオプションは、既存のOBProxyクラスタを関連付けるために使用します。この例では、このオプションを有効にしません。|

   <!-- ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/4%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4-1%E5%9F%BA%E7%A1%80%E8%AE%BE%E7%BD%AE.png) -->

6. **クラスタの作成** ページで、クラスタのデプロイモード情報を設定します。

   デフォルトで3つのZone情報が追加されています。いずれかのZoneの後ろにある削除アイコンをクリックして、2つのZoneを残します。

   |       **設定**     |            **説明**               |
   |--------------------|-----------------------------------|
   | **Zone名**      | 通常、デフォルト名が設定されていますが、必要に応じて名前を変更することができます。 Zone名は英字で始める必要があり、英大文字、英小文字、数字、アンダースコア(_)を使用できます。長さは2～48文字です。|
   | **データセンター**           | Zoneが属するデータセンター。各Zoneのホストは同じデータセンターにのみデプロイできます。|
   | **マシンタイプ(オプション)**   | マシンタイプを選択すると、後のホストリストはそのマシンタイプに基づいてフィルタリングされます。 |
   | **CPUアーキテクチャ**   | **自動割り当て** または **手動選択** を選択できます。        |
   | **ホスト**           | マシンのIPアドレス。複数のIPアドレスを選択できます。|
   | **Root Serverの位置** | Root Serviceを配置するマシンのIPアドレスを選択する必要があります。マルチレプリカのOceanBaseクラスタでは、各Zoneに1つのRoot Serviceを指定する必要があります。        |
   | **Zone優先順位ソート**  | クラスタのsysテナントのプライマリレプリカの分散における優先順位。オプションです。指定しない場合、最初のZoneが最優先されます。最も優先順位の高いZoneはPrimary Zoneと見なされ、1つしか持つことができません。</br>このオプションを有効にして、Zoneの優先順位をカスタマイズすることもできます。ソート方法は以下のとおりです：<ol><li>左側のリストボックスで、1つまたは複数のZoneを選択します。 左側のリストボックスには、現在のクラスタで使用可能なすべてのZoneが表示されています。</li><li>中央の <b>></b> ボタンをクリックします。 選択したZoneが<b>優先順位ソート</b>リストに移動します。複数のZoneを同時に選択すると、それらは同じ優先順位を持ちます。</li><li>a、bの操作を繰り返して、優先順位の低いZoneを追加します。</li><li>優先順位を調整する必要がある場合、<b>優先順位ソート</b>リスト内でドラッグして順序を変更することができます。 リスト内では上から下へ優先順位が低くなります。</li></ol>|

   <!-- ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/4%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4-2%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F2zone.png) -->

7. (オプション) **クラスタの作成** ページで、クラスタパラメータを設定します。

   デフォルトのパラメータ設定を使用するか、**パラメータ設定** モジュールを開いてクラスタパラメータを設定できます。

   * 起動パラメータ項目を個別に追加して値を設定できます。
   * **パラメータテンプレートの選択** をクリックしてパラメータテンプレートを選択すると、テンプレートのパラメータと設定が自動的に入力されます。クラスタのパラメータテンプレートが作成されていない場合は、**クラスタテンプレートの新規作成** をクリックして、クラスタのパラメータテンプレートを作成できます。

   <!-- ![3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/4%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4-3%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE.png) -->

8. (オプション) **クラスタの作成** ページで、カスタム設定を使用してパスとポートを設定します。

   デフォルトのパスとポート設定を使用するか、**カスタム設定** モジュールを開いて **パス設定** と **ポート設定** をカスタマイズできます。

   * パスの設定：

     1. **パス設定** モジュールで、必要に応じて **ソフトウェアインストールパス**、**データディスクパス**、**ログディスクパス** をカスタマイズします。
     2. 設定完了後、**テスト** をクリックして、パスが使用可能かどうか検証します。使用できない場合は、テスト結果に基づいて問題を調査するか、パスを他の使用可能なパスに変更します。

   * ポートの設定：

     1. **ポート設定** モジュールで、**SQLポート** と **RPCポート** をカスタマイズします。
     2. 設定が完了したら、**テスト** をクリックして、ポートが既に使用されているかどうかを検証します。既に使用されている場合、使用可能なポートを再設定する必要があります。

   <!-- ![4](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/4%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4-4%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%BE%E7%BD%AE.png) -->

9. 設定が完了したら、右下の **送信** をクリックします。

### ステップ2：アービトレーションサービスの新規作成

1. 左側のナビゲーションバーで **クラスタ** をクリックして、クラスタページに移動します。

2. 概要ページの右上隅にある **アービトレーションサービス管理** をクリックします。

3. **アービトレーションサービス管理** ページで、**アービトレーションサービスの新規作成** をクリックします。

4. **アービトレーションサービスの新規作成** パネルで、アービトレーションサービスの基本情報を設定します。

   | パラメータ | 説明 |
   | ------ | ------ |
   | ホスト | アービトレーションサービスをデプロイするホストを選択します。同じホスト上で複数のアービトレーションサービスプロセスを起動できます。IPアドレスでホストを検索できます。また、ドロップダウンリストから **ホストの追加** をクリックして、利用可能なホストを追加することもできます。<main id="notice" type='notice'><h4>注意</h4><p>OceanBaseサービスが既にデプロイされているホストは選択できません。</p></main>|
   | サービスバージョン | リストから既存のOceanBaseクラスタのバージョンを選択できます。選択したバージョンのハードウェアアーキテクチャは **ホスト** のアーキテクチャと一致している必要があり、OceanBase V4.1.0以上のバージョンのソフトウェアパッケージのみをサポートしています。リストの下部にある **バージョンの追加** をクリックして、必要なバージョンのソフトウェアパッケージをアップロードすることもできます。|
   | ソフトウェアパス | ソフトウェアのインストールパス。デフォルトパスは `/home/admin/oceanbase` です。ホストの当該パスへの **書き込み** 権限が必要です。|
   | サービスポート | デフォルトは `2882` です。実際の状況に応じて変更できます。選択したポートが使用されていないことを確認する必要があります。|
   | 説明(オプション) | アービトレーションサービスに関する補足説明。オプションです。|
   | パラメータ設定 | アービトレーションサービスの起動パラメータを設定します。 <main id="notice" type='notice'><h4>注意</h4><p>アービトレーションノードのログディレクトリが自動的にクリーンアップされてディスクがいっぱいになるのを防ぐために、<code>enable_syslog_recycle</code> を <code>True</code> に設定し、<code>max_syslog_file_count</code> に有効な値を設定する必要があります。そうしないと、ログファイルが継続的に増加し、ディスク容量を使い果たす可能性があります。</p></main>|

   <!-- ![5](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/5%E6%96%B0%E5%BB%BA%E4%BB%B2%E8%A3%81%E6%9C%8D%E5%8A%A1-1%E5%8F%82%E6%95%B0.png) -->

5. 設定が完了したら、右下の **OK** をクリックします。ポップアップウィンドウでタスクIDをクリックすると、タスクの実行ステータスを確認できます。

   システムは入力された情報を検証します。検証に失敗した場合は、ページの指示に従って調査または修正を行います。

### ステップ3：クラスタへのアービトレーションサービスの追加

1. 左側のナビゲーションバーで **クラスタ** をクリックして、クラスタページに移動します。

2. **クラスタ** ページの **クラスタリスト** 領域で、操作するクラスタのクラスタ名をクリックします。

3. クラスタの **概要** ページの右上隅にある **...** アイコンをクリックして、**アービトレーションサービスの追加** を選択します。

   <!-- ![6](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/6%E6%B7%BB%E5%8A%A0%E4%BB%B2%E8%A3%81%E6%9C%8D%E5%8A%A1-1.png) -->

4. **アービトレーションサービスの追加** パネルで、クラスタのアービトレーションサービスアドレスを選択するか、リストの下部にある **サービスの新規作成** をクリックします。

   <!-- ![7](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/6%E6%B7%BB%E5%8A%A0%E4%BB%B2%E8%A3%81%E6%9C%8D%E5%8A%A1-2.png) -->

5. 選択が完了したら、右下の **送信** をクリックします。

## 次の操作

クラスタの作成後、ビジネスのニーズに応じてユーザーテナントを作成します。

* OCPを使用したユーザーテナントの作成方法の詳細については、[プライマリテナントの新規作成](https://en.oceanbase.com/docs/enterprise-oceanbase-ocp-en-10000000000838603)を参照してください。

* コマンドラインを使用したユーザーテナントの作成の詳細情報については、[テナントの作成](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971591)を参照してください。

## 関連ドキュメント

* [OCPのデプロイ](../200.deploy-ocp-use-oat/400.deploy-ocp.md)
* [サーバーの追加](../100.configuring-the-deploy-environment-through-oat/100.add-server.md)
* [インストールパッケージの準備](../../200.preparations-before-deploy/300.prepare-installation-packages.md)
* [ロールの概要](https://en.oceanbase.com/docs/enterprise-oceanbase-ocp-en-10000000000838707)
* [OCPデフォルトロール](https://en.oceanbase.com/docs/common-ocp-10000000002169916)
* [接続方法の概要](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001971653)
* [クラスタの新規作成](https://en.oceanbase.com/docs/common-ocp-10000000002169361)
* [アービトレーションサービスの新規作成](https://en.oceanbase.com/docs/common-ocp-10000000002169347)
* [アービトレーションサービスの追加](https://en.oceanbase.com/docs/common-ocp-10000000002169345)
