|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# (オプション) OBProxyのデプロイ

カラムストアレプリカント(columnstore replica)を使用する場合は、独立したODPをデプロイする必要があります。カラムストアレプリカントに関する情報は、[カラムストアレプリカント](https://en.oceanbase.com/docs/common-oceanbase-database-10000000001974664)を参照してください。

OceanBaseデータベースプロキシ(OceanBase Database Proxy、略称：ODP、またはOBProxy)は、OceanBaseが提供するデータベースプロキシミドルウェアで、接続プーリング管理、ロードバランシング、フェールオーバーなどの機能を提供します。OBProxyはオプションのコンポーネントです。そのデプロイの可否は、アプリケーションのニーズやシナリオによって異なります。

この記事では、OCPを使用したOBProxyクラスタの作成方法について説明します。

<main id="notice" type='explain'>
  <h4>説明</h4>
  <p><ul>
  <li>この記事では、OCP V4.2.1バージョンを例に操作手順を説明します。OCPのバージョンによって操作画面が異なる場合があります。実際の画面をご確認ください。</li>
  <li>OBProxyは任意のマシンにデプロイされた後、ip:portを外部に公開することにより、OceanBaseのプロキシサービスを提供します。ユーザーはMySQLデータベースへのアクセスと同様に、ip:portを通じてOceanBaseデータベースにアクセスできます。一般的には、OBServerノードへのデプロイが推奨されます。</li>
  <li>1台のマシンに1つのOBProxyサービスのみをデプロイし、予約済みのポート <code>2883</code> を使用することを推奨します。同一マシンに複数のOBProxyサービスをデプロイする場合は、異なるポートを指定して区別する必要があります。</li>
  </ul></p>
</main>

## 前提条件

* OCPをデプロイ済みであること。詳細については、[OCPのデプロイ](200.deploy-ocp-use-oat/400.deploy-ocp.md)を参照してください。
* ログインしているユーザーが `OBPROXY_MANAGER` ロールであるか、OBProxyを管理する権限を持っていること。詳細については、[ロールの概要](https://www.oceanbase.com/docs/enterprise-oceanbase-ocp-cn-10000000001541995)と [OCPのデフォルトロール](https://en.oceanbase.com/docs/common-ocp-10000000002168891)を参照してください。
* OBProxyのRPMパッケージを取得していること。詳細については、[インストールパッケージの準備](../200.preparations-before-deploy/300.prepare-installation-packages.md)を参照してください。

## 操作手順

1. OCPにログインします。

2. 左側のナビゲーションバーで **OBProxy** をクリックして、**OBProxy** ページに移動します。

3. **OBProxy** ページで、右上の **OBProxyクラスタの作成** をクリックします。

4. **OBProxyクラスタの作成** ページで、**基本設定** を設定します。

   |        パラメータ      |     説明     |
   |------------------|-------------|
   | **クラスタ名** | 実際のビジネスの状況に応じて、英字で始まり、英数字とアンダースコア(_)を含むクラスタ名をカスタマイズできます。|
   | **Proxyroアカウントのパスワードを入力** | OBProxyはProxyroアカウントを使用してOceanBaseクラスタにアクセスします。パスワードが入力されていない場合は、Proxyroアカウントのデフォルトパスワードを使用して接続します。パスワードのフォーマットは以下のとおりです：<ul><li>長さは8～32文字です。</li><li>英数字と特殊文字 <code>\~!@#%\^\&\*_-+=\`\|(){}\[\]:;',.?/</code> のみを含めることができます。</li><li>大文字、小文字、数字、特殊文字をそれぞれ2つ以上含める必要があります。</li></ul> |
   | **ソフトウェアバージョン**      | インストールするOBProxyのバージョンを選択します。<main id="notice" type='explain'><h4>説明</h4><p><ul><li>V1.8.0以上のバージョンのOBProxyソフトウェアパッケージのみ選択可能です。</li><li>接続可能なOceanBaseクラスタにV4.0.0以上のバージョンのクラスタが存在する場合は、V4.0.0以上のバージョンのOBProxyソフトウェアパッケージのみ選択可能です。</li></ul></p></main> |
   | **ロードバランシング管理** | デフォルトで無効です。</br> <ul><li>ロードバランシング管理が無効の場合は、以下の情報を設定する必要があります：<ul><li>アクセスアドレス：OBProxyクラスタのアクセスアドレスです。テナントの接続文字列の生成のみに使用され、実際の使用には影響しません。VIPアドレスの場合は、ご自身で申請してOBProxy Serverに関連付ける必要があります。</li><li>アクセスポート：デフォルトは2883です。ポート番号はカスタマイズ可能です。</li></ul> </li><li>ロードバランシング管理が有効の場合、以下の情報を設定する必要があります：<ul><li>ロードバランサー：デフォルトはOBLBです。Alibaba CloudのSLBサービスはVPN環境でのみ利用可能です。テクニカルサポート担当者にお問い合わせください。</li><li>OBLBサービス：OCPのデプロイ時に設定済みのOBLBサービスを選択するか、<b>OBLBサービスの追加</b>ボタンをクリックして、右側のパネルで新しいOBLBサービスを作成することができます。</li><li>VIP：OBLBの特定のVIPアドレスを選択します。</li><li>アクセスポート：デフォルトは2883です。ポート番号はカスタマイズ可能です。</li><li>ドメイン設定(オプション)：VIPとポートを指すための設定情報です。プラットフォームはVIPとドメイン名のマッピング関係を提供していないため、ご自身でドメイン名解決サービスを準備する必要があります。</li></ul></li></ul>|
   | **起動方法** | このOBProxyクラスタの起動方式です。取り得る値：<ul><li>ConfigUrl：マルチクラスタ起動方式。OBProxyクラスタは複数のOceanBaseクラスタにアクセスできます。</li><li>RsList：シングルクラスタ起動方式。OBProxyクラスタはOBProxyクラスタの作成時に指定されたOceanBaseクラスタにのみアクセスできます。OBProxyクラスタの作成後に、接続可能なOceanBaseクラスタを追加することはできません。</li></ul>|

   <!-- ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/7%E5%88%9B%E5%BB%BAODP-1%E5%9F%BA%E6%9C%AC%E8%AE%BE%E7%BD%AE.png) -->

5. (オプション) **OBProxyクラスタの作成** ページで、**OBProxyのデプロイ** を設定します。

   OBProxyクラスタの作成時にOBProxyをデプロイする必要がある場合は、この手順で設定することができます。それ以外の場合はこの手順をスキップし、クラスタの作成が完了した後に、**OBProxyの引き継ぎ** または **OBProxyの追加** によってクラスタにOBProxyを追加することができます。

   **OBProxyのデプロイ** の設定スイッチを有効にします。以下の表を参照して、デプロイ情報を入力します。

   |    **パラメータ**       |     **説明**    |
   |-------------------|-----------------|
   | **データセンター** | OBProxyが存在するデータセンター。1つのOBProxyは1つのデータセンターにのみ存在できます。|
   | **マシンタイプ(オプション)** | オプションです。マシンタイプを選択すると、後のホストリストはそのマシンタイプに基づいてフィルタリングされます。|
   | **OBProxyホストの選択** | OBProxyのデプロイに使用するホストを選択します。 </br>システムはデフォルトで2つのホストを選択肢として表示し、2つのOBProxyをデプロイする場合にのみ対応しています。さらにデプロイする必要がある場合は、**OBProxyの追加** をクリックしてホストを追加します。OBProxyを1つのみデプロイする場合は、上図のようにホストの後ろにある削除アイコンをクリックしてホストを削除します。|

   <!-- ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/7%E5%88%9B%E5%BB%BAODP-2%E9%83%A8%E7%BD%B2OBProxy.png) -->

6. (オプション) **OBProxyクラスタの作成** ページで、**パラメータ設定** を設定します。

   **パラメータ設定** を開いて、起動パラメータとその他のパラメータを追加または変更します。

   <!-- ![3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/7%E5%88%9B%E5%BB%BAODP-3%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE.png) -->

7. **カスタム設定** を開いて、クラスタポート、OSの所有者ユーザーおよびパスを設定します。

   |    **パラメータ**       |     **説明**    |
   |-------------------|-----------------|
   | **SQLポート** | デフォルトは2883です。ポート番号はカスタマイズ可能です。|
   | **Exporterポート** | デフォルトは2884です。ポート番号はカスタマイズ可能です。|
   | **OSの所有者ユーザー** | OBServerのインストールと実行に使用するOSユーザーです。編集できません。システムパラメータ `ocp.operation.default.os.user` でデフォルト設定を変更できます。詳細については、[システムパラメータの変更](https://en.oceanbase.com/docs/common-ocp-10000000002169971)を参照してください。|
   | **ソフトウェアインストールパス** | <ul><li>**OSの所有者ユーザー** がadminの場合、**ソフトウェアインストールパス** はデフォルトで <code>/home/admin/obproxy</code> です。パスはカスタマイズ可能です。</li><li>**OSの所有者ユーザー** がadmin以外の場合、**ソフトウェアインストールパス** はデフォルトで <code>/opt/oceanbase/obproxy</code> です。パスはカスタマイズ可能です。</li></ul>設定完了後、**テスト** をクリックして、パスが使用可能かどうか検証します。使用できない場合は、テスト結果に基づいて問題を調査するか、パスを他の使用可能なパスに変更することができます。|

   <main id="notice" type='explain'>
   <h4>説明</h4>
   <p><code>ocp.operation.default.os.user</code> パラメータを変更すると、その変更は分散クラスタの作成、OBProxyクラスタの作成、アービトレーションサービスの作成にのみ影響し、既存のクラスタの他の設定には影響しません。</p>
   </main>

   <!-- ![4](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.2/400.deploy/OCP422/7%E5%88%9B%E5%BB%BAODP-4%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%BE%E7%BD%AE.png) -->

8. 設定が完了したら、右下の **送信** をクリックします。

## 関連ドキュメント

OCPを使用したOBProxyクラスタの作成に関する詳細は、[OBProxyクラスタの作成](https://en.oceanbase.com/docs/common-ocp-10000000002168927)を参照してください。
